---
title: " Forecasting range shifts of a dioecious plant species under climate change"
author: "Jacob Moutouama,Aldo Compagnoni and Tom Miller "
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
 rmdformats::readthedown:
    code_folding: show
    self_contained: true
    number_sections: true
    thumbnails: true
    lightbox: true
    gallery: true
    keep_md: true
    highlight: tango
    df_print: kable 
    toc_depth: 3
    fig_width: 8
    fig_height: 8
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(comment=NA, 
                      echo = TRUE,
                      warning=FALSE, 
                      message=FALSE)
knitr::opts_knit$set(fig.pos = "H",global.par = TRUE,knitr.table.format = "latex")
```

This is the code for the paper 'Forecasting range shifts of a dioecious plant species under climate change'.

**Variables**:\

```{r img-with-knitr,echo=FALSE, fig.align='center', out.width='100%', fig.cap='dorming and dormant season for Poa arachnifera'}
url_life_cycle <-"https://www.dropbox.com/scl/fi/8n7q6eu6y2i5xnj0do0wf/POARlifecycle.png?rlkey=8opmup53lo91pdyhe7kjba2qc&dl=1"
knitr::include_graphics(url_life_cycle)
```

**pptgrow:** precipitation of the growing season\
**tempgrow:** temperature of the growing season\
**pptdorm:** precipitation of the dormant season\
**tempdorm:** temperature of the growing season\
**census.year:** Census year\
**source** Population from which the seeds was collected for the common garden\
**site** Location on which the common garden was established\
**block** Block in which the individuals are located\

```{r eval=TRUE,echo=T}
rm(list = ls())
```

Required libraries

```{r,warning=FALSE}
# load packages
library(rstan)
# set rstan options
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
set.seed(13)
# Sys.setenv(LOCAL_CPPFLAGS = '-march=corei7 -mtune=corei7')
options(tidyverse.quiet = TRUE)
library(tidyverse)
options(dplyr.summarise.inform = FALSE)
library(bayesplot)
# install.packages("countreg",repos = "http://R-Forge.R-project.org")
#library(countreg)
library(rmutil)
library(actuar)
#library(SPEI)
library(LaplacesDemon)
library(ggpubr)
library(raster)
library(rgdal)
library(doParallel)
# if (!require("BiocManager", quietly = TRUE))
#     install.packages("BiocManager")
# BiocManager::install("scater")
# library(scater)
library(BiocManager)
library(randomForest)
library(swfscMisc)
```

Define some basic functions that we'll use later

```{r}
# quote a series of bare names
quote_bare <- function( ... ){
    substitute( alist(...) ) %>% 
    eval( ) %>% 
    sapply( deparse )
}

invlogit<-function(x){exp(x)/(1+exp(x))}

multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)
  
  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)
  
  numPlots = length(plots)
  
  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                     ncol = cols, nrow = ceiling(numPlots/cols))
  }
  
  if (numPlots==1) {
    print(plots[[1]])
    
  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))
    
    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))
      
      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}

```

# Time serie for site 

```{r}
pr_poar_projections <- read.csv("https://www.dropbox.com/scl/fi/x8qq3c5g86hrheakpf0hf/pr_poar_projections.csv?rlkey=9pg7xd9fi8m0e1bq488ax5vgw&dl=1", stringsAsFactors = F) 
tas_poar_projections <- read.csv("https://www.dropbox.com/scl/fi/o26xt25t588ii7hd18qge/tas_poar_projections.csv?rlkey=mhb21bx3upr3b5nfm9baytdmi&dl=1", stringsAsFactors = F) 

```

```{r}
pr_poar_projections %>% 
  mutate(date=as.numeric(str_sub(transition,6,9))) %>% 
  filter(date %in% (1901:2100)) %>% 
  group_by(site,date,season) %>% 
  dplyr::summarize(site=unique(site),mean_pr = mean(pr,na.rm=T))->pr_past_present_future
#head(pr_past_present_future)
```


```{r}
fig_pr_past_present_furure<-ggplot(pr_past_present_future, aes(x = date, y = mean_pr)) +
  geom_line(aes(color =season )) +
  geom_smooth(aes(col = season),method="lm") +
  labs(x = "Year", y = "Precipitation (mm)") +
  # scale_x_continuous(breaks = c(1901,1920,1940,1960,1990,2010,2040,2070,2100))+
  xlim(1901,2100)+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))+
  facet_wrap(~site,ncol=4,scales = 'free',
             labeller=labeller(site=
                                 c("buffalolake"="Amarillo, TX",
                                   "elreno"="El Reno, OK",
                                   "Katy"="Waller, TX",
                                   "llano"="Junction, TX",
                                   "llela"="Lewisville, TX",
                                   "lostP"="Bastrop, TX",
                                   "lubbock"="Lubbock, TX",
                                   "ninnescah"="Wichita, KS",
                                   "ozona"="Ozona, TX",
                                   "psu"="Pittsburgh, KS",
                                   "shsu"="Huntsville, TX",
                                   "vernon"="Vernon, TX",
                                   "wf"="Wichita Falls, TX",
                                   "woodward"="Woodward, OK"))) +
  theme_bw()+
  theme(legend.position = "bottom",
        strip.text.x = element_text(
          size = 12, 
          color = "black",
          face = "italic"
        ),
        strip.background = element_rect(
          color="black",
          fill="pink", 
          size=0.25, 
          linetype="solid",
        ))

pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/fig_pr_past_present_future.pdf",useDingbats = F,height=8,width=9)
print(fig_pr_past_present_furure)
dev.off()
```

```{r}
tas_poar_projections %>% 
  mutate(date=as.numeric(str_sub(transition,6,9))) %>% 
  filter(date %in% (1901:2100)) %>% 
  group_by(site,date,season) %>% 
  dplyr::summarize(site=unique(site),mean_temp = mean(tas,na.rm=T))->tas_past_present_future
head(tas_past_present_future)

```

```{r}
fig_tas_past_present_future<-ggplot(tas_past_present_future, aes(x = date, y = mean_temp)) +
  geom_line(aes(color =season )) +
  geom_smooth(aes(col = season),method="lm",full_range = TRUE) +
  labs(x = "Year", y = "Temperature (Â°C)") +
  # scale_x_continuous(breaks = c(1990,2010,2040,2070,2100))+
  xlim(1901,2100)+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))+
  facet_wrap(~site,ncol=4,scales = 'free',
             labeller=labeller(site=
                                 c("buffalolake"="Amarillo, TX",
                                   "elreno"="El Reno, OK",
                                   "Katy"="Waller, TX",
                                   "llano"="Junction, TX",
                                   "llela"="Lewisville, TX",
                                   "lostP"="Bastrop, TX",
                                   "lubbock"="Lubbock, TX",
                                   "ninnescah"="Wichita, KS",
                                   "ozona"="Ozona, TX",
                                   "psu"="Pittsburgh, KS",
                                   "shsu"="Huntsville, TX",
                                   "vernon"="Vernon, TX",
                                   "wf"="Wichita Falls, TX",
                                   "woodward"="Woodward, OK"))) +
  theme_bw()+
  theme(legend.position = "bottom",
        strip.text.x = element_text(
          size = 12, 
          color = "black",
          face = "italic"
        ),
        strip.background = element_rect(
          color="black",
          fill="pink", 
          size=0.25, 
          linetype="solid",
        ))

pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/fig_tas_past_present_future.pdf",useDingbats = F,height=8,width=9)
print(fig_tas_past_present_future)
dev.off()
```


```{r,eval=FALSE}
Location<-readRDS("data/poar_ms_quantities.rds")
surveypo<-Location$survey_site_table[,c(1,2,3,5)]
surveypo$Population<-c(rep("Natural population survey"))
exp_pop<-Location$exp_site_table[,c(3,4)]
exp_pop$Population<-c(rep("Common garden site"))

surveypo %>% 
  filter(Experimental_source=="yes")->source_pop
source_pop$Population<-c(rep("Source population"))
Studysite<-rbind(surveypo[,c(1,2,4)],exp_pop,source_pop[,c(1,2,4)])
```

# Demography data

```{r}
poar_allsites <- read.csv("https://www.dropbox.com/s/xk4225mn8btqhbm/demography_allsites.csv?dl=1", stringsAsFactors = F)#common garden data
poar_allsites$census.year<-poar_allsites$year-1 # Add census year to match with climate data
# unique(poar_allsites$census.year)
poar_allsites %>% 
  dplyr::select(everything()) %>% 
  filter(census.year %in% (2015:2016))-> poar_allsites_2015_2016 # Drop the first census to match with the seasonal model (growing and dormant season temperature and precipitation)
```

# climatic data for the observed period to build the model

```{r}
poar_ppt <- read.csv("https://www.dropbox.com/s/kkga2hf9k1w9ht1/Poa_pr.csv?dl=1", stringsAsFactors = F) # monthly  precipitation 
# head(poar_ppt)
poar_tempmax <- read.csv("https://www.dropbox.com/scl/fi/2eizs4j1sv8g0vgy625qu/tasmax_poar.csv?rlkey=3u6l0765wkmvxulmbk00xuvhk&dl=1", stringsAsFactors = F) # monthly maximum temperature)
poar_tempmin <- read.csv("https://www.dropbox.com/scl/fi/wfrru3bbhxisr6c5yi75y/tasmin_poar.csv?rlkey=y1fihjfwqyq4mfjdkxl4607fs&dl=1", stringsAsFactors = F) # monthly maximum temperature)
poar_temp<-mutate(poar_tempmax,poar_tempmin)
# head(poar_temp)
poar_temp$temp<-(poar_temp$tempmax+poar_temp$tempmin)/2
# head(poar_temp)
poar_ppt$census.year<-ifelse(poar_ppt$month<=5,poar_ppt$year-1,poar_ppt$year) # data were collected in May. Thus, the precipitation for the census year is both the precipitation from June 1 to December of the previous year and precipitation of the current year up to and including May.  
poar_temp$census.year<-ifelse(poar_temp$month<=5,poar_temp$year-1,poar_temp$year)

# poar_temp %>% filter(site=="ozona",
#                      year%in%2015:2016) %>% View()

# poar_realmean<-read.csv("https://www.dropbox.com/s/n0vrn8q5ma49rc9/Poa_tas.csv?dl=1", stringsAsFactors = F) # monthly real mean temp 
# poar_realmean$realtemp<-poar_realmean$temp
# names(poar_realmean)
# dat<-mutate(poar_temp,poar_realmean)
# plot(poar_temp$temp,poar_realmean$realtemp)
# abline(0,1,col="red")

```

## Observed data (growing and dormant season temperature and precipitation)

```{r}
poar_temp %>% 
  dplyr::select(site,Longitude, Latitude,census.year,temp,month) %>% 
  filter(census.year %in% (2015:2016)) %>%
  mutate(Season=ifelse((month >= 6) & (month <= 9), "dormant", "growing")) %>% 
  group_by(site,census.year,Season) %>%
	dplyr::summarize(site=unique(site),Longitude=unique(Longitude),Latitude=unique(Latitude),temp_season = mean(temp))->poar_tempseason 
# head(poar_tempseason)

poar_ppt %>% 
  dplyr::select(site,Longitude, Latitude,census.year,ppt,month) %>% 
  filter(census.year %in% (2015:2016)) %>%
  mutate(Season=ifelse((month >= 6) & (month <= 9), "dormant", "growing")) %>% 
  group_by(site,census.year,Season) %>%
	dplyr::summarize(site=unique(site),Longitude=unique(Longitude),Latitude=unique(Latitude),ppt_season = sum(ppt))->poar_pptseason 
# head(poar_pptseason)

poar_climseason<- merge(x = poar_tempseason, y = poar_pptseason) # merge temperature and precipitation data

poar_climseason %>% 
  filter(Season=="growing") %>% 
  mutate(tempgrow=temp_season,pptgrow=ppt_season)->poar_growing_2015_2016

poar_climseason %>% 
  filter(Season=="dormant") %>% 
  mutate(tempdorm=temp_season,pptdorm=ppt_season)->poar_dormant_2015_2016

poar_dormant_growing_2015_2016<-mutate(poar_growing_2015_2016,poar_dormant_2015_2016)
poar_dormant_growing_2015_2016 %>% 
  mutate(ztempgrow=scale(tempgrow, scale = TRUE),zpptgrow=scale(pptgrow, scale = TRUE),ztempdorm=scale(tempdorm, scale = TRUE),zpptdorm=scale(pptdorm, scale = TRUE))->poar_2015_2016
# head(poar_2015_2016)
```


Extract the geographic coordianates
## Visualize the temp and precip variation covered by these sites and years
```{r}
site_cols<-rainbow(length(unique(poar_2015_2016$site)))
year_shapes<-c(1,16)
poar_2015_2016$site_col <- site_cols[as.factor(poar_2015_2016$site)]
poar_2015_2016$year_pch <- year_shapes[as.factor(poar_2015_2016$census.year)]
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/site_year_weather.pdf",height = 8,width = 6,useDingbats = F)
par(mar = c(4, 4, 2, 5), mfrow=c(2,1),xpd = TRUE) 
plot(poar_2015_2016$tempgrow,poar_2015_2016$pptgrow,lwd=2,cex=1.4,
     col=poar_2015_2016$site_col,pch=poar_2015_2016$year_pch,
     cex.lab=1,cex.axis=0.8,
     xlab=" Temperature (grow. season) ",
     ylab=" Precipitation (grow. season)")
arrows(poar_2015_2016$tempgrow[poar_2015_2016$census.year==2015],
       poar_2015_2016$pptgrow[poar_2015_2016$census.year==2015],
       poar_2015_2016$tempgrow[poar_2015_2016$census.year==2016],
       poar_2015_2016$pptgrow[poar_2015_2016$census.year==2016],
       col=unique(poar_2015_2016$site_col),length=0,lwd=2)
# legend("topright",legend=unique(poar_2015_2016$site),lwd=2,col=unique(poar_2015_2016$site_col),inset = c(-.2, .1),cex=0.5)
# legend(13,1100,legend=unique(poar_2015_2016$census.year),pch=unique(poar_2015_2016$year_pch),inset = c(-.2, .9),cex=0.8)
title("A",adj=0,font=3)
plot(poar_2015_2016$tempdorm,poar_2015_2016$pptdorm,lwd=2,cex=1.4,
     col=poar_2015_2016$site_col,pch=poar_2015_2016$year_pch,
     cex.lab=1,cex.axis=0.8,
     xlab="Temperature (dorm. season)",
     ylab="Precipitation (dorm. season)")
arrows(poar_2015_2016$tempdorm[poar_2015_2016$census.year==2015],
       poar_2015_2016$pptdorm[poar_2015_2016$census.year==2015],
       poar_2015_2016$tempdorm[poar_2015_2016$census.year==2016],
       poar_2015_2016$pptdorm[poar_2015_2016$census.year==2016],
       col=unique(poar_2015_2016$site_col),length=0,lwd=2)
legend(28.75,700,legend=unique(poar_2015_2016$census.year),pch=unique(poar_2015_2016$year_pch),inset = c(-.2, .9),cex=0.8)
title("B",adj=0,font=3)
dev.off()
# plot(poar_2015_2016$tempgrow,poar_2015_2016$tempdorm,lwd=2,cex=1.4,
#      col=poar_2015_2016$site_col,pch=poar_2015_2016$year_pch)
# plot(poar_2015_2016$pptgrow,poar_2015_2016$pptdorm,lwd=2,cex=1.4,
#      col=poar_2015_2016$site_col,pch=poar_2015_2016$year_pch)
```

## Extract the geographic coordianates for each site

```{r}
Poa_coordinate<-data.frame(site=unique(poar_allsites$site),Longitude=unique(poar_allsites$Longitude),Latitude=unique(poar_allsites$Latitude))
Poa_longlat<-Poa_coordinate[,-1]
sp::coordinates(Poa_longlat) <- ~ Longitude + Latitude
CRS1 <- CRS("+init=epsg:4326") # WGS 84
crs(Poa_longlat) <- CRS1
```

### Past climatic data (1901-1930)

```{r}
jacob_path<-"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Future and historical data"
tom_path<-"C:/Users/tm9/Dropbox/Miller Lab -- Moutouama/Future and historical data"
choose_path<-tom_path
```

```{r}
raster_1901_1930_list <- list.files(path = paste0(choose_path,"/Historical"),pattern=".tif$",full.names = T)# load bioclimatic layers
clim_1901_1930 <- raster::stack(raster_1901_1930_list) # put all the rasters together
names(clim_1901_1930)<-c("pptdorm","tempdorm","pptgrow","tempgrow") # Change the default names
plot(clim_1901_1930)
# summary(clim_1901_1930)
Conditions_1901_1930 <-terra::extract(clim_1901_1930,Poa_longlat)
# head(Conditions_1901_1930)
clim_past<-data.frame(Conditions_1901_1930)
```

### Current data (1990-2019)

```{r}
raster_1990_2019_list <- list.files(path = paste0(choose_path,"/Present"),pattern=".tif$",full.names = T)# load bioclimatic layers
clim_1990_2019 <- raster::stack(raster_1990_2019_list) # put all the rasters together
names(clim_1990_2019)<-c("pptdorm","tempdorm","pptgrow","tempgrow") # Change the default names
plot(clim_1990_2019)
# summary(clim_1990_2019)
Conditions_1990_2019 <- terra::extract(clim_1990_2019,Poa_longlat)
clim_current<-data.frame(Conditions_1990_2019)
```

### Future data (2017-2100)

#### MIROC5

```{r}
raster_miroc45_list <- list.files(path = paste0(choose_path,"/Future/MIROC/rcp45"), pattern=".tif$",full.names = T)# load bioclimatic layers
clim_miroc_45 <- terra::rast(raster_miroc45_list) # put all the rasters
clim_miroc_45<-raster::stack(clim_miroc_45)
names(clim_miroc_45)<-c("pptdorm"," tempdorm ","pptgrow","tempgrow") # Change the default names
plot(clim_miroc_45)
Conditions_miroc85 <- terra::extract(clim_miroc_45,Poa_longlat)
clim_miroc45<-data.frame(Conditions_miroc85)
```

```{r}
raster_miroc85_list <- list.files(path = paste0(choose_path,"/Future/MIROC/rcp85"),pattern=".tif$",full.names = T)# load bioclimatic layers
clim_miroc_85 <- terra::rast(raster_miroc85_list) # put all the raster together
clim_miroc_85<-raster::stack(clim_miroc_85)
names(clim_miroc_85)<-c("pptdorm"," tempdorm ","pptgrow","tempgrow") # Change the defaul
plot(clim_miroc_85)
Conditions_miroc85 <- terra::extract(clim_miroc_85,Poa_longlat)
clim_miroc85<-data.frame(Conditions_miroc85)
```

How much have the sites changed and by how much are they expected to change?
```{r}
past_current_change<-(clim_current - clim_past)/(1990-1901)
range(past_current_change$tempdorm);mean(past_current_change$tempdorm)
range(past_current_change$tempgrow);mean(past_current_change$tempgrow)
range(past_current_change$pptdorm);mean(past_current_change$pptdorm)
range(past_current_change$pptgrow);mean(past_current_change$pptgrow)

current_miroc45_change<- (clim_miroc45 - clim_current)/(2070-1990)
range(current_miroc45_change$tempdorm);mean(current_miroc45_change$tempdorm)
range(current_miroc45_change$tempgrow);mean(current_miroc45_change$tempgrow)

current_miroc85_change<- (clim_miroc85 - clim_current)/(2070-1990)
range(current_miroc85_change$tempdorm);mean(current_miroc85_change$tempdorm)
range(current_miroc85_change$tempgrow);mean(current_miroc85_change$tempgrow)

```


*Raw data*

One of the observation years was much cooler and wetter than the other, especially in the dormant season (see site_year_weather.pdf). We want to know which one was closer to the long-term average, and which year was unusual. 
```{r}
normal_vs_obs<-left_join(poar_2015_2016,cbind(Poa_longlat@coords,clim_current), by=c("Longitude","Latitude"))
pdf("Manuscript/Figures/clim_norm_vs_weather.pdf",height = 6,width = 7,useDingbats = F)
par(mar = c(4, 4, 2, 5),mfrow=c(2,2))
plot(normal_vs_obs$tempgrow.y,normal_vs_obs$tempgrow.x,
     pch=normal_vs_obs$year_pch,col=normal_vs_obs$site_col,cex=2,
     main="Growing season temp",xlab="30-year normal",ylab="Observed")
abline(0,1)
legend("topleft",legend=c(2015,2016),pch=c(1,16))
plot(normal_vs_obs$pptgrow.y,normal_vs_obs$pptgrow.x,
     pch=normal_vs_obs$year_pch,col=normal_vs_obs$site_col,cex=2,
     main="Growing season precip",xlab="30-year normal",ylab="Observed")
abline(0,1)
plot(normal_vs_obs$tempdorm.y,normal_vs_obs$tempdorm.x,
     pch=normal_vs_obs$year_pch,col=normal_vs_obs$site_col,cex=2,
     main="Dormant season temp",xlab="30-year normal",ylab="Observed")
abline(0,1)
plot(normal_vs_obs$pptdorm.y,normal_vs_obs$pptdorm.x,
     pch=normal_vs_obs$year_pch,col=normal_vs_obs$site_col,cex=2,
     main="Dormant season precip",xlab="30-year normal",ylab="Observed")
abline(0,1)
dev.off()
```


```{r,eval=FALSE}
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/MIROC.pdf",height = 7,width = 7,useDingbats = F)
par(mfrow=c(2,2))
hist(poar_2015_2016$pptgrow,xlab="Precipitation growing",xlim=c(50,1500),ylim=c(0,10),main="",col="grey")
hist(clim_past$pptgrow,col="pink",add=T)
hist(clim_miroc45$pptgrow,col="#F0E442",add=T)
hist(clim_miroc85$pptgrow,col="#0072B2",add=T)
hist(clim_current$pptgrow,col="green",add=T)

hist(poar_2015_2016$tempgrow,xlab="Temperature growing",xlim=c(5,25),ylim=c(0,10),main="",col="grey")
hist(clim_past$tempgrow,col="pink",add=T)
hist(clim_miroc45$tempgrow,col="#F0E442",add=T)
hist(clim_miroc85$tempgrow,col="#0072B2",add=T)
hist(clim_current$tempgrow,col="green",add=T)

hist(poar_2015_2016$pptdorm,xlab="Precipitation dormant",xlim=c(100,1000),main="",col="grey")
hist(clim_past$pptdorm,col="pink",add=T)
hist(clim_miroc45$pptdorm,col="#F0E442",add=T)
hist(clim_miroc85$pptdorm,col="#0072B2",add=T)
hist(clim_current$pptdorm,col="green",add=T)
legend("topright",legend=c("Observed","Past","RCP 4.5","RCP 8.5","Present"),lwd=6,col =c("grey","pink","#F0E442","#0072B2","green") ,bty="n",cex=0.75)

hist(poar_2015_2016$tempdorm,xlab="Temperature dormant",xlim=c(22,35),ylim=c(0,10),main="",col="grey")
hist(clim_past$tempdorm,col="pink",add=T)
hist(clim_miroc45$tempdorm,col="#F0E442",add=T)
hist(clim_miroc85$tempdorm,col="#0072B2",add=T)
hist(clim_current$tempdorm,col="green",add=T)

dev.off()

```


#### ACCESS

```{r}
raster_access_list_45 <- list.files(path = paste0(choose_path,"/Future/ACCESS/rcp45"),pattern=".tif$",full.names = T)# load bioclimatic layers
clim_access_45<-raster::stack(raster_access_list_45)
names(clim_access_45)<-c("pptdorm"," tempdorm ","pptgrow","tempgrow") # Change the default names
plot(clim_access_45)
Conditions_access_45 <- terra::extract(clim_access_45,Poa_longlat)
clim_access45<-data.frame(Conditions_access_45)
```

```{r}
raster_access_list_85 <- list.files(path = paste0(choose_path,"/Future/ACCESS/rcp85"),pattern=".tif$",full.names = T)# load bioclimatic layers
clim_access_85<-raster::stack(raster_access_list_85)
names(clim_access_85)<-c("pptdorm"," tempdorm ","pptgrow","tempgrow") # Change the default names
plot(clim_access_85)
Conditions_access_85 <- terra::extract(clim_access_85,Poa_longlat)
clim_access85<-data.frame(Conditions_access_85)
```

*Raw data*

```{r,eval=FALSE}
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/ACCESS.pdf",height = 7,width = 7,useDingbats = F)

par(mfrow=c(2,2))

hist(poar_2015_2016$pptgrow,xlab="Precipitation growing",xlim=c(50,1500),ylim=c(0,10),main="",col="grey")
hist(clim_past$pptgrow,col="pink",add=T)
hist(clim_access45$pptgrow,col="#F0E442",add=T)
hist(clim_access85$pptgrow,col="#0072B2",add=T)
hist(clim_current$pptgrow,col="green",add=T)

hist(poar_2015_2016$tempgrow,xlab="Temperature growing",xlim=c(5,30),main="",col="grey")
hist(clim_past$tempgrow,col="pink",add=T)
hist(clim_access45$tempgrow,col="#F0E442",add=T)
hist(clim_access85$tempgrow,col="#0072B2",add=T)
hist(clim_current$tempgrow,col="green",add=T)

hist(poar_2015_2016$pptdorm,xlab="Precipitation dormant",xlim=c(100,900),main="",col="grey")
hist(clim_past$pptdorm,col="pink",add=T)
hist(clim_access45$pptdorm,col="#F0E442",add=T)
hist(clim_access85$pptdorm,col="#0072B2",add=T)
hist(clim_current$pptdorm,col="green",add=T)
legend("topright",legend=c("Observed","Present","Past","RCP 4.5","RCP 8.5"),lwd=6,col =c("grey","green","pink","#F0E442","#0072B2") ,bty="n",cex=0.75)

hist(poar_2015_2016$tempdorm,xlab="Temperature dormant",xlim=c(20,35),ylim=c(0,6),main="",col="grey")
hist(clim_past$tempdorm,col="pink",add=T)
hist(clim_access45$tempdorm,col="#F0E442",add=T)
hist(clim_access85$tempdorm,col="#0072B2",add=T)
hist(clim_current$tempdorm,col="green",add=T)

dev.off()

```

#### CMCC

```{r}
raster_cmcc_list_45 <- list.files(path = paste0(choose_path,"/Future/CMCC/rcp45"),pattern=".tif$",full.names = T)# load bioclimatic layers
clim_cmcc_45<-raster::stack(raster_cmcc_list_45)
names(clim_cmcc_45)<-c("pptdorm"," tempdorm ","pptgrow","tempgrow") # Change the default names
plot(clim_cmcc_45)
Conditions_cmcc_45 <- terra::extract(clim_cmcc_45,Poa_longlat)
clim_cmcc45<-data.frame(Conditions_cmcc_45)
```

```{r}
raster_cmcc_list_85 <- list.files(path = paste0(choose_path,"/Future/CMCC/rcp85"),pattern=".tif$",full.names = T)# load bioclimatic layers
clim_cmcc_85<-raster::stack(raster_cmcc_list_85)
names(clim_cmcc_85)<-c("pptdorm"," tempdorm ","pptgrow","tempgrow") # Change the default names
plot(clim_cmcc_85)
Conditions_cmcc_85 <- terra::extract(clim_cmcc_85,Poa_longlat)
clim_cmcc85<-data.frame(Conditions_cmcc_85)
```

*Raw data*

```{r,eval=FALSE}
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/CMCC.pdf",height = 7,width = 7,useDingbats = F)

par(mfrow=c(2,2))

hist(poar_2015_2016$pptgrow,xlab="Precipitation growing",xlim=c(50,1500),ylim=c(0,10),main="",col="grey")
hist(clim_past$pptgrow,col="pink",add=T)
hist(clim_cmcc45$pptgrow,col="#F0E442",add=T)
hist(clim_cmcc85$pptgrow,col="#0072B2",add=T)
hist(clim_current$pptgrow,col="green",add=T)

hist(poar_2015_2016$tempgrow,xlab="Temperature growing",xlim=c(5,30),main="",col="grey")
hist(clim_past$tempgrow,col="pink",add=T)
hist(clim_cmcc45$tempgrow,col="#F0E442",add=T)
hist(clim_cmcc85$tempgrow,col="#0072B2",add=T)
hist(clim_current$tempgrow,col="green",add=T)


hist(poar_2015_2016$pptdorm,xlab="Precipitation dormant",xlim=c(100,900),main="",col="grey")
hist(clim_past$pptdorm,col="pink",add=T)
hist(clim_cmcc45$pptdorm,col="#F0E442",add=T)
hist(clim_cmcc85$pptdorm,col="#0072B2",add=T)
hist(clim_current$pptdorm,col="green",add=T)
legend("topright",legend=c("Observed","Present","Past","RCP 4.5","RCP 8.5"),lwd=6,col =c("grey","green","pink","#F0E442","#0072B2") ,bty="n",cex=0.75)


hist(poar_2015_2016$tempdorm,xlab="Temperature dormant",xlim=c(20,35),ylim=c(0,8),main="",col="grey")
hist(clim_past$tempdorm,col="pink",add=T)
hist(clim_cmcc45$tempdorm,col="#F0E442",add=T)
hist(clim_cmcc85$tempdorm,col="#0072B2",add=T)
hist(clim_current$tempdorm,col="green",add=T)

dev.off()

```

#### CESM1

```{r}
raster_cesm_list_45 <- list.files(path = paste0(choose_path,"/Future/CESM1/rcp45"),pattern=".tif$",full.names = T)# load bioclimatic layers
clim_cesm_45<-raster::stack(raster_cesm_list_45)
names(clim_cesm_45)<-c("pptdorm"," tempdorm ","pptgrow","tempgrow") # Change the default names
plot(clim_cesm_45)
Conditions_cesm_45 <- terra::extract(clim_cesm_45,Poa_longlat)
clim_cesm45<-data.frame(Conditions_cesm_45)
```

```{r}
raster_cesm_list_85 <- list.files(path = paste0(choose_path,"/Future/CESM1/rcp85"),pattern=".tif$",full.names = T)# load bioclimatic layers
clim_cesm_85<-raster::stack(raster_cesm_list_85)
names(clim_cesm_85)<-c("pptdorm"," tempdorm ","pptgrow","tempgrow") # Change the default names
plot(clim_cesm_85)
Conditions_cesm_85 <- terra::extract(clim_cesm_85,Poa_longlat)
clim_cesm85<-data.frame(Conditions_cesm_85)
```

*Raw data*

```{r,eval=FALSE}
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/CESM1.pdf",height = 7,width = 7,useDingbats = F)

par(mfrow=c(2,2))
hist(poar_2015_2016$pptgrow,xlab="Precipitation growing",xlim=c(10,1500),ylim=c(0,10),main="",col="grey")
hist(clim_past$pptgrow,col="pink",add=T)
hist(clim_cesm45$pptgrow,col="#F0E442",add=T)
hist(clim_cesm85$pptgrow,col="#0072B2",add=T)
hist(clim_current$pptgrow,col="green",add=T)

hist(poar_2015_2016$tempgrow,xlab="Temperature growing",xlim=c(5,25),main="",col="grey")
hist(clim_past$tempgrow,col="pink",add=T)
hist(clim_cesm45$tempgrow,col="#F0E442",add=T)
hist(clim_cesm85$tempgrow,col="#0072B2",add=T)
hist(clim_current$tempgrow,col="green",add=T)

hist(poar_2015_2016$pptdorm,xlab="Precipitation dormant",xlim=c(100,900),main="",col="grey")
hist(clim_past$pptdorm,col="pink",add=T)
hist(clim_cesm45$pptdorm,col="#F0E442",add=T)
hist(clim_cesm85$pptdorm,col="#0072B2",add=T)
hist(clim_current$pptdorm,col="green",add=T)
legend("topright",legend=c("Observed","Present","Past","RCP 4.5","RCP 8.5"),lwd=6,col =c("grey","green","pink","#F0E442","#0072B2") ,bty="n",cex=0.75)

hist(poar_2015_2016$tempdorm,xlab="Temperature dormant",xlim=c(20,35),ylim=c(0,8),main="",col="grey")
hist(clim_past$tempdorm,col="pink",add=T)
hist(clim_cesm45$tempdorm,col="#F0E442",add=T)
hist(clim_cesm85$tempdorm,col="#0072B2",add=T)
hist(clim_current$tempdorm,xlab="Temperature",col="green",add=T)
dev.off()

```


## Check for correlation between predictors for the seasonal data

```{r,eval=FALSE}
figgrow <-ggplot(data=poar_2015_2016, aes(x=scale(tempgrow), y=scale(pptgrow))) +
        geom_smooth(method="lm",color = "#0072B2") +
        geom_point(color = '#0072B2',shape = 19, size=4) +
        labs (x="Temperature of growing season",y="Precipitation of growing season") +
        ggpubr::stat_cor(aes(label=..rr.label..)) +
        theme_bw()

figdorm <- ggplot(data=poar_2015_2016, aes(x=scale(tempdorm), y=scale(pptdorm))) +
        geom_smooth(method="lm",color = "#0072B2") +
        geom_point(color = '#0072B2',shape = 19, size=4) +
        labs (x="Temperature of dormant season",y="Precipitation of dormant season") +
        ggpubr::stat_cor(aes(label=..rr.label..)) +
        theme_bw()

figppt <-ggplot(data=poar_2015_2016, aes(x=scale(pptdorm), y=scale(pptgrow))) +
        geom_smooth(method="lm",color = "#0072B2") +
        geom_point(color = '#0072B2',shape = 19, size=4) +
        labs (x="Precipitation of dormant season",y="Precipitation of growing season") +
        ggpubr::stat_cor(method = "pearson", label.x = 1, label.y = 1) +
        theme_bw()

figtemp <- ggplot(data=poar_2015_2016, aes(x=scale(tempdorm), y=scale(tempgrow))) +
        geom_smooth(method="lm",color = "#0072B2") +
        geom_point(color = '#0072B2',shape = 19, size=4) +
        labs (x="Temperature of dormant season",y="Temperature of growing season") +
        ggpubr::stat_cor(method = "pearson", label.x = -1.5, label.y = 1) +
        theme_bw()

(figgrowdorm<-ggpubr::ggarrange(plotlist = list(figgrow, figdorm)))
(figppttemp<-ggpubr::ggarrange(plotlist = list(figppt, figtemp)))
# pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/Varianceexplained.pdf",useDingbats = F,height=4,width=8)
# print(figgrowdorm)
# dev.off()
```

## Matching seasonnal data with observed demographic data

```{r}
poar.clim_seasonal <- left_join(x = poar_allsites_2015_2016,y =poar_2015_2016,by=c("site","census.year","Longitude","Latitude")) # merge the demographic data with climatic data for each site
# head(poar.clim_seasonal)
```


# Mixed effect models (vital rate vs. climate )

## Read and format data to build the model

```{r}
# Survival data
poar.clim_seasonal %>% 
  subset( tillerN_t0 > 0 )%>%
  dplyr::select(census.year, Code, site, Block, Sex, 
          Longitude, Latitude, 
          tillerN_t0, surv_t1,zpptgrow,zpptdorm,ztempgrow,ztempdorm,site)%>% 
  na.omit %>% 
  mutate( site= site %>% as.factor %>% as.numeric,
          Block = Block %>% as.factor %>% as.numeric,
          Sex = Sex %>% as.factor %>% as.numeric,
          source = Code %>% as.factor %>% as.numeric ) %>%
  mutate( log_size_t0   = log(tillerN_t0),
          z_ppt_t1_grow = zpptgrow,
          z_ppt_t1_dorm = zpptdorm,
          z_temp_t1_grow = ztempgrow,
          z_temp_t1_dorm = ztempdorm)->poarclim_seasonal.surv
# growth data
poar.clim_seasonal %>% 
  subset( tillerN_t0 > 0 & tillerN_t1 > 0)%>%
  dplyr::select( census.year, Code, site, Block, Sex, 
          Longitude, Latitude, 
          tillerN_t0, tillerN_t1,surv_t1,zpptgrow,zpptdorm,ztempgrow,ztempdorm,site)%>% 
  na.omit %>% 
  mutate( site= site %>% as.factor %>% as.numeric,
          Block = Block %>% as.factor %>% as.numeric,
          Sex= Sex %>% as.factor %>% as.numeric,
          source = Code %>% as.factor %>% as.numeric ) %>%
  mutate( log_size_t0   = log(tillerN_t0),
          z_ppt_t1_grow = zpptgrow,
          z_ppt_t1_dorm = zpptdorm,
          z_temp_t1_grow = ztempgrow,
          z_temp_t1_dorm = ztempdorm)->poarclim_seasonal.grow

# flowering data
poar.clim_seasonal %>% 
  subset( tillerN_t1 > 0 )%>%
  dplyr::select(census.year, Code, site, Block, Sex, 
          Longitude, Latitude, 
          tillerN_t1, flowerN_t1,flow_t1,zpptgrow,zpptdorm,ztempgrow,ztempdorm,site)%>% 
  na.omit %>% 
  mutate( site= site %>% as.factor %>% as.numeric,
          Block = Block %>% as.factor %>% as.numeric,
          Sex= Sex %>% as.factor %>% as.numeric,
          source = Code %>% as.factor %>% as.numeric ) %>%
  mutate( log_size_t1   = log(tillerN_t1),
          z_ppt_t1_grow = zpptgrow ,
          z_ppt_t1_dorm = zpptdorm ,
          z_temp_t1_grow = ztempgrow ,
          z_temp_t1_dorm = ztempdorm)->poarclim_seasonal.flow

# panicle data
poar.clim_seasonal %>% 
  subset( flowerN_t1 > 0 & tillerN_t1 > 0 )%>%
  dplyr::select( census.year, Code, site, Block, Sex, 
          Longitude, Latitude, 
          tillerN_t1, flowerN_t1,zpptgrow,zpptdorm,ztempgrow,ztempdorm,site)%>% 
  na.omit %>% 
  mutate( site = site %>% as.factor %>% as.numeric,
          Block = Block %>% as.factor %>% as.numeric,
          Sex= Sex %>% as.factor %>% as.numeric,
          source = Code %>% as.factor %>% as.numeric,
          panic_t1 = flowerN_t1) %>%
  mutate( 
          log_size_t1 = log(tillerN_t1),
          z_ppt_t1_grow = zpptgrow,
          z_ppt_t1_dorm = zpptdorm ,
          z_temp_t1_grow = ztempgrow ,
          z_temp_t1_dorm = ztempdorm )->poarclim_seasonal.panic

#seed viability and germination
viabVr <- read.csv("https://www.dropbox.com/s/jfkgoxgv8o1fgqx/viability.csv?dl=1")

# seed viability
viabVr %>% 
  dplyr::select( plot, totS, yesMaybe, sr_f ) %>% 
  dplyr::rename( SR        = sr_f,
          y_viab = yesMaybe,
          tot_seeds_viab = totS) %>% 
  dplyr::select(y_viab, tot_seeds_viab, SR ) %>% 
  na.omit ->viab

# seed germination
viabVr %>% 
  dplyr::select( plot, germTot, germFail, sr_f ) %>% 
  dplyr::rename( SR        = sr_f,
          y_germ    = germTot ) %>% 
  mutate(tot_seeds_germ = y_germ + germFail ) %>% 
  dplyr::select(y_germ, tot_seeds_germ, SR ) %>% 
  na.omit->germ

# seeds per panicle
viabVr %>% 
  dplyr::select(SeedN)  %>% 
  na.omit->seeds

```

```{r}
# bundle data for model
data_sites_season <- list( n_sites    = poarclim_seasonal.surv$site %>% n_distinct,
                  n_sources  = poarclim_seasonal.surv$source %>% n_distinct(),
                  # survival data
                  n_blocks_s = poarclim_seasonal.surv$Block %>% n_distinct,
                  site_s   = poarclim_seasonal.surv$site,
                  source_s =  poarclim_seasonal.surv$source,
                  block_s  = poarclim_seasonal.surv$Block,
                  pptgrow_s=as.vector(poarclim_seasonal.surv$z_ppt_t1_grow),
                  pptdorm_s=as.vector(poarclim_seasonal.surv$z_ppt_t1_dorm),
                  tempgrow_s=as.vector(poarclim_seasonal.surv$z_temp_t1_grow),
                  tempdorm_s=as.vector(poarclim_seasonal.surv$z_temp_t1_dorm),
                  site_block_s = data.frame( site_i  = poarclim_seasonal.surv$site,
                                             block_i = poarclim_seasonal.surv$Block ) %>%
                    unique %>% .$site_i,
                  male_s   = poarclim_seasonal.surv$Sex-1,
                  size_s   = poarclim_seasonal.surv$log_size_t0,
                  y_s      = poarclim_seasonal.surv$surv_t1,
                  n_s      = nrow(poarclim_seasonal.surv),
                  
                  # growth data
                  n_blocks_g = poarclim_seasonal.grow$Block %>% n_distinct,
                  site_g   = poarclim_seasonal.grow$site,
                  source_g =  poarclim_seasonal.grow$source,
                  block_g  = poarclim_seasonal.grow$Block,
                  pptgrow_g=as.vector(poarclim_seasonal.grow$z_ppt_t1_grow),
                  pptdorm_g=as.vector(poarclim_seasonal.grow$z_ppt_t1_dorm),
                  tempgrow_g=as.vector(poarclim_seasonal.grow$z_temp_t1_grow),
                  tempdorm_g=as.vector(poarclim_seasonal.grow$z_temp_t1_dorm),
                  site_block_g = data.frame( site_i  = poarclim_seasonal.grow$site,
                                             block_i = poarclim_seasonal.grow$Block ) %>%
                    unique %>% .$site_i,
                  male_g   = poarclim_seasonal.grow$Sex-1,
                  size_g   = poarclim_seasonal.grow$log_size_t0,
                  y_g      = poarclim_seasonal.grow$tillerN_t1,
                  n_g      = nrow(poarclim_seasonal.grow),
                  
                   # flowering data
                   n_blocks_f = poarclim_seasonal.flow$Block %>% n_distinct,
                  site_f   = poarclim_seasonal.flow$site,
                  source_f =  poarclim_seasonal.flow$source,
                  block_f  = poarclim_seasonal.flow$Block,
                  pptgrow_f=as.vector(poarclim_seasonal.flow$z_ppt_t1_grow),
                  pptdorm_f=as.vector(poarclim_seasonal.flow$z_ppt_t1_dorm),
                  tempgrow_f=as.vector(poarclim_seasonal.flow$z_temp_t1_grow),
                  tempdorm_f=as.vector(poarclim_seasonal.flow$z_temp_t1_dorm),
                  site_block_f = data.frame( site_i  = poarclim_seasonal.flow$site,
                                             block_i = poarclim_seasonal.flow$Block ) %>%
                    unique %>% .$site_i,
                  male_f   = poarclim_seasonal.flow$Sex-1,
                  size_f   = poarclim_seasonal.flow$log_size_t1,
                  y_f      = poarclim_seasonal.flow$flow_t1,
                  n_f      = nrow(poarclim_seasonal.flow),

                  # panicle data
                   n_blocks_p = poarclim_seasonal.panic$Block %>% n_distinct,
                  site_p   = poarclim_seasonal.panic$site,
                  source_p =  poarclim_seasonal.panic$source,
                  block_p  = poarclim_seasonal.panic$Block,
                  pptgrow_p=as.vector(poarclim_seasonal.panic$z_ppt_t1_grow),
                  pptdorm_p=as.vector(poarclim_seasonal.panic$z_ppt_t1_dorm),
                  tempgrow_p=as.vector(poarclim_seasonal.panic$z_temp_t1_grow),
                  tempdorm_p=as.vector(poarclim_seasonal.panic$z_temp_t1_dorm),
                  site_block_p = data.frame( site_i  = poarclim_seasonal.panic$site,
                                             block_i = poarclim_seasonal.panic$Block ) %>%
                    unique %>% .$site_i,
                  male_p   = poarclim_seasonal.panic$Sex-1,
                  size_p   = poarclim_seasonal.panic$log_size_t1,
                  y_p      = poarclim_seasonal.panic$panic_t1,
                  n_p      = nrow(poarclim_seasonal.panic),
                   # viability
                  n_v       = nrow(viab),
                  y_v       = viab$y_viab,
                  tot_seeds_v = viab$tot_seeds_viab,
                  SR_v        = viab$SR,
                  
                  # germination
                  n_m       = nrow(germ),
                  y_m       = germ$y_germ,
                  tot_seeds_m = germ$tot_seeds_germ,
                  SR_m        = germ$SR,
                  
                  # seeds per panicle
                  n_d = nrow(seeds),
                  y_d = seeds$SeedN
                  
                )
```

## Running the stan model

```{r , eval=FALSE}
# sim_pars <- list(
#   warmup = 1000,
#   iter = 4000,
#   thin = 3,
#   chains = 3
# )
# 
# fit_allsites_season <- stan(
#  file = "/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Analysis/stan/poar_season.stan",
#  data = data_sites_season,
#  warmup = sim_pars$warmup,
#  iter = sim_pars$iter,
#  thin = sim_pars$thin,
#  chains = sim_pars$chains)
# 
# saveRDS(fit_allsites_season, '/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/fit_1.5_0.5.rds')
```

## Chains convergence

```{r}
fit_allsites_season <- readRDS(url("https://www.dropbox.com/scl/fi/1sbhjorfv15ianvdwli96/fit_1.5_0.5.rds?rlkey=rm9sxy29qzc7himps7n6y0xw6&dl=1"))
#ignore warning from readRDS
```

```{r,eval=FALSE}
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/Traceplot_Survival.pdf",useDingbats = F,height=7,width=10)
traceplot(fit_allsites_season, pars = quote_bare(b0_s,bsizesex_s,btempgrowpptgrow_s,bsex_s,bpptdorm_s,
                                                        bsize_s,bpptgrow_s,btempgrow_s,btempdorm_s,
                                                        bpptgrowsex_s,btempgrowsex_s,bpptdormsex_s,
                                                        btempgrowpptgrowsex_s,btempdormpptdormsex_s,bpptgrow2_s,
                                                        btempgrow2_s,bpptgrow2sex_s,bpptdorm2_s,bpptdorm2sex_s,btempdorm2sex_s,
                                                        btempgrow2sex_s))+theme_bw()
dev.off()
```

```{r,eval=FALSE}
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/Traceplot_growth.pdf",useDingbats = F,height=7,width=10)
traceplot(fit_allsites_season, pars = quote_bare(b0_g,bsizesex_g,btempgrowpptgrow_g,bsex_g,bpptdorm_g,
                                                        bsize_g,bpptgrow_g,btempgrow_g,btempdorm_g,
                                                        bpptgrowsex_g,btempgrowsex_g,bpptdormsex_g,
                                                        btempgrowpptgrowsex_g,btempdormpptdormsex_g,bpptgrow2_g,
                                                        btempgrow2_g,bpptgrow2sex_g,bpptdorm2_g,bpptdorm2sex_g,btempdorm2sex_g,
                                                        btempgrow2sex_g),ncol=4)+theme_bw()
dev.off()
```

```{r,eval=FALSE}
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/Traceplot_Flowering.pdf",useDingbats = F,height=7,width=10)
traceplot(fit_allsites_season, pars = quote_bare(b0_f,bsizesex_f,btempgrowpptgrow_f,bsex_f,bpptdorm_f,
                                                        bsize_f,bpptgrow_f,btempgrow_f,btempdorm_f,
                                                        bpptgrowsex_f,btempgrowsex_f,bpptdormsex_f,
                                                        btempgrowpptgrowsex_f,btempdormpptdormsex_f,bpptgrow2_f,
                                                        btempgrow2_f,bpptgrow2sex_f,bpptdorm2_f,bpptdorm2sex_f,btempdorm2sex_f,
                                                        btempgrow2sex_f))+theme_bw()
dev.off()
```

```{r,eval=FALSE}
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/Traceplot_Panicles.pdf",useDingbats = F,height=7,width=10)
traceplot(fit_allsites_season, pars = quote_bare(b0_p,bsizesex_p,btempgrowpptgrow_p,bsex_p,bpptdorm_p,
                                                        bsize_p,bpptgrow_p,btempgrow_p,btempdorm_p,
                                                        bpptgrowsex_p,btempgrowsex_p,bpptdormsex_p,
                                                        btempgrowpptgrowsex_p,btempdormpptdormsex_p,bpptgrow2_p,
                                                        btempgrow2_p,bpptgrow2sex_p,bpptdorm2_p,bpptdorm2sex_p,btempdorm2sex_p,
                                                        btempgrow2sex_p))+theme_bw()
dev.off()
```

## Posterior predictive check for survival

```{r,eval=FALSE}
#pull out parameter posterior distributions
predS <- rstan::extract(fit_allsites_season, pars = c("predS"))$predS
predG <- rstan::extract(fit_allsites_season, pars = c("predG"))$predG
sigmaG <- rstan::extract(fit_allsites_season, pars = c("sigma"))$sigma
predF <- rstan::extract(fit_allsites_season, pars = c("predF"))$predF
predP <- rstan::extract(fit_allsites_season, pars = c("predP"))$predP
phi_P <- rstan::extract(fit_allsites_season, pars = c("phi_p"))$phi_p
predV <- rstan::extract(fit_allsites_season, pars = c("predV"))$predV
phi_V <- rstan::extract(fit_allsites_season, pars = c("phi_v"))$phi_v
predM <- rstan::extract(fit_allsites_season, pars = c("predM"))$predM
phi_M <- rstan::extract(fit_allsites_season, pars = c("phi_m"))$phi_m
#draw 500 random samples from the joint posterior
n_post_draws <- 500
post_draws <- sample.int(dim(predS)[1], n_post_draws)
#set up simulation output
y_s_sim <- matrix(NA,n_post_draws,length(data_sites_season$y_s))
y_g_sim <- matrix(NA,n_post_draws,length(data_sites_season$y_g))
y_f_sim <- matrix(NA,n_post_draws,length(data_sites_season$y_f))
y_p_sim <- matrix(NA,n_post_draws,length(data_sites_season$y_p))
y_v_sim <- matrix(NA,n_post_draws,length(data_sites_season$y_v))
y_m_sim <- matrix(NA,n_post_draws,length(data_sites_season$y_m))
#loop over the posterior and generate new observations
for(i in 1:n_post_draws){
  print(i)
  ## sample survival data (bernoulli)
  y_s_sim[i,] <- rbinom(n=length(data_sites_season$y_s), size=1, prob = invlogit(predS[i,]))
  ## sample flowering data (bernoulli)
  y_f_sim[i,] <- rbinom(n=length(data_sites_season$y_f), size=1, prob = invlogit(predF[i,]))
  ## sample viability data (beta-binomial)
  y_v_sim[i,] <- rbetabinom(n=length(data_sites_season$y_v), size=data_sites_season$tot_seeds_v, m=predV[i,], s=phi_V[i])
  ## sample germination data (beta-binomial)
  y_m_sim[i,] <- rbetabinom(n=length(data_sites_season$y_m), size=data_sites_season$tot_seeds_m, m=predM[i,], s=phi_M[i])
  ## sample growth data (zero-truncated PIG) -- generates data as legit PIG
    for(j in 1:length(data_sites_season$y_g)){
      ## the pig function appears numerically unstable at low probabilities, so here is a hacky solution
      pig<-dpoisinvgauss(0:1000,mean=predG[i,j],shape=(sigmaG[i]*predG[i,j]))
      pig[is.nan(pig) | is.infinite(pig)] <- 0
      pig_trunc_prob <- pig[2:1001] / (1 - ((1 - sum(pig)) + pig[1]))
      y_g_sim[i,j] <- sample(x=1:1000,size=1,replace=T,prob=pig_trunc_prob)
    } 
  ## sample panicle data (zero-truncated NB)
  for(j in 1:length(data_sites_season$y_p)){
    y_p_sim[i,j] <- sample(x=1:1000,size=1,replace=T,prob=dnbinom(1:1000, mu = exp(predP[i,j]), size=phi_P[i]) / (1 - dnbinom(0, mu = exp(predP[i,j]), size=phi_P[i])))
  }
}

```

```{r,eval=FALSE}
#plot ppc overlay
ppc_dens_overlay(data_sites_season$y_s, y_s_sim)+
  xlab("Survival status")+ylab("Density")+
  ggtitle(("Survival"))+theme(legend.position = "none")->ppc_surv
ppc_dens_overlay(data_sites_season$y_g, na.omit(y_g_sim))+xlim(0, 50)+
  xlab("Number of tillers")+ylab("Density")+
  ggtitle(("Growth"))+theme(legend.position = "none")->ppc_grow
ppc_dens_overlay(data_sites_season$y_f, y_f_sim)+
  xlab("Flowering status")+ylab("Density")+
  ggtitle(("Flowering"))+theme(legend.position = "none")->ppc_flow
ppc_dens_overlay(data_sites_season$y_p, y_p_sim)+xlim(0, 30)+
  xlab("Number of panicles")+ylab("Density")+
  ggtitle(("Panicles"))+theme(legend.position = "none")->ppc_panic
ppc_dens_overlay(data_sites_season$y_v, y_v_sim)+
  xlab("Number of viable seeds")+ylab("Density")+
  ggtitle(("Seed viability"))+theme(legend.position = "none")->ppc_viab
ppc_dens_overlay(data_sites_season$y_m, y_m_sim)+
  xlab("Number of germinants")+ylab("Density")+
  ggtitle(("Seed germination"))+theme(legend.position = "none")->ppc_germ

#print figure
# pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/PPC.pdf",useDingbats = F,height=10,width=6)
# multiplot(ppc_surv,ppc_flow,ppc_viab,
#           ppc_grow,ppc_panic,ppc_germ,cols=2)
# dev.off()
```

# Posterior mean values for each vital rate

```{r}
posterior_season <- as.array(fit_allsites_season)
color_scheme_set("orange")
surv_clim<-mcmc_intervals(posterior_season, pars = quote_bare(b0_s,bsizesex_s,btempgrowpptgrow_s,btempdormpptdorm_s,bsex_s,bpptdorm_s,
                                                        bsize_s,bpptgrow_s,btempgrow_s,btempdorm_s,
                                                        bpptgrowsex_s,btempgrowsex_s,bpptdormsex_s,btempdormsex_s,
                                                        btempgrowpptgrowsex_s,btempdormpptdormsex_s,bpptgrow2_s,
                                                        btempgrow2_s,btempdorm2_s,bpptgrow2sex_s,bpptdorm2_s,bpptdorm2sex_s,btempdorm2sex_s,
                                                        btempgrow2sex_s)) + 
  ggplot2::scale_y_discrete(limits = c("b0_s","bsex_s", "bsize_s","bsizesex_s",
                                       "bpptgrow_s","bpptdorm_s","btempgrow_s","btempdorm_s",
                                       "bpptgrowsex_s","bpptdormsex_s", "btempdormsex_s","btempgrowsex_s",
                                        "btempgrowpptgrowsex_s", "btempdormpptdormsex_s", 
                                       "btempgrowpptgrow_s","btempdormpptdorm_s",
                                       "bpptgrow2_s","bpptdorm2_s","btempdorm2_s","btempgrow2_s",
                                       "bpptdorm2sex_s","bpptgrow2sex_s","btempdorm2sex_s", "btempgrow2sex_s"),
                            labels=c("b0_s"="Intercept",
                                     "bsex_s"="sex",
                                     "bsize_s"="size",
                                     "bsizesex_s"="size:sex",
                                     "bpptgrow_s"="pptgrow",
                                     "bpptdorm_s"="pptdorm",
                                     "btempgrow_s"="tempgrow",
                                     "btempdorm_s"="tempdorm",
                                     "bpptgrowsex_s"="pptgrow:sex",
                                     "bpptdormsex_s"="pptdorm:sex",
                                     "btempdormsex_s"="tempdorm:sex",
                                     "btempgrowsex_s"="tempgrow:sex",  
                                     "btempgrowpptgrowsex_s"="tempgrow:pptgrow:sex",
                                     "btempdormpptdormsex_s"="tempdorm:pptdorm:sex",
                                     "btempgrowpptgrow_s"="tempgrow:pptgrow",
                                     "btempdormpptdorm_s"="tempdorm:pptdorm",
                                     "bpptgrow2_s"=expression(pptgrow^2),
                                     "btempgrow2_s"=expression(tempgrow^2),
                                     "bpptdorm2_s"=expression(pptdorm^2),
                                     "btempdorm2_s"=expression(tempdorm^2),
                                     "bpptdorm2sex_s"=expression(pptdorm^2:sex),
                                     "btempdorm2sex_s"=expression(tempdorm^2:sex),
                                     "bpptgrow2sex_s"=expression(pptgrow^2:sex),
                                     "btempgrow2sex_s"=expression(tempgrow^2:sex)))+
  geom_vline(xintercept = 0, linetype = "dashed", size = 0.6, alpha = 0.6, color = "black") +
  labs(color = "Interaction type:")+
  xlab("Posterior estimates (Survival)")+
  xlim(-2,2)+
  ggtitle("A") +
  # geom_rect(xmin = 0, xmax=2.25, ymin = 0, ymax = 25, alpha = 0.006, fill = "#F4B400", color = NA)+
  # geom_rect(xmin = -2.25, xmax = 0, ymin = 0, ymax = 25, alpha = 0.006, fill = "#0F9D58", color = NA)+
  theme_pubr()+
  theme(axis.title.x = element_text(family = "Helvetica",colour="black", size = 13),
        axis.title.y = element_blank(),
        axis.text.x = element_text(size = 12),
        axis.text.y  = element_text(size = 10),
        axis.line.x = element_line(linewidth = 0.1),
        axis.line.y = element_line(linewidth = 0.1),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(colour = "black", size=0.5))

grow_clim<-mcmc_intervals(posterior_season, pars = quote_bare(b0_g,bsizesex_g,btempgrowpptgrow_g,btempdormpptdorm_g,bsex_g,bpptdorm_g,
                                                        bsize_g,bpptgrow_g,btempgrow_g,btempdorm_g,
                                                        bpptgrowsex_g,btempgrowsex_g,bpptdormsex_g,btempdormsex_g,
                                                        btempgrowpptgrowsex_g,btempdormpptdormsex_g,bpptgrow2_g,
                                                        btempgrow2_g,btempdorm2_g,bpptgrow2sex_g,bpptdorm2_g,bpptdorm2sex_g,btempdorm2sex_g,
                                                        btempgrow2sex_g)) + 
  ggplot2::scale_y_discrete(limits = c("b0_g","bsex_g", "bsize_g","bsizesex_g",
                                       "bpptgrow_g","bpptdorm_g","btempgrow_g","btempdorm_g",
                                       "bpptgrowsex_g","bpptdormsex_g", "btempdormsex_g","btempgrowsex_g",
                                        "btempgrowpptgrowsex_g", "btempdormpptdormsex_g", 
                                       "btempgrowpptgrow_g","btempdormpptdorm_g",
                                       "bpptgrow2_g","bpptdorm2_g","btempdorm2_g","btempgrow2_g",
                                       "bpptdorm2sex_g","bpptgrow2sex_g","btempdorm2sex_g", "btempgrow2sex_g"),
                            labels=c("b0_g"="Intercept",
                                     "bsize_g"="size",
                                     "bsex_g"="sex",
                                     "bsizesex_g"="size:sex",
                                     "bpptgrow_g"="pptgrow",
                                     "bpptdorm_g"="pptdorm",
                                     "btempgrow_g"="tempgrow",
                                     "btempdorm_g"="tempdorm",
                                    "bpptgrowsex_g"="pptgrow:sex",
                                    "bpptdormsex_g"="pptdorm:sex",
                                    "btempdormsex_g"="tempdorm:sex",
                                    "btempgrowsex_g"="tempgrow:sex",  
                                 "btempgrowpptgrowsex_g"="tempgrow:pptgrow:sex",
                                 "btempdormpptdormsex_g"="tempdorm:pptdorm:sex",
                                     "btempgrowpptgrow_g"="tempgrow:pptgrow",
                                 "btempdormpptdorm_g"="tempdorm:pptdorm",
                                 "bpptgrow2_g"=expression(pptgrow^2),
                                 "btempgrow2_g"=expression(tempgrow^2),
                                 "bpptdorm2_g"=expression(pptdorm^2),
                                 "btempdorm2_g"=expression(tempdorm^2),
                                  "bpptdorm2sex_g"=expression(pptdorm^2:sex),
                                 "btempdorm2sex_g"=expression(tempdorm^2:sex),
                                 "bpptgrow2sex_g"=expression(pptgrow^2:sex),
                                 "btempgrow2sex_g"=expression(tempgrow^2:sex)))+
  geom_vline(xintercept = 0, linetype = "dashed", size = 0.6, alpha = 0.6, color = "black") +
  labs(color = "Interaction type:")+
  xlab("Posterior estimates (Growth)")+
  ylab(NULL) +
  xlim(-1.5,1.5)+
  ggtitle("B") +
  # geom_rect(xmin = 0, xmax=2.25, ymin = 0, ymax = 25, alpha = 0.006, fill = "#F4B400", color = NA)+
  # geom_rect(xmin = -2.25, xmax = 0, ymin = 0, ymax = 25, alpha = 0.006, fill = "#0F9D58", color = NA)+
  theme_pubr()+
  theme(axis.title.x = element_text(family = "Helvetica",colour="black", size = 13),
        axis.title.y = element_blank(),
        axis.text.x = element_text(size = 12),
        axis.text.y  = element_text(size = 10),
        axis.line.x = element_line(linewidth = 0.1),
        axis.line.y = element_line(linewidth = 0.1),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(colour = "black", size=0.5))

flow_clim<-mcmc_intervals(posterior_season, pars = quote_bare(b0_g,bsizesex_f,btempgrowpptgrow_f,btempdormpptdorm_f,bsex_f,bpptdorm_f,
                                                        bsize_f,bpptgrow_f,btempgrow_f,btempdorm_f,
                                                        bpptgrowsex_f,btempgrowsex_f,bpptdormsex_f,btempdormsex_f,
                                                        btempgrowpptgrowsex_f,btempdormpptdormsex_f,bpptgrow2_f,
                                                        btempgrow2_f,btempdorm2_f,bpptgrow2sex_f,bpptdorm2_f,bpptdorm2sex_f,btempdorm2sex_f,
                                                        btempgrow2sex_f)) + 
  ggplot2::scale_y_discrete(limits = c("b0_f","bsex_f", "bsize_f","bsizesex_f",
                                       "bpptgrow_f","bpptdorm_f","btempgrow_f","btempdorm_f",
                                       "bpptgrowsex_f","bpptdormsex_f", "btempdormsex_f","btempgrowsex_f",
                                        "btempgrowpptgrowsex_f", "btempdormpptdormsex_f", 
                                       "btempgrowpptgrow_f","btempdormpptdorm_f",
                                       "bpptgrow2_f","bpptdorm2_f","btempdorm2_f","btempgrow2_f",
                                       "bpptdorm2sex_f","bpptgrow2sex_f","btempdorm2sex_f", "btempgrow2sex_f"),
                            labels=c("b0_f"="Intercept",
                                     "bsize_f"="size",
                                     "bsex_f"="sex",
                                     "bsizesex_f"="size:sex",
                                     "bpptgrow_f"="pptgrow",
                                     "bpptdorm_f"="pptdorm",
                                     "btempgrow_f"="tempgrow",
                                     "btempdorm_f"="tempdorm",
                                    "bpptgrowsex_f"="pptgrow:sex",
                                    "bpptdormsex_f"="pptdorm:sex",
                                    "btempdormsex_f"="tempdorm:sex",
                                    "btempgrowsex_f"="tempgrow:sex",  
                                 "btempgrowpptgrowsex_f"="tempgrow:pptgrow:sex",
                                 "btempdormpptdormsex_f"="tempdorm:pptdorm:sex",
                                     "btempgrowpptgrow_f"="tempgrow:pptgrow",
                                 "btempdormpptdorm_f"="tempdorm:pptdorm",
                                    "bpptgrow2_f"=expression(pptgrow^2),
                                 "btempgrow2_f"=expression(tempgrow^2),
                                 "bpptdorm2_f"=expression(pptdorm^2),
                                 "btempdorm2_f"=expression(tempdorm^2),
                                    "bpptdorm2sex_f"=expression(pptdorm^2:sex),
                                 "btempdorm2sex_f"=expression(tempdorm^2:sex),
                                 "bpptgrow2sex_f"=expression(pptgrow^2:sex),
                                 "btempgrow2sex_f"=expression(tempgrow^2:sex)))+
  geom_vline(xintercept = 0, linetype = "dashed", size = 0.6, alpha = 0.6, color = "black") +
  labs(color = "Interaction type:")+
  xlab("Posterior estimates (Flowering)")+
  ylab(NULL) +
  xlim(-2,2)+
  ggtitle("C") +
  # geom_rect(xmin = 0, xmax=2.25, ymin = 0, ymax = 25, alpha = 0.006, fill = "#F4B400", color = NA)+
  # geom_rect(xmin = -2.25, xmax = 0, ymin = 0, ymax = 25, alpha = 0.006, fill = "#0F9D58", color = NA)+
  theme_pubr()+
  theme(axis.title.x = element_text(family = "Helvetica",colour="black", size = 13),
        axis.title.y = element_blank(),
        axis.text.x = element_text(size = 12),
        axis.text.y  = element_text(size = 10),
        axis.line.x = element_line(linewidth = 0.1),
        axis.line.y = element_line(linewidth = 0.1),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(colour = "black", size=0.5))

panic_clim<-mcmc_intervals(posterior_season, pars = quote_bare(b0_p,bsizesex_p,btempgrowpptgrow_p,btempdormpptdorm_p,bsex_p,bpptdorm_p,
                                                        bsize_p,bpptgrow_p,btempgrow_p,btempdorm_p,
                                                        bpptgrowsex_p,btempgrowsex_p,bpptdormsex_p,btempdormsex_p,
                                                        btempgrowpptgrowsex_p,btempdormpptdormsex_p,bpptgrow2_p,
                                                        btempgrow2_p,btempdorm2_p,bpptgrow2sex_p,bpptdorm2_p,bpptdorm2sex_p,btempdorm2sex_p,
                                                        btempgrow2sex_p)) + 
  ggplot2::scale_y_discrete(limits = c("b0_p","bsex_p", "bsize_p","bsizesex_p",
                                       "bpptgrow_p","bpptdorm_p","btempgrow_p","btempdorm_p",
                                       "bpptgrowsex_p","bpptdormsex_p", "btempdormsex_p","btempgrowsex_p",
                                        "btempgrowpptgrowsex_p", "btempdormpptdormsex_p", 
                                       "btempgrowpptgrow_p","btempdormpptdorm_p",
                                       "bpptgrow2_p","bpptdorm2_p","btempdorm2_p","btempgrow2_p",
                                       "bpptdorm2sex_p","bpptgrow2sex_p","btempdorm2sex_p", "btempgrow2sex_p"),
                            labels=c("b0_p"="Intercept","bsize_p"="size","bsex_p"="sex",
                                     "bsizesex_p"="size:sex",
                                     "bpptgrow_p"="pptgrow","bpptdorm_p"="pptdorm","btempgrow_p"="tempgrow","btempdorm_p"="tempdorm",
                                    "bpptgrowsex_p"="pptgrow:sex","bpptdormsex_p"="pptdorm:sex","btempdormsex_p"="tempdorm:sex","btempgrowsex_p"="tempgrow:sex",  
                                 "btempgrowpptgrowsex_p"="tempgrow:pptgrow:sex","btempdormpptdormsex_p"="tempdorm:pptdorm:sex",
                                     "btempgrowpptgrow_p"="tempgrow:pptgrow", "btempdormpptdorm_p"="tempdorm:pptdorm",
                                     "bpptgrow2_p"=expression(pptgrow^2),"btempgrow2_p"=expression(tempgrow^2),"bpptdorm2_p"=expression(pptdorm^2),"btempdorm2_p"=expression(tempdorm^2),
                                     "bpptdorm2sex_p"=expression(pptdorm^2:sex),"btempdorm2sex_p"=expression(tempdorm^2:sex),"bpptgrow2sex_p"=expression(pptgrow^2:sex),"btempgrow2sex_p"=expression(tempgrow^2:sex)))+
  geom_vline(xintercept = 0, linetype = "dashed", size = 0.6, alpha = 0.6, color = "white") +
  labs(color = "Interaction type:")+
  xlab("Posterior estimates (Panicles)")+
  ylab(NULL) +
  xlim(-1,1)+
  ggtitle("D") +
  # geom_rect(xmin = 0, xmax=2.25, ymin = 0, ymax = 25, alpha = 0.006, fill = "#F4B400", color = NA)+
  # geom_rect(xmin = -2.25, xmax = 0, ymin = 0, ymax = 25, alpha = 0.006, fill = "#0F9D58", color = NA)+
  theme_pubr()+
  theme(axis.title.x = element_text(family = "Helvetica",colour="black", size = 13),
        axis.title.y = element_blank(),
        axis.text.x = element_text(size = 12),
        axis.text.y  = element_text(size = 10),
        axis.line.x = element_line(linewidth = 0.1),
        axis.line.y = element_line(linewidth = 0.1),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(colour = "black", size=0.5))


```

```{r,eval=FALSE}
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/Posterior_mean.pdf",useDingbats = F,height=12,width=10)
ggarrange(surv_clim,grow_clim,flow_clim,panic_clim + rremove("ylab"), ncol = 2, nrow = 2)
dev.off()
```

# Vital rate figure (observed data)

```{r}
poar <- poar.clim_seasonal  
fit_full <- fit_allsites_season  

# bin size groups for visualization
size_bin_num <- 1

## re-format data for plotting
## Survival
poar %>% 
  subset( tillerN_t0 > 0 )%>%
  dplyr::select(census.year, Code, site, Block, Sex, 
          Longitude, Latitude, 
          tillerN_t0, surv_t1,zpptgrow,zpptdorm,ztempgrow,ztempdorm,site)%>% 
  na.omit %>% 
  mutate( site         = site %>% as.factor %>% as.numeric,
          Block = Block %>% as.factor %>% as.numeric,
          Sex          = Sex %>% as.factor %>% as.numeric,
          source = Code %>% as.factor %>% as.numeric ) %>%
  mutate( log_size_t0   = log(tillerN_t0),
          z_size_t0   = tillerN_t0 %>% scale %>% .[,1],
          z_ppt_t1_grow = zpptgrow,
          z_ppt_t1_dorm = zpptdorm ,
          z_temp_t1_grow = ztempgrow ,
          z_temp_t1_dorm = ztempdorm)->poar.surv


poar_surv_binned <- poar.surv %>% 
  mutate(size_bin = as.integer(cut_number(log_size_t0,size_bin_num))) %>% 
  group_by(site,census.year,Sex,size_bin) %>% 
  summarise(mean_size = mean(log_size_t0),
            mean_surv = mean(surv_t1),
            pptgrow = unique(z_ppt_t1_grow),
            pptdorm = unique(z_ppt_t1_dorm),
            tempgrow = unique(z_temp_t1_grow),
            tempdorm = unique(z_temp_t1_dorm),
            bin_n = n())

surv_mean_sizes <- poar_surv_binned %>% group_by(Sex,size_bin) %>% summarise(size = mean(mean_size))
surv_mean_pptgrow <- poar_surv_binned %>% group_by(Sex,size_bin) %>% summarise(pptgrow = mean(pptgrow))
surv_mean_tempgrow <- poar_surv_binned %>% group_by(Sex,size_bin) %>% summarise(tempgrow = mean(tempgrow))
surv_mean_pptdorm <- poar_surv_binned %>% group_by(Sex,size_bin) %>% summarise(pptdorm = mean(pptdorm))
surv_mean_tempdorm <- poar_surv_binned %>% group_by(Sex,size_bin) %>% summarise(tempdorm = mean(tempdorm))

## Growth
poar %>% 
  subset( tillerN_t0 > 0 & tillerN_t1 > 0)%>%
  dplyr::select( census.year, Code, site, Block, Sex, 
          Longitude, Latitude, 
          tillerN_t0, tillerN_t1,surv_t1,zpptgrow,zpptdorm,ztempgrow,ztempdorm,site)%>% 
  na.omit %>% 
  mutate( site         = site %>% as.factor %>% as.numeric,
          Block = Block %>% as.factor %>% as.numeric,
          Sex          = Sex %>% as.factor %>% as.numeric,
          source = Code %>% as.factor %>% as.numeric ) %>%
  mutate( log_size_t0   = log(tillerN_t0),
          z_size_t0   = tillerN_t0,
          z_ppt_t1_grow = zpptgrow,
          z_ppt_t1_dorm = zpptdorm,
          z_temp_t1_grow = ztempgrow,
          z_temp_t1_dorm = ztempdorm)->poar.grow

poar_grow_binned <- poar.grow %>% 
  mutate(size_bin = as.integer(cut_number(log_size_t0,size_bin_num))) %>% 
  group_by(site,census.year,Sex,size_bin) %>% 
  summarise(mean_size = mean(log_size_t0),
            mean_grow = mean(tillerN_t1),
            pptgrow = unique(z_ppt_t1_grow),
            pptdorm = unique(z_ppt_t1_dorm),
            tempgrow = unique(z_temp_t1_grow),
            tempdorm = unique(z_temp_t1_dorm),
            bin_n = n())
grow_mean_sizes <- poar_grow_binned %>% group_by(Sex,size_bin) %>% summarise(size = mean(mean_size))
grow_mean_pptgrow <- poar_grow_binned %>% group_by(Sex,size_bin) %>% summarise(pptgrow = mean(pptgrow))
grow_mean_tempgrow <- poar_grow_binned %>% group_by(Sex,size_bin) %>% summarise(tempgrow = mean(tempgrow))
grow_mean_pptdorm <- poar_grow_binned %>% group_by(Sex,size_bin) %>% summarise(pptdorm = mean(pptdorm))
grow_mean_tempdorm <- poar_grow_binned %>% group_by(Sex,size_bin) %>% summarise(tempdorm = mean(tempdorm))

## Flowering
poar %>% 
  subset( tillerN_t1 > 0 )%>%
  dplyr::select(census.year, Code, site, Block, Sex, 
          Longitude, Latitude, 
          tillerN_t1, flowerN_t1,flow_t1,zpptgrow,zpptdorm,ztempgrow,ztempdorm,site)%>% 
  na.omit %>% 
  mutate( site         = site %>% as.factor %>% as.numeric,
          Block = Block %>% as.factor %>% as.numeric,
          Sex          = Sex %>% as.factor %>% as.numeric,
          source = Code %>% as.factor %>% as.numeric ) %>%
  mutate( log_size_t1   = log(tillerN_t1),
          z_size_t1 = tillerN_t1 %>% scale %>% .[,1],
          z_ppt_t1_grow = zpptgrow,
          z_ppt_t1_dorm = zpptdorm ,
          z_temp_t1_grow = ztempgrow,
          z_temp_t1_dorm = ztempdorm)->poar.flow

poar_flow_binned <- poar.flow %>% 
  mutate(size_bin = as.integer(cut_number(log_size_t1,size_bin_num))) %>% 
  group_by(site,census.year,Sex,size_bin) %>% 
  summarise(mean_size = mean(log_size_t1),
            mean_flow = mean(flow_t1),
            pptgrow = unique(z_ppt_t1_grow),
            pptdorm = unique(z_ppt_t1_dorm),
            tempgrow = unique(z_temp_t1_grow),
            tempdorm = unique(z_temp_t1_dorm),
            bin_n = n())
flow_mean_sizes <- poar_flow_binned %>% group_by(Sex,size_bin) %>% summarise(size = mean(mean_size))
flow_mean_pptgrow <- poar_flow_binned %>% group_by(Sex,size_bin) %>% summarise(pptgrow = mean(pptgrow))
flow_mean_tempgrow <- poar_flow_binned %>% group_by(Sex,size_bin) %>% summarise(tempgrow = mean(tempgrow))
flow_mean_pptdorm <- poar_flow_binned %>% group_by(Sex,size_bin) %>% summarise(pptdorm = mean(pptdorm))
flow_mean_tempdorm <- poar_flow_binned %>% group_by(Sex,size_bin) %>% summarise(tempdorm = mean(tempdorm))

## Panicles
poar %>% 
  subset( flowerN_t1 > 0 & tillerN_t1 > 0 )%>%
  dplyr::select( census.year, Code, site, Block, Sex, 
          Longitude, Latitude, 
          tillerN_t1, flowerN_t1,zpptgrow,zpptdorm,ztempgrow,ztempdorm,site)%>% 
  na.omit %>% 
  mutate( site         = site %>% as.factor %>% as.numeric,
          Block = Block %>% as.factor %>% as.numeric,
          Sex          = Sex %>% as.factor %>% as.numeric,
          source = Code %>% as.factor %>% as.numeric,
          panic_t1 = flowerN_t1) %>%
  mutate( 
          log_size_t1   = log(tillerN_t1),
          z_size_t1 = tillerN_t1 %>% scale %>% .[,1],
          z_ppt_t1_grow = zpptgrow ,
          z_ppt_t1_dorm = zpptdorm ,
          z_temp_t1_grow = ztempgrow ,
          z_temp_t1_dorm = ztempdorm)->poar.panic

poar_panic_binned <- poar.panic %>% 
  mutate(size_bin = as.integer(cut_number(log_size_t1,size_bin_num))) %>% 
  group_by(site,census.year,Sex,size_bin) %>% 
  summarise(mean_size = mean(log_size_t1),
            mean_panic = mean(panic_t1),
            pptgrow = unique(z_ppt_t1_grow),
            pptdorm = unique(z_ppt_t1_dorm),
            tempgrow = unique(z_temp_t1_grow),
            tempdorm = unique(z_temp_t1_dorm),
            bin_n = n())

panic_mean_sizes <- poar_panic_binned %>% group_by(Sex,size_bin) %>% summarise(size = mean(mean_size))
panic_mean_pptgrow <- poar_panic_binned %>% group_by(Sex,size_bin) %>% summarise(pptgrow = mean(pptgrow))
panic_mean_tempgrow <- poar_panic_binned %>% group_by(Sex,size_bin) %>% summarise(tempgrow = mean(tempgrow))
panic_mean_pptdorm <- poar_panic_binned %>% group_by(Sex,size_bin) %>% summarise(pptdorm = mean(pptdorm))
panic_mean_tempdorm <- poar_panic_binned %>% group_by(Sex,size_bin) %>% summarise(tempdorm = mean(tempdorm))
```

```{r}
# pull out stan coefficients
surv_coef <- rstan::extract(fit_full, pars = quote_bare(b0_s,bsizesex_s,btempdormpptdorm_s,btempgrowpptgrow_s,bsex_s,
                                                        bsize_s,bpptgrow_s,bpptdorm_s,btempgrow_s,btempdorm_s,
                                                        bpptgrowsex_s,bpptdormsex_s,btempgrowsex_s,btempdormsex_s,
                                                        btempdormpptdormsex_s,btempgrowpptgrowsex_s,bpptgrow2_s,
                                                        bpptdorm2_s,btempgrow2_s,btempdorm2_s,bpptgrow2sex_s,bpptdorm2sex_s,
                                                        btempgrow2sex_s,btempdorm2sex_s,
                                                        site_tau_s,block_tau_s,source_tau_s))

grow_coef <- rstan::extract(fit_full, pars = quote_bare(b0_g,btempdormpptdorm_g,btempgrowpptgrow_g,bsizesex_g,bsex_g,
                                                        bsize_g,bpptgrow_g,bpptdorm_g,btempgrow_g,btempdorm_g,bpptgrowsex_g,
                                                        bpptdormsex_g,btempgrowsex_g,btempdormsex_g,btempdormpptdormsex_g,
                                                        btempgrowpptgrowsex_g,bpptgrow2_g,bpptdorm2_g,btempgrow2_g,btempdorm2_g,
                                                        bpptgrow2sex_g,bpptdorm2sex_g,btempgrow2sex_g,btempdorm2sex_g,
                                                        site_tau_g,block_tau_g,source_tau_g,sigma))

flow_coef <- rstan::extract(fit_full, pars = quote_bare(b0_f,bsizesex_f,bsex_f, bsize_f,bpptgrow_f,bpptdorm_f,btempgrow_f,
                                                        btempdorm_f,bpptgrowsex_f,bpptdormsex_f,btempgrowsex_f,btempdormsex_f,
                                                        btempdormpptdorm_f,btempgrowpptgrow_f,btempdormpptdormsex_f,
                                                        btempgrowpptgrowsex_f,bpptgrow2_f,bpptdorm2_f,btempgrow2_f,
                                                        btempdorm2_f,bpptgrow2sex_f,bpptdorm2sex_f,btempgrow2sex_f,btempdorm2sex_f,
                                                        site_tau_f,block_tau_f,source_tau_f))

panic_coef <- rstan::extract(fit_full, pars = quote_bare(b0_p,bsex_p,bsex_p,bsizesex_p, bsize_p,bpptgrow_p,bpptdorm_p,
                                                         btempgrow_p,btempdorm_p,bpptgrowsex_p,bpptdormsex_p,btempgrowsex_p,
                                                         btempdormsex_p,btempdormpptdorm_p,btempgrowpptgrow_p,btempdormpptdormsex_p,
                                                         btempgrowpptgrowsex_p,bpptgrow2_p,bpptdorm2_p,btempgrow2_p,
                                                         btempdorm2_p,bpptgrow2sex_p,bpptdorm2sex_p,btempgrow2sex_p,btempdorm2sex_p,
                                                         site_tau_p,block_tau_p,source_tau_p))

via_coef <- rstan::extract(fit_full, pars = quote_bare(v0,a_v,m,lambda_d))
```

## Precipitation of the growing season

```{r}
# sample vital rate functions from the join posterior
pptgrow_seq <- seq(min(poar_surv_binned$pptgrow),max(poar_surv_binned$pptgrow),length.out=30)
n_post_draws <- 2000
post_draws <- sample.int(length(surv_coef$b0_s), n_post_draws)
surv_sex_diff_post_pptgrow <- grow_sex_diff_post_pptgrow <- flow_sex_diff_post_pptgrow <- panic_sex_diff_post_pptgrow <- array(NA,dim=c(size_bin_num,length(pptgrow_seq),n_post_draws))
for(p in 1:n_post_draws){
  for(i in 1:size_bin_num){
    s=1;      
    fem_s <- invlogit((surv_coef$b0_s[post_draws[p]]) + 
                         (surv_coef$bsize_s[post_draws[p]]) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i]+
                         (surv_coef$bsizesex_s[post_draws[p]]) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i] * (s-1) +
                         (surv_coef$bsex_s[post_draws[p]]) * (s-1) +
                         (surv_coef$bpptgrow_s[post_draws[p]]) * pptgrow_seq +
                         (surv_coef$bpptdorm_s[post_draws[p]]) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s]  +
                         (surv_coef$btempgrow_s[post_draws[p]]) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                         (surv_coef$btempdorm_s[post_draws[p]]) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] +
                         (surv_coef$bpptgrowsex_s[post_draws[p]]) * pptgrow_seq * (s-1) +
                         (surv_coef$bpptdormsex_s[post_draws[p]]) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s]  * (s-1) +
                         (surv_coef$btempgrowsex_s[post_draws[p]]) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * (s-1) +
                        (surv_coef$btempdormsex_s[post_draws[p]]) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * (s-1) +
                         (surv_coef$btempdormpptdorm_s[post_draws[p]]) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] +
                         (surv_coef$btempgrowpptgrow_s[post_draws[p]]) * pptgrow_seq * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                         (surv_coef$btempdormpptdormsex_s[post_draws[p]]) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] * (s-1) +
                         (surv_coef$btempgrowpptgrowsex_s[post_draws[p]]) * pptgrow_seq * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * (s-1) +
                         (surv_coef$bpptgrow2_s[post_draws[p]]) * (pptgrow_seq^2) +
                         (surv_coef$bpptdorm2_s[post_draws[p]]) * (surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s])^2 +
                         (surv_coef$btempgrow2_s[post_draws[p]]) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 +
                         (surv_coef$btempdorm2_s[post_draws[p]]) * (surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s])^2 +
                         (surv_coef$bpptgrow2sex_s[post_draws[p]]) * (pptgrow_seq^2) * (s-1) +
                         (surv_coef$bpptdorm2sex_s[post_draws[p]]) * (surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s])^2 * (s-1) +
                         (surv_coef$btempgrow2sex_s[post_draws[p]]) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 * (s-1) +
                         (surv_coef$btempdorm2sex_s[post_draws[p]]) * (surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s])^2 * (s-1)
    )
    
    fem_g <- exp((grow_coef$b0_g[post_draws[p]]) + 
                         (grow_coef$bsize_g[post_draws[p]]) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i]+
                         (grow_coef$bsizesex_g[post_draws[p]]) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i] * (s-1) +
                         (grow_coef$bsex_g[post_draws[p]]) * (s-1) +
                         (grow_coef$bpptgrow_g[post_draws[p]]) * pptgrow_seq +
                         (grow_coef$bpptdorm_g[post_draws[p]]) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s]  +
                         (grow_coef$btempgrow_g[post_draws[p]]) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                         (grow_coef$btempdorm_g[post_draws[p]]) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] +
                         (grow_coef$bpptgrowsex_g[post_draws[p]]) * pptgrow_seq * (s-1) +
                         (grow_coef$bpptdormsex_g[post_draws[p]]) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s]  * (s-1) +
                         (grow_coef$btempgrowsex_g[post_draws[p]]) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] * (s-1) +
                        (grow_coef$btempdormsex_g[post_draws[p]]) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * (s-1) +
                         (grow_coef$btempdormpptdorm_g[post_draws[p]]) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] +
                         (grow_coef$btempgrowpptgrow_g[post_draws[p]]) * pptgrow_seq * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                         (grow_coef$btempdormpptdormsex_g[post_draws[p]]) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] * (s-1) +
                         (grow_coef$btempgrowpptgrowsex_g[post_draws[p]]) * pptgrow_seq * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s]  * (s-1) +
                         (grow_coef$bpptgrow2_g[post_draws[p]]) * (pptgrow_seq^2) +
                         (grow_coef$bpptdorm2_g[post_draws[p]]) * (grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s])^2 +
                         (grow_coef$btempgrow2_g[post_draws[p]]) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 +
                         (grow_coef$btempdorm2_g[post_draws[p]]) * (grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s])^2 +
                         (grow_coef$bpptgrow2sex_g[post_draws[p]]) * (pptgrow_seq^2) * (s-1) +
                         (grow_coef$bpptdorm2sex_g[post_draws[p]]) * (grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s])^2 * (s-1) +
                         (grow_coef$btempgrow2sex_g[post_draws[p]]) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 * (s-1) +
                         (grow_coef$btempdorm2sex_g[post_draws[p]]) * (grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s])^2 * (s-1)
    )
    
    fem_f <- invlogit((flow_coef$b0_f[post_draws[p]]) + 
                         (flow_coef$bsize_f[post_draws[p]]) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i] +
                         (flow_coef$bsizesex_f[post_draws[p]]) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i] * (s-1) +
                         (flow_coef$bsex_f[post_draws[p]]) * (s-1) +
                         (flow_coef$bpptgrow_f[post_draws[p]]) * pptgrow_seq +
                         (flow_coef$bpptdorm_f[post_draws[p]]) * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s]  +
                         (flow_coef$btempgrow_f[post_draws[p]]) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                         (flow_coef$btempdorm_f[post_draws[p]]) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] +
                         (flow_coef$bpptgrowsex_f[post_draws[p]]) * pptgrow_seq * (s-1) +
                         (flow_coef$bpptdormsex_f[post_draws[p]]) * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s]  * (s-1) +
                         (flow_coef$btempgrowsex_f[post_draws[p]]) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] * (s-1) +
                        (flow_coef$btempdormsex_f[post_draws[p]]) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * (s-1) +
                         (flow_coef$btempdormpptdorm_f[post_draws[p]]) * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s] * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] +
                         (flow_coef$btempgrowpptgrow_f[post_draws[p]]) * pptgrow_seq * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                         (flow_coef$btempdormpptdormsex_f[post_draws[p]]) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s] * (s-1) +
                         (flow_coef$btempgrowpptgrowsex_f)[post_draws[p]] * pptgrow_seq * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s]  * (s-1) +
                         (flow_coef$bpptgrow2_f[post_draws[p]]) * (pptgrow_seq^2) +
                         (flow_coef$bpptdorm2_f[post_draws[p]]) * (flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s])^2 +
                         (flow_coef$btempgrow2_f[post_draws[p]]) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 +
                         (flow_coef$btempdorm2_f[post_draws[p]]) * (flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s])^2 +
                         (flow_coef$bpptgrow2sex_f[post_draws[p]]) * (pptgrow_seq^2) * (s-1) +
                         (flow_coef$bpptdorm2sex_f[post_draws[p]]) * (flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s])^2 * (s-1) +
                         (flow_coef$btempgrow2sex_f[post_draws[p]]) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 * (s-1) +
                         (flow_coef$btempdorm2sex_f[post_draws[p]]) * (flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s])^2 * (s-1)
    
    )
    
     fem_p <- exp((panic_coef$b0_p[post_draws[p]]) + 
                         (panic_coef$bsize_p[post_draws[p]]) * panic_mean_sizes$size[panic_mean_sizes$Sex==s & panic_mean_sizes$size_bin==i]+
                         (panic_coef$bsizesex_p[post_draws[p]]) * panic_mean_sizes$size[panic_mean_sizes$Sex==s & panic_mean_sizes$size_bin==i] * (s-1) +
                         (panic_coef$bsex_p[post_draws[p]]) * (s-1) +
                         (panic_coef$bpptgrow_p[post_draws[p]]) * pptgrow_seq +
                         (panic_coef$bpptdorm_p[post_draws[p]]) * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s]  +
                         (panic_coef$btempgrow_p[post_draws[p]]) * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] +
                         (panic_coef$btempdorm_p[post_draws[p]]) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] +
                         (panic_coef$bpptgrowsex_p[post_draws[p]]) * pptgrow_seq * (s-1) +
                         (panic_coef$bpptdormsex_p[post_draws[p]]) * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s]  * (s-1) +
                         (panic_coef$btempgrowsex_p[post_draws[p]]) * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] * (s-1) +
                        (panic_coef$btempdormsex_p[post_draws[p]]) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * (s-1) +
                         (panic_coef$btempdormpptdorm_p[post_draws[p]]) * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s] * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] +
                         (panic_coef$btempgrowpptgrow_p[post_draws[p]]) * pptgrow_seq * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] +
                         (panic_coef$btempdormpptdormsex_p[post_draws[p]]) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s] * (s-1) +
                         (panic_coef$btempgrowpptgrowsex_p[post_draws[p]]) * pptgrow_seq * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s]  * (s-1) +
                         (panic_coef$bpptgrow2_p[post_draws[p]]) * (pptgrow_seq^2) +
                         (panic_coef$bpptdorm2_p[post_draws[p]]) * (panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s])^2 +
                         (panic_coef$btempgrow2_p[post_draws[p]]) * (panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s])^2 +
                         (panic_coef$btempdorm2_p[post_draws[p]]) * (panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s])^2 +
                         (panic_coef$bpptgrow2sex_p[post_draws[p]]) * (pptgrow_seq^2) * (s-1) +
                         (panic_coef$bpptdorm2sex_p[post_draws[p]]) * (panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s])^2 * (s-1) +
                         (panic_coef$btempgrow2sex_p[post_draws[p]]) * (panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s])^2 * (s-1) +
                         (panic_coef$btempdorm2sex_p[post_draws[p]]) * (panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s])^2 * (s-1)
    )
    
    s=2;       
   male_s <- invlogit((surv_coef$b0_s[post_draws[p]]) + 
                         (surv_coef$bsize_s[post_draws[p]]) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i]+
                         (surv_coef$bsizesex_s[post_draws[p]]) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i] * (s-1) +
                         (surv_coef$bsex_s[post_draws[p]]) * (s-1) +
                         (surv_coef$bpptgrow_s[post_draws[p]]) * pptgrow_seq +
                         (surv_coef$bpptdorm_s[post_draws[p]]) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s]  +
                         (surv_coef$btempgrow_s[post_draws[p]]) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                         (surv_coef$btempdorm_s[post_draws[p]]) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] +
                         (surv_coef$bpptgrowsex_s[post_draws[p]]) * pptgrow_seq * (s-1) +
                         (surv_coef$bpptdormsex_s[post_draws[p]]) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s]  * (s-1) +
                         (surv_coef$btempgrowsex_s[post_draws[p]]) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * (s-1) +
                        (surv_coef$btempdormsex_s[post_draws[p]]) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * (s-1) +
                         (surv_coef$btempdormpptdorm_s[post_draws[p]]) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] +
                         (surv_coef$btempgrowpptgrow_s[post_draws[p]]) * pptgrow_seq * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                         (surv_coef$btempdormpptdormsex_s[post_draws[p]]) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] * (s-1) +
                         (surv_coef$btempgrowpptgrowsex_s[post_draws[p]]) * pptgrow_seq * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s]  * (s-1) +
                         (surv_coef$bpptgrow2_s[post_draws[p]]) * (pptgrow_seq^2) +
                         (surv_coef$bpptdorm2_s[post_draws[p]]) * (surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s])^2 +
                         (surv_coef$btempgrow2_s[post_draws[p]]) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 +
                         (surv_coef$btempdorm2_s[post_draws[p]]) * (surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s])^2 +
                         (surv_coef$bpptgrow2sex_s[post_draws[p]]) * (pptgrow_seq^2) * (s-1) +
                         (surv_coef$bpptdorm2sex_s[post_draws[p]]) * (surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s])^2 * (s-1) +
                         (surv_coef$btempgrow2sex_s[post_draws[p]]) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 * (s-1) +
                         (surv_coef$btempdorm2sex_s[post_draws[p]]) * (surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s])^2 * (s-1)
    )
             
    male_g <- exp((grow_coef$b0_g[post_draws[p]]) + 
                         (grow_coef$bsize_g[post_draws[p]]) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i]+
                         (grow_coef$bsizesex_g[post_draws[p]]) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i] * (s-1) +
                         (grow_coef$bsex_g[post_draws[p]]) * (s-1) +
                         (grow_coef$bpptgrow_g[post_draws[p]]) * pptgrow_seq +
                         (grow_coef$bpptdorm_g[post_draws[p]]) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s]  +
                         (grow_coef$btempgrow_g[post_draws[p]]) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                         (grow_coef$btempdorm_g[post_draws[p]]) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] +
                         (grow_coef$bpptgrowsex_g[post_draws[p]]) * pptgrow_seq * (s-1) +
                         (grow_coef$bpptdormsex_g[post_draws[p]]) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s]  * (s-1) +
                         (grow_coef$btempgrowsex_g[post_draws[p]]) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] * (s-1) +
                        (grow_coef$btempdormsex_g[post_draws[p]]) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * (s-1) +
                         (grow_coef$btempdormpptdorm_g[post_draws[p]]) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] +
                         (grow_coef$btempgrowpptgrow_g[post_draws[p]]) * pptgrow_seq * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                         (grow_coef$btempdormpptdormsex_g[post_draws[p]]) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] * (s-1) +
                         (grow_coef$btempgrowpptgrowsex_g)[post_draws[p]] * pptgrow_seq * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s]  * (s-1) +
                         (grow_coef$bpptgrow2_g[post_draws[p]]) * (pptgrow_seq^2) +
                         (grow_coef$bpptdorm2_g[post_draws[p]]) * (grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s])^2 +
                         (grow_coef$btempgrow2_g[post_draws[p]]) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 +
                         (grow_coef$btempdorm2_g[post_draws[p]]) * (grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s])^2 +
                         (grow_coef$bpptgrow2sex_g[post_draws[p]]) * (pptgrow_seq^2) * (s-1) +
                         (grow_coef$bpptdorm2sex_g[post_draws[p]]) * (grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s])^2 * (s-1) +
                         (grow_coef$btempgrow2sex_g[post_draws[p]]) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 * (s-1) +
                         (grow_coef$btempdorm2sex_g[post_draws[p]]) * (grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s])^2 * (s-1)
    
    )
    
    male_f <- invlogit((flow_coef$b0_f[post_draws[p]]) + 
                         (flow_coef$bsize_f[post_draws[p]]) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i]+
                         (flow_coef$bsizesex_f[post_draws[p]]) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i] * (s-1) +
                         (flow_coef$bsex_f[post_draws[p]]) * (s-1) +
                         (flow_coef$bpptgrow_f[post_draws[p]]) * pptgrow_seq +
                         (flow_coef$bpptdorm_f[post_draws[p]]) * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s]  +
                         (flow_coef$btempgrow_f[post_draws[p]]) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                         (flow_coef$btempdorm_f[post_draws[p]]) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] +
                         (flow_coef$bpptgrowsex_f[post_draws[p]]) * pptgrow_seq * (s-1) +
                         (flow_coef$bpptdormsex_f[post_draws[p]]) * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s]  * (s-1) +
                         (flow_coef$btempgrowsex_f[post_draws[p]]) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] * (s-1) +
                        (flow_coef$btempdormsex_f[post_draws[p]]) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * (s-1) +
                         (flow_coef$btempdormpptdorm_f[post_draws[p]]) * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s] * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] +
                         (flow_coef$btempgrowpptgrow_f[post_draws[p]]) * pptgrow_seq * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                         (flow_coef$btempdormpptdormsex_f[post_draws[p]]) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s] * (s-1) +
                         (flow_coef$btempgrowpptgrowsex_f)[post_draws[p]] * pptgrow_seq * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s]  * (s-1) +
                         (flow_coef$bpptgrow2_f[post_draws[p]]) * (pptgrow_seq^2) +
                         (flow_coef$bpptdorm2_f[post_draws[p]]) * (flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s])^2 +
                         (flow_coef$btempgrow2_f[post_draws[p]]) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 +
                         (flow_coef$btempdorm2_f[post_draws[p]]) * (flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s])^2 +
                         (flow_coef$bpptgrow2sex_f[post_draws[p]]) * (pptgrow_seq^2) * (s-1) +
                         (flow_coef$bpptdorm2sex_f[post_draws[p]]) * (flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s])^2 * (s-1) +
                         (flow_coef$btempgrow2sex_f[post_draws[p]]) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 * (s-1) +
                         (flow_coef$btempdorm2sex_f[post_draws[p]]) * (flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s])^2 * (s-1)
    )
    
    male_p <- exp((panic_coef$b0_p[post_draws[p]]) + 
                         (panic_coef$bsize_p[post_draws[p]]) * panic_mean_sizes$size[panic_mean_sizes$Sex==s & panic_mean_sizes$size_bin==i]+
                         (panic_coef$bsizesex_p[post_draws[p]]) * panic_mean_sizes$size[panic_mean_sizes$Sex==s & panic_mean_sizes$size_bin==i] * (s-1) +
                         (panic_coef$bsex_p[post_draws[p]]) * (s-1) +
                         (panic_coef$bpptgrow_p[post_draws[p]]) * pptgrow_seq +
                         (panic_coef$bpptdorm_p[post_draws[p]]) * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s]  +
                         (panic_coef$btempgrow_p[post_draws[p]]) * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] +
                         (panic_coef$btempdorm_p[post_draws[p]]) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] +
                         (panic_coef$bpptgrowsex_p[post_draws[p]]) * pptgrow_seq * (s-1) +
                         (panic_coef$bpptdormsex_p[post_draws[p]]) * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s]  * (s-1) +
                         (panic_coef$btempgrowsex_p[post_draws[p]]) * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] * (s-1) +
                         (panic_coef$btempdormsex_p[post_draws[p]]) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * (s-1) +
                         (panic_coef$btempdormpptdorm_p[post_draws[p]]) * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s] * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] +
                         (panic_coef$btempgrowpptgrow_p[post_draws[p]]) * pptgrow_seq * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] +
                         (panic_coef$btempdormpptdormsex_p[post_draws[p]]) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s] * (s-1) +
                         (panic_coef$btempgrowpptgrowsex_p[post_draws[p]]) * pptgrow_seq * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s]  * (s-1) +
                         (panic_coef$bpptgrow2_p[post_draws[p]]) * (pptgrow_seq^2) +
                         (panic_coef$bpptdorm2_p[post_draws[p]]) * (panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s])^2 +
                         (panic_coef$btempgrow2_p[post_draws[p]]) * (panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s])^2 +
                         (panic_coef$btempdorm2_p[post_draws[p]]) * (panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s])^2 +
                         (panic_coef$bpptgrow2sex_p[post_draws[p]]) * (pptgrow_seq^2) * (s-1) +
                         (panic_coef$bpptdorm2sex_p[post_draws[p]]) * (panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s])^2 * (s-1) +
                         (panic_coef$btempgrow2sex_p[post_draws[p]]) * (panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s])^2 * (s-1) +
                         (panic_coef$btempdorm2sex_p[post_draws[p]]) * (panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s])^2 * (s-1)
    
    )
    surv_sex_diff_post_pptgrow[i,,p] <-  fem_s-male_s
    grow_sex_diff_post_pptgrow[i,,p] <-  fem_g-male_g
    flow_sex_diff_post_pptgrow[i,,p] <-  fem_f-male_f
    panic_sex_diff_post_pptgrow[i,,p] <-  fem_p-male_p
  }
}

```

```{r}
#define quantiles of posterior samples
sex_diff_surv_mean_pptgrow <- sex_diff_grow_mean_pptgrow <- sex_diff_flow_mean_pptgrow <- sex_diff_panic_mean_pptgrow <- matrix(NA,size_bin_num,length(pptgrow_seq))
sex_diff_surv_95_pptgrow <- sex_diff_surv_75_pptgrow <- sex_diff_surv_50_pptgrow <- sex_diff_surv_25_pptgrow <- array(NA,dim=c(size_bin_num,length(pptgrow_seq),2))
sex_diff_grow_95_pptgrow <- sex_diff_grow_75_pptgrow <- sex_diff_grow_50_pptgrow <- sex_diff_grow_25_pptgrow <- array(NA,dim=c(size_bin_num,length(pptgrow_seq),2))
sex_diff_flow_95_pptgrow <- sex_diff_flow_75_pptgrow <- sex_diff_flow_50_pptgrow <- sex_diff_flow_25_pptgrow <- array(NA,dim=c(size_bin_num,length(pptgrow_seq),2))
sex_diff_panic_95_pptgrow <- sex_diff_panic_75_pptgrow <- sex_diff_panic_50_pptgrow <- sex_diff_panic_25_pptgrow <- array(NA,dim=c(size_bin_num,length(pptgrow_seq),2))
for(s in 1:size_bin_num){
  for(l in 1:length(pptgrow_seq)){
    sex_diff_surv_mean_pptgrow[s,l] <- mean(surv_sex_diff_post_pptgrow[s,l,])
    sex_diff_surv_95_pptgrow[s,l,] <- quantile(surv_sex_diff_post_pptgrow[s,l,],probs=c(0.025,0.975))
    sex_diff_surv_75_pptgrow[s,l,] <- quantile(surv_sex_diff_post_pptgrow[s,l,],probs=c(0.125,0.875))
    sex_diff_surv_50_pptgrow[s,l,] <- quantile(surv_sex_diff_post_pptgrow[s,l,],probs=c(0.25,0.75))
    sex_diff_surv_25_pptgrow[s,l,] <- quantile(surv_sex_diff_post_pptgrow[s,l,],probs=c(0.375,0.625))
    
    sex_diff_grow_mean_pptgrow[s,l] <- mean(grow_sex_diff_post_pptgrow[s,l,])
    sex_diff_grow_95_pptgrow[s,l,] <- quantile(grow_sex_diff_post_pptgrow[s,l,],probs=c(0.025,0.975))
    sex_diff_grow_75_pptgrow[s,l,] <- quantile(grow_sex_diff_post_pptgrow[s,l,],probs=c(0.125,0.875))
    sex_diff_grow_50_pptgrow[s,l,] <- quantile(grow_sex_diff_post_pptgrow[s,l,],probs=c(0.25,0.75))
    sex_diff_grow_25_pptgrow[s,l,] <- quantile(grow_sex_diff_post_pptgrow[s,l,],probs=c(0.375,0.625))
    
    sex_diff_flow_mean_pptgrow[s,l] <- mean(flow_sex_diff_post_pptgrow[s,l,])
    sex_diff_flow_95_pptgrow[s,l,] <- quantile(flow_sex_diff_post_pptgrow[s,l,],probs=c(0.025,0.975))
    sex_diff_flow_75_pptgrow[s,l,] <- quantile(flow_sex_diff_post_pptgrow[s,l,],probs=c(0.125,0.875))
    sex_diff_flow_50_pptgrow[s,l,] <- quantile(flow_sex_diff_post_pptgrow[s,l,],probs=c(0.25,0.75))
    sex_diff_flow_25_pptgrow[s,l,] <- quantile(flow_sex_diff_post_pptgrow[s,l,],probs=c(0.375,0.625))
    
    sex_diff_panic_mean_pptgrow[s,l] <- mean(panic_sex_diff_post_pptgrow[s,l,])
    sex_diff_panic_95_pptgrow[s,l,] <- quantile(panic_sex_diff_post_pptgrow[s,l,],probs=c(0.025,0.975))
    sex_diff_panic_75_pptgrow[s,l,] <- quantile(panic_sex_diff_post_pptgrow[s,l,],probs=c(0.125,0.875))
    sex_diff_panic_50_pptgrow[s,l,] <- quantile(panic_sex_diff_post_pptgrow[s,l,],probs=c(0.25,0.75))
    sex_diff_panic_25_pptgrow[s,l,] <- quantile(panic_sex_diff_post_pptgrow[s,l,],probs=c(0.375,0.625))
    
  }
}
```

## Temperature of the growing season

```{r}
# sample vital rate functions from the join posterior
tempgrow_seq <- seq(min(poar_surv_binned$tempgrow),max(poar_surv_binned$tempgrow),length.out=30)
n_post_draws <- 2000
post_draws <- sample.int(length(surv_coef$b0_s), n_post_draws)
surv_sex_diff_post_tempgrow <- grow_sex_diff_post_tempgrow <- flow_sex_diff_post_tempgrow <- panic_sex_diff_post_tempgrow <- array(NA,dim=c(size_bin_num,length(tempgrow_seq),n_post_draws))
for(p in 1:n_post_draws){
  for(i in 1:size_bin_num){
    s=1;      
    fem_s <-invlogit((surv_coef$b0_s[post_draws[p]]) +
                        (surv_coef$bsize_s[post_draws[p]]) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i] +
                        (surv_coef$bsizesex_s[post_draws[p]]) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i] * (s-1) +
                        (surv_coef$bsex_s[post_draws[p]]) * (s-1) +
                        (surv_coef$bpptgrow_s[post_draws[p]]) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s]  +
                        (surv_coef$bpptdorm_s[post_draws[p]]) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s]  +
                        (surv_coef$btempgrow_s[post_draws[p]]) * tempgrow_seq +
                        (surv_coef$btempdorm_s[post_draws[p]]) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] +
                        (surv_coef$bpptgrowsex_s[post_draws[p]]) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * (s-1) +
                        (surv_coef$bpptdormsex_s[post_draws[p]]) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s]  * (s-1) +
                        (surv_coef$btempdormpptdorm_s[post_draws[p]]) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] +
                        (surv_coef$btempgrowpptgrow_s[post_draws[p]]) * tempgrow_seq * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] +
                        (surv_coef$btempgrowsex_s[post_draws[p]]) * tempgrow_seq * (s-1) +
                        (surv_coef$btempdormsex_s[post_draws[p]]) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * (s-1) +
                        (surv_coef$btempdormpptdormsex_s[post_draws[p]]) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] * (s-1) +
                        (surv_coef$btempgrowpptgrowsex_s[post_draws[p]]) * tempgrow_seq * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s]  * (s-1) +
                        (surv_coef$bpptgrow2_s[post_draws[p]]) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 +
                        (surv_coef$bpptdorm2_s[post_draws[p]]) * (surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s])^2 +
                        (surv_coef$btempgrow2_s[post_draws[p]]) * (tempgrow_seq^2) +
                        (surv_coef$btempdorm2_s[post_draws[p]]) * (surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s])^2 +
                        (surv_coef$bpptgrow2sex_s[post_draws[p]]) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 * (s-1) +
                        (surv_coef$bpptdorm2sex_s[post_draws[p]]) * (surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s])^2 * (s-1) +
                        (surv_coef$btempgrow2sex_s[post_draws[p]]) * (tempgrow_seq^2) * (s-1) +
                        (surv_coef$btempdorm2sex_s[post_draws[p]]) * (surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s])^2 * (s-1)
      )
    
    fem_g <- exp((grow_coef$b0_g[post_draws[p]]) +
                        (grow_coef$bsize_g[post_draws[p]]) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i] +
                        (grow_coef$bsizesex_g[post_draws[p]]) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i] * (s-1) +
                        (grow_coef$bsex_g[post_draws[p]]) * (s-1) +
                        (grow_coef$bpptgrow_g[post_draws[p]]) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s]  +
                        (grow_coef$bpptdorm_g[post_draws[p]]) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s]  +
                        (grow_coef$btempgrow_g[post_draws[p]]) * tempgrow_seq +
                        (grow_coef$btempdorm_g[post_draws[p]]) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] +
                        (grow_coef$bpptgrowsex_g[post_draws[p]]) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * (s-1) +
                        (grow_coef$bpptdormsex_g[post_draws[p]]) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s]  * (s-1) +
                        (grow_coef$btempdormpptdorm_g[post_draws[p]]) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] +
                        (grow_coef$btempgrowpptgrow_g[post_draws[p]]) * tempgrow_seq * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] +
                        (grow_coef$btempgrowsex_g[post_draws[p]]) * tempgrow_seq * (s-1) +
                        (grow_coef$btempdormsex_g[post_draws[p]]) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * (s-1) +
                        (grow_coef$btempdormpptdormsex_g[post_draws[p]]) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] * (s-1) +
                        (grow_coef$btempgrowpptgrowsex_g[post_draws[p]]) * tempgrow_seq * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s]  * (s-1) +
                        (grow_coef$bpptgrow2_g[post_draws[p]]) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 +
                        (grow_coef$bpptdorm2_g[post_draws[p]]) * (grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s])^2 +
                        (grow_coef$btempgrow2_g[post_draws[p]]) * (tempgrow_seq^2) +
                        (grow_coef$btempdorm2_g[post_draws[p]]) * (grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s])^2 +
                        (grow_coef$bpptgrow2sex_g[post_draws[p]]) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 * (s-1) +
                        (grow_coef$bpptdorm2sex_g[post_draws[p]]) * (grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s])^2 * (s-1) +
                        (grow_coef$btempgrow2sex_g[post_draws[p]]) * (tempgrow_seq^2) * (s-1) +
                        (grow_coef$btempdorm2sex_g[post_draws[p]]) * (grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s])^2 * (s-1)
    )
    fem_f <- invlogit((flow_coef$b0_f[post_draws[p]]) +
                        (flow_coef$bsize_f[post_draws[p]]) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i] +
                        (flow_coef$bsizesex_f[post_draws[p]]) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i] * (s-1) +
                        (flow_coef$bsex_f[post_draws[p]]) * (s-1) +
                        (flow_coef$bpptgrow_f[post_draws[p]]) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s]  +
                        (flow_coef$bpptdorm_f[post_draws[p]]) * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s]  +
                        (flow_coef$btempgrow_f[post_draws[p]]) * tempgrow_seq +
                        (flow_coef$btempdorm_f[post_draws[p]]) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] +
                        (flow_coef$bpptgrowsex_f[post_draws[p]]) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] * (s-1) +
                        (flow_coef$bpptdormsex_f[post_draws[p]]) * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s]  * (s-1) +
                        (flow_coef$btempgrowsex_f[post_draws[p]]) * tempgrow_seq * (s-1) +
                        (flow_coef$btempdormsex_f[post_draws[p]]) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * (s-1) +
                        (flow_coef$btempdormpptdorm_f[post_draws[p]]) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s]  +
                        (flow_coef$btempgrowpptgrow_f[post_draws[p]]) * tempgrow_seq * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s]   +
                        (flow_coef$btempdormpptdormsex_f[post_draws[p]]) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s] * (s-1) +
                        (flow_coef$btempgrowpptgrowsex_f[post_draws[p]]) * tempgrow_seq * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s]  * (s-1) +
                        (flow_coef$bpptgrow2_f[post_draws[p]]) * (flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s])^2 +
                        (flow_coef$bpptdorm2_f[post_draws[p]]) * (flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s])^2 +
                        (flow_coef$btempgrow2_f[post_draws[p]]) * (tempgrow_seq^2) +
                        (flow_coef$btempdorm2_f[post_draws[p]]) * (flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s])^2 +
                        (flow_coef$bpptgrow2sex_f[post_draws[p]]) * (flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s])^2 * (s-1) +
                        (flow_coef$bpptdorm2sex_f[post_draws[p]]) * (flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s])^2 * (s-1) +
                        (flow_coef$btempgrow2sex_f[post_draws[p]]) * (tempgrow_seq^2) * (s-1) +
                        (flow_coef$btempdorm2sex_f[post_draws[p]]) * (flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s])^2 * (s-1)
      )
    
    
     fem_p <- exp((panic_coef$b0_p[post_draws[p]]) +
                        (panic_coef$bsize_p[post_draws[p]]) * panic_mean_sizes$size[panic_mean_sizes$Sex==s & panic_mean_sizes$size_bin==i] +
                        (panic_coef$bsizesex_p[post_draws[p]]) * panic_mean_sizes$size[panic_mean_sizes$Sex==s & panic_mean_sizes$size_bin==i] * (s-1) +
                        (panic_coef$bsex_p[post_draws[p]]) * (s-1) +
                        (panic_coef$bpptgrow_p[post_draws[p]]) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s]  +
                        (panic_coef$bpptdorm_p[post_draws[p]]) * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s]  +
                        (panic_coef$btempgrow_p[post_draws[p]]) * tempgrow_seq +
                        (panic_coef$btempdorm_p[post_draws[p]]) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] +
                        (panic_coef$bpptgrowsex_p[post_draws[p]]) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s] * (s-1) +
                        (panic_coef$bpptdormsex_p[post_draws[p]]) * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s]  * (s-1) +
                        (panic_coef$btempgrowsex_p[post_draws[p]]) * tempgrow_seq * (s-1) +
                        (panic_coef$btempdormsex_p[post_draws[p]]) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * (s-1) +
                        (panic_coef$btempdormpptdorm_p[post_draws[p]]) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s]  +
                        (panic_coef$btempgrowpptgrow_p[post_draws[p]]) * tempgrow_seq * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s]   +
                        (panic_coef$btempdormpptdormsex_p[post_draws[p]]) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s] * (s-1) +
                        (panic_coef$btempgrowpptgrowsex_p[post_draws[p]]) * tempgrow_seq * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s]  * (s-1) +
                        (panic_coef$bpptgrow2_p[post_draws[p]]) * (panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s])^2 +
                        (panic_coef$bpptdorm2_p[post_draws[p]]) * (panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s])^2 +
                        (panic_coef$btempgrow2_p[post_draws[p]]) * (tempgrow_seq^2) +
                        (panic_coef$btempdorm2_p[post_draws[p]]) * (panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s])^2 +
                        (panic_coef$bpptgrow2sex_p[post_draws[p]]) * (panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s])^2 * (s-1) +
                        (panic_coef$bpptdorm2sex_p[post_draws[p]]) * (panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s])^2 * (s-1) +
                        (panic_coef$btempgrow2sex_p[post_draws[p]]) * (tempgrow_seq^2) * (s-1) +
                        (panic_coef$btempdorm2sex_p[post_draws[p]]) * (panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s])^2 * (s-1)
      )
    
    s=2;
   male_s <-invlogit((surv_coef$b0_s[post_draws[p]]) +
                        (surv_coef$bsize_s[post_draws[p]]) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i] +
                        (surv_coef$bsizesex_s[post_draws[p]]) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i] * (s-1) +
                        (surv_coef$bsex_s[post_draws[p]]) * (s-1) +
                        (surv_coef$bpptgrow_s[post_draws[p]]) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s]  +
                        (surv_coef$bpptdorm_s[post_draws[p]]) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s]  +
                        (surv_coef$btempgrow_s[post_draws[p]]) * tempgrow_seq +
                        (surv_coef$btempdorm_s[post_draws[p]]) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] +
                        (surv_coef$bpptgrowsex_s[post_draws[p]]) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * (s-1) +
                        (surv_coef$bpptdormsex_s[post_draws[p]]) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s]  * (s-1) +
                        (surv_coef$btempdormpptdorm_s[post_draws[p]]) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] +
                        (surv_coef$btempgrowpptgrow_s[post_draws[p]]) * tempgrow_seq * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] +
                        (surv_coef$btempgrowsex_s[post_draws[p]]) * tempgrow_seq * (s-1) +
                        (surv_coef$btempdormsex_s[post_draws[p]]) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * (s-1) +
                        (surv_coef$btempdormpptdormsex_s[post_draws[p]]) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] * (s-1) +
                        (surv_coef$btempgrowpptgrowsex_s[post_draws[p]]) * tempgrow_seq * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s]  * (s-1) +
                        (surv_coef$bpptgrow2_s[post_draws[p]]) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 +
                        (surv_coef$bpptdorm2_s[post_draws[p]]) * (surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s])^2 +
                        (surv_coef$btempgrow2_s[post_draws[p]]) * (tempgrow_seq^2) +
                        (surv_coef$btempdorm2_s[post_draws[p]]) * (surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s])^2 +
                        (surv_coef$bpptgrow2sex_s[post_draws[p]]) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 * (s-1) +
                        (surv_coef$bpptdorm2sex_s[post_draws[p]]) * (surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s])^2 * (s-1) +
                        (surv_coef$btempgrow2sex_s[post_draws[p]]) * (tempgrow_seq^2) * (s-1) +
                        (surv_coef$btempdorm2sex_s[post_draws[p]]) * (surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s])^2 * (s-1)
      )

    male_g <- exp((grow_coef$b0_g[post_draws[p]]) +
                        (grow_coef$bsize_g[post_draws[p]]) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i] +
                        (grow_coef$bsizesex_g[post_draws[p]]) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i] * (s-1) +
                        (grow_coef$bsex_g[post_draws[p]]) * (s-1) +
                        (grow_coef$bpptgrow_g[post_draws[p]]) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s]  +
                        (grow_coef$bpptdorm_g[post_draws[p]]) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s]  +
                        (grow_coef$btempgrow_g[post_draws[p]]) * tempgrow_seq +
                        (grow_coef$btempdorm_g[post_draws[p]]) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] +
                        (grow_coef$bpptgrowsex_g[post_draws[p]]) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * (s-1) +
                        (grow_coef$bpptdormsex_g[post_draws[p]]) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s]  * (s-1) +
                        (grow_coef$btempdormpptdorm_g[post_draws[p]]) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] +
                        (grow_coef$btempgrowpptgrow_g[post_draws[p]]) * tempgrow_seq * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] +
                        (grow_coef$btempgrowsex_g[post_draws[p]]) * tempgrow_seq * (s-1) +
                        (grow_coef$btempdormsex_g[post_draws[p]]) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * (s-1) +
                        (grow_coef$btempdormpptdormsex_g[post_draws[p]]) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] * (s-1) +
                        (grow_coef$btempgrowpptgrowsex_g[post_draws[p]]) * tempgrow_seq * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s]  * (s-1) +
                        (grow_coef$bpptgrow2_g[post_draws[p]]) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 +
                        (grow_coef$bpptdorm2_g[post_draws[p]]) * (grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s])^2 +
                        (grow_coef$btempgrow2_g[post_draws[p]]) * (tempgrow_seq^2) +
                        (grow_coef$btempdorm2_g[post_draws[p]]) * (grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s])^2 +
                        (grow_coef$bpptgrow2sex_g[post_draws[p]]) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 * (s-1) +
                        (grow_coef$bpptdorm2sex_g[post_draws[p]]) * (grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s])^2 * (s-1) +
                        (grow_coef$btempgrow2sex_g[post_draws[p]]) * (tempgrow_seq^2) * (s-1) +
                        (grow_coef$btempdorm2sex_g[post_draws[p]]) * (grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s])^2 * (s-1)
      )
    male_f <- invlogit((flow_coef$b0_f[post_draws[p]]) +
                        (flow_coef$bsize_f[post_draws[p]]) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i] +
                        (flow_coef$bsizesex_f[post_draws[p]]) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i] * (s-1) +
                        (flow_coef$bsex_f[post_draws[p]]) * (s-1) +
                        (flow_coef$bpptgrow_f[post_draws[p]]) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s]  +
                        (flow_coef$bpptdorm_f[post_draws[p]]) * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s]  +
                        (flow_coef$btempgrow_f[post_draws[p]]) * tempgrow_seq +
                        (flow_coef$btempdorm_f[post_draws[p]]) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] +
                        (flow_coef$bpptgrowsex_f[post_draws[p]]) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] * (s-1) +
                        (flow_coef$bpptdormsex_f[post_draws[p]]) * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s]  * (s-1) +
                        (flow_coef$btempgrowsex_f[post_draws[p]]) * tempgrow_seq * (s-1) +
                        (flow_coef$btempdormsex_f[post_draws[p]]) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * (s-1) +
                        (flow_coef$btempdormpptdorm_f[post_draws[p]]) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s]  +
                        (flow_coef$btempgrowpptgrow_f[post_draws[p]]) * tempgrow_seq * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s]   +
                        (flow_coef$btempdormpptdormsex_f[post_draws[p]]) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s] * (s-1) +
                        (flow_coef$btempgrowpptgrowsex_f[post_draws[p]]) * tempgrow_seq * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s]  * (s-1) +
                        (flow_coef$bpptgrow2_f[post_draws[p]]) * (flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s])^2 +
                        (flow_coef$bpptdorm2_f[post_draws[p]]) * (flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s])^2 +
                        (flow_coef$btempgrow2_f[post_draws[p]]) * (tempgrow_seq^2) +
                        (flow_coef$btempdorm2_f[post_draws[p]]) * (flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s])^2 +
                        (flow_coef$bpptgrow2sex_f[post_draws[p]]) * (flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s])^2 * (s-1) +
                        (flow_coef$bpptdorm2sex_f[post_draws[p]]) * (flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s])^2 * (s-1) +
                        (flow_coef$btempgrow2sex_f[post_draws[p]]) * (tempgrow_seq^2) * (s-1) +
                        (flow_coef$btempdorm2sex_f[post_draws[p]]) * (flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s])^2 * (s-1)
      )

     male_p <- exp((panic_coef$b0_p[post_draws[p]]) +
                        (panic_coef$bsize_p[post_draws[p]]) * panic_mean_sizes$size[panic_mean_sizes$Sex==s & panic_mean_sizes$size_bin==i] +
                        (panic_coef$bsizesex_p[post_draws[p]]) * panic_mean_sizes$size[panic_mean_sizes$Sex==s & panic_mean_sizes$size_bin==i] * (s-1) +
                        (panic_coef$bsex_p[post_draws[p]]) * (s-1) +
                        (panic_coef$bpptgrow_p[post_draws[p]]) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s]  +
                        (panic_coef$bpptdorm_p[post_draws[p]]) * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s]  +
                        (panic_coef$btempgrow_p[post_draws[p]]) * tempgrow_seq +
                        (panic_coef$btempdorm_p[post_draws[p]]) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] +
                        (panic_coef$bpptgrowsex_p[post_draws[p]]) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s] * (s-1) +
                        (panic_coef$bpptdormsex_p[post_draws[p]]) * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s]  * (s-1) +
                        (panic_coef$btempgrowsex_p[post_draws[p]]) * tempgrow_seq * (s-1) +
                        (panic_coef$btempdormsex_p[post_draws[p]]) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * (s-1) +
                        (panic_coef$btempdormpptdorm_p[post_draws[p]]) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s]  +
                        (panic_coef$btempgrowpptgrow_p[post_draws[p]]) * tempgrow_seq * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s]   +
                        (panic_coef$btempdormpptdormsex_p[post_draws[p]]) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s] * (s-1) +
                        (panic_coef$btempgrowpptgrowsex_p[post_draws[p]]) * tempgrow_seq * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s]  * (s-1) +
                        (panic_coef$bpptgrow2_p[post_draws[p]]) * (panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s])^2 +
                        (panic_coef$bpptdorm2_p[post_draws[p]]) * (panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s])^2 +
                        (panic_coef$btempgrow2_p[post_draws[p]]) * (tempgrow_seq^2) +
                        (panic_coef$btempdorm2_p[post_draws[p]]) * (panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s])^2 +
                        (panic_coef$bpptgrow2sex_p[post_draws[p]]) * (panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s])^2 * (s-1) +
                        (panic_coef$bpptdorm2sex_p[post_draws[p]]) * (panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s])^2 * (s-1) +
                        (panic_coef$btempgrow2sex_p[post_draws[p]]) * (tempgrow_seq^2) * (s-1) +
                        (panic_coef$btempdorm2sex_p[post_draws[p]]) * (panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s])^2 * (s-1)
      )
    surv_sex_diff_post_tempgrow[i,,p] <-  fem_s-male_s
    grow_sex_diff_post_tempgrow[i,,p] <-  fem_g-male_g
    flow_sex_diff_post_tempgrow[i,,p] <-  fem_f-male_f
    panic_sex_diff_post_tempgrow[i,,p] <- fem_p-male_p
  }
}

```

```{r}
#define quantiles of posterior samples
sex_diff_surv_mean_tempgrow <- sex_diff_grow_mean_tempgrow <- sex_diff_flow_mean_tempgrow <- sex_diff_panic_mean_tempgrow <- matrix(NA,size_bin_num,length(tempgrow_seq))
sex_diff_surv_95_tempgrow <- sex_diff_surv_75_tempgrow <- sex_diff_surv_50_tempgrow <- sex_diff_surv_25_tempgrow <- array(NA,dim=c(size_bin_num,length(tempgrow_seq),2))
sex_diff_grow_95_tempgrow <- sex_diff_grow_75_tempgrow <- sex_diff_grow_50_tempgrow <- sex_diff_grow_25_tempgrow <- array(NA,dim=c(size_bin_num,length(tempgrow_seq),2))
sex_diff_flow_95_tempgrow <- sex_diff_flow_75_tempgrow <- sex_diff_flow_50_tempgrow <- sex_diff_flow_25_tempgrow <- array(NA,dim=c(size_bin_num,length(tempgrow_seq),2))
sex_diff_panic_95_tempgrow <- sex_diff_panic_75_tempgrow <- sex_diff_panic_50_tempgrow <- sex_diff_panic_25_tempgrow <- array(NA,dim=c(size_bin_num,length(tempgrow_seq),2))
for(s in 1:size_bin_num){
  for(l in 1:length(tempgrow_seq)){
    sex_diff_surv_mean_tempgrow[s,l] <- mean(surv_sex_diff_post_tempgrow[s,l,])
    sex_diff_surv_95_tempgrow[s,l,] <- quantile(surv_sex_diff_post_tempgrow[s,l,],probs=c(0.025,0.975))
    sex_diff_surv_75_tempgrow[s,l,] <- quantile(surv_sex_diff_post_tempgrow[s,l,],probs=c(0.125,0.875))
    sex_diff_surv_50_tempgrow[s,l,] <- quantile(surv_sex_diff_post_tempgrow[s,l,],probs=c(0.25,0.75))
    sex_diff_surv_25_tempgrow[s,l,] <- quantile(surv_sex_diff_post_tempgrow[s,l,],probs=c(0.375,0.625))
    
    sex_diff_grow_mean_tempgrow[s,l] <- mean(grow_sex_diff_post_tempgrow[s,l,])
    sex_diff_grow_95_tempgrow[s,l,] <- quantile(grow_sex_diff_post_tempgrow[s,l,],probs=c(0.025,0.975))
    sex_diff_grow_75_tempgrow[s,l,] <- quantile(grow_sex_diff_post_tempgrow[s,l,],probs=c(0.125,0.875))
    sex_diff_grow_50_tempgrow[s,l,] <- quantile(grow_sex_diff_post_tempgrow[s,l,],probs=c(0.25,0.75))
    sex_diff_grow_25_tempgrow[s,l,] <- quantile(grow_sex_diff_post_tempgrow[s,l,],probs=c(0.375,0.625))
    
    sex_diff_flow_mean_tempgrow[s,l] <- mean(flow_sex_diff_post_tempgrow[s,l,])
    sex_diff_flow_95_tempgrow[s,l,] <- quantile(flow_sex_diff_post_tempgrow[s,l,],probs=c(0.025,0.975))
    sex_diff_flow_75_tempgrow[s,l,] <- quantile(flow_sex_diff_post_tempgrow[s,l,],probs=c(0.125,0.875))
    sex_diff_flow_50_tempgrow[s,l,] <- quantile(flow_sex_diff_post_tempgrow[s,l,],probs=c(0.25,0.75))
    sex_diff_flow_25_tempgrow[s,l,] <- quantile(flow_sex_diff_post_tempgrow[s,l,],probs=c(0.375,0.625))
    
    sex_diff_panic_mean_tempgrow[s,l] <- mean(panic_sex_diff_post_tempgrow[s,l,])
    sex_diff_panic_95_tempgrow[s,l,] <- quantile(panic_sex_diff_post_tempgrow[s,l,],probs=c(0.025,0.975))
    sex_diff_panic_75_tempgrow[s,l,] <- quantile(panic_sex_diff_post_tempgrow[s,l,],probs=c(0.125,0.875))
    sex_diff_panic_50_tempgrow[s,l,] <- quantile(panic_sex_diff_post_tempgrow[s,l,],probs=c(0.25,0.75))
    sex_diff_panic_25_tempgrow[s,l,] <- quantile(panic_sex_diff_post_tempgrow[s,l,],probs=c(0.375,0.625))
    
  }
}
```

## Precipitation of the dormant season

```{r}
# sample vital rate functions from the join posterior
pptdorm_seq <- seq(min(poar_surv_binned$pptdorm),max(poar_surv_binned$pptdorm),length.out=30)
n_post_draws <- 2000
post_draws <- sample.int(length(surv_coef$b0_s), n_post_draws)
surv_sex_diff_post_pptdorm <- grow_sex_diff_post_pptdorm <- flow_sex_diff_post_pptdorm <- panic_sex_diff_post_pptdorm <- array(NA,dim=c(size_bin_num,length(pptdorm_seq),n_post_draws))
for(p in 1:n_post_draws){
  for(i in 1:size_bin_num){
    s=1;      
    fem_s <- invlogit((surv_coef$b0_s[post_draws[p]]) + 
                         (surv_coef$bsize_s[post_draws[p]]) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i]+
                         (surv_coef$bsizesex_s[post_draws[p]]) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i] * (s-1) +
                         (surv_coef$bsex_s[post_draws[p]]) * (s-1) +
                         (surv_coef$bpptgrow_s[post_draws[p]]) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] +
                         (surv_coef$bpptdorm_s[post_draws[p]]) *  pptdorm_seq +
                         (surv_coef$btempgrow_s[post_draws[p]]) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                         (surv_coef$btempdorm_s[post_draws[p]]) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] +
                         (surv_coef$bpptgrowsex_s[post_draws[p]]) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * (s-1) +
                         (surv_coef$bpptdormsex_s[post_draws[p]]) * pptdorm_seq * (s-1) +
                         (surv_coef$btempgrowsex_s[post_draws[p]]) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * (s-1) +
                        (surv_coef$btempdormsex_s[post_draws[p]]) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * (s-1) +
                         (surv_coef$btempdormpptdorm_s[post_draws[p]]) * pptdorm_seq * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] +
                         (surv_coef$btempgrowpptgrow_s[post_draws[p]]) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                         (surv_coef$btempdormpptdormsex_s[post_draws[p]]) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * pptdorm_seq * (s-1) +
                         (surv_coef$btempgrowpptgrowsex_s[post_draws[p]]) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * (s-1) +
                         (surv_coef$bpptgrow2_s[post_draws[p]]) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 +
                         (surv_coef$bpptdorm2_s[post_draws[p]]) * (pptdorm_seq^2) +
                         (surv_coef$btempgrow2_s[post_draws[p]]) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 +
                         (surv_coef$btempdorm2_s[post_draws[p]]) * (surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s])^2 +
                         (surv_coef$bpptgrow2sex_s[post_draws[p]]) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 * (s-1) +
                         (surv_coef$bpptdorm2sex_s[post_draws[p]]) * (pptdorm_seq^2) * (s-1) +
                         (surv_coef$btempgrow2sex_s[post_draws[p]]) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 * (s-1) +
                         (surv_coef$btempdorm2sex_s[post_draws[p]]) * (surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s])^2 * (s-1)
    )
    
    fem_g <- exp((grow_coef$b0_g[post_draws[p]]) + 
                         (grow_coef$bsize_g[post_draws[p]]) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i]+
                         (grow_coef$bsizesex_g[post_draws[p]]) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i] * (s-1) +
                         (grow_coef$bsex_g[post_draws[p]]) * (s-1) +
                         (grow_coef$bpptgrow_g[post_draws[p]]) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] +
                         (grow_coef$bpptdorm_g[post_draws[p]]) *  pptdorm_seq +
                         (grow_coef$btempgrow_g[post_draws[p]]) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                         (grow_coef$btempdorm_g[post_draws[p]]) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] +
                         (grow_coef$bpptgrowsex_g[post_draws[p]]) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * (s-1) +
                         (grow_coef$bpptdormsex_g[post_draws[p]]) * pptdorm_seq * (s-1) +
                         (grow_coef$btempgrowsex_g[post_draws[p]]) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] * (s-1) +
                        (grow_coef$btempdormsex_g[post_draws[p]]) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * (s-1) +
                         (grow_coef$btempdormpptdorm_g[post_draws[p]]) * pptdorm_seq * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] +
                         (grow_coef$btempgrowpptgrow_g[post_draws[p]]) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                         (grow_coef$btempdormpptdormsex_g[post_draws[p]]) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * pptdorm_seq * (s-1) +
                         (grow_coef$btempgrowpptgrowsex_g[post_draws[p]]) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] * (s-1) +
                         (grow_coef$bpptgrow2_g[post_draws[p]]) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 +
                         (grow_coef$bpptdorm2_g[post_draws[p]]) * (pptdorm_seq^2) +
                         (grow_coef$btempgrow2_g[post_draws[p]]) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 +
                         (grow_coef$btempdorm2_g[post_draws[p]]) * (grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s])^2 +
                         (grow_coef$bpptgrow2sex_g[post_draws[p]]) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 * (s-1) +
                         (grow_coef$bpptdorm2sex_g[post_draws[p]]) * (pptdorm_seq^2) * (s-1) +
                         (grow_coef$btempgrow2sex_g[post_draws[p]]) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 * (s-1) +
                         (grow_coef$btempdorm2sex_g[post_draws[p]]) * (grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s])^2 * (s-1)
    )
    
    fem_f <- invlogit((flow_coef$b0_f[post_draws[p]]) + 
                         (flow_coef$bsize_f[post_draws[p]]) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i]+
                         (flow_coef$bsizesex_f[post_draws[p]]) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i] * (s-1) +
                         (flow_coef$bsex_f[post_draws[p]]) * (s-1) +
                         (flow_coef$bpptgrow_f[post_draws[p]]) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] +
                         (flow_coef$bpptdorm_f[post_draws[p]]) *  pptdorm_seq +
                         (flow_coef$btempgrow_f[post_draws[p]]) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                         (flow_coef$btempdorm_f[post_draws[p]]) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] +
                         (flow_coef$bpptgrowsex_f[post_draws[p]]) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] * (s-1) +
                         (flow_coef$bpptdormsex_f[post_draws[p]]) * pptdorm_seq * (s-1) +
                         (flow_coef$btempgrowsex_f[post_draws[p]]) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] * (s-1) +
                        (flow_coef$btempdormsex_f[post_draws[p]]) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * (s-1) +
                         (flow_coef$btempdormpptdorm_f[post_draws[p]]) * pptdorm_seq * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] +
                         (flow_coef$btempgrowpptgrow_f[post_draws[p]]) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                         (flow_coef$btempdormpptdormsex_f[post_draws[p]]) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * pptdorm_seq * (s-1) +
                         (flow_coef$btempgrowpptgrowsex_f[post_draws[p]]) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] * (s-1) +
                         (flow_coef$bpptgrow2_f[post_draws[p]]) * (flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s])^2 +
                         (flow_coef$bpptdorm2_f[post_draws[p]]) * (pptdorm_seq^2) +
                         (flow_coef$btempgrow2_f[post_draws[p]]) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 +
                         (flow_coef$btempdorm2_f[post_draws[p]]) * (flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s])^2 +
                         (flow_coef$bpptgrow2sex_f[post_draws[p]]) * (flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s])^2 * (s-1) +
                         (flow_coef$bpptdorm2sex_f[post_draws[p]]) * (pptdorm_seq^2) * (s-1) +
                         (flow_coef$btempgrow2sex_f[post_draws[p]]) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 * (s-1) +
                         (flow_coef$btempdorm2sex_f[post_draws[p]]) * (flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s])^2 * (s-1)
    )
  
     fem_p <- exp((panic_coef$b0_p[post_draws[p]]) + 
                         (panic_coef$bsize_p[post_draws[p]]) * panic_mean_sizes$size[panic_mean_sizes$Sex==s & panic_mean_sizes$size_bin==i]+
                         (panic_coef$bsizesex_p[post_draws[p]]) * panic_mean_sizes$size[panic_mean_sizes$Sex==s & panic_mean_sizes$size_bin==i] * (s-1) +
                         (panic_coef$bsex_p[post_draws[p]]) * (s-1) +
                         (panic_coef$bpptgrow_p[post_draws[p]]) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s] +
                         (panic_coef$bpptdorm_p[post_draws[p]]) *  pptdorm_seq +
                         (panic_coef$btempgrow_p[post_draws[p]]) * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] +
                         (panic_coef$btempdorm_p[post_draws[p]]) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] +
                         (panic_coef$bpptgrowsex_p[post_draws[p]]) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s] * (s-1) +
                         (panic_coef$bpptdormsex_p[post_draws[p]]) * pptdorm_seq * (s-1) +
                         (panic_coef$btempgrowsex_p[post_draws[p]]) * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] * (s-1) +
                        (panic_coef$btempdormsex_p[post_draws[p]]) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * (s-1) +
                         (panic_coef$btempdormpptdorm_p[post_draws[p]]) * pptdorm_seq * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] +
                         (panic_coef$btempgrowpptgrow_p[post_draws[p]]) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s] * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] +
                         (panic_coef$btempdormpptdormsex_p[post_draws[p]]) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * pptdorm_seq * (s-1) +
                         (panic_coef$btempgrowpptgrowsex_p[post_draws[p]]) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s] * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] * (s-1) +
                         (panic_coef$bpptgrow2_p[post_draws[p]]) * (panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s])^2 +
                         (panic_coef$bpptdorm2_p[post_draws[p]]) * (pptdorm_seq^2) +
                         (panic_coef$btempgrow2_p[post_draws[p]]) * (panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s])^2 +
                         (panic_coef$btempdorm2_p[post_draws[p]]) * (panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s])^2 +
                         (panic_coef$bpptgrow2sex_p[post_draws[p]]) * (panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s])^2 * (s-1) +
                         (panic_coef$bpptdorm2sex_p[post_draws[p]]) * (pptdorm_seq^2) * (s-1) +
                         (panic_coef$btempgrow2sex_p[post_draws[p]]) * (panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s])^2 * (s-1) +
                         (panic_coef$btempdorm2sex_p[post_draws[p]]) * (panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s])^2 * (s-1)
    )
    
    s=2;       
   male_s <- invlogit((surv_coef$b0_s[post_draws[p]]) + 
                         (surv_coef$bsize_s[post_draws[p]]) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i]+
                         (surv_coef$bsizesex_s[post_draws[p]]) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i] * (s-1) +
                         (surv_coef$bsex_s[post_draws[p]]) * (s-1) +
                         (surv_coef$bpptgrow_s[post_draws[p]]) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] +
                         (surv_coef$bpptdorm_s[post_draws[p]]) *  pptdorm_seq +
                         (surv_coef$btempgrow_s[post_draws[p]]) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                         (surv_coef$btempdorm_s[post_draws[p]]) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] +
                         (surv_coef$bpptgrowsex_s[post_draws[p]]) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * (s-1) +
                         (surv_coef$bpptdormsex_s[post_draws[p]]) * pptdorm_seq * (s-1) +
                         (surv_coef$btempgrowsex_s[post_draws[p]]) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * (s-1) +
                        (surv_coef$btempdormsex_s[post_draws[p]]) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * (s-1) +
                         (surv_coef$btempdormpptdorm_s[post_draws[p]]) * pptdorm_seq * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] +
                         (surv_coef$btempgrowpptgrow_s[post_draws[p]]) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                         (surv_coef$btempdormpptdormsex_s[post_draws[p]]) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * pptdorm_seq * (s-1) +
                         (surv_coef$btempgrowpptgrowsex_s[post_draws[p]]) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * (s-1) +
                         (surv_coef$bpptgrow2_s[post_draws[p]]) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 +
                         (surv_coef$bpptdorm2_s[post_draws[p]]) * (pptdorm_seq^2) +
                         (surv_coef$btempgrow2_s[post_draws[p]]) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 +
                         (surv_coef$btempdorm2_s[post_draws[p]]) * (surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s])^2 +
                         (surv_coef$bpptgrow2sex_s[post_draws[p]]) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 * (s-1) +
                         (surv_coef$bpptdorm2sex_s[post_draws[p]]) * (pptdorm_seq^2) * (s-1) +
                         (surv_coef$btempgrow2sex_s[post_draws[p]]) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 * (s-1) +
                         (surv_coef$btempdorm2sex_s[post_draws[p]]) * (surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s])^2 * (s-1)
    )
             
    male_g <- exp((grow_coef$b0_g[post_draws[p]]) + 
                         (grow_coef$bsize_g[post_draws[p]]) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i]+
                         (grow_coef$bsizesex_g[post_draws[p]]) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i] * (s-1) +
                         (grow_coef$bsex_g[post_draws[p]]) * (s-1) +
                         (grow_coef$bpptgrow_g[post_draws[p]]) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] +
                         (grow_coef$bpptdorm_g[post_draws[p]]) *  pptdorm_seq +
                         (grow_coef$btempgrow_g[post_draws[p]]) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                         (grow_coef$btempdorm_g[post_draws[p]]) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] +
                         (grow_coef$bpptgrowsex_g[post_draws[p]]) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * (s-1) +
                         (grow_coef$bpptdormsex_g[post_draws[p]]) * pptdorm_seq * (s-1) +
                         (grow_coef$btempgrowsex_g[post_draws[p]]) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] * (s-1) +
                        (grow_coef$btempdormsex_g[post_draws[p]]) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * (s-1) +
                         (grow_coef$btempdormpptdorm_g[post_draws[p]]) * pptdorm_seq * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] +
                         (grow_coef$btempgrowpptgrow_g[post_draws[p]]) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                         (grow_coef$btempdormpptdormsex_g[post_draws[p]]) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * pptdorm_seq * (s-1) +
                         (grow_coef$btempgrowpptgrowsex_g[post_draws[p]]) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] * (s-1) +
                         (grow_coef$bpptgrow2_g[post_draws[p]]) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 +
                         (grow_coef$bpptdorm2_g[post_draws[p]]) * (pptdorm_seq^2) +
                         (grow_coef$btempgrow2_g[post_draws[p]]) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 +
                         (grow_coef$btempdorm2_g[post_draws[p]]) * (grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s])^2 +
                         (grow_coef$bpptgrow2sex_g[post_draws[p]]) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 * (s-1) +
                         (grow_coef$bpptdorm2sex_g[post_draws[p]]) * (pptdorm_seq^2) * (s-1) +
                         (grow_coef$btempgrow2sex_g[post_draws[p]]) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 * (s-1) +
                         (grow_coef$btempdorm2sex_g[post_draws[p]]) * (grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s])^2 * (s-1)
    )
    
    male_f <- invlogit((flow_coef$b0_f[post_draws[p]]) + 
                         (flow_coef$bsize_f[post_draws[p]]) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i]+
                         (flow_coef$bsizesex_f[post_draws[p]]) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i] * (s-1) +
                         (flow_coef$bsex_f[post_draws[p]]) * (s-1) +
                         (flow_coef$bpptgrow_f[post_draws[p]]) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] +
                         (flow_coef$bpptdorm_f[post_draws[p]]) *  pptdorm_seq +
                         (flow_coef$btempgrow_f[post_draws[p]]) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                         (flow_coef$btempdorm_f[post_draws[p]]) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] +
                         (flow_coef$bpptgrowsex_f[post_draws[p]]) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] * (s-1) +
                         (flow_coef$bpptdormsex_f[post_draws[p]]) * pptdorm_seq * (s-1) +
                         (flow_coef$btempgrowsex_f[post_draws[p]]) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] * (s-1) +
                        (flow_coef$btempdormsex_f[post_draws[p]]) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * (s-1) +
                         (flow_coef$btempdormpptdorm_f[post_draws[p]]) * pptdorm_seq * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] +
                         (flow_coef$btempgrowpptgrow_f[post_draws[p]]) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                         (flow_coef$btempdormpptdormsex_f[post_draws[p]]) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * pptdorm_seq * (s-1) +
                         (flow_coef$btempgrowpptgrowsex_f[post_draws[p]]) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] * (s-1) +
                         (flow_coef$bpptgrow2_f[post_draws[p]]) * (flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s])^2 +
                         (flow_coef$bpptdorm2_f[post_draws[p]]) * (pptdorm_seq^2) +
                         (flow_coef$btempgrow2_f[post_draws[p]]) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 +
                         (flow_coef$btempdorm2_f[post_draws[p]]) * (flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s])^2 +
                         (flow_coef$bpptgrow2sex_f[post_draws[p]]) * (flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s])^2 * (s-1) +
                         (flow_coef$bpptdorm2sex_f[post_draws[p]]) * (pptdorm_seq^2) * (s-1) +
                         (flow_coef$btempgrow2sex_f[post_draws[p]]) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 * (s-1) +
                         (flow_coef$btempdorm2sex_f[post_draws[p]]) * (flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s])^2 * (s-1)
    )
  
    
    male_p <- exp((panic_coef$b0_p[post_draws[p]]) + 
                         (panic_coef$bsize_p[post_draws[p]]) * panic_mean_sizes$size[panic_mean_sizes$Sex==s & panic_mean_sizes$size_bin==i]+
                         (panic_coef$bsizesex_p[post_draws[p]]) * panic_mean_sizes$size[panic_mean_sizes$Sex==s & panic_mean_sizes$size_bin==i] * (s-1) +
                         (panic_coef$bsex_p[post_draws[p]]) * (s-1) +
                         (panic_coef$bpptgrow_p[post_draws[p]]) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s] +
                         (panic_coef$bpptdorm_p[post_draws[p]]) *  pptdorm_seq +
                         (panic_coef$btempgrow_p[post_draws[p]]) * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] +
                         (panic_coef$btempdorm_p[post_draws[p]]) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] +
                         (panic_coef$bpptgrowsex_p[post_draws[p]]) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s] * (s-1) +
                         (panic_coef$bpptdormsex_p[post_draws[p]]) * pptdorm_seq * (s-1) +
                         (panic_coef$btempgrowsex_p[post_draws[p]]) * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] * (s-1) +
                        (panic_coef$btempdormsex_p[post_draws[p]]) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * (s-1) +
                         (panic_coef$btempdormpptdorm_p[post_draws[p]]) * pptdorm_seq * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] +
                         (panic_coef$btempgrowpptgrow_p[post_draws[p]]) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s] * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] +
                         (panic_coef$btempdormpptdormsex_p[post_draws[p]]) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * pptdorm_seq * (s-1) +
                         (panic_coef$btempgrowpptgrowsex_p[post_draws[p]]) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s] * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] * (s-1) +
                         (panic_coef$bpptgrow2_p[post_draws[p]]) * (panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s])^2 +
                         (panic_coef$bpptdorm2_p[post_draws[p]]) * (pptdorm_seq^2) +
                         (panic_coef$btempgrow2_p[post_draws[p]]) * (panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s])^2 +
                         (panic_coef$btempdorm2_p[post_draws[p]]) * (panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s])^2 +
                         (panic_coef$bpptgrow2sex_p[post_draws[p]]) * (panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s])^2 * (s-1) +
                         (panic_coef$bpptdorm2sex_p[post_draws[p]]) * (pptdorm_seq^2) * (s-1) +
                         (panic_coef$btempgrow2sex_p[post_draws[p]]) * (panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s])^2 * (s-1) +
                         (panic_coef$btempdorm2sex_p[post_draws[p]]) * (panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s])^2 * (s-1)
    )
    surv_sex_diff_post_pptdorm[i,,p] <-  fem_s-male_s
    grow_sex_diff_post_pptdorm[i,,p] <-  fem_g-male_g
    flow_sex_diff_post_pptdorm[i,,p] <-  fem_f-male_f
    panic_sex_diff_post_pptdorm[i,,p] <-  fem_p-male_p
  }
}

```

```{r}
#define quantiles of posterior samples
sex_diff_surv_mean_pptdorm <- sex_diff_grow_mean_pptdorm <- sex_diff_flow_mean_pptdorm <- sex_diff_panic_mean_pptdorm <- matrix(NA,size_bin_num,length(pptdorm_seq))
sex_diff_surv_95_pptdorm <- sex_diff_surv_75_pptdorm <- sex_diff_surv_50_pptdorm <- sex_diff_surv_25_pptdorm <- array(NA,dim=c(size_bin_num,length(pptdorm_seq),2))
sex_diff_grow_95_pptdorm <- sex_diff_grow_75_pptdorm <- sex_diff_grow_50_pptdorm <- sex_diff_grow_25_pptdorm <- array(NA,dim=c(size_bin_num,length(pptdorm_seq),2))
sex_diff_flow_95_pptdorm <- sex_diff_flow_75_pptdorm <- sex_diff_flow_50_pptdorm <- sex_diff_flow_25_pptdorm <- array(NA,dim=c(size_bin_num,length(pptdorm_seq),2))
sex_diff_panic_95_pptdorm <- sex_diff_panic_75_pptdorm <- sex_diff_panic_50_pptdorm <- sex_diff_panic_25_pptdorm <- array(NA,dim=c(size_bin_num,length(pptdorm_seq),2))
for(s in 1:size_bin_num){
  for(l in 1:length(pptdorm_seq)){
    sex_diff_surv_mean_pptdorm[s,l] <- mean(surv_sex_diff_post_pptdorm[s,l,])
    sex_diff_surv_95_pptdorm[s,l,] <- quantile(surv_sex_diff_post_pptdorm[s,l,],probs=c(0.025,0.975))
    sex_diff_surv_75_pptdorm[s,l,] <- quantile(surv_sex_diff_post_pptdorm[s,l,],probs=c(0.125,0.875))
    sex_diff_surv_50_pptdorm[s,l,] <- quantile(surv_sex_diff_post_pptdorm[s,l,],probs=c(0.25,0.75))
    sex_diff_surv_25_pptdorm[s,l,] <- quantile(surv_sex_diff_post_pptdorm[s,l,],probs=c(0.375,0.625))
    
    sex_diff_grow_mean_pptdorm[s,l] <- mean(grow_sex_diff_post_pptdorm[s,l,])
    sex_diff_grow_95_pptdorm[s,l,] <- quantile(grow_sex_diff_post_pptdorm[s,l,],probs=c(0.025,0.975))
    sex_diff_grow_75_pptdorm[s,l,] <- quantile(grow_sex_diff_post_pptdorm[s,l,],probs=c(0.125,0.875))
    sex_diff_grow_50_pptdorm[s,l,] <- quantile(grow_sex_diff_post_pptdorm[s,l,],probs=c(0.25,0.75))
    sex_diff_grow_25_pptdorm[s,l,] <- quantile(grow_sex_diff_post_pptdorm[s,l,],probs=c(0.375,0.625))
    
    sex_diff_flow_mean_pptdorm[s,l] <- mean(flow_sex_diff_post_pptdorm[s,l,])
    sex_diff_flow_95_pptdorm[s,l,] <- quantile(flow_sex_diff_post_pptdorm[s,l,],probs=c(0.025,0.975))
    sex_diff_flow_75_pptdorm[s,l,] <- quantile(flow_sex_diff_post_pptdorm[s,l,],probs=c(0.125,0.875))
    sex_diff_flow_50_pptdorm[s,l,] <- quantile(flow_sex_diff_post_pptdorm[s,l,],probs=c(0.25,0.75))
    sex_diff_flow_25_pptdorm[s,l,] <- quantile(flow_sex_diff_post_pptdorm[s,l,],probs=c(0.375,0.625))
    
    sex_diff_panic_mean_pptdorm[s,l] <- mean(panic_sex_diff_post_pptdorm[s,l,])
    sex_diff_panic_95_pptdorm[s,l,] <- quantile(panic_sex_diff_post_pptdorm[s,l,],probs=c(0.025,0.975))
    sex_diff_panic_75_pptdorm[s,l,] <- quantile(panic_sex_diff_post_pptdorm[s,l,],probs=c(0.125,0.875))
    sex_diff_panic_50_pptdorm[s,l,] <- quantile(panic_sex_diff_post_pptdorm[s,l,],probs=c(0.25,0.75))
    sex_diff_panic_25_pptdorm[s,l,] <- quantile(panic_sex_diff_post_pptdorm[s,l,],probs=c(0.375,0.625))
    
  }
}
```

## Temperature of the dormant season

```{r}
# sample vital rate functions from the join posterior
tempdorm_seq <- seq(min(poar_surv_binned$tempdorm),max(poar_surv_binned$tempdorm),length.out=30)
n_post_draws <- 2000
post_draws <- sample.int(length(surv_coef$b0_s), n_post_draws)
surv_sex_diff_post_tempdorm <- grow_sex_diff_post_tempdorm <- flow_sex_diff_post_tempdorm <- panic_sex_diff_post_tempdorm <- array(NA,dim=c(size_bin_num,length(tempdorm_seq),n_post_draws))
for(p in 1:n_post_draws){
  for(i in 1:size_bin_num){
    s=1;      
    fem_s <- invlogit((surv_coef$b0_s[post_draws[p]]) + 
                         (surv_coef$bsize_s[post_draws[p]]) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i] +
                         (surv_coef$bsizesex_s[post_draws[p]]) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i] * (s-1) +
                         (surv_coef$bsex_s[post_draws[p]]) * (s-1) +
                         (surv_coef$bpptgrow_s[post_draws[p]]) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] +
                         (surv_coef$bpptdorm_s[post_draws[p]]) *  surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] +
                         (surv_coef$btempgrow_s[post_draws[p]]) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                         (surv_coef$btempdorm_s[post_draws[p]]) * tempdorm_seq +
                         (surv_coef$bpptgrowsex_s[post_draws[p]]) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * (s-1) +
                         (surv_coef$bpptdormsex_s[post_draws[p]]) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] * (s-1) +
                         (surv_coef$btempgrowsex_s[post_draws[p]]) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * (s-1) +
                        (surv_coef$btempdormsex_s[post_draws[p]]) * tempdorm_seq * (s-1) +
                         (surv_coef$btempdormpptdorm_s[post_draws[p]]) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] * tempdorm_seq +
                         (surv_coef$btempgrowpptgrow_s[post_draws[p]]) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                         (surv_coef$btempdormpptdormsex_s[post_draws[p]]) * tempdorm_seq * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] * (s-1) +
                         (surv_coef$btempgrowpptgrowsex_s[post_draws[p]]) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * (s-1) +
                         (surv_coef$bpptgrow2_s[post_draws[p]]) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 +
                         (surv_coef$bpptdorm2_s[post_draws[p]]) * (surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s])^2 +
                         (surv_coef$btempgrow2_s[post_draws[p]]) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 +
                         (surv_coef$btempdorm2_s[post_draws[p]]) * (tempdorm_seq^2) +
                         (surv_coef$bpptgrow2sex_s[post_draws[p]]) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 * (s-1) +
                         (surv_coef$bpptdorm2sex_s[post_draws[p]]) * (surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s])^2 * (s-1) +
                         (surv_coef$btempgrow2sex_s[post_draws[p]]) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 * (s-1) +
                         (surv_coef$btempdorm2sex_s[post_draws[p]]) * (tempdorm_seq^2) * (s-1)
    )
    
    fem_g <- exp((grow_coef$b0_g[post_draws[p]]) + 
                         (grow_coef$bsize_g[post_draws[p]]) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i] +
                         (grow_coef$bsizesex_g[post_draws[p]]) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i] * (s-1) +
                         (grow_coef$bsex_g[post_draws[p]]) * (s-1) +
                         (grow_coef$bpptgrow_g[post_draws[p]]) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] +
                         (grow_coef$bpptdorm_g[post_draws[p]]) *  grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] +
                         (grow_coef$btempgrow_g[post_draws[p]]) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                         (grow_coef$btempdorm_g[post_draws[p]]) * tempdorm_seq +
                         (grow_coef$bpptgrowsex_g[post_draws[p]]) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * (s-1) +
                         (grow_coef$bpptdormsex_g[post_draws[p]]) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] * (s-1) +
                         (grow_coef$btempgrowsex_g[post_draws[p]]) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] * (s-1) +
                        (grow_coef$btempdormsex_g[post_draws[p]]) * tempdorm_seq * (s-1) +
                         (grow_coef$btempdormpptdorm_g[post_draws[p]]) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] * tempdorm_seq +
                         (grow_coef$btempgrowpptgrow_g[post_draws[p]]) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                         (grow_coef$btempdormpptdormsex_g[post_draws[p]]) * tempdorm_seq * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] * (s-1) +
                         (grow_coef$btempgrowpptgrowsex_g[post_draws[p]]) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] * (s-1) +
                         (grow_coef$bpptgrow2_g[post_draws[p]]) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 +
                         (grow_coef$bpptdorm2_g[post_draws[p]]) * (grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s])^2 +
                         (grow_coef$btempgrow2_g[post_draws[p]]) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 +
                         (grow_coef$btempdorm2_g[post_draws[p]]) * (tempdorm_seq^2) +
                         (grow_coef$bpptgrow2sex_g[post_draws[p]]) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 * (s-1) +
                         (grow_coef$bpptdorm2sex_g[post_draws[p]]) * (grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s])^2 * (s-1) +
                         (grow_coef$btempgrow2sex_g[post_draws[p]]) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 * (s-1) +
                         (grow_coef$btempdorm2sex_g[post_draws[p]]) * (tempdorm_seq^2) * (s-1)
    )
    
    fem_f <- invlogit((flow_coef$b0_f[post_draws[p]]) + 
                         (flow_coef$bsize_f[post_draws[p]]) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i] +
                         (flow_coef$bsizesex_f[post_draws[p]]) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i] * (s-1) +
                         (flow_coef$bsex_f[post_draws[p]]) * (s-1) +
                         (flow_coef$bpptgrow_f[post_draws[p]]) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] +
                         (flow_coef$bpptdorm_f[post_draws[p]]) *  flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s] +
                         (flow_coef$btempgrow_f[post_draws[p]]) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                         (flow_coef$btempdorm_f[post_draws[p]]) * tempdorm_seq +
                         (flow_coef$bpptgrowsex_f[post_draws[p]]) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] * (s-1) +
                         (flow_coef$bpptdormsex_f[post_draws[p]]) * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s] * (s-1) +
                         (flow_coef$btempgrowsex_f[post_draws[p]]) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] * (s-1) +
                        (flow_coef$btempdormsex_f[post_draws[p]]) * tempdorm_seq * (s-1) +
                         (flow_coef$btempdormpptdorm_f[post_draws[p]]) * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s] * tempdorm_seq +
                         (flow_coef$btempgrowpptgrow_f[post_draws[p]]) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                         (flow_coef$btempdormpptdormsex_f[post_draws[p]]) * tempdorm_seq * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s] * (s-1) +
                         (flow_coef$btempgrowpptgrowsex_f[post_draws[p]]) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] * (s-1) +
                         (flow_coef$bpptgrow2_f[post_draws[p]]) * (flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s])^2 +
                         (flow_coef$bpptdorm2_f[post_draws[p]]) * (flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s])^2 +
                         (flow_coef$btempgrow2_f[post_draws[p]]) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 +
                         (flow_coef$btempdorm2_f[post_draws[p]]) * (tempdorm_seq^2) +
                         (flow_coef$bpptgrow2sex_f[post_draws[p]]) * (flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s])^2 * (s-1) +
                         (flow_coef$bpptdorm2sex_f[post_draws[p]]) * (flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s])^2 * (s-1) +
                         (flow_coef$btempgrow2sex_f[post_draws[p]]) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 * (s-1) +
                         (flow_coef$btempdorm2sex_f[post_draws[p]]) * (tempdorm_seq^2) * (s-1)
    )
  
     fem_p <- exp((panic_coef$b0_p[post_draws[p]]) + 
                         (panic_coef$bsize_p[post_draws[p]]) * panic_mean_sizes$size[panic_mean_sizes$Sex==s & panic_mean_sizes$size_bin==i] +
                         (panic_coef$bsizesex_p[post_draws[p]]) * panic_mean_sizes$size[panic_mean_sizes$Sex==s & panic_mean_sizes$size_bin==i] * (s-1) +
                         (panic_coef$bsex_p[post_draws[p]]) * (s-1) +
                         (panic_coef$bpptgrow_p[post_draws[p]]) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s] +
                         (panic_coef$bpptdorm_p[post_draws[p]]) *  panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s] +
                         (panic_coef$btempgrow_p[post_draws[p]]) * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] +
                         (panic_coef$btempdorm_p[post_draws[p]]) * tempdorm_seq +
                         (panic_coef$bpptgrowsex_p[post_draws[p]]) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s] * (s-1) +
                         (panic_coef$bpptdormsex_p[post_draws[p]]) * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s] * (s-1) +
                         (panic_coef$btempgrowsex_p[post_draws[p]]) * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] * (s-1) +
                        (panic_coef$btempdormsex_p[post_draws[p]]) * tempdorm_seq * (s-1) +
                         (panic_coef$btempdormpptdorm_p[post_draws[p]]) * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s] * tempdorm_seq +
                         (panic_coef$btempgrowpptgrow_p[post_draws[p]]) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s] * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] +
                         (panic_coef$btempdormpptdormsex_p[post_draws[p]]) * tempdorm_seq * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s] * (s-1) +
                         (panic_coef$btempgrowpptgrowsex_p[post_draws[p]]) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s] * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] * (s-1) +
                         (panic_coef$bpptgrow2_p[post_draws[p]]) * (panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s])^2 +
                         (panic_coef$bpptdorm2_p[post_draws[p]]) * (panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s])^2 +
                         (panic_coef$btempgrow2_p[post_draws[p]]) * (panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s])^2 +
                         (panic_coef$btempdorm2_p[post_draws[p]]) * (tempdorm_seq^2) +
                         (panic_coef$bpptgrow2sex_p[post_draws[p]]) * (panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s])^2 * (s-1) +
                         (panic_coef$bpptdorm2sex_p[post_draws[p]]) * (panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s])^2 * (s-1) +
                         (panic_coef$btempgrow2sex_p[post_draws[p]]) * (panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s])^2 * (s-1) +
                         (panic_coef$btempdorm2sex_p[post_draws[p]]) * (tempdorm_seq^2) * (s-1)
    )
    
    s=2;       
   male_s <- invlogit((surv_coef$b0_s[post_draws[p]]) + 
                         (surv_coef$bsize_s[post_draws[p]]) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i] +
                         (surv_coef$bsizesex_s[post_draws[p]]) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i] * (s-1) +
                         (surv_coef$bsex_s[post_draws[p]]) * (s-1) +
                         (surv_coef$bpptgrow_s[post_draws[p]]) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] +
                         (surv_coef$bpptdorm_s[post_draws[p]]) *  surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] +
                         (surv_coef$btempgrow_s[post_draws[p]]) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                         (surv_coef$btempdorm_s[post_draws[p]]) * tempdorm_seq +
                         (surv_coef$bpptgrowsex_s[post_draws[p]]) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * (s-1) +
                         (surv_coef$bpptdormsex_s[post_draws[p]]) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] * (s-1) +
                         (surv_coef$btempgrowsex_s[post_draws[p]]) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * (s-1) +
                        (surv_coef$btempdormsex_s[post_draws[p]]) * tempdorm_seq * (s-1) +
                         (surv_coef$btempdormpptdorm_s[post_draws[p]]) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] * tempdorm_seq +
                         (surv_coef$btempgrowpptgrow_s[post_draws[p]]) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                         (surv_coef$btempdormpptdormsex_s[post_draws[p]]) * tempdorm_seq * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] * (s-1) +
                         (surv_coef$btempgrowpptgrowsex_s[post_draws[p]]) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * (s-1) +
                         (surv_coef$bpptgrow2_s[post_draws[p]]) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 +
                         (surv_coef$bpptdorm2_s[post_draws[p]]) * (surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s])^2 +
                         (surv_coef$btempgrow2_s[post_draws[p]]) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 +
                         (surv_coef$btempdorm2_s[post_draws[p]]) * (tempdorm_seq^2) +
                         (surv_coef$bpptgrow2sex_s[post_draws[p]]) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 * (s-1) +
                         (surv_coef$bpptdorm2sex_s[post_draws[p]]) * (surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s])^2 * (s-1) +
                         (surv_coef$btempgrow2sex_s[post_draws[p]]) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 * (s-1) +
                         (surv_coef$btempdorm2sex_s[post_draws[p]]) * (tempdorm_seq^2) * (s-1)
    )
    
    male_g <- exp((grow_coef$b0_g[post_draws[p]]) + 
                         (grow_coef$bsize_g[post_draws[p]]) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i] +
                         (grow_coef$bsizesex_g[post_draws[p]]) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i] * (s-1) +
                         (grow_coef$bsex_g[post_draws[p]]) * (s-1) +
                         (grow_coef$bpptgrow_g[post_draws[p]]) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] +
                         (grow_coef$bpptdorm_g[post_draws[p]]) *  grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] +
                         (grow_coef$btempgrow_g[post_draws[p]]) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                         (grow_coef$btempdorm_g[post_draws[p]]) * tempdorm_seq +
                         (grow_coef$bpptgrowsex_g[post_draws[p]]) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * (s-1) +
                         (grow_coef$bpptdormsex_g[post_draws[p]]) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] * (s-1) +
                         (grow_coef$btempgrowsex_g[post_draws[p]]) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] * (s-1) +
                        (grow_coef$btempdormsex_g[post_draws[p]]) * tempdorm_seq * (s-1) +
                         (grow_coef$btempdormpptdorm_g[post_draws[p]]) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] * tempdorm_seq +
                         (grow_coef$btempgrowpptgrow_g[post_draws[p]]) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                         (grow_coef$btempdormpptdormsex_g[post_draws[p]]) * tempdorm_seq * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] * (s-1) +
                         (grow_coef$btempgrowpptgrowsex_g[post_draws[p]]) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] * (s-1) +
                         (grow_coef$bpptgrow2_g[post_draws[p]]) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 +
                         (grow_coef$bpptdorm2_g[post_draws[p]]) * (grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s])^2 +
                         (grow_coef$btempgrow2_g[post_draws[p]]) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 +
                         (grow_coef$btempdorm2_g[post_draws[p]]) * (tempdorm_seq^2) +
                         (grow_coef$bpptgrow2sex_g[post_draws[p]]) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 * (s-1) +
                         (grow_coef$bpptdorm2sex_g[post_draws[p]]) * (grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s])^2 * (s-1) +
                         (grow_coef$btempgrow2sex_g[post_draws[p]]) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 * (s-1) +
                         (grow_coef$btempdorm2sex_g[post_draws[p]]) * (tempdorm_seq^2) * (s-1)
    )
    
    male_f <- invlogit((flow_coef$b0_f[post_draws[p]]) + 
                         (flow_coef$bsize_f[post_draws[p]]) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i] +
                         (flow_coef$bsizesex_f[post_draws[p]]) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i] * (s-1) +
                         (flow_coef$bsex_f[post_draws[p]]) * (s-1) +
                         (flow_coef$bpptgrow_f[post_draws[p]]) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] +
                         (flow_coef$bpptdorm_f[post_draws[p]]) *  flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s] +
                         (flow_coef$btempgrow_f[post_draws[p]]) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                         (flow_coef$btempdorm_f[post_draws[p]]) * tempdorm_seq +
                         (flow_coef$bpptgrowsex_f[post_draws[p]]) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] * (s-1) +
                         (flow_coef$bpptdormsex_f[post_draws[p]]) * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s] * (s-1) +
                         (flow_coef$btempgrowsex_f[post_draws[p]]) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] * (s-1) +
                        (flow_coef$btempdormsex_f[post_draws[p]]) * tempdorm_seq * (s-1) +
                         (flow_coef$btempdormpptdorm_f[post_draws[p]]) * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s] * tempdorm_seq +
                         (flow_coef$btempgrowpptgrow_f[post_draws[p]]) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                         (flow_coef$btempdormpptdormsex_f[post_draws[p]]) * tempdorm_seq * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s] * (s-1) +
                         (flow_coef$btempgrowpptgrowsex_f[post_draws[p]]) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] * (s-1) +
                         (flow_coef$bpptgrow2_f[post_draws[p]]) * (flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s])^2 +
                         (flow_coef$bpptdorm2_f[post_draws[p]]) * (flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s])^2 +
                         (flow_coef$btempgrow2_f[post_draws[p]]) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 +
                         (flow_coef$btempdorm2_f[post_draws[p]]) * (tempdorm_seq^2) +
                         (flow_coef$bpptgrow2sex_f[post_draws[p]]) * (flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s])^2 * (s-1) +
                         (flow_coef$bpptdorm2sex_f[post_draws[p]]) * (flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s])^2 * (s-1) +
                         (flow_coef$btempgrow2sex_f[post_draws[p]]) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 * (s-1) +
                         (flow_coef$btempdorm2sex_f[post_draws[p]]) * (tempdorm_seq^2) * (s-1)
    )
  
     male_p <- exp((panic_coef$b0_p[post_draws[p]]) + 
                         (panic_coef$bsize_p[post_draws[p]]) * panic_mean_sizes$size[panic_mean_sizes$Sex==s & panic_mean_sizes$size_bin==i] +
                         (panic_coef$bsizesex_p[post_draws[p]]) * panic_mean_sizes$size[panic_mean_sizes$Sex==s & panic_mean_sizes$size_bin==i] * (s-1) +
                         (panic_coef$bsex_p[post_draws[p]]) * (s-1) +
                         (panic_coef$bpptgrow_p[post_draws[p]]) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s] +
                         (panic_coef$bpptdorm_p[post_draws[p]]) *  panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s] +
                         (panic_coef$btempgrow_p[post_draws[p]]) * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] +
                         (panic_coef$btempdorm_p[post_draws[p]]) * tempdorm_seq +
                         (panic_coef$bpptgrowsex_p[post_draws[p]]) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s] * (s-1) +
                         (panic_coef$bpptdormsex_p[post_draws[p]]) * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s] * (s-1) +
                         (panic_coef$btempgrowsex_p[post_draws[p]]) * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] * (s-1) +
                        (panic_coef$btempdormsex_p[post_draws[p]]) * tempdorm_seq * (s-1) +
                         (panic_coef$btempdormpptdorm_p[post_draws[p]]) * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s] * tempdorm_seq +
                         (panic_coef$btempgrowpptgrow_p[post_draws[p]]) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s] * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] +
                         (panic_coef$btempdormpptdormsex_p[post_draws[p]]) * tempdorm_seq * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s] * (s-1) +
                         (panic_coef$btempgrowpptgrowsex_p[post_draws[p]]) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s] * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] * (s-1) +
                         (panic_coef$bpptgrow2_p[post_draws[p]]) * (panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s])^2 +
                         (panic_coef$bpptdorm2_p[post_draws[p]]) * (panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s])^2 +
                         (panic_coef$btempgrow2_p[post_draws[p]]) * (panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s])^2 +
                         (panic_coef$btempdorm2_p[post_draws[p]]) * (tempdorm_seq^2) +
                         (panic_coef$bpptgrow2sex_p[post_draws[p]]) * (panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s])^2 * (s-1) +
                         (panic_coef$bpptdorm2sex_p[post_draws[p]]) * (panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s])^2 * (s-1) +
                         (panic_coef$btempgrow2sex_p[post_draws[p]]) * (panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s])^2 * (s-1) +
                         (panic_coef$btempdorm2sex_p[post_draws[p]]) * (tempdorm_seq^2) * (s-1)
    )
    
    surv_sex_diff_post_tempdorm[i,,p] <-  fem_s-male_s
    grow_sex_diff_post_tempdorm[i,,p] <-  fem_g-male_g
    flow_sex_diff_post_tempdorm[i,,p] <-  fem_f-male_f
    panic_sex_diff_post_tempdorm[i,,p] <-  fem_p-male_p
  }
}

```

```{r}
#tom's code to visualize full posteriors of difference functions
#win.graph()
#matplot(panic_sex_diff_post_tempgrow[1,,],type="l")
#quantile(panic_sex_diff_post_tempgrow[1,1,],probs=c(0.05,0.5,0.95))
```

```{r}
#define quantiles of posterior samples
sex_diff_surv_mean_tempdorm <- sex_diff_grow_mean_tempdorm <- sex_diff_flow_mean_tempdorm <- sex_diff_panic_mean_tempdorm <- matrix(NA,size_bin_num,length(tempdorm_seq))
sex_diff_surv_95_tempdorm <- sex_diff_surv_75_tempdorm <- sex_diff_surv_50_tempdorm <- sex_diff_surv_25_tempdorm <- array(NA,dim=c(size_bin_num,length(tempdorm_seq),2))
sex_diff_grow_95_tempdorm <- sex_diff_grow_75_tempdorm <- sex_diff_grow_50_tempdorm <- sex_diff_grow_25_tempdorm <- array(NA,dim=c(size_bin_num,length(tempdorm_seq),2))
sex_diff_flow_95_tempdorm <- sex_diff_flow_75_tempdorm <- sex_diff_flow_50_tempdorm <- sex_diff_flow_25_tempdorm <- array(NA,dim=c(size_bin_num,length(tempdorm_seq),2))
sex_diff_panic_95_tempdorm <- sex_diff_panic_75_tempdorm <- sex_diff_panic_50_tempdorm <- sex_diff_panic_25_tempdorm <- array(NA,dim=c(size_bin_num,length(tempdorm_seq),2))
for(s in 1:size_bin_num){
  for(l in 1:length(tempdorm_seq)){
    sex_diff_surv_mean_tempdorm[s,l] <- mean(surv_sex_diff_post_tempdorm[s,l,])
    sex_diff_surv_95_tempdorm[s,l,] <- quantile(surv_sex_diff_post_tempdorm[s,l,],probs=c(0.025,0.975))
    sex_diff_surv_75_tempdorm[s,l,] <- quantile(surv_sex_diff_post_tempdorm[s,l,],probs=c(0.125,0.875))
    sex_diff_surv_50_tempdorm[s,l,] <- quantile(surv_sex_diff_post_tempdorm[s,l,],probs=c(0.25,0.75))
    sex_diff_surv_25_tempdorm[s,l,] <- quantile(surv_sex_diff_post_tempdorm[s,l,],probs=c(0.375,0.625))
    
    sex_diff_grow_mean_tempdorm[s,l] <- mean(grow_sex_diff_post_tempdorm[s,l,])
    sex_diff_grow_95_tempdorm[s,l,] <- quantile(grow_sex_diff_post_tempdorm[s,l,],probs=c(0.025,0.975))
    sex_diff_grow_75_tempdorm[s,l,] <- quantile(grow_sex_diff_post_tempdorm[s,l,],probs=c(0.125,0.875))
    sex_diff_grow_50_tempdorm[s,l,] <- quantile(grow_sex_diff_post_tempdorm[s,l,],probs=c(0.25,0.75))
    sex_diff_grow_25_tempdorm[s,l,] <- quantile(grow_sex_diff_post_tempdorm[s,l,],probs=c(0.375,0.625))
    
    sex_diff_flow_mean_tempdorm[s,l] <- mean(flow_sex_diff_post_tempdorm[s,l,])
    sex_diff_flow_95_tempdorm[s,l,] <- quantile(flow_sex_diff_post_tempdorm[s,l,],probs=c(0.025,0.975))
    sex_diff_flow_75_tempdorm[s,l,] <- quantile(flow_sex_diff_post_tempdorm[s,l,],probs=c(0.125,0.875))
    sex_diff_flow_50_tempdorm[s,l,] <- quantile(flow_sex_diff_post_tempdorm[s,l,],probs=c(0.25,0.75))
    sex_diff_flow_25_tempdorm[s,l,] <- quantile(flow_sex_diff_post_tempdorm[s,l,],probs=c(0.375,0.625))
    
    sex_diff_panic_mean_tempdorm[s,l] <- mean(panic_sex_diff_post_tempdorm[s,l,])
    sex_diff_panic_95_tempdorm[s,l,] <- quantile(panic_sex_diff_post_tempdorm[s,l,],probs=c(0.025,0.975))
    sex_diff_panic_75_tempdorm[s,l,] <- quantile(panic_sex_diff_post_tempdorm[s,l,],probs=c(0.125,0.875))
    sex_diff_panic_50_tempdorm[s,l,] <- quantile(panic_sex_diff_post_tempdorm[s,l,],probs=c(0.25,0.75))
    sex_diff_panic_25_tempdorm[s,l,] <- quantile(panic_sex_diff_post_tempdorm[s,l,],probs=c(0.375,0.625))
    
  }
}
```

```{r}

# set up figure
sex_cols <- RColorBrewer::brewer.pal(8, "Dark2")[c(2,1)]
# sex_cols <- c("black","white")
sex_lty <- c(1,1)
bin_shapes <- 15
diff_col <- RColorBrewer::brewer.pal(8, "Dark2")[6]
diff_alpha <- 0.35
graph<-list("A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P")
layout.matrix <- rbind(matrix(1:8, nrow = 2, ncol = 4, byrow = F),
                       matrix(9:16, nrow = 2, ncol = 4, byrow = F),
                       matrix(17:24, nrow = 2, ncol = 4, byrow = F),
                       matrix(25:32, nrow = 2, ncol = 4, byrow = F))
#print figure
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/vital_rates.pdf",height = 14,width = 13,useDingbats = F)
layout(mat = layout.matrix,
       heights = rep(c(2, 1),4), # Heights of the two rows
       widths = c(2, 2, 2,2))
# layout.show(32)

par(oma=c(3,1,0.5,0.5))
with(poar_surv_binned,{
  for(i in 1:size_bin_num){
    par(mar=c(0,4,2,0))
    plot(pptgrow[size_bin==i]*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),mean_surv[size_bin==i],type="n",xaxt="n",ylim=c(0,1),
         xlab=" ",ylab=" ");box()
    if(i==1){mtext("Pr(survival)",side=2,line=3,cex=1.5)}
    mylabel3 <- paste(graph[[1]])
    mtext(mylabel3,side = 3, adj = 0,cex=1.5)
    for(s in 1:2){
      points(pptgrow[Sex==s & size_bin==i]*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),mean_surv[Sex==s & size_bin==i],
             bg=sex_cols[s],pch=21,cex=5*(bin_n/max(bin_n)),lwd=2)
      lines(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),invlogit(mean(surv_coef$b0_s) + 
                         mean(surv_coef$bsize_s) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i]+
                         mean(surv_coef$bsizesex_s) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i] * (s-1) +
                         mean(surv_coef$bsex_s) * (s-1) +
                         mean(surv_coef$bpptgrow_s) * pptgrow_seq +
                         mean(surv_coef$bpptdorm_s) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s]  +
                         mean(surv_coef$btempgrow_s) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                         mean(surv_coef$btempdorm_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] +
                         mean(surv_coef$bpptgrowsex_s) * pptgrow_seq * (s-1) +
                         mean(surv_coef$bpptdormsex_s) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s]  * (s-1) +
                         mean(surv_coef$btempgrowsex_s) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * (s-1) +
                        mean(surv_coef$btempdormsex_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * (s-1) +
                         mean(surv_coef$btempdormpptdorm_s) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] +
                         mean(surv_coef$btempgrowpptgrow_s) * pptgrow_seq * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                         mean(surv_coef$btempdormpptdormsex_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] * (s-1) +
                         mean(surv_coef$btempgrowpptgrowsex_s) * pptgrow_seq * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s]  * (s-1) +
                         mean(surv_coef$bpptgrow2_s) * (pptgrow_seq^2) +
                         mean(surv_coef$bpptdorm2_s) * (surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s])^2 +
                         mean(surv_coef$btempgrow2_s) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 +
                         mean(surv_coef$btempdorm2_s) * (surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s])^2 +
                         mean(surv_coef$bpptgrow2sex_s) * (pptgrow_seq^2) * (s-1) +
                         mean(surv_coef$bpptdorm2sex_s) * (surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s])^2 * (s-1) +
                         mean(surv_coef$btempgrow2sex_s) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 * (s-1) +
                         mean(surv_coef$btempdorm2sex_s) * (surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s])^2 * (s-1)
    ),lty=sex_lty[s],lwd=3,col= sex_cols[s])
    }
    par(mar=c(2,4,0.5,0))
    plot(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) ,sex_diff_surv_mean_pptgrow[i,],type="n",lwd=4,yaxt="n",
         xlab=" ",ylab=" ",xaxt="n",ylim=c(min(sex_diff_surv_95_pptgrow[i,,1]),max(sex_diff_surv_95_pptgrow[i,,2])))
    if(i==1){mtext(expression(paste(Delta," (F-M)")),side=2,line=2,cex=1.3)}
    polygon(x=c(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),rev(pptgrow_seq *sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow))),
            y=c(sex_diff_surv_95_pptgrow[i,,1],rev(sex_diff_surv_95_pptgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) ,rev(pptgrow_seq *sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow))),
            y=c(sex_diff_surv_75_pptgrow[i,,1],rev(sex_diff_surv_75_pptgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),rev(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow))),
            y=c(sex_diff_surv_50_pptgrow[i,,1],rev(sex_diff_surv_50_pptgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) ,rev(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow))),
            y=c(sex_diff_surv_25_pptgrow[i,,1],rev(sex_diff_surv_25_pptgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    lines(pptgrow_seq *sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),sex_diff_surv_mean_pptgrow[i,],lwd=2,col="black")
    abline(h=0,lty=2)
    mtext("0",side=2,at=0)
  }
})

with(poar_surv_binned,{
  for(i in 1:size_bin_num){
    par(mar=c(0,4,2,0))
    plot(tempgrow[size_bin==i]*sd(poar_2015_2016$tempgrow)+ mean(poar_2015_2016$tempgrow),mean_surv[size_bin==i],type="n",ylim=c(0,1),
         xlab=" ",ylab=" ",xaxt="n");box()
     mylabel3 <- paste(graph[[2]])
     mtext(mylabel3,side = 3, adj = 0,cex=1.5)
    for(s in 1:2){
      points(tempgrow[Sex==s & size_bin==i]*sd(poar_2015_2016$tempgrow)+mean(poar_2015_2016$tempgrow),mean_surv[Sex==s & size_bin==i],
             bg=sex_cols[s],pch=21,cex=5*(bin_n/max(bin_n)),lwd=2)
      lines(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow),invlogit(mean(surv_coef$b0_s) +
                        mean(surv_coef$bsize_s) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i] +
                        mean(surv_coef$bsizesex_s) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i] * (s-1) +
                        mean(surv_coef$bsex_s) * (s-1) +
                        mean(surv_coef$bpptgrow_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s]  +
                        mean(surv_coef$bpptdorm_s) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s]  +
                        mean(surv_coef$btempgrow_s) * tempgrow_seq +
                        mean(surv_coef$btempdorm_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] +
                        mean(surv_coef$bpptgrowsex_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * (s-1) +
                        mean(surv_coef$bpptdormsex_s) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s]  * (s-1) +
                        mean(surv_coef$btempdormpptdorm_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] +
                        mean(surv_coef$btempgrowpptgrow_s) * tempgrow_seq * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] +
                        mean(surv_coef$btempgrowsex_s) * tempgrow_seq * (s-1) +
                        mean(surv_coef$btempdormsex_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * (s-1) +
                        mean(surv_coef$btempdormpptdormsex_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] * (s-1) +
                        mean(surv_coef$btempgrowpptgrowsex_s) * tempgrow_seq * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s]  * (s-1) +
                        mean(surv_coef$bpptgrow2_s) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 +
                        mean(surv_coef$bpptdorm2_s) * (surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s])^2 +
                        mean(surv_coef$btempgrow2_s) * (tempgrow_seq^2) +
                        mean(surv_coef$btempdorm2_s) * (surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s])^2 +
                        mean(surv_coef$bpptgrow2sex_s) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 * (s-1) +
                        mean(surv_coef$bpptdorm2sex_s) * (surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s])^2 * (s-1) +
                        mean(surv_coef$btempgrow2sex_s) * (tempgrow_seq^2) * (s-1) +
                        mean(surv_coef$btempdorm2sex_s) * (surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s])^2 * (s-1)
    
    ),lty=sex_lty[s],lwd=3,col= sex_cols[s])
    }
    par(mar=c(2,4,0.5,0))
    plot(tempgrow_seq *sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow),sex_diff_surv_mean_tempgrow[i,],type="n",lwd=4,yaxt="n",
         xlab=" ",ylab=" ",xaxt="n",ylim=c(min(sex_diff_surv_95_tempgrow[i,,1]),max(sex_diff_surv_95_tempgrow[i,,2])))
    # if(i==1){mtext(expression(paste(Delta," (F-M)")),side=2,line=2,cex=1.3)}
    polygon(x=c(tempgrow_seq*sd(poar_2015_2016$tempgrow)+ mean(poar_2015_2016$tempgrow),rev(tempgrow_seq*sd(poar_2015_2016$tempgrow)+ mean(poar_2015_2016$tempgrow) )),
            y=c(sex_diff_surv_95_tempgrow[i,,1],rev(sex_diff_surv_95_tempgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempgrow_seq *sd(poar_2015_2016$tempgrow)+ mean(poar_2015_2016$tempgrow),rev(tempgrow_seq*sd(poar_2015_2016$tempgrow)+ mean(poar_2015_2016$tempgrow) )),
            y=c(sex_diff_surv_75_tempgrow[i,,1],rev(sex_diff_surv_75_tempgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempgrow_seq*sd(poar_2015_2016$tempgrow)+ mean(poar_2015_2016$tempgrow),rev(tempgrow_seq*sd(poar_2015_2016$tempgrow)+ mean(poar_2015_2016$tempgrow))),
            y=c(sex_diff_surv_50_tempgrow[i,,1],rev(sex_diff_surv_50_tempgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempgrow_seq*sd(poar_2015_2016$tempgrow)+ mean(poar_2015_2016$tempgrow) ,rev(tempgrow_seq*sd(poar_2015_2016$tempgrow)+ mean(poar_2015_2016$tempgrow))),
            y=c(sex_diff_surv_25_tempgrow[i,,1],rev(sex_diff_surv_25_tempgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    lines(tempgrow_seq*sd(poar_2015_2016$tempgrow)+ mean(poar_2015_2016$tempgrow) ,sex_diff_surv_mean_tempgrow[i,],lwd=2,col="black")
    abline(h=0,lty=2)
    mtext("0",side=2,at=0)
  }
})

with(poar_surv_binned,{
  for(i in 1:size_bin_num){
    par(mar=c(0,4,2,0))
    plot(pptdorm[size_bin==i]*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),mean_surv[size_bin==i],type="n",ylim=c(0,1),
         xlab=" ",ylab=" ",xaxt="n");box()
     mylabel3 <- paste(graph[[3]])
     mtext(mylabel3,side = 3, adj = 0,cex=1.5)
    for(s in 1:2){
      points(pptdorm[Sex==s & size_bin==i]*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),mean_surv[Sex==s & size_bin==i],
             bg=sex_cols[s],pch=21,cex=5*(bin_n/max(bin_n)),lwd=2)
      lines(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),invlogit(mean(surv_coef$b0_s) + 
                         mean(surv_coef$bsize_s) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i]+
                         mean(surv_coef$bsizesex_s) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i] * (s-1) +
                         mean(surv_coef$bsex_s) * (s-1) +
                         mean(surv_coef$bpptgrow_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] +
                         mean(surv_coef$bpptdorm_s) *  pptdorm_seq +
                         mean(surv_coef$btempgrow_s) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                         mean(surv_coef$btempdorm_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] +
                         mean(surv_coef$bpptgrowsex_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * (s-1) +
                         mean(surv_coef$bpptdormsex_s) * pptdorm_seq * (s-1) +
                         mean(surv_coef$btempgrowsex_s) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * (s-1) +
                        mean(surv_coef$btempdormsex_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * (s-1) +
                         mean(surv_coef$btempdormpptdorm_s) * pptdorm_seq * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] +
                         mean(surv_coef$btempgrowpptgrow_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                         mean(surv_coef$btempdormpptdormsex_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * pptdorm_seq * (s-1) +
                         mean(surv_coef$btempgrowpptgrowsex_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * (s-1) +
                         mean(surv_coef$bpptgrow2_s) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 +
                         mean(surv_coef$bpptdorm2_s) * (pptdorm_seq^2) +
                         mean(surv_coef$btempgrow2_s) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 +
                         mean(surv_coef$btempdorm2_s) * (surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s])^2 +
                         mean(surv_coef$bpptgrow2sex_s) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 * (s-1) +
                         mean(surv_coef$bpptdorm2sex_s) * (pptdorm_seq^2) * (s-1) +
                         mean(surv_coef$btempgrow2sex_s) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 * (s-1) +
                         mean(surv_coef$btempdorm2sex_s) * (surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s])^2 * (s-1)
    ),lty=sex_lty[s],lwd=3,col= sex_cols[s])
    }
    par(mar=c(2,4,0.5,0))
    plot(pptdorm_seq *sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),sex_diff_surv_mean_pptdorm[i,],type="n",lwd=4,yaxt="n",
         xlab=" ",ylab=" ",xaxt="n",ylim=c(min(sex_diff_surv_95_pptdorm[i,,1]),max(sex_diff_surv_95_pptdorm[i,,2])))
    # if(i==1){mtext(expression(paste(Delta," (F-M)")),side=2,line=2,cex=1.3)}
    polygon(x=c(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),rev(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) )),
            y=c(sex_diff_surv_95_pptdorm[i,,1],rev(sex_diff_surv_95_pptdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) ,rev(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) )),
            y=c(sex_diff_surv_75_pptdorm[i,,1],rev(sex_diff_surv_75_pptdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),rev(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm))),
            y=c(sex_diff_surv_50_pptdorm[i,,1],rev(sex_diff_surv_50_pptdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) ,rev(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm))),
            y=c(sex_diff_surv_25_pptdorm[i,,1],rev(sex_diff_surv_25_pptdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    lines(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) ,sex_diff_surv_mean_pptdorm[i,],lwd=2,col="black")
    abline(h=0,lty=2)
    mtext("0",side=2,at=0)
  }
})

with(poar_surv_binned,{
  for(i in 1:size_bin_num){
    par(mar=c(0,4,2,0))
    plot(tempdorm[size_bin==i]*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),mean_surv[size_bin==i],type="n",ylim=c(0,1),
         xlab=" ",ylab=" ",xaxt="n");box()
     mylabel3 <- paste(graph[[4]])
     mtext(mylabel3,side = 3, adj = 0,cex=1.5)
    for(s in 1:2){
      points(tempdorm[Sex==s & size_bin==i]*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),mean_surv[Sex==s & size_bin==i],
             bg=sex_cols[s],pch=21,cex=5*(bin_n/max(bin_n)),lwd=2)
      lines(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),invlogit(mean(surv_coef$b0_s) + 
                         mean(surv_coef$bsize_s) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i] +
                         mean(surv_coef$bsizesex_s) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i] * (s-1) +
                         mean(surv_coef$bsex_s) * (s-1) +
                         mean(surv_coef$bpptgrow_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] +
                         mean(surv_coef$bpptdorm_s) *  surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] +
                         mean(surv_coef$btempgrow_s) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                         mean(surv_coef$btempdorm_s) * tempdorm_seq +
                         mean(surv_coef$bpptgrowsex_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * (s-1) +
                         mean(surv_coef$bpptdormsex_s) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] * (s-1) +
                         mean(surv_coef$btempgrowsex_s) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * (s-1) +
                        mean(surv_coef$btempdormsex_s) * tempdorm_seq * (s-1) +
                         mean(surv_coef$btempdormpptdorm_s) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] +
                         mean(surv_coef$btempgrowpptgrow_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                         mean(surv_coef$btempdormpptdormsex_s) * tempdorm_seq * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] * (s-1) +
                         mean(surv_coef$btempgrowpptgrowsex_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * (s-1) +
                         mean(surv_coef$bpptgrow2_s) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 +
                         mean(surv_coef$bpptdorm2_s) * (surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s])^2 +
                         mean(surv_coef$btempgrow2_s) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 +
                         mean(surv_coef$btempdorm2_s) * (tempdorm_seq^2) +
                         mean(surv_coef$bpptgrow2sex_s) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 * (s-1) +
                        mean(surv_coef$bpptdorm2sex_s) * (surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s])^2 * (s-1) +
                        mean(surv_coef$btempgrow2sex_s) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 * (s-1) +
                        mean(surv_coef$btempdorm2sex_s) * (tempdorm_seq^2) * (s-1)
    ),lty=sex_lty[s],lwd=3,col= sex_cols[s])
    }
    par(mar=c(2,4,0.5,0))
    plot(tempdorm_seq *sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),sex_diff_surv_mean_tempdorm[i,],type="n",lwd=4,yaxt="n",
         xlab=" ",ylab=" ",xaxt="n",ylim=c(min(sex_diff_surv_95_tempdorm[i,,1]),max(sex_diff_surv_95_tempdorm[i,,2])))
    # if(i==1){mtext(expression(paste(Delta," (F-M)")),side=2,line=2,cex=1.3)}
    polygon(x=c(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),rev(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm) )),
            y=c(sex_diff_surv_95_tempdorm[i,,1],rev(sex_diff_surv_95_tempdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm) ,rev(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm) )),
            y=c(sex_diff_surv_75_tempdorm[i,,1],rev(sex_diff_surv_75_tempdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),rev(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm))),
            y=c(sex_diff_surv_50_tempdorm[i,,1],rev(sex_diff_surv_50_tempdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm) ,rev(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm))),
            y=c(sex_diff_surv_25_tempdorm[i,,1],rev(sex_diff_surv_25_tempdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    lines(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm) ,sex_diff_surv_mean_tempdorm[i,],lwd=2,col="black")
    abline(h=0,lty=2)
    mtext("0",side=2,at=0)
  }
})

with(poar_grow_binned,{
  for(i in 1:size_bin_num){
    par(mar=c(0,4,1,0))
    plot(pptgrow[size_bin==i]*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),mean_grow[size_bin==i],type="n",
         xlab=" ",ylab=" ",xaxt="n",ylim=c(0,50));box()    
    if(i==1){mtext("#tillers",side=2,line=3,cex=1.5)}
    mylabel3 <- paste(graph[[5]])
    mtext(mylabel3,side = 3, adj = 0,cex=1.5)
    for(s in 1:2){
      points(pptgrow[Sex==s & size_bin==i]*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) ,mean_grow[Sex==s & size_bin==i],
             bg=sex_cols[s],pch=21,cex=5*(bin_n/max(bin_n)),lwd=2,ylim=c(0,50))
      lines(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) ,
            exp(mean(grow_coef$b0_g) + 
                         mean(grow_coef$bsize_g) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i]+
                         mean(grow_coef$bsizesex_g) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i] * (s-1) +
                         mean(grow_coef$bsex_g) * (s-1) +
                         mean(grow_coef$bpptgrow_g) * pptgrow_seq +
                         mean(grow_coef$bpptdorm_g) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s]  +
                         mean(grow_coef$btempgrow_g) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                         mean(grow_coef$btempdorm_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] +
                         mean(grow_coef$bpptgrowsex_g) * pptgrow_seq * (s-1) +
                         mean(grow_coef$bpptdormsex_g) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s]  * (s-1) +
                         mean(grow_coef$btempgrowsex_g) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] * (s-1) +
                        mean(grow_coef$btempdormsex_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * (s-1) +
                         mean(grow_coef$btempdormpptdorm_g) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] +
                         mean(grow_coef$btempgrowpptgrow_g) * pptgrow_seq * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                         mean(grow_coef$btempdormpptdormsex_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] * (s-1) +
                         mean(grow_coef$btempgrowpptgrowsex_g) * pptgrow_seq * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s]  * (s-1) +
                         mean(grow_coef$bpptgrow2_g) * (pptgrow_seq^2) +
                         mean(grow_coef$bpptdorm2_g) * (grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s])^2 +
                         mean(grow_coef$btempgrow2_g) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 +
                         mean(grow_coef$btempdorm2_g) * (grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s])^2 +
                         mean(grow_coef$bpptgrow2sex_g) * (pptgrow_seq^2) * (s-1) +
                         mean(grow_coef$bpptdorm2sex_g) * (grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s])^2 * (s-1) +
                         mean(grow_coef$btempgrow2sex_g) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 * (s-1) +
                         mean(grow_coef$btempdorm2sex_g) * (grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s])^2 * (s-1)
    
    ),lty=sex_lty[s],lwd=3,col= sex_cols[s])
    }
    par(mar=c(2,4,0.5,0))
    plot(pptgrow_seq *sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),sex_diff_grow_mean_pptgrow[i,],type="n",lwd=4,yaxt="n",
         xlab=" ",ylab=" ",xaxt="n",ylim=c(min(sex_diff_grow_95_pptgrow[i,,1]),max(sex_diff_grow_95_pptgrow[i,,2])))
    if(i==1){mtext(expression(paste(Delta," (F-M)")),side=2,line=2,cex=1.3)}
    polygon(x=c(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),rev(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) )),
            y=c(sex_diff_grow_95_pptgrow[i,,1],rev(sex_diff_grow_95_pptgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) ,rev(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow))),
            y=c(sex_diff_grow_75_pptgrow[i,,1],rev(sex_diff_grow_75_pptgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) ,rev(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) )),
            y=c(sex_diff_grow_50_pptgrow[i,,1],rev(sex_diff_grow_50_pptgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) ,rev(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow))),
            y=c(sex_diff_grow_25_pptgrow[i,,1],rev(sex_diff_grow_25_pptgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    lines(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) ,sex_diff_grow_mean_pptgrow[i,],lwd=2,col="black")
    abline(h=0,lty=2)
    mtext("0",side=2,at=0)
  }
})

with(poar_grow_binned,{
  for(i in 1:size_bin_num){
    par(mar=c(0,4,1,0))
    plot(tempgrow[size_bin==i]*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow),mean_grow[size_bin==i],type="n",
         xlab=" ",ylab=" ",xaxt="n",ylim=c(0,50));box()    
     mylabel3 <- paste(graph[[6]])
     mtext(mylabel3,side = 3, adj = 0,cex=1.5)    
    for(s in 1:2){
      points(tempgrow[Sex==s & size_bin==i]*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow),mean_grow[Sex==s & size_bin==i],
             bg=sex_cols[s],pch=21,cex=5*(bin_n/max(bin_n)),lwd=2)
      lines(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow) ,
            exp(mean(grow_coef$b0_g) +
                        mean(grow_coef$bsize_g) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i] +
                        mean(grow_coef$bsizesex_g) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i] * (s-1) +
                        mean(grow_coef$bsex_g) * (s-1) +
                        mean(grow_coef$bpptgrow_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s]  +
                        mean(grow_coef$bpptdorm_g) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s]  +
                        mean(grow_coef$btempgrow_g) * tempgrow_seq +
                        mean(grow_coef$btempdorm_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] +
                        mean(grow_coef$bpptgrowsex_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * (s-1) +
                        mean(grow_coef$bpptdormsex_g) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s]  * (s-1) +
                        mean(grow_coef$btempdormpptdorm_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] +
                        mean(grow_coef$btempgrowpptgrow_g) * tempgrow_seq * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] +
                        mean(grow_coef$btempgrowsex_g) * tempgrow_seq * (s-1) +
                        mean(grow_coef$btempdormsex_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * (s-1) +
                        mean(grow_coef$btempdormpptdormsex_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] * (s-1) +
                        mean(grow_coef$btempgrowpptgrowsex_g) * tempgrow_seq * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s]  * (s-1) +
                        mean(grow_coef$bpptgrow2_g) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 +
                        mean(grow_coef$bpptdorm2_g) * (grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s])^2 +
                        mean(grow_coef$btempgrow2_g) * (tempgrow_seq^2) +
                        mean(grow_coef$btempdorm2_g) * (grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s])^2 +
                        mean(grow_coef$bpptgrow2sex_g) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 * (s-1) +
                        mean(grow_coef$bpptdorm2sex_g) * (grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s])^2 * (s-1) +
                        mean(grow_coef$btempgrow2sex_g) * (tempgrow_seq^2) * (s-1) +
                        mean(grow_coef$btempdorm2sex_g) * (grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s])^2 * (s-1)

    
    ),lty=sex_lty[s],lwd=3,col= sex_cols[s])
    }
    par(mar=c(2,4,0.5,0))
    plot(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow) ,sex_diff_grow_mean_tempgrow[i,],type="n",lwd=4,yaxt="n",
         xlab=" ",ylab=" ",xaxt="n",ylim=c(min(sex_diff_grow_95_tempgrow[i,,1]),max(sex_diff_grow_95_tempgrow[i,,2])))
    # if(i==1){mtext(expression(paste(Delta," (F-M)")),side=2,line=2,cex=1.3)}
    polygon(x=c(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow),rev(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow) )),
            y=c(sex_diff_grow_95_tempgrow[i,,1],rev(sex_diff_grow_95_tempgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow) ,rev(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow))),
            y=c(sex_diff_grow_75_tempgrow[i,,1],rev(sex_diff_grow_75_tempgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow) ,rev(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow) )),
            y=c(sex_diff_grow_50_tempgrow[i,,1],rev(sex_diff_grow_50_tempgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempgrow_seq *sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow),rev(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow))),
            y=c(sex_diff_grow_25_tempgrow[i,,1],rev(sex_diff_grow_25_tempgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    lines(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow) ,sex_diff_grow_mean_tempgrow[i,],lwd=2,col="black")
    abline(h=0,lty=2)
    mtext("0",side=2,at=0)
  }
})


with(poar_grow_binned,{
  for(i in 1:size_bin_num){
    par(mar=c(0,4,1,0))
    plot(pptdorm[size_bin==i]*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),mean_grow[size_bin==i],type="n",
         xlab=" ",ylab=" ",xaxt="n",ylim=c(0,50));box()    
    # if(i==1){mtext("#tillers",side=2,line=3,cex=1.3)}
    mylabel3 <- paste(graph[[7]])
    mtext(mylabel3,side = 3, adj = 0,cex=1.5)
    for(s in 1:2){
      points(pptdorm[Sex==s & size_bin==i]*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),mean_grow[Sex==s & size_bin==i],
             bg=sex_cols[s],pch=21,cex=5*(bin_n/max(bin_n)),lwd=2,ylim=c(0,50))
      lines(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) ,
            exp(mean(grow_coef$b0_g) + 
                         mean(grow_coef$bsize_g) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i]+
                         mean(grow_coef$bsizesex_g) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i] * (s-1) +
                         mean(grow_coef$bsex_g) * (s-1) +
                         mean(grow_coef$bpptgrow_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] +
                         mean(grow_coef$bpptdorm_g) *  pptdorm_seq +
                         mean(grow_coef$btempgrow_g) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                         mean(grow_coef$btempdorm_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] +
                         mean(grow_coef$bpptgrowsex_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * (s-1) +
                         mean(grow_coef$bpptdormsex_g) * pptdorm_seq * (s-1) +
                         mean(grow_coef$btempgrowsex_g) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] * (s-1) +
                        mean(grow_coef$btempdormsex_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * (s-1) +
                        mean (grow_coef$btempdormpptdorm_g) * pptdorm_seq * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] +
                        mean (grow_coef$btempgrowpptgrow_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                         mean(grow_coef$btempdormpptdormsex_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * pptdorm_seq * (s-1) +
                         mean(grow_coef$btempgrowpptgrowsex_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] * (s-1) +
                         mean(grow_coef$bpptgrow2_g) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 +
                         mean(grow_coef$bpptdorm2_g) * (pptdorm_seq^2) +
                         mean(grow_coef$btempgrow2_g) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 +
                        mean (grow_coef$btempdorm2_g) * (grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s])^2 +
                         mean(grow_coef$bpptgrow2sex_g) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 * (s-1) +
                         mean(grow_coef$bpptdorm2sex_g) * (pptdorm_seq^2) * (s-1) +
                         mean(grow_coef$btempgrow2sex_g) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 * (s-1) +
                         mean(grow_coef$btempdorm2sex_g) * (grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s])^2 * (s-1)
    ),lty=sex_lty[s],lwd=3,col= sex_cols[s])
    }
    par(mar=c(2,4,0.5,0))
    plot(pptdorm_seq *sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),sex_diff_grow_mean_pptdorm[i,],type="n",lwd=4,yaxt="n",
         xlab=" ",ylab=" ",xaxt="n",ylim=c(min(sex_diff_grow_95_pptdorm[i,,1]),max(sex_diff_grow_95_pptdorm[i,,2])))
    # if(i==1){mtext(expression(paste(Delta," (F-M)")),side=2,line=2,cex=1.3)}
    polygon(x=c(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),rev(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) )),
            y=c(sex_diff_grow_95_pptdorm[i,,1],rev(sex_diff_grow_95_pptdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) ,rev(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm))),
            y=c(sex_diff_grow_75_pptdorm[i,,1],rev(sex_diff_grow_75_pptdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) ,rev(pptdorm_seq *sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm))),
            y=c(sex_diff_grow_50_pptdorm[i,,1],rev(sex_diff_grow_50_pptdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) ,rev(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm))),
            y=c(sex_diff_grow_25_pptdorm[i,,1],rev(sex_diff_grow_25_pptdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    lines(pptdorm_seq *sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),sex_diff_grow_mean_pptdorm[i,],lwd=2,col="black")
    abline(h=0,lty=2)
    mtext("0",side=2,at=0)
  }
})

with(poar_grow_binned,{
  for(i in 1:size_bin_num){
    par(mar=c(0,4,1,0))
    plot(tempdorm[size_bin==i]*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),mean_grow[size_bin==i],type="n",
         xlab=" ",ylab=" ",xaxt="n",ylim=c(0,50));box()    
    # if(i==1){mtext("#tillers",side=2,line=3,cex=1.3)}
    mylabel3 <- paste(graph[[8]])
    mtext(mylabel3,side = 3, adj = 0,cex=1.5)   
    for(s in 1:2){
      points(tempdorm[Sex==s & size_bin==i]*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm) ,mean_grow[Sex==s & size_bin==i],
             bg=sex_cols[s],pch=21,cex=5*(bin_n/max(bin_n)),lwd=2,ylim=c(0,50))
      lines(tempdorm_seq *sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm) ,exp(mean(grow_coef$b0_g) + 
                         mean(grow_coef$bsize_g) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i] +
                         mean(grow_coef$bsizesex_g) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i] * (s-1) +
                         mean(grow_coef$bsex_g) * (s-1) +
                         mean(grow_coef$bpptgrow_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] +
                        mean(grow_coef$bpptdorm_g) *  grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] +
                         mean(grow_coef$btempgrow_g) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                         mean(grow_coef$btempdorm_g) * tempdorm_seq +
                         mean(grow_coef$bpptgrowsex_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * (s-1) +
                         mean(grow_coef$bpptdormsex_g) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] * (s-1) +
                         mean(grow_coef$btempgrowsex_g) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] * (s-1) +
                        mean(grow_coef$btempdormsex_g) * tempdorm_seq * (s-1) +
                         mean(grow_coef$btempdormpptdorm_g) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] +
                         mean(grow_coef$btempgrowpptgrow_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                         mean(grow_coef$btempdormpptdormsex_g) * tempdorm_seq * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] * (s-1) +
                         mean(grow_coef$btempgrowpptgrowsex_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] * (s-1) +
                         mean(grow_coef$bpptgrow2_g) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 +
                         mean(grow_coef$bpptdorm2_g) * (grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s])^2 +
                         mean(grow_coef$btempgrow2_g) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 +
                         mean(grow_coef$btempdorm2_g) * (tempdorm_seq^2) +
                         mean(grow_coef$bpptgrow2sex_g) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 * (s-1) +
                         mean(grow_coef$bpptdorm2sex_g) * (grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s])^2 * (s-1) +
                         mean(grow_coef$btempgrow2sex_g) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 * (s-1) +
                         mean(grow_coef$btempdorm2sex_g) * (tempdorm_seq^2) * (s-1)
    )
            ,lty=sex_lty[s],lwd=3,col= sex_cols[s])
    }
    par(mar=c(2,4,0.5,0))
    plot(tempdorm_seq *sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),sex_diff_grow_mean_tempdorm[i,],type="n",lwd=4,yaxt="n",
         xlab=" ",ylab=" ",xaxt="n",ylim=c(min(sex_diff_grow_95_tempdorm[i,,1]),max(sex_diff_grow_95_tempdorm[i,,2])))
    # if(i==1){mtext(expression(paste(Delta," (F-M)")),side=2,line=2,cex=1.3)}
    polygon(x=c(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),rev(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm) )),
            y=c(sex_diff_grow_95_tempdorm[i,,1],rev(sex_diff_grow_95_tempdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempdorm_seq *sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),rev(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm))),
            y=c(sex_diff_grow_75_tempdorm[i,,1],rev(sex_diff_grow_75_tempdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempdorm_seq *sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),rev(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm) )),
            y=c(sex_diff_grow_50_tempdorm[i,,1],rev(sex_diff_grow_50_tempdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm) ,rev(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm))),
            y=c(sex_diff_grow_25_tempdorm[i,,1],rev(sex_diff_grow_25_tempdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    lines(tempdorm_seq *sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),sex_diff_grow_mean_tempdorm[i,],lwd=2,col="black")
    abline(h=0,lty=2)
    mtext("0",side=2,at=0)
  }
})

with(poar_flow_binned,{
  for(i in 1:size_bin_num){
    par(mar=c(0,4,1,0))
    plot(pptgrow[size_bin==i]*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),mean_flow[size_bin==i],type="n",
         xlab=" ",ylab=" ",xaxt="n");box()
    if(i==1){mtext("Pr(flowering)",side=2,line=3,cex=1.5)}
    mylabel3 <- paste(graph[[9]])
    mtext(mylabel3,side = 3, adj = 0,cex=1.5)
    for(s in 1:2){
      points(pptgrow[Sex==s & size_bin==i]*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),mean_flow[Sex==s & size_bin==i],
             bg=sex_cols[s],pch=21,cex=5*(bin_n/max(bin_n)),lwd=2)
      lines(pptgrow_seq *sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) ,invlogit(mean(flow_coef$b0_f) + 
                         mean(flow_coef$bsize_f) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i]+
                         mean(flow_coef$bsizesex_f) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i] * (s-1) +
                         mean(flow_coef$bsex_f) * (s-1) +
                         mean(flow_coef$bpptgrow_f) * pptgrow_seq +
                         mean(flow_coef$bpptdorm_f) * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s]  +
                         mean(flow_coef$btempgrow_f) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                         mean(flow_coef$btempdorm_f) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] +
                         mean(flow_coef$bpptgrowsex_f) * pptgrow_seq * (s-1) +
                         mean(flow_coef$bpptdormsex_f) * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s]  * (s-1) +
                         mean(flow_coef$btempgrowsex_f) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] * (s-1) +
                        mean(flow_coef$btempdormsex_f) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * (s-1) +
                         mean(flow_coef$btempdormpptdorm_f) * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s] * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] +
                         mean(flow_coef$btempgrowpptgrow_f) * pptgrow_seq * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                         mean(flow_coef$btempdormpptdormsex_f) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s] * (s-1) +
                         mean(flow_coef$btempgrowpptgrowsex_f) * pptgrow_seq * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s]  * (s-1) +
                         mean(flow_coef$bpptgrow2_f) * (pptgrow_seq^2) +
                         mean(flow_coef$bpptdorm2_f) * (flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s])^2 +
                         mean(flow_coef$btempgrow2_f) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 +
                         mean(flow_coef$btempdorm2_f) * (flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s])^2 +
                         mean(flow_coef$bpptgrow2sex_f) * (pptgrow_seq^2) * (s-1) +
                         mean(flow_coef$bpptdorm2sex_f) * (flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s])^2 * (s-1) +
                         mean(flow_coef$btempgrow2sex_f) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 * (s-1) +
                         mean(flow_coef$btempdorm2sex_f) * (flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s])^2 * (s-1)
    
    )
    
            ,lty=sex_lty[s],lwd=3,col= sex_cols[s])
    }
    par(mar=c(2,4,0.5,0))
    plot(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) ,sex_diff_flow_mean_pptgrow[i,],type="n",lwd=4,yaxt="n",
         xlab=" ",ylab=" ",xaxt="n",ylim=c(min(sex_diff_flow_95_pptgrow[i,,1]),max(sex_diff_flow_95_pptgrow[i,,2])))
    if(i==1){mtext(expression(paste(Delta," (F-M)")),side=2,line=2,cex=1.3)}
    polygon(x=c(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) ,rev(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) )),
            y=c(sex_diff_flow_95_pptgrow[i,,1],rev(sex_diff_flow_95_pptgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptgrow_seq *sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),rev(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) )),
            y=c(sex_diff_flow_75_pptgrow[i,,1],rev(sex_diff_flow_75_pptgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) ,rev(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow))),
            y=c(sex_diff_flow_50_pptgrow[i,,1],rev(sex_diff_flow_50_pptgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) ,rev(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow))),
            y=c(sex_diff_flow_25_pptgrow[i,,1],rev(sex_diff_flow_25_pptgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    lines(pptgrow_seq *sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),sex_diff_flow_mean_pptgrow[i,],lwd=2,col="black")
    abline(h=0,lty=2)
    mtext("0",side=2,at=0)
  }
})

with(poar_flow_binned,{
  for(i in 1:size_bin_num){
    par(mar=c(0,4,1,0))
    plot(tempgrow[size_bin==i]*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow) ,mean_flow[size_bin==i],type="n",
         xlab=" ",ylab=" ",xaxt="n");box()
    mylabel3 <- paste(graph[[10]])
    mtext(mylabel3,side = 3, adj = 0,cex=1.5)
    for(s in 1:2){
      points(tempgrow[Sex==s & size_bin==i]*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow),mean_flow[Sex==s & size_bin==i],
             bg=sex_cols[s],pch=21,cex=5*(bin_n/max(bin_n)),lwd=2)
      lines(tempgrow_seq *sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow),invlogit(mean(flow_coef$b0_f) +
                        mean(flow_coef$bsize_f) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i] +
                        mean(flow_coef$bsizesex_f) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i] * (s-1) +
                        mean(flow_coef$bsex_f) * (s-1) +
                        mean(flow_coef$bpptgrow_f) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s]  +
                        mean(flow_coef$bpptdorm_f) * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s]  +
                        mean(flow_coef$btempgrow_f) * tempgrow_seq +
                        mean(flow_coef$btempdorm_f) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] +
                        mean(flow_coef$bpptgrowsex_f) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] * (s-1) +
                        mean(flow_coef$bpptdormsex_f) * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s]  * (s-1) +
                        mean(flow_coef$btempgrowsex_f) * tempgrow_seq * (s-1) +
                        mean(flow_coef$btempdormsex_f) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * (s-1) +
                        mean(flow_coef$btempdormpptdorm_f) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s]  +
                        mean(flow_coef$btempgrowpptgrow_f) * tempgrow_seq * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s]   +
                        mean(flow_coef$btempdormpptdormsex_f) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s] * (s-1) +
                        mean(flow_coef$btempgrowpptgrowsex_f) * tempgrow_seq * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s]  * (s-1) +
                        mean(flow_coef$bpptgrow2_f) * (flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s])^2 +
                        mean(flow_coef$bpptdorm2_f) * (flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s])^2 +
                        mean(flow_coef$btempgrow2_f) * (tempgrow_seq^2) +
                        mean(flow_coef$btempdorm2_f) * (flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s])^2 +
                        mean(flow_coef$bpptgrow2sex_f) * (flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s])^2 * (s-1) +
                        mean(flow_coef$bpptdorm2sex_f) * (flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s])^2 * (s-1) +
                        mean(flow_coef$btempgrow2sex_f) * (tempgrow_seq^2) * (s-1) +
                        mean(flow_coef$btempdorm2sex_f) * (flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s])^2 * (s-1)
    ) ,lty=sex_lty[s],lwd=3,col= sex_cols[s])
    }
    par(mar=c(2,4,0.5,0))
    plot(tempgrow_seq *sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow),sex_diff_flow_mean_tempgrow[i,],type="n",lwd=4,yaxt="n",
         xlab=" ",ylab=" ",xaxt="n",ylim=c(min(sex_diff_flow_95_tempgrow[i,,1]),max(sex_diff_flow_95_tempgrow[i,,2])))
    # if(i==1){mtext(expression(paste(Delta," (F-M)")),side=2,line=2,cex=1.3)}
    polygon(x=c(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow) ,rev(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow)  )),
            y=c(sex_diff_flow_95_tempgrow[i,,1],rev(sex_diff_flow_95_tempgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow) ,rev(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow) )),
            y=c(sex_diff_flow_75_tempgrow[i,,1],rev(sex_diff_flow_75_tempgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow) ,rev(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow) )),
            y=c(sex_diff_flow_50_tempgrow[i,,1],rev(sex_diff_flow_50_tempgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow) ,rev(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow) )),
            y=c(sex_diff_flow_25_tempgrow[i,,1],rev(sex_diff_flow_25_tempgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    lines(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow) ,sex_diff_flow_mean_tempgrow[i,],lwd=2,col="black")
    abline(h=0,lty=2)
    mtext("0",side=2,at=0)
  }
})

with(poar_flow_binned,{
  for(i in 1:size_bin_num){
    par(mar=c(0,4,1,0))
    plot(pptdorm[size_bin==i]*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) ,mean_flow[size_bin==i],type="n",
         xlab=" ",ylab=" ",xaxt="n");box()
     mylabel3 <- paste(graph[[11]])
     mtext(mylabel3,side = 3, adj = 0,cex=1.5)  
    for(s in 1:2){
      points(pptdorm[Sex==s & size_bin==i]*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),mean_flow[Sex==s & size_bin==i],
             bg=sex_cols[s],pch=21,cex=5*(bin_n/max(bin_n)),lwd=2)
      lines(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm), invlogit(mean(flow_coef$b0_f) + 
                         mean(flow_coef$bsize_f) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i]+
                         mean(flow_coef$bsizesex_f) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i] * (s-1) +
                         mean(flow_coef$bsex_f) * (s-1) +
                         mean(flow_coef$bpptgrow_f) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] +
                         mean(flow_coef$bpptdorm_f) *  pptdorm_seq +
                         mean(flow_coef$btempgrow_f) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                         mean(flow_coef$btempdorm_f) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] +
                         mean(flow_coef$bpptgrowsex_f) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] * (s-1) +
                         mean(flow_coef$bpptdormsex_f) * pptdorm_seq * (s-1) +
                        mean (flow_coef$btempgrowsex_f) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] * (s-1) +
                        mean(flow_coef$btempdormsex_f) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * (s-1) +
                        mean (flow_coef$btempdormpptdorm_f) * pptdorm_seq * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] +
                         mean(flow_coef$btempgrowpptgrow_f) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                         mean(flow_coef$btempdormpptdormsex_f) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * pptdorm_seq * (s-1) +
                        mean (flow_coef$btempgrowpptgrowsex_f) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] * (s-1) +
                         mean(flow_coef$bpptgrow2_f) * (flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s])^2 +
                         mean(flow_coef$bpptdorm2_f) * (pptdorm_seq^2) +
                         mean(flow_coef$btempgrow2_f) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 +
                        mean (flow_coef$btempdorm2_f) * (flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s])^2 +
                         mean(flow_coef$bpptgrow2sex_f) * (flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s])^2 * (s-1) +
                         mean(flow_coef$bpptdorm2sex_f) * (pptdorm_seq^2) * (s-1) +
                        mean (flow_coef$btempgrow2sex_f) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 * (s-1) +
                        mean (flow_coef$btempdorm2sex_f) * (flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s])^2 * (s-1)
    )
  
    
            ,lty=sex_lty[s],lwd=3,col= sex_cols[s])
    }
    par(mar=c(2,4,0.5,0))
    plot(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) ,sex_diff_flow_mean_pptdorm[i,],type="n",lwd=4,yaxt="n",
         xlab=" ",ylab=" ",xaxt="n",ylim=c(min(sex_diff_flow_95_pptdorm[i,,1]),max(sex_diff_flow_95_pptdorm[i,,2])))
    # if(i==1){mtext(expression(paste(Delta," (F-M)")),side=2,line=2,cex=1.3)}
    polygon(x=c(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) ,rev(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) )),
            y=c(sex_diff_flow_95_pptdorm[i,,1],rev(sex_diff_flow_95_pptdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) ,rev(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) )),
            y=c(sex_diff_flow_75_pptdorm[i,,1],rev(sex_diff_flow_75_pptdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptdorm_seq *sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),rev(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm))),
            y=c(sex_diff_flow_50_pptdorm[i,,1],rev(sex_diff_flow_50_pptdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) ,rev(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm))),
            y=c(sex_diff_flow_25_pptdorm[i,,1],rev(sex_diff_flow_25_pptdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    lines(pptdorm_seq *sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),sex_diff_flow_mean_pptdorm[i,],lwd=2,col="black")
    abline(h=0,lty=2)
    mtext("0",side=2,at=0)
  }
})

with(poar_flow_binned,{
  for(i in 1:size_bin_num){
    par(mar=c(0,4,1,0))
    plot(tempdorm[size_bin==i]*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm) ,mean_flow[size_bin==i],type="n",
         xlab=" ",ylab=" ",xaxt="n");box()
    # if(i==1){mtext("Pr(flowering)",side=2,line=3,cex=1.3)}
     mylabel3 <- paste(graph[[12]])
    mtext(mylabel3,side = 3, adj = 0,cex=1.5)    
    for(s in 1:2){
      points(tempdorm[Sex==s & size_bin==i]*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),mean_flow[Sex==s & size_bin==i],
             bg=sex_cols[s],pch=21,cex=5*(bin_n/max(bin_n)),lwd=2)
      lines(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm), invlogit(mean(flow_coef$b0_f) + 
                         mean(flow_coef$bsize_f) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i] +
                         mean(flow_coef$bsizesex_f) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i] * (s-1) +
                         mean(flow_coef$bsex_f) * (s-1) +
                         mean(flow_coef$bpptgrow_f) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] +
                         mean(flow_coef$bpptdorm_f) *  flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s] +
                         mean(flow_coef$btempgrow_f) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                         mean(flow_coef$btempdorm_f) * tempdorm_seq +
                         mean(flow_coef$bpptgrowsex_f) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] * (s-1) +
                         mean(flow_coef$bpptdormsex_f) * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s] * (s-1) +
                        mean (flow_coef$btempgrowsex_f) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] * (s-1) +
                        mean(flow_coef$btempdormsex_f) * tempdorm_seq * (s-1) +
                        mean (flow_coef$btempdormpptdorm_f) * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s] * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] +
                         mean(flow_coef$btempgrowpptgrow_f) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                        mean (flow_coef$btempdormpptdormsex_f) * tempdorm_seq * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s] * (s-1) +
                        mean (flow_coef$btempgrowpptgrowsex_f) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] * (s-1) +
                        mean (flow_coef$bpptgrow2_f) * (flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s])^2 +
                        mean (flow_coef$bpptdorm2_f) * (flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s])^2 +
                        mean (flow_coef$btempgrow2_f) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 +
                        mean (flow_coef$btempdorm2_f) * (tempdorm_seq^2) +
                        mean (flow_coef$bpptgrow2sex_f) * (flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s])^2 * (s-1) +
                        mean (flow_coef$bpptdorm2sex_f) * (flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s])^2 * (s-1) +
                        mean (flow_coef$btempgrow2sex_f) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 * (s-1) +
                        mean (flow_coef$btempdorm2sex_f) * (tempdorm_seq^2) * (s-1)
    )
  
    
            ,lty=sex_lty[s],lwd=3,col= sex_cols[s])
    }
    par(mar=c(2,4,0.5,0))
    plot(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm) ,sex_diff_flow_mean_tempdorm[i,],type="n",lwd=4,yaxt="n",
         xlab=" ",ylab=" ",xaxt="n",ylim=c(min(sex_diff_flow_95_tempdorm[i,,1]),max(sex_diff_flow_95_tempdorm[i,,2])))
    # if(i==1){mtext(expression(paste(Delta," (F-M)")),side=2,line=2,cex=1.3)}
    polygon(x=c(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm) ,rev(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm) )),
            y=c(sex_diff_flow_95_tempdorm[i,,1],rev(sex_diff_flow_95_tempdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm) ,rev(tempdorm_seq *sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm))),
            y=c(sex_diff_flow_75_tempdorm[i,,1],rev(sex_diff_flow_75_tempdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm) ,rev(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm))),
            y=c(sex_diff_flow_50_tempdorm[i,,1],rev(sex_diff_flow_50_tempdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm) ,rev(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm))),
            y=c(sex_diff_flow_25_tempdorm[i,,1],rev(sex_diff_flow_25_tempdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    lines(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm) ,sex_diff_flow_mean_tempdorm[i,],lwd=2,col="black")
    abline(h=0,lty=2)
    mtext("0",side=2,at=0)
  }
})

with(poar_panic_binned,{
  for(i in 1:size_bin_num){
    par(mar=c(0,4,1,0))
    plot(pptgrow[size_bin==i]*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) ,mean_panic[size_bin==i],type="n",
         xlab=" ",ylab=" ",xaxt="n",ylim=c(0,15));box()    
    if(i==1){mtext("#panicles",side=2,line=3,cex=1.5)}
    mylabel3 <- paste(graph[[13]])
    mtext(mylabel3,side = 3, adj = 0,cex=1.75)    
    for(s in 1:2){
      points(pptgrow[Sex==s & size_bin==i]*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),mean_panic[Sex==s & size_bin==i],
             bg=sex_cols[s],pch=21,cex=7*(bin_n/max(bin_n)),lwd=2,ylim=c(0,12))
      lines(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow), exp(mean(panic_coef$b0_p) + 
                         mean(panic_coef$bsize_p) * panic_mean_sizes$size[panic_mean_sizes$Sex==s & panic_mean_sizes$size_bin==i]+
                         mean(panic_coef$bsizesex_p) * panic_mean_sizes$size[panic_mean_sizes$Sex==s & panic_mean_sizes$size_bin==i] * (s-1) +
                         mean(panic_coef$bsex_p) * (s-1) +
                         mean(panic_coef$bpptgrow_p) * pptgrow_seq +
                         mean(panic_coef$bpptdorm_p) * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s]  +
                         mean(panic_coef$btempgrow_p) * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] +
                         mean(panic_coef$btempdorm_p) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] +
                         mean(panic_coef$bpptgrowsex_p) * pptgrow_seq * (s-1) +
                         mean(panic_coef$bpptdormsex_p) * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s]  * (s-1) +
                         mean(panic_coef$btempgrowsex_p) * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] * (s-1) +
                        mean(panic_coef$btempdormsex_p) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * (s-1) +
                         mean(panic_coef$btempdormpptdorm_p) * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s] * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] +
                         mean(panic_coef$btempgrowpptgrow_p) * pptgrow_seq * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] +
                         mean(panic_coef$btempdormpptdormsex_p) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s] * (s-1) +
                         mean(panic_coef$btempgrowpptgrowsex_p) * pptgrow_seq * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s]  * (s-1) +
                         mean(panic_coef$bpptgrow2_p) * (pptgrow_seq^2) +
                         mean(panic_coef$bpptdorm2_p) * (panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s])^2 +
                         mean(panic_coef$btempgrow2_p) * (panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s])^2 +
                         mean(panic_coef$btempdorm2_p) * (panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s])^2 +
                         mean(panic_coef$bpptgrow2sex_p) * (pptgrow_seq^2) * (s-1) +
                         mean(panic_coef$bpptdorm2sex_p) * (panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s])^2 * (s-1) +
                         mean(panic_coef$btempgrow2sex_p) * (panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s])^2 * (s-1) +
                         mean(panic_coef$btempdorm2sex_p) * (panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s])^2 * (s-1)
    
    )
    
            ,lty=sex_lty[s],lwd=3,col= sex_cols[s])
    }
    legend(900, 12, 
       legend=c( "Female","Male"),
       lty=c(1,1),
       # pt.cex=c(0.75,1.25,1),
       col =c("#D95F02", "#1B9E77"),
       cex = 1.2,
       bty = "n",
       lw=3,
       horiz = F ) 
    par(mar=c(2,4,0.5,0))
    plot(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) ,sex_diff_panic_mean_pptgrow[i,],type="n",lwd=4,yaxt="n",
         xlab=" ",ylab=" ",ylim=c(min(sex_diff_panic_95_pptgrow[i,,1]),max(sex_diff_panic_95_pptgrow[i,,2])))
    if(i==1){mtext(expression(paste(Delta," (F-M)")),side=2,line=2,cex=1.3)}
    mtext("Precipitation (grow. season)",side=1,line=3,cex=1.3)
    polygon(x=c(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) ,rev(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) )),
            y=c(sex_diff_panic_95_pptgrow[i,,1],rev(sex_diff_panic_95_pptgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) ,rev(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) )),
            y=c(sex_diff_panic_75_pptgrow[i,,1],rev(sex_diff_panic_75_pptgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) ,rev(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) )),
            y=c(sex_diff_panic_50_pptgrow[i,,1],rev(sex_diff_panic_50_pptgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) ,rev(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) )),
            y=c(sex_diff_panic_25_pptgrow[i,,1],rev(sex_diff_panic_25_pptgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    lines(pptgrow_seq *sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),sex_diff_panic_mean_pptgrow[i,],lwd=2,col="black")
    abline(h=0,lty=2)
    mtext("0",side=2,at=0)
  }
})

with(poar_panic_binned,{
  for(i in 1:size_bin_num){
    par(mar=c(0,4,1,0))
    plot(tempgrow[size_bin==i]* sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow),mean_panic[size_bin==i],type="n",
         xlab=" ",ylab=" ",xaxt="n",ylim=c(0,12));box()    
    # if(i==1){mtext("#panicles",side=2,line=3,cex=1.3)}
    mylabel3 <- paste(graph[[14]])
    mtext(mylabel3,side = 3, adj = 0,cex=1.5)    
    for(s in 1:2){
      points(tempgrow[Sex==s & size_bin==i]*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow),mean_panic[Sex==s & size_bin==i],
             bg=sex_cols[s],pch=21,cex=7*(bin_n/max(bin_n)),lwd=2)
      lines(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow), exp(mean(panic_coef$b0_p) +
                        mean(panic_coef$bsize_p) * panic_mean_sizes$size[panic_mean_sizes$Sex==s & panic_mean_sizes$size_bin==i] +
                        mean(panic_coef$bsizesex_p) * panic_mean_sizes$size[panic_mean_sizes$Sex==s & panic_mean_sizes$size_bin==i] * (s-1) +
                        mean(panic_coef$bsex_p) * (s-1) +
                        mean(panic_coef$bpptgrow_p) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s]  +
                        mean(panic_coef$bpptdorm_p) * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s]  +
                        mean(panic_coef$btempgrow_p) * tempgrow_seq +
                        mean(panic_coef$btempdorm_p) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] +
                        mean(panic_coef$bpptgrowsex_p) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s] * (s-1) +
                        mean(panic_coef$bpptdormsex_p) * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s]  * (s-1) +
                        mean(panic_coef$btempgrowsex_p) * tempgrow_seq * (s-1) +
                        mean(panic_coef$btempdormsex_p) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * (s-1) +
                        mean(panic_coef$btempdormpptdorm_p) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s]  +
                        mean(panic_coef$btempgrowpptgrow_p) * tempgrow_seq * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s]   +
                        mean(panic_coef$btempdormpptdormsex_p) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s] * (s-1) +
                        mean(panic_coef$btempgrowpptgrowsex_p) * tempgrow_seq * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s]  * (s-1) +
                        mean(panic_coef$bpptgrow2_p) * (panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s])^2 +
                        mean(panic_coef$bpptdorm2_p) * (panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s])^2 +
                        mean(panic_coef$btempgrow2_p) * (tempgrow_seq^2) +
                        mean(panic_coef$btempdorm2_p) * (panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s])^2 +
                        mean(panic_coef$bpptgrow2sex_p) * (panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s])^2 * (s-1) +
                        mean(panic_coef$bpptdorm2sex_p) * (panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s])^2 * (s-1) +
                        mean(panic_coef$btempgrow2sex_p) * (tempgrow_seq^2) * (s-1) +
                        mean(panic_coef$btempdorm2sex_p) * (panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s])^2 * (s-1)
    
    ) ,lty=sex_lty[s],lwd=3,col= sex_cols[s])
    }
    par(mar=c(2,4,0.5,0))
    plot(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow) ,sex_diff_panic_mean_tempgrow[i,],type="n",lwd=4,yaxt="n",
         xlab=" ",ylab=" ",ylim=c(min(sex_diff_panic_95_tempgrow[i,,1]),max(sex_diff_panic_95_tempgrow[i,,2])))
    # if(i==1){mtext(expression(paste(Delta," (F-M)")),side=2,line=2,cex=1.3)}
    mtext("Temperature (grow. season)",side=1,line=3,cex=1.3)
    polygon(x=c(tempgrow_seq *sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow),rev(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow) )),
            y=c(sex_diff_panic_95_tempgrow[i,,1],rev(sex_diff_panic_95_tempgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempgrow_seq *sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow),rev(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow) )),
            y=c(sex_diff_panic_75_tempgrow[i,,1],rev(sex_diff_panic_75_tempgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempgrow_seq *sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow),rev(tempgrow_seq * sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow) )),
            y=c(sex_diff_panic_50_tempgrow[i,,1],rev(sex_diff_panic_50_tempgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempgrow_seq *sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow),rev(tempgrow_seq* sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow) )),
            y=c(sex_diff_panic_25_tempgrow[i,,1],rev(sex_diff_panic_25_tempgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    lines(tempgrow_seq *sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow),sex_diff_panic_mean_tempgrow[i,],lwd=2,col="black")
    abline(h=0,lty=2)
    mtext("0",side=2,at=0)
  }
})

with(poar_panic_binned,{
  for(i in 1:size_bin_num){
    par(mar=c(0,4,1,0))
    plot(pptdorm[size_bin==i]*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),mean_panic[size_bin==i],type="n",
         xlab=" ",ylab=" ",xaxt="n",ylim=c(0,12));box()    
    # if(i==1){mtext("#panicles",side=2,line=3,cex=1.3)}
     mylabel3 <- paste(graph[[15]])
     mtext(mylabel3,side = 3, adj = 0,cex=1.5)    
    for(s in 1:2){
      points(pptdorm[Sex==s & size_bin==i]*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),mean_panic[Sex==s & size_bin==i],
             bg=sex_cols[s],pch=21,cex=7*(bin_n/max(bin_n)),lwd=2)
      lines(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm), exp(mean(panic_coef$b0_p) + 
                         mean(panic_coef$bsize_p) * panic_mean_sizes$size[panic_mean_sizes$Sex==s & panic_mean_sizes$size_bin==i]+
                         mean(panic_coef$bsizesex_p) * panic_mean_sizes$size[panic_mean_sizes$Sex==s & panic_mean_sizes$size_bin==i] * (s-1) +
                         mean(panic_coef$bsex_p) * (s-1) +
                         mean(panic_coef$bpptdorm_p) * pptdorm_seq +
                         mean(panic_coef$bpptgrow_p) * panic_mean_pptgrow$pptgrow[panic_mean_pptdorm$Sex==s]  +
                         mean(panic_coef$btempgrow_p) * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] +
                         mean(panic_coef$btempdorm_p) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] +
                         mean(panic_coef$bpptdormsex_p) * pptdorm_seq * (s-1) +
                         mean(panic_coef$bpptgrowsex_p) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s]  * (s-1) +
                         mean(panic_coef$btempgrowsex_p) * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] * (s-1) +
                        mean(panic_coef$btempdormsex_p) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * (s-1) +
                         mean(panic_coef$btempdormpptdorm_p) * pptdorm_seq * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] +
                         mean(panic_coef$btempgrowpptgrow_p) * panic_mean_pptgrow$pptgrow[panic_mean_pptdorm$Sex==s] * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] +
                         mean(panic_coef$btempdormpptdormsex_p) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * pptdorm_seq * (s-1) +
                         mean(panic_coef$btempgrowpptgrowsex_p) * panic_mean_pptgrow$pptgrow[panic_mean_tempgrow$Sex==s] * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s]  * (s-1) +
                         mean(panic_coef$bpptdorm2_p) * (pptdorm_seq^2) +
                         mean(panic_coef$bpptgrow2_p) * (panic_mean_pptgrow$pptgrow[panic_mean_pptdorm$Sex==s])^2 +
                         mean(panic_coef$btempgrow2_p) * (panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s])^2 +
                         mean(panic_coef$btempdorm2_p) * (panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s])^2 +
                         mean(panic_coef$bpptdorm2sex_p) * (pptdorm_seq^2) * (s-1) +
                         mean(panic_coef$bpptgrow2sex_p) * (panic_mean_pptgrow$pptgrow[panic_mean_tempgrow$Sex==s])^2 * (s-1) +
                         mean(panic_coef$btempgrow2sex_p) * (panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s])^2 * (s-1) +
                         mean(panic_coef$btempdorm2sex_p) * (panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s])^2 * (s-1)
    
    )
    
            ,lty=sex_lty[s],lwd=3,col= sex_cols[s])
    }
    par(mar=c(2,4,0.5,0))
    plot(pptdorm_seq *sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),sex_diff_panic_mean_pptdorm[i,],type="n",lwd=4,yaxt="n",
         xlab=" ",ylab=" ",ylim=c(min(sex_diff_panic_95_pptdorm[i,,1]),15))
    # if(i==1){mtext(expression(paste(Delta," (F-M)")),side=2,line=2,cex=1.3)}
    mtext("Precipitation (dorm. season)",side=1,line=3,cex=1.3)
    polygon(x=c(pptdorm_seq *sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),rev(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) )),
            y=c(sex_diff_panic_95_pptdorm[i,,1],rev(sex_diff_panic_95_pptdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptdorm_seq *sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),rev(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) )),
            y=c(sex_diff_panic_75_pptdorm[i,,1],rev(sex_diff_panic_75_pptdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) ,rev(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) )),
            y=c(sex_diff_panic_50_pptdorm[i,,1],rev(sex_diff_panic_50_pptdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA) 
    polygon(x=c(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) ,rev(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) )),
            y=c(sex_diff_panic_25_pptdorm[i,,1],rev(sex_diff_panic_25_pptdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    lines(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) ,sex_diff_panic_mean_pptdorm[i,],lwd=2,col="black")
    abline(h=0,lty=2)
    mtext("0",side=2,at=0)
  }
})

with(poar_panic_binned,{
  for(i in 1:size_bin_num){
    par(mar=c(0,4,1,0))
    plot(tempdorm[size_bin==i]*sd(poar_2015_2016$tempdorm)+ mean(poar_2015_2016$tempdorm) ,mean_panic[size_bin==i],type="n",
         xlab=" ",ylab=" ",xaxt="n",ylim=c(0,12));box()    
    # if(i==1){mtext("#panicles",side=2,line=3,cex=1.3)}
    mylabel3 <- paste(graph[[16]])
    mtext(mylabel3,side = 3, adj = 0,cex=1.5)   
    for(s in 1:2){
      points(tempdorm[Sex==s & size_bin==i]*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),mean_panic[Sex==s & size_bin==i],
             bg=sex_cols[s],pch=21,cex=7*(bin_n/max(bin_n)),lwd=2)
      lines(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm), exp(mean(panic_coef$b0_p) + 
                         mean(panic_coef$bsize_p) * panic_mean_sizes$size[panic_mean_sizes$Sex==s & panic_mean_sizes$size_bin==i] +
                         mean(panic_coef$bsizesex_p) * panic_mean_sizes$size[panic_mean_sizes$Sex==s & panic_mean_sizes$size_bin==i] * (s-1) +
                         mean(panic_coef$bsex_p) * (s-1) +
                         mean(panic_coef$bpptgrow_p) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s] +
                         mean(panic_coef$bpptdorm_p) *  panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s] +
                         mean(panic_coef$btempgrow_p) * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] +
                         mean(panic_coef$btempdorm_p) * tempdorm_seq +
                         mean(panic_coef$bpptgrowsex_p) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s] * (s-1) +
                         mean(panic_coef$bpptdormsex_p) * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s] * (s-1) +
                         mean(panic_coef$btempgrowsex_p) * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] * (s-1) +
                        mean(panic_coef$btempdormsex_p) * tempdorm_seq * (s-1) +
                        mean (panic_coef$btempdormpptdorm_p) * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s] * tempdorm_seq +
                        mean (panic_coef$btempgrowpptgrow_p) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s] * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] +
                        mean (panic_coef$btempdormpptdormsex_p) * tempdorm_seq * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s] * (s-1) +
                        mean (panic_coef$btempgrowpptgrowsex_p) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s] * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] * (s-1) +
                        mean (panic_coef$bpptgrow2_p) * (panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s])^2 +
                        mean (panic_coef$bpptdorm2_p) * (panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s])^2 +
                         mean(panic_coef$btempgrow2_p) * (panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s])^2 +
                         mean(panic_coef$btempdorm2_p) * (tempdorm_seq^2) +
                         mean(panic_coef$bpptgrow2sex_p) * (panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s])^2 * (s-1) +
                         mean(panic_coef$bpptdorm2sex_p) * (panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s])^2 * (s-1) +
                         mean(panic_coef$btempgrow2sex_p) * (panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s])^2 * (s-1) +
                         mean(panic_coef$btempdorm2sex_p) * (tempdorm_seq^2) * (s-1)
    )
     ,lty=sex_lty[s],lwd=3,col= sex_cols[s])
    }
    par(mar=c(2,4,0.5,0))
    plot(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm) ,sex_diff_panic_mean_tempdorm[i,],type="n",lwd=4,yaxt="n",
         xlab=" ",ylab=" ",ylim=c(min(sex_diff_panic_95_tempdorm[i,,1]),max(sex_diff_panic_95_tempdorm[i,,2])))
    # if(i==1){mtext(expression(paste(Delta," (F-M)")),side=2,line=2,cex=1.3)}
    mtext("Temperature (dorm. season)",side=1,line=3,cex=1.3)
    polygon(x=c(tempdorm_seq*sd(poar_2015_2016$tempdorm)+ mean(poar_2015_2016$tempdorm) ,rev(tempdorm_seq*sd(poar_2015_2016$tempdorm)+ mean(poar_2015_2016$tempdorm) )),
            y=c(sex_diff_panic_95_tempdorm[i,,1],rev(sex_diff_panic_95_tempdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempdorm_seq*sd(poar_2015_2016$tempdorm)+ mean(poar_2015_2016$tempdorm) ,rev(tempdorm_seq*sd(poar_2015_2016$tempdorm)+ mean(poar_2015_2016$tempdorm) )),
            y=c(sex_diff_panic_75_tempdorm[i,,1],rev(sex_diff_panic_75_tempdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempdorm_seq*sd(poar_2015_2016$tempdorm)+ mean(poar_2015_2016$tempdorm) ,rev(tempdorm_seq*sd(poar_2015_2016$tempdorm)+ mean(poar_2015_2016$tempdorm) )),
            y=c(sex_diff_panic_50_tempdorm[i,,1],rev(sex_diff_panic_50_tempdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempdorm_seq*sd(poar_2015_2016$tempdorm)+ mean(poar_2015_2016$tempdorm) ,rev(tempdorm_seq*sd(poar_2015_2016$tempdorm)+ mean(poar_2015_2016$tempdorm) )),
            y=c(sex_diff_panic_25_tempdorm[i,,1],rev(sex_diff_panic_25_tempdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    lines(tempdorm_seq *sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),sex_diff_panic_mean_tempdorm[i,],lwd=2,col="black")
    abline(h=0,lty=2)
    mtext("0",side=2,at=0)
  }
})

dev.off()
```

```{r}

# set up figure
sex_cols <- RColorBrewer::brewer.pal(8, "Dark2")[c(2,1)]
# sex_cols <- c("black","white")
sex_lty <- c(1,1)
bin_shapes <- 15
diff_col <- RColorBrewer::brewer.pal(8, "Dark2")[6]
diff_alpha <- 0.35
graph<-list("A","B","C","D","E","F","G","H")
layout.matrix <- rbind(matrix(1:8, nrow = 2, ncol = 4, byrow = F),
                       matrix(9:16, nrow = 2, ncol = 4, byrow = F))
#print figure
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/vital_rates_ESA.pdf",height = 7,width = 12,useDingbats = F)
layout(mat = layout.matrix,
       heights = rep(c(2, 1),4), # Heights of the two rows
       widths = c(2, 2, 2,2))
# layout.show(32)

par(oma=c(3,1,0.5,0.5))
with(poar_surv_binned,{
  for(i in 1:size_bin_num){
    par(mar=c(0,4,2,0))
    plot(pptgrow[size_bin==i]*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),mean_surv[size_bin==i],type="n",xaxt="n",ylim=c(0,1),
         xlab=" ",ylab=" ");box()
    if(i==1){mtext("Pr(survival)",side=2,line=3,cex=1.2)}
    mylabel3 <- paste(graph[[1]])
    mtext(mylabel3,side = 3, adj = 0,cex=1.5)
    for(s in 1:2){
      points(pptgrow[Sex==s & size_bin==i]*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),mean_surv[Sex==s & size_bin==i],
             bg=sex_cols[s],pch=21,cex=5*(bin_n/max(bin_n)),lwd=2)
      lines(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),invlogit(mean(surv_coef$b0_s) + 
                         mean(surv_coef$bsize_s) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i]+
                         mean(surv_coef$bsizesex_s) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i] * (s-1) +
                         mean(surv_coef$bsex_s) * (s-1) +
                         mean(surv_coef$bpptgrow_s) * pptgrow_seq +
                         mean(surv_coef$bpptdorm_s) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s]  +
                         mean(surv_coef$btempgrow_s) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                         mean(surv_coef$btempdorm_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] +
                         mean(surv_coef$bpptgrowsex_s) * pptgrow_seq * (s-1) +
                         mean(surv_coef$bpptdormsex_s) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s]  * (s-1) +
                         mean(surv_coef$btempgrowsex_s) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * (s-1) +
                        mean(surv_coef$btempdormsex_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * (s-1) +
                         mean(surv_coef$btempdormpptdorm_s) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] +
                         mean(surv_coef$btempgrowpptgrow_s) * pptgrow_seq * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                         mean(surv_coef$btempdormpptdormsex_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] * (s-1) +
                         mean(surv_coef$btempgrowpptgrowsex_s) * pptgrow_seq * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s]  * (s-1) +
                         mean(surv_coef$bpptgrow2_s) * (pptgrow_seq^2) +
                         mean(surv_coef$bpptdorm2_s) * (surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s])^2 +
                         mean(surv_coef$btempgrow2_s) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 +
                         mean(surv_coef$btempdorm2_s) * (surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s])^2 +
                         mean(surv_coef$bpptgrow2sex_s) * (pptgrow_seq^2) * (s-1) +
                         mean(surv_coef$bpptdorm2sex_s) * (surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s])^2 * (s-1) +
                         mean(surv_coef$btempgrow2sex_s) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 * (s-1) +
                         mean(surv_coef$btempdorm2sex_s) * (surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s])^2 * (s-1)
    ),lty=sex_lty[s],lwd=3,col= sex_cols[s])
    }
    par(mar=c(2,4,0.5,0))
    plot(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) ,sex_diff_surv_mean_pptgrow[i,],type="n",lwd=4,yaxt="n",
         xlab=" ",ylab=" ",xaxt="n",ylim=c(min(sex_diff_surv_95_pptgrow[i,,1]),max(sex_diff_surv_95_pptgrow[i,,2])))
    if(i==1){mtext(expression(paste(Delta," (F-M)")),side=2,line=2,cex=1.2)}
    polygon(x=c(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),rev(pptgrow_seq *sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow))),
            y=c(sex_diff_surv_95_pptgrow[i,,1],rev(sex_diff_surv_95_pptgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) ,rev(pptgrow_seq *sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow))),
            y=c(sex_diff_surv_75_pptgrow[i,,1],rev(sex_diff_surv_75_pptgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),rev(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow))),
            y=c(sex_diff_surv_50_pptgrow[i,,1],rev(sex_diff_surv_50_pptgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) ,rev(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow))),
            y=c(sex_diff_surv_25_pptgrow[i,,1],rev(sex_diff_surv_25_pptgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    lines(pptgrow_seq *sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),sex_diff_surv_mean_pptgrow[i,],lwd=2,col="black")
    abline(h=0,lty=2)
    mtext("0",side=2,at=0)
  }
})

with(poar_surv_binned,{
  for(i in 1:size_bin_num){
    par(mar=c(0,4,2,0))
    plot(tempgrow[size_bin==i]*sd(poar_2015_2016$tempgrow)+ mean(poar_2015_2016$tempgrow),mean_surv[size_bin==i],type="n",ylim=c(0,1),
         xlab=" ",ylab=" ",xaxt="n");box()
     mylabel3 <- paste(graph[[2]])
     mtext(mylabel3,side = 3, adj = 0,cex=1.5)
    for(s in 1:2){
      points(tempgrow[Sex==s & size_bin==i]*sd(poar_2015_2016$tempgrow)+mean(poar_2015_2016$tempgrow),mean_surv[Sex==s & size_bin==i],
             bg=sex_cols[s],pch=21,cex=5*(bin_n/max(bin_n)),lwd=2)
      lines(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow),invlogit(mean(surv_coef$b0_s) +
                        mean(surv_coef$bsize_s) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i] +
                        mean(surv_coef$bsizesex_s) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i] * (s-1) +
                        mean(surv_coef$bsex_s) * (s-1) +
                        mean(surv_coef$bpptgrow_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s]  +
                        mean(surv_coef$bpptdorm_s) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s]  +
                        mean(surv_coef$btempgrow_s) * tempgrow_seq +
                        mean(surv_coef$btempdorm_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] +
                        mean(surv_coef$bpptgrowsex_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * (s-1) +
                        mean(surv_coef$bpptdormsex_s) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s]  * (s-1) +
                        mean(surv_coef$btempdormpptdorm_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] +
                        mean(surv_coef$btempgrowpptgrow_s) * tempgrow_seq * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] +
                        mean(surv_coef$btempgrowsex_s) * tempgrow_seq * (s-1) +
                        mean(surv_coef$btempdormsex_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * (s-1) +
                        mean(surv_coef$btempdormpptdormsex_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] * (s-1) +
                        mean(surv_coef$btempgrowpptgrowsex_s) * tempgrow_seq * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s]  * (s-1) +
                        mean(surv_coef$bpptgrow2_s) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 +
                        mean(surv_coef$bpptdorm2_s) * (surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s])^2 +
                        mean(surv_coef$btempgrow2_s) * (tempgrow_seq^2) +
                        mean(surv_coef$btempdorm2_s) * (surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s])^2 +
                        mean(surv_coef$bpptgrow2sex_s) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 * (s-1) +
                        mean(surv_coef$bpptdorm2sex_s) * (surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s])^2 * (s-1) +
                        mean(surv_coef$btempgrow2sex_s) * (tempgrow_seq^2) * (s-1) +
                        mean(surv_coef$btempdorm2sex_s) * (surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s])^2 * (s-1)
    
    ),lty=sex_lty[s],lwd=3,col= sex_cols[s])
    }
    par(mar=c(2,4,0.5,0))
    plot(tempgrow_seq *sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow),sex_diff_surv_mean_tempgrow[i,],type="n",lwd=4,yaxt="n",
         xlab=" ",ylab=" ",xaxt="n",ylim=c(min(sex_diff_surv_95_tempgrow[i,,1]),max(sex_diff_surv_95_tempgrow[i,,2])))
    # if(i==1){mtext(expression(paste(Delta," (F-M)")),side=2,line=2,cex=1.3)}
    polygon(x=c(tempgrow_seq*sd(poar_2015_2016$tempgrow)+ mean(poar_2015_2016$tempgrow),rev(tempgrow_seq*sd(poar_2015_2016$tempgrow)+ mean(poar_2015_2016$tempgrow) )),
            y=c(sex_diff_surv_95_tempgrow[i,,1],rev(sex_diff_surv_95_tempgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempgrow_seq *sd(poar_2015_2016$tempgrow)+ mean(poar_2015_2016$tempgrow),rev(tempgrow_seq*sd(poar_2015_2016$tempgrow)+ mean(poar_2015_2016$tempgrow) )),
            y=c(sex_diff_surv_75_tempgrow[i,,1],rev(sex_diff_surv_75_tempgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempgrow_seq*sd(poar_2015_2016$tempgrow)+ mean(poar_2015_2016$tempgrow),rev(tempgrow_seq*sd(poar_2015_2016$tempgrow)+ mean(poar_2015_2016$tempgrow))),
            y=c(sex_diff_surv_50_tempgrow[i,,1],rev(sex_diff_surv_50_tempgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempgrow_seq*sd(poar_2015_2016$tempgrow)+ mean(poar_2015_2016$tempgrow) ,rev(tempgrow_seq*sd(poar_2015_2016$tempgrow)+ mean(poar_2015_2016$tempgrow))),
            y=c(sex_diff_surv_25_tempgrow[i,,1],rev(sex_diff_surv_25_tempgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    lines(tempgrow_seq*sd(poar_2015_2016$tempgrow)+ mean(poar_2015_2016$tempgrow) ,sex_diff_surv_mean_tempgrow[i,],lwd=2,col="black")
    abline(h=0,lty=2)
    mtext("0",side=2,at=0)
  }
})

with(poar_surv_binned,{
  for(i in 1:size_bin_num){
    par(mar=c(0,4,2,0))
    plot(pptdorm[size_bin==i]*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),mean_surv[size_bin==i],type="n",ylim=c(0,1),
         xlab=" ",ylab=" ",xaxt="n");box()
     mylabel3 <- paste(graph[[3]])
     mtext(mylabel3,side = 3, adj = 0,cex=1.5)
    for(s in 1:2){
      points(pptdorm[Sex==s & size_bin==i]*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),mean_surv[Sex==s & size_bin==i],
             bg=sex_cols[s],pch=21,cex=5*(bin_n/max(bin_n)),lwd=2)
      lines(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),invlogit(mean(surv_coef$b0_s) + 
                         mean(surv_coef$bsize_s) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i]+
                         mean(surv_coef$bsizesex_s) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i] * (s-1) +
                         mean(surv_coef$bsex_s) * (s-1) +
                         mean(surv_coef$bpptgrow_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] +
                         mean(surv_coef$bpptdorm_s) *  pptdorm_seq +
                         mean(surv_coef$btempgrow_s) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                         mean(surv_coef$btempdorm_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] +
                         mean(surv_coef$bpptgrowsex_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * (s-1) +
                         mean(surv_coef$bpptdormsex_s) * pptdorm_seq * (s-1) +
                         mean(surv_coef$btempgrowsex_s) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * (s-1) +
                        mean(surv_coef$btempdormsex_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * (s-1) +
                         mean(surv_coef$btempdormpptdorm_s) * pptdorm_seq * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] +
                         mean(surv_coef$btempgrowpptgrow_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                         mean(surv_coef$btempdormpptdormsex_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * pptdorm_seq * (s-1) +
                         mean(surv_coef$btempgrowpptgrowsex_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * (s-1) +
                         mean(surv_coef$bpptgrow2_s) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 +
                         mean(surv_coef$bpptdorm2_s) * (pptdorm_seq^2) +
                         mean(surv_coef$btempgrow2_s) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 +
                         mean(surv_coef$btempdorm2_s) * (surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s])^2 +
                         mean(surv_coef$bpptgrow2sex_s) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 * (s-1) +
                         mean(surv_coef$bpptdorm2sex_s) * (pptdorm_seq^2) * (s-1) +
                         mean(surv_coef$btempgrow2sex_s) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 * (s-1) +
                         mean(surv_coef$btempdorm2sex_s) * (surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s])^2 * (s-1)
    ),lty=sex_lty[s],lwd=3,col= sex_cols[s])
    }
    par(mar=c(2,4,0.5,0))
    plot(pptdorm_seq *sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),sex_diff_surv_mean_pptdorm[i,],type="n",lwd=4,yaxt="n",
         xlab=" ",ylab=" ",xaxt="n",ylim=c(min(sex_diff_surv_95_pptdorm[i,,1]),max(sex_diff_surv_95_pptdorm[i,,2])))
    # if(i==1){mtext(expression(paste(Delta," (F-M)")),side=2,line=2,cex=1.3)}
    polygon(x=c(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),rev(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) )),
            y=c(sex_diff_surv_95_pptdorm[i,,1],rev(sex_diff_surv_95_pptdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) ,rev(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) )),
            y=c(sex_diff_surv_75_pptdorm[i,,1],rev(sex_diff_surv_75_pptdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),rev(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm))),
            y=c(sex_diff_surv_50_pptdorm[i,,1],rev(sex_diff_surv_50_pptdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) ,rev(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm))),
            y=c(sex_diff_surv_25_pptdorm[i,,1],rev(sex_diff_surv_25_pptdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    lines(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) ,sex_diff_surv_mean_pptdorm[i,],lwd=2,col="black")
    abline(h=0,lty=2)
    mtext("0",side=2,at=0)
  }
})

with(poar_surv_binned,{
  for(i in 1:size_bin_num){
    par(mar=c(0,4,2,0))
    plot(tempdorm[size_bin==i]*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),mean_surv[size_bin==i],type="n",ylim=c(0,1),
         xlab=" ",ylab=" ",xaxt="n");box()
     mylabel3 <- paste(graph[[4]])
     mtext(mylabel3,side = 3, adj = 0,cex=1.5)
    for(s in 1:2){
      points(tempdorm[Sex==s & size_bin==i]*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),mean_surv[Sex==s & size_bin==i],
             bg=sex_cols[s],pch=21,cex=5*(bin_n/max(bin_n)),lwd=2)
      lines(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),invlogit(mean(surv_coef$b0_s) + 
                         mean(surv_coef$bsize_s) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i] +
                         mean(surv_coef$bsizesex_s) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i] * (s-1) +
                         mean(surv_coef$bsex_s) * (s-1) +
                         mean(surv_coef$bpptgrow_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] +
                         mean(surv_coef$bpptdorm_s) *  surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] +
                         mean(surv_coef$btempgrow_s) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                         mean(surv_coef$btempdorm_s) * tempdorm_seq +
                         mean(surv_coef$bpptgrowsex_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * (s-1) +
                         mean(surv_coef$bpptdormsex_s) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] * (s-1) +
                         mean(surv_coef$btempgrowsex_s) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * (s-1) +
                        mean(surv_coef$btempdormsex_s) * tempdorm_seq * (s-1) +
                         mean(surv_coef$btempdormpptdorm_s) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] +
                         mean(surv_coef$btempgrowpptgrow_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                         mean(surv_coef$btempdormpptdormsex_s) * tempdorm_seq * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] * (s-1) +
                         mean(surv_coef$btempgrowpptgrowsex_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * (s-1) +
                         mean(surv_coef$bpptgrow2_s) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 +
                         mean(surv_coef$bpptdorm2_s) * (surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s])^2 +
                         mean(surv_coef$btempgrow2_s) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 +
                         mean(surv_coef$btempdorm2_s) * (tempdorm_seq^2) +
                         mean(surv_coef$bpptgrow2sex_s) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 * (s-1) +
                        mean(surv_coef$bpptdorm2sex_s) * (surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s])^2 * (s-1) +
                        mean(surv_coef$btempgrow2sex_s) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 * (s-1) +
                        mean(surv_coef$btempdorm2sex_s) * (tempdorm_seq^2) * (s-1)
    ),lty=sex_lty[s],lwd=3,col= sex_cols[s])
    }
    par(mar=c(2,4,0.5,0))
    plot(tempdorm_seq *sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),sex_diff_surv_mean_tempdorm[i,],type="n",lwd=4,yaxt="n",
         xlab=" ",ylab=" ",xaxt="n",ylim=c(min(sex_diff_surv_95_tempdorm[i,,1]),max(sex_diff_surv_95_tempdorm[i,,2])))
    # if(i==1){mtext(expression(paste(Delta," (F-M)")),side=2,line=2,cex=1.3)}
    polygon(x=c(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),rev(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm) )),
            y=c(sex_diff_surv_95_tempdorm[i,,1],rev(sex_diff_surv_95_tempdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm) ,rev(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm) )),
            y=c(sex_diff_surv_75_tempdorm[i,,1],rev(sex_diff_surv_75_tempdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),rev(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm))),
            y=c(sex_diff_surv_50_tempdorm[i,,1],rev(sex_diff_surv_50_tempdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm) ,rev(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm))),
            y=c(sex_diff_surv_25_tempdorm[i,,1],rev(sex_diff_surv_25_tempdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    lines(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm) ,sex_diff_surv_mean_tempdorm[i,],lwd=2,col="black")
    abline(h=0,lty=2)
    mtext("0",side=2,at=0)
  }
})

with(poar_grow_binned,{
  for(i in 1:size_bin_num){
    par(mar=c(0,4,1,0))
    plot(pptgrow[size_bin==i]*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),mean_grow[size_bin==i],type="n",
         xlab=" ",ylab=" ",ylim=c(0,50));box()    
    if(i==1){mtext("#tillers",side=2,line=3,cex=1.2)}
    mylabel3 <- paste(graph[[5]])
    mtext(mylabel3,side = 3, adj = 0,cex=1.5)
    for(s in 1:2){
      points(pptgrow[Sex==s & size_bin==i]*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) ,mean_grow[Sex==s & size_bin==i],
             bg=sex_cols[s],pch=21,cex=5*(bin_n/max(bin_n)),lwd=2,ylim=c(0,50))
      lines(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) ,
            exp(mean(grow_coef$b0_g) + 
                         mean(grow_coef$bsize_g) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i]+
                         mean(grow_coef$bsizesex_g) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i] * (s-1) +
                         mean(grow_coef$bsex_g) * (s-1) +
                         mean(grow_coef$bpptgrow_g) * pptgrow_seq +
                         mean(grow_coef$bpptdorm_g) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s]  +
                         mean(grow_coef$btempgrow_g) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                         mean(grow_coef$btempdorm_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] +
                         mean(grow_coef$bpptgrowsex_g) * pptgrow_seq * (s-1) +
                         mean(grow_coef$bpptdormsex_g) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s]  * (s-1) +
                         mean(grow_coef$btempgrowsex_g) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] * (s-1) +
                        mean(grow_coef$btempdormsex_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * (s-1) +
                         mean(grow_coef$btempdormpptdorm_g) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] +
                         mean(grow_coef$btempgrowpptgrow_g) * pptgrow_seq * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                         mean(grow_coef$btempdormpptdormsex_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] * (s-1) +
                         mean(grow_coef$btempgrowpptgrowsex_g) * pptgrow_seq * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s]  * (s-1) +
                         mean(grow_coef$bpptgrow2_g) * (pptgrow_seq^2) +
                         mean(grow_coef$bpptdorm2_g) * (grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s])^2 +
                         mean(grow_coef$btempgrow2_g) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 +
                         mean(grow_coef$btempdorm2_g) * (grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s])^2 +
                         mean(grow_coef$bpptgrow2sex_g) * (pptgrow_seq^2) * (s-1) +
                         mean(grow_coef$bpptdorm2sex_g) * (grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s])^2 * (s-1) +
                         mean(grow_coef$btempgrow2sex_g) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 * (s-1) +
                         mean(grow_coef$btempdorm2sex_g) * (grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s])^2 * (s-1)
    
    ),lty=sex_lty[s],lwd=3,col= sex_cols[s])
    }
    legend(850, 40, 
       legend=c( "Female","Male"),
       lty=c(1,1),
       # pt.cex=c(0.75,1.25,1),
       col =c("#D95F02", "#1B9E77"),
       cex = 1.2,
       bty = "n",
       lw=3,
       horiz = F , 
)
    par(mar=c(2,4,0.5,0))
    plot(pptgrow_seq *sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),sex_diff_grow_mean_pptgrow[i,],type="n",lwd=4,yaxt="n",
         xlab=" ",ylab=" ",ylim=c(min(sex_diff_grow_95_pptgrow[i,,1]),max(sex_diff_grow_95_pptgrow[i,,2])))
    mtext("Precipitation (grow. season)",side=1,line=3,cex=1.2)
    if(i==1){mtext(expression(paste(Delta," (F-M)")),side=2,line=2,cex=1.2)}
    polygon(x=c(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),rev(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) )),
            y=c(sex_diff_grow_95_pptgrow[i,,1],rev(sex_diff_grow_95_pptgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) ,rev(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow))),
            y=c(sex_diff_grow_75_pptgrow[i,,1],rev(sex_diff_grow_75_pptgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) ,rev(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) )),
            y=c(sex_diff_grow_50_pptgrow[i,,1],rev(sex_diff_grow_50_pptgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) ,rev(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow))),
            y=c(sex_diff_grow_25_pptgrow[i,,1],rev(sex_diff_grow_25_pptgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    lines(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) ,sex_diff_grow_mean_pptgrow[i,],lwd=2,col="black")
    abline(h=0,lty=2)
    mtext("0",side=2,at=0)
  }
})

with(poar_grow_binned,{
  for(i in 1:size_bin_num){
    par(mar=c(0,4,1,0))
    plot(tempgrow[size_bin==i]*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow),mean_grow[size_bin==i],type="n",
         xlab=" ",ylab=" ",ylim=c(0,50));box()    
     mylabel3 <- paste(graph[[6]])
     mtext(mylabel3,side = 3, adj = 0,cex=1.5)    
    for(s in 1:2){
      points(tempgrow[Sex==s & size_bin==i]*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow),mean_grow[Sex==s & size_bin==i],
             bg=sex_cols[s],pch=21,cex=5*(bin_n/max(bin_n)),lwd=2)
      lines(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow) ,
            exp(mean(grow_coef$b0_g) +
                        mean(grow_coef$bsize_g) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i] +
                        mean(grow_coef$bsizesex_g) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i] * (s-1) +
                        mean(grow_coef$bsex_g) * (s-1) +
                        mean(grow_coef$bpptgrow_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s]  +
                        mean(grow_coef$bpptdorm_g) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s]  +
                        mean(grow_coef$btempgrow_g) * tempgrow_seq +
                        mean(grow_coef$btempdorm_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] +
                        mean(grow_coef$bpptgrowsex_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * (s-1) +
                        mean(grow_coef$bpptdormsex_g) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s]  * (s-1) +
                        mean(grow_coef$btempdormpptdorm_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] +
                        mean(grow_coef$btempgrowpptgrow_g) * tempgrow_seq * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] +
                        mean(grow_coef$btempgrowsex_g) * tempgrow_seq * (s-1) +
                        mean(grow_coef$btempdormsex_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * (s-1) +
                        mean(grow_coef$btempdormpptdormsex_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] * (s-1) +
                        mean(grow_coef$btempgrowpptgrowsex_g) * tempgrow_seq * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s]  * (s-1) +
                        mean(grow_coef$bpptgrow2_g) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 +
                        mean(grow_coef$bpptdorm2_g) * (grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s])^2 +
                        mean(grow_coef$btempgrow2_g) * (tempgrow_seq^2) +
                        mean(grow_coef$btempdorm2_g) * (grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s])^2 +
                        mean(grow_coef$bpptgrow2sex_g) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 * (s-1) +
                        mean(grow_coef$bpptdorm2sex_g) * (grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s])^2 * (s-1) +
                        mean(grow_coef$btempgrow2sex_g) * (tempgrow_seq^2) * (s-1) +
                        mean(grow_coef$btempdorm2sex_g) * (grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s])^2 * (s-1)

    
    ),lty=sex_lty[s],lwd=3,col= sex_cols[s])
    }
    par(mar=c(2,4,0.5,0))
    plot(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow) ,sex_diff_grow_mean_tempgrow[i,],type="n",lwd=4,yaxt="n",
         xlab=" ",ylab=" ",ylim=c(min(sex_diff_grow_95_tempgrow[i,,1]),max(sex_diff_grow_95_tempgrow[i,,2])))
     mtext("Temperature (grow. season)",side=1,line=3,cex=1.2)
    # if(i==1){mtext(expression(paste(Delta," (F-M)")),side=2,line=2,cex=1.3)}
    polygon(x=c(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow),rev(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow) )),
            y=c(sex_diff_grow_95_tempgrow[i,,1],rev(sex_diff_grow_95_tempgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow) ,rev(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow))),
            y=c(sex_diff_grow_75_tempgrow[i,,1],rev(sex_diff_grow_75_tempgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow) ,rev(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow) )),
            y=c(sex_diff_grow_50_tempgrow[i,,1],rev(sex_diff_grow_50_tempgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempgrow_seq *sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow),rev(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow))),
            y=c(sex_diff_grow_25_tempgrow[i,,1],rev(sex_diff_grow_25_tempgrow[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    lines(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow) ,sex_diff_grow_mean_tempgrow[i,],lwd=2,col="black")
    abline(h=0,lty=2)
    mtext("0",side=2,at=0)
  }
})


with(poar_grow_binned,{
  for(i in 1:size_bin_num){
    par(mar=c(0,4,1,0))
    plot(pptdorm[size_bin==i]*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),mean_grow[size_bin==i],type="n",
         xlab=" ",ylab=" ",ylim=c(0,50));box()    
    # if(i==1){mtext("#tillers",side=2,line=3,cex=1.3)}
    mylabel3 <- paste(graph[[7]])
    mtext(mylabel3,side = 3, adj = 0,cex=1.5)
    for(s in 1:2){
      points(pptdorm[Sex==s & size_bin==i]*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),mean_grow[Sex==s & size_bin==i],
             bg=sex_cols[s],pch=21,cex=5*(bin_n/max(bin_n)),lwd=2,ylim=c(0,50))
      lines(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) ,
            exp(mean(grow_coef$b0_g) + 
                         mean(grow_coef$bsize_g) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i]+
                         mean(grow_coef$bsizesex_g) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i] * (s-1) +
                         mean(grow_coef$bsex_g) * (s-1) +
                         mean(grow_coef$bpptgrow_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] +
                         mean(grow_coef$bpptdorm_g) *  pptdorm_seq +
                         mean(grow_coef$btempgrow_g) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                         mean(grow_coef$btempdorm_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] +
                         mean(grow_coef$bpptgrowsex_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * (s-1) +
                         mean(grow_coef$bpptdormsex_g) * pptdorm_seq * (s-1) +
                         mean(grow_coef$btempgrowsex_g) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] * (s-1) +
                        mean(grow_coef$btempdormsex_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * (s-1) +
                        mean (grow_coef$btempdormpptdorm_g) * pptdorm_seq * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] +
                        mean (grow_coef$btempgrowpptgrow_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                         mean(grow_coef$btempdormpptdormsex_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * pptdorm_seq * (s-1) +
                         mean(grow_coef$btempgrowpptgrowsex_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] * (s-1) +
                         mean(grow_coef$bpptgrow2_g) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 +
                         mean(grow_coef$bpptdorm2_g) * (pptdorm_seq^2) +
                         mean(grow_coef$btempgrow2_g) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 +
                        mean (grow_coef$btempdorm2_g) * (grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s])^2 +
                         mean(grow_coef$bpptgrow2sex_g) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 * (s-1) +
                         mean(grow_coef$bpptdorm2sex_g) * (pptdorm_seq^2) * (s-1) +
                         mean(grow_coef$btempgrow2sex_g) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 * (s-1) +
                         mean(grow_coef$btempdorm2sex_g) * (grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s])^2 * (s-1)
    ),lty=sex_lty[s],lwd=3,col= sex_cols[s])
    }
    par(mar=c(2,4,0.5,0))
    plot(pptdorm_seq *sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),sex_diff_grow_mean_pptdorm[i,],type="n",lwd=4,yaxt="n",
         xlab=" ",ylab=" ",ylim=c(min(sex_diff_grow_95_pptdorm[i,,1]),max(sex_diff_grow_95_pptdorm[i,,2])))
    mtext("Precipitation (dorm. season)",side=1,line=3,cex=1.2)
    # if(i==1){mtext(expression(paste(Delta," (F-M)")),side=2,line=2,cex=1.3)}
    polygon(x=c(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),rev(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) )),
            y=c(sex_diff_grow_95_pptdorm[i,,1],rev(sex_diff_grow_95_pptdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) ,rev(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm))),
            y=c(sex_diff_grow_75_pptdorm[i,,1],rev(sex_diff_grow_75_pptdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) ,rev(pptdorm_seq *sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm))),
            y=c(sex_diff_grow_50_pptdorm[i,,1],rev(sex_diff_grow_50_pptdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) ,rev(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm))),
            y=c(sex_diff_grow_25_pptdorm[i,,1],rev(sex_diff_grow_25_pptdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    lines(pptdorm_seq *sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),sex_diff_grow_mean_pptdorm[i,],lwd=2,col="black")
    abline(h=0,lty=2)
    mtext("0",side=2,at=0)
  }
})

with(poar_grow_binned,{
  for(i in 1:size_bin_num){
    par(mar=c(0,4,1,0))
    plot(tempdorm[size_bin==i]*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),mean_grow[size_bin==i],type="n",
         xlab=" ",ylab=" ",ylim=c(0,50));box()    
    # if(i==1){mtext("#tillers",side=2,line=3,cex=1.3)}
    mylabel3 <- paste(graph[[8]])
    mtext(mylabel3,side = 3, adj = 0,cex=1.5)   
    for(s in 1:2){
      points(tempdorm[Sex==s & size_bin==i]*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm) ,mean_grow[Sex==s & size_bin==i],
             bg=sex_cols[s],pch=21,cex=5*(bin_n/max(bin_n)),lwd=2,ylim=c(0,50))
      lines(tempdorm_seq *sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm) ,exp(mean(grow_coef$b0_g) + 
                         mean(grow_coef$bsize_g) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i] +
                         mean(grow_coef$bsizesex_g) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i] * (s-1) +
                         mean(grow_coef$bsex_g) * (s-1) +
                         mean(grow_coef$bpptgrow_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] +
                        mean(grow_coef$bpptdorm_g) *  grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] +
                         mean(grow_coef$btempgrow_g) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                         mean(grow_coef$btempdorm_g) * tempdorm_seq +
                         mean(grow_coef$bpptgrowsex_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * (s-1) +
                         mean(grow_coef$bpptdormsex_g) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] * (s-1) +
                         mean(grow_coef$btempgrowsex_g) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] * (s-1) +
                        mean(grow_coef$btempdormsex_g) * tempdorm_seq * (s-1) +
                         mean(grow_coef$btempdormpptdorm_g) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] +
                         mean(grow_coef$btempgrowpptgrow_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                         mean(grow_coef$btempdormpptdormsex_g) * tempdorm_seq * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] * (s-1) +
                         mean(grow_coef$btempgrowpptgrowsex_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] * (s-1) +
                         mean(grow_coef$bpptgrow2_g) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 +
                         mean(grow_coef$bpptdorm2_g) * (grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s])^2 +
                         mean(grow_coef$btempgrow2_g) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 +
                         mean(grow_coef$btempdorm2_g) * (tempdorm_seq^2) +
                         mean(grow_coef$bpptgrow2sex_g) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 * (s-1) +
                         mean(grow_coef$bpptdorm2sex_g) * (grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s])^2 * (s-1) +
                         mean(grow_coef$btempgrow2sex_g) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 * (s-1) +
                         mean(grow_coef$btempdorm2sex_g) * (tempdorm_seq^2) * (s-1)
    )
            ,lty=sex_lty[s],lwd=3,col= sex_cols[s])
    }
    par(mar=c(2,4,0.5,0))
    plot(tempdorm_seq *sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),sex_diff_grow_mean_tempdorm[i,],type="n",lwd=4,yaxt="n",
         xlab=" ",ylab=" ",ylim=c(min(sex_diff_grow_95_tempdorm[i,,1]),max(sex_diff_grow_95_tempdorm[i,,2])))
    mtext("Temperature (dorm. season)",side=1,line=3,cex=1.2)
    # if(i==1){mtext(expression(paste(Delta," (F-M)")),side=2,line=2,cex=1.3)}
    polygon(x=c(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),rev(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm) )),
            y=c(sex_diff_grow_95_tempdorm[i,,1],rev(sex_diff_grow_95_tempdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempdorm_seq *sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),rev(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm))),
            y=c(sex_diff_grow_75_tempdorm[i,,1],rev(sex_diff_grow_75_tempdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempdorm_seq *sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),rev(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm) )),
            y=c(sex_diff_grow_50_tempdorm[i,,1],rev(sex_diff_grow_50_tempdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm) ,rev(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm))),
            y=c(sex_diff_grow_25_tempdorm[i,,1],rev(sex_diff_grow_25_tempdorm[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    lines(tempdorm_seq *sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),sex_diff_grow_mean_tempdorm[i,],lwd=2,col="black")
    abline(h=0,lty=2)
    mtext("0",side=2,at=0)
  }
})


dev.off()
```


# Matrix model (lambda vs climate)

##load MPM functions

```{r}
# source("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/twosexMPM.R")
source("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Analysis/twosexMPMLTRE.R")
# source("/Users/tm9/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Analysis/twosexMPMLTRE.R")

```

## read in the seedling survival data from Poa autumnalis

```{r}
POAU <- read.csv("https://www.dropbox.com/s/7f2yfz49fzrcp5i/POAU.csv?dl=1")

# sdlg_surv <- POAU %>% filter(year_recruit==year_t,year_t %in% 2014:2016) %>% summarise(sdlg_surv = mean(spring_survival_t1,na.rm=T))

sdlg_surv <- POAU %>% filter(year_recruit==year_t) %>% summarise(sdlg_surv = mean(spring_survival_t1,na.rm=T))
```

## pull out mean stan coefficients

```{r}
mean_coefs<- lapply(rstan::extract(fit_full, pars = quote_bare(b0_s,bsizesex_s,btempdormpptdorm_s,btempgrowpptgrow_s,bsex_s,
                                                        bsize_s,bpptgrow_s,bpptdorm_s,btempgrow_s,btempdorm_s,
                                                        bpptgrowsex_s,bpptdormsex_s,btempgrowsex_s,btempdormsex_s,
                                                        btempdormpptdormsex_s,btempgrowpptgrowsex_s,bpptgrow2_s,
                                                        bpptdorm2_s,btempgrow2_s,btempdorm2_s,bpptgrow2sex_s,bpptdorm2sex_s,
                                                        btempgrow2sex_s,btempdorm2sex_s,
                                                        site_tau_s,block_tau_s,source_tau_s)) ,mean)

mean_coefg<- lapply(rstan::extract(fit_full, pars = quote_bare(b0_g,btempdormpptdorm_g,btempgrowpptgrow_g,bsizesex_g,bsex_g,
                                                        bsize_g,bpptgrow_g,bpptdorm_g,btempgrow_g,btempdorm_g,bpptgrowsex_g,
                                                        bpptdormsex_g,btempgrowsex_g,btempdormsex_g,btempdormpptdormsex_g,
                                                        btempgrowpptgrowsex_g,bpptgrow2_g,bpptdorm2_g,btempgrow2_g,
                                                        btempdorm2_g,bpptgrow2sex_g,bpptdorm2sex_g,btempgrow2sex_g,btempdorm2sex_g,
                                                        site_tau_g,block_tau_g,source_tau_g,sigma)) ,mean)

mean_coeff<- lapply(rstan::extract(fit_full, pars = quote_bare(b0_f,bsizesex_f,bsex_f, bsize_f,bpptgrow_f,bpptdorm_f,btempgrow_f,
                                                        btempdorm_f,bpptgrowsex_f,bpptdormsex_f,btempgrowsex_f,btempdormsex_f,
                                                        btempdormpptdorm_f,btempgrowpptgrow_f,btempdormpptdormsex_f,
                                                        btempgrowpptgrowsex_f,bpptgrow2_f,bpptdorm2_f,btempgrow2_f,
                                                        btempdorm2_f,bpptgrow2sex_f,bpptdorm2sex_f,btempgrow2sex_f,btempdorm2sex_f,
                                                        site_tau_f,block_tau_f,source_tau_f)) ,mean)

mean_coefp<- lapply(rstan::extract(fit_full, pars = quote_bare(b0_p,bsex_p,bsex_p,bsizesex_p, bsize_p,bpptgrow_p,bpptdorm_p,
                                                         btempgrow_p,btempdorm_p,bpptgrowsex_p,bpptdormsex_p,btempgrowsex_p,
                                                         btempdormsex_p,btempdormpptdorm_p,btempgrowpptgrow_p,btempdormpptdormsex_p,
                                                         btempgrowpptgrowsex_p,bpptgrow2_p,bpptdorm2_p,btempgrow2_p,
                                                         btempdorm2_p,bpptgrow2sex_p,bpptdorm2sex_p,btempgrow2sex_p,btempdorm2sex_p,
                                                         site_tau_p,block_tau_p,source_tau_p)) ,mean)

mean_coefv<-lapply(rstan::extract(fit_full, pars = quote_bare(v0,a_v,m,lambda_d)) ,mean)


```

# set up female and male parameter vectors to run the Matrix

```{r}
F_params <- M_params <- c()
## survival
F_params$surv_mu <- mean_coefs$b0_s
F_params$surv_size <- mean_coefs$bsize_s
F_params$surv_pptgrow <- mean_coefs$bpptgrow_s 
F_params$surv_pptdorm <- mean_coefs$bpptdorm_s 
F_params$surv_tempgrow <- mean_coefs$btempgrow_s 
F_params$surv_tempdorm <- mean_coefs$btempdorm_s  
F_params$surv_tempdorm_pptdorm<-mean_coefs$btempdormpptdorm_s
F_params$surv_tempgrow_pptgrow<-mean_coefs$btempgrowpptgrow_s
F_params$surv_pptgrow2<-mean_coefs$bpptgrow2_s
F_params$surv_pptdorm2<-mean_coefs$bpptdorm2_s
F_params$surv_tempgrow2<-mean_coefs$btempgrow2_s
F_params$surv_tempdorm2<-mean_coefs$btempdorm2_s
M_params$surv_mu <- mean_coefs$b0_s + mean_coefs$bsex_s  
M_params$surv_size <- mean_coefs$bsize_s + mean_coefs$bsizesex_s
M_params$surv_pptgrow <- mean_coefs$bpptgrow_s  + mean_coefs$bpptgrowsex_s 
M_params$surv_pptdorm <- mean_coefs$bpptdorm_s  + mean_coefs$bpptdormsex_s 
M_params$surv_tempgrow <- mean_coefs$btempgrow_s + mean_coefs$btempgrowsex_s #
M_params$surv_tempdorm <-  mean_coefs$btempdorm_s  + mean_coefs$btempdormsex_s  
M_params$surv_tempdorm_pptdorm<-mean_coefs$btempdormpptdorm_s + mean_coefs$btempdormpptdormsex_s
M_params$surv_tempgrow_pptgrow<-mean_coefs$btempgrowpptgrow_s + mean_coefs$btempgrowpptgrowsex_s
M_params$surv_pptgrow2<-mean_coefs$bpptgrow2_s + mean_coefs$bpptgrow2sex_s
M_params$surv_pptdorm2<-mean_coefs$bpptdorm2_s + mean_coefs$bpptdorm2sex_s
M_params$surv_tempgrow2<-mean_coefs$btempgrow2_s + mean_coefs$btempgrow2sex_s
M_params$surv_tempdorm2<-mean_coefs$btempdorm2_s + mean_coefs$btempdorm2sex_s
## growth
F_params$grow_mu <- mean_coefg$b0_g
F_params$grow_size <- mean_coefg$bsize_g
F_params$grow_pptgrow <- mean_coefg$bpptgrow_g 
F_params$grow_pptdorm <- mean_coefg$bpptdorm_g 
F_params$grow_tempgrow <- mean_coefg$btempgrow_g 
F_params$grow_tempdorm <- mean_coefg$btempdorm_g  
F_params$grow_tempdorm_pptdorm<-mean_coefg$btempdormpptdorm_g
F_params$grow_tempgrow_pptgrow<-mean_coefg$btempgrowpptgrow_g
F_params$grow_pptgrow2<-mean_coefg$bpptgrow2_g
F_params$grow_pptdorm2<-mean_coefg$bpptdorm2_g
F_params$grow_tempgrow2<-mean_coefg$btempgrow2_g
F_params$grow_tempdorm2<-mean_coefg$btempdorm2_g
F_params$sigma_g <- mean_coefg$sigma 
M_params$grow_mu <- mean_coefg$b0_g + mean_coefg$bsex_g  
M_params$grow_size <- mean_coefg$bsize_g + mean_coefg$bsizesex_g
M_params$grow_pptgrow <- mean_coefg$bpptgrow_g  + mean_coefg$bpptgrowsex_g 
M_params$grow_pptdorm <- mean_coefg$bpptdorm_g  + mean_coefg$bpptdormsex_g 
M_params$grow_tempgrow <- mean_coefg$btempgrow_g + mean_coefg$btempgrowsex_g #
M_params$grow_tempdorm <-  mean_coefg$btempdorm_g  + mean_coefg$btempdormsex_g  
M_params$grow_tempdorm_pptdorm<-mean_coefg$btempdormpptdorm_g + mean_coefg$btempdormpptdormsex_g
M_params$grow_tempgrow_pptgrow<-mean_coefg$btempgrowpptgrow_g + mean_coefg$btempgrowpptgrowsex_g
M_params$grow_pptgrow2<-mean_coefg$bpptgrow2_g + mean_coefg$bpptgrow2sex_g
M_params$grow_pptdorm2<-mean_coefg$bpptdorm2_g + mean_coefg$bpptdorm2sex_g
M_params$grow_tempgrow2<-mean_coefg$btempgrow2_g + mean_coefg$btempgrow2sex_g
M_params$grow_tempdorm2<-mean_coefg$btempdorm2_g + mean_coefg$btempdorm2sex_g
M_params$sigma_g <- mean_coefg$sigma 
## flowering
F_params$flow_mu <- mean_coeff$b0_f
F_params$flow_size <- mean_coeff$bsize_f
F_params$flow_pptgrow <- mean_coeff$bpptgrow_f 
F_params$flow_pptdorm <- mean_coeff$bpptdorm_f 
F_params$flow_tempgrow <- mean_coeff$btempgrow_f 
F_params$flow_tempdorm <- mean_coeff$btempdorm_f  
F_params$flow_tempdorm_pptdorm<-mean_coeff$btempdormpptdorm_f
F_params$flow_tempgrow_pptgrow<-mean_coeff$btempgrowpptgrow_f
F_params$flow_pptgrow2<-mean_coeff$bpptgrow2_f
F_params$flow_pptdorm2<-mean_coeff$bpptdorm2_f
F_params$flow_tempgrow2<-mean_coeff$btempgrow2_f
F_params$flow_tempdorm2<-mean_coeff$btempdorm2_f
M_params$flow_mu <- mean_coeff$b0_f + mean_coeff$bsex_f  
M_params$flow_size <- mean_coeff$bsize_f + mean_coeff$bsizesex_f
M_params$flow_pptgrow <- mean_coeff$bpptgrow_f  + mean_coeff$bpptgrowsex_f 
M_params$flow_pptdorm <- mean_coeff$bpptdorm_f  + mean_coeff$bpptdormsex_f 
M_params$flow_tempgrow <- mean_coeff$btempgrow_f + mean_coeff$btempgrowsex_f #
M_params$flow_tempdorm <-  mean_coeff$btempdorm_f  + mean_coeff$btempdormsex_f  
M_params$flow_tempdorm_pptdorm<-mean_coeff$btempdormpptdorm_f + mean_coeff$btempdormpptdormsex_f
M_params$flow_tempgrow_pptgrow<-mean_coeff$btempgrowpptgrow_f + mean_coeff$btempgrowpptgrowsex_f
M_params$flow_pptgrow2<-mean_coeff$bpptgrow2_f + mean_coeff$bpptgrow2sex_f
M_params$flow_pptdorm2<-mean_coeff$bpptdorm2_f + mean_coeff$bpptdorm2sex_f
M_params$flow_tempgrow2<-mean_coeff$btempgrow2_f + mean_coeff$btempgrow2sex_f
M_params$flow_tempdorm2<-mean_coeff$btempdorm2_f + mean_coeff$btempdorm2sex_f
## panicles
F_params$panic_mu <- mean_coefp$b0_p
F_params$panic_size <- mean_coefp$bsize_p
F_params$panic_pptgrow <- mean_coefp$bpptgrow_p 
F_params$panic_pptdorm <- mean_coefp$bpptdorm_p 
F_params$panic_tempgrow <- mean_coefp$btempgrow_p 
F_params$panic_tempdorm <- mean_coefp$btempdorm_p  
F_params$panic_tempdorm_pptdorm<-mean_coefp$btempdormpptdorm_p
F_params$panic_tempgrow_pptgrow<-mean_coefp$btempgrowpptgrow_p
F_params$panic_pptgrow2<-mean_coefp$bpptgrow2_p
F_params$panic_pptdorm2<-mean_coefp$bpptdorm2_p
F_params$panic_tempgrow2<-mean_coefp$btempgrow2_p
F_params$panic_tempdorm2<-mean_coefp$btempdorm2_p
M_params$panic_mu <- mean_coefp$b0_p + mean_coefp$bsex_p  
M_params$panic_size <- mean_coefp$bsize_p + mean_coefp$bsizesex_p
M_params$panic_pptgrow <- mean_coefp$bpptgrow_p  + mean_coefp$bpptgrowsex_p 
M_params$panic_pptdorm <- mean_coefp$bpptdorm_p  + mean_coefp$bpptdormsex_p 
M_params$panic_tempgrow <- mean_coefp$btempgrow_p + mean_coefp$btempgrowsex_p #
M_params$panic_tempdorm <-  mean_coefp$btempdorm_p  + mean_coefp$btempdormsex_p  
M_params$panic_tempdorm_pptdorm<-mean_coefp$btempdormpptdorm_p + mean_coefp$btempdormpptdormsex_p
M_params$panic_tempgrow_pptgrow<-mean_coefp$btempgrowpptgrow_p + mean_coefp$btempgrowpptgrowsex_p
M_params$panic_pptgrow2<-mean_coefp$bpptgrow2_p + mean_coefp$bpptgrow2sex_p
M_params$panic_pptdorm2<-mean_coefp$bpptdorm2_p + mean_coefp$bpptdorm2sex_p
M_params$panic_tempgrow2<-mean_coefp$btempgrow2_p + mean_coefp$btempgrow2sex_p
M_params$panic_tempdorm2<-mean_coefp$btempdorm2_p + mean_coefp$btempdorm2sex_p
## seed viability and misc fertility params
F_params$v0 <- mean_coefv$v0 
F_params$a_v <- mean_coefv$a_v 
F_params$ov_per_inf <- mean_coefv$lambda_d 
F_params$germ <- mean_coefv$m 
F_params$PSR <- 0.5
## use POAU seedling survival for females and males
F_params$sdlg_surv <- M_params$sdlg_surv <- sdlg_surv$sdlg_surv
## set max size equal between the sexes
F_params$max_size <- M_params$max_size <- round(quantile(na.omit((poar.clim_seasonal$tillerN_t1)),probs=0.95))
```

# Relation lambda and each climatic variable.

```{r}
cbPalette <- c("#999999", "#E69F00")
```

## Demographic data

```{r}
pptgrow_seq <- seq(min(poar_2015_2016$zpptgrow),max(poar_2015_2016$zpptgrow),length.out=20)

climat_ppt<-data.frame(pptgrow_seq=pptgrow_seq,tempgrow_seq=rep(mean(poar_2015_2016$ztempgrow),length(pptgrow_seq)),pptdorm_seq=rep(mean(poar_2015_2016$zpptdorm),length(pptgrow_seq)),tempdorm_seq=rep(mean(poar_2015_2016$ztempdorm),length(pptgrow_seq)))

lambda_pptgrow_mean<-lambda_pptgrow_mean_2sex<-SR_pptgrow_mean<-OSR_pptgrow_mean<-c()
ssd_pptgrow<-matrix(NA,(F_params$max_size+1)*2,nrow(climat_ppt))
max_yrs <- 30

for (i in 1:nrow(climat_ppt)) {
    #linear model for comparison
  mat <- megamatrix_delay( F_params=F_params,
                           M_params=M_params,
                           twosex=F,
                           grow_perturb=0,
                           surv_perturb=0,
                           flow_perturb=0,
                           fert_perturb=0,
                           viab_perturb=0,
                           zpptgrow=climat_ppt[i,1],
                           ztempgrow=0,
                           zpptdorm=0,
                           ztempdorm=0,
                           rfx=rfx_fun())$MEGAmat
  lambda_pptgrow_mean[i] <- popbio::lambda(mat)
  # 2-sex model
  lambda_run <- lambdaSim_delay( F_params=F_params,
                                 M_params=M_params,
                                 grow_perturb=0,
                                 surv_perturb=0,
                                 flow_perturb=0,
                                 fert_perturb=0,
                                 viab_perturb=0,
                                 zpptgrow=climat_ppt[i,1],
                                 ztempgrow=0,
                                 zpptdorm=0,
                                 ztempdorm=0,
                                 rfx = rfx_fun(),
                                 max.yrs = max_yrs)
  lambda_pptgrow_mean_2sex[i] <- lambda_run$lambdatracker[max_yrs]
  SR_pptgrow_mean[i] <- lambda_run$SRtracker[max_yrs]
  OSR_pptgrow_mean[i] <- lambda_run$OSRtracker[max_yrs]
  ssd_pptgrow[,i] <- lambda_run$n0
}

```

### Temperature of the growing season

```{r}
tempgrow_seq <- seq(min(poar_2015_2016$ztempgrow),max(poar_2015_2016$ztempgrow),length.out=20)

climat_temp<-data.frame(pptgrow_seq_extend=rep(mean(poar_2015_2016$zpptgrow),length(tempgrow_seq)),tempgrow_seq=tempgrow_seq,pptdorm_seq=rep(mean(poar_2015_2016$zpptdorm),length(tempgrow_seq)),tempdorm_seq=rep(mean(poar_2015_2016$ztempdorm),length(tempgrow_seq)))

lambda_tempgrow_mean<-lambda_tempgrow_mean_2sex<-SR_tempgrow_mean<-OSR_tempgrow_mean<-c()
ssd_tempgrow<-matrix(NA,(F_params$max_size+1)*2,nrow(climat_temp))
max_yrs <- 30

for (i in 1:nrow(climat_temp)) {
    #linear model for comparison
  mat <- megamatrix_delay( F_params=F_params,
                           M_params=M_params,
                           twosex=F,
                           grow_perturb=0,
                           surv_perturb=0,
                           flow_perturb=0,
                           fert_perturb=0,
                           viab_perturb=0,
                           zpptgrow=0,
                           ztempgrow=climat_temp[i,2],
                           zpptdorm=0,
                           ztempdorm=0,
                           rfx=rfx_fun())$MEGAmat
  lambda_tempgrow_mean[i] <- popbio::lambda(mat)
  # 2-sex model
  lambda_run <- lambdaSim_delay( F_params=F_params,
                                 M_params=M_params,
                                 grow_perturb=0,
                                 surv_perturb=0,
                                 flow_perturb=0,
                                 fert_perturb=0,
                                 viab_perturb=0,
                                 zpptgrow=0,
                                 ztempgrow=climat_temp[i,2],
                                 zpptdorm=0,
                                 ztempdorm=0,
                                 rfx = rfx_fun(),
                                 max.yrs = max_yrs)
  lambda_tempgrow_mean_2sex[i] <- lambda_run$lambdatracker[max_yrs]
  SR_tempgrow_mean[i] <- lambda_run$SRtracker[max_yrs]
  OSR_tempgrow_mean[i] <- lambda_run$OSRtracker[max_yrs]
  ssd_tempgrow[,i] <- lambda_run$n0
}
```

### Precipitation of the dormant season

```{r}
pptdorm_seq <- seq(min(poar_2015_2016$zpptdorm),max(poar_2015_2016$zpptdorm),length.out=20)

climat_pptdorm<-data.frame(pptgrow_seq=rep(mean(poar_2015_2016$zpptgrow),length(pptdorm_seq)),tempgrow_seq=rep(mean(poar_2015_2016$ztempgrow),length(pptdorm_seq)),pptdorm_seq=pptdorm_seq,tempdorm_seq=rep(mean(poar_2015_2016$ztempdorm),length(pptdorm_seq)))

lambda_pptdorm_mean<-lambda_pptdorm_mean_2sex<-SR_pptdorm_mean<-OSR_pptdorm_mean<-c()
ssd_pptdorm<-matrix(NA,(F_params$max_size+1)*2,nrow(climat_pptdorm))
max_yrs <- 30

for (i in 1:nrow(climat_pptdorm)) {
    #linear model for comparison
  mat <- megamatrix_delay( F_params=F_params,
                           M_params=M_params,
                           twosex=F,
                           grow_perturb=0,
                           surv_perturb=0,
                           flow_perturb=0,
                           fert_perturb=0,
                           viab_perturb=0,
                           zpptgrow=0,
                           ztempgrow=0,
                           zpptdorm=climat_pptdorm[i,3],
                           ztempdorm=0,
                           rfx=rfx_fun())$MEGAmat
  lambda_pptdorm_mean [i] <- popbio::lambda(mat)
  # 2-sex model
  lambda_run <- lambdaSim_delay( F_params=F_params,
                                 M_params=M_params,
                                 grow_perturb=0,
                                 surv_perturb=0,
                                 flow_perturb=0,
                                 fert_perturb=0,
                                 viab_perturb=0,
                                 zpptgrow=0,
                                 ztempgrow=0,
                                 zpptdorm=climat_pptdorm[i,3],
                                 ztempdorm=0,
                                 rfx = rfx_fun(),
                                 max.yrs = max_yrs)
  lambda_pptdorm_mean_2sex [i] <- lambda_run$lambdatracker[max_yrs]
  SR_pptdorm_mean[i] <- lambda_run$SRtracker[max_yrs]
  OSR_pptdorm_mean[i] <- lambda_run$OSRtracker[max_yrs]
  ssd_pptdorm[,i] <- lambda_run$n0
}

```

### Temperature of the dormant season

```{r}
tempdorm_seq <- seq(min(poar_2015_2016$ztempdorm),max(poar_2015_2016$ztempdorm),length.out=20)

climat_tempdorm<-data.frame(pptgrow_seq=rep(mean(poar_2015_2016$zpptgrow),length(tempdorm_seq)),tempgrow_seq=rep(mean(poar_2015_2016$ztempgrow),length(tempdorm_seq)),pptdorm_seq=rep(mean(poar_2015_2016$zpptdorm),length(tempdorm_seq)),tempdorm_seq=tempdorm_seq)

lambda_tempdorm_mean<-lambda_tempdorm_mean_2sex<-SR_tempdorm_mean<-OSR_tempdorm_mean<-c()
ssd_tempdorm_mean<-matrix(NA,(F_params$max_size+1)*2,nrow(climat_tempdorm))
max_yrs <- 30

for (i in 1:nrow(climat_tempdorm)) {
    #linear model for comparison
  mat <- megamatrix_delay( F_params=F_params,
                           M_params=M_params,
                           twosex=F,
                           grow_perturb=0,
                           surv_perturb=0,
                           flow_perturb=0,
                           fert_perturb=0,
                           viab_perturb=0,
                           zpptgrow=0,
                           ztempgrow=0,
                           zpptdorm=0,
                           ztempdorm=climat_tempdorm[i,4],
                           rfx=rfx_fun())$MEGAmat
  lambda_tempdorm_mean[i] <- popbio::lambda(mat)
  # 2-sex model
  lambda_run <- lambdaSim_delay( F_params=F_params,
                                 M_params=M_params,
                                 grow_perturb=0,
                                 surv_perturb=0,
                                 flow_perturb=0,
                                 fert_perturb=0,
                                 viab_perturb=0,
                                 zpptgrow=0,
                                 ztempgrow=0,
                                 zpptdorm=0,
                                 ztempdorm=climat_tempdorm[i,4],
                                 rfx = rfx_fun(),
                                 max.yrs = max_yrs)
  lambda_tempdorm_mean_2sex[i] <- lambda_run$lambdatracker[max_yrs]
  SR_tempdorm_mean[i] <- lambda_run$SRtracker[max_yrs]
  OSR_tempdorm_mean[i] <- lambda_run$OSRtracker[max_yrs]
  ssd_tempdorm_mean[,i] <- lambda_run$n0
}

```

### Plot with all four variables for observed data

```{r}

fig1<-ggplot() +
  geom_line(aes(x=climat_ppt$pptgrow_seq*sd(poar_2015_2016$pptgrow)+mean(poar_2015_2016$pptgrow),y=lambda_pptgrow_mean), col = "#E69F00",size=1.2) +
  geom_line(aes(climat_ppt$pptgrow_seq*sd(poar_2015_2016$pptgrow)+mean(poar_2015_2016$pptgrow),lambda_pptgrow_mean_2sex), col = "#999999",size=1.2) +
  geom_hline(yintercept = 1, lty=2,color = "black")+
  xlab(" Precipitation (grow. season)") +
  ylab(expression(paste("Population growth rate, ", lambda))) +
  scale_y_continuous(breaks = c(0,1,2,3,4,5,6,7,8,9,10))+
  ggtitle("")+
  theme_bw() +
  theme(legend.position="none",
        panel.border = element_rect(colour = "black", fill=NA, size=0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(size = 9,color="black"),
        axis.title.y = element_text(size = 9,color="black")
  )

fig2<-ggplot() +
  geom_line(aes(x=climat_temp$tempgrow_seq*sd(poar_2015_2016$tempgrow)+mean(poar_2015_2016$tempgrow),y=lambda_tempgrow_mean), col = "#E69F00",size=1.2) +
  geom_line(aes(climat_temp$tempgrow_seq*sd(poar_2015_2016$tempgrow)+mean(poar_2015_2016$tempgrow),lambda_tempgrow_mean_2sex), col = "#999999",size=1.2) +
  geom_hline(yintercept = 1, lty=2,color = "black")+
  xlab(" Temperature (grow. season)") +
  ylab(expression(paste("Population growth rate, ", lambda))) +
  scale_y_continuous(breaks = c(0,1,2,3,4,5,6,7))+
  ggtitle("")+
  theme_bw() +
  theme(legend.position="none", 
        panel.border = element_rect(colour = "black", fill=NA, size=0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(size = 9,color="black"),
        axis.title.y = element_text(size = 9,color="black")
  )

fig3<-ggplot() +
  geom_line(aes(x=climat_pptdorm$pptdorm_seq*sd(poar_2015_2016$pptdorm)+mean(poar_2015_2016$pptdorm),y=lambda_pptdorm_mean), col = "#E69F00",size=1.2) +
  geom_line(aes(x=climat_pptdorm$pptdorm_seq*sd(poar_2015_2016$pptdorm)+mean(poar_2015_2016$pptdorm),y=lambda_pptdorm_mean_2sex), col = "#999999",size=1.2) +
  geom_hline(yintercept = 1, lty=2,color = "black")+
  xlab("Precipitation (dorm. season)") +
  ylab(expression(paste("Population growth rate, ", lambda))) +
  scale_y_continuous(breaks = c(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14))+
  ggtitle("")+
  theme_bw() +
  theme(legend.position="none", 
        panel.border = element_rect(colour = "black", fill=NA, size=0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(size = 9,color="black"),
        axis.title.y = element_text(size = 9,color="black")
  )

fig4<-ggplot() +
  geom_line(aes(x=climat_tempdorm$tempdorm_seq*sd(poar_2015_2016$tempdorm)+mean(poar_2015_2016$tempdorm),y=lambda_tempdorm_mean), col = "#E69F00",size=1.2) +
  geom_line(aes(x=climat_tempdorm$tempdorm_seq*sd(poar_2015_2016$tempdorm)+mean(poar_2015_2016$tempdorm),y=lambda_tempdorm_mean_2sex), col = "#999999",size=1.2) +
  geom_hline(yintercept = 1, lty=2,color = "black")+
  xlab("Temperature (dorm. season)") +
  ylab(expression(paste("Population growth rate, ", lambda))) +
  scale_y_continuous(breaks = c(0,1,2,3,4,5,6))+
  ggtitle("")+
  theme_bw() +
  theme(legend.position="none", 
        panel.border = element_rect(colour = "black", fill=NA, size=0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(size = 9,color="black"),
        axis.title.y = element_text(size = 9,color="black")
  )




pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/lambda.pdf",width=5,height=5,useDingbats = F)
(figure1 <- ggarrange(fig1, fig2,fig3,fig4,
                     hjust = -2, labels = c("A", "B","C","D"), common.legend = TRUE, legend = "right", font.label = list(size = 10, color = "black", face = "plain", family = NULL), vjust = 2, widths = c(2, 2), heights = 0.5, align = "hv",
                     ncol = 2, nrow = 2
))

dev.off()

```

# Lambda-climate posterior sampling

```{r}
library(doParallel)
library(foreach)
parallel::detectCores() # found out how many cores are available
n.cores <- parallel::detectCores() - 1 # define the number of cores we want to use
my.cluster <- parallel::makeCluster( # create the cluster
  n.cores, 
  type = "FORK" # FORK is about a 40% faster than PSOCK.FORK is  appropriate for only single-machine environments
  )
print(my.cluster)#check cluster definition (optional)
doParallel::registerDoParallel(cl = my.cluster) #register it to be used by %dopar%
foreach::getDoParRegistered() #check if it is registered (optional)
foreach::getDoParWorkers()#how many workers are available? (optional)
```

## Precipitation of growing season

```{r}
## set up output matrices
n_post_draws <- 300
post_draws <- sample.int(length(surv_coef$b0_s), n_post_draws)
pptgrow_seq <- seq(min(poar_2015_2016$zpptgrow),max(poar_2015_2016$zpptgrow),length.out=20)
max_yrs <- 30
lambda_pptgrow_post <- matrix(NA,nrow=n_post_draws,ncol=length(pptgrow_seq))

F_params <- M_params <- list()
Tpptgrow<-system.time(
  lambda_pptgrow_post<-foreach(p=1:n_post_draws,.combine='rbind') %:% 
foreach(l=1:length(pptgrow_seq), .combine='c')%dopar%{
  #set up param vectors
  ## survival
  F_params$surv_mu <- surv_coef$b0_s[post_draws[p]]
  F_params$surv_size <- surv_coef$bsize_s[post_draws[p]]
  F_params$surv_pptgrow <- surv_coef$bpptgrow_s[post_draws[p]] 
  F_params$surv_pptdorm <- surv_coef$bpptdorm_s[post_draws[p]] 
  F_params$surv_tempgrow <- surv_coef$btempgrow_s[post_draws[p]]
  F_params$surv_tempdorm <- surv_coef$btempdorm_s[post_draws[p]] 
  F_params$surv_tempgrow_pptgrow<-surv_coef$btempgrowpptgrow_s[post_draws[p]]
  F_params$surv_tempdorm_pptdorm<-surv_coef$btempdormpptdorm_s[post_draws[p]]
  F_params$surv_pptgrow2<-surv_coef$bpptgrow2_s[post_draws[p]]
  F_params$surv_pptdorm2<-surv_coef$bpptdorm2_s[post_draws[p]]
  F_params$surv_tempgrow2<-surv_coef$btempgrow2_s[post_draws[p]]
  F_params$surv_tempdorm2<-surv_coef$btempdorm2_s[post_draws[p]]
  M_params$surv_mu <- surv_coef$b0_s[post_draws[p]] + surv_coef$bsex_s[post_draws[p]]  
  M_params$surv_size <- surv_coef$bsize_s[post_draws[p]] + surv_coef$bsizesex_s[post_draws[p]]
  M_params$surv_pptgrow <- surv_coef$bpptgrow_s[post_draws[p]]  + surv_coef$bpptgrowsex_s[post_draws[p]] 
  M_params$surv_tempgrow <- surv_coef$btempgrow_s[post_draws[p]] + surv_coef$btempgrowsex_s[post_draws[p]] 
  M_params$surv_pptdorm <- surv_coef$bpptdorm_s[post_draws[p]] + surv_coef$bpptdormsex_s[post_draws[p]] 
  M_params$surv_tempdorm <- surv_coef$btempdorm_s[post_draws[p]] + surv_coef$btempdormsex_s[post_draws[p]]
  M_params$surv_tempgrow_pptgrow<-surv_coef$btempgrowpptgrow_s[post_draws[p]] + surv_coef$btempgrowpptgrowsex_s[post_draws[p]]
  M_params$surv_tempdorm_pptdorm<-surv_coef$btempdormpptdorm_s[post_draws[p]] + surv_coef$btempdormpptdormsex_s[post_draws[p]]
  M_params$surv_pptgrow2<-surv_coef$bpptgrow2_s[post_draws[p]] + surv_coef$bpptgrow2sex_s[post_draws[p]]
  M_params$surv_tempgrow2<-surv_coef$btempgrow2_s[post_draws[p]] + surv_coef$btempgrow2sex_s[post_draws[p]]
  M_params$surv_pptdorm2<-surv_coef$bpptdorm2_s[post_draws[p]] + surv_coef$bpptdorm2sex_s[post_draws[p]]
  M_params$surv_tempdorm2<-surv_coef$btempdorm2_s[post_draws[p]] + surv_coef$btempdorm2sex_s[post_draws[p]]
  ## growth
  F_params$grow_mu <- grow_coef$b0_g[post_draws[p]]
  F_params$grow_size <- grow_coef$bsize_g[post_draws[p]]
  F_params$grow_pptgrow <- grow_coef$bpptgrow_g[post_draws[p]] 
  F_params$grow_pptdorm <- grow_coef$bpptdorm_g[post_draws[p]]
  F_params$grow_tempgrow <- grow_coef$btempgrow_g[post_draws[p]] 
  F_params$grow_tempdorm <- grow_coef$btempdorm_g[post_draws[p]] 
  F_params$grow_tempgrow_pptgrow<-grow_coef$btempgrowpptgrow_g[post_draws[p]]
  F_params$grow_tempdorm_pptdorm<-grow_coef$btempdormpptdorm_g[post_draws[p]] 
  F_params$grow_pptgrow2<-grow_coef$bpptgrow2_g[post_draws[p]]
  F_params$grow_tempgrow2<-grow_coef$btempgrow2_g[post_draws[p]]
  F_params$grow_pptdorm2<-grow_coef$bpptdorm2_g[post_draws[p]] 
  F_params$grow_tempdorm2<-grow_coef$btempdorm2_g[post_draws[p]] 
  F_params$sigma_g <- grow_coef$sigma[post_draws[p]] 
  M_params$grow_mu <- grow_coef$b0_g[post_draws[p]] + grow_coef$bsex_g[post_draws[p]]  
  M_params$grow_size <- grow_coef$bsize_g[post_draws[p]] + grow_coef$bsizesex_g[post_draws[p]]
  M_params$grow_pptgrow <- grow_coef$bpptgrow_g[post_draws[p]]  + grow_coef$bpptgrowsex_g[post_draws[p]] 
  M_params$grow_pptdorm <- grow_coef$bpptdorm_g[post_draws[p]]  + grow_coef$bpptdormsex_g[post_draws[p]] 
  M_params$grow_tempgrow <- grow_coef$btempgrow_g[post_draws[p]] + grow_coef$btempgrowsex_g[post_draws[p]] 
  M_params$grow_tempdorm <- grow_coef$btempdorm_g[post_draws[p]] + grow_coef$btempdormsex_g[post_draws[p]]
  M_params$grow_tempgrow_pptgrow<-grow_coef$btempgrowpptgrow_g[post_draws[p]] + grow_coef$btempgrowpptgrowsex_g[post_draws[p]]
  M_params$grow_tempdorm_pptdorm<-grow_coef$btempdormpptdorm_g[post_draws[p]] + grow_coef$btempdormpptdormsex_g[post_draws[p]]
  M_params$grow_pptgrow2<-grow_coef$bpptgrow2_g[post_draws[p]] + grow_coef$bpptgrow2sex_g[post_draws[p]]
  M_params$grow_tempgrow2<-grow_coef$btempgrow2_g[post_draws[p]] + grow_coef$btempgrow2sex_g[post_draws[p]]
  M_params$grow_pptdorm2<-grow_coef$bpptdorm2_g[post_draws[p]] + grow_coef$bpptdorm2sex_g[post_draws[p]]
  M_params$grow_tempdorm2<-grow_coef$btempdorm2_g[post_draws[p]] + grow_coef$btempdorm2sex_g[post_draws[p]]
  M_params$sigma_g <- grow_coef$sigma[post_draws[p]] 
  ## flowering
  F_params$flow_mu <- flow_coef$b0_f[post_draws[p]]
  F_params$flow_size <- flow_coef$bsize_f[post_draws[p]]
  F_params$flow_pptgrow <- flow_coef$bpptgrow_f[post_draws[p]] 
  F_params$flow_tempgrow <- flow_coef$btempgrow_f[post_draws[p]] 
  F_params$flow_tempdorm <- flow_coef$btempdorm_f[post_draws[p]] 
  F_params$flow_pptdorm <- flow_coef$bpptdorm_f[post_draws[p]]
  F_params$flow_tempgrow_pptgrow<-flow_coef$btempgrowpptgrow_f[post_draws[p]]
  F_params$flow_tempdorm_pptdorm<-flow_coef$btempdormpptdorm_f[post_draws[p]]
  F_params$flow_pptgrow2<-flow_coef$bpptgrow2_f[post_draws[p]]
  F_params$flow_pptdorm2<-flow_coef$bpptdorm2_f[post_draws[p]]
  F_params$flow_tempgrow2<-flow_coef$btempgrow2_f[post_draws[p]]
  F_params$flow_tempdorm2<-flow_coef$btempdorm2_f[post_draws[p]]
  M_params$flow_mu <- flow_coef$b0_f[post_draws[p]] + flow_coef$bsex_f[post_draws[p]]  
  M_params$flow_size <- flow_coef$bsize_f[post_draws[p]] + flow_coef$bsizesex_f[post_draws[p]]
  M_params$flow_pptgrow <- flow_coef$bpptgrow_f[post_draws[p]]  + flow_coef$bpptgrowsex_f[post_draws[p]] 
  M_params$flow_tempgrow <- flow_coef$btempgrow_f[post_draws[p]] + flow_coef$btempgrowsex_f[post_draws[p]]
  M_params$flow_tempdorm <- flow_coef$btempdorm_f[post_draws[p]] +  flow_coef$btempdormsex_f[post_draws[p]]  
  M_params$flow_pptdorm <- flow_coef$bpptdorm_f[post_draws[p]] + flow_coef$bpptdormsex_f[post_draws[p]] 
  M_params$flow_tempgrow_pptgrow<-flow_coef$btempgrowpptgrow_f[post_draws[p]] + flow_coef$btempgrowpptgrowsex_f[post_draws[p]]
  M_params$flow_tempdorm_pptdorm<-flow_coef$btempdormpptdorm_f[post_draws[p]] + flow_coef$btempdormpptdormsex_f[post_draws[p]]
  M_params$flow_pptgrow2<-flow_coef$bpptgrow2_f[post_draws[p]] + flow_coef$bpptgrow2sex_f[post_draws[p]]
  M_params$flow_tempgrow2<-flow_coef$btempgrow2_f[post_draws[p]] + flow_coef$btempgrow2sex_f[post_draws[p]]
  M_params$flow_pptdorm2<-flow_coef$bpptdorm2_f[post_draws[p]] +  flow_coef$bpptdorm2sex_f[post_draws[p]]
  M_params$flow_tempdorm2<-flow_coef$btempdorm2_f[post_draws[p]] + flow_coef$btempdorm2sex_f[post_draws[p]]
  ## panicles
  F_params$panic_mu <- panic_coef$b0_p[post_draws[p]]
  F_params$panic_size <- panic_coef$bsize_p[post_draws[p]]
  F_params$panic_pptgrow <- panic_coef$bpptgrow_p[post_draws[p]] 
  F_params$panic_tempgrow <- panic_coef$btempgrow_p[post_draws[p]] 
  F_params$panic_tempdorm <- panic_coef$btempdorm_p[post_draws[p]] 
  F_params$panic_pptdorm <- panic_coef$bpptdorm_p[post_draws[p]]
  F_params$panic_tempgrow_pptgrow<-panic_coef$btempgrowpptgrow_p[post_draws[p]]
  F_params$panic_tempdorm_pptdorm<-panic_coef$btempdormpptdorm_p[post_draws[p]]
  F_params$panic_pptgrow2<-panic_coef$bpptgrow2_p[post_draws[p]]
  F_params$panic_tempgrow2<-panic_coef$btempgrow2_p[post_draws[p]]
  F_params$panic_pptdorm2<-panic_coef$bpptdorm2_p[post_draws[p]]
  F_params$panic_tempdorm2<-panic_coef$btempdorm2_p[post_draws[p]]
  M_params$panic_mu <- panic_coef$b0_p[post_draws[p]] + panic_coef$bsex_p[post_draws[p]]  
  M_params$panic_size <- panic_coef$bsize_p[post_draws[p]] + panic_coef$bsizesex_p[post_draws[p]]
  M_params$panic_pptgrow <- panic_coef$bpptgrow_p[post_draws[p]]  + panic_coef$bpptgrowsex_p[post_draws[p]] 
  M_params$panic_tempgrow <- panic_coef$btempgrow_p[post_draws[p]] + panic_coef$btempgrowsex_p[post_draws[p]]
  M_params$panic_tempdorm <- panic_coef$btempdorm_p[post_draws[p]] +  panic_coef$btempdormsex_p[post_draws[p]]  
  M_params$panic_pptdorm <- panic_coef$bpptdorm_p[post_draws[p]] + panic_coef$bpptdormsex_p[post_draws[p]] 
  M_params$panic_tempgrow_pptgrow<-panic_coef$btempgrowpptgrow_p[post_draws[p]] + panic_coef$btempgrowpptgrowsex_p[post_draws[p]]
  M_params$panic_tempdorm_pptdorm<-panic_coef$btempdormpptdorm_p[post_draws[p]] + panic_coef$btempdormpptdormsex_p[post_draws[p]]
  M_params$panic_pptgrow2<-panic_coef$bpptgrow2_p[post_draws[p]] + panic_coef$bpptgrow2sex_p[post_draws[p]]
  M_params$panic_tempgrow2<-panic_coef$btempgrow2_p[post_draws[p]] + panic_coef$btempgrow2sex_p[post_draws[p]]
  M_params$panic_pptdorm2<-panic_coef$bpptdorm2_p[post_draws[p]] + panic_coef$bpptdorm2sex_p[post_draws[p]]
  M_params$panic_tempdorm2<-panic_coef$btempdorm2_p[post_draws[p]] + panic_coef$btempdorm2sex_p[post_draws[p]]
  ## seed viability and misc fertility params
  F_params$v0 <- via_coef$v0[post_draws[p]] 
  F_params$a_v <- via_coef$a_v[post_draws[p]] 
  F_params$ov_per_inf <- via_coef$lambda_d[post_draws[p]] 
  F_params$germ <- via_coef$m[post_draws[p]] 
  F_params$PSR <- 0.5
  ## use POAU seedling survival for females and males
  F_params$sdlg_surv <- M_params$sdlg_surv <- sdlg_surv$sdlg_surv
  ## set max size equal between the sexes
  F_params$max_size <- M_params$max_size <- round(quantile(na.omit((poar.clim_seasonal$tillerN_t1)),probs=0.95))
  ## pull out the rfx variances
  rfx <- rfx_fun(site_tau_s = surv_coef$site_tau_s[post_draws[p]],
                block_tau_s = surv_coef$block_tau_s[post_draws[p]],
                source_tau_s = surv_coef$source_tau_s[post_draws[p]],
                site_tau_g = grow_coef$site_tau_g[post_draws[p]],
                block_tau_g = grow_coef$block_tau_g[post_draws[p]],
                source_tau_g = grow_coef$source_tau_g[post_draws[p]],
                site_tau_f = flow_coef$site_tau_f[post_draws[p]],
                block_tau_f = flow_coef$block_tau_f[post_draws[p]],
                source_tau_f = flow_coef$source_tau_f[post_draws[p]],
                site_tau_p = panic_coef$site_tau_p[post_draws[p]],
                block_tau_p = panic_coef$block_tau_p[post_draws[p]],
                source_tau_p = panic_coef$source_tau_p[post_draws[p]])
   #Estimation error only
   lambda_run_rfx <- lambdaSim_delay(F_params=F_params,M_params=M_params,zpptgrow=pptgrow_seq[l],ztempgrow=0,zpptdorm=0,ztempdorm=0,rfx=rfx_fun(),max.yrs=max_yrs)
   lambda_run_rfx$lambdatracker[max_yrs]
 }
)
## write output as a list
lambda_pptgrow_post_list <- list(lambda_pptgrow_post=lambda_pptgrow_post)

write_rds(lambda_pptgrow_post_list,"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/Posterior/lambda_pptgrow_post_list.rds")
```

```{r}
# read in results of the above loop
lambda_pptgrow_post_list <- readRDS(url("https://www.dropbox.com/scl/fi/hxq7kzivw1x6lsqy7wzjv/lambda_pptgrow_post_list.rds?rlkey=6bjeg1amxxp9i4rz1wvjkpgfo&dl=1"))
```

```{r}
## visualize results
lambda_pptgrow_q95 <- lambda_pptgrow_q75 <- lambda_pptgrow_q50 <- lambda_pptgrow_q25 <- lambda_pptgrow_q5 <- matrix(NA,2,length(pptgrow_seq))
lambda_pptgrow_mean <- c()
for(l in 1:length(pptgrow_seq)){
  lambda_pptgrow_q95[,l] <- quantile(lambda_pptgrow_post_list$lambda_pptgrow_post[,l],probs=c(0.025,0.975),na.rm = T)
  lambda_pptgrow_q75[,l] <- quantile(lambda_pptgrow_post_list$lambda_pptgrow_post[,l],probs=c(0.125,0.875),na.rm = T)
  lambda_pptgrow_q50[,l] <- quantile(lambda_pptgrow_post_list$lambda_pptgrow_post[,l],probs=c(0.25,0.75),na.rm = T)
  lambda_pptgrow_q25[,l] <- quantile(lambda_pptgrow_post_list$lambda_pptgrow_post[,l],probs=c(0.375,0.625),na.rm = T)
  lambda_pptgrow_q5[,l] <- quantile(lambda_pptgrow_post_list$lambda_pptgrow_post[,l],probs=c(0.475,0.525),na.rm = T)
  lambda_pptgrow_mean[l] <- mean(lambda_pptgrow_post_list$lambda_pptgrow_post[,l],na.rm = T)
}
```

## Temperature of growing season

```{r}
## set up output matrices
n_post_draws <- 300
post_draws <- sample.int(length(surv_coef$b0_s), n_post_draws)
tempgrow_seq <- seq(min(poar_2015_2016$ztempgrow),max(poar_2015_2016$ztempgrow),length.out=20)
max_yrs <- 30
lambda_tempgrow_post <- matrix(NA,nrow=n_post_draws,ncol=length(tempgrow_seq))

F_params <- M_params <- list()
TTG<-system.time(lambda_tempgrow_post<-foreach(p=1:n_post_draws,.combine='rbind')%:%
foreach(l=1:length(tempgrow_seq),.combine='c')%dopar%{
  #set up param vectors
  ## survival
  F_params$surv_mu <- surv_coef$b0_s[post_draws[p]]
  F_params$surv_size <- surv_coef$bsize_s[post_draws[p]]
  F_params$surv_pptgrow <- surv_coef$bpptgrow_s[post_draws[p]] 
  F_params$surv_pptdorm <- surv_coef$bpptdorm_s[post_draws[p]] 
  F_params$surv_tempgrow <- surv_coef$btempgrow_s[post_draws[p]]
  F_params$surv_tempdorm <- surv_coef$btempdorm_s[post_draws[p]] 
  F_params$surv_tempgrow_pptgrow<-surv_coef$btempgrowpptgrow_s[post_draws[p]]
  F_params$surv_tempdorm_pptdorm<-surv_coef$btempdormpptdorm_s[post_draws[p]]
  F_params$surv_pptgrow2<-surv_coef$bpptgrow2_s[post_draws[p]]
  F_params$surv_pptdorm2<-surv_coef$bpptdorm2_s[post_draws[p]]
  F_params$surv_tempgrow2<-surv_coef$btempgrow2_s[post_draws[p]]
  F_params$surv_tempdorm2<-surv_coef$btempdorm2_s[post_draws[p]]
  M_params$surv_mu <- surv_coef$b0_s[post_draws[p]] + surv_coef$bsex_s[post_draws[p]]  
  M_params$surv_size <- surv_coef$bsize_s[post_draws[p]] + surv_coef$bsizesex_s[post_draws[p]]
  M_params$surv_pptgrow <- surv_coef$bpptgrow_s[post_draws[p]]  + surv_coef$bpptgrowsex_s[post_draws[p]] 
  M_params$surv_tempgrow <- surv_coef$btempgrow_s[post_draws[p]] + surv_coef$btempgrowsex_s[post_draws[p]] 
  M_params$surv_pptdorm <- surv_coef$bpptdorm_s[post_draws[p]] + surv_coef$bpptdormsex_s[post_draws[p]] 
  M_params$surv_tempdorm <- surv_coef$btempdorm_s[post_draws[p]] + surv_coef$btempdormsex_s[post_draws[p]]
  M_params$surv_tempgrow_pptgrow<-surv_coef$btempgrowpptgrow_s[post_draws[p]] + surv_coef$btempgrowpptgrowsex_s[post_draws[p]]
  M_params$surv_tempdorm_pptdorm<-surv_coef$btempdormpptdorm_s[post_draws[p]] + surv_coef$btempdormpptdormsex_s[post_draws[p]]
  M_params$surv_pptgrow2<-surv_coef$bpptgrow2_s[post_draws[p]] + surv_coef$bpptgrow2sex_s[post_draws[p]]
  M_params$surv_tempgrow2<-surv_coef$btempgrow2_s[post_draws[p]] + surv_coef$btempgrow2sex_s[post_draws[p]]
  M_params$surv_pptdorm2<-surv_coef$bpptdorm2_s[post_draws[p]] + surv_coef$bpptdorm2sex_s[post_draws[p]]
  M_params$surv_tempdorm2<-surv_coef$btempdorm2_s[post_draws[p]] + surv_coef$btempdorm2sex_s[post_draws[p]]
  ## growth
  F_params$grow_mu <- grow_coef$b0_g[post_draws[p]]
  F_params$grow_size <- grow_coef$bsize_g[post_draws[p]]
  F_params$grow_pptgrow <- grow_coef$bpptgrow_g[post_draws[p]] 
  F_params$grow_pptdorm <- grow_coef$bpptdorm_g[post_draws[p]]
  F_params$grow_tempgrow <- grow_coef$btempgrow_g[post_draws[p]] 
  F_params$grow_tempdorm <- grow_coef$btempdorm_g[post_draws[p]] 
  F_params$grow_tempgrow_pptgrow<-grow_coef$btempgrowpptgrow_g[post_draws[p]]
  F_params$grow_tempdorm_pptdorm<-grow_coef$btempdormpptdorm_g[post_draws[p]] 
  F_params$grow_pptgrow2<-grow_coef$bpptgrow2_g[post_draws[p]]
  F_params$grow_tempgrow2<-grow_coef$btempgrow2_g[post_draws[p]]
  F_params$grow_pptdorm2<-grow_coef$bpptdorm2_g[post_draws[p]] 
  F_params$grow_tempdorm2<-grow_coef$btempdorm2_g[post_draws[p]] 
  F_params$sigma_g <- grow_coef$sigma[post_draws[p]] 
  M_params$grow_mu <- grow_coef$b0_g[post_draws[p]] + grow_coef$bsex_g[post_draws[p]]  
  M_params$grow_size <- grow_coef$bsize_g[post_draws[p]] + grow_coef$bsizesex_g[post_draws[p]]
  M_params$grow_pptgrow <- grow_coef$bpptgrow_g[post_draws[p]]  + grow_coef$bpptgrowsex_g[post_draws[p]] 
  M_params$grow_pptdorm <- grow_coef$bpptdorm_g[post_draws[p]]  + grow_coef$bpptdormsex_g[post_draws[p]] 
  M_params$grow_tempgrow <- grow_coef$btempgrow_g[post_draws[p]] + grow_coef$btempgrowsex_g[post_draws[p]] 
  M_params$grow_tempdorm <- grow_coef$btempdorm_g[post_draws[p]] + grow_coef$btempdormsex_g[post_draws[p]]
  M_params$grow_tempgrow_pptgrow<-grow_coef$btempgrowpptgrow_g[post_draws[p]] + grow_coef$btempgrowpptgrowsex_g[post_draws[p]]
  M_params$grow_tempdorm_pptdorm<-grow_coef$btempdormpptdorm_g[post_draws[p]] + grow_coef$btempdormpptdormsex_g[post_draws[p]]
  M_params$grow_pptgrow2<-grow_coef$bpptgrow2_g[post_draws[p]] + grow_coef$bpptgrow2sex_g[post_draws[p]]
  M_params$grow_tempgrow2<-grow_coef$btempgrow2_g[post_draws[p]] + grow_coef$btempgrow2sex_g[post_draws[p]]
  M_params$grow_pptdorm2<-grow_coef$bpptdorm2_g[post_draws[p]] + grow_coef$bpptdorm2sex_g[post_draws[p]]
  M_params$grow_tempdorm2<-grow_coef$btempdorm2_g[post_draws[p]] + grow_coef$btempdorm2sex_g[post_draws[p]]
  M_params$sigma_g <- grow_coef$sigma[post_draws[p]] 
  ## flowering
  F_params$flow_mu <- flow_coef$b0_f[post_draws[p]]
  F_params$flow_size <- flow_coef$bsize_f[post_draws[p]]
  F_params$flow_pptgrow <- flow_coef$bpptgrow_f[post_draws[p]] 
  F_params$flow_tempgrow <- flow_coef$btempgrow_f[post_draws[p]] 
  F_params$flow_tempdorm <- flow_coef$btempdorm_f[post_draws[p]] 
  F_params$flow_pptdorm <- flow_coef$bpptdorm_f[post_draws[p]]
  F_params$flow_tempgrow_pptgrow<-flow_coef$btempgrowpptgrow_f[post_draws[p]]
  F_params$flow_tempdorm_pptdorm<-flow_coef$btempdormpptdorm_f[post_draws[p]]
  F_params$flow_pptgrow2<-flow_coef$bpptgrow2_f[post_draws[p]]
  F_params$flow_pptdorm2<-flow_coef$bpptdorm2_f[post_draws[p]]
  F_params$flow_tempgrow2<-flow_coef$btempgrow2_f[post_draws[p]]
  F_params$flow_tempdorm2<-flow_coef$btempdorm2_f[post_draws[p]]
  M_params$flow_mu <- flow_coef$b0_f[post_draws[p]] + flow_coef$bsex_f[post_draws[p]]  
  M_params$flow_size <- flow_coef$bsize_f[post_draws[p]] + flow_coef$bsizesex_f[post_draws[p]]
  M_params$flow_pptgrow <- flow_coef$bpptgrow_f[post_draws[p]]  + flow_coef$bpptgrowsex_f[post_draws[p]] 
  M_params$flow_tempgrow <- flow_coef$btempgrow_f[post_draws[p]] + flow_coef$btempgrowsex_f[post_draws[p]]
  M_params$flow_tempdorm <- flow_coef$btempdorm_f[post_draws[p]] +  flow_coef$btempdormsex_f[post_draws[p]]  
  M_params$flow_pptdorm <- flow_coef$bpptdorm_f[post_draws[p]] + flow_coef$bpptdormsex_f[post_draws[p]] 
  M_params$flow_tempgrow_pptgrow<-flow_coef$btempgrowpptgrow_f[post_draws[p]] + flow_coef$btempgrowpptgrowsex_f[post_draws[p]]
  M_params$flow_tempdorm_pptdorm<-flow_coef$btempdormpptdorm_f[post_draws[p]] + flow_coef$btempdormpptdormsex_f[post_draws[p]]
  M_params$flow_pptgrow2<-flow_coef$bpptgrow2_f[post_draws[p]] + flow_coef$bpptgrow2sex_f[post_draws[p]]
  M_params$flow_tempgrow2<-flow_coef$btempgrow2_f[post_draws[p]] + flow_coef$btempgrow2sex_f[post_draws[p]]
  M_params$flow_pptdorm2<-flow_coef$bpptdorm2_f[post_draws[p]] +  flow_coef$bpptdorm2sex_f[post_draws[p]]
  M_params$flow_tempdorm2<-flow_coef$btempdorm2_f[post_draws[p]] + flow_coef$btempdorm2sex_f[post_draws[p]]
  ## panicles
  F_params$panic_mu <- panic_coef$b0_p[post_draws[p]]
  F_params$panic_size <- panic_coef$bsize_p[post_draws[p]]
  F_params$panic_pptgrow <- panic_coef$bpptgrow_p[post_draws[p]] 
  F_params$panic_tempgrow <- panic_coef$btempgrow_p[post_draws[p]] 
  F_params$panic_tempdorm <- panic_coef$btempdorm_p[post_draws[p]] 
  F_params$panic_pptdorm <- panic_coef$bpptdorm_p[post_draws[p]]
  F_params$panic_tempgrow_pptgrow<-panic_coef$btempgrowpptgrow_p[post_draws[p]]
  F_params$panic_tempdorm_pptdorm<-panic_coef$btempdormpptdorm_p[post_draws[p]]
  F_params$panic_pptgrow2<-panic_coef$bpptgrow2_p[post_draws[p]]
  F_params$panic_tempgrow2<-panic_coef$btempgrow2_p[post_draws[p]]
  F_params$panic_pptdorm2<-panic_coef$bpptdorm2_p[post_draws[p]]
  F_params$panic_tempdorm2<-panic_coef$btempdorm2_p[post_draws[p]]
  M_params$panic_mu <- panic_coef$b0_p[post_draws[p]] + panic_coef$bsex_p[post_draws[p]]  
  M_params$panic_size <- panic_coef$bsize_p[post_draws[p]] + panic_coef$bsizesex_p[post_draws[p]]
  M_params$panic_pptgrow <- panic_coef$bpptgrow_p[post_draws[p]]  + panic_coef$bpptgrowsex_p[post_draws[p]] 
  M_params$panic_tempgrow <- panic_coef$btempgrow_p[post_draws[p]] + panic_coef$btempgrowsex_p[post_draws[p]]
  M_params$panic_tempdorm <- panic_coef$btempdorm_p[post_draws[p]] +  panic_coef$btempdormsex_p[post_draws[p]]  
  M_params$panic_pptdorm <- panic_coef$bpptdorm_p[post_draws[p]] + panic_coef$bpptdormsex_p[post_draws[p]] 
  M_params$panic_tempgrow_pptgrow<-panic_coef$btempgrowpptgrow_p[post_draws[p]] + panic_coef$btempgrowpptgrowsex_p[post_draws[p]]
  M_params$panic_tempdorm_pptdorm<-panic_coef$btempdormpptdorm_p[post_draws[p]] + panic_coef$btempdormpptdormsex_p[post_draws[p]]
  M_params$panic_pptgrow2<-panic_coef$bpptgrow2_p[post_draws[p]] + panic_coef$bpptgrow2sex_p[post_draws[p]]
  M_params$panic_tempgrow2<-panic_coef$btempgrow2_p[post_draws[p]] + panic_coef$btempgrow2sex_p[post_draws[p]]
  M_params$panic_pptdorm2<-panic_coef$bpptdorm2_p[post_draws[p]] + panic_coef$bpptdorm2sex_p[post_draws[p]]
  M_params$panic_tempdorm2<-panic_coef$btempdorm2_p[post_draws[p]] + panic_coef$btempdorm2sex_p[post_draws[p]]
  ## seed viability and misc fertility params
  F_params$v0 <- via_coef$v0[post_draws[p]] 
  F_params$a_v <- via_coef$a_v[post_draws[p]] 
  F_params$ov_per_inf <- via_coef$lambda_d[post_draws[p]] 
  F_params$germ <- via_coef$m[post_draws[p]] 
  F_params$PSR <- 0.5
  ## use POAU seedling survival for females and males
  F_params$sdlg_surv <- M_params$sdlg_surv <- sdlg_surv$sdlg_surv
  ## set max size equal between the sexes
  F_params$max_size <- M_params$max_size <- round(quantile(na.omit((poar.clim_seasonal$tillerN_t1)),probs=0.95))
  ## pull out the rfx variances
  rfx <- rfx_fun(site_tau_s = surv_coef$site_tau_s[post_draws[p]],
                block_tau_s = surv_coef$block_tau_s[post_draws[p]],
                source_tau_s = surv_coef$source_tau_s[post_draws[p]],
                site_tau_g = grow_coef$site_tau_g[post_draws[p]],
                block_tau_g = grow_coef$block_tau_g[post_draws[p]],
                source_tau_g = grow_coef$source_tau_g[post_draws[p]],
                site_tau_f = flow_coef$site_tau_f[post_draws[p]],
                block_tau_f = flow_coef$block_tau_f[post_draws[p]],
                source_tau_f = flow_coef$source_tau_f[post_draws[p]],
                site_tau_p = panic_coef$site_tau_p[post_draws[p]],
                block_tau_p = panic_coef$block_tau_p[post_draws[p]],
                source_tau_p = panic_coef$source_tau_p[post_draws[p]])
   #Estimation+process error
   lambda_run_rfx <- lambdaSim_delay(F_params=F_params,M_params=M_params,zpptgrow=0,ztempgrow=tempgrow_seq[l],zpptdorm=0,ztempdorm=0,rfx=rfx_fun(),max.yrs=max_yrs)
  lambda_run_rfx$lambdatracker[max_yrs]
 }
)
## write output as a list
lambda_tempgrow_post_list <- list(lambda_tempgrow_post_rfx=lambda_tempgrow_post)

write_rds(lambda_tempgrow_post_list,"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/Posterior/lambda_tempgrow_post_list.rds")
```

```{r}
# read in results of the above loop
lambda_tempgrow_post_list <- readRDS(url("https://www.dropbox.com/scl/fi/gnbtwg2wp5mvpuxdk7ey3/lambda_tempgrow_post_list.rds?rlkey=l09nnyrnavzof7gfvqy9sq7hg&dl=1"))
```

```{r}
lambda_tempgrow_q95 <- lambda_tempgrow_q75 <- lambda_tempgrow_q50 <- lambda_tempgrow_q25 <- lambda_tempgrow_q5 <- matrix(NA,2,length(tempgrow_seq))
lambda_tempgrow_mean <- lambda_tempgrow_rfx_mean <- c()
for(l in 1:length(tempgrow_seq)){
  lambda_tempgrow_q95[,l] <- quantile(lambda_tempgrow_post_list$lambda_tempgrow_post[,l],probs=c(0.025,0.975),na.rm = T)
  lambda_tempgrow_q75[,l] <- quantile(lambda_tempgrow_post_list$lambda_tempgrow_post[,l],probs=c(0.125,0.875),na.rm = T)
  lambda_tempgrow_q50[,l] <- quantile(lambda_tempgrow_post_list$lambda_tempgrow_post[,l],probs=c(0.25,0.75),na.rm = T)
  lambda_tempgrow_q25[,l] <- quantile(lambda_tempgrow_post_list$lambda_tempgrow_post[,l],probs=c(0.375,0.625),na.rm = T)
  lambda_tempgrow_q5[,l] <- quantile(lambda_tempgrow_post_list$lambda_tempgrow_post[,l],probs=c(0.475,0.525),na.rm = T)
  lambda_tempgrow_mean[l] <- mean(lambda_tempgrow_post_list$lambda_tempgrow_post[,l],na.rm = T)
}

```

# Precipitation of dormant season

```{r,eval=FALSE}
## set up output matrices
n_post_draws <- 300
post_draws <- sample.int(length(surv_coef$b0_s), n_post_draws)
pptdorm_seq <- seq(min(poar_2015_2016$zpptdorm),max(poar_2015_2016$zpptdorm),length.out=20)
max_yrs <- 30
lambda_pptdorm_post <- matrix(NA,nrow=n_post_draws,ncol=length(pptdorm_seq))

F_params <- M_params <- list()
TPD<-system.time(
lambda_pptdorm_post<-foreach(p=1:n_post_draws,.combine='rbind')%:%
   foreach(l=1:length(pptdorm_seq),.combine='c')%dopar% {
  #set up param vectors
  ## survival
  F_params$surv_mu <- surv_coef$b0_s[post_draws[p]]
  F_params$surv_size <- surv_coef$bsize_s[post_draws[p]]
  F_params$surv_pptgrow <- surv_coef$bpptgrow_s[post_draws[p]] 
  F_params$surv_pptdorm <- surv_coef$bpptdorm_s[post_draws[p]] 
  F_params$surv_tempgrow <- surv_coef$btempgrow_s[post_draws[p]]
  F_params$surv_tempdorm <- surv_coef$btempdorm_s[post_draws[p]] 
  F_params$surv_tempgrow_pptgrow<-surv_coef$btempgrowpptgrow_s[post_draws[p]]
  F_params$surv_tempdorm_pptdorm<-surv_coef$btempdormpptdorm_s[post_draws[p]]
  F_params$surv_pptgrow2<-surv_coef$bpptgrow2_s[post_draws[p]]
  F_params$surv_pptdorm2<-surv_coef$bpptdorm2_s[post_draws[p]]
  F_params$surv_tempgrow2<-surv_coef$btempgrow2_s[post_draws[p]]
  F_params$surv_tempdorm2<-surv_coef$btempdorm2_s[post_draws[p]]
  M_params$surv_mu <- surv_coef$b0_s[post_draws[p]] + surv_coef$bsex_s[post_draws[p]]  
  M_params$surv_size <- surv_coef$bsize_s[post_draws[p]] + surv_coef$bsizesex_s[post_draws[p]]
  M_params$surv_pptgrow <- surv_coef$bpptgrow_s[post_draws[p]]  + surv_coef$bpptgrowsex_s[post_draws[p]] 
  M_params$surv_tempgrow <- surv_coef$btempgrow_s[post_draws[p]] + surv_coef$btempgrowsex_s[post_draws[p]] 
  M_params$surv_pptdorm <- surv_coef$bpptdorm_s[post_draws[p]] + surv_coef$bpptdormsex_s[post_draws[p]] 
  M_params$surv_tempdorm <- surv_coef$btempdorm_s[post_draws[p]] + surv_coef$btempdormsex_s[post_draws[p]]
  M_params$surv_tempgrow_pptgrow<-surv_coef$btempgrowpptgrow_s[post_draws[p]] + surv_coef$btempgrowpptgrowsex_s[post_draws[p]]
  M_params$surv_tempdorm_pptdorm<-surv_coef$btempdormpptdorm_s[post_draws[p]] + surv_coef$btempdormpptdormsex_s[post_draws[p]]
  M_params$surv_pptgrow2<-surv_coef$bpptgrow2_s[post_draws[p]] + surv_coef$bpptgrow2sex_s[post_draws[p]]
  M_params$surv_tempgrow2<-surv_coef$btempgrow2_s[post_draws[p]] + surv_coef$btempgrow2sex_s[post_draws[p]]
  M_params$surv_pptdorm2<-surv_coef$bpptdorm2_s[post_draws[p]] + surv_coef$bpptdorm2sex_s[post_draws[p]]
  M_params$surv_tempdorm2<-surv_coef$btempdorm2_s[post_draws[p]] + surv_coef$btempdorm2sex_s[post_draws[p]]
  ## growth
  F_params$grow_mu <- grow_coef$b0_g[post_draws[p]]
  F_params$grow_size <- grow_coef$bsize_g[post_draws[p]]
  F_params$grow_pptgrow <- grow_coef$bpptgrow_g[post_draws[p]] 
  F_params$grow_pptdorm <- grow_coef$bpptdorm_g[post_draws[p]]
  F_params$grow_tempgrow <- grow_coef$btempgrow_g[post_draws[p]] 
  F_params$grow_tempdorm <- grow_coef$btempdorm_g[post_draws[p]] 
  F_params$grow_tempgrow_pptgrow<-grow_coef$btempgrowpptgrow_g[post_draws[p]]
  F_params$grow_tempdorm_pptdorm<-grow_coef$btempdormpptdorm_g[post_draws[p]] 
  F_params$grow_pptgrow2<-grow_coef$bpptgrow2_g[post_draws[p]]
  F_params$grow_tempgrow2<-grow_coef$btempgrow2_g[post_draws[p]]
  F_params$grow_pptdorm2<-grow_coef$bpptdorm2_g[post_draws[p]] 
  F_params$grow_tempdorm2<-grow_coef$btempdorm2_g[post_draws[p]] 
  F_params$sigma_g <- grow_coef$sigma[post_draws[p]] 
  M_params$grow_mu <- grow_coef$b0_g[post_draws[p]] + grow_coef$bsex_g[post_draws[p]]  
  M_params$grow_size <- grow_coef$bsize_g[post_draws[p]] + grow_coef$bsizesex_g[post_draws[p]]
  M_params$grow_pptgrow <- grow_coef$bpptgrow_g[post_draws[p]]  + grow_coef$bpptgrowsex_g[post_draws[p]] 
  M_params$grow_pptdorm <- grow_coef$bpptdorm_g[post_draws[p]]  + grow_coef$bpptdormsex_g[post_draws[p]] 
  M_params$grow_tempgrow <- grow_coef$btempgrow_g[post_draws[p]] + grow_coef$btempgrowsex_g[post_draws[p]] 
  M_params$grow_tempdorm <- grow_coef$btempdorm_g[post_draws[p]] + grow_coef$btempdormsex_g[post_draws[p]]
  M_params$grow_tempgrow_pptgrow<-grow_coef$btempgrowpptgrow_g[post_draws[p]] + grow_coef$btempgrowpptgrowsex_g[post_draws[p]]
  M_params$grow_tempdorm_pptdorm<-grow_coef$btempdormpptdorm_g[post_draws[p]] + grow_coef$btempdormpptdormsex_g[post_draws[p]]
  M_params$grow_pptgrow2<-grow_coef$bpptgrow2_g[post_draws[p]] + grow_coef$bpptgrow2sex_g[post_draws[p]]
  M_params$grow_tempgrow2<-grow_coef$btempgrow2_g[post_draws[p]] + grow_coef$btempgrow2sex_g[post_draws[p]]
  M_params$grow_pptdorm2<-grow_coef$bpptdorm2_g[post_draws[p]] + grow_coef$bpptdorm2sex_g[post_draws[p]]
  M_params$grow_tempdorm2<-grow_coef$btempdorm2_g[post_draws[p]] + grow_coef$btempdorm2sex_g[post_draws[p]]
  M_params$sigma_g <- grow_coef$sigma[post_draws[p]] 
  ## flowering
  F_params$flow_mu <- flow_coef$b0_f[post_draws[p]]
  F_params$flow_size <- flow_coef$bsize_f[post_draws[p]]
  F_params$flow_pptgrow <- flow_coef$bpptgrow_f[post_draws[p]] 
  F_params$flow_tempgrow <- flow_coef$btempgrow_f[post_draws[p]] 
  F_params$flow_tempdorm <- flow_coef$btempdorm_f[post_draws[p]] 
  F_params$flow_pptdorm <- flow_coef$bpptdorm_f[post_draws[p]]
  F_params$flow_tempgrow_pptgrow<-flow_coef$btempgrowpptgrow_f[post_draws[p]]
  F_params$flow_tempdorm_pptdorm<-flow_coef$btempdormpptdorm_f[post_draws[p]]
  F_params$flow_pptgrow2<-flow_coef$bpptgrow2_f[post_draws[p]]
  F_params$flow_pptdorm2<-flow_coef$bpptdorm2_f[post_draws[p]]
  F_params$flow_tempgrow2<-flow_coef$btempgrow2_f[post_draws[p]]
  F_params$flow_tempdorm2<-flow_coef$btempdorm2_f[post_draws[p]]
  M_params$flow_mu <- flow_coef$b0_f[post_draws[p]] + flow_coef$bsex_f[post_draws[p]]  
  M_params$flow_size <- flow_coef$bsize_f[post_draws[p]] + flow_coef$bsizesex_f[post_draws[p]]
  M_params$flow_pptgrow <- flow_coef$bpptgrow_f[post_draws[p]]  + flow_coef$bpptgrowsex_f[post_draws[p]] 
  M_params$flow_tempgrow <- flow_coef$btempgrow_f[post_draws[p]] + flow_coef$btempgrowsex_f[post_draws[p]]
  M_params$flow_tempdorm <- flow_coef$btempdorm_f[post_draws[p]] +  flow_coef$btempdormsex_f[post_draws[p]]  
  M_params$flow_pptdorm <- flow_coef$bpptdorm_f[post_draws[p]] + flow_coef$bpptdormsex_f[post_draws[p]] 
  M_params$flow_tempgrow_pptgrow<-flow_coef$btempgrowpptgrow_f[post_draws[p]] + flow_coef$btempgrowpptgrowsex_f[post_draws[p]]
  M_params$flow_tempdorm_pptdorm<-flow_coef$btempdormpptdorm_f[post_draws[p]] + flow_coef$btempdormpptdormsex_f[post_draws[p]]
  M_params$flow_pptgrow2<-flow_coef$bpptgrow2_f[post_draws[p]] + flow_coef$bpptgrow2sex_f[post_draws[p]]
  M_params$flow_tempgrow2<-flow_coef$btempgrow2_f[post_draws[p]] + flow_coef$btempgrow2sex_f[post_draws[p]]
  M_params$flow_pptdorm2<-flow_coef$bpptdorm2_f[post_draws[p]] +  flow_coef$bpptdorm2sex_f[post_draws[p]]
  M_params$flow_tempdorm2<-flow_coef$btempdorm2_f[post_draws[p]] + flow_coef$btempdorm2sex_f[post_draws[p]]
  ## panicles
  F_params$panic_mu <- panic_coef$b0_p[post_draws[p]]
  F_params$panic_size <- panic_coef$bsize_p[post_draws[p]]
  F_params$panic_pptgrow <- panic_coef$bpptgrow_p[post_draws[p]] 
  F_params$panic_tempgrow <- panic_coef$btempgrow_p[post_draws[p]] 
  F_params$panic_tempdorm <- panic_coef$btempdorm_p[post_draws[p]] 
  F_params$panic_pptdorm <- panic_coef$bpptdorm_p[post_draws[p]]
  F_params$panic_tempgrow_pptgrow<-panic_coef$btempgrowpptgrow_p[post_draws[p]]
  F_params$panic_tempdorm_pptdorm<-panic_coef$btempdormpptdorm_p[post_draws[p]]
  F_params$panic_pptgrow2<-panic_coef$bpptgrow2_p[post_draws[p]]
  F_params$panic_tempgrow2<-panic_coef$btempgrow2_p[post_draws[p]]
  F_params$panic_pptdorm2<-panic_coef$bpptdorm2_p[post_draws[p]]
  F_params$panic_tempdorm2<-panic_coef$btempdorm2_p[post_draws[p]]
  M_params$panic_mu <- panic_coef$b0_p[post_draws[p]] + panic_coef$bsex_p[post_draws[p]]  
  M_params$panic_size <- panic_coef$bsize_p[post_draws[p]] + panic_coef$bsizesex_p[post_draws[p]]
  M_params$panic_pptgrow <- panic_coef$bpptgrow_p[post_draws[p]]  + panic_coef$bpptgrowsex_p[post_draws[p]] 
  M_params$panic_tempgrow <- panic_coef$btempgrow_p[post_draws[p]] + panic_coef$btempgrowsex_p[post_draws[p]]
  M_params$panic_tempdorm <- panic_coef$btempdorm_p[post_draws[p]] +  panic_coef$btempdormsex_p[post_draws[p]]  
  M_params$panic_pptdorm <- panic_coef$bpptdorm_p[post_draws[p]] + panic_coef$bpptdormsex_p[post_draws[p]] 
  M_params$panic_tempgrow_pptgrow<-panic_coef$btempgrowpptgrow_p[post_draws[p]] + panic_coef$btempgrowpptgrowsex_p[post_draws[p]]
  M_params$panic_tempdorm_pptdorm<-panic_coef$btempdormpptdorm_p[post_draws[p]] + panic_coef$btempdormpptdormsex_p[post_draws[p]]
  M_params$panic_pptgrow2<-panic_coef$bpptgrow2_p[post_draws[p]] + panic_coef$bpptgrow2sex_p[post_draws[p]]
  M_params$panic_tempgrow2<-panic_coef$btempgrow2_p[post_draws[p]] + panic_coef$btempgrow2sex_p[post_draws[p]]
  M_params$panic_pptdorm2<-panic_coef$bpptdorm2_p[post_draws[p]] + panic_coef$bpptdorm2sex_p[post_draws[p]]
  M_params$panic_tempdorm2<-panic_coef$btempdorm2_p[post_draws[p]] + panic_coef$btempdorm2sex_p[post_draws[p]]
  ## seed viability and misc fertility params
  F_params$v0 <- via_coef$v0[post_draws[p]] 
  F_params$a_v <- via_coef$a_v[post_draws[p]] 
  F_params$ov_per_inf <- via_coef$lambda_d[post_draws[p]] 
  F_params$germ <- via_coef$m[post_draws[p]] 
  F_params$PSR <- 0.5
  ## use POAU seedling survival for females and males
  F_params$sdlg_surv <- M_params$sdlg_surv <- sdlg_surv$sdlg_surv
  ## set max size equal between the sexes
  F_params$max_size <- M_params$max_size <- round(quantile(na.omit((poar.clim_seasonal$tillerN_t1)),probs=0.95))
  ## pull out the rfx variances
  rfx <- rfx_fun(site_tau_s = surv_coef$site_tau_s[post_draws[p]],
                block_tau_s = surv_coef$block_tau_s[post_draws[p]],
                source_tau_s = surv_coef$source_tau_s[post_draws[p]],
                site_tau_g = grow_coef$site_tau_g[post_draws[p]],
                block_tau_g = grow_coef$block_tau_g[post_draws[p]],
                source_tau_g = grow_coef$source_tau_g[post_draws[p]],
                site_tau_f = flow_coef$site_tau_f[post_draws[p]],
                block_tau_f = flow_coef$block_tau_f[post_draws[p]],
                source_tau_f = flow_coef$source_tau_f[post_draws[p]],
                site_tau_p = panic_coef$site_tau_p[post_draws[p]],
                block_tau_p = panic_coef$block_tau_p[post_draws[p]],
                source_tau_p = panic_coef$source_tau_p[post_draws[p]])
   #Estimation+process error
   lambda_run_rfx <- lambdaSim_delay(F_params=F_params,M_params=M_params,zpptgrow=0,ztempgrow=0,zpptdorm=pptdorm_seq[l],ztempdorm=0,rfx=rfx_fun(),max.yrs=max_yrs)
  lambda_run_rfx$lambdatracker[max_yrs]
  
 }
)
## write output as a list
lambda_pptdorm_post_list <- list(lambda_pptdorm_post_rfx=lambda_pptdorm_post)


write_rds(lambda_pptdorm_post_list,"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/Posterior/lambda_pptdorm_post_list.rds")

```

```{r}
# read in results of the above loop
lambda_pptdorm_post_list <- readRDS(url("https://www.dropbox.com/scl/fi/vkd6i8vyacvr3cffij7wf/lambda_pptdorm_post_list.rds?rlkey=jeyucz1a1ki0ugwnya7m2xek5&dl=1"))
```

```{r}
## visualize results
lambda_pptdorm_q95 <- lambda_pptdorm_q75 <- lambda_pptdorm_q50 <- lambda_pptdorm_q25 <- lambda_pptdorm_q5 <- matrix(NA,2,length(pptdorm_seq))
lambda_pptdorm_mean <- lambda_pptdorm_rfx_mean <- c()
for(l in 1:length(pptdorm_seq)){
  lambda_pptdorm_q95[,l] <- quantile(lambda_pptdorm_post_list$lambda_pptdorm_post[,l],probs=c(0.025,0.975),na.rm = T)
  lambda_pptdorm_q75[,l] <- quantile(lambda_pptdorm_post_list$lambda_pptdorm_post[,l],probs=c(0.125,0.875),na.rm = T)
  lambda_pptdorm_q50[,l] <- quantile(lambda_pptdorm_post_list$lambda_pptdorm_post[,l],probs=c(0.25,0.75),na.rm = T)
  lambda_pptdorm_q25[,l] <- quantile(lambda_pptdorm_post_list$lambda_pptdorm_post[,l],probs=c(0.375,0.625),na.rm = T)
  lambda_pptdorm_q5[,l] <- quantile(lambda_pptdorm_post_list$lambda_pptdorm_post[,l],probs=c(0.475,0.525),na.rm = T)
  lambda_pptdorm_mean[l] <- mean(lambda_pptdorm_post_list$lambda_pptdorm_post[,l],na.rm = T)
}
```

## Temperature of dormant season

```{r,eval=FALSE}
## set up output matrices
n_post_draws <- 300
post_draws <- sample.int(length(surv_coef$b0_s), n_post_draws)
tempdorm_seq <- seq(min(poar_2015_2016$ztempdorm),max(poar_2015_2016$ztempdorm),length.out=20)
max_yrs <- 30
lambda_tempdorm_post <-matrix(NA,nrow=n_post_draws,ncol=length(tempdorm_seq))

F_params <- M_params <- list()
TTD<-system.time(
lambda_tempdorm_post<-foreach(p=1:n_post_draws,.combine='rbind')%:%
foreach(l=1:length(tempdorm_seq), .combine='c')%dopar%{
  #set up param vectors
  ## survival
  F_params$surv_mu <- surv_coef$b0_s[post_draws[p]]
  F_params$surv_size <- surv_coef$bsize_s[post_draws[p]]
  F_params$surv_pptgrow <- surv_coef$bpptgrow_s[post_draws[p]] 
  F_params$surv_pptdorm <- surv_coef$bpptdorm_s[post_draws[p]] 
  F_params$surv_tempgrow <- surv_coef$btempgrow_s[post_draws[p]]
  F_params$surv_tempdorm <- surv_coef$btempdorm_s[post_draws[p]] 
  F_params$surv_tempgrow_pptgrow<-surv_coef$btempgrowpptgrow_s[post_draws[p]]
  F_params$surv_tempdorm_pptdorm<-surv_coef$btempdormpptdorm_s[post_draws[p]]
  F_params$surv_pptgrow2<-surv_coef$bpptgrow2_s[post_draws[p]]
  F_params$surv_pptdorm2<-surv_coef$bpptdorm2_s[post_draws[p]]
  F_params$surv_tempgrow2<-surv_coef$btempgrow2_s[post_draws[p]]
  F_params$surv_tempdorm2<-surv_coef$btempdorm2_s[post_draws[p]]
  M_params$surv_mu <- surv_coef$b0_s[post_draws[p]] + surv_coef$bsex_s[post_draws[p]]  
  M_params$surv_size <- surv_coef$bsize_s[post_draws[p]] + surv_coef$bsizesex_s[post_draws[p]]
  M_params$surv_pptgrow <- surv_coef$bpptgrow_s[post_draws[p]]  + surv_coef$bpptgrowsex_s[post_draws[p]] 
  M_params$surv_tempgrow <- surv_coef$btempgrow_s[post_draws[p]] + surv_coef$btempgrowsex_s[post_draws[p]] 
  M_params$surv_pptdorm <- surv_coef$bpptdorm_s[post_draws[p]] + surv_coef$bpptdormsex_s[post_draws[p]] 
  M_params$surv_tempdorm <- surv_coef$btempdorm_s[post_draws[p]] + surv_coef$btempdormsex_s[post_draws[p]]
  M_params$surv_tempgrow_pptgrow<-surv_coef$btempgrowpptgrow_s[post_draws[p]] + surv_coef$btempgrowpptgrowsex_s[post_draws[p]]
  M_params$surv_tempdorm_pptdorm<-surv_coef$btempdormpptdorm_s[post_draws[p]] + surv_coef$btempdormpptdormsex_s[post_draws[p]]
  M_params$surv_pptgrow2<-surv_coef$bpptgrow2_s[post_draws[p]] + surv_coef$bpptgrow2sex_s[post_draws[p]]
  M_params$surv_tempgrow2<-surv_coef$btempgrow2_s[post_draws[p]] + surv_coef$btempgrow2sex_s[post_draws[p]]
  M_params$surv_pptdorm2<-surv_coef$bpptdorm2_s[post_draws[p]] + surv_coef$bpptdorm2sex_s[post_draws[p]]
  M_params$surv_tempdorm2<-surv_coef$btempdorm2_s[post_draws[p]] + surv_coef$btempdorm2sex_s[post_draws[p]]
  ## growth
  F_params$grow_mu <- grow_coef$b0_g[post_draws[p]]
  F_params$grow_size <- grow_coef$bsize_g[post_draws[p]]
  F_params$grow_pptgrow <- grow_coef$bpptgrow_g[post_draws[p]] 
  F_params$grow_pptdorm <- grow_coef$bpptdorm_g[post_draws[p]]
  F_params$grow_tempgrow <- grow_coef$btempgrow_g[post_draws[p]] 
  F_params$grow_tempdorm <- grow_coef$btempdorm_g[post_draws[p]] 
  F_params$grow_tempgrow_pptgrow<-grow_coef$btempgrowpptgrow_g[post_draws[p]]
  F_params$grow_tempdorm_pptdorm<-grow_coef$btempdormpptdorm_g[post_draws[p]] 
  F_params$grow_pptgrow2<-grow_coef$bpptgrow2_g[post_draws[p]]
  F_params$grow_tempgrow2<-grow_coef$btempgrow2_g[post_draws[p]]
  F_params$grow_pptdorm2<-grow_coef$bpptdorm2_g[post_draws[p]] 
  F_params$grow_tempdorm2<-grow_coef$btempdorm2_g[post_draws[p]] 
  F_params$sigma_g <- grow_coef$sigma[post_draws[p]] 
  M_params$grow_mu <- grow_coef$b0_g[post_draws[p]] + grow_coef$bsex_g[post_draws[p]]  
  M_params$grow_size <- grow_coef$bsize_g[post_draws[p]] + grow_coef$bsizesex_g[post_draws[p]]
  M_params$grow_pptgrow <- grow_coef$bpptgrow_g[post_draws[p]]  + grow_coef$bpptgrowsex_g[post_draws[p]] 
  M_params$grow_pptdorm <- grow_coef$bpptdorm_g[post_draws[p]]  + grow_coef$bpptdormsex_g[post_draws[p]] 
  M_params$grow_tempgrow <- grow_coef$btempgrow_g[post_draws[p]] + grow_coef$btempgrowsex_g[post_draws[p]] 
  M_params$grow_tempdorm <- grow_coef$btempdorm_g[post_draws[p]] + grow_coef$btempdormsex_g[post_draws[p]]
  M_params$grow_tempgrow_pptgrow<-grow_coef$btempgrowpptgrow_g[post_draws[p]] + grow_coef$btempgrowpptgrowsex_g[post_draws[p]]
  M_params$grow_tempdorm_pptdorm<-grow_coef$btempdormpptdorm_g[post_draws[p]] + grow_coef$btempdormpptdormsex_g[post_draws[p]]
  M_params$grow_pptgrow2<-grow_coef$bpptgrow2_g[post_draws[p]] + grow_coef$bpptgrow2sex_g[post_draws[p]]
  M_params$grow_tempgrow2<-grow_coef$btempgrow2_g[post_draws[p]] + grow_coef$btempgrow2sex_g[post_draws[p]]
  M_params$grow_pptdorm2<-grow_coef$bpptdorm2_g[post_draws[p]] + grow_coef$bpptdorm2sex_g[post_draws[p]]
  M_params$grow_tempdorm2<-grow_coef$btempdorm2_g[post_draws[p]] + grow_coef$btempdorm2sex_g[post_draws[p]]
  M_params$sigma_g <- grow_coef$sigma[post_draws[p]] 
  ## flowering
  F_params$flow_mu <- flow_coef$b0_f[post_draws[p]]
  F_params$flow_size <- flow_coef$bsize_f[post_draws[p]]
  F_params$flow_pptgrow <- flow_coef$bpptgrow_f[post_draws[p]] 
  F_params$flow_tempgrow <- flow_coef$btempgrow_f[post_draws[p]] 
  F_params$flow_tempdorm <- flow_coef$btempdorm_f[post_draws[p]] 
  F_params$flow_pptdorm <- flow_coef$bpptdorm_f[post_draws[p]]
  F_params$flow_tempgrow_pptgrow<-flow_coef$btempgrowpptgrow_f[post_draws[p]]
  F_params$flow_tempdorm_pptdorm<-flow_coef$btempdormpptdorm_f[post_draws[p]]
  F_params$flow_pptgrow2<-flow_coef$bpptgrow2_f[post_draws[p]]
  F_params$flow_pptdorm2<-flow_coef$bpptdorm2_f[post_draws[p]]
  F_params$flow_tempgrow2<-flow_coef$btempgrow2_f[post_draws[p]]
  F_params$flow_tempdorm2<-flow_coef$btempdorm2_f[post_draws[p]]
  M_params$flow_mu <- flow_coef$b0_f[post_draws[p]] + flow_coef$bsex_f[post_draws[p]]  
  M_params$flow_size <- flow_coef$bsize_f[post_draws[p]] + flow_coef$bsizesex_f[post_draws[p]]
  M_params$flow_pptgrow <- flow_coef$bpptgrow_f[post_draws[p]]  + flow_coef$bpptgrowsex_f[post_draws[p]] 
  M_params$flow_tempgrow <- flow_coef$btempgrow_f[post_draws[p]] + flow_coef$btempgrowsex_f[post_draws[p]]
  M_params$flow_tempdorm <- flow_coef$btempdorm_f[post_draws[p]] +  flow_coef$btempdormsex_f[post_draws[p]]  
  M_params$flow_pptdorm <- flow_coef$bpptdorm_f[post_draws[p]] + flow_coef$bpptdormsex_f[post_draws[p]] 
  M_params$flow_tempgrow_pptgrow<-flow_coef$btempgrowpptgrow_f[post_draws[p]] + flow_coef$btempgrowpptgrowsex_f[post_draws[p]]
  M_params$flow_tempdorm_pptdorm<-flow_coef$btempdormpptdorm_f[post_draws[p]] + flow_coef$btempdormpptdormsex_f[post_draws[p]]
  M_params$flow_pptgrow2<-flow_coef$bpptgrow2_f[post_draws[p]] + flow_coef$bpptgrow2sex_f[post_draws[p]]
  M_params$flow_tempgrow2<-flow_coef$btempgrow2_f[post_draws[p]] + flow_coef$btempgrow2sex_f[post_draws[p]]
  M_params$flow_pptdorm2<-flow_coef$bpptdorm2_f[post_draws[p]] +  flow_coef$bpptdorm2sex_f[post_draws[p]]
  M_params$flow_tempdorm2<-flow_coef$btempdorm2_f[post_draws[p]] + flow_coef$btempdorm2sex_f[post_draws[p]]
  ## panicles
  F_params$panic_mu <- panic_coef$b0_p[post_draws[p]]
  F_params$panic_size <- panic_coef$bsize_p[post_draws[p]]
  F_params$panic_pptgrow <- panic_coef$bpptgrow_p[post_draws[p]] 
  F_params$panic_tempgrow <- panic_coef$btempgrow_p[post_draws[p]] 
  F_params$panic_tempdorm <- panic_coef$btempdorm_p[post_draws[p]] 
  F_params$panic_pptdorm <- panic_coef$bpptdorm_p[post_draws[p]]
  F_params$panic_tempgrow_pptgrow<-panic_coef$btempgrowpptgrow_p[post_draws[p]]
  F_params$panic_tempdorm_pptdorm<-panic_coef$btempdormpptdorm_p[post_draws[p]]
  F_params$panic_pptgrow2<-panic_coef$bpptgrow2_p[post_draws[p]]
  F_params$panic_tempgrow2<-panic_coef$btempgrow2_p[post_draws[p]]
  F_params$panic_pptdorm2<-panic_coef$bpptdorm2_p[post_draws[p]]
  F_params$panic_tempdorm2<-panic_coef$btempdorm2_p[post_draws[p]]
  M_params$panic_mu <- panic_coef$b0_p[post_draws[p]] + panic_coef$bsex_p[post_draws[p]]  
  M_params$panic_size <- panic_coef$bsize_p[post_draws[p]] + panic_coef$bsizesex_p[post_draws[p]]
  M_params$panic_pptgrow <- panic_coef$bpptgrow_p[post_draws[p]]  + panic_coef$bpptgrowsex_p[post_draws[p]] 
  M_params$panic_tempgrow <- panic_coef$btempgrow_p[post_draws[p]] + panic_coef$btempgrowsex_p[post_draws[p]]
  M_params$panic_tempdorm <- panic_coef$btempdorm_p[post_draws[p]] +  panic_coef$btempdormsex_p[post_draws[p]]  
  M_params$panic_pptdorm <- panic_coef$bpptdorm_p[post_draws[p]] + panic_coef$bpptdormsex_p[post_draws[p]] 
  M_params$panic_tempgrow_pptgrow<-panic_coef$btempgrowpptgrow_p[post_draws[p]] + panic_coef$btempgrowpptgrowsex_p[post_draws[p]]
  M_params$panic_tempdorm_pptdorm<-panic_coef$btempdormpptdorm_p[post_draws[p]] + panic_coef$btempdormpptdormsex_p[post_draws[p]]
  M_params$panic_pptgrow2<-panic_coef$bpptgrow2_p[post_draws[p]] + panic_coef$bpptgrow2sex_p[post_draws[p]]
  M_params$panic_tempgrow2<-panic_coef$btempgrow2_p[post_draws[p]] + panic_coef$btempgrow2sex_p[post_draws[p]]
  M_params$panic_pptdorm2<-panic_coef$bpptdorm2_p[post_draws[p]] + panic_coef$bpptdorm2sex_p[post_draws[p]]
  M_params$panic_tempdorm2<-panic_coef$btempdorm2_p[post_draws[p]] + panic_coef$btempdorm2sex_p[post_draws[p]]
  ## seed viability and misc fertility params
  F_params$v0 <- via_coef$v0[post_draws[p]] 
  F_params$a_v <- via_coef$a_v[post_draws[p]] 
  F_params$ov_per_inf <- via_coef$lambda_d[post_draws[p]] 
  F_params$germ <- via_coef$m[post_draws[p]] 
  F_params$PSR <- 0.5
  ## use POAU seedling survival for females and males
  F_params$sdlg_surv <- M_params$sdlg_surv <- sdlg_surv$sdlg_surv
  ## set max size equal between the sexes
  F_params$max_size <- M_params$max_size <- round(quantile(na.omit((poar.clim_seasonal$tillerN_t1)),probs=0.95))
  ## pull out the rfx variances
  rfx <- rfx_fun(site_tau_s = surv_coef$site_tau_s[post_draws[p]],
                block_tau_s = surv_coef$block_tau_s[post_draws[p]],
                source_tau_s = surv_coef$source_tau_s[post_draws[p]],
                site_tau_g = grow_coef$site_tau_g[post_draws[p]],
                block_tau_g = grow_coef$block_tau_g[post_draws[p]],
                source_tau_g = grow_coef$source_tau_g[post_draws[p]],
                site_tau_f = flow_coef$site_tau_f[post_draws[p]],
                block_tau_f = flow_coef$block_tau_f[post_draws[p]],
                source_tau_f = flow_coef$source_tau_f[post_draws[p]],
                site_tau_p = panic_coef$site_tau_p[post_draws[p]],
                block_tau_p = panic_coef$block_tau_p[post_draws[p]],
                source_tau_p = panic_coef$source_tau_p[post_draws[p]])
   #Estimation+process error
   lambda_run_rfx <- lambdaSim_delay(F_params=F_params,M_params=M_params,zpptgrow=0,ztempgrow=0,zpptdorm=0,ztempdorm=tempdorm_seq[l],rfx=rfx_fun(),max.yrs=max_yrs)
  lambda_run_rfx$lambdatracker[max_yrs]
 }
)
## write output as a list
lambda_tempdorm_post_list <- list(lambda_tempdorm_post_rfx=lambda_tempdorm_post)


write_rds(lambda_tempdorm_post_list,"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/Posterior/lambda_tempdorm_post_list.rds")

```

```{r}
# read in results of the above loop
lambda_tempdorm_post_list <- readRDS(url("https://www.dropbox.com/scl/fi/wiv6fjsm0auzch4k9eeqi/lambda_tempdorm_post_listfeb26.rds?rlkey=ex6vm03f6jqs0dyiz7l86hc2y&dl=1"))
```

```{r}
lambda_tempdorm_q95 <- lambda_tempdorm_q75 <- lambda_tempdorm_q50 <- lambda_tempdorm_q25 <- lambda_tempdorm_q5 <- matrix(NA,2,length(tempdorm_seq))
lambda_tempdorm_rfx_mean  <- c()

for(l in 1:length(tempdorm_seq)){
  lambda_tempdorm_q95[,l] <- quantile(lambda_tempdorm_post_list$lambda_tempdorm_post[,l],probs=c(0.025,0.975),na.rm = T)
  lambda_tempdorm_q75[,l] <- quantile(lambda_tempdorm_post_list$lambda_tempdorm_post[,l],probs=c(0.125,0.875),na.rm = T)
  lambda_tempdorm_q50[,l] <- quantile(lambda_tempdorm_post_list$lambda_tempdorm_post[,l],probs=c(0.25,0.75),na.rm = T)
  lambda_tempdorm_q25[,l] <- quantile(lambda_tempdorm_post_list$lambda_tempdorm_post[,l],probs=c(0.375,0.625),na.rm = T)
  lambda_tempdorm_q5[,l] <- quantile(lambda_tempdorm_post_list$lambda_tempdorm_post[,l],probs=c(0.475,0.525),na.rm = T)
  lambda_tempdorm_mean[l] <- mean(lambda_tempdorm_post_list$lambda_tempdorm_post[,l],na.rm = T)
}

```

```{r}
polygon_col <- "#E6AB02"
polygon_alpha <- 0.25

pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/lambda_CI.pdf",useDingbats = F,height=8,width=7.5)
par(mfrow=c(2,2))
plot(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),lambda_pptgrow_mean,type="l",
     xlab="Precipitation (grow. season)",ylab=expression(paste(lambda)),cex.lab=1.2,lwd=2)
polygon(x=c(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),rev(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) )),
        y=c(lambda_pptgrow_q95[1,],rev(lambda_pptgrow_q95[2,])),
        col=alpha(polygon_col,polygon_alpha),border=NA)
polygon(x=c(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),rev(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow))),
        y=c(lambda_pptgrow_q75[1,],rev(lambda_pptgrow_q75[2,])),
        col=alpha(polygon_col,polygon_alpha),border=NA)
polygon(x=c(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),rev(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow))),
        y=c(lambda_pptgrow_q50[1,],rev(lambda_pptgrow_q50[2,])),
        col=alpha(polygon_col,polygon_alpha),border=NA)
polygon(x=c(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) ,rev(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow))),
        y=c(lambda_pptgrow_q25[1,],rev(lambda_pptgrow_q25[2,])),
        col=alpha(polygon_col,polygon_alpha),border=NA)
polygon(x=c(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) ,rev(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow) )),
        y=c(lambda_pptgrow_q5[1,],rev(lambda_pptgrow_q5[2,])),
        col=alpha(polygon_col,polygon_alpha),border=NA)
abline(h=1,lty=3)

plot(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow),lambda_tempgrow_mean,type="l",
     xlab="Temperature (grow. season)",ylab=expression(paste(lambda)),cex.lab=1.2,lwd=2)
polygon(x=c(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow),rev(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow) )),
        y=c(lambda_tempgrow_q95[1,],rev(lambda_tempgrow_q95[2,])),
        col=alpha(polygon_col,polygon_alpha),border=NA)
polygon(x=c(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow),rev(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow))),
        y=c(lambda_tempgrow_q75[1,],rev(lambda_tempgrow_q75[2,])),
        col=alpha(polygon_col,polygon_alpha),border=NA)
polygon(x=c(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow),rev(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow))),
        y=c(lambda_tempgrow_q50[1,],rev(lambda_tempgrow_q50[2,])),
        col=alpha(polygon_col,polygon_alpha),border=NA)
polygon(x=c(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow) ,rev(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow))),
        y=c(lambda_tempgrow_q25[1,],rev(lambda_tempgrow_q25[2,])),
        col=alpha(polygon_col,polygon_alpha),border=NA)
polygon(x=c(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow) ,rev(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow) )),
        y=c(lambda_tempgrow_q5[1,],rev(lambda_tempgrow_q5[2,])),
        col=alpha(polygon_col,polygon_alpha),border=NA)
abline(h=1,lty=3)

plot(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),lambda_pptdorm_mean,type="l",
     xlab="Precipitation (dorm. season)",ylab=expression(paste(lambda)),cex.lab=1.2,lwd=2)
polygon(x=c(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),rev(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) )),
        y=c(lambda_pptdorm_q95[1,],rev(lambda_pptdorm_q95[2,])),
        col=alpha(polygon_col,polygon_alpha),border=NA)
polygon(x=c(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),rev(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm))),
        y=c(lambda_pptdorm_q75[1,],rev(lambda_pptdorm_q75[2,])),
        col=alpha(polygon_col,polygon_alpha),border=NA)
polygon(x=c(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),rev(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm))),
        y=c(lambda_pptdorm_q50[1,],rev(lambda_pptdorm_q50[2,])),
        col=alpha(polygon_col,polygon_alpha),border=NA)
polygon(x=c(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) ,rev(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm))),
        y=c(lambda_pptdorm_q25[1,],rev(lambda_pptdorm_q25[2,])),
        col=alpha(polygon_col,polygon_alpha),border=NA)
polygon(x=c(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) ,rev(pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm) )),
        y=c(lambda_pptdorm_q5[1,],rev(lambda_pptdorm_q5[2,])),
        col=alpha(polygon_col,polygon_alpha),border=NA)
abline(h=1,lty=3)

plot(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),lambda_tempdorm_mean,type="l",
     xlab="Temperature (dorm. season)",ylab=expression(paste(lambda)),cex.lab=1.2,lwd=2)
polygon(x=c(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),rev(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm) )),
        y=c(lambda_tempdorm_q95[1,],rev(lambda_tempdorm_q95[2,])),
        col=alpha(polygon_col,polygon_alpha),border=NA)
polygon(x=c(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),rev(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm))),
        y=c(lambda_tempdorm_q75[1,],rev(lambda_tempdorm_q75[2,])),
        col=alpha(polygon_col,polygon_alpha),border=NA)
polygon(x=c(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),rev(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm))),
        y=c(lambda_tempdorm_q50[1,],rev(lambda_tempdorm_q50[2,])),
        col=alpha(polygon_col,polygon_alpha),border=NA)
polygon(x=c(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm) ,rev(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm))),
        y=c(lambda_tempdorm_q25[1,],rev(lambda_tempdorm_q25[2,])),
        col=alpha(polygon_col,polygon_alpha),border=NA)
polygon(x=c(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm) ,rev(tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm) )),
        y=c(lambda_tempdorm_q5[1,],rev(lambda_tempdorm_q5[2,])),
        col=alpha(polygon_col,polygon_alpha),border=NA)
abline(h=1,lty=3)


dev.off()

```

```{r}
stopCluster(my.cluster)
```

# Life Table Response Experiment (LTRE)

```{r}
# Z score
zclim_current = data.frame(matrix(nrow = 14, ncol = 4)) 
colnames(zclim_current)<-c("zpptgrow","ztempgrow","zpptdorm","ztempdorm")
zclim_current$zpptgrow<-(clim_current$pptgrow-mean(poar_2015_2016$pptgrow))/sd(poar_2015_2016$pptgrow)
zclim_current$ztempgrow<-(clim_current$tempgrow-mean(poar_2015_2016$tempgrow))/sd(poar_2015_2016$tempgrow)
zclim_current$zpptdorm<-(clim_current$pptdorm-mean(poar_2015_2016$pptdorm))/sd(poar_2015_2016$pptdorm)
zclim_current$ztempdorm<-(clim_current$tempdorm-mean(poar_2015_2016$tempdorm))/sd(poar_2015_2016$tempdorm)
```

## Past

```{r}
zclim_past = data.frame(matrix(nrow = 14, ncol = 4)) 
colnames(zclim_past)<-c("zpptgrow","ztempgrow","zpptdorm","ztempdorm")
zclim_past$zpptgrow<-(clim_past$pptgrow-mean(poar_2015_2016$pptgrow))/sd(poar_2015_2016$pptgrow)
zclim_past$ztempgrow<-(clim_past$tempgrow-mean(poar_2015_2016$tempgrow))/sd(poar_2015_2016$tempgrow)
zclim_past$zpptdorm<-(clim_past$pptdorm-mean(poar_2015_2016$pptdorm))/sd(poar_2015_2016$pptdorm)
zclim_past$ztempdorm<-(clim_past$tempdorm-mean(poar_2015_2016$tempdorm))/sd(poar_2015_2016$tempdorm)
```

## MIROC45

```{r}
zclim_miroc45 = data.frame(matrix(nrow = 14, ncol = 4)) 
colnames(zclim_miroc45)<-c("zpptgrow","ztempgrow","zpptdorm","ztempdorm")
zclim_miroc45$zpptgrow<-(clim_miroc45$pptgrow-mean(poar_2015_2016$pptgrow))/sd(poar_2015_2016$pptgrow)
zclim_miroc45$ztempgrow<-(clim_miroc45$tempgrow-mean(poar_2015_2016$tempgrow))/sd(poar_2015_2016$tempgrow)
zclim_miroc45$zpptdorm<-(clim_miroc45$pptdorm-mean(poar_2015_2016$pptdorm))/sd(poar_2015_2016$pptdorm)
zclim_miroc45$ztempdorm<-(clim_miroc45$tempdorm-mean(poar_2015_2016$tempdorm))/sd(poar_2015_2016$tempdorm)
```

## ACCESS45

```{r}
zclim_acc45 = data.frame(matrix(nrow = 14, ncol = 4)) 
colnames(zclim_acc45)<-c("zpptgrow","ztempgrow","zpptdorm","ztempdorm")
zclim_acc45$zpptgrow<-(clim_access45$pptgrow-mean(poar_2015_2016$pptgrow))/sd(poar_2015_2016$pptgrow)
zclim_acc45$ztempgrow<-(clim_access45$tempgrow-mean(poar_2015_2016$tempgrow))/sd(poar_2015_2016$tempgrow)
zclim_acc45$zpptdorm<-(clim_access45$pptdorm-mean(poar_2015_2016$pptdorm))/sd(poar_2015_2016$pptdorm)
zclim_acc45$ztempdorm<-(clim_access45$tempdorm-mean(poar_2015_2016$tempdorm))/sd(poar_2015_2016$tempdorm)
```

## CMC45

```{r}
zclim_cmc45 = data.frame(matrix(nrow = 14, ncol = 4)) 
colnames(zclim_cmc45)<-c("zpptgrow","ztempgrow","zpptdorm","ztempdorm")
zclim_cmc45$zpptgrow<-(clim_cmcc45$pptgrow-mean(poar_2015_2016$pptgrow))/sd(poar_2015_2016$pptgrow)
zclim_cmc45$ztempgrow<-(clim_cmcc45$tempgrow-mean(poar_2015_2016$tempgrow))/sd(poar_2015_2016$tempgrow)
zclim_cmc45$zpptdorm<-(clim_cmcc45$pptdorm-mean(poar_2015_2016$pptdorm))/sd(poar_2015_2016$pptdorm)
zclim_cmc45$ztempdorm<-(clim_cmcc45$tempdorm-mean(poar_2015_2016$tempdorm))/sd(poar_2015_2016$tempdorm)
```

## CES45

```{r}
zclim_ces45 = data.frame(matrix(nrow = 14, ncol = 4)) 
colnames(zclim_ces45)<-c("zpptgrow","ztempgrow","zpptdorm","ztempdorm")
zclim_ces45$zpptgrow<-(clim_cesm45$pptgrow-mean(poar_2015_2016$pptgrow))/sd(poar_2015_2016$pptgrow)
zclim_ces45$ztempgrow<-(clim_cesm45$tempgrow-mean(poar_2015_2016$tempgrow))/sd(poar_2015_2016$tempgrow)
zclim_ces45$zpptdorm<-(clim_cesm45$pptdorm-mean(poar_2015_2016$pptdorm))/sd(poar_2015_2016$pptdorm)
zclim_ces45$ztempdorm<-(clim_cesm45$tempdorm-mean(poar_2015_2016$tempdorm))/sd(poar_2015_2016$tempdorm)
```

```{r}
data_site_pptgrow45<-data.frame(zclim_miroc45$zpptgrow,zclim_acc45$zpptgrow,zclim_cmc45$zpptgrow,zclim_ces45$zpptgrow)
data_site_tempgrow45<-data.frame(zclim_miroc45$ztempgrow,zclim_acc45$ztempgrow,zclim_cmc45$ztempgrow,zclim_ces45$ztempgrow)
data_site_pptdorm45<-data.frame(zclim_miroc45$zpptdorm,zclim_acc45$zpptdorm,zclim_cmc45$zpptdorm,zclim_ces45$zpptdorm)
data_site_tempdorm45<-data.frame(zclim_miroc45$ztempdorm,zclim_acc45$ztempdorm,zclim_cmc45$ztempdorm,zclim_ces45$ztempdorm)
data_site_45<-data.frame(zpptgrow=rowMeans(data_site_pptgrow45),ztempgrow=rowMeans(data_site_tempgrow45),zpptdorm=rowMeans(data_site_pptdorm45),ztempdorm=rowMeans(data_site_tempdorm45))
```

## MIROC85

```{r}
zclim_miroc85 = data.frame(matrix(nrow = 14, ncol = 4)) 
colnames(zclim_miroc85)<-c("zpptgrow","ztempgrow","zpptdorm","ztempdorm")
zclim_miroc85$zpptgrow<-(clim_miroc85$pptgrow-mean(poar_2015_2016$pptgrow))/sd(poar_2015_2016$pptgrow)
zclim_miroc85$ztempgrow<-(clim_miroc85$tempgrow-mean(poar_2015_2016$tempgrow))/sd(poar_2015_2016$tempgrow)
zclim_miroc85$zpptdorm<-(clim_miroc85$pptdorm-mean(poar_2015_2016$pptdorm))/sd(poar_2015_2016$pptdorm)
zclim_miroc85$ztempdorm<-(clim_miroc85$tempdorm-mean(poar_2015_2016$tempdorm))/sd(poar_2015_2016$tempdorm)
```

## ACCESS85

```{r}
zclim_acc85 = data.frame(matrix(nrow = 14, ncol = 4)) 
colnames(zclim_acc85)<-c("zpptgrow","ztempgrow","zpptdorm","ztempdorm")
zclim_acc85$zpptgrow<-(clim_access85$pptgrow-mean(poar_2015_2016$pptgrow))/sd(poar_2015_2016$pptgrow)
zclim_acc85$ztempgrow<-(clim_access85$tempgrow-mean(poar_2015_2016$tempgrow))/sd(poar_2015_2016$tempgrow)
zclim_acc85$zpptdorm<-(clim_access85$pptdorm-mean(poar_2015_2016$pptdorm))/sd(poar_2015_2016$pptdorm)
zclim_acc85$ztempdorm<-(clim_access85$tempdorm-mean(poar_2015_2016$tempdorm))/sd(poar_2015_2016$tempdorm)
```

## CMC85

```{r}
zclim_cmc85 = data.frame(matrix(nrow = 14, ncol = 4)) 
colnames(zclim_cmc85)<-c("zpptgrow","ztempgrow","zpptdorm","ztempdorm")
zclim_cmc85$zpptgrow<-(clim_cmcc85$pptgrow-mean(poar_2015_2016$pptgrow))/sd(poar_2015_2016$pptgrow)
zclim_cmc85$ztempgrow<-(clim_cmcc85$tempgrow-mean(poar_2015_2016$tempgrow))/sd(poar_2015_2016$tempgrow)
zclim_cmc85$zpptdorm<-(clim_cmcc85$pptdorm-mean(poar_2015_2016$pptdorm))/sd(poar_2015_2016$pptdorm)
zclim_cmc85$ztempdorm<-(clim_cmcc85$tempdorm-mean(poar_2015_2016$tempdorm))/sd(poar_2015_2016$tempdorm)
```

## CES85

```{r}
zclim_ces85 = data.frame(matrix(nrow = 14, ncol = 4)) 
colnames(zclim_ces85)<-c("zpptgrow","ztempgrow","zpptdorm","ztempdorm")
zclim_ces85$zpptgrow<-(clim_cesm85$pptgrow-mean(poar_2015_2016$pptgrow))/sd(poar_2015_2016$pptgrow)
zclim_ces85$ztempgrow<-(clim_cesm85$tempgrow-mean(poar_2015_2016$tempgrow))/sd(poar_2015_2016$tempgrow)
zclim_ces85$zpptdorm<-(clim_cesm85$pptdorm-mean(poar_2015_2016$pptdorm))/sd(poar_2015_2016$pptdorm)
zclim_ces85$ztempdorm<-(clim_cesm85$tempdorm-mean(poar_2015_2016$tempdorm))/sd(poar_2015_2016$tempdorm)
```

```{r}
data_site_pptgrow85<-data.frame(zclim_miroc85$zpptgrow,zclim_acc85$zpptgrow,zclim_cmc85$zpptgrow,zclim_ces85$zpptgrow)
data_site_tempgrow85<-data.frame(zclim_miroc85$ztempgrow,zclim_acc85$ztempgrow,zclim_cmc85$ztempgrow,zclim_ces85$ztempgrow)
data_site_pptdorm85<-data.frame(zclim_miroc85$zpptdorm,zclim_acc85$zpptdorm,zclim_cmc85$zpptdorm,zclim_ces85$zpptdorm)
data_site_tempdorm85<-data.frame(zclim_miroc85$ztempdorm,zclim_acc85$ztempdorm,zclim_cmc85$ztempdorm,zclim_ces85$ztempdorm)
data_site_85<-data.frame(zpptgrow=rowMeans(data_site_pptgrow85),ztempgrow=rowMeans(data_site_tempgrow85),zpptdorm=rowMeans(data_site_pptdorm85),ztempdorm=rowMeans(data_site_tempdorm85))
```

```{r}
data_past_present_45_85<-rbind(zclim_past,zclim_current,data_site_45,data_site_85)
# write_csv(data_past_present_45_85,"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/Climatic data/Niche/data_past_present_45_85.csv")
```

```{r}
lambda_ppf<-lambda_ppf_2sex<-SR_ppf<-OSR_ppf<-c()
max_yrs <- 30

for (i in 1:nrow(data_past_present_45_85)) {
    #linear model for comparison
  mat <- megamatrix_delay( F_params=F_params,
                           M_params=M_params,
                           twosex=F,
                           grow_perturb=0,
                           surv_perturb=0,
                           flow_perturb=0,
                           fert_perturb=0,
                           viab_perturb=0,
                           zpptgrow=data_past_present_45_85[i,1],
                           ztempgrow=data_past_present_45_85[i,2],
                           zpptdorm=data_past_present_45_85[i,3],
                           ztempdorm=data_past_present_45_85[i,4],
                           rfx=rfx_fun())$MEGAmat
  lambda_ppf[i] <- popbio::lambda(mat)
  # 2-sex model
  lambda_run <- lambdaSim_delay( F_params=F_params,
                                 M_params=M_params,
                                 grow_perturb=0,
                                 surv_perturb=0,
                                 flow_perturb=0,
                                 fert_perturb=0,
                                 viab_perturb=0,
                                 zpptgrow=data_past_present_45_85[i,1],
                                 ztempgrow=data_past_present_45_85[i,2],
                                 zpptdorm=data_past_present_45_85[i,3],
                                 ztempdorm=data_past_present_45_85[i,4],
                                 rfx = rfx_fun(),
                                 max.yrs = max_yrs)
  lambda_ppf_2sex[i] <- lambda_run$lambdatracker[max_yrs]
  SR_ppf[i] <- lambda_run$SRtracker[max_yrs]
  OSR_ppf[i] <- lambda_run$OSRtracker[max_yrs]
}
```

```{r}
Time<-c(rep("Past",14),rep("Present",14),rep("Future",28))
datltre<-data.frame(data_past_present_45_85,idorm=data_past_present_45_85$zpptdorm*data_past_present_45_85$ztempdorm,igrow=data_past_present_45_85$zpptgrow*data_past_present_45_85$ztempgrow,Time=Time,lambda=lambda_ppf_2sex)
# modrf45<-MixRF::MixRF(Y=datltre45$lambda, X=as.data.frame(datltre45[,-c(5,6)]), random="(1|Time)", data=datltre45, initialRandomEffects = 0, ErrorTolerance = 0.001, MaxIterations = 1000)
# summary(modrf45)
```


```{r}
library(randomForestExplainer)
set.seed(13)
modrf <- randomForest(lambda ~ zpptdorm + ztempdorm + zpptgrow + ztempgrow + idorm + igrow + I(zpptdorm)+I(ztempdorm)+I(zpptgrow)+I(ztempgrow), data=datltre, 
                         # three permutations per tree to estimate importance
                         importance = TRUE, nperm = 3, 
                         na.action = na.omit, mtry = 3)
print(modrf)

```


```{r}
plot(modrf)
```


```{r}
randomForest::importance(modrf, type=1)
```

```{r}
require(vip)
v1 <- vip(modrf, title = "randomForest")
```


```{r}
ou<-tuneRF(y=datltre$lambda, x=as.data.frame(datltre[,1:6]),stepFactor = 1,improve = 0.02)
modrf<-randomForest::randomForest(y=datltre$lambda, x=as.data.frame(datltre[,1:6]),ntree=500,importance=TRUE,mtry=2)
plot(modrf$rsq,type="l")
randomForest::varImpPlot(modrf,type = 1,scale = FALSE,main="")
```

```{r}
imp<- as.data.frame(importance(modrf))
imp$vars <- row.names(imp)
imp<-imp[,-2]
colnames(imp)<-c("Importance","Climate")
imp$Rimportance<-imp$Importance/sum(imp$Importance)
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/Fig_LTRE.pdf",width=5,height=5,useDingbats = F)
(Fig_LTRE <- ggplot(data=imp, aes(x=Climate, y=Rimportance)) +
geom_bar(stat="identity", color="black",fill="grey80", position=position_dodge())+
  labs(x="",y="Relative importance")+
  scale_x_discrete(
    breaks = c("ztempgrow","ztempdorm","zpptgrow","zpptdorm","idorm","igrow"),
    labels = c("Temperature (grow.season)", "Temperature (dorm.season)","Precipitation (grow.season)","Precipitation (dorm.season)","Precipitation*Temperature (dorm.season)","Precipitation*Temperature (grow.season)"))+
  coord_flip()+
  theme_bw()+
  theme(
    axis.text = element_text(color = "black",size = 10),
    legend.position=c(0.8, 0.2)))
dev.off()
```

# Projection over time (Past,Present, and Future )

# Predicted response of Î» to climate change

### Precipitation growing season

```{r}
all_pptgrow_seq <- seq(min(data_past_present_45_85$zpptgrow),max(data_past_present_45_85$zpptgrow),length.out=30)

lambda_pptgrow_all<-lambda_pptgrow_all_2sex<-SR_pptgrow_all<-OSR_pptgrow_all<-c()
ssd_pptgrow_all<-matrix(NA,(F_params$max_size+1)*2,length(all_pptgrow_seq))
max_yrs <- 30

for (i in 1:length(all_pptgrow_seq)) {
    #linear model for comparison
  mat <- megamatrix_delay( F_params=F_params,
                           M_params=M_params,
                           twosex=F,
                           grow_perturb=0,
                           surv_perturb=0,
                           flow_perturb=0,
                           fert_perturb=0,
                           viab_perturb=0,
                           zpptgrow=all_pptgrow_seq[i],
                           ztempgrow=0,
                           zpptdorm=0,
                           ztempdorm=0,
                           rfx=rfx_fun())$MEGAmat
  lambda_pptgrow_all[i] <- popbio::lambda(mat)
  # 2-sex model
  lambda_run <- lambdaSim_delay( F_params=F_params,
                                 M_params=M_params,
                                 grow_perturb=0,
                                 surv_perturb=0,
                                 flow_perturb=0,
                                 fert_perturb=0,
                                 viab_perturb=0,
                                 zpptgrow=all_pptgrow_seq[i],
                                 ztempgrow=0,
                                 zpptdorm=0,
                                 ztempdorm=0,
                                 rfx = rfx_fun(),
                                 max.yrs = max_yrs)
  lambda_pptgrow_all_2sex[i] <- lambda_run$lambdatracker[max_yrs]
  SR_pptgrow_all[i] <- lambda_run$SRtracker[max_yrs]
  OSR_pptgrow_all[i] <- lambda_run$OSRtracker[max_yrs]
  ssd_pptgrow_all[,i] <- lambda_run$n0
}
```


### Temperature growing season

```{r}
all_tempgrow_seq <- seq(min(data_past_present_45_85$ztempgrow),max(data_past_present_45_85$ztempgrow),length.out=30)

lambda_tempgrow_all<-lambda_tempgrow_all_2sex<-SR_tempgrow_all<-OSR_tempgrow_all<-c()
ssd_tempgrow_all<-matrix(NA,(F_params$max_size+1)*2,length(all_tempgrow_seq))
max_yrs <- 30

for (i in 1:length(all_tempgrow_seq)) {
    #linear model for comparison
  mat <- megamatrix_delay( F_params=F_params,
                           M_params=M_params,
                           twosex=F,
                           grow_perturb=0,
                           surv_perturb=0,
                           flow_perturb=0,
                           fert_perturb=0,
                           viab_perturb=0,
                           zpptgrow=0,
                           ztempgrow=all_tempgrow_seq[i],
                           zpptdorm=0,
                           ztempdorm=0,
                           rfx=rfx_fun())$MEGAmat
  lambda_tempgrow_all[i] <- popbio::lambda(mat)
  # 2-sex model
  lambda_run <- lambdaSim_delay( F_params=F_params,
                                 M_params=M_params,
                                 grow_perturb=0,
                                 surv_perturb=0,
                                 flow_perturb=0,
                                 fert_perturb=0,
                                 viab_perturb=0,
                                 zpptgrow=0,
                                 ztempgrow=all_tempgrow_seq[i],
                                 zpptdorm=0,
                                 ztempdorm=0,
                                 rfx = rfx_fun(),
                                 max.yrs = max_yrs)
  lambda_tempgrow_all_2sex[i] <- lambda_run$lambdatracker[max_yrs]
  SR_tempgrow_all[i] <- lambda_run$SRtracker[max_yrs]
  OSR_tempgrow_all[i] <- lambda_run$OSRtracker[max_yrs]
  ssd_tempgrow_all[,i] <- lambda_run$n0
}
```


### Precipitation dormant season

```{r}
# all_pptdorm<-c(zclim_current$zpptdorm,zclim_past$zpptdorm,zclim_miroc45$zpptdorm,zclim_miroc85$zpptdorm)
all_pptdorm_seq <- seq(min(data_past_present_45_85$zpptdorm),max(data_past_present_45_85$zpptdorm),length.out=30)

lambda_pptdorm_all<-lambda_pptdorm_all_2sex<-SR_pptdorm_all<-OSR_pptdorm_all<-c()
ssd_pptdorm_all<-matrix(NA,(F_params$max_size+1)*2,length(all_pptdorm_seq))
max_yrs <- 30


for (i in 1:length(all_pptdorm_seq)) {
    #linear model for comparison
  mat <- megamatrix_delay( F_params=F_params,
                           M_params=M_params,
                           twosex=F,
                           grow_perturb=0,
                           surv_perturb=0,
                           flow_perturb=0,
                           fert_perturb=0,
                           viab_perturb=0,
                           zpptgrow=0,
                           ztempgrow=0,
                           zpptdorm=all_pptdorm_seq[i],
                           ztempdorm=0,
                           rfx=rfx_fun())$MEGAmat
  lambda_pptdorm_all[i] <- popbio::lambda(mat)
  # 2-sex model
  lambda_run <- lambdaSim_delay( F_params=F_params,
                                 M_params=M_params,
                                 grow_perturb=0,
                                 surv_perturb=0,
                                 flow_perturb=0,
                                 fert_perturb=0,
                                 viab_perturb=0,
                                 zpptgrow=0,
                                 ztempgrow=0,
                                 zpptdorm=all_pptdorm_seq[i],
                                 ztempdorm=0,
                                 rfx = rfx_fun(),
                                 max.yrs = max_yrs)
  lambda_pptdorm_all_2sex[i] <- lambda_run$lambdatracker[max_yrs]
  SR_pptdorm_all[i] <- lambda_run$SRtracker[max_yrs]
  OSR_pptdorm_all[i] <- lambda_run$OSRtracker[max_yrs]
  ssd_pptdorm_all[,i] <- lambda_run$n0
}
```


### Temperature of the dormant season

```{r}
all_tempdorm_seq <- seq(min(data_past_present_45_85$ztempdorm),max(data_past_present_45_85$ztempdorm),length.out=30)
lambda_tempdorm_all<-lambda_tempdorm_all_2sex<-SR_tempdorm_all<-OSR_tempdorm_all<-c()
ssd_tempdorm_all<-matrix(NA,(F_params$max_size+1)*2,length(all_tempdorm_seq))
max_yrs <- 30

for (i in 1:length(all_tempdorm_seq)) {
    #linear model for comparison
  mat <- megamatrix_delay( F_params=F_params,
                           M_params=M_params,
                           twosex=F,
                           grow_perturb=0,
                           surv_perturb=0,
                           flow_perturb=0,
                           fert_perturb=0,
                           viab_perturb=0,
                           zpptgrow=0,
                           ztempgrow=0,
                           zpptdorm=0,
                           ztempdorm=all_tempdorm_seq[i],
                           rfx=rfx_fun())$MEGAmat
  lambda_tempdorm_all[i] <- popbio::lambda(mat)
  # 2-sex model
  lambda_run <- lambdaSim_delay( F_params=F_params,
                                 M_params=M_params,
                                 grow_perturb=0,
                                 surv_perturb=0,
                                 flow_perturb=0,
                                 fert_perturb=0,
                                 viab_perturb=0,
                                 zpptgrow=0,
                                 ztempgrow=0,
                                 zpptdorm=0,
                                 ztempdorm=all_tempdorm_seq[i],
                                 rfx = rfx_fun(),
                                 max.yrs = max_yrs)
  lambda_tempdorm_all_2sex[i] <- lambda_run$lambdatracker[max_yrs]
  SR_tempdorm_all[i] <- lambda_run$SRtracker[max_yrs]
  OSR_tempdorm_all[i] <- lambda_run$OSRtracker[max_yrs]
  ssd_tempdorm_all[,i] <- lambda_run$n0
}

```

```{r,eval=FALSE}
rect_pptgrow <- data.frame(xmin = c((min(zclim_past$zpptgrow)*sd(poar_2015_2016$pptgrow)+mean(poar_2015_2016$pptgrow)), (min(zclim_current$zpptgrow)*sd(poar_2015_2016$pptgrow)+mean(poar_2015_2016$pptgrow)), (min(data_site_45$zpptgrow)*sd(poar_2015_2016$pptgrow)+mean(poar_2015_2016$pptgrow)),
(min(data_site_85$zpptgrow)*sd(poar_2015_2016$pptgrow)+mean(poar_2015_2016$pptgrow))), xmax = c((max(zclim_past$zpptgrow)*sd(poar_2015_2016$pptgrow)+mean(poar_2015_2016$pptgrow)), (max(zclim_current$zpptgrow)*sd(poar_2015_2016$pptgrow)+mean(poar_2015_2016$pptgrow)), (max(data_site_45$zpptgrow)*sd(poar_2015_2016$pptgrow)+mean(poar_2015_2016$pptgrow)),
(max(data_site_85$zpptgrow)*sd(poar_2015_2016$pptgrow)+mean(poar_2015_2016$pptgrow))),                               
                      Time = c("Past", "Present", "RCP4.5","RCP8.5"))

rect_tempgrow <- data.frame(xmin = c((min(zclim_past$ztempgrow)*sd(poar_2015_2016$tempgrow)+mean(poar_2015_2016$tempgrow)), (min(zclim_current$ztempgrow)*sd(poar_2015_2016$tempgrow)+mean(poar_2015_2016$tempgrow)), (min(data_site_45$ztempgrow)*sd(poar_2015_2016$tempgrow)+mean(poar_2015_2016$tempgrow)),
(min(data_site_85$ztempgrow)*sd(poar_2015_2016$tempgrow)+mean(poar_2015_2016$tempgrow))), xmax = c((max(zclim_past$ztempgrow)*sd(poar_2015_2016$tempgrow)+mean(poar_2015_2016$tempgrow)), (max(zclim_current$ztempgrow)*sd(poar_2015_2016$tempgrow)+mean(poar_2015_2016$tempgrow)), (max(data_site_45$ztempgrow)*sd(poar_2015_2016$tempgrow)+mean(poar_2015_2016$tempgrow)),
(max(data_site_85$ztempgrow)*sd(poar_2015_2016$tempgrow)+mean(poar_2015_2016$tempgrow))),                                                                                                  Time = c("Past", "Present", "RCP4.5","RCP8.5"))

rect_pptdorm <- data.frame(xmin = c((min(zclim_past$zpptdorm)*sd(poar_2015_2016$pptdorm)+mean(poar_2015_2016$pptdorm)), (min(zclim_current$zpptdorm)*sd(poar_2015_2016$pptdorm)+mean(poar_2015_2016$pptdorm)), (min(data_site_45$zpptdorm)*sd(poar_2015_2016$pptdorm)+mean(poar_2015_2016$pptdorm)),
(min(data_site_85$zpptdorm)*sd(poar_2015_2016$pptdorm)+mean(poar_2015_2016$pptdorm))), xmax = c((max(zclim_past$zpptdorm)*sd(poar_2015_2016$pptdorm)+mean(poar_2015_2016$pptdorm)), (max(zclim_current$zpptdorm)*sd(poar_2015_2016$pptdorm)+mean(poar_2015_2016$pptdorm)), (max(data_site_45$zpptdorm)*sd(poar_2015_2016$pptdorm)+mean(poar_2015_2016$pptdorm)),                                                        (max(data_site_85$zpptdorm)*sd(poar_2015_2016$pptdorm)+mean(poar_2015_2016$pptdorm))),
                      Time = c("Past", "Present", "RCP4.5","RCP8.5"))


rect_tempdorm <- data.frame(xmin = c((min(zclim_past$ztempdorm)*sd(poar_2015_2016$tempdorm)+mean(poar_2015_2016$tempdorm)), (min(zclim_current$ztempdorm)*sd(poar_2015_2016$tempdorm)+mean(poar_2015_2016$tempdorm)), (min(data_site_45$ztempdorm)*sd(poar_2015_2016$tempdorm)+mean(poar_2015_2016$tempdorm)),
(min(data_site_85$ztempdorm)*sd(poar_2015_2016$tempdorm)+mean(poar_2015_2016$tempdorm))), xmax = c((max(zclim_past$ztempdorm)*sd(poar_2015_2016$tempdorm)+mean(poar_2015_2016$tempdorm)), (max(zclim_current$ztempdorm)*sd(poar_2015_2016$tempdorm)+mean(poar_2015_2016$tempdorm)), (max(data_site_45$ztempdorm)*sd(poar_2015_2016$tempdorm)+mean(poar_2015_2016$tempdorm)),
(max(data_site_85$ztempdorm)*sd(poar_2015_2016$tempdorm)+mean(poar_2015_2016$tempdorm))),                                                     
                      Time = c("Past", "Present", "RCP4.5","RCP8.5"))
colors <- c("Past" = "#009E73", "Present" = "#0072B2", "RCP4.5" = "#D55E00","RCP8.5"="#D81B60")


layout.matrix <- rbind(
                       matrix(1:4, nrow = 1, ncol = 4, byrow = F),
                       matrix(5:9, nrow = 1, ncol = 4, byrow = F))
#print figure
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/lambda_past_present_future_LTRE.pdf",height = 10,width = 14,useDingbats = F)

layout(mat = layout.matrix,
       heights = c(rep(c(2, 0.5),1),rep(c(2, 2),4)), # Heights of the two rows
       widths = c(2, 2, 2,2))
layout.show(16)

# par(oma=c(5,2,1.5,0.5))
par(oma=c(5,1,1.5,0.5))
par(mar=c(0,5,1,0))

par(mar=c(0,5,3,0))
plot(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),colSums(LTRE_PPTGROW_out[1:8,]),type="l",lwd=3,ylim=c(-10,3),col="grey20",lty=1,
     xlab="",ylab=expression(paste(partialdiff,lambda," / ",partialdiff,"pptgrow")),cex.lab=1.6,xaxt="n")
sex.symbols(700, 2, sex = 2, cex = 2.5, lwd = 2, col = "black")  
abline(h=0,col="black")
for(i in seq(1,8,by=2)){
  lines(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),colSums(LTRE_PPTGROW_out[i:(i+1),]),lty=ltre_lty[i],col=ltre_cols[i],lwd=2)
}
legend("bottomright",bty="n",legend=c("Survival","Growth","Flowering","Panicles","Total"),lwd=c(2,2,2,2,3),
       lty=c(na.omit(ltre_lty),1),col=c(na.omit(ltre_cols),"grey20"),cex=1)
mtext( "E",side = 3, adj = 0,cex=1.25)

par(mar=c(0,7,3,0))

plot(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow),colSums(LTRE_TEMPGROW_out[1:8,]),type="l",lwd=3,col="grey20",lty=1,
     xlab="Temperature (grow. season)",ylab=expression(paste(partialdiff,lambda," / ",partialdiff,"tempgrow")),ylim=c(-5,5),cex.lab=1.6,xaxt="n")
sex.symbols(18, 4, sex = 2, cex = 2.5, lwd = 2, col = "black")  
abline(h=0,col="black")
for(i in seq(1,8,by=2)){
  lines(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow),colSums(LTRE_TEMPGROW_out[i:(i+1),]),lty=ltre_lty[i],col=ltre_cols[i],lwd=2)
}
mtext( "F",side = 3, adj = 0,cex=1.25)
# legend("topright",bty="n",legend=c("Survival","Growth","Flowering","Panicles","Total"),lwd=c(2,2,2,2,4),
#        lty=c(na.omit(ltre_lty),2),col=c(na.omit(ltre_cols),"grey20"),cex=0.8,seg.len =1)

par(mar=c(0,7,3,0))
plot(all_pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),colSums(LTRE_PPTDORM_out[1:8,]),type="l",lwd=3,ylim=c(-10,3),col="grey20",lty=1,
     xlab="Precipitation (dorm. season)",ylab=expression(paste(partialdiff,lambda," / ",partialdiff,"pptdormant")),cex.lab=1.6,xaxt="n")
sex.symbols(448, 2.1, sex = 2, cex = 2.5, lwd = 2, col = "black")  
abline(h=0,col="black")
for(i in seq(1,8,by=2)){
  lines(all_pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),colSums(LTRE_PPTGROW_out[i:(i+1),]),lty=ltre_lty[i],col=ltre_cols[i],lwd=2)
}
mtext( "G",side = 3, adj = 0,cex=1.25)

plot(all_tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),colSums(LTRE_TEMPDORM_out[1:8,]),type="l",lwd=3,col="grey20",lty=1,
     xlab="Temperature (dorm. season)",ylab=expression(paste(partialdiff,lambda," / ",partialdiff,"tempdorm")),ylim=c(-5,5),cex.lab=1.8,xaxt="n")
abline(h=0,col="black")
for(i in seq(1,8,by=2)){
  lines(all_tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),colSums(LTRE_TEMPDORM_out[i:(i+1),]),lty=ltre_lty[i],col=ltre_cols[i],lwd=2)
}
sex.symbols(32, 4, sex = 2, cex = 2.5, lwd = 2, col = "black") 
mtext( "H",side = 3, adj = 0,cex=1.25)

par(mar=c(0,5,3,0))
plot(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),colSums(LTRE_PPTGROW_out[9:16,]),type="l",lwd=3,ylim=c(-10,3),col="grey20",
     xlab="Precipitation (grow. season)",ylab=expression(paste(partialdiff,lambda," / ",partialdiff,"pptgrow")),cex.lab=1.8)
sex.symbols(700, 2, sex = 1, cex = 2.5, lwd = 2, col = "black")  
abline(h=0,col="black")
for(i in seq(9,16,by=2)){
  lines(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),colSums(LTRE_PPTGROW_out[i:(i+1),]),lty=ltre_lty[i-8],col=ltre_cols[i-8],lwd=2)
}
mtext("Precipitation (grow. season)",side=1,line=3,cex=1.2)
mtext( "I",side = 3, adj = 0,cex=1.25)
legend("bottomright",bty="n",legend=c("Survival","Growth","Flowering","Panicles","Total"),lwd=c(2,2,2,2,3),
       lty=c(na.omit(ltre_lty),1),col=c(na.omit(ltre_cols),"grey20"),cex=1)

par(mar=c(0,7,3,0))
plot(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow),colSums(LTRE_TEMPGROW_out[9:16,]),type="l",lwd=3,col="grey20",
     xlab="Temperature (grow. season)",ylab=expression(paste(partialdiff,lambda," / ",partialdiff,"tempgrow")),ylim=c(-5,5),cex.lab=1.8)
sex.symbols(18, 4, sex = 1, cex = 2.5, lwd = 2, col = "black")  
abline(h=0,col="black")
for(i in seq(9,16,by=2)){
  lines(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow),colSums(LTRE_TEMPGROW_out[i:(i+1),]),lty=ltre_lty[i-8],col=ltre_cols[i-8],lwd=2)
}
mtext("Temperature (grow. season)",side=1,line=3,cex=1.2)
mtext( "J",side = 3, adj = 0,cex=1.25)
# legend("topright",bty="n",legend=c("Survival","Growth","Flowering","Panicles","Total"),lwd=c(2,2,2,2,3),
#        lty=c(na.omit(ltre_lty),1),col=c(na.omit(ltre_cols),"grey20"),cex=0.8)
# 
par(mar=c(0,7,3,0))
plot(all_pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),colSums(LTRE_PPTGROW_out[9:16,]),type="l",lwd=3,col="grey20",
     xlab="Precipitation (dorm. season)",ylab=expression(paste(partialdiff,lambda," / ",partialdiff,"pptdorm")),ylim=c(-10,3),cex.lab=1.8)
sex.symbols(400, 2, sex = 1, cex = 2.5, lwd = 2, col = "black")  
abline(h=0,col="black")
for(i in seq(9,16,by=2)){
  lines(all_pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),colSums(LTRE_PPTGROW_out[i:(i+1),]),lty=ltre_lty[i-8],col=ltre_cols[i-8],lwd=2)
}
mtext("Precipitation (dorm. season)",side=1,line=3,cex=1.2)
mtext("K",side = 3, adj = 0,cex=1.25)


par(mar=c(0,7,3,0))
plot(all_tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),colSums(LTRE_TEMPDORM_out[9:16,]),type="l",lwd=3,col="grey20",
     xlab="Temperature (dorm. season)",ylab=expression(paste(partialdiff,lambda," / ",partialdiff,"tempdorm")),ylim=c(-5,5),cex.lab=1.6)
abline(h=0,col="black")
for(i in seq(9,16,by=2)){
  lines(all_tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),colSums(LTRE_TEMPDORM_out[i:(i+1),]),lty=ltre_lty[i-8],col=ltre_cols[i-8],lwd=2)
}
sex.symbols(32, 4, sex = 1, cex = 2.5, lwd = 2, col = "black") 
mtext("Temperature (dorm. season)",side=1,line=3,cex=1.2)
mtext( "L",side = 3, adj = 0,cex=1.25)
dev.off()



```



```{r}
layout.matrix <- rbind(matrix(1:4, nrow = 2, ncol = 2, byrow = F),
                       matrix(5:8, nrow = 2, ncol = 2, byrow = F))
#print figure
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/lambda_past_present_future.pdf",height = 8,width = 7,useDingbats = F)

layout(mat = layout.matrix,
       heights = c(rep(c(2, 0.5),2),rep(c(2, 2),4)), # Heights of the two rows
       widths = c(2, 2, 2,2))
# layout.show(16)

# par(oma=c(5,1,1.5,0.5))
par(oma=c(8,1,3,0.5))
par(mar=c(0,5,0,0))
plot(all_pptgrow_seq*sd(poar_2015_2016$pptgrow)+mean(poar_2015_2016$pptgrow),lambda_pptgrow_all,ylim=c(0,9),
         xlab=" ",ylab="",type="n",xaxt="n");box()
# title(LETTERS[1],adj=0,cex.main=1.75)
mtext( "A",side = 3, adj = 0,cex=1.25)
mtext(expression(paste("Population growth rate, ", lambda)),side=2,line=3,cex=1)
abline(h = 1,lty=2,col="black")
lines (all_pptgrow_seq*sd(poar_2015_2016$pptgrow)+mean(poar_2015_2016$pptgrow),lambda_pptgrow_all,col="#E69F00", lwd=3)
lines(all_pptgrow_seq*sd(poar_2015_2016$pptgrow)+mean(poar_2015_2016$pptgrow),lambda_pptgrow_all_2sex, col = "#999999",lwd=3) 
legend(460, 8.5, legend=c("Female dominant", "Two-sex"),
       col=c("#E69F00", "#999999"), lty=1:1, cex=1.2,bty = "n",lwd=3,seg.len =2:2)

par(mar=c(1.75,5,0.25,0))
plot(all_pptgrow_seq*sd(poar_2015_2016$pptgrow)+mean(poar_2015_2016$pptgrow),lambda_pptgrow_all,ylim=c(0,2.5),
         xlab=" ",ylab="",yaxt="n",type="n")
mtext("Time",side=2,line=1,cex=1.)
mtext("Precipitation (grow. season)",side=1,line=2.75,cex=1.)
segments(x0 = rect_pptgrow[1,1],y0 = 2, x1 = rect_pptgrow[1,2],y1 = 2, col= colors[1],lwd = 4) 
segments(x0 = rect_pptgrow[2,1],y0 = 1.5, x1 = rect_pptgrow[2,2],y1 =1.5, col = colors[2],lwd = 4) 
segments(x0 = rect_pptgrow[3,1],y0 = 1, x1 = rect_pptgrow[3,2],y1 =1, col = colors[3],lwd = 4) 
segments(x0 = rect_pptgrow[4,1],y0 = 0.5, x1 = rect_pptgrow[4,2],y1 = 0.5, col = colors[4],lwd = 4) 

par(mar=c(0,5,0,0))
plot(all_tempgrow_seq*sd(poar_2015_2016$tempgrow)+mean(poar_2015_2016$tempgrow),lambda_tempgrow_all,ylim=c(0,5),
         xlab="Temperature (grow. season) ",ylab=" ",xaxt="n",type="n");box()
mtext( "B",side = 3, adj = 0,cex=1.25)
# mtext(expression(paste("Population growth rate, ", lambda)),side=2,line=3,cex=1.)
# title(LETTERS[2],adj=0,cex.main=1.75)
abline(h = 1,lty=2,col="black")
lines(all_tempgrow_seq*sd(poar_2015_2016$tempgrow)+mean(poar_2015_2016$tempgrow),lambda_tempgrow_all,col="#E69F00", lwd=3)
lines(all_tempgrow_seq*sd(poar_2015_2016$tempgrow)+mean(poar_2015_2016$tempgrow),lambda_tempgrow_all_2sex, col = "#999999",lwd=3)   

par(mar=c(1.75,5,0.25,0))
plot(all_tempgrow_seq*sd(poar_2015_2016$tempgrow)+mean(poar_2015_2016$tempgrow),lambda_tempgrow_all,ylim=c(0,2.5),
         xlab=" ",ylab=" ",yaxt="n",type="n");box()
mtext("Temperature (grow. season)",side=1,line=2.75,cex=1.)
segments(x0 = rect_tempgrow[1,1],y0 = 2, x1 = rect_tempgrow[1,2],y1 = 2, col= colors[1],lwd = 4) 
segments(x0 = rect_tempgrow[2,1],y0 = 1.5, x1 = rect_tempgrow[2,2],y1 =1.5, col = colors[2],lwd = 4) 
segments(x0 = rect_tempgrow[3,1],y0 = 1, x1 = rect_tempgrow[3,2],y1 =1, col = colors[3],lwd = 4) 
segments(x0 = rect_tempgrow[4,1],y0 = 0.5, x1 = rect_tempgrow[4,2],y1 = 0.5, col = colors[4],lwd = 4) 


par(mar=c(0,5,2.80,0))
plot(all_pptdorm_seq*sd(poar_2015_2016$pptdorm)+mean(poar_2015_2016$pptdorm),lambda_pptdorm_all,ylim=c(0,6),
         xlab=" ",ylab=" ",xaxt="n",type="n");box()
mtext(expression(paste("Population growth rate, ", lambda)),side=2,line=3,cex=1.)
# title(LETTERS[3],adj=0,cex.main=1.75)
mtext( "C",side = 3, adj = 0,cex=1.25)
# mtext(expression(paste("Population growth rate, ", lambda)),side=2,line=3,cex=1.2)
abline(h = 1,lty=2,col="black")
lines(all_pptdorm_seq*sd(poar_2015_2016$pptdorm)+mean(poar_2015_2016$pptdorm),lambda_pptdorm_all,col="#E69F00", lwd=3)
lines(all_pptdorm_seq*sd(poar_2015_2016$pptdorm)+mean(poar_2015_2016$pptdorm),lambda_pptdorm_all_2sex, col = "#999999",lwd=3)

par(mar=c(1.75,5,0.25,0))
plot(all_pptdorm_seq*sd(poar_2015_2016$pptdorm)+mean(poar_2015_2016$pptdorm),lambda_pptdorm_all,ylim=c(0,2.5),
         xlab=" ",ylab=" ",yaxt="n",type="n")
mtext("Precipitation (dorm. season)",side=1,line=2.75,cex=1.)
mtext("Time",side=2,line=1.5,cex=1.)
segments(x0 = rect_pptdorm[1,1], x1 = rect_pptdorm[1,2], y0 = 2, y1 = 2, col = colors[1],lwd = 4)
segments(x0 = rect_pptdorm[2,1], x1 = rect_pptdorm[2,2], y0 = 1.5, y1 = 1.5, col = colors[2],lwd = 4) 
segments(x0 = rect_pptdorm[3,1], x1 = rect_pptdorm[3,2], y0 = 1, y1 = 1, col = colors[3],lwd = 4)
segments(x0 = rect_pptdorm[4,1], x1 = rect_pptdorm[4,2], y0 = 0.5, y1 = 0.5, col = colors[4],lwd = 4)

par(mar=c(0,5,2.80,0))
plot(all_tempdorm_seq*sd(poar_2015_2016$tempdorm)+mean(poar_2015_2016$tempdorm),lambda_tempdorm_all,ylim=c(0,5),xlab=" ",ylab=" ",xaxt="n",type="n");box()
# mtext(expression(paste("Population growth rate, ", lambda)),side=2,line=3,cex=1.)
# title(LETTERS[4],adj=0,cex.main=1.75)
mtext( "D",side = 3, adj = 0,cex=1.25)
abline(h = 1,lty=2,col="black")
lines(all_tempdorm_seq*sd(poar_2015_2016$tempdorm)+mean(poar_2015_2016$tempdorm),lambda_tempdorm_all,col="#E69F00", lwd=3)
lines(all_tempdorm_seq*sd(poar_2015_2016$tempdorm)+mean(poar_2015_2016$tempdorm),lambda_tempdorm_all_2sex, col = "#999999",lwd=3)

par(mar=c(1.75,5,0.25,0))
plot(all_tempdorm_seq*sd(poar_2015_2016$tempdorm)+mean(poar_2015_2016$tempdorm),lambda_tempdorm_all,ylim=c(0,2.5),
         xlab=" ",ylab=" ",yaxt="n",type="n")
mtext("Temperature (dorm. season)",side=1,line=2.75,cex=1.)
segments(x0 = rect_tempdorm[1,1], x1 = rect_tempdorm[1,2], y0 = 2, y1 = 2, col = colors[1],lwd = 4)
segments(x0 = rect_tempdorm[2,1], x1 = rect_tempdorm[2,2], y0 = 1.5, y1 = 1.5, col = colors[2],lwd = 4) 
segments(x0 = rect_tempdorm[3,1], x1 = rect_tempdorm[3,2], y0 = 1, y1 = 1, col = colors[3],lwd = 4)
segments(x0 = rect_tempdorm[4,1], x1 = rect_tempdorm[4,2], y0 = 0.5, y1 = 0.5, col = colors[4],lwd = 4)
# legend(31, 2.5, legend=c("Past", "Present", "RCP4.5","RCP8.5"),
#        col=colors, lty=1:1, seg.len =0.5:0.5,bty ="n",cex=0.75,lwd = 5)
text(29, 2.1, "Past",cex=1.)
text(30.3, 1.6, "Present",cex=1.)
text(32, 1.1, "RCP 4.5",cex=1.)
text(28, 0.5, "RCP 8.5",cex=1.)
dev.off()

```



```{r}
layout.matrix <- rbind(matrix(1:4, nrow = 2, ncol = 2, byrow = F))
#print figure
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/lambda_past_present_future_ESA.pdf",height = 5,width = 9,useDingbats = F)

layout(mat = layout.matrix,
       heights = c(rep(c(2, 0.5),2),rep(c(2, 2),2)), # Heights of the two rows
       widths = c(2, 2, 2,2))
# layout.show(4)

# par(oma=c(5,1,1.5,0.5))
par(oma=c(3,1,3,0.5))
par(mar=c(0,5,0,0))
plot(all_tempdorm_seq*sd(poar_2015_2016$tempdorm)+mean(poar_2015_2016$tempdorm),lambda_tempdorm_all,ylim=c(0,5),xlab=" ",ylab=" ",xaxt="n",type="n");box()
# mtext(expression(paste("Population growth rate, ", lambda)),side=2,line=3,cex=1.)
# title(LETTERS[4],adj=0,cex.main=1.75)
mtext( "A",side = 3, adj = 0,cex=1.25)
mtext(expression(paste("Population growth rate, ", lambda)),side=2,line=3,cex=1.4)
abline(h = 1,lty=2,col="black")
lines(all_tempdorm_seq*sd(poar_2015_2016$tempdorm)+mean(poar_2015_2016$tempdorm),lambda_tempdorm_all,col="#E69F00", lwd=3)
lines(all_tempdorm_seq*sd(poar_2015_2016$tempdorm)+mean(poar_2015_2016$tempdorm),lambda_tempdorm_all_2sex, col = "#999999",lwd=3)

par(mar=c(1.75,5,0.25,0))
plot(all_tempdorm_seq*sd(poar_2015_2016$tempdorm)+mean(poar_2015_2016$tempdorm),lambda_tempdorm_all,ylim=c(0,2.5),
         xlab=" ",ylab=" ",yaxt="n",type="n")
mtext("Temperature (dorm. season)",side=1,line=2.75,cex=1.4)
mtext("Time",side=2,line=1,cex=1.2)
segments(x0 = rect_tempdorm[1,1], x1 = rect_tempdorm[1,2], y0 = 2, y1 = 2, col = colors[1],lwd = 4)
segments(x0 = rect_tempdorm[2,1], x1 = rect_tempdorm[2,2], y0 = 1.5, y1 = 1.5, col = colors[2],lwd = 4) 
segments(x0 = rect_tempdorm[3,1], x1 = rect_tempdorm[3,2], y0 = 1, y1 = 1, col = colors[3],lwd = 4)
segments(x0 = rect_tempdorm[4,1], x1 = rect_tempdorm[4,2], y0 = 0.5, y1 = 0.5, col = colors[4],lwd = 4)
# legend(31, 2.5, legend=c("Past", "Present", "RCP4.5","RCP8.5"),
#        col=colors, lty=1:1, seg.len =0.5:0.5,bty ="n",cex=0.75,lwd = 5)
text(29, 2.1, "Past",cex=1.)
text(30.3, 1.6, "Present",cex=1.)
text(32, 1.1, "RCP 4.5",cex=1.)
text(28, 0.5, "RCP 8.5",cex=1.)


par(mar=c(0,5,0,0))
plot(all_tempgrow_seq*sd(poar_2015_2016$tempgrow)+mean(poar_2015_2016$tempgrow),lambda_tempgrow_all,ylim=c(0,5),
         xlab="Temperature (grow. season) ",ylab=" ",xaxt="n",type="n");box()
mtext( "B",side = 3, adj = 0,cex=1.25)
# mtext(expression(paste("Population growth rate, ", lambda)),side=2,line=3,cex=1.)
# title(LETTERS[2],adj=0,cex.main=1.75)
abline(h = 1,lty=2,col="black")
lines(all_tempgrow_seq*sd(poar_2015_2016$tempgrow)+mean(poar_2015_2016$tempgrow),lambda_tempgrow_all,col="#E69F00", lwd=3)
lines(all_tempgrow_seq*sd(poar_2015_2016$tempgrow)+mean(poar_2015_2016$tempgrow),lambda_tempgrow_all_2sex, col = "#999999",lwd=3)   
lines(all_tempdorm_seq*sd(poar_2015_2016$tempdorm)+mean(poar_2015_2016$tempdorm),lambda_tempdorm_all_2sex, col = "#999999",lwd=3)
legend(7.3, 5.1, legend=c("Female dominant", "Two-sex"),
       col=c("#E69F00", "#999999"), lty=1:1, cex=1,bty = "n",lwd=3,seg.len =2:2)

par(mar=c(1.75,5,0.25,0))
plot(all_tempgrow_seq*sd(poar_2015_2016$tempgrow)+mean(poar_2015_2016$tempgrow),lambda_tempgrow_all,ylim=c(0,2.5),
         xlab=" ",ylab=" ",yaxt="n",type="n");box()
mtext("Temperature (grow. season)",side=1,line=2.75,cex=1.4)
segments(x0 = rect_tempgrow[1,1],y0 = 2, x1 = rect_tempgrow[1,2],y1 = 2, col= colors[1],lwd = 4) 
segments(x0 = rect_tempgrow[2,1],y0 = 1.5, x1 = rect_tempgrow[2,2],y1 =1.5, col = colors[2],lwd = 4) 
segments(x0 = rect_tempgrow[3,1],y0 = 1, x1 = rect_tempgrow[3,2],y1 =1, col = colors[3],lwd = 4) 
segments(x0 = rect_tempgrow[4,1],y0 = 0.5, x1 = rect_tempgrow[4,2],y1 = 0.5, col = colors[4],lwd = 4) 

dev.off()

```


```{r}
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/lambdapredcited.pdf",width=5,height=5,useDingbats = F)
(figurecombo1 <- ggarrange(figcombo1, figcombo2,figcombo3,figcombo4,
                     hjust = -2, labels = c("A", "B","C","D"), common.legend = TRUE,legend="bottom" ,font.label = list(size = 10, color = "black", face = "plain", family = NULL), vjust = 2, widths = c(2, 2), heights = 0.5, align = "hv",
                     ncol = 2, nrow = 2
))

dev.off()

```

## LTRE

```{r}
pptgrow_seq<-seq(min(data_past_present_45_85$zpptgrow),max(data_past_present_45_85$zpptgrow),length.out=30)
## LTRE parameters:
# these are the indices of the intercepts and slopes
LTRE_params <- c(1,2,13,14,26,27,38,39)
# these are the effects of pptgrow on the intercepts and slopes
betas_pptgrow <- c(F_params[c("surv_pptgrow","surv_tempgrow_pptgrow","grow_pptgrow","grow_tempgrow_pptgrow","flow_pptgrow","flow_tempgrow_pptgrow","panic_pptgrow","panic_tempgrow_pptgrow")],
                M_params[c("surv_pptgrow","surv_tempgrow_pptgrow","grow_pptgrow","grow_tempgrow_pptgrow","flow_pptgrow","flow_tempgrow_pptgrow","panic_pptgrow","panic_tempgrow_pptgrow")])
# these are the effects of pptgrow^2 on the intercepts and slopes
betas_pptgrow2 <- c(F_params[c("surv_pptgrow2","grow_pptgrow2","flow_pptgrow2","panic_pptgrow2")],
                 M_params[c("surv_pptgrow2","grow_pptgrow2","flow_pptgrow2","panic_pptgrow2")])

## Sensitivity of parameters to pptgrow -- this is just the derivative of a second-order polynomial
dp_dpptgrow_fun <- function(beta_pptgrow,beta_pptgrow2,pptgrow){return(beta_pptgrow + 2*beta_pptgrow2*pptgrow)}

## loop over pptgrow and calculated dp_dpptgrow and dlambda_dp
dp_dpptgrow <- dlambda_dp <- matrix(NA,nrow=length(LTRE_params)*2,ncol=length(pptgrow_seq))
lambda_pptgrow <- c()
perturbation <- 0.01

for(l in 1:length(pptgrow_seq)){
 lambda_pptgrow[l] <- lambdaSim_delay(F_params=F_params,M_params=M_params,zpptgrow=pptgrow_seq[l],ztempgrow=0,zpptdorm=0,ztempdorm=0,rfx=rfx_fun(),max.yrs=max_yrs)$lambdatracker[max_yrs]
 dp_dpptgrow[,l] <- dp_dpptgrow_fun(beta_pptgrow = unlist(betas_pptgrow),
                              beta_pptgrow2 = unlist(betas_pptgrow2),
                              pptgrow=pptgrow_seq[l])
# cannot vectorize this part unfortunately
 for(p in 1:8){
   F_params_perturb <- F_params; M_params_perturb <- M_params;
   F_params_perturb[LTRE_params[p]] <- unlist(F_params[LTRE_params[p]]) + perturbation
   lambda_perturb <- lambdaSim_delay(F_params=F_params_perturb,M_params=M_params_perturb,zpptgrow=pptgrow_seq[l],ztempgrow=0,zpptdorm=0,ztempdorm=0,rfx=rfx_fun(),max.yrs=max_yrs)$lambdatracker[max_yrs]
   dlambda_dp[p,l] <- (lambda_perturb - lambda_pptgrow[l]) / perturbation
 }
 for(p in 9:16){
   F_params_perturb <- F_params; M_params_perturb <- M_params;
   M_params_perturb[LTRE_params[p-8]] <- unlist(M_params[LTRE_params[p-8]]) + perturbation
   lambda_perturb <- lambdaSim_delay(F_params=F_params_perturb,M_params=M_params_perturb,zpptgrow=pptgrow_seq[l],ztempgrow=0,zpptdorm=0,ztempdorm=0,rfx=rfx_fun(),max.yrs=max_yrs)$lambdatracker[max_yrs]
   dlambda_dp[p,l] <- (lambda_perturb - lambda_pptgrow[l]) / perturbation
 }
 print(l)
}
## write LTRE output based on posterior mean parameters
write_rds(list(dp_dpptgrow=dp_dpptgrow,dlambda_dp=dlambda_dp),"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/POAR_LTREPPTGROW.rds")

```

```{r}
## read LTRE output
POAR_LTRE_PPTGROW <- readRDS(url("https://www.dropbox.com/scl/fi/eu9xnhl0qfizaoom3uj88/POAR_LTREPPTGROW.rds?rlkey=l70j7j7n18cli9wosi4m5pgzs&dl=1"))
# put it all together 
LTRE_PPTGROW_out <- POAR_LTRE_PPTGROW$dp_dpptgrow * POAR_LTRE_PPTGROW$dlambda_dp

# Plot male and feme contribution
# ltre_cols <- c("#D55E00",NA,"#56B4E9",NA,"#009E73",NA,"#CC79A7",NA)

```

```{r}
tempgrow_seq<-seq(min(data_past_present_45_85$ztempgrow),max(data_past_present_45_85$ztempgrow),length.out=30)
## LTRE parameters:
# these are the indices of the intercepts and slopes
LTRE_params <- c(1,2,13,14,26,27,38,39)
# these are the effects of pptgrow on the intercepts and slopes
betas_tempgrow <- c(F_params[c("surv_tempgrow","surv_tempgrow_pptgrow","grow_tempgrow","grow_tempgrow_pptgrow","flow_tempgrow","flow_tempgrow_pptgrow","panic_tempgrow","panic_tempgrow_pptgrow")],
                M_params[c("surv_tempgrow","surv_tempgrow_pptgrow","grow_tempgrow","grow_tempgrow_pptgrow","flow_tempgrow","flow_tempgrow_pptgrow","panic_tempgrow","panic_tempgrow_pptgrow")])
# these are the effects of pptgrow^2 on the intercepts and slopes
betas_tempgrow2 <- c(F_params[c("surv_tempgrow2","grow_tempgrow2","flow_tempgrow2","panic_tempgrow2")],
                 M_params[c("surv_tempgrow2","grow_tempgrow2","flow_tempgrow2","panic_tempgrow2")])

## Sensitivity of parameters to pptgrow -- this is just the derivative of a second-order polynomial
dp_dtempgrow_fun <- function(beta_tempgrow,beta_tempgrow2,tempgrow){return(beta_tempgrow + 2*beta_tempgrow2*tempgrow)}

## loop over pptgrow and calculated dp_dpptgrow and dlambda_dp
dp_dtempgrow <- dlambda_dp <- matrix(NA,nrow=length(LTRE_params)*2,ncol=length(tempgrow_seq))
lambda_tempgrow <- c()
perturbation <- 0.01

for(l in 1:length(tempgrow_seq)){
 lambda_tempgrow[l] <- lambdaSim_delay(F_params=F_params,M_params=M_params,zpptgrow=0,ztempgrow=tempgrow_seq[l],zpptdorm=0,ztempdorm=0,rfx=rfx_fun(),max.yrs=max_yrs)$lambdatracker[max_yrs]
 dp_dtempgrow[,l] <- dp_dtempgrow_fun(beta_tempgrow = unlist(betas_tempgrow),
                              beta_tempgrow2 = unlist(betas_tempgrow2),
                              tempgrow=tempgrow_seq[l])
# cannot vectorize this part unfortunately
 for(p in 1:8){
   F_params_perturb <- F_params; M_params_perturb <- M_params;
   F_params_perturb[LTRE_params[p]] <- unlist(F_params[LTRE_params[p]]) + perturbation
   lambda_perturb <- lambdaSim_delay(F_params=F_params_perturb,M_params=M_params_perturb,zpptgrow=0,ztempgrow=tempgrow_seq[l],zpptdorm=0,ztempdorm=0,rfx=rfx_fun(),max.yrs=max_yrs)$lambdatracker[max_yrs]
   dlambda_dp[p,l] <- (lambda_perturb - lambda_tempgrow[l]) / perturbation
 }
 for(p in 9:16){
   F_params_perturb <- F_params; M_params_perturb <- M_params;
   M_params_perturb[LTRE_params[p-8]] <- unlist(M_params[LTRE_params[p-8]]) + perturbation
   lambda_perturb <- lambdaSim_delay(F_params=F_params_perturb,M_params=M_params_perturb,zpptgrow=0,ztempgrow=tempgrow_seq[l],zpptdorm=0,ztempdorm=0,rfx=rfx_fun(),max.yrs=max_yrs)$lambdatracker[max_yrs]
   dlambda_dp[p,l] <- (lambda_perturb - lambda_tempgrow[l]) / perturbation
 }
 print(l)
}
## write LTRE output based on posterior mean parameters
# write_rds(list(dp_dtempgrow=dp_dtempgrow,dlambda_dp=dlambda_dp),"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/POAR_LTRETEMPGROW.rds")

```

```{r}
## read LTRE output
POAR_LTRE_TEMPGROW <- readRDS(url("https://www.dropbox.com/scl/fi/o3zaudgef040befdqdj2j/POAR_LTRETEMPGROW.rds?rlkey=cqy74r3mw0vtvx0r6obhlmk0f&dl=1"))
# put it all together 
LTRE_TEMPGROW_out <- POAR_LTRE_TEMPGROW$dp_dtempgrow * POAR_LTRE_TEMPGROW$dlambda_dp
# Plot male and feme contribution
# ltre_cols <- c("#D55E00",NA,"#56B4E9",NA,"#009E73",NA,"#CC79A7",NA)
```

```{r}
all_pptdorm_seq<-seq(min(data_past_present_45_85$zpptdorm),max(data_past_present_45_85$zpptdorm),length.out=30)
max_yrs<-30

## LTRE parameters:
# these are the indices of the intercepts and slopes
LTRE_params <- c(1,2,13,14,26,27,38,39)
# these are the effects of pptdorm on the intercepts and slopes
betas_pptdorm <- c(F_params[c("surv_pptdorm","surv_tempdorm_pptdorm","grow_pptdorm","grow_tempdorm_pptdorm","flow_pptdorm","flow_tempdorm_pptdorm","panic_pptdorm","panic_tempdorm_pptdorm")],
                M_params[c("surv_pptdorm","surv_tempdorm_pptdorm","grow_pptdorm","grow_tempdorm_pptdorm","flow_pptdorm","flow_tempdorm_pptdorm","panic_pptdorm","panic_tempdorm_pptdorm")])
# these are the effects of pptdorm^2 on the intercepts and slopes
betas_pptdorm2 <- c(F_params[c("surv_pptdorm2","grow_pptdorm2","flow_pptdorm2","panic_pptdorm2")],
                 M_params[c("surv_pptdorm2","grow_pptdorm2","flow_pptdorm2","panic_pptdorm2")])

## Sensitivity of parameters to pptdorm -- this is just the derivative of a second-order polynomial
dp_dpptdorm_fun <- function(beta_pptdorm,beta_pptdorm2,pptdorm){return(beta_pptdorm + 2*beta_pptdorm2*pptdorm)}

## loop over pptdorm and calculated dp_dpptdorm and dlambda_dp
dp_dpptdorm <- dlambda_dp <- matrix(NA,nrow=length(LTRE_params)*2,ncol=length(all_pptdorm_seq))
lambda_pptdorm <- c()
perturbation <- 0.01

for(l in 1:length(all_pptdorm_seq)){
 lambda_pptdorm[l] <- lambdaSim_delay(F_params=F_params,M_params=M_params,zpptgrow=0,ztempgrow=0,ztempdorm=0,zpptdorm=all_pptdorm_seq[l],rfx=rfx_fun(),max.yrs=max_yrs)$lambdatracker[max_yrs]
 dp_dpptdorm[,l] <- dp_dpptdorm_fun(beta_pptdorm = unlist(betas_pptdorm),
                              beta_pptdorm2 = unlist(betas_pptdorm2),
                              pptdorm=all_pptdorm_seq[l])
# cannot vectorize this part unfortunately
 for(p in 1:8){
   F_params_perturb <- F_params; M_params_perturb <- M_params;
   F_params_perturb[LTRE_params[p]] <- unlist(F_params[LTRE_params[p]]) + perturbation
   lambda_perturb <- lambdaSim_delay(F_params=F_params_perturb,M_params=M_params_perturb,zpptgrow=0,ztempgrow=0,ztempdorm=0,zpptdorm=all_pptdorm_seq[l],rfx=rfx_fun(),max.yrs=max_yrs)$lambdatracker[max_yrs]
   dlambda_dp[p,l] <- (lambda_perturb - lambda_pptdorm[l]) / perturbation
 }
 for(p in 9:16){
   F_params_perturb <- F_params; M_params_perturb <- M_params;
   M_params_perturb[LTRE_params[p-8]] <- unlist(M_params[LTRE_params[p-8]]) + perturbation
   lambda_perturb <- lambdaSim_delay(F_params=F_params_perturb,M_params=M_params_perturb,zpptgrow=0,ztempgrow=0,ztempdorm=0,zpptdorm=all_pptdorm_seq[l],rfx=rfx_fun(),max.yrs=max_yrs)$lambdatracker[max_yrs]
   dlambda_dp[p,l] <- (lambda_perturb - lambda_pptdorm[l]) / perturbation
 }
 print(l)
}
## write LTRE output based on posterior mean parameters
# write_rds(list(dp_dpptdorm=dp_dpptdorm,dlambda_dp=dlambda_dp),"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/POAR_LTREPPTDORM.rds")

```

```{r}
## read LTRE output
POAR_LTRE_PPTDORM <- readRDS(url("https://www.dropbox.com/scl/fi/fppc6kjqx1cgayk7wf95w/POAR_LTREPPTDORM.rds?rlkey=qrv2r9atakg7e2hlhof4xoyzs&dl=1"))
# put it all together 
LTRE_PPTDORM_out <- POAR_LTRE_PPTDORM$dp_dpptdorm * POAR_LTRE_PPTDORM$dlambda_dp
```

```{r}
all_tempdorm_seq<-seq(min(data_past_present_45_85$ztempdorm),max(data_past_present_45_85$ztempdorm),length.out=30)
max_yrs<-30

## LTRE parameters:
# these are the indices of the intercepts and slopes
LTRE_params <- c(1,2,13,14,26,27,38,39)
# these are the effects of tempdorm on the intercepts and slopes
betas_tempdorm <- c(F_params[c("surv_tempdorm","surv_tempdorm_pptdorm","grow_tempdorm","grow_tempdorm_pptdorm","flow_tempdorm","flow_tempdorm_pptdorm","panic_tempdorm","panic_tempdorm_pptdorm")],
                M_params[c("surv_tempdorm","surv_tempdorm_pptdorm","grow_tempdorm","grow_tempdorm_pptdorm","flow_tempdorm","flow_tempdorm_pptdorm","panic_tempdorm","panic_tempdorm_pptdorm")])
# these are the effects of tempdorm^2 on the intercepts and slopes
betas_tempdorm2 <- c(F_params[c("surv_tempdorm2","grow_tempdorm2","flow_tempdorm2","panic_tempdorm2")],
                 M_params[c("surv_tempdorm2","grow_tempdorm2","flow_tempdorm2","panic_tempdorm2")])

## Sensitivity of parameters to tempdorm -- this is just the derivative of a second-order polynomial
dp_dtempdorm_fun <- function(beta_tempdorm,beta_tempdorm2,tempdorm){return(beta_tempdorm + 2*beta_tempdorm2*tempdorm)}

## loop over tempdorm and calculated dp_dtempdorm and dlambda_dp
dp_dtempdorm <- dlambda_dp <- matrix(NA,nrow=length(LTRE_params)*2,ncol=length(all_tempdorm_seq))
lambda_tempdorm <- c()
perturbation <- 0.01

for(l in 1:length(all_tempdorm_seq)){
 lambda_tempdorm[l] <- lambdaSim_delay(F_params=F_params,M_params=M_params,zpptgrow=0,ztempgrow=0,zpptdorm=0,ztempdorm=all_tempdorm_seq[l],rfx=rfx_fun(),max.yrs=max_yrs)$lambdatracker[max_yrs]
 dp_dtempdorm[,l] <- dp_dtempdorm_fun(beta_tempdorm = unlist(betas_tempdorm),
                              beta_tempdorm2 = unlist(betas_tempdorm2),
                              tempdorm=all_tempdorm_seq[l])
# cannot vectorize this part unfortunately
 for(p in 1:8){
   F_params_perturb <- F_params; M_params_perturb <- M_params;
   F_params_perturb[LTRE_params[p]] <- unlist(F_params[LTRE_params[p]]) + perturbation
   lambda_perturb <- lambdaSim_delay(F_params=F_params_perturb,M_params=M_params_perturb,zpptgrow=0,ztempgrow=0,zpptdorm=0,ztempdorm=all_tempdorm_seq[l],rfx=rfx_fun(),max.yrs=max_yrs)$lambdatracker[max_yrs]
   dlambda_dp[p,l] <- (lambda_perturb - lambda_tempdorm[l]) / perturbation
 }
 for(p in 9:16){
   F_params_perturb <- F_params; M_params_perturb <- M_params;
   M_params_perturb[LTRE_params[p-8]] <- unlist(M_params[LTRE_params[p-8]]) + perturbation
   lambda_perturb <- lambdaSim_delay(F_params=F_params_perturb,M_params=M_params_perturb,zpptgrow=0,ztempgrow=0,zpptdorm=0,ztempdorm=all_tempdorm_seq[l],rfx=rfx_fun(),max.yrs=max_yrs)$lambdatracker[max_yrs]
   dlambda_dp[p,l] <- (lambda_perturb - lambda_tempdorm[l]) / perturbation
 }
 print(l)
}
## write LTRE output based on posterior mean parameters
# write_rds(list(dp_dtempdorm=dp_dtempdorm,dlambda_dp=dlambda_dp),"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/POAR_LTRETEMPDORM.rds")

```

```{r}
## read LTRE output
POAR_LTRE_TEMPDORM <- readRDS(url("https://www.dropbox.com/scl/fi/l6lpwgi11lb4qkks501sh/POAR_LTRETEMPDORM.rds?rlkey=m9m0jw9qsrutr7z31rkl3hdp1&dl=1"))
# put it all together 
LTRE_TEMPDORM_out <- POAR_LTRE_TEMPDORM$dp_dtempdorm * POAR_LTRE_TEMPDORM$dlambda_dp
```

```{r}
# ltre_cols <- c("#D55E00",NA,"#56B4E9",NA,"#009E73",NA,"#CC79A7",NA)
ltre_cols <- c("#7570B3",NA,"#0072B2",NA,"#E7298A",NA,"#FFDB6D",NA)
ltre_lty <- c(1,NA,1,NA,1,NA,1,NA)

pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/LTRE_Temperature.pdf",width=7,height=7,useDingbats = F)
par(oma=c(5,3,0.5,0.5))
# par(mar=c(5,4,1,0),mfrow=c(2,2))
par(mar=c(5,5,1,1),mfrow=c(2,2))
plot(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow),colSums(LTRE_TEMPGROW_out[1:8,]),type="l",lwd=3,col="grey20",lty=1,
     xlab="Temperature (grow. season)",ylab=expression(paste(partialdiff,lambda," / ",partialdiff,"tempgrow")),ylim=c(-5,5),cex.lab=1.2)
sex.symbols(9, -3, sex = 2, cex = 1.5, lwd = 2, col = "black")  
abline(h=0,col="black")
for(i in seq(1,8,by=2)){
  lines(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow),colSums(LTRE_TEMPGROW_out[i:(i+1),]),lty=ltre_lty[i],col=ltre_cols[i],lwd=2)
}
mtext( "A",side = 3, adj = 0,cex=1.25)
# legend("topright",bty="n",legend=c("Survival","Growth","Flowering","Panicles","Total"),lwd=c(2,2,2,2,4),
#        lty=c(na.omit(ltre_lty),2),col=c(na.omit(ltre_cols),"grey20"),cex=0.8,seg.len =1)

plot(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow),colSums(LTRE_TEMPGROW_out[9:16,]),type="l",lwd=3,col="grey20",
     xlab="Temperature (grow. season)",ylab=expression(paste(partialdiff,lambda," / ",partialdiff,"tempgrow")),ylim=c(-5,5),cex.lab=1.2)
sex.symbols(9, -3, sex = 1, cex = 1.5, lwd = 2, col = "black")  
abline(h=0,col="black")
for(i in seq(9,16,by=2)){
  lines(tempgrow_seq*sd(poar_2015_2016$tempgrow) + mean(poar_2015_2016$tempgrow),colSums(LTRE_TEMPGROW_out[i:(i+1),]),lty=ltre_lty[i-8],col=ltre_cols[i-8],lwd=2)
}
mtext( "B",side = 3, adj = 0,cex=1.25)
legend("topright",bty="n",legend=c("Survival","Growth","Flowering","Panicles","Total"),lwd=c(2,2,2,2,3),
       lty=c(na.omit(ltre_lty),1),col=c(na.omit(ltre_cols),"grey20"),cex=0.8)

# par(mar=c(5,5,1,1),mfrow=c(2,1))
plot(all_tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),colSums(LTRE_TEMPDORM_out[1:8,]),type="l",lwd=3,col="grey20",lty=1,
     xlab="Temperature (dorm. season)",ylab=expression(paste(partialdiff,lambda," / ",partialdiff,"tempdorm")),ylim=c(-5,5),cex.lab=1.2)
abline(h=0,col="black")
for(i in seq(1,8,by=2)){
  lines(all_tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),colSums(LTRE_TEMPDORM_out[i:(i+1),]),lty=ltre_lty[i],col=ltre_cols[i],lwd=2)
}
sex.symbols(25, -4, sex = 2, cex = 1.5, lwd = 2, col = "black") 
mtext( "C",side = 3, adj = 0,cex=1.25)

plot(all_tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),colSums(LTRE_TEMPDORM_out[9:16,]),type="l",lwd=3,col="grey20",
     xlab="Temperature (dorm.season)",ylab=expression(paste(partialdiff,lambda," / ",partialdiff,"tempdorm")),ylim=c(-5,5),cex.lab=1.2)
abline(h=0,col="black")
for(i in seq(9,16,by=2)){
  lines(all_tempdorm_seq*sd(poar_2015_2016$tempdorm) + mean(poar_2015_2016$tempdorm),colSums(LTRE_TEMPDORM_out[i:(i+1),]),lty=ltre_lty[i-8],col=ltre_cols[i-8],lwd=2)
}
sex.symbols(25, -4, sex = 1, cex = 1.5, lwd = 2, col = "black") 
mtext( "D",side = 3, adj = 0,cex=1.25)
dev.off()
```

```{r}
ltre_cols <- c("#7570B3",NA,"#0072B2",NA,"#E7298A",NA,"#E6AB02",NA)
ltre_lty <- c(1,NA,1,NA,1,NA,1,NA)

pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/LTRE_Precipitation.pdf",width=7,height=7,useDingbats = F)
par(oma=c(5,2,1.5,0.5))
# par(mar=c(5,4,1,0),mfrow=c(2,2))
par(mar=c(5,5,1,1),mfrow=c(2,2))
plot(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),colSums(LTRE_PPTGROW_out[1:8,]),type="l",lwd=3,ylim=c(-10,3),col="grey20",lty=1,
     xlab="Precipitation (grow. season)",ylab=expression(paste(partialdiff,lambda," / ",partialdiff,"pptgrow")),cex.lab=1.2)
sex.symbols(700, 2, sex = 2, cex = 1.5, lwd = 2, col = "black")  
abline(h=0,col="black")
for(i in seq(1,8,by=2)){
  lines(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),colSums(LTRE_PPTGROW_out[i:(i+1),]),lty=ltre_lty[i],col=ltre_cols[i],lwd=2)
}
mtext( "A",side = 3, adj = 0,cex=1.25)
plot(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),colSums(LTRE_PPTGROW_out[9:16,]),type="l",lwd=3,ylim=c(-10,3),col="grey20",
     xlab="Precipitation (grow. season)",ylab=expression(paste(partialdiff,lambda," / ",partialdiff,"pptgrow")),cex.lab=1.2)
sex.symbols(700, 2, sex = 1, cex = 1.5, lwd = 2, col = "black")  
abline(h=0,col="black")
for(i in seq(9,16,by=2)){
  lines(pptgrow_seq*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow),colSums(LTRE_PPTGROW_out[i:(i+1),]),lty=ltre_lty[i-8],col=ltre_cols[i-8],lwd=2)
}
mtext( "B",side = 3, adj = 0,cex=1.25)
legend("bottomright",bty="n",legend=c("Survival","Growth","Flowering","Panicles","Total"),lwd=c(2,2,2,2,3),
       lty=c(na.omit(ltre_lty),1),col=c(na.omit(ltre_cols),"grey20"),cex=0.8)

plot(all_pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),colSums(LTRE_PPTDORM_out[1:8,]),type="l",lwd=3,ylim=c(-10,3),col="grey20",lty=1,
     xlab="Precipitation (dorm. season)",ylab=expression(paste(partialdiff,lambda," / ",partialdiff,"pptdormant")),cex.lab=1.2)
sex.symbols(425, 2.75, sex = 2, cex = 1.5, lwd = 2, col = "black")  
abline(h=0,col="black")
for(i in seq(1,8,by=2)){
  lines(all_pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),colSums(LTRE_PPTGROW_out[i:(i+1),]),lty=ltre_lty[i],col=ltre_cols[i],lwd=2)
}
mtext( "C",side = 3, adj = 0,cex=1.25)

plot(all_pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),colSums(LTRE_PPTGROW_out[9:16,]),type="l",lwd=3,col="grey20",
     xlab="Precipitation (dorm. season)",ylab=expression(paste(partialdiff,lambda," / ",partialdiff,"pptdorm")),ylim=c(-10,3),cex.lab=1.2)
sex.symbols(400, 2, sex = 1, cex = 1.5, lwd = 2, col = "black")  
abline(h=0,col="black")
for(i in seq(9,16,by=2)){
  lines(all_pptdorm_seq*sd(poar_2015_2016$pptdorm) + mean(poar_2015_2016$pptdorm),colSums(LTRE_PPTGROW_out[i:(i+1),]),lty=ltre_lty[i-8],col=ltre_cols[i-8],lwd=2)
}
mtext("D",side = 3, adj = 0,cex=1.25)

dev.off()
```



### Geographic Projection

```{r}
library(doParallel)
library(foreach)
parallel::detectCores() # found out how many cores are available
n.cores <- parallel::detectCores() - 1 # define the number of cores we want to use
my.cluster <- parallel::makeCluster( # create the cluster
  n.cores, 
  type = "FORK" # FORK is about a 40% faster than PSOCK.FORK is  appropriate for only single-machine environments
  )
print(my.cluster)#check cluster definition (optional)
doParallel::registerDoParallel(cl = my.cluster) #register it to be used by %dopar%
foreach::getDoParRegistered() #check if it is registered (optional)
foreach::getDoParWorkers()#how many workers are available? (optional)
```

```{r}
ppt<-terra::rast(clim_1990_2019[[3]])
study_area<-terra::vect("data/USA_vector_polygon/States_shapefile.shp")
study_area <- study_area[(study_area$State_Name %in% c("TEXAS","OKLAHOMA","KANSAS")), ]
plot(study_area)
```


```{r}
crop_study_area <- terra::crop(ppt, study_area,mask=TRUE)
crop_study_area_raster<-raster::raster(crop_study_area)
coordinates_study_area<-read.csv("data/coordinate10_study_area.csv")
```

```{r}
coordinates(coordinates_study_area) <- ~ x + y
CRS1 <- CRS("+init=epsg:4326") # WGS 84
crs(coordinates_study_area) <- CRS1
plot(crop_study_area_raster)
plot(study_area,add=T)
plot(coordinates_study_area,add=T)
```

## Download occurrence data from gbif for *Poa arachnifera*

```{r}
#library(dismo)
# dir.create("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/data/occurence")
#poar_occ_raw <- gbif(genus="Poa",species="arachnifera",download=TRUE)
#write.csv(poar_occ_raw,"data/poar_occ_raw.csv")
poar_occ_raw<-read.csv("data/poar_occ_raw.csv")
head(poar_occ_raw) # to view the first few records the occurrence dataset use
```

## Clean occurrence data from gbif

```{r}
poar_occ <- subset(poar_occ_raw,(!is.na(lat))&(!is.na(lon))) # here we remove erroneous coordinates, where either the latitude or longitude is missing
cat(nrow(poar_occ_raw)-nrow(poar_occ), "records are removed") # Show the number of records that are removed from the dataset. 
#this dropped a lot -- have a look at what gets removed
poar_occ_raw %>% filter((is.na(lat))|(is.na(lon))) %>% View

poar_occ %>% 
  dplyr::select(country,lon, lat, year,basisOfRecord)%>% 
  filter(country=="United States")->poar_occ_clean # We want only occurrence data for the US

```

```{r}
dups_poar <- duplicated(poar_occ_clean[c("lat","lon")]  )
poar_occ_unique <- poar_occ_clean[!dups_poar,] # Remove duplicated data based on latitude and longitude
cat(nrow(poar_occ_clean)-nrow(poar_occ_unique), "records are removed")
```

```{r}
table(poar_occ_unique$basisOfRecord) # show the frequency table of âbasisOfRecordâ
```

```{r}
hist(poar_occ_unique$year,main="",xlim=c(1901,2019),ylim=c(0,200),col="orange2",xlab="years")
```

```{r}
poar_occ_unique %>% 
  dplyr::select(lon, lat, year)%>% 
  filter(year %in% (1890:2019) & as.numeric(lon >=-126.374160))->poar_occ_1990_2019 #  filter from 1990 to 2019 to match climatic data.
```


```{r}
Locationinfo<-read_rds("data/poar_ms_quantities.rds")
survey<-Locationinfo$survey_site_table[,2:3]
garden<-Locationinfo$exp_site_table[,3:4]
Locationinfo$survey_site_table %>% 
  filter(Experimental_source=="yes")->sourceinfo
sourcepop<-sourceinfo[,2:3]
data_gbif<-poar_occ_1990_2019[,1:2]
coordinates(data_gbif) <- ~ lon + lat
CRS1 <- CRS("+init=epsg:4326") # WGS 84
crs(data_gbif) <- CRS1
coordinates(garden) <- ~ Longitude + Latitude
crs(garden) <- CRS1
coordinates(sourcepop) <- ~ Longitude + Latitude
crs(sourcepop) <- CRS1

```

```{r}
# plot(clim_1990_2019)
pptdorm_raster<-terra::rast(clim_1990_2019[[1]])
tempdorm_raster<-terra::rast(clim_1990_2019[[2]])
pptgrow_raster<-terra::rast(clim_1990_2019[[3]])
tempgrow_raster<-terra::rast(clim_1990_2019[[4]])

crop_pptdorm_raster <- terra::crop(pptdorm_raster, study_area,mask=TRUE)
crop_tempdorm_raster <- terra::crop(tempdorm_raster, study_area,mask=TRUE)
crop_pptgrow_raster <- terra::crop(pptgrow_raster, study_area,mask=TRUE)
crop_tempgrow_raster <- terra::crop(tempgrow_raster, study_area,mask=TRUE)
```

Tom's version of the map+climate figure.
```{r tom_map}
pdf("Manuscript/Figures/tom_map_v1.pdf",width=11,height=4)
par(mfrow=c(1,3))
plot(study_area,xlab="Longitude",ylab="Latitude")
plot(data_gbif,add=T,pch = 1,cex=0.5,col=alpha("darkgrey",0.75))
plot(garden,add=T,pch = 21,col="black",cex =3,bg=unique(poar_2015_2016$site_col))
#plot(sourcepop,add=T,pch = 21,col="black",bg="red",cex =0.85)

plot(clim_past$pptdorm,clim_past$tempdorm,xlab="Precipitation (mm)",ylab="Temperature (C)",col=unique(poar_2015_2016$site_col),cex=0.5,xlim=c(150,550),ylim=c(23,34),pch=16)
#points(clim_current$pptdorm,clim_current$tempdorm,col=unique(poar_2015_2016$site_col),cex=1,pch=16)
arrows(clim_past$pptdorm,clim_past$tempdorm,
       clim_current$pptdorm,clim_current$tempdorm,
       length=0.1,col=unique(poar_2015_2016$site_col),lwd=2)
#points(clim_miroc45$pptdorm,clim_miroc45$tempdorm,col=unique(poar_2015_2016$site_col),cex=1.5,pch=1)
arrows(clim_current$pptdorm,clim_current$tempdorm,
      clim_miroc45$pptdorm,clim_miroc45$tempdorm,
      length=0.1,col=unique(poar_2015_2016$site_col),lty=1,lwd=1)
#points(clim_miroc85$pptdorm,clim_miroc85$tempdorm,col=unique(poar_2015_2016$site_col),cex=2,pch=1)
arrows(clim_current$pptdorm,clim_current$tempdorm,
       clim_miroc85$pptdorm,clim_miroc85$tempdorm,
       length=0.1,col=unique(poar_2015_2016$site_col),lty=3,lwd=1)


plot(clim_past$pptgrow,clim_past$tempgrow,xlab="Precipitation (mm)",ylab="Temperature (C)",col=unique(poar_2015_2016$site_col),cex=0.5,xlim=c(190,840),ylim=c(7,22),pch=16)
#points(clim_current$pptgrow,clim_current$tempgrow,col=unique(poar_2015_2016$site_col),cex=1,pch=16)
arrows(clim_past$pptgrow,clim_past$tempgrow,
       clim_current$pptgrow,clim_current$tempgrow,
       length=0.1,col=unique(poar_2015_2016$site_col),lwd=2)
#points(clim_miroc45$pptgrow,clim_miroc45$tempgrow,col=unique(poar_2015_2016$site_col),cex=1.5,pch=1)
arrows(clim_current$pptgrow,clim_current$tempgrow,
      clim_miroc45$pptgrow,clim_miroc45$tempgrow,
      length=0.1,col=unique(poar_2015_2016$site_col),lty=1,lwd=1)
#points(clim_miroc85$pptgrow,clim_miroc85$tempgrow,col=unique(poar_2015_2016$site_col),cex=2,pch=1)
arrows(clim_current$pptgrow,clim_current$tempgrow,
       clim_miroc85$pptgrow,clim_miroc85$tempgrow,
       length=0.1,col=unique(poar_2015_2016$site_col),lty=3,lwd=1)
dev.off()
```

```{r tom_map_v2}
pdf("Manuscript/Figures/tom_map_v2.pdf",width=11,height=4)
par(mfrow=c(1,3))
plot(study_area,xlab="Longitude",ylab="Latitude")
plot(data_gbif,add=T,pch = 1,cex=1,col=alpha("darkgrey",0.75))
plot(garden,add=T,pch = "+",col="black",cex =3,bg=unique(poar_2015_2016$site_col))
plot(sourcepop,add=T,pch = 21,col="black",bg="red",cex =1)

plot(clim_past$pptdorm,clim_past$tempdorm,xlab="Precipitation (mm)",ylab="Temperature (C)",col=alpha("black",0.25),cex=2,xlim=c(150,550),ylim=c(23,34),pch=16)
points(clim_miroc45$pptdorm,clim_miroc45$tempdorm,col=alpha("blue",0.25),cex=2,pch=16)
points(clim_miroc85$pptdorm,clim_miroc85$tempdorm,col=alpha("red",0.25),cex=2,pch=16)
points(poar_2015_2016$pptdorm,poar_2015_2016$tempdorm,col="black",cex=2,pch="+")
title(main="Dormant season",adj=0)
legend("topright",legend=c("Past (1901-30)","Observed (2014-16)","RCP4.5 (2071-2100)","RCP8.5 (2071-2100)"),pch=c(16,3,16,16),col=c(alpha("black",0.25),"black",alpha("blue",0.25),alpha("red",0.25)))
#points(clim_current$pptdorm,clim_current$tempdorm,col="black",cex=1,pch=16)


plot(clim_past$pptgrow,clim_past$tempgrow,xlab="Precipitation (mm)",ylab="Temperature (C)",col=alpha("black",0.25),cex=2,xlim=c(190,840),ylim=c(7,22),pch=16)
points(clim_miroc45$pptgrow,clim_miroc45$tempgrow,col=alpha("blue",0.25),cex=2,pch=16)
points(clim_miroc85$pptgrow,clim_miroc85$tempgrow,col=alpha("red",0.25),cex=2,pch=16)
points(poar_2015_2016$pptgrow,poar_2015_2016$tempgrow,col="black",cex=2,pch="+")
title(main="Growing season",adj=0)
#points(clim_current$pptgrow,clim_current$tempgrow,col="black",cex=1,pch=16)
dev.off()
```


```{r}
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/POAR_survey_garden_map.pdf",width=7,height=8,useDingbats = F)
par(mar=c(5,5,1.5,0.5),mfrow=c(2,2))
plot(crop_pptdorm_raster,xlab="Longitude",ylab="Latitude",main="Precipitation (dorm. season)",cex.main=1)
# mtext("A",side = 3, adj = 0,cex=1.25)
plot(study_area,add=T)
plot(data_gbif,add=T,pch = 23,col="black",bg="grey",cex =0.75)
plot(garden,add=T,pch = 21,col="black",cex =1.25,bg="black")
plot(sourcepop,add=T,pch = 21,col="black",bg="red",cex =1)
legend(-106.5, 28.5, 
       legend=c( "GBIF occurences","Common garden sites","Source populations"),
       pch = c(23,21,21),
       pt.cex=c(0.75,1.25,1),
       col = c("black","black","black"),
       pt.bg=c("grey","black","red"),
       cex = 0.7, 
       bty = "n", 
       horiz = F , 
)
plot(crop_tempdorm_raster,xlab="Longitude",ylab="Latitude",main="Temperature (dorm. season)",cex.main=1)
# mtext("B",side = 3, adj = 0,cex=1.25)
plot(study_area,add=T)
# plot(survey,add=T,pch = 23,col="black",bg="grey",cex =1.5)
plot(data_gbif,add=T,pch = 23,col="black",bg="grey",cex =0.75)
plot(garden,add=T,pch = 21,col="black",cex =1.25,bg="black")
plot(sourcepop,add=T,pch = 21,col="black",bg="red",cex =1)



plot(crop_pptgrow_raster,xlab="Longitude",ylab="Latitude",main="Precipitation (grow. season)",cex.main=1)
# mtext("C",side = 3, adj = 0,cex=1.25)
plot(study_area,add=T)
plot(data_gbif,add=T,pch = 23,col="black",bg="grey",cex =0.75)
plot(garden,add=T,pch = 21,col="black",cex =1.25,bg="black")
plot(sourcepop,add=T,pch = 21,col="black",bg="red",cex =1)



plot(crop_tempgrow_raster,xlab="Longitude",ylab="Latitude",main="Temperature (grow. season)",cex.main=1)
# mtext("D",side = 3, adj = 0,cex=1.25)
plot(study_area,add=T)
plot(data_gbif,add=T,pch = 23,col="black",bg="grey",cex =0.75)
plot(garden,add=T,pch = 21,col="black",cex =1.25,bg="black")
plot(sourcepop,add=T,pch = 21,col="black",bg="red",cex =1)


dev.off()
```

# Extract min and max for each climate variable

```{r}
climate_gbif<-terra::extract(clim_1901_1930,data_gbif)
summary(climate_gbif)
```

```{r}
clim_miroc_85_values<-terra::extract(clim_miroc_85,coordinates_study_area)
climate_miroc85_values<-data.frame(clim_miroc_85_values)
climate_miroc85_values$zpptgrow<-(climate_miroc85_values$pptgrow-mean(poar_2015_2016$pptgrow))/sd(poar_2015_2016$pptgrow)
climate_miroc85_values$ztempgrow<-(climate_miroc85_values$tempgrow-mean(poar_2015_2016$tempgrow))/sd(poar_2015_2016$tempgrow)
climate_miroc85_values$zpptdorm<-(climate_miroc85_values$pptdorm-mean(poar_2015_2016$pptdorm))/sd(poar_2015_2016$pptdorm)
climate_miroc85_values$ztempdorm<-(climate_miroc85_values$tempdorm-mean(poar_2015_2016$tempdorm))/sd(poar_2015_2016$tempdorm)
climate_miroc85_values<-data.frame(climate_miroc85_values,coordinates_study_area)
dim(climate_miroc85_values)
# write_csv(climate_miroc85_values,"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/Climate data  OSR/climate_miroc85_values.csv")
```

```{r}
max_yrs<-30
P_miroc85 <- system.time(
  lambda_2sex_miroc85<- foreach::foreach(i=1:nrow(climate_miroc85_values), 
               .combine = 'c'
  ) %dopar% {lambdaSim_delay( F_params=F_params,
                                 M_params=M_params,
                                 grow_perturb=0,
                                 surv_perturb=0,
                                 flow_perturb=0,
                                 fert_perturb=0,
                                 viab_perturb=0,
                                 zpptgrow=climate_miroc85_values[i,5],
                                 ztempgrow=climate_miroc85_values[i,6],
                                 zpptdorm=climate_miroc85_values[i,7],
                                 ztempdorm=climate_miroc85_values[i,8],
                                 rfx = rfx_fun(),
                                 max.yrs = max_yrs)$lambdatracker[max_yrs]
})
```

```{r}
clim_lambda_miroc85<-data.frame(coordinates_study_area,lambda=lambda_2sex_miroc85)
# write.csv(clim_lambda_miroc85,"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/lambda_miroc8510m.csv",row.names = F)
```

```{r}
data.frame(coordinates_study_area)
clim_current_values<-terra::extract(clim_1990_2019,coordinates_study_area)
clim_current_values<-as.data.frame(clim_current_values)
clim_current_values$zpptgrow<-(clim_current_values$pptgrow-mean(poar_2015_2016$pptgrow))/sd(poar_2015_2016$pptgrow)
clim_current_values$ztempgrow<-(clim_current_values$tempgrow-mean(poar_2015_2016$tempgrow))/sd(poar_2015_2016$tempgrow)
clim_current_values$zpptdorm<-(clim_current_values$pptdorm-mean(poar_2015_2016$pptdorm))/sd(poar_2015_2016$pptdorm)
clim_current_values$ztempdorm<-(clim_current_values$tempdorm-mean(poar_2015_2016$tempdorm))/sd(poar_2015_2016$tempdorm)
clim_current_values<-data.frame(clim_current_values,coordinates_study_area)
dim(clim_current_values)
# write_csv(clim_current_values,"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/Climate data  OSR/clim_current_values.csv")
```

```{r}
P_current <- system.time(
  lambda_2sex_current<- foreach::foreach(i=1:nrow(clim_current_values), 
               .combine = 'c'
  ) %dopar% {lambdaSim_delay( F_params=F_params,
                                 M_params=M_params,
                                 grow_perturb=0,
                                 surv_perturb=0,
                                 flow_perturb=0,
                                 fert_perturb=0,
                                 viab_perturb=0,
                                 zpptgrow=clim_current_values[i,5],
                                 ztempgrow=clim_current_values[i,6],
                                 zpptdorm=clim_current_values[i,7],
                                 ztempdorm=clim_current_values[i,8],
                                 rfx = rfx_fun(),
                                 max.yrs = max_yrs)$lambdatracker[max_yrs]
})
```

```{r}
clim_lambba_current<-data.frame(coordinates_study_area,lambda=lambda_2sex_current)
# write.csv(clim_lambba_current,"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/lambda_current.csv",row.names = F)
```

```{r}
clim_miroc_45_values<-terra::extract(clim_miroc_45,coordinates_study_area)
climate_miroc45_values<-data.frame(clim_miroc_45_values)
climate_miroc45_values$zpptgrow<-(climate_miroc45_values$pptgrow-mean(poar_2015_2016$pptgrow))/sd(poar_2015_2016$pptgrow)
climate_miroc45_values$ztempgrow<-(climate_miroc45_values$tempgrow-mean(poar_2015_2016$tempgrow))/sd(poar_2015_2016$tempgrow)
climate_miroc45_values$zpptdorm<-(climate_miroc45_values$pptdorm-mean(poar_2015_2016$pptdorm))/sd(poar_2015_2016$pptdorm)
climate_miroc45_values$ztempdorm<-(climate_miroc45_values$tempdorm-mean(poar_2015_2016$tempdorm))/sd(poar_2015_2016$tempdorm)
climate_miroc45_values<-data.frame(climate_miroc45_values,coordinates_study_area)
# write_csv(climate_miroc45_values,"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/Climate data  OSR/clim_miroc_45_values.csv")
```

```{r}
P_miroc45 <- system.time(
  lambda_2sex_miroc45<- foreach::foreach(i=1:nrow(climate_miroc5_values), 
               .combine = 'c'
  ) %dopar% {lambdaSim_delay( F_params=F_params,
                                 M_params=M_params,
                                 grow_perturb=0,
                                 surv_perturb=0,
                                 flow_perturb=0,
                                 fert_perturb=0,
                                 viab_perturb=0,
                                 zpptgrow=climate_miroc5_values[i,5],
                                 ztempgrow=climate_miroc5_values[i,6],
                                 zpptdorm=climate_miroc5_values[i,7],
                                 ztempdorm=climate_miroc5_values[i,8],
                                 rfx = rfx_fun(),
                                 max.yrs = max_yrs)$lambdatracker[max_yrs]
})
```

```{r}
clim_lambda<-data.frame(coordinates_study_area,lambda=lambda_2sex_miroc45)
# write.csv(clim_lambda,"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/lambda_10mmiroc45.csv")
```

```{r}
clim_past_values<-terra::extract(clim_1901_1930,coordinates_study_area)
clim_past_values<-as.data.frame(clim_past_values)
clim_past_values$zpptgrow<-(clim_past_values$pptgrow-mean(poar_2015_2016$pptgrow))/sd(poar_2015_2016$pptgrow)
clim_past_values$ztempgrow<-(clim_past_values$tempgrow-mean(poar_2015_2016$tempgrow))/sd(poar_2015_2016$tempgrow)
clim_past_values$zpptdorm<-(clim_past_values$pptdorm-mean(poar_2015_2016$pptdorm))/sd(poar_2015_2016$pptdorm)
clim_past_values$ztempdorm<-(clim_past_values$tempdorm-mean(poar_2015_2016$tempdorm))/sd(poar_2015_2016$tempdorm)
clim_past_values<-data.frame(clim_past_values,coordinates_study_area)
# write_csv(clim_past_values,"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/Climate data  OSR/clim_past_values.csv")
```

```{r}
P_past <- system.time(
  lambda_2sex_past<- foreach::foreach(i=1:nrow(clim_past_values), 
               .combine = 'c'
  ) %dopar% {lambdaSim_delay( F_params=F_params,
                                 M_params=M_params,
                                 grow_perturb=0,
                                 surv_perturb=0,
                                 flow_perturb=0,
                                 fert_perturb=0,
                                 viab_perturb=0,
                                 zpptgrow=clim_past_values[i,5],
                                 ztempgrow=clim_past_values[i,6],
                                 zpptdorm=clim_past_values[i,7],
                                 ztempdorm=clim_past_values[i,8],
                                 rfx = rfx_fun(),
                                 max.yrs = max_yrs)$lambdatracker[max_yrs]
})
```

```{r}
clim_lambda_past<-data.frame(coordinates_study_area,lambda=lambda_2sex_past)
# write.csv(clim_lambda_past,"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/clim_lambda_past.csv",row.names = F)
```

## ACCESS

```{r}
clim_acc_85_values<-terra::extract(clim_access_85,coordinates_study_area)
climate_acc_85_values<-data.frame(clim_acc_85_values)
climate_acc_85_values$zpptgrow<-(climate_acc_85_values$pptgrow-mean(poar_2015_2016$pptgrow))/sd(poar_2015_2016$pptgrow)
climate_acc_85_values$ztempgrow<-(climate_acc_85_values$tempgrow-mean(poar_2015_2016$tempgrow))/sd(poar_2015_2016$tempgrow)
climate_acc_85_values$zpptdorm<-(climate_acc_85_values$pptdorm-mean(poar_2015_2016$pptdorm))/sd(poar_2015_2016$pptdorm)
climate_acc_85_values$ztempdorm<-(climate_acc_85_values$tempdorm-mean(poar_2015_2016$tempdorm))/sd(poar_2015_2016$tempdorm)
climate_acc_85_values<-data.frame(climate_acc_85_values,coordinates_study_area)
# write_csv(climate_acc_85_values,"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/Climatic data/climate_acc_85_values.csv")
```

```{r}
max_yrs<-30
P_acce85 <- system.time(
  lambda_2sex_acc85<- foreach::foreach(i=1:nrow(climate_acc_85_values), 
               .combine = 'c'
  ) %dopar% {lambdaSim_delay( F_params=F_params,
                                 M_params=M_params,
                                 grow_perturb=0,
                                 surv_perturb=0,
                                 flow_perturb=0,
                                 fert_perturb=0,
                                 viab_perturb=0,
                                 zpptgrow=climate_acc_85_values[i,5],
                                 ztempgrow=climate_acc_85_values[i,6],
                                 zpptdorm=climate_acc_85_values[i,7],
                                 ztempdorm=climate_acc_85_values[i,8],
                                 rfx = rfx_fun(),
                                 max.yrs = max_yrs)$lambdatracker[max_yrs]
})
```

```{r}
clim_lambda_acc85<-data.frame(coordinates_study_area,lambda=lambda_2sex_acc85)
# write.csv(clim_lambda_acc85,"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/lambda_access85.csv",row.names = F)
```

```{r}
clim_acc_45_values<-terra::extract(clim_access_45,coordinates_study_area)
climate_acc_45_values<-data.frame(clim_acc_45_values)
climate_acc_45_values$zpptgrow<-(climate_acc_45_values$pptgrow-mean(poar_2015_2016$pptgrow))/sd(poar_2015_2016$pptgrow)
climate_acc_45_values$ztempgrow<-(climate_acc_45_values$tempgrow-mean(poar_2015_2016$tempgrow))/sd(poar_2015_2016$tempgrow)
climate_acc_45_values$zpptdorm<-(climate_acc_45_values$pptdorm-mean(poar_2015_2016$pptdorm))/sd(poar_2015_2016$pptdorm)
climate_acc_45_values$ztempdorm<-(climate_acc_45_values$tempdorm-mean(poar_2015_2016$tempdorm))/sd(poar_2015_2016$tempdorm)
climate_acc_45_values<-data.frame(climate_acc_45_values,coordinates_study_area)
# write_csv(climate_acc_45_values,"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/Climatic data/climate_acc_45_values.csv")

```

```{r}
max_yrs<-30
P_acce45 <- system.time(
  lambda_2sex_acc45<- foreach::foreach(i=1:nrow(climate_acc_45_values), 
               .combine = 'c'
  ) %dopar% {lambdaSim_delay( F_params=F_params,
                                 M_params=M_params,
                                 grow_perturb=0,
                                 surv_perturb=0,
                                 flow_perturb=0,
                                 fert_perturb=0,
                                 viab_perturb=0,
                                 zpptgrow=climate_acc_45_values[i,5],
                                 ztempgrow=climate_acc_45_values[i,6],
                                 zpptdorm=climate_acc_45_values[i,7],
                                 ztempdorm=climate_acc_45_values[i,8],
                                 rfx = rfx_fun(),
                                 max.yrs = max_yrs)$lambdatracker[max_yrs]
})
```

```{r}
clim_lambda_acc45<-data.frame(coordinates_study_area,lambda=lambda_2sex_acc45)
# write.csv(clim_lambda_acc45,"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/lambda_access45.csv",row.names = F)
```

## CMCM

```{r}
clim_cmc_85_values<-terra::extract(clim_cmcc_85,coordinates_study_area)
climate_cmc_85_values<-data.frame(clim_cmc_85_values)
climate_cmc_85_values$zpptgrow<-(climate_cmc_85_values$pptgrow-mean(poar_2015_2016$pptgrow))/sd(poar_2015_2016$pptgrow)
climate_cmc_85_values$ztempgrow<-(climate_cmc_85_values$tempgrow-mean(poar_2015_2016$tempgrow))/sd(poar_2015_2016$tempgrow)
climate_cmc_85_values$zpptdorm<-(climate_cmc_85_values$pptdorm-mean(poar_2015_2016$pptdorm))/sd(poar_2015_2016$pptdorm)
climate_cmc_85_values$ztempdorm<-(climate_cmc_85_values$tempdorm-mean(poar_2015_2016$tempdorm))/sd(poar_2015_2016$tempdorm)
climate_cmc_85_values<-data.frame(climate_cmc_85_values,coordinates_study_area)
# write_csv(climate_cmc_85_values,"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/Climate data  OSR/climate_cmc_85_values.csv")
```

```{r}
max_yrs<-30
P_cmc85 <- system.time(
  lambda_2sex_cmc85<- foreach::foreach(i=1:nrow(climate_cmc_85_values), 
               .combine = 'c'
  ) %dopar% {lambdaSim_delay( F_params=F_params,
                                 M_params=M_params,
                                 grow_perturb=0,
                                 surv_perturb=0,
                                 flow_perturb=0,
                                 fert_perturb=0,
                                 viab_perturb=0,
                                 zpptgrow=climate_cmc_85_values[i,5],
                                 ztempgrow=climate_cmc_85_values[i,6],
                                 zpptdorm=climate_cmc_85_values[i,7],
                                 ztempdorm=climate_cmc_85_values[i,8],
                                 rfx = rfx_fun(),
                                 max.yrs = max_yrs)$lambdatracker[max_yrs]
})
```

```{r}
clim_lambda_cmc85<-data.frame(coordinates_study_area,lambda=lambda_2sex_cmc85)
# write.csv(clim_lambda_cmc85,"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/lambda_cmc85.csv",row.names = F)
```

```{r}
clim_cmc_45_values<-terra::extract(clim_cmcc_45,coordinates_study_area)
climate_cmc_45_values<-data.frame(clim_cmc_45_values)
climate_cmc_45_values$zpptgrow<-(climate_cmc_45_values$pptgrow-mean(poar_2015_2016$pptgrow))/sd(poar_2015_2016$pptgrow)
climate_cmc_45_values$ztempgrow<-(climate_cmc_45_values$tempgrow-mean(poar_2015_2016$tempgrow))/sd(poar_2015_2016$tempgrow)
climate_cmc_45_values$zpptdorm<-(climate_cmc_45_values$pptdorm-mean(poar_2015_2016$pptdorm))/sd(poar_2015_2016$pptdorm)
climate_cmc_45_values$ztempdorm<-(climate_cmc_45_values$tempdorm-mean(poar_2015_2016$tempdorm))/sd(poar_2015_2016$tempdorm)
climate_cmc_45_values<-data.frame(climate_cmc_45_values,coordinates_study_area)

# write_csv(climate_cmc_45_values,"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/Climate data  OSR/climate_cmc_45_values.csv")
```

```{r}
max_yrs<-30
P_cmc45 <- system.time(
  lambda_2sex_cmc45<- foreach::foreach(i=1:nrow(climate_cmc_45_values), 
               .combine = 'c'
  ) %dopar% {lambdaSim_delay( F_params=F_params,
                                 M_params=M_params,
                                 grow_perturb=0,
                                 surv_perturb=0,
                                 flow_perturb=0,
                                 fert_perturb=0,
                                 viab_perturb=0,
                                 zpptgrow=climate_cmc_45_values[i,5],
                                 ztempgrow=climate_cmc_45_values[i,6],
                                 zpptdorm=climate_cmc_45_values[i,7],
                                 ztempdorm=climate_cmc_45_values[i,8],
                                 rfx = rfx_fun(),
                                 max.yrs = max_yrs)$lambdatracker[max_yrs]
})
```

```{r}
clim_lambda_cmc45<-data.frame(coordinates_study_area,lambda=lambda_2sex_cmc45)
# write.csv(clim_lambda_cmc45,"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/lambda_cmc45.csv",row.names = F)
```

## CES

```{r}
clim_ces_85_values<-terra::extract(clim_cesm_85,coordinates_study_area)
climate_ces_85_values<-data.frame(clim_ces_85_values)
climate_ces_85_values$zpptgrow<-(climate_ces_85_values$pptgrow-mean(poar_2015_2016$pptgrow))/sd(poar_2015_2016$pptgrow)
climate_ces_85_values$ztempgrow<-(climate_ces_85_values$tempgrow-mean(poar_2015_2016$tempgrow))/sd(poar_2015_2016$tempgrow)
climate_ces_85_values$zpptdorm<-(climate_ces_85_values$pptdorm-mean(poar_2015_2016$pptdorm))/sd(poar_2015_2016$pptdorm)
climate_ces_85_values$ztempdorm<-(climate_ces_85_values$tempdorm-mean(poar_2015_2016$tempdorm))/sd(poar_2015_2016$tempdorm)
climate_ces_85_values<-data.frame(climate_ces_85_values,coordinates_study_area)
# write_csv(climate_ces_85_values,"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/Climatic data/climate_ces_85_values.csv")
```

```{r}
max_yrs<-30
P_ces85 <- system.time(
  lambda_2sex_ces85<- foreach::foreach(i=1:nrow(climate_ces_85_values), 
               .combine = 'c'
  ) %dopar% {lambdaSim_delay( F_params=F_params,
                                 M_params=M_params,
                                 grow_perturb=0,
                                 surv_perturb=0,
                                 flow_perturb=0,
                                 fert_perturb=0,
                                 viab_perturb=0,
                                 zpptgrow=climate_ces_85_values[i,5],
                                 ztempgrow=climate_ces_85_values[i,6],
                                 zpptdorm=climate_ces_85_values[i,7],
                                 ztempdorm=climate_ces_85_values[i,8],
                                 rfx = rfx_fun(),
                                 max.yrs = max_yrs)$lambdatracker[max_yrs]
})
```

```{r}
clim_lambda_ces85<-data.frame(coordinates_study_area,lambda=lambda_2sex_ces85)
# write.csv(clim_lambda_ces85,"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/lambda_ces85.csv",row.names = F)
```

```{r}
clim_ces_45_values<-terra::extract(clim_cesm_45,coordinates_study_area)
climate_ces_45_values<-data.frame(clim_ces_45_values)
climate_ces_45_values$zpptgrow<-(climate_ces_45_values$pptgrow-mean(poar_2015_2016$pptgrow))/sd(poar_2015_2016$pptgrow)
climate_ces_45_values$ztempgrow<-(climate_ces_45_values$tempgrow-mean(poar_2015_2016$tempgrow))/sd(poar_2015_2016$tempgrow)
climate_ces_45_values$zpptdorm<-(climate_ces_45_values$pptdorm-mean(poar_2015_2016$pptdorm))/sd(poar_2015_2016$pptdorm)
climate_ces_45_values$ztempdorm<-(climate_ces_45_values$tempdorm-mean(poar_2015_2016$tempdorm))/sd(poar_2015_2016$tempdorm)
climate_ces_45_values<-data.frame(climate_ces_45_values,coordinates_study_area)
# write_csv(climate_ces_45_values,"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/Climatic data/climate_ces_45_values.csv")
```

```{r}
max_yrs<-30
P_ces45 <- system.time(
  lambda_2sex_ces45<- foreach::foreach(i=1:nrow(climate_ces_45_values), 
               .combine = 'c'
  ) %dopar% {lambdaSim_delay( F_params=F_params,
                                 M_params=M_params,
                                 grow_perturb=0,
                                 surv_perturb=0,
                                 flow_perturb=0,
                                 fert_perturb=0,
                                 viab_perturb=0,
                                 zpptgrow=climate_ces_45_values[i,5],
                                 ztempgrow=climate_ces_45_values[i,6],
                                 zpptdorm=climate_ces_45_values[i,7],
                                 ztempdorm=climate_ces_45_values[i,8],
                                 rfx = rfx_fun(),
                                 max.yrs = max_yrs)$lambdatracker[max_yrs]
})
```

```{r}
clim_lambda_ces45<-data.frame(coordinates_study_area,lambda=lambda_2sex_ces45)
# write.csv(clim_lambda_cmc45,"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/lambda_ces45.csv",row.names = F)
```

```{r}
stopCluster(my.cluster)
```

# Put the future projection together

```{r}
lambda_future = data.frame(matrix(nrow = 3972, ncol = 10)) 
colnames(lambda_future)<-c("x","y","miroc45","miroc85","access45","access85","cmcc45","cmcc85","ces45","ces85")
lambda_future$x<-clim_lambda_miroc85$x
lambda_future$y<-clim_lambda_miroc85$y
lambda_future$miroc45<-clim_lambda$lambda
lambda_future$miroc85<-clim_lambda_miroc85$lambda
lambda_future$access45<-clim_lambda_acc45$lambda
lambda_future$access85<-clim_lambda_acc85$lambda
lambda_future$cmcc45<-clim_lambda_cmc45$lambda
lambda_future$cmcc85<-clim_lambda_cmc85$lambda
lambda_future$ces45<-clim_lambda_ces45$lambda
lambda_future$ces85<-clim_lambda_ces85$lambda
# write.csv(lambda_future,"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/lambda_future.csv",row.names = F)
```

```{r}
lambda_past<-read.csv("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/clim_lambda_past.csv")
lambda_current<-read.csv("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/lambda_current.csv")
lambda_cmc85<-read.csv("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/lambda_cmc85.csv")
lambda_cmc45<-read.csv("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/lambda_cmc45.csv")
lambda_past_fd<-read.csv("/Volumes/NO NAME/geolambdaFd/lam_past_fd.csv")
lambda_current_fd<-read.csv("/Volumes/NO NAME/geolambdaFd/lam_current_fd.csv")
lambda_cmc85_fd<-read.csv("/Volumes/NO NAME/geolambdaFd/lam_cmc_85_fd.csv")
lambda_cmc45_fd<-read.csv("/Volumes/NO NAME/geolambdaFd/lam_cmc_45_fd.csv")

```

```{r}
summary(lambda_past)
summary(lambda_current)
summary(lambda_future)
```

## Download occurrence data from gbif for *Poa arachnifera*

```{r}
library(dismo)
# dir.create("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/data/occurence")
poar_occ_raw <- gbif(genus="Poa",species="arachnifera",download=TRUE)
# load("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Herbaruim Project/Data/Occurence/aghy_occ_raw.rdata")
head(poar_occ_raw) # to view the first few records the occurrence dataset use
```

## Clean occurrence data from gbif

```{r}
poar_occ <- subset(poar_occ_raw,(!is.na(lat))&(!is.na(lon))) # here we remove erroneous coordinates, where either the latitude or longitude is missing
cat(nrow(poar_occ_raw)-nrow(poar_occ), "records are removed") # Show the number of records that are removed from the dataset. 
poar_occ %>% 
  dplyr::select(country,lon, lat, year,basisOfRecord)%>% 
  filter(country=="United States")->poar_occ_clean # We want only occurrence data for the US

```

```{r}
dups_poar <- duplicated(poar_occ_clean[c("lat","lon")]  )
poar_occ_unique <- poar_occ_clean[!dups_poar,] # Remove duplicated data based on latitude and longitude
cat(nrow(poar_occ_clean)-nrow(poar_occ_unique), "records are removed")
```

```{r}
table(poar_occ_unique$basisOfRecord) # show the frequency table of âbasisOfRecordâ
```

```{r}
hist(poar_occ_unique$year,main="",xlim=c(1901,2019),ylim=c(0,200),col="orange2",xlab="years")
```

```{r}
poar_occ_unique %>% 
  dplyr::select(lon, lat, year)%>% 
  filter(year %in% (1990:2019) & as.numeric(lon >=-126.374160))->poar_occ_1990_2019 #  filter from 1990 to 2019 to match climatic data.
```

```{r}
# lambda_future %>% 
#   dplyr::select(miroc45,access45,cmcc45,ces45)-> lambda_future45
# mean_lambda_45<-rowMeans(lambda_future45)
# lambda_future %>% 
#   dplyr::select(miroc85,access85,cmcc85,ces85)-> lambda_future85
# mean_lambda_85<-rowMeans(lambda_future85)
# median_lambda_45<-rowMeans(lambda_future45)
# geo45<-data.frame(coordinates_study_area,mean_lambda_45)
# geo85<-data.frame(coordinates_study_area,mean_lambda_85)
```



```{r}
outline_map <- map_data("world")
```

```{r}
(lambda_map_past <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = lambda_past, aes(x = x, y = y, fill = lambda))+
  # geom_point(data=poar_occ_1901_1930,aes(lon, lat))+
  annotate(geom="text", x=-100, y=41, label="Past",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = expression(paste(lambda)),
    colours = terrain.colors(7))+
  theme_light()+
  theme(strip.background = element_blank(),
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="A") )

```

```{r}
(lambda_map_current <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = lambda_current, aes(x = x, y = y, fill = lambda))+
  geom_point(data=poar_occ_1990_2019,aes(lon, lat),alpha=1/5)+
  annotate(geom="text", x=-100, y=41, label="Current",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = expression(paste(lambda)),
    colours = terrain.colors(7))+
  theme_light()+
 theme(strip.background = element_blank(),
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="B") )

```

```{r}
(lambda_map_45 <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = lambda_cmc45, aes(x = x, y = y, fill =lambda ))+
  annotate(geom="text", x=-100, y=41, label="Future 4.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = expression(paste(lambda)),
    colours = terrain.colors(7))+
  theme_light()+
theme(strip.background = element_blank(),
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="C") )

```

```{r}
(lambda_map_85 <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = lambda_cmc85, aes(x = x, y = y, fill = lambda))+
  annotate(geom="text", x=-100, y=41, label="Future 8.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = expression(paste(lambda)),
    colours = terrain.colors(7))+
  theme_light()+
theme(strip.background = element_blank(),
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="D") )

```


```{r}
(lambda_map_past_fd <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = lambda_past_fd, aes(x = x, y = y, fill = lambda_mat_past_fd))+
  # geom_point(data=poar_occ_1901_1930,aes(lon, lat))+
  annotate(geom="text", x=-100, y=41, label="Past",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = expression(paste(lambda)),
    colours = terrain.colors(7))+
  theme_light()+
  theme(strip.background = element_blank(),
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="A") )

```

```{r}
(lambda_map_current_fd <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = lambda_current_fd, aes(x = x, y = y, fill = lambda_mat_current_fd))+
  geom_point(data=poar_occ_1990_2019,aes(lon, lat),alpha=1/5)+
  annotate(geom="text", x=-100, y=41, label="Current",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = expression(paste(lambda)),
    colours = terrain.colors(7))+
  theme_light()+
 theme(strip.background = element_blank(),
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="B") )

```

```{r}
(lambda_map_45_fd <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = lambda_cmc45_fd, aes(x = x, y = y, fill =lambda_mat_cmc45_fd ))+
  annotate(geom="text", x=-100, y=41, label="Future 4.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = expression(paste(lambda)),
    colours = terrain.colors(7))+
  theme_light()+
theme(strip.background = element_blank(),
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="C") )

```

```{r}
(lambda_map_85_fd <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = lambda_cmc85_fd, aes(x = x, y = y, fill = lambda_mat_cmc85_fd))+
  annotate(geom="text", x=-100, y=41, label="Future 8.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = expression(paste(lambda)),
    colours = terrain.colors(7))+
  theme_light()+
theme(strip.background = element_blank(),
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="D") )

```



```{r}
Fig_geoprojection<-ggarrange(lambda_map_past, lambda_map_current, lambda_map_45, lambda_map_85,common.legend = TRUE)
ggsave("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/Fig_geoprojection.pdf", Fig_geoprojection, width = 5, height = 7)
```

### Probability of lambda above 1 

### Two sex models
```{r}
lambbacurrent <- read.csv("https://www.dropbox.com/scl/fi/5xl6vxw456m942qbtynqi/poar_current_1-400K.csv?rlkey=y76suoez6xbk21xkh52iaym9k&dl=1", stringsAsFactors = F) 
lambbapast <- read.csv("https://www.dropbox.com/scl/fi/l1509slfkm5lpecbpscfp/poar_past_1-400K.csv?rlkey=83pxzva68d98qk090kk1kmfkt&dl=1", stringsAsFactors = F)
lambba45 <- read.csv("https://www.dropbox.com/scl/fi/kq7p7zpnr4n910ed9lf1n/poar_miroc45_1-400K.csv?rlkey=0381obcnwjhzjkcx5kj8krmua&dl=1", stringsAsFactors = F)
lambba85 <- read.csv("https://www.dropbox.com/scl/fi/tzat8n3x9dgj4mr2kj2a0/poar_miroc85_1-400K.csv?rlkey=yv10l7v2ii4ljossoviebyp59&dl=1", stringsAsFactors = F)
lambbacmc45 <- read.csv("https://www.dropbox.com/scl/fi/ekjo0ezv0gn2pfoj69blt/poar_cmc45_1-400K.csv?rlkey=25x99ojbmc021qswxl2ehzq3t&dl=1", stringsAsFactors = F)
lambbacmc85 <- read.csv("https://www.dropbox.com/scl/fi/299bagx6imcgm534bcmhs/poar_cmc85_1-400K.csv?rlkey=fd4qs8grnkyua7o99w0oz9pyt&dl=1", stringsAsFactors = F)

lambbaacc45 <- read.csv("https://www.dropbox.com/scl/fi/973dwzsk6y7hzpoov5ljo/poar_acc45_1-400K.csv?rlkey=qsib01gvqjjgmye7pofnmvm7n&dl=1", stringsAsFactors = F)
lambbaacc85 <- read.csv("https://www.dropbox.com/scl/fi/ybt7vyi1693nselqqkxhc/poar_acc85_1-400K.csv?rlkey=pfzooz6p1p0bw2dnvydm2gdzf&dl=1", stringsAsFactors = F)

lambbaces45 <- read.csv("https://www.dropbox.com/scl/fi/8ml4oep2lssgg4xd3eon6/poar_ces45_1-400K.csv?rlkey=71ow2cfxcs6uk7iyqfcdijn1y&dl=1", stringsAsFactors = F)
lambbaces85 <- read.csv("https://www.dropbox.com/scl/fi/84d3crazogxfj5p2id4to/poar_ces85_1-400K.csv?rlkey=raur7uo6w3flwippbrom69uqb&dl=1", stringsAsFactors = F)
```


### Female dominant model

```{r}
geo_lambbacurrent_fd <- read.csv("https://www.dropbox.com/scl/fi/7zmsid3dxszv3l3tyvoox/lambda_post_current.csv?rlkey=hwy253ls9imsupkzqrduwp7r8&dl=1", stringsAsFactors = F) 
geo_lambbapast_fd <- read.csv("https://www.dropbox.com/scl/fi/9x9gbdv1vefdyd292726c/data_past_fd.csv?rlkey=besdw6mj9ab1nubx18if54w9z&dl=1", stringsAsFactors = F)
geo_lambda_miroc45_fd<-read.csv("https://www.dropbox.com/scl/fi/dmfb2mdhrv5k8otcrc33m/lambda_miroc45.csv?rlkey=1d4j1blbmlx9i3rp61c35g7f8&dl=1", stringsAsFactors = F)
geo_lambba_miroc85_fd <- read.csv("https://www.dropbox.com/scl/fi/a1rmqszey6y9s88887fqq/datamiroc85fd.csv?rlkey=1eckoajb6s4ee6dq61f2o5ymj&dl=1", stringsAsFactors = F)
geo_lambba_cmc45_fd <- read.csv("https://www.dropbox.com/scl/fi/oarso87jb6q5c30gsqm3k/lambda_cmcc45_fd.csv?rlkey=w7xlibvxnc2etc3iliog960dq&dl=1", stringsAsFactors = F)
geolambba_cmc85_fd <- read.csv("https://www.dropbox.com/scl/fi/d8uv2mbb2g47ywly0cz63/data_cmc85_fd.csv?rlkey=o4wcrp7hkqmdyow19eue8e1dh&dl=1", stringsAsFactors = F)
geo_lambba_acc45_fd <- read.csv("https://www.dropbox.com/scl/fi/p7xkr30t6zf24gtn4adbl/data_acc45_fd.csv?rlkey=2qv22qe7p3bahmn24mmtff1rm&dl=1", stringsAsFactors = F)
geolambba_acc85_fd <- read.csv("https://www.dropbox.com/scl/fi/5ged79dtckp3z2k570sm8/data_acc85_fd.csv?rlkey=l97zn5wfci6icbbvv8gcj6z5c&dl=1", stringsAsFactors = F)
geo_lambba_ces45_fd <- read.csv("https://www.dropbox.com/scl/fi/zdj4ra2qaghb4y16uiuow/data_ces45_fd.csv?rlkey=wl8t4ih9s48dr674xti0wwwww&dl=1", stringsAsFactors = F)
geolambba_ces85_fd <- read.csv("https://www.dropbox.com/scl/fi/e4mksgd5hpayfwd3oy0sz/data_ces85_fd.csv?rlkey=miacot7xh5yan0vk6nbwk9q1o&dl=1", stringsAsFactors = F)
```

```{r}
lambbapast %>% 
  unique %>% 
  pivot_wider(
    names_from = posterior_id, 
    values_from = lambda_diff)->pivot_lambda_past
dim(pivot_lambda_past)
# view(pivot_lambda_past)
# Calculate probability of lambda above 1
pivot_lambda_past_final<-pivot_lambda_past[,-c(1:8)]
# view(pivot_lambda_past_final)
# dim(pivot_lambda_past_final)
prob_lambda_past_post<-c()
for(l in 1:nrow(pivot_lambda_past_final)){
  prob_lambda_past_post[l]<-mean(pivot_lambda_past_final[l,]>1,na.rm=T)
}
lam_prob_past<-data.frame(pivot_lambda_past[,1:8],Prlambda=prob_lambda_past_post)
```

```{r}
geo_prlambda_past <- merge(x = lam_prob_past,y =clim_past_values,by=c("pptdorm","tempdorm"), all.x = TRUE) 
# dim(geo_prlambda_past)
# summary(geo_prlambda_current)
```

```{r}
(lambda_map_Prpast <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-107,-92), ylim = c(25,41)) +
  geom_tile(data = geo_prlambda_past, aes(x = x, y = y, fill = Prlambda))+
  annotate(geom="text", x=-100, y=41, label="Past",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = expression("Pr " (lambda) > 1),
    colours = terrain.colors(100),
    na.value = "transparent",
    breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  theme_light()+
 theme(strip.background = element_blank(),
        strip.text  = element_text(face = "italic", color = "black"),
       legend.position = c(0.15, 0.7),
          legend.direction = "vertical")+
  labs(x = "Longitude", y = "Latitude",title="A") )

```

```{r}
lambbacurrent %>% 
  unique %>% 
  pivot_wider( values_from = 'lambda_diff',
               names_from  = 'posterior_id' )->pivot_lambda_current
dim(pivot_lambda_current)
pivot_lambda_current_final<-pivot_lambda_current[,-c(1:8)]
# dim(pivot_lambda_current_final)
# Calculate probability of lambda above 1
prob_lambda_current_post<-c()
for(l in 1:nrow(pivot_lambda_current_final)){
  prob_lambda_current_post[l]<-mean(pivot_lambda_current_final[l,]>1,na.rm=T)
}
lam_prob_current<-data.frame(pivot_lambda_current[,1:8],Prlambda=prob_lambda_current_post)
# dim(lam_prob_current)
```

```{r}
# summary(geo_prlambda_current)
geo_prlambda_current <- merge(x =lam_prob_current ,y = clim_current_values,by=c("pptdorm","tempdorm"),all.x=TRUE) 
# dim(geo_prlambda_current)
# geo_prlambda_current <- geo_prlambda_current[complete.cases(geo_prlambda_current), ]

# sum(is.na(geo_prlambda_current$Prlambda))
# 
# %>% 
#   drop_na("Prlambda","x","y")
# summary(geo_prlambda_current)
```

```{r}
(lambda_map_Prcurrent <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = geo_prlambda_current, aes(x = x, y = y, fill = Prlambda))+
  geom_point(data=poar_occ_1990_2019,aes(lon, lat),alpha=1/5)+
  annotate(geom="text", x=-100, y=41, label="Current",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = expression("Pr " (lambda) > 1),
    colours = terrain.colors(100),
    na.value = "transparent",
    breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  theme_light()+
 theme(strip.background = element_blank(),
       legend.position = "none",
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="B") )
```


```{r}
lambba45 %>% 
  unique %>% 
  pivot_wider( values_from = 'lambda_diff',
               names_from  = 'posterior_id' )->pivot_lambda_45
dim(pivot_lambda_45)
pivot_lambda_45_final<-pivot_lambda_45[,-c(1:8)]
# dim(pivot_lambda_45_final)
# Calculate probability of lambda above 1
prob_lambda_45_post<-c()
for(l in 1:nrow(pivot_lambda_45_final)){
  prob_lambda_45_post[l]<-mean(pivot_lambda_45_final[l,]>1,na.rm=T)
}
lam_prob_45<-data.frame(pivot_lambda_45[,1:8],Prlambda=prob_lambda_45_post)
```

```{r}
# class(climate_miroc45_values)
geo_prlambda_45 <- merge(x = lam_prob_45,y =climate_miroc45_values,by=c("pptdorm","tempdorm"),all.x=TRUE) 
# dim(geo_prlambda_45)
# summary(geo_prlambda_current)
```

```{r}
(lambda_map_Prmiroc45 <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = geo_prlambda_45, aes(x = x, y = y, fill = Prlambda))+
  # geom_point(data=poar_occ_1990_2019,aes(lon, lat),alpha=1/5)+
  annotate(geom="text", x=-100, y=41, label="RCP 4.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = expression("Pr " (lambda) > 1),
    colours = terrain.colors(100),
    na.value = "transparent",
    breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  theme_light()+
 theme(strip.background = element_blank(),
       legend.position = "none",
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="C") )

```

```{r}
lambba85 %>% 
  unique %>% 
  pivot_wider( values_from = 'lambda_diff',
               names_from  = 'posterior_id' )->pivot_lambda_85
dim(pivot_lambda_85)
# pivot_lambda_85
# Calculate probability of lambda above 1
pivot_lambda_85_final<-pivot_lambda_85[,-c(1:8)]
# dim(pivot_lambda_85_final)
prob_lambda_85_post<-c()
for(l in 1:nrow(pivot_lambda_85_final)){
  prob_lambda_85_post[l]<-mean(pivot_lambda_85_final[l,]>1,na.rm=T)
}
lam_prob_85<-data.frame(pivot_lambda_85[,1:8],Prlambda=prob_lambda_85_post)
```

```{r}
geo_prlambda_85 <- merge(x = lam_prob_85,y =climate_miroc85_values,by=c("pptdorm","tempdorm")) # merge the demographic data with climatic data for each
# summary(geo_prlambda_current)
```

```{r}
(lambda_map_Prmiroc85 <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = geo_prlambda_85, aes(x = x, y = y, fill = Prlambda))+
  # geom_point(data=poar_occ_1990_2019,aes(lon, lat),alpha=1/5)+
  annotate(geom="text", x=-100, y=41, label="RCP 8.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = expression("Pr " (lambda) > 1),
    colours = terrain.colors(100),
    na.value = "transparent",
    breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  theme_light()+
 theme(strip.background = element_blank(),
       legend.position = "none",
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="D") )

```


```{r}
prob_lambda_past_fd<-c()
for(l in 1:ncol(geo_lambbapast_fd)){
  prob_lambda_past_fd[l]<-mean(geo_lambbapast_fd[,l]>1,na.rm=T)
}

clim_past_values_clean<-na.omit(clim_past_values)
lam_prob_past_fd<-data.frame(clim_past_values_clean[,9:10],Prlambda=prob_lambda_past_fd)

```

```{r}
(lambda_map_Prpast_fd <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-107,-92), ylim = c(25,41)) +
  geom_tile(data = lam_prob_past_fd, aes(x = x, y = y, fill = Prlambda))+
  annotate(geom="text", x=-100, y=41, label="Past",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = expression("Pr " (lambda) > 1),
    colours = terrain.colors(100),
    na.value = "transparent",
    breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  theme_light()+
 theme(strip.background = element_blank(),
       legend.position = c(0.15, 0.7),
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="E") )

```


```{r}
prob_lambda_current_fd<-c()
for(l in 1:ncol(geo_lambbacurrent_fd)){
  prob_lambda_current_fd[l]<-mean(geo_lambbacurrent_fd[,l]>1,na.rm=T)
}
lam_prob_current_fd<-data.frame(clim_current_values[,9:10],Prlambda=prob_lambda_current_fd)

```

```{r}
(lambda_map_Prcurrent_fd <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = lam_prob_current_fd, aes(x = x, y = y, fill = Prlambda))+
  geom_point(data=poar_occ_1990_2019,aes(lon, lat),alpha=1/5)+
  annotate(geom="text", x=-100, y=41, label="Current",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = expression("Pr " (lambda) > 1),
    colours = terrain.colors(100),
    na.value = "transparent",
    breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  theme_light()+
 theme(strip.background = element_blank(),
       legend.position = "none",
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="F") )
```

```{r}
prob_lambda_miroc45_fd<-c()
dim(geo_lambda_miroc45_fd)
for(l in 1:ncol(geo_lambda_miroc45_fd)){
  prob_lambda_miroc45_fd[l]<-mean(geo_lambda_miroc45_fd[,l]>1,na.rm=T)
}
lam_prob_miroc45_fd<-data.frame(climate_miroc45_values[,9:10],Prlambda=prob_lambda_miroc45_fd)
```

```{r}
(lambda_map_miroc45_fd <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = lam_prob_miroc45_fd, aes(x = x, y = y, fill = Prlambda))+
  annotate(geom="text", x=-100, y=41, label="RCP 4.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = expression("Pr " (lambda) > 1),
    colours = terrain.colors(100),
    na.value = "transparent",
     breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  theme_light()+
 theme(strip.background = element_blank(),
       legend.position = "none",
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="G") )
```

```{r}
prob_lambda_miroc85_fd<-c()
dim(geo_lambba_miroc85_fd)
for(l in 1:ncol(geo_lambba_miroc85_fd)){
  prob_lambda_miroc85_fd[l]<-mean(geo_lambba_miroc85_fd[,l]>1,na.rm=T)
}
lam_prob_miroc85_fd<-data.frame(climate_miroc85_values[,9:10],Prlambda=prob_lambda_miroc85_fd)
```

```{r}
(lambda_map_miroc85_fd <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = lam_prob_miroc85_fd, aes(x = x, y = y, fill = Prlambda))+
  annotate(geom="text", x=-100, y=41, label="RCP 8.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = expression("Pr " (lambda) > 1),
    colours = terrain.colors(100),
    na.value = "transparent",
     breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  theme_light()+
 theme(strip.background = element_blank(),
       legend.position = "none",
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="H") )
```


```{r}
geo_prlambda_past_fd_twosex<-left_join(lam_prob_past_fd,geo_prlambda_past,by=c("x","y"))
geo_prlambda_past_fd_twosex$Prlambda<-geo_prlambda_past_fd_twosex$Prlambda.x-geo_prlambda_past_fd_twosex$Prlambda.y
```

```{r}
geo_prlambda_current_fd_twosex<-left_join(lam_prob_current_fd,geo_prlambda_current,by=c("x","y"))
geo_prlambda_current_fd_twosex$Prlambda<-geo_prlambda_current_fd_twosex$Prlambda.x-geo_prlambda_current_fd_twosex$Prlambda.y
```

```{r}
geo_prlambda_miroc45_fd_twosex<-left_join(lam_prob_miroc45_fd,geo_prlambda_45,by=c("x","y"))
geo_prlambda_miroc45_fd_twosex$Prlambda<-geo_prlambda_miroc45_fd_twosex$Prlambda.x-geo_prlambda_miroc45_fd_twosex$Prlambda.y
```

```{r}
geo_prlambda_miroc85_fd_twosex<-left_join(lam_prob_miroc85_fd,geo_prlambda_85,by=c("x","y"))
geo_prlambda_miroc85_fd_twosex$Prlambda<-geo_prlambda_miroc85_fd_twosex$Prlambda.x-geo_prlambda_miroc85_fd_twosex$Prlambda.y
```

```{r}
(lambda_map_Prpast_diff <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-107,-92), ylim = c(25,41)) +
  geom_tile(data = geo_prlambda_past_fd_twosex, aes(x = x, y = y, fill = lambda_diff))+
  annotate(geom="text", x=-100, y=41, label="Past",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = expression(paste(Delta,("Pr " (lambda) > 1))),
    colours = terrain.colors(100),
    na.value = "transparent",
     breaks = seq(-0.5, 0.5, length.out=5),labels=c(0.5,-0.25,0.00,0.25,0.5),
                           limits=c(-0.5,0.5))+
  theme_light()+
 theme(strip.background = element_blank(),
        strip.text  = element_text(face = "italic", color = "black"),
            legend.position = c(0.15, 0.7),
       legend.direction = "vertical")+
  labs(x = "Longitude", y = "Latitude",title="I") )

```

```{r}
(lambda_map_Prcurrent_diff <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-107,-92), ylim = c(25,41)) +
  geom_tile(data = geo_prlambda_current_fd_twosex, aes(x = x, y = y, fill = lambda_diff))+
  annotate(geom="text", x=-100, y=41, label="Cuurent",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = expression(paste(Delta," (FD-2S)")),
    colours = terrain.colors(100),
    na.value = "transparent",
     breaks = seq(-0.5, 0.5, length.out=5),labels=c(0.5,-0.25,0.00,0.25,0.5),
                           limits=c(-0.5,0.5))+
  theme_light()+
 theme(strip.background = element_blank(),
       legend.position = "none",
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="J") )

```

```{r}
(lambda_map_Prmiroc45_diff <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-107,-92), ylim = c(25,41)) +
  geom_tile(data = geo_prlambda_miroc45_fd_twosex, aes(x = x, y = y, fill = lambda_diff))+
  annotate(geom="text", x=-100, y=41, label="RCP 4.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = expression(paste(Delta," (FD-2S)")),
    colours = terrain.colors(100),
    na.value = "transparent",
     breaks = seq(-0.5, 0.5, length.out=5),labels=c(0.5,-0.25,0.00,0.25,0.5),
                           limits=c(-0.5,0.5))+
  theme_light()+
 theme(strip.background = element_blank(),
       legend.position = "none",
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="K") )

```


```{r}
(lambda_map_Prmiroc85_diff <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-107,-92), ylim = c(25,41)) +
  geom_tile(data = geo_prlambda_miroc85_fd_twosex, aes(x = x, y = y, fill = lambda_diff))+
  annotate(geom="text", x=-100, y=41, label="RCP 8.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = expression(paste(Delta," (FD-2S)")),
    colours = terrain.colors(100),
    na.value = "transparent",
     breaks = seq(-0.5, 0.5, length.out=5),labels=c(0.5,-0.25,0.00,0.25,0.5),
                           limits=c(-0.5,0.5))+
  theme_light()+
 theme(strip.background = element_blank(),
       legend.position = "none",
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="L") )

```


```{r}
dat_miroc_map<-rbind(geo_prlambda_past[,c("x","y","Prlambda")],lam_prob_past_fd[,c("x","y","Prlambda")],geo_prlambda_past_fd_twosex[,c("x","y","Prlambda")],geo_prlambda_current[,c("x","y","Prlambda")],lam_prob_current_fd[,c("x","y","Prlambda")],geo_prlambda_current_fd_twosex[,c("x","y","Prlambda")],geo_prlambda_45[,c("x","y","Prlambda")],lam_prob_miroc45_fd[,c("x","y","Prlambda")],geo_prlambda_miroc45_fd_twosex[,c("x","y","Prlambda")],geo_prlambda_85[,c("x","y","Prlambda")],lam_prob_miroc85_fd[,c("x","y","Prlambda")],geo_prlambda_miroc85_fd_twosex[,c("x","y","Prlambda")])

dim(dat_miroc_map)

dat_miroc_map$Time<-c(rep("Past",nrow(geo_prlambda_past)+nrow(lam_prob_past_fd)+nrow(geo_prlambda_past_fd_twosex)),rep("Present",3*nrow(geo_prlambda_current)),rep("RCP45",3*nrow(geo_prlambda_45)),rep("RCP85",3*nrow(geo_prlambda_85)))

dat_miroc_map$model<-c(rep("B",nrow(geo_prlambda_past)),rep("A",nrow(lam_prob_past_fd)),rep("C",nrow(geo_prlambda_past_fd_twosex)),
                       rep("B",nrow(geo_prlambda_current)),rep("A",nrow(lam_prob_current_fd)),rep("C",nrow(geo_prlambda_current_fd_twosex)),
                       rep("B",nrow(geo_prlambda_45)),rep("A",nrow(lam_prob_miroc45_fd)),rep("C",nrow(geo_prlambda_miroc45_fd_twosex)),
                       
                      rep("B",nrow(geo_prlambda_85)),rep("A",nrow(lam_prob_miroc85_fd)),rep("C",nrow(geo_prlambda_miroc85_fd_twosex)) 
                                    )
```

```{r}
library(ggnewscale)
model_names <- c("A"="Female dominant model (F)",
                    "B"="Two-sex model (FM)",
                    "C"="F - FM"
                    )
Time_names <- c("Past"="Past",
                    "Present"="Present",
                    "RCP45"="RCP 4.5",
                    "RCP85"="RCP 8.5"
                 )

Fig_geoPrlambdamiroc<-ggplot()+
  geom_tile(data = subset(dat_miroc_map, model == "A"), aes(x = x, y = y, fill = Prlambda))+
  # facet_grid(model~Time,scales='free_x', space='free_x',labeller = labeller(model = model_names,Time=Time_names)) +
  labs(x = "Longitude", y = "Latitude")+
  scale_fill_gradientn(
    name = expression("Pr " (lambda[F]) > 1),
    colours = terrain.colors(100),
    na.value = "transparent",
     breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  new_scale_fill() +
  geom_tile(data = subset(dat_miroc_map, model == "B"), aes(x = x, y = y, fill = Prlambda))+
  # facet_grid(model~Time,scales='free_x', space='free_x',labeller = labeller(model = model_names,Time=Time_names)) +
  labs(x = "Longitude", y = "Latitude")+
  scale_fill_gradientn(
    name = expression("Pr " (lambda[FM]) > 1),
    colours = terrain.colors(100),
    na.value = "transparent",
     breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  new_scale_fill() +
  geom_tile(data = subset(dat_miroc_map, model == "C"), aes(x = x, y = y, fill = Prlambda))+
  scale_fill_gradientn(
    name = expression(paste(Delta,"Pr " (lambda[F-FM]))> 1),
    colours = colorspace::diverge_hcl(7),
    na.value = "transparent",
    breaks = seq(-0.5, 0.5, length.out=5),labels=c(-0.5,-0.25,0.00,0.25,0.5),
                           limits=c(-0.5,0.5))+
  facet_grid(model~Time,labeller = labeller(model = model_names,Time=Time_names))+
  theme_light()+
 theme(legend.position = "bottom",
       legend.title = element_text(size = 8),
       legend.text  = element_text(size = 7),
       strip.text.x = element_text(
        size = 10, color = "grey40", face = "bold"
        ),
      strip.text.y = element_text(
        size = 10, color = "grey40", face = "bold"),
      strip.background = element_rect(
     color="black", fill="white", size=0.5, linetype="solid"
     )
        )
  

```

```{r}
Fig_geoPrlambdamiroc<-ggarrange(lambda_map_Prpast, lambda_map_Prcurrent, lambda_map_Prmiroc45, lambda_map_Prmiroc85,lambda_map_Prpast_fd,lambda_map_Prcurrent_fd,lambda_map_miroc45_fd,lambda_map_miroc85_fd,lambda_map_Prpast_diff,lambda_map_Prcurrent_diff,lambda_map_Prmiroc45_diff,lambda_map_Prmiroc85_diff,common.legend = FALSE,ncol = 4, nrow = 3)
ggsave("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/Fig_geoPrlambda_miroc.pdf", Fig_geoPrlambdamiroc, width =9, height = 10)
```

```{r}
lambbacmc45 %>% 
  unique %>% 
  pivot_wider( values_from = 'lambda_diff',
               names_from  = 'posterior_id' )->pivot_lambdacmc_45
# dim(pivot_lambda_current)
pivot_lambdacmc_45_final<-pivot_lambdacmc_45[,-c(1:8)]
dim(pivot_lambdacmc_45_final)
# Calculate probability of lambda above 1
prob_lambdacmc_45_post<-c()
for(l in 1:nrow(pivot_lambdacmc_45_final)){
  prob_lambdacmc_45_post[l]<-mean(pivot_lambdacmc_45_final[l,]>1,na.rm=T)
}
lamcmc_prob_45<-data.frame(pivot_lambdacmc_45[,1:8],Prlambda=prob_lambdacmc_45_post)
```

```{r}
# class(climate_cmc45_values)
geo_prlambdacmc_45 <- merge(x = lamcmc_prob_45,y =climate_cmc_45_values,by=c("pptdorm","tempdorm"),all.x=TRUE) 
# summary(geo_prlambdacmc_45)
```

```{r}
(lambda_map_Prcmc45 <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = geo_prlambdacmc_45, aes(x = x, y = y, fill = Prlambda))+
  # geom_point(data=poar_occ_1990_2019,aes(lon, lat),alpha=1/5)+
  annotate(geom="text", x=-100, y=41, label="RCP 4.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = expression("Pr " (lambda) > 1),
    colours = terrain.colors(100),
    breaks = seq(0, 1, length.out=5))+
  theme_light()+
 theme(strip.background = element_blank(),
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="C") )

```

```{r}
lambbacmc85 %>% 
  unique %>% 
  pivot_wider( values_from = 'lambda_diff',
               names_from  = 'posterior_id' )->pivot_lambdacmc_85
# dim(pivot_lambda_current)
pivot_lambdacmc_85_final<-pivot_lambdacmc_85[,-c(1:8)]
dim(pivot_lambdacmc_85_final)
# Calculate probability of lambda above 1
prob_lambdacmc_85_post<-c()
for(l in 1:nrow(pivot_lambdacmc_85_final)){
  prob_lambdacmc_85_post[l]<-mean(pivot_lambdacmc_85_final[l,]>1,na.rm=T)
}
lamcmc_prob_85<-data.frame(pivot_lambdacmc_85[,1:8],Prlambda=prob_lambdacmc_85_post)
```

```{r}
geo_prlambdacmc_85 <- merge(x = lamcmc_prob_85,y =climate_cmc_85_values,by=c("pptdorm","tempdorm")) # merge the demographic data with climatic data for each
# summary(geo_prlambda_current)
```

```{r}
(lambda_map_Prcmc85 <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = geo_prlambdacmc_85, aes(x = x, y = y, fill = Prlambda))+
  # geom_point(data=poar_occ_1990_2019,aes(lon, lat),alpha=1/5)+
  annotate(geom="text", x=-100, y=41, label="RCP 8.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = expression("Pr " (lambda) > 1),
    colours = terrain.colors(100),
   breaks = seq(0, 1, length.out=5))+
  theme_light()+
 theme(strip.background = element_blank(),
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="D") )

```

```{r}
prob_lambda_cmc45_fd<-c()
dim(geo_lambba_cmc45_fd)
for(l in 1:ncol(geo_lambba_cmc45_fd)){
  prob_lambda_cmc45_fd[l]<-mean(geo_lambba_cmc45_fd[,l]>1,na.rm=T)
}
lam_prob_cmc45_fd<-data.frame(climate_cmc_45_values[,9:10],Prlambda=prob_lambda_cmc45_fd)
```

```{r}
(lambda_map_cmc45_fd <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = lam_prob_cmc45_fd, aes(x = x, y = y, fill = Prlambda))+
  annotate(geom="text", x=-100, y=41, label="RCP 4.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = expression("Pr " (lambda) > 1),
    colours = terrain.colors(100),
    breaks = seq(0, 1, length.out=5))+
  theme_light()+
 theme(strip.background = element_blank(),
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="G") )
```

```{r}
prob_lambda_cmc85_fd<-c()
dim(geolambba_cmc85_fd)
for(l in 1:ncol(geolambba_cmc85_fd)){
  prob_lambda_cmc85_fd[l]<-mean(geolambba_cmc85_fd[,l]>1,na.rm=T)
}
lam_prob_cmc85_fd<-data.frame(climate_cmc_85_values[,9:10],Prlambda=prob_lambda_cmc85_fd)
```

```{r}
(lambda_map_cmc85_fd <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = lam_prob_cmc85_fd, aes(x = x, y = y, fill = Prlambda))+
  annotate(geom="text", x=-100, y=41, label="RCP 8.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = expression("Pr " (lambda) > 1),
    colours = terrain.colors(100),
    breaks = seq(0, 1, length.out=5))+
  theme_light()+
 theme(strip.background = element_blank(),
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="H") )
```

```{r}
geo_prlambda_cmc45_fd_twosex<-left_join(lam_prob_cmc45_fd,geo_prlambdacmc_45,by=c("x","y"))
geo_prlambda_cmc45_fd_twosex$Prlambda<-geo_prlambda_cmc45_fd_twosex$Prlambda.x-geo_prlambda_cmc45_fd_twosex$Prlambda.y
```

```{r}
geo_prlambda_cmc85_fd_twosex<-left_join(lam_prob_cmc85_fd,geo_prlambdacmc_85,by=c("x","y"))
geo_prlambda_cmc85_fd_twosex$Prlambda<-geo_prlambda_cmc85_fd_twosex$Prlambda.x-geo_prlambda_cmc85_fd_twosex$Prlambda.y
```

```{r}
dat_cmc_map<-rbind(geo_prlambda_past[,c("x","y","Prlambda")],lam_prob_past_fd[,c("x","y","Prlambda")],geo_prlambda_past_fd_twosex[,c("x","y","Prlambda")],geo_prlambda_current[,c("x","y","Prlambda")],lam_prob_current_fd[,c("x","y","Prlambda")],geo_prlambda_current_fd_twosex[,c("x","y","Prlambda")],geo_prlambdacmc_45[,c("x","y","Prlambda")],lam_prob_cmc45_fd[,c("x","y","Prlambda")],geo_prlambda_cmc45_fd_twosex[,c("x","y","Prlambda")],geo_prlambdacmc_85[,c("x","y","Prlambda")],lam_prob_cmc85_fd[,c("x","y","Prlambda")],geo_prlambda_cmc85_fd_twosex[,c("x","y","Prlambda")])

dim(dat_cmc_map)

dat_cmc_map$Time<-c(rep("Past",nrow(geo_prlambda_past)+nrow(lam_prob_past_fd)+nrow(geo_prlambda_past_fd_twosex)),rep("Present",3*nrow(geo_prlambda_current)),rep("RCP45",3*nrow(geo_prlambdacmc_45)),rep("RCP85",3*nrow(geo_prlambdacmc_85)))

dat_cmc_map$model<-c(rep("B",nrow(geo_prlambda_past)),rep("A",nrow(lam_prob_past_fd)),rep("C",nrow(geo_prlambda_past_fd_twosex)),
                       rep("B",nrow(geo_prlambda_current)),rep("A",nrow(lam_prob_current_fd)),rep("C",nrow(geo_prlambda_current_fd_twosex)),
                       rep("B",nrow(geo_prlambdacmc_45)),rep("A",nrow(lam_prob_cmc45_fd)),rep("C",nrow(geo_prlambda_cmc45_fd_twosex)),
                       
                      rep("B",nrow(geo_prlambdacmc_85)),rep("A",nrow(lam_prob_cmc85_fd)),rep("C",nrow(geo_prlambda_cmc85_fd_twosex)) 
                                    )
```


```{r}
Fig_geoPrlambdacmc<-ggplot()+
  geom_tile(data = subset(dat_cmc_map, model == "A"), aes(x = x, y = y, fill = Prlambda))+
  # facet_grid(model~Time,scales='free_x', space='free_x',labeller = labeller(model = model_names,Time=Time_names)) +
  labs(x = "Longitude", y = "Latitude")+
  scale_fill_gradientn(
    name = expression("Pr " (lambda[F]) > 1),
    colours = terrain.colors(100),
    na.value = "transparent",
     breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  new_scale_fill() +
  geom_tile(data = subset(dat_cmc_map, model == "B"), aes(x = x, y = y, fill = Prlambda))+
  # facet_grid(model~Time,scales='free_x', space='free_x',labeller = labeller(model = model_names,Time=Time_names)) +
  labs(x = "Longitude", y = "Latitude")+
  scale_fill_gradientn(
    name = expression("Pr " (lambda[FM]) > 1),
    colours = terrain.colors(100),
    na.value = "transparent",
     breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  new_scale_fill() +
  geom_tile(data = subset(dat_cmc_map, model == "C"), aes(x = x, y = y, fill = Prlambda))+
  scale_fill_gradientn(
    name = expression(paste(Delta,"Pr " (lambda[F-FM]))> 1),
    colours = colorspace::diverge_hcl(7),
    na.value = "transparent",
    breaks = seq(-0.5, 0.5, length.out=5),labels=c(-0.5,-0.25,0.00,0.25,0.5),
                           limits=c(-0.5,0.5))+
  facet_grid(model~Time,labeller = labeller(model = model_names,Time=Time_names))+
  theme_light()+
 theme(legend.position = "bottom",
       legend.title = element_text(size = 8),
       legend.text  = element_text(size = 7),
       strip.text.x = element_text(
        size = 12, color = "grey40", face = "bold"
        ),
      strip.text.y = element_text(
        size = 12, color = "grey40", face = "bold"),
      strip.background = element_rect(
     color="black", fill="white", size=0.5, linetype="solid"
     )
        )
```


```{r}
Fig_geoPrlambdacmc<-ggarrange(lambda_map_Prpast, lambda_map_Prcurrent, lambda_map_Prcmc45, lambda_map_Prcmc85,lambda_map_Prpast_fd, lambda_map_Prcurrent_fd, lambda_map_cmc45_fd, lambda_map_cmc85_fd, common.legend = TRUE,ncol = 4, nrow = 2)
ggsave("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/Fig_geoPrlambdacmc.pdf", Fig_geoPrlambdacmc, width = 9, height = 10)
```




```{r}
lambbaacc45 %>% 
  unique %>% 
  pivot_wider( values_from = 'lambda_diff',
               names_from  = 'posterior_id' )->pivot_lambdaacc_45
dim(pivot_lambdaacc_45)
pivot_lambdaacc_45_final<-pivot_lambdaacc_45[,-c(1:8)]
# Calculate probability of lambda above 1
prob_lambdaacc_45_post<-c()
for(l in 1:nrow(pivot_lambdaacc_45_final)){
  prob_lambdaacc_45_post[l]<-mean(pivot_lambdaacc_45_final[l,]>1,na.rm=T)
}
lambaacc_prob_45<-data.frame(pivot_lambdaacc_45[,1:8],Prlambda=prob_lambdaacc_45_post)
```

```{r}
# class(climate_cmc45_values)
geo_prlambdaacc_45 <- merge(x = lambaacc_prob_45,y =climate_acc_45_values,by=c("pptdorm","tempdorm"),all.x=TRUE) 
# summary(geo_prlambdacmc_45)
```

```{r}
(lambda_map_Pracc45 <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = geo_prlambdaacc_45, aes(x = x, y = y, fill = Prlambda))+
  # geom_point(data=poar_occ_1990_2019,aes(lon, lat),alpha=1/5)+
  annotate(geom="text", x=-100, y=41, label="RCP 4.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = expression("Pr " (lambda) > 1),
    colours = terrain.colors(100),
   breaks = seq(0, 1, length.out=5))+
  theme_light()+
 theme(strip.background = element_blank(),
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="C") )

```

```{r}
lambbaacc85 %>% 
  unique %>% 
  pivot_wider( values_from = 'lambda_diff',
               names_from  = 'posterior_id' )->pivot_lambdacc_85
# dim(pivot_lambdacc_85)
pivot_lambdacc_85_final<-pivot_lambdacc_85[,-c(1:8)]
# Calculate probability of lambda above 1
prob_lambdaacc_85_post<-c()
for(l in 1:nrow(pivot_lambdacc_85_final)){
  prob_lambdaacc_85_post[l]<-mean(pivot_lambdacc_85_final[l,]>1,na.rm=T)
}
lambdaacc_prob_85<-data.frame(pivot_lambdacc_85[,1:8],Prlambda=prob_lambdaacc_85_post)
```

```{r}
geo_prlambdaacc_85 <- merge(x = lambdaacc_prob_85,y =climate_acc_85_values,by=c("pptdorm","tempdorm")) # merge the demographic data with climatic data for each
# summary(geo_prlambda_current)
```

```{r}
(lambda_map_Pracc85 <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = geo_prlambdaacc_85, aes(x = x, y = y, fill = Prlambda))+
  # geom_point(data=poar_occ_1990_2019,aes(lon, lat),alpha=1/5)+
  annotate(geom="text", x=-100, y=41, label="RCP 8.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = expression("Pr " (lambda) > 1),
    colours = terrain.colors(100),
    breaks = seq(0, 1, length.out=5))+
  theme_light()+
 theme(strip.background = element_blank(),
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="D") )

```

```{r}
prob_lambda_acc45_fd<-c()
dim(geo_lambba_acc45_fd)
for(l in 1:ncol(geo_lambba_acc45_fd)){
  prob_lambda_acc45_fd[l]<-mean(geo_lambba_acc45_fd[,l]>1,na.rm=T)
}
lam_prob_acc45_fd<-data.frame(climate_acc_45_values[,9:10],Prlambda=prob_lambda_acc45_fd)
```

```{r}
(lambda_map_acc45_fd <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = lam_prob_acc45_fd, aes(x = x, y = y, fill = Prlambda))+
  annotate(geom="text", x=-100, y=41, label="RCP 4.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = expression("Pr " (lambda) > 1),
    colours = terrain.colors(100),
    breaks = seq(0, 1, length.out=5))+
  theme_light()+
 theme(strip.background = element_blank(),
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="G") )
```


```{r}
prob_lambda_acc85_fd<-c()
dim(geolambba_acc85_fd)
for(l in 1:ncol(geolambba_acc85_fd)){
  prob_lambda_acc85_fd[l]<-mean(geolambba_acc85_fd[,l]>1,na.rm=T)
}
lam_prob_acc85_fd<-data.frame(climate_acc_85_values[,9:10],Prlambda=prob_lambda_acc85_fd)
```

```{r}
(lambda_map_acc85_fd <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = lam_prob_acc85_fd, aes(x = x, y = y, fill = Prlambda))+
  annotate(geom="text", x=-100, y=41, label="RCP 8.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = expression("Pr " (lambda) > 1),
    colours = terrain.colors(100),
    breaks = seq(0, 1, length.out=5))+
  theme_light()+
 theme(strip.background = element_blank(),
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="H") )
```


```{r}
geo_prlambda_acc45_fd_twosex<-left_join(lam_prob_acc45_fd,geo_prlambdaacc_45,by=c("x","y"))
geo_prlambda_acc45_fd_twosex$Prlambda<-geo_prlambda_acc45_fd_twosex$Prlambda.x-geo_prlambda_acc45_fd_twosex$Prlambda.y
```

```{r}
geo_prlambda_acc85_fd_twosex<-left_join(lam_prob_acc85_fd,geo_prlambdaacc_85,by=c("x","y"))
geo_prlambda_acc85_fd_twosex$Prlambda<-geo_prlambda_acc85_fd_twosex$Prlambda.x-geo_prlambda_acc85_fd_twosex$Prlambda.y
```

```{r}
dat_acc_map<-rbind(geo_prlambda_past[,c("x","y","Prlambda")],lam_prob_past_fd[,c("x","y","Prlambda")],geo_prlambda_past_fd_twosex[,c("x","y","Prlambda")],geo_prlambda_current[,c("x","y","Prlambda")],lam_prob_current_fd[,c("x","y","Prlambda")],geo_prlambda_current_fd_twosex[,c("x","y","Prlambda")],geo_prlambdaacc_45[,c("x","y","Prlambda")],lam_prob_acc45_fd[,c("x","y","Prlambda")],geo_prlambda_acc45_fd_twosex[,c("x","y","Prlambda")],geo_prlambdaacc_85[,c("x","y","Prlambda")],lam_prob_acc85_fd[,c("x","y","Prlambda")],geo_prlambda_acc85_fd_twosex[,c("x","y","Prlambda")])

dim(dat_acc_map)

dat_acc_map$Time<-c(rep("Past",nrow(geo_prlambda_past)+nrow(lam_prob_past_fd)+nrow(geo_prlambda_past_fd_twosex)),rep("Present",3*nrow(geo_prlambda_current)),rep("RCP45",3*nrow(geo_prlambdaacc_45)),rep("RCP85",3*nrow(geo_prlambdaacc_85)))

dat_acc_map$model<-c(rep("B",nrow(geo_prlambda_past)),rep("A",nrow(lam_prob_past_fd)),rep("C",nrow(geo_prlambda_past_fd_twosex)),
                       rep("B",nrow(geo_prlambda_current)),rep("A",nrow(lam_prob_current_fd)),rep("C",nrow(geo_prlambda_current_fd_twosex)),
                       rep("B",nrow(geo_prlambdaacc_45)),rep("A",nrow(lam_prob_acc45_fd)),rep("C",nrow(geo_prlambda_acc45_fd_twosex)),
                       
                      rep("B",nrow(geo_prlambdaacc_85)),rep("A",nrow(lam_prob_acc85_fd)),rep("C",nrow(geo_prlambda_acc85_fd_twosex)) 
                                    )
```


```{r}
Fig_geoPrlambdaacc<-ggplot()+
  geom_tile(data = subset(dat_acc_map, model == "A"), aes(x = x, y = y, fill = Prlambda))+
  # facet_grid(model~Time,scales='free_x', space='free_x',labeller = labeller(model = model_names,Time=Time_names)) +
  labs(x = "Longitude", y = "Latitude")+
  scale_fill_gradientn(
    name = expression("Pr " (lambda[F]) > 1),
    colours = terrain.colors(100),
    na.value = "transparent",
     breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  new_scale_fill() +
  geom_tile(data = subset(dat_acc_map, model == "B"), aes(x = x, y = y, fill = Prlambda))+
  # facet_grid(model~Time,scales='free_x', space='free_x',labeller = labeller(model = model_names,Time=Time_names)) +
  labs(x = "Longitude", y = "Latitude")+
  scale_fill_gradientn(
    name = expression("Pr " (lambda[FM]) > 1),
    colours = terrain.colors(100),
    na.value = "transparent",
     breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  new_scale_fill() +
  geom_tile(data = subset(dat_acc_map, model == "C"), aes(x = x, y = y, fill = Prlambda))+
  scale_fill_gradientn(
    name = expression(paste(Delta,"Pr " (lambda[F-FM]))> 1),
    colours = colorspace::diverge_hcl(7),
    na.value = "transparent",
    breaks = seq(-0.5, 0.5, length.out=5),labels=c(-0.5,-0.25,0.00,0.25,0.5),
                           limits=c(-0.5,0.5))+
  facet_grid(model~Time,labeller = labeller(model = model_names,Time=Time_names))+
  theme_light()+
 theme(legend.position = "bottom",
       legend.title = element_text(size = 8),
       legend.text  = element_text(size = 7),
       strip.text.x = element_text(
        size = 10, color = "grey40", face = "bold"
        ),
      strip.text.y = element_text(
        size = 10, color = "grey40", face = "bold"),
      strip.background = element_rect(
     color="black", fill="white", size=0.5, linetype="solid"
     )
        )
```


```{r}
Fig_geoPrlambdaacc<-ggarrange(lambda_map_Prpast, lambda_map_Prcurrent, lambda_map_Pracc45, lambda_map_Pracc85,lambda_map_Prpast_fd, lambda_map_Prcurrent_fd,lambda_map_acc45_fd,lambda_map_acc85_fd,ncol=4,nrow=2,
                                        common.legend = TRUE)
ggsave("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/Fig_geoPrlambdaacc.pdf", Fig_geoPrlambdaacc, width = 9, height = 10)
```



```{r}
lambbaces45 %>% 
  unique %>% 
  pivot_wider( values_from = 'lambda_diff',
               names_from  = 'posterior_id' )->pivot_lambdaces_45
dim(pivot_lambdaces_45)
pivot_lambdaces_45_final<-pivot_lambdaces_45[,-c(1:8)]
# Calculate probability of lambda above 1
prob_lambdaces_45_post<-c()
for(l in 1:nrow(pivot_lambdaces_45_final)){
  prob_lambdaces_45_post[l]<-mean(pivot_lambdaces_45_final[l,]>1,na.rm=T)
}
lambaces_prob_45<-data.frame(pivot_lambdaces_45[,1:8],Prlambda=prob_lambdaces_45_post)
```

```{r}
# class(climate_cmc45_values)
geo_prlambdaces_45 <- merge(x = lambaces_prob_45,y =climate_ces_45_values,by=c("pptdorm","tempdorm"),all.x=TRUE) 
# summary(geo_prlambdacmc_45)
```

```{r}
(lambda_map_Prces45 <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = geo_prlambdaces_45, aes(x = x, y = y, fill = Prlambda))+
  # geom_point(data=poar_occ_1990_2019,aes(lon, lat),alpha=1/5)+
  annotate(geom="text", x=-100, y=41, label="RCP 4.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = expression("Pr " (lambda) > 1),
    colours = terrain.colors(100),
    breaks = seq(0, 1, length.out=5))+
  theme_light()+
 theme(strip.background = element_blank(),
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="C") )

```

```{r}
lambbaces85 %>% 
  unique %>% 
  pivot_wider( values_from = 'lambda_diff',
               names_from  = 'posterior_id' )->pivot_lambdaces_85
dim(pivot_lambdaces_85)
pivot_lambdaces_85_final<-pivot_lambdaces_85[,-c(1:8)]
# Calculate probability of lambda above 1
prob_lambdaces_85_post<-c()
for(l in 1:nrow(pivot_lambdaces_85_final)){
  prob_lambdaces_85_post[l]<-mean(pivot_lambdaces_85_final[l,]>1,na.rm=T)
}
lambdaces_prob_85<-data.frame(pivot_lambdaces_85[,1:8],Prlambda=prob_lambdaces_85_post)
```

```{r}
geo_prlambdaces_85 <- merge(x = lambdaces_prob_85,y =climate_ces_85_values,by=c("pptdorm","tempdorm")) # merge the demographic data with climatic data for each
# summary(geo_prlambda_current)
```

```{r}
(lambda_map_Prces85 <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = geo_prlambdaces_85, aes(x = x, y = y, fill = Prlambda))+
  # geom_point(data=poar_occ_1990_2019,aes(lon, lat),alpha=1/5)+
  annotate(geom="text", x=-100, y=41, label="RCP 8.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = expression("Pr " (lambda) > 1),
    colours = terrain.colors(100),
     breaks = seq(0, 1, length.out=5))+
  theme_light()+
 theme(strip.background = element_blank(),
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="D") )

```

```{r}
prob_lambda_ces45_fd<-c()
dim(geo_lambba_ces45_fd)
for(l in 1:ncol(geo_lambba_ces45_fd)){
  prob_lambda_ces45_fd[l]<-mean(geo_lambba_ces45_fd[,l]>1,na.rm=T)
}
lam_prob_ces45_fd<-data.frame(climate_ces_45_values[,9:10],Prlambda=prob_lambda_ces45_fd)
```

```{r}
(lambda_map_ces45_fd <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = lam_prob_ces45_fd, aes(x = x, y = y, fill = Prlambda))+
  annotate(geom="text", x=-100, y=41, label="RCP 4.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = expression("Pr " (lambda) > 1),
    colours = terrain.colors(100),
     breaks = seq(0, 1, length.out=5))+
  theme_light()+
 theme(strip.background = element_blank(),
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="G") )
```

```{r}
prob_lambda_ces85_fd<-c()
dim(geolambba_ces85_fd)
for(l in 1:ncol(geolambba_ces85_fd)){
  prob_lambda_ces85_fd[l]<-mean(geolambba_ces85_fd[,l]>1,na.rm=T)
}
lam_prob_ces85_fd<-data.frame(climate_ces_85_values[,9:10],Prlambda=prob_lambda_ces85_fd)
```

```{r}
(lambda_map_ces85_fd <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = lam_prob_ces85_fd, aes(x = x, y = y, fill = Prlambda))+
  annotate(geom="text", x=-100, y=41, label="RCP 8.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = expression("Pr " (lambda) > 1),
    colours = terrain.colors(100),
     breaks = seq(0, 1, length.out=5))+
  theme_light()+
 theme(strip.background = element_blank(),
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="H") )
```


```{r}
geo_prlambda_ces45_fd_twosex<-left_join(lam_prob_ces45_fd,geo_prlambdaces_45,by=c("x","y"))
geo_prlambda_ces45_fd_twosex$Prlambda<-geo_prlambda_ces45_fd_twosex$Prlambda.x-geo_prlambda_ces45_fd_twosex$Prlambda.y
```

```{r}
geo_prlambda_ces85_fd_twosex<-left_join(lam_prob_ces85_fd,geo_prlambdaces_85,by=c("x","y"))
geo_prlambda_ces85_fd_twosex$Prlambda<-geo_prlambda_ces85_fd_twosex$Prlambda.x-geo_prlambda_ces85_fd_twosex$Prlambda.y
```


```{r}
dat_ces_map<-rbind(geo_prlambda_past[,c("x","y","Prlambda")],lam_prob_past_fd[,c("x","y","Prlambda")],geo_prlambda_past_fd_twosex[,c("x","y","Prlambda")],geo_prlambda_current[,c("x","y","Prlambda")],lam_prob_current_fd[,c("x","y","Prlambda")],geo_prlambda_current_fd_twosex[,c("x","y","Prlambda")],geo_prlambdaces_45[,c("x","y","Prlambda")],lam_prob_ces45_fd[,c("x","y","Prlambda")],geo_prlambda_ces45_fd_twosex[,c("x","y","Prlambda")],geo_prlambdaces_85[,c("x","y","Prlambda")],lam_prob_ces85_fd[,c("x","y","Prlambda")],geo_prlambda_ces85_fd_twosex[,c("x","y","Prlambda")])

dim(dat_ces_map)

dat_ces_map$Time<-c(rep("Past",nrow(geo_prlambda_past)+nrow(lam_prob_past_fd)+nrow(geo_prlambda_past_fd_twosex)),rep("Present",3*nrow(geo_prlambda_current)),rep("RCP45",3*nrow(geo_prlambdaces_45)),rep("RCP85",3*nrow(geo_prlambdaces_85)))

dat_ces_map$model<-c(rep("B",nrow(geo_prlambda_past)),rep("A",nrow(lam_prob_past_fd)),rep("C",nrow(geo_prlambda_past_fd_twosex)),
                       rep("B",nrow(geo_prlambda_current)),rep("A",nrow(lam_prob_current_fd)),rep("C",nrow(geo_prlambda_current_fd_twosex)),
                       rep("B",nrow(geo_prlambdaces_45)),rep("A",nrow(lam_prob_ces45_fd)),rep("C",nrow(geo_prlambda_ces45_fd_twosex)),
                       
                      rep("B",nrow(geo_prlambdaces_85)),rep("A",nrow(lam_prob_ces85_fd)),rep("C",nrow(geo_prlambda_ces85_fd_twosex)) 
                                    )
```



```{r}
Fig_geoPrlambdaces<-ggplot()+
  geom_tile(data = subset(dat_ces_map, model == "A"), aes(x = x, y = y, fill = Prlambda))+
  # facet_grid(model~Time,scales='free_x', space='free_x',labeller = labeller(model = model_names,Time=Time_names)) +
  labs(x = "Longitude", y = "Latitude")+
  scale_fill_gradientn(
    name = expression("Pr " (lambda[F]) > 1),
    colours = terrain.colors(100),
    na.value = "transparent",
     breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  new_scale_fill() +
  geom_tile(data = subset(dat_ces_map, model == "B"), aes(x = x, y = y, fill = Prlambda))+
  # facet_grid(model~Time,scales='free_x', space='free_x',labeller = labeller(model = model_names,Time=Time_names)) +
  labs(x = "Longitude", y = "Latitude")+
  scale_fill_gradientn(
    name = expression("Pr " (lambda[FM]) > 1),
    colours = terrain.colors(100),
    na.value = "transparent",
     breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  new_scale_fill() +
  geom_tile(data = subset(dat_ces_map, model == "C"), aes(x = x, y = y, fill = Prlambda))+
  scale_fill_gradientn(
    name = expression(paste(Delta,"Pr " (lambda[F-FM]))> 1),
    colours = colorspace::diverge_hcl(7),
    na.value = "transparent",
    breaks = seq(-0.5, 0.5, length.out=5),labels=c(-0.5,-0.25,0.00,0.25,0.5),
                           limits=c(-0.5,0.5))+
  facet_grid(model~Time,labeller = labeller(model = model_names,Time=Time_names))+
  theme_light()+
 theme(legend.position = "bottom",
       legend.title = element_text(size = 8),
       legend.text  = element_text(size = 7),
       strip.text.x = element_text(
        size = 10, color = "grey40", face = "bold"
        ),
      strip.text.y = element_text(
        size = 10, color = "grey40", face = "bold"),
      strip.background = element_rect(
     color="black", fill="white", size=0.5, linetype="solid"
     )
        )
```


```{r}
Fig_geoPrlambdaces<-ggarrange(lambda_map_Prpast, lambda_map_Prcurrent, lambda_map_Prces45, lambda_map_Prces85,lambda_map_Prpast_fd, lambda_map_Prcurrent_fd,lambda_map_ces45_fd, lambda_map_ces85_fd,ncol=4,nrow=2,common.legend = TRUE)
ggsave("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/Fig_geoPrlambda_ces.pdf", Fig_geoPrlambdaces,  width = 9, height = 10)
```

### Niche Projection

#### Lambda-temperature posterior sampling to have probability density

##### Two sex models
##### Dormant season

```{r}
data_niche<-cbind(data_past_present_45_85)
```

```{r}
## set up data for past, present, future 
clim_dorm_post<-expand.grid(pptdorm=seq(min(data_niche$zpptdorm),max(data_niche$zpptdorm),length.out=30),tempdorm=seq(min(data_niche$ztempdorm),max(data_niche$ztempdorm),length.out=30))
n_post_draws<-300
post_draws <- sample.int(length(surv_coef$b0_s), n_post_draws)
lambda_dorm_post <-matrix(NA,nrow=n_post_draws,ncol=nrow(clim_dorm_post))
# prob_lambda_dorm_post<-c()
max_yrs<-30

F_params <- M_params <- list()
Timedorm<-system.time(
lambda_dorm_post<-foreach(p=1:n_post_draws,.combine='rbind') %:% 
   foreach(l=1:nrow(clim_dorm_post),.combine='c') %dopar% {
  #set up param vectors
  ## survival
  F_params$surv_mu <- surv_coef$b0_s[post_draws[p]]
  F_params$surv_size <- surv_coef$bsize_s[post_draws[p]]
  F_params$surv_pptgrow <- surv_coef$bpptgrow_s[post_draws[p]] 
  F_params$surv_pptdorm <- surv_coef$bpptdorm_s[post_draws[p]] 
  F_params$surv_tempgrow <- surv_coef$btempgrow_s[post_draws[p]]
  F_params$surv_tempdorm <- surv_coef$btempdorm_s[post_draws[p]] 
  F_params$surv_tempgrow_pptgrow<-surv_coef$btempgrowpptgrow_s[post_draws[p]]
  F_params$surv_tempdorm_pptdorm<-surv_coef$btempdormpptdorm_s[post_draws[p]]
  F_params$surv_pptgrow2<-surv_coef$bpptgrow2_s[post_draws[p]]
  F_params$surv_pptdorm2<-surv_coef$bpptdorm2_s[post_draws[p]]
  F_params$surv_tempgrow2<-surv_coef$btempgrow2_s[post_draws[p]]
  F_params$surv_tempdorm2<-surv_coef$btempdorm2_s[post_draws[p]]
  M_params$surv_mu <- surv_coef$b0_s[post_draws[p]] + surv_coef$bsex_s[post_draws[p]]  
  M_params$surv_size <- surv_coef$bsize_s[post_draws[p]] + surv_coef$bsizesex_s[post_draws[p]]
  M_params$surv_pptgrow <- surv_coef$bpptgrow_s[post_draws[p]]  + surv_coef$bpptgrowsex_s[post_draws[p]] 
  M_params$surv_tempgrow <- surv_coef$btempgrow_s[post_draws[p]] + surv_coef$btempgrowsex_s[post_draws[p]] 
  M_params$surv_pptdorm <- surv_coef$bpptdorm_s[post_draws[p]] + surv_coef$bpptdormsex_s[post_draws[p]] 
  M_params$surv_tempdorm <- surv_coef$btempdorm_s[post_draws[p]] + surv_coef$btempdormsex_s[post_draws[p]]
  M_params$surv_tempgrow_pptgrow<-surv_coef$btempgrowpptgrow_s[post_draws[p]] + surv_coef$btempgrowpptgrowsex_s[post_draws[p]]
  M_params$surv_tempdorm_pptdorm<-surv_coef$btempdormpptdorm_s[post_draws[p]] + surv_coef$btempdormpptdormsex_s[post_draws[p]]
  M_params$surv_pptgrow2<-surv_coef$bpptgrow2_s[post_draws[p]] + surv_coef$bpptgrow2sex_s[post_draws[p]]
  M_params$surv_tempgrow2<-surv_coef$btempgrow2_s[post_draws[p]] + surv_coef$btempgrow2sex_s[post_draws[p]]
  M_params$surv_pptdorm2<-surv_coef$bpptdorm2_s[post_draws[p]] + surv_coef$bpptdorm2sex_s[post_draws[p]]
  M_params$surv_tempdorm2<-surv_coef$btempdorm2_s[post_draws[p]] + surv_coef$btempdorm2sex_s[post_draws[p]]
  ## growth
  F_params$grow_mu <- grow_coef$b0_g[post_draws[p]]
  F_params$grow_size <- grow_coef$bsize_g[post_draws[p]]
  F_params$grow_pptgrow <- grow_coef$bpptgrow_g[post_draws[p]] 
  F_params$grow_pptdorm <- grow_coef$bpptdorm_g[post_draws[p]]
  F_params$grow_tempgrow <- grow_coef$btempgrow_g[post_draws[p]] 
  F_params$grow_tempdorm <- grow_coef$btempdorm_g[post_draws[p]] 
  F_params$grow_tempgrow_pptgrow<-grow_coef$btempgrowpptgrow_g[post_draws[p]]
  F_params$grow_tempdorm_pptdorm<-grow_coef$btempdormpptdorm_g[post_draws[p]] 
  F_params$grow_pptgrow2<-grow_coef$bpptgrow2_g[post_draws[p]]
  F_params$grow_tempgrow2<-grow_coef$btempgrow2_g[post_draws[p]]
  F_params$grow_pptdorm2<-grow_coef$bpptdorm2_g[post_draws[p]] 
  F_params$grow_tempdorm2<-grow_coef$btempdorm2_g[post_draws[p]] 
  F_params$sigma_g <- grow_coef$sigma[post_draws[p]] 
  M_params$grow_mu <- grow_coef$b0_g[post_draws[p]] + grow_coef$bsex_g[post_draws[p]]  
  M_params$grow_size <- grow_coef$bsize_g[post_draws[p]] + grow_coef$bsizesex_g[post_draws[p]]
  M_params$grow_pptgrow <- grow_coef$bpptgrow_g[post_draws[p]]  + grow_coef$bpptgrowsex_g[post_draws[p]] 
  M_params$grow_pptdorm <- grow_coef$bpptdorm_g[post_draws[p]]  + grow_coef$bpptdormsex_g[post_draws[p]] 
  M_params$grow_tempgrow <- grow_coef$btempgrow_g[post_draws[p]] + grow_coef$btempgrowsex_g[post_draws[p]] 
  M_params$grow_tempdorm <- grow_coef$btempdorm_g[post_draws[p]] + grow_coef$btempdormsex_g[post_draws[p]]
  M_params$grow_tempgrow_pptgrow<-grow_coef$btempgrowpptgrow_g[post_draws[p]] + grow_coef$btempgrowpptgrowsex_g[post_draws[p]]
  M_params$grow_tempdorm_pptdorm<-grow_coef$btempdormpptdorm_g[post_draws[p]] + grow_coef$btempdormpptdormsex_g[post_draws[p]]
  M_params$grow_pptgrow2<-grow_coef$bpptgrow2_g[post_draws[p]] + grow_coef$bpptgrow2sex_g[post_draws[p]]
  M_params$grow_tempgrow2<-grow_coef$btempgrow2_g[post_draws[p]] + grow_coef$btempgrow2sex_g[post_draws[p]]
  M_params$grow_pptdorm2<-grow_coef$bpptdorm2_g[post_draws[p]] + grow_coef$bpptdorm2sex_g[post_draws[p]]
  M_params$grow_tempdorm2<-grow_coef$btempdorm2_g[post_draws[p]] + grow_coef$btempdorm2sex_g[post_draws[p]]
  M_params$sigma_g <- grow_coef$sigma[post_draws[p]] 
  ## flowering
  F_params$flow_mu <- flow_coef$b0_f[post_draws[p]]
  F_params$flow_size <- flow_coef$bsize_f[post_draws[p]]
  F_params$flow_pptgrow <- flow_coef$bpptgrow_f[post_draws[p]] 
  F_params$flow_tempgrow <- flow_coef$btempgrow_f[post_draws[p]] 
  F_params$flow_tempdorm <- flow_coef$btempdorm_f[post_draws[p]] 
  F_params$flow_pptdorm <- flow_coef$bpptdorm_f[post_draws[p]]
  F_params$flow_tempgrow_pptgrow<-flow_coef$btempgrowpptgrow_f[post_draws[p]]
  F_params$flow_tempdorm_pptdorm<-flow_coef$btempdormpptdorm_f[post_draws[p]]
  F_params$flow_pptgrow2<-flow_coef$bpptgrow2_f[post_draws[p]]
  F_params$flow_pptdorm2<-flow_coef$bpptdorm2_f[post_draws[p]]
  F_params$flow_tempgrow2<-flow_coef$btempgrow2_f[post_draws[p]]
  F_params$flow_tempdorm2<-flow_coef$btempdorm2_f[post_draws[p]]
  M_params$flow_mu <- flow_coef$b0_f[post_draws[p]] + flow_coef$bsex_f[post_draws[p]]  
  M_params$flow_size <- flow_coef$bsize_f[post_draws[p]] + flow_coef$bsizesex_f[post_draws[p]]
  M_params$flow_pptgrow <- flow_coef$bpptgrow_f[post_draws[p]]  + flow_coef$bpptgrowsex_f[post_draws[p]] 
  M_params$flow_tempgrow <- flow_coef$btempgrow_f[post_draws[p]] + flow_coef$btempgrowsex_f[post_draws[p]]
  M_params$flow_tempdorm <- flow_coef$btempdorm_f[post_draws[p]] +  flow_coef$btempdormsex_f[post_draws[p]]  
  M_params$flow_pptdorm <- flow_coef$bpptdorm_f[post_draws[p]] + flow_coef$bpptdormsex_f[post_draws[p]] 
  M_params$flow_tempgrow_pptgrow<-flow_coef$btempgrowpptgrow_f[post_draws[p]] + flow_coef$btempgrowpptgrowsex_f[post_draws[p]]
  M_params$flow_tempdorm_pptdorm<-flow_coef$btempdormpptdorm_f[post_draws[p]] + flow_coef$btempdormpptdormsex_f[post_draws[p]]
  M_params$flow_pptgrow2<-flow_coef$bpptgrow2_f[post_draws[p]] + flow_coef$bpptgrow2sex_f[post_draws[p]]
  M_params$flow_tempgrow2<-flow_coef$btempgrow2_f[post_draws[p]] + flow_coef$btempgrow2sex_f[post_draws[p]]
  M_params$flow_pptdorm2<-flow_coef$bpptdorm2_f[post_draws[p]] +  flow_coef$bpptdorm2sex_f[post_draws[p]]
  M_params$flow_tempdorm2<-flow_coef$btempdorm2_f[post_draws[p]] + flow_coef$btempdorm2sex_f[post_draws[p]]
  ## panicles
  F_params$panic_mu <- panic_coef$b0_p[post_draws[p]]
  F_params$panic_size <- panic_coef$bsize_p[post_draws[p]]
  F_params$panic_pptgrow <- panic_coef$bpptgrow_p[post_draws[p]] 
  F_params$panic_tempgrow <- panic_coef$btempgrow_p[post_draws[p]] 
  F_params$panic_tempdorm <- panic_coef$btempdorm_p[post_draws[p]] 
  F_params$panic_pptdorm <- panic_coef$bpptdorm_p[post_draws[p]]
  F_params$panic_tempgrow_pptgrow<-panic_coef$btempgrowpptgrow_p[post_draws[p]]
  F_params$panic_tempdorm_pptdorm<-panic_coef$btempdormpptdorm_p[post_draws[p]]
  F_params$panic_pptgrow2<-panic_coef$bpptgrow2_p[post_draws[p]]
  F_params$panic_tempgrow2<-panic_coef$btempgrow2_p[post_draws[p]]
  F_params$panic_pptdorm2<-panic_coef$bpptdorm2_p[post_draws[p]]
  F_params$panic_tempdorm2<-panic_coef$btempdorm2_p[post_draws[p]]
  M_params$panic_mu <- panic_coef$b0_p[post_draws[p]] + panic_coef$bsex_p[post_draws[p]]  
  M_params$panic_size <- panic_coef$bsize_p[post_draws[p]] + panic_coef$bsizesex_p[post_draws[p]]
  M_params$panic_pptgrow <- panic_coef$bpptgrow_p[post_draws[p]]  + panic_coef$bpptgrowsex_p[post_draws[p]] 
  M_params$panic_tempgrow <- panic_coef$btempgrow_p[post_draws[p]] + panic_coef$btempgrowsex_p[post_draws[p]]
  M_params$panic_tempdorm <- panic_coef$btempdorm_p[post_draws[p]] +  panic_coef$btempdormsex_p[post_draws[p]]  
  M_params$panic_pptdorm <- panic_coef$bpptdorm_p[post_draws[p]] + panic_coef$bpptdormsex_p[post_draws[p]] 
  M_params$panic_tempgrow_pptgrow<-panic_coef$btempgrowpptgrow_p[post_draws[p]] + panic_coef$btempgrowpptgrowsex_p[post_draws[p]]
  M_params$panic_tempdorm_pptdorm<-panic_coef$btempdormpptdorm_p[post_draws[p]] + panic_coef$btempdormpptdormsex_p[post_draws[p]]
  M_params$panic_pptgrow2<-panic_coef$bpptgrow2_p[post_draws[p]] + panic_coef$bpptgrow2sex_p[post_draws[p]]
  M_params$panic_tempgrow2<-panic_coef$btempgrow2_p[post_draws[p]] + panic_coef$btempgrow2sex_p[post_draws[p]]
  M_params$panic_pptdorm2<-panic_coef$bpptdorm2_p[post_draws[p]] + panic_coef$bpptdorm2sex_p[post_draws[p]]
  M_params$panic_tempdorm2<-panic_coef$btempdorm2_p[post_draws[p]] + panic_coef$btempdorm2sex_p[post_draws[p]]
  ## seed viability and misc fertility params
  F_params$v0 <- via_coef$v0[post_draws[p]] 
  F_params$a_v <- via_coef$a_v[post_draws[p]] 
  F_params$ov_per_inf <- via_coef$lambda_d[post_draws[p]] 
  F_params$germ <- via_coef$m[post_draws[p]] 
  F_params$PSR <- 0.5
  ## use POAU seedling survival for females and males
  F_params$sdlg_surv <- M_params$sdlg_surv <- sdlg_surv$sdlg_surv
  ## set max size equal between the sexes
  F_params$max_size <- M_params$max_size <- round(quantile(na.omit((poar.clim_seasonal$tillerN_t1)),probs=0.95))
  ## pull out the rfx variances
  rfx <- rfx_fun(site_tau_s = surv_coef$site_tau_s[post_draws[p]],
                block_tau_s = surv_coef$block_tau_s[post_draws[p]],
                source_tau_s = surv_coef$source_tau_s[post_draws[p]],
                site_tau_g = grow_coef$site_tau_g[post_draws[p]],
                block_tau_g = grow_coef$block_tau_g[post_draws[p]],
                source_tau_g = grow_coef$source_tau_g[post_draws[p]],
                site_tau_f = flow_coef$site_tau_f[post_draws[p]],
                block_tau_f = flow_coef$block_tau_f[post_draws[p]],
                source_tau_f = flow_coef$source_tau_f[post_draws[p]],
                site_tau_p = panic_coef$site_tau_p[post_draws[p]],
                block_tau_p = panic_coef$block_tau_p[post_draws[p]],
                source_tau_p = panic_coef$source_tau_p[post_draws[p]])
   #Estimation+process error
    lambdaSim_delay(F_params=F_params,
                                 M_params=M_params,
                                 grow_perturb=0,
                                 surv_perturb=0,
                                 flow_perturb=0,
                                 fert_perturb=0,
                                 viab_perturb=0,
                                 zpptgrow=0,
                                 ztempgrow=0,
                                 zpptdorm=clim_dorm_post[l,1],
                                 ztempdorm=clim_dorm_post[l,2],
                                 rfx = rfx_fun(),
                                 max.yrs = max_yrs)$lambdatracker[max_yrs]
   # mean(lambda_dorm_post[,l]>1,na.rm=T)
        
 }
)

## write output as a dataframe
data_dormant_niche<-data.frame(lambda_dorm_post)

# write_rds(data_dormant_niche,"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/data_dormant_niche.rds")
# write_csv(data_dormant_niche,"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/data_dormant_niche.csv")
```

```{r}
nichedormant<-readRDS(url("https://www.dropbox.com/scl/fi/ejueiyu58g96eqlb60js4/data_dormant_niche.rds?rlkey=8xjqn6reelmqtcbzm1na61g2m&dl=1"))
fixr::check_for_negative_values(nichedormant)
nichedormant[127,884]
prob_lambda_dorm_post<-c()
for(l in 1:ncol(nichedormant)){
  prob_lambda_dorm_post[l]<-mean(nichedormant[,l]>1,na.rm=T)
}

all_pptdorm_seq<-seq(min(data_niche$zpptdorm*sd(poar_2015_2016$pptdorm)+mean(poar_2015_2016$pptdorm)),max(data_niche$zpptdorm*sd(poar_2015_2016$pptdorm)+mean(poar_2015_2016$pptdorm)),length.out=30)
all_tempdorm_seq<-seq(min(data_niche$ztempdorm*sd(poar_2015_2016$tempdorm)+mean(poar_2015_2016$tempdorm)),max(data_niche$ztempdorm*sd(poar_2015_2016$tempdorm)+mean(poar_2015_2016$tempdorm)),length.out=30)

mtrx_dorm <- matrix(prob_lambda_dorm_post, nrow = 30, dimnames = list(all_pptdorm_seq,
               all_tempdorm_seq))
```

##### Growing season

```{r}
## set up data for past, present, future 
clim_grow_post<-expand.grid(pptgrow=seq(min(data_niche$zpptgrow),max(data_niche$zpptgrow),length.out=30),tempgrow=seq(min(data_niche$ztempgrow),max(data_niche$ztempgrow),length.out=30))
n_post_draws<-300
post_draws <- sample.int(length(surv_coef$b0_s), n_post_draws)
lambda_grow_post <-matrix(NA,nrow=n_post_draws,ncol=nrow(clim_grow_post))
# dim(lambda_grow_post)
# prob_lambda_dorm_post<-c()
max_yrs<-30
F_params <- M_params <- list()
Timegrow<-system.time(
lambda_grow_post<-foreach(p=1:n_post_draws,.combine='rbind') %:% 
   foreach(l=1:nrow(clim_grow_post),.combine='c') %dopar% {
  #set up param vectors
  ## survival
  F_params$surv_mu <- surv_coef$b0_s[post_draws[p]]
  F_params$surv_size <- surv_coef$bsize_s[post_draws[p]]
  F_params$surv_pptgrow <- surv_coef$bpptgrow_s[post_draws[p]] 
  F_params$surv_pptdorm <- surv_coef$bpptdorm_s[post_draws[p]] 
  F_params$surv_tempgrow <- surv_coef$btempgrow_s[post_draws[p]]
  F_params$surv_tempdorm <- surv_coef$btempdorm_s[post_draws[p]] 
  F_params$surv_tempgrow_pptgrow<-surv_coef$btempgrowpptgrow_s[post_draws[p]]
  F_params$surv_tempdorm_pptdorm<-surv_coef$btempdormpptdorm_s[post_draws[p]]
  F_params$surv_pptgrow2<-surv_coef$bpptgrow2_s[post_draws[p]]
  F_params$surv_pptdorm2<-surv_coef$bpptdorm2_s[post_draws[p]]
  F_params$surv_tempgrow2<-surv_coef$btempgrow2_s[post_draws[p]]
  F_params$surv_tempdorm2<-surv_coef$btempdorm2_s[post_draws[p]]
  M_params$surv_mu <- surv_coef$b0_s[post_draws[p]] + surv_coef$bsex_s[post_draws[p]]  
  M_params$surv_size <- surv_coef$bsize_s[post_draws[p]] + surv_coef$bsizesex_s[post_draws[p]]
  M_params$surv_pptgrow <- surv_coef$bpptgrow_s[post_draws[p]]  + surv_coef$bpptgrowsex_s[post_draws[p]] 
  M_params$surv_tempgrow <- surv_coef$btempgrow_s[post_draws[p]] + surv_coef$btempgrowsex_s[post_draws[p]] 
  M_params$surv_pptdorm <- surv_coef$bpptdorm_s[post_draws[p]] + surv_coef$bpptdormsex_s[post_draws[p]] 
  M_params$surv_tempdorm <- surv_coef$btempdorm_s[post_draws[p]] + surv_coef$btempdormsex_s[post_draws[p]]
  M_params$surv_tempgrow_pptgrow<-surv_coef$btempgrowpptgrow_s[post_draws[p]] + surv_coef$btempgrowpptgrowsex_s[post_draws[p]]
  M_params$surv_tempdorm_pptdorm<-surv_coef$btempdormpptdorm_s[post_draws[p]] + surv_coef$btempdormpptdormsex_s[post_draws[p]]
  M_params$surv_pptgrow2<-surv_coef$bpptgrow2_s[post_draws[p]] + surv_coef$bpptgrow2sex_s[post_draws[p]]
  M_params$surv_tempgrow2<-surv_coef$btempgrow2_s[post_draws[p]] + surv_coef$btempgrow2sex_s[post_draws[p]]
  M_params$surv_pptdorm2<-surv_coef$bpptdorm2_s[post_draws[p]] + surv_coef$bpptdorm2sex_s[post_draws[p]]
  M_params$surv_tempdorm2<-surv_coef$btempdorm2_s[post_draws[p]] + surv_coef$btempdorm2sex_s[post_draws[p]]
  ## growth
  F_params$grow_mu <- grow_coef$b0_g[post_draws[p]]
  F_params$grow_size <- grow_coef$bsize_g[post_draws[p]]
  F_params$grow_pptgrow <- grow_coef$bpptgrow_g[post_draws[p]] 
  F_params$grow_pptdorm <- grow_coef$bpptdorm_g[post_draws[p]]
  F_params$grow_tempgrow <- grow_coef$btempgrow_g[post_draws[p]] 
  F_params$grow_tempdorm <- grow_coef$btempdorm_g[post_draws[p]] 
  F_params$grow_tempgrow_pptgrow<-grow_coef$btempgrowpptgrow_g[post_draws[p]]
  F_params$grow_tempdorm_pptdorm<-grow_coef$btempdormpptdorm_g[post_draws[p]] 
  F_params$grow_pptgrow2<-grow_coef$bpptgrow2_g[post_draws[p]]
  F_params$grow_tempgrow2<-grow_coef$btempgrow2_g[post_draws[p]]
  F_params$grow_pptdorm2<-grow_coef$bpptdorm2_g[post_draws[p]] 
  F_params$grow_tempdorm2<-grow_coef$btempdorm2_g[post_draws[p]] 
  F_params$sigma_g <- grow_coef$sigma[post_draws[p]] 
  M_params$grow_mu <- grow_coef$b0_g[post_draws[p]] + grow_coef$bsex_g[post_draws[p]]  
  M_params$grow_size <- grow_coef$bsize_g[post_draws[p]] + grow_coef$bsizesex_g[post_draws[p]]
  M_params$grow_pptgrow <- grow_coef$bpptgrow_g[post_draws[p]]  + grow_coef$bpptgrowsex_g[post_draws[p]] 
  M_params$grow_pptdorm <- grow_coef$bpptdorm_g[post_draws[p]]  + grow_coef$bpptdormsex_g[post_draws[p]] 
  M_params$grow_tempgrow <- grow_coef$btempgrow_g[post_draws[p]] + grow_coef$btempgrowsex_g[post_draws[p]] 
  M_params$grow_tempdorm <- grow_coef$btempdorm_g[post_draws[p]] + grow_coef$btempdormsex_g[post_draws[p]]
  M_params$grow_tempgrow_pptgrow<-grow_coef$btempgrowpptgrow_g[post_draws[p]] + grow_coef$btempgrowpptgrowsex_g[post_draws[p]]
  M_params$grow_tempdorm_pptdorm<-grow_coef$btempdormpptdorm_g[post_draws[p]] + grow_coef$btempdormpptdormsex_g[post_draws[p]]
  M_params$grow_pptgrow2<-grow_coef$bpptgrow2_g[post_draws[p]] + grow_coef$bpptgrow2sex_g[post_draws[p]]
  M_params$grow_tempgrow2<-grow_coef$btempgrow2_g[post_draws[p]] + grow_coef$btempgrow2sex_g[post_draws[p]]
  M_params$grow_pptdorm2<-grow_coef$bpptdorm2_g[post_draws[p]] + grow_coef$bpptdorm2sex_g[post_draws[p]]
  M_params$grow_tempdorm2<-grow_coef$btempdorm2_g[post_draws[p]] + grow_coef$btempdorm2sex_g[post_draws[p]]
  M_params$sigma_g <- grow_coef$sigma[post_draws[p]] 
  ## flowering
  F_params$flow_mu <- flow_coef$b0_f[post_draws[p]]
  F_params$flow_size <- flow_coef$bsize_f[post_draws[p]]
  F_params$flow_pptgrow <- flow_coef$bpptgrow_f[post_draws[p]] 
  F_params$flow_tempgrow <- flow_coef$btempgrow_f[post_draws[p]] 
  F_params$flow_tempdorm <- flow_coef$btempdorm_f[post_draws[p]] 
  F_params$flow_pptdorm <- flow_coef$bpptdorm_f[post_draws[p]]
  F_params$flow_tempgrow_pptgrow<-flow_coef$btempgrowpptgrow_f[post_draws[p]]
  F_params$flow_tempdorm_pptdorm<-flow_coef$btempdormpptdorm_f[post_draws[p]]
  F_params$flow_pptgrow2<-flow_coef$bpptgrow2_f[post_draws[p]]
  F_params$flow_pptdorm2<-flow_coef$bpptdorm2_f[post_draws[p]]
  F_params$flow_tempgrow2<-flow_coef$btempgrow2_f[post_draws[p]]
  F_params$flow_tempdorm2<-flow_coef$btempdorm2_f[post_draws[p]]
  M_params$flow_mu <- flow_coef$b0_f[post_draws[p]] + flow_coef$bsex_f[post_draws[p]]  
  M_params$flow_size <- flow_coef$bsize_f[post_draws[p]] + flow_coef$bsizesex_f[post_draws[p]]
  M_params$flow_pptgrow <- flow_coef$bpptgrow_f[post_draws[p]]  + flow_coef$bpptgrowsex_f[post_draws[p]] 
  M_params$flow_tempgrow <- flow_coef$btempgrow_f[post_draws[p]] + flow_coef$btempgrowsex_f[post_draws[p]]
  M_params$flow_tempdorm <- flow_coef$btempdorm_f[post_draws[p]] +  flow_coef$btempdormsex_f[post_draws[p]]  
  M_params$flow_pptdorm <- flow_coef$bpptdorm_f[post_draws[p]] + flow_coef$bpptdormsex_f[post_draws[p]] 
  M_params$flow_tempgrow_pptgrow<-flow_coef$btempgrowpptgrow_f[post_draws[p]] + flow_coef$btempgrowpptgrowsex_f[post_draws[p]]
  M_params$flow_tempdorm_pptdorm<-flow_coef$btempdormpptdorm_f[post_draws[p]] + flow_coef$btempdormpptdormsex_f[post_draws[p]]
  M_params$flow_pptgrow2<-flow_coef$bpptgrow2_f[post_draws[p]] + flow_coef$bpptgrow2sex_f[post_draws[p]]
  M_params$flow_tempgrow2<-flow_coef$btempgrow2_f[post_draws[p]] + flow_coef$btempgrow2sex_f[post_draws[p]]
  M_params$flow_pptdorm2<-flow_coef$bpptdorm2_f[post_draws[p]] +  flow_coef$bpptdorm2sex_f[post_draws[p]]
  M_params$flow_tempdorm2<-flow_coef$btempdorm2_f[post_draws[p]] + flow_coef$btempdorm2sex_f[post_draws[p]]
  ## panicles
  F_params$panic_mu <- panic_coef$b0_p[post_draws[p]]
  F_params$panic_size <- panic_coef$bsize_p[post_draws[p]]
  F_params$panic_pptgrow <- panic_coef$bpptgrow_p[post_draws[p]] 
  F_params$panic_tempgrow <- panic_coef$btempgrow_p[post_draws[p]] 
  F_params$panic_tempdorm <- panic_coef$btempdorm_p[post_draws[p]] 
  F_params$panic_pptdorm <- panic_coef$bpptdorm_p[post_draws[p]]
  F_params$panic_tempgrow_pptgrow<-panic_coef$btempgrowpptgrow_p[post_draws[p]]
  F_params$panic_tempdorm_pptdorm<-panic_coef$btempdormpptdorm_p[post_draws[p]]
  F_params$panic_pptgrow2<-panic_coef$bpptgrow2_p[post_draws[p]]
  F_params$panic_tempgrow2<-panic_coef$btempgrow2_p[post_draws[p]]
  F_params$panic_pptdorm2<-panic_coef$bpptdorm2_p[post_draws[p]]
  F_params$panic_tempdorm2<-panic_coef$btempdorm2_p[post_draws[p]]
  M_params$panic_mu <- panic_coef$b0_p[post_draws[p]] + panic_coef$bsex_p[post_draws[p]]  
  M_params$panic_size <- panic_coef$bsize_p[post_draws[p]] + panic_coef$bsizesex_p[post_draws[p]]
  M_params$panic_pptgrow <- panic_coef$bpptgrow_p[post_draws[p]]  + panic_coef$bpptgrowsex_p[post_draws[p]] 
  M_params$panic_tempgrow <- panic_coef$btempgrow_p[post_draws[p]] + panic_coef$btempgrowsex_p[post_draws[p]]
  M_params$panic_tempdorm <- panic_coef$btempdorm_p[post_draws[p]] +  panic_coef$btempdormsex_p[post_draws[p]]  
  M_params$panic_pptdorm <- panic_coef$bpptdorm_p[post_draws[p]] + panic_coef$bpptdormsex_p[post_draws[p]] 
  M_params$panic_tempgrow_pptgrow<-panic_coef$btempgrowpptgrow_p[post_draws[p]] + panic_coef$btempgrowpptgrowsex_p[post_draws[p]]
  M_params$panic_tempdorm_pptdorm<-panic_coef$btempdormpptdorm_p[post_draws[p]] + panic_coef$btempdormpptdormsex_p[post_draws[p]]
  M_params$panic_pptgrow2<-panic_coef$bpptgrow2_p[post_draws[p]] + panic_coef$bpptgrow2sex_p[post_draws[p]]
  M_params$panic_tempgrow2<-panic_coef$btempgrow2_p[post_draws[p]] + panic_coef$btempgrow2sex_p[post_draws[p]]
  M_params$panic_pptdorm2<-panic_coef$bpptdorm2_p[post_draws[p]] + panic_coef$bpptdorm2sex_p[post_draws[p]]
  M_params$panic_tempdorm2<-panic_coef$btempdorm2_p[post_draws[p]] + panic_coef$btempdorm2sex_p[post_draws[p]]
  ## seed viability and misc fertility params
  F_params$v0 <- via_coef$v0[post_draws[p]] 
  F_params$a_v <- via_coef$a_v[post_draws[p]] 
  F_params$ov_per_inf <- via_coef$lambda_d[post_draws[p]] 
  F_params$germ <- via_coef$m[post_draws[p]] 
  F_params$PSR <- 0.5
  ## use POAU seedling survival for females and males
  F_params$sdlg_surv <- M_params$sdlg_surv <- sdlg_surv$sdlg_surv
  ## set max size equal between the sexes
  F_params$max_size <- M_params$max_size <- round(quantile(na.omit((poar.clim_seasonal$tillerN_t1)),probs=0.95))
  ## pull out the rfx variances
  rfx <- rfx_fun(site_tau_s = surv_coef$site_tau_s[post_draws[p]],
                block_tau_s = surv_coef$block_tau_s[post_draws[p]],
                source_tau_s = surv_coef$source_tau_s[post_draws[p]],
                site_tau_g = grow_coef$site_tau_g[post_draws[p]],
                block_tau_g = grow_coef$block_tau_g[post_draws[p]],
                source_tau_g = grow_coef$source_tau_g[post_draws[p]],
                site_tau_f = flow_coef$site_tau_f[post_draws[p]],
                block_tau_f = flow_coef$block_tau_f[post_draws[p]],
                source_tau_f = flow_coef$source_tau_f[post_draws[p]],
                site_tau_p = panic_coef$site_tau_p[post_draws[p]],
                block_tau_p = panic_coef$block_tau_p[post_draws[p]],
                source_tau_p = panic_coef$source_tau_p[post_draws[p]])
   lambdaSim_delay(F_params=F_params,
                                 M_params=M_params,
                                 grow_perturb=0,
                                 surv_perturb=0,
                                 flow_perturb=0,
                                 fert_perturb=0,
                                 viab_perturb=0,
                                 zpptgrow=clim_grow_post[l,1],
                                 ztempgrow=clim_grow_post[l,2],
                                 zpptdorm=0,
                                 ztempdorm=0,
                                 rfx = rfx_fun(),
                                 max.yrs = max_yrs)$lambdatracker[max_yrs]
   # mean(lambda_grow_post[,l]>1,na.rm=T)
        
 }
)

data_growing_niche<-data.frame(lambda_grow_post)
## write output as a rds and csv and rds
# write_rds(data_growing_niche,"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/data_growing_niche.rds")
# write_csv(data_growing_niche,"/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/data_growing_niche.csv")

```

```{r}
# read in results of the above loop
nichegrowing <- readRDS(url("https://www.dropbox.com/scl/fi/ggxrqzgz2wwmo1mec2d5m/data_growing_niche.rds?rlkey=6uv4l0e2ajovdit7gt778aexw&dl=1"))
# fixr::check_for_negative_values(nichegrowing)
summary(nichegrowing)
prob_lambda_grow_post<-c()
for(l in 1:ncol(nichegrowing)){
  prob_lambda_grow_post[l]<-mean(nichegrowing[,l]>1,na.rm=T)
}

all_pptgrow_seq<-seq(min(data_niche$zpptgrow*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow)),max(data_niche$zpptgrow*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow)),length.out=30)
all_tempgrow_seq<-seq(min(data_niche$ztempgrow*sd(poar_2015_2016$tempgrow)+mean(poar_2015_2016$tempgrow)),max(data_niche$ztempgrow*sd(poar_2015_2016$tempgrow)+mean(poar_2015_2016$tempgrow)),length.out=30)

mtrx_grow <- matrix(prob_lambda_grow_post, nrow = 30, dimnames = list(all_pptgrow_seq,
               all_tempgrow_seq))

```


```{r}
library(RColorBrewer)
x_current_d<-clim_current$pptdorm
y_current_d<-clim_current$tempdorm
x_past_d<-clim_past$pptdorm
y_past_d<-clim_past$tempdorm
x_miroc45_d<-clim_miroc45$pptdorm
y_miroc45_d<-clim_miroc45$tempdorm
x_miroc85_d<-clim_miroc85$pptdorm
y_miroc85_d<-clim_miroc85$tempdorm

x_current_g<-clim_current$pptgrow
y_current_g<-clim_current$tempgrow
x_past_g<-clim_past$pptgrow
y_past_g<-clim_past$tempgrow
x_miroc45_g<-clim_miroc45$pptgrow
y_miroc45_g<-clim_miroc45$tempgrow
x_miroc85_g<-clim_miroc85$pptgrow
y_miroc85_g<-clim_miroc85$tempgrow

```

#### Female dominant models

```{r}
nichedormant_fd<-readRDS(url("https://www.dropbox.com/scl/fi/u0yeohxrienfp96hopvl5/data_dormant_niche.rds?rlkey=lhum5y9ymqtpkegkw75seruuc&dl=1"))
prob_lambda_dorm_post_fd<-c()
for(l in 1:ncol(nichedormant_fd)){
  prob_lambda_dorm_post_fd[l]<-mean(nichedormant_fd[,l]>1,na.rm=T)
}

all_pptdorm_seq<-seq(min(data_niche$zpptdorm*sd(poar_2015_2016$pptdorm)+mean(poar_2015_2016$pptdorm)),max(data_niche$zpptdorm*sd(poar_2015_2016$pptdorm)+mean(poar_2015_2016$pptdorm)),length.out=30)
all_tempdorm_seq<-seq(min(data_niche$ztempdorm*sd(poar_2015_2016$tempdorm)+mean(poar_2015_2016$tempdorm)),max(data_niche$ztempdorm*sd(poar_2015_2016$tempdorm)+mean(poar_2015_2016$tempdorm)),length.out=30)

mtrx_dorm_fd <- matrix(prob_lambda_dorm_post_fd, nrow = 30, dimnames = list(all_pptdorm_seq,
               all_tempdorm_seq))
```

```{r}
# read in results of the above loop
nichegrowing_fd <- readRDS(url("https://www.dropbox.com/scl/fi/xgi4mzlgwrw1k73n6sdkw/data_growing_niche.rds?rlkey=7gw2nh7mw67ind2dhs9mbfszy&dl=1"))
prob_lambda_grow_post_fd<-c()
for(l in 1:ncol(nichegrowing_fd)){
  prob_lambda_grow_post_fd[l]<-mean(nichegrowing_fd[,l]>1,na.rm=T)
}

all_pptgrow_seq<-seq(min(data_niche$zpptgrow*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow)),max(data_niche$zpptgrow*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow)),length.out=30)
all_tempgrow_seq<-seq(min(data_niche$ztempgrow*sd(poar_2015_2016$tempgrow)+mean(poar_2015_2016$tempgrow)),max(data_niche$ztempgrow*sd(poar_2015_2016$tempgrow)+mean(poar_2015_2016$tempgrow)),length.out=30)

mtrx_grow_fd <- matrix(prob_lambda_grow_post_fd, nrow = 30, dimnames = list(all_pptgrow_seq,
               all_tempgrow_seq))

```

```{r}
library(RColorBrewer)
x_current_d<-clim_current$pptdorm
y_current_d<-clim_current$tempdorm
x_past_d<-clim_past$pptdorm
y_past_d<-clim_past$tempdorm
x_miroc45_d<-clim_miroc45$pptdorm
y_miroc45_d<-clim_miroc45$tempdorm
x_miroc85_d<-clim_miroc85$pptdorm
y_miroc85_d<-clim_miroc85$tempdorm

x_current_g<-clim_current$pptgrow
y_current_g<-clim_current$tempgrow
x_past_g<-clim_past$pptgrow
y_past_g<-clim_past$tempgrow
x_miroc45_g<-clim_miroc45$pptgrow
y_miroc45_g<-clim_miroc45$tempgrow
x_miroc85_g<-clim_miroc85$pptgrow
y_miroc85_g<-clim_miroc85$tempgrow

scal_breaks <- c(seq(0, 1, length.out = 101))
scal_breaks_diff <- c(seq(-0.2, 0.80, length.out = 101))
scal_breaks_diff_dorm <- c(seq(-0.05, 0.30, length.out = 101))
```



```{r}
niche_diff_dormant<-prob_lambda_dorm_post_fd-prob_lambda_dorm_post
summary(niche_diff_dormant)
mtrx_diff_dorm <- matrix(niche_diff_dormant, nrow = 30, dimnames = list(all_pptdorm_seq,
               all_tempdorm_seq))
```


```{r}
niche_diff_grow<-prob_lambda_grow_post_fd-prob_lambda_grow_post
summary(niche_diff_grow)
mtrx_diff_grow<- matrix(niche_diff_grow, nrow = 30, dimnames = list(all_pptgrow_seq,
               all_tempgrow_seq))
```




```{r}
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/niche_dormant_growing_ESA.pdf",width=8,height=10,useDingbats = F)
par(mar=c(5,5,2,0.5),mfrow=c(3,2))
fields::image.plot(all_pptdorm_seq,all_tempdorm_seq,mtrx_dorm_fd,col=topo.colors(100),xlab="Precipitation (dorm. season)",ylab="Temperature (dorm. season)",main="",breaks = scal_breaks,cex.lab=1.6) 
contour(all_pptdorm_seq,all_tempdorm_seq,mtrx_dorm_fd,add=T,labcex=0.75,col="black") 
# mtext(~ bolditalic ("Female-dominant model (F)"),side = 3, adj = 0.5,cex=1.2)
# text(x=x_current_d,y=y_current_d,"+",col="black",cex=1.5)
# text(x=x_past_d,y=y_past_d,"o",col="black")
# text(x=x_miroc45_d,y=y_miroc45_d,"*",col="black",cex=2)
# text(x=x_miroc85_d,y=y_miroc85_d,".",col="black",cex=4.5)
fields::image.plot(all_pptgrow_seq,all_tempgrow_seq,mtrx_grow_fd,col=topo.colors(100),xlab="Precipitation (grow. season)",ylab="Temperature (grow. season)",main="",breaks = scal_breaks,cex.lab=1.6) 
contour(all_pptgrow_seq,all_tempgrow_seq,mtrx_grow_fd,add=T,labcex=0.75,col="black") 
# mtext(~ bolditalic ("Female-dominant model (F)"),side = 3, adj = 0.5,cex=1.2)
# title(main="A" ,adj=0,cex.main=1.4,font=1)
# text(x=x_current_g,y=y_current_g,"+",col="black",cex=1.5)
# text(x=x_past_g,y=y_past_g,"o",col="black")
# text(x=x_miroc45_g,y=y_miroc45_g,"*",col="black",cex=2)
# text(x=x_miroc85_g,y=y_miroc85_g,".",col="black",cex=4.5)
fields::image.plot(all_pptdorm_seq,all_tempdorm_seq,mtrx_dorm,col=topo.colors(100),xlab="Precipitation (dorm. season)",ylab="Temperature (dorm. season)",main="",breaks =scal_breaks ,cex.lab=1.6) 
contour(all_pptdorm_seq,all_tempdorm_seq,mtrx_dorm,add=T,labcex=0.75,col="black") 
# mtext(~ bolditalic (" Two-sex model (FM)"),side = 3, adj = 0.5,cex=1.2)
# text(x=x_current_d,y=y_current_d,"+",col="black",cex=1.5)
# text(x=x_past_d,y=y_past_d,"o",col="black")
# text(x=x_miroc45_d,y=y_miroc45_d,"*",col="black",cex=2)
# text(x=x_miroc85_d,y=y_miroc85_d,".",col="black",cex=4.5)
fields::image.plot(all_pptgrow_seq,all_tempgrow_seq,mtrx_grow,col=topo.colors(100),xlab="Precipitation (grow. season)",ylab="Temperature (grow. season)",main="",breaks = scal_breaks,cex.lab=1.6) 
contour(all_pptgrow_seq,all_tempgrow_seq,mtrx_grow,add=T,labcex=0.75,col="black") 
# mtext(~ bolditalic (" Two-sex model (FM)"),side = 3, adj = 0.5,cex=1.2)
# title(main="B" ,adj=0,cex.main=1.4,font=1)
# text(x=x_current_g,y=y_current_g,"+",col="black",cex=1.5)
# text(x=x_past_g,y=y_past_g,"o",col="black")
# text(x=x_miroc45_g,y=y_miroc45_g,"*",col="black",cex=2)
# text(x=x_miroc85_g,y=y_miroc85_g,".",col="black",cex=4.5)
fields::image.plot(all_pptdorm_seq,all_tempdorm_seq,mtrx_diff_dorm,col=colorspace::diverge_hcl(100),xlab="Precipitation (dorm. season)",ylab="Temperature (dorm. season)",main="" ,breaks = scal_breaks_diff_dorm,cex.lab=1.6) 
contour(all_pptdorm_seq,all_tempdorm_seq,mtrx_diff_dorm,add=T,labcex=0.75,col="black") 
# mtext(~ bolditalic (" F - FM "),side = 3, adj = 0.5,cex=1.2)
# text(x=x_current_d,y=y_current_d,"+",col="black",cex=1.5)
# text(x=x_past_d,y=y_past_d,"o",col="black")
# text(x=x_miroc45_d,y=y_miroc45_d,"*",col="black",cex=2)
# text(x=x_miroc85_d,y=y_miroc85_d,".",col="black",cex=4.5)
fields::image.plot(all_pptgrow_seq,all_tempgrow_seq,mtrx_diff_grow,col=colorspace::diverge_hcl(100),xlab="Precipitation (grow. season)",ylab="Temperature (grow. season)",main="",breaks = scal_breaks_diff,cex.lab=1.6) 
contour(all_pptgrow_seq,all_tempgrow_seq,mtrx_diff_grow,add=T,labcex=0.75,col="black") 
# mtext(~ bolditalic ("F - FM"),side = 3, adj = 0.5,cex=1.2)
# title(main="B" ,adj=0,cex.main=1.4,font=1)
# text(x=x_current_g,y=y_current_g,"+",col="black",cex=1.5)
# text(x=x_past_g,y=y_past_g,"o",col="black")
# text(x=x_miroc45_g,y=y_miroc45_g,"*",col="black",cex=2)
# text(x=x_miroc85_g,y=y_miroc85_g,".",col="black",cex=4.5)

dev.off()
```

```{r}
library(brms)
zoib_model_dorm <-bf(
  Prob ~ model,
  phi ~ model,
  zoi ~ model,
  coi ~ model, 
  family = zero_one_inflated_beta()
)

zoib_model_grow <-bf(
  Prob ~ model,
  phi ~ model,
  zoi ~ model,
  coi ~ model, 
  family = zero_one_inflated_beta()
)

fit_dorm <- brm(
  formula = zoib_model_dorm,
  data = data_wilcox_dorm,
  cores = 4,
  file = "brm-zoib"
)
summary(fit_dorm)





fit_grow <- brm(
  formula = zoib_model_grow,
  data = data_wilcox_grow,
  cores = 4,
  file = "brm-zoib"
)
summary(fit_grow)

plot(
  conditional_effects(fit, dpar = "mu"), 
  points = TRUE, 
  point_args = list(width = .05, shape = 1)
)

names(data_wilcox_dorm)
shapiro.test(n_prob_lambda_dorm_post_fd)
shapiro.test(prob_lambda_dorm_post)
shapiro.test(prob_lambda_grow_post_fd)
shapiro.test(prob_lambda_grow_post)
```

```{r}
data_wilcox_dorm<-data.frame(Prob=c(prob_lambda_dorm_post_fd,prob_lambda_dorm_post),model=c(rep("f",length(prob_lambda_dorm_post_fd)),rep("s",length(prob_lambda_dorm_post))))

data_wilcox_grow<-data.frame(Prob=c(prob_lambda_grow_post_fd,prob_lambda_grow_post),model=c(rep("f",length(prob_lambda_grow_post_fd)),rep("s",length(prob_lambda_grow_post))))

summary(data_wilcox_dorm)
summary(data_wilcox_grow)
                                                                                            
wilcox.test(Prob ~ model, data = data_wilcox_dorm, 
        exact = FALSE, alternative = "greater")
wilcox.test(Prob ~ model, data = data_wilcox_grow, 
        exact = FALSE, alternative = "greater")

# pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/Niche_overestimation.pdf",width=7,height=4,useDingbats = F)
# par(mfrow = c(1, 2))
# plot(prob_lambda_dorm_post_fd ~ prob_lambda_dorm_post,col="#D55E00",pch = 19,cex = 1,xlab="Two-sex model",ylab="Female dominant model",xlim=c(0,1),ylim=c(0,1))
# abline(a=0,b=1,col="black",lw=2,lty=2)
# mtext(~ bolditalic ("Dormant season"),side = 3, adj = 0.5,cex=1.2)
# plot(prob_lambda_grow_post_fd ~ prob_lambda_grow_post,col="#D55E00",pch = 19,cex = 1,xlab="Two-sex model",ylab="Female dominant model",xlim=c(0,1),ylim=c(0,1))
# abline(a=0,b=1,col="black",lw=2,lty=2)
# mtext(~ bolditalic ("Growing season"),side = 3, adj = 0.5,cex=1.2)
# dev.off()

dx_dorm <- density(prob_lambda_dorm_post_fd)
dy_dorm <- density(prob_lambda_dorm_post)
dx_grow <- density(prob_lambda_grow_post_fd)
dy_grow <- density(prob_lambda_grow_post)

summary(prob_lambda_dorm_post_fd)
summary(prob_lambda_dorm_post)
summary(prob_lambda_grow_post_fd)
summary(prob_lambda_grow_post)


pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/Niche_overestimation.pdf",width=7,height=4,useDingbats = F)
par(mfrow = c(1, 2))
plot(dx_dorm, lwd = 2, main = "", xlab = expression("Pr " (lambda) > 1),xlim=c(0,1),
     col = "red")
abline(v=mean(prob_lambda_dorm_post_fd),lty=2,col="red")
polygon(dx_dorm, col = rgb(1, 0, 0, alpha = 0.5))
mtext(~ bolditalic ("Dormant season"),side = 3, adj = 0.5,cex=1.2)
lines(dy_dorm, lwd = 2, col = "blue")
abline(v=mean(prob_lambda_dorm_post),lty=2,col="blue")
polygon(dy_dorm, col = rgb(0, 0, 1, alpha = 0.5))

plot(dx_grow, lwd = 2, main = "", xlab = expression("Pr " (lambda) > 1),xlim=c(0,1),
     col = "red")
abline(v=mean(prob_lambda_grow_post_fd),lty=2,col="red")
polygon(dx_grow, col = rgb(1, 0, 0, alpha = 0.5))
mtext(~ bolditalic ("Growing season"),side = 3, adj = 0.5,cex=1.2)
lines(dy_grow, lwd = 2, col = "blue")
abline(v=mean(prob_lambda_grow_post),lty=2,col="blue")
polygon(dy_grow, col = rgb(0, 0, 1, alpha = 0.5))
dev.off()
```


# Sex ratio and climate change 

```{r}
sexratio_dormant<-read_csv(url("https://www.dropbox.com/scl/fi/i4e5amud3v0td6jz10j86/SR_OSR_dorm.csv?rlkey=bk1gyfcjn68umysxazydgqrmo&dl=1"))
# sexratio_dormant<-read_csv("/Volumes/NO NAME/geolambdaFd/SR_OSR_dorm.csv")
all_pptdorm_seq<-seq(min(data_past_present_45_85$zpptdorm*sd(poar_2015_2016$pptdorm)+mean(poar_2015_2016$pptdorm)),max(data_past_present_45_85$zpptdorm*sd(poar_2015_2016$pptdorm)+mean(poar_2015_2016$pptdorm)),length.out=30)
all_tempdorm_seq<-seq(min(data_past_present_45_85$ztempdorm*sd(poar_2015_2016$tempdorm)+mean(poar_2015_2016$tempdorm)),max(data_past_present_45_85$ztempdorm*sd(poar_2015_2016$tempdorm)+mean(poar_2015_2016$tempdorm)),length.out=30)

OSR_mtrx_dorm <- matrix(sexratio_dormant$OSR, nrow = 30, dimnames = list(all_pptdorm_seq,
               all_tempdorm_seq))
SR_mtrx_dorm <- matrix(sexratio_dormant$SR, nrow = 30, dimnames = list(all_pptdorm_seq,
               all_tempdorm_seq))
```

```{r}
# read in results of the above loop
sexratio_growing <- read_csv(url("https://www.dropbox.com/scl/fi/vr2pkz8ot2v6azqf18y0t/OSR_grow.csv?rlkey=l1h2re7kf7q155fuwg8m5m8ot&dl=1"))
all_pptgrow_seq<-seq(min(data_past_present_45_85$zpptgrow*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow)),max(data_past_present_45_85$zpptgrow*sd(poar_2015_2016$pptgrow) + mean(poar_2015_2016$pptgrow)),length.out=30)
all_tempgrow_seq<-seq(min(data_past_present_45_85$ztempgrow*sd(poar_2015_2016$tempgrow)+mean(poar_2015_2016$tempgrow)),max(data_past_present_45_85$ztempgrow*sd(poar_2015_2016$tempgrow)+mean(poar_2015_2016$tempgrow)),length.out=30)
OSR_mtrx_grow <- matrix(sexratio_growing$OSR, nrow = 30, dimnames = list(all_pptgrow_seq,
               all_tempgrow_seq))
SR_mtrx_grow <- matrix(sexratio_growing$SR, nrow = 30, dimnames = list(all_pptgrow_seq,
               all_tempgrow_seq))

```

```{r}
par(mfrow=c(1,2))
library(RColorBrewer)
library(lattice)
cls <- colorRampPalette(rev(brewer.pal(11, 'RdYlBu')))(100)
xyz<-expand.grid(all_pptgrow_seq,all_tempgrow_seq)
colnames(xyz)<-c("x","y")
xyz$z<-sexratio_growing$OSR
growing<-wireframe(z ~ y+x, data = xyz, zlab = list("OSR", rot=90),
    drape = TRUE, col.regions = cls, scales = list(arrows = FALSE), zlim = c(0, 1), cex.lab=10,cex.axis=5,
    main='Growing season', xlab='temp', ylab='ppt', ticktype="detailed")
# mtext("A",side = 3, adj = 0,cex=1.25)
```

```{r}
library(RColorBrewer)
library(lattice)
library(gridExtra) 
cls <- colorRampPalette(rev(brewer.pal(11, 'RdYlBu')))(100)
xyzdorm<-expand.grid(all_pptdorm_seq,all_tempdorm_seq)
colnames(xyzdorm)<-c("x","y")
xyzdorm$z<-sexratio_dormant$OSR
dormant<-wireframe(z ~ y+x, data = xyzdorm, zlab = list("OSR", rot=90),
    drape = TRUE, col.regions = cls, scales = list(arrows = FALSE), zlim = c(0, 1), cex.lab=10,cex.axis=5,
    main='Dormant season', xlab='temp', ylab='ppt',ticktype="detailed")

```

```{r}
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/OSR_3D.pdf",width=5,height=4,useDingbats = F)
grid.arrange(growing,dormant,ncol = 1)
dev.off()
```

```{r}
library(RColorBrewer)
x_current_d<-clim_current$pptdorm
y_current_d<-clim_current$tempdorm
x_past_d<-clim_past$pptdorm
y_past_d<-clim_past$tempdorm
x_miroc45_d<-clim_miroc45$pptdorm
y_miroc45_d<-clim_miroc45$tempdorm
x_miroc85_d<-clim_miroc85$pptdorm
y_miroc85_d<-clim_miroc85$tempdorm

x_current_g<-clim_current$pptgrow
y_current_g<-clim_current$tempgrow
x_past_g<-clim_past$pptgrow
y_past_g<-clim_past$tempgrow
x_miroc45_g<-clim_miroc45$pptgrow
y_miroc45_g<-clim_miroc45$tempgrow
x_miroc85_g<-clim_miroc85$pptgrow
y_miroc85_g<-clim_miroc85$tempgrow

scal_breaks <- c(seq(0, 1, length.out = 101))

```

```{r}
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/OSR.pdf",width=5,height=7,useDingbats = F)
par(mar=c(5,5,1,1),mfrow=c(2,1))
fields::image.plot(all_pptdorm_seq,all_tempdorm_seq,na.omit(OSR_mtrx_dorm),col=topo.colors(100),xlab="Precipitation dormant",ylab="Temperature dormant",main="",breaks = scal_breaks) 
contour(all_pptdorm_seq,all_tempdorm_seq,OSR_mtrx_dorm,add=T,labcex=0.75,col="black") 
mtext("A",side = 3, adj = 0,cex=1.25)
# text(x=x_current_d,y=y_current_d,"+",col="black",cex=1.5)
# text(x=x_past_d,y=y_past_d,"o",col="black")
# text(x=x_miroc45_d,y=y_miroc45_d,"*",col="black",cex=2)
# text(x=x_miroc85_d,y=y_miroc85_d,".",col="black",cex=4.5)
# fields::image.plot(all_pptgrow_seq,all_tempgrow_seq,OSR_mtrx_grow,col=topo.colors(100),xlab="Precipitation growing",ylab="Temperature growing",main="") 
# contour(all_pptgrow_seq,all_tempgrow_seq,OSR_mtrx_grow,add=T,labcex=0.75,col="black") 
# mtext("B",side = 3, adj = 0,cex=1.25)
# # title(main="B" ,adj=0,cex.main=1.4,font=1)
# text(x=x_current_g,y=y_current_g,"+",col="black",cex=1.5)
# text(x=x_past_g,y=y_past_g,"o",col="black")
# text(x=x_miroc45_g,y=y_miroc45_g,"*",col="black",cex=2)
# text(x=x_miroc85_g,y=y_miroc85_g,".",col="black",cex=4.5)
# text(x=x_miroc85_g,y=y_miroc85_g,".",col="black",cex=4.5)
dev.off()
```


```{r}
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/SR.pdf",width=5,height=7,useDingbats = F)
par(mar=c(5,5,1,1),mfrow=c(2,1))
fields::image.plot(all_pptdorm_seq,all_tempdorm_seq,SR_mtrx_dorm,col=topo.colors(100),xlab="Precipitation dormant",ylab="Temperature dormant",main="",breaks = scal_breaks) 
contour(all_pptdorm_seq,all_tempdorm_seq,SR_mtrx_dorm,add=T,labcex=0.75,col="black") 
mtext("A",side = 3, adj = 0,cex=1.25)
text(x=x_current_d,y=y_current_d,"+",col="black",cex=1.5)
text(x=x_past_d,y=y_past_d,"o",col="black")
text(x=x_miroc45_d,y=y_miroc45_d,"*",col="black",cex=2)
text(x=x_miroc85_d,y=y_miroc85_d,".",col="black",cex=4.5)
fields::image.plot(all_pptgrow_seq,all_tempgrow_seq,SR_mtrx_grow,col=topo.colors(100),xlab="Precipitation growing",ylab="Temperature growing",main="") 
contour(all_pptgrow_seq,all_tempgrow_seq,SR_mtrx_grow,add=T,labcex=0.75,col="black") 
mtext("B",side = 3, adj = 0,cex=1.25)
# title(main="B" ,adj=0,cex.main=1.4,font=1)
text(x=x_current_d,y=y_current_d,"+",col="black",cex=1.5)
text(x=x_past_d,y=y_past_d,"o",col="black")
text(x=x_miroc45_d,y=y_miroc45_d,"*",col="black",cex=2)
text(x=x_miroc85_d,y=y_miroc85_d,".",col="black",cex=4.5)
dev.off()
```

```{r}
sexratio_past<-read_csv(url("https://www.dropbox.com/scl/fi/yfv9b4w857wg8hcnasg6b/future_spatial_past.csv?rlkey=1q5xovdf33g2woql3p56iq9dr&dl=1"))
sexratio_current<-read_csv(url("https://www.dropbox.com/scl/fi/92rsr3ek3pzmvg4ej3pyp/future_spatial_current.csv?rlkey=xqbw7cei5u6wv2te41bzdohs0&dl=1"))
sexratio_cmc45<-read_csv(url("https://www.dropbox.com/scl/fi/cxalajldmu9dngs8767xv/future_spatial_cmc45.csv?rlkey=zgnl8kpu78bml8pw9fl0x81a7&dl=1"))
sexratio_cmc85<-read_csv(url("https://www.dropbox.com/scl/fi/jhof247ui1eor19iukswi/future_spatial_cmc85.csv?rlkey=w9b7fx3y5jxmvqyg5cq792pim&dl=1"))
sexratio_acc45<-read_csv(url("https://www.dropbox.com/scl/fi/5hhvjv3ikv95vjuaci72m/future_spatial_acc45.csv?rlkey=7tq5wwdy23uwre8n2ied823mj&dl=1"))
sexratio_acc85<-read_csv(url("https://www.dropbox.com/scl/fi/uf9d2c1eoj7a5sd3w2jsa/future_spatial_acc85.csv?rlkey=ntnhaa7dfzbmizqqsgfuslhl0&dl=1"))
sexratio_ces45<-read_csv(url("https://www.dropbox.com/scl/fi/4gqeocp3sgnqup1htzci4/future_spatial_ces45.csv?rlkey=oxpyohr6ghxttc2kxviswwh7x&dl=1"))
sexratio_ces85<-read_csv(url("https://www.dropbox.com/scl/fi/wdqmv4fsg9xdp50quesdz/future_spatial_ces85.csv?rlkey=qda9kjbsjf55r6w6vklf9s099&dl=1"))
sexratio_miroc45<-read_csv(url("https://www.dropbox.com/s/s7ps4029miuefnh/future_spatial_miroc45.csv?dl=1"))
sexratio_miroc85<-read_csv(url("https://www.dropbox.com/scl/fi/y9pf380aw5103h6l81dhi/future_spatial_miroc85.csv?rlkey=a7qk5qj27liyopkn54up4va0b&dl=1"))
```


```{r}
sr_past <- merge(x = sexratio_past,y =lam_prob_past,by=c("pptdorm","tempdorm"))
sr_current <- merge(x = sexratio_current,y =lam_prob_current,by=c("pptdorm","tempdorm")) 
sr_cmc_85 <- merge(x = sexratio_cmc85,y =lamcmc_prob_85,by=c("pptdorm","tempdorm"))
sr_cmc_45 <- merge(x = sexratio_cmc45,y =lamcmc_prob_45,by=c("pptdorm","tempdorm")) 
sr_miroc_85 <- merge(x = sexratio_miroc85,y =lam_prob_85,by=c("pptdorm","tempdorm"))
sr_miroc_45 <- merge(x = sexratio_miroc45,y =lam_prob_45,by=c("pptdorm","tempdorm")) 
sr_ces_85 <- merge(x = sexratio_ces85,y =lambdaces_prob_85,by=c("pptdorm","tempdorm"))
sr_ces_45 <- merge(x = sexratio_ces45,y =lambaces_prob_45,by=c("pptdorm","tempdorm")) 
sr_acc_85 <- merge(x =sexratio_acc85 ,y =lambdaacc_prob_85,by=c("pptdorm","tempdorm"))
sr_acc_45 <- merge(x = sexratio_acc45,y = lambaacc_prob_45,by=c("pptdorm","tempdorm")) 
```

```{r}
sr_past$OSR_final <- ifelse(sr_past$Prlambda >0.5, sr_past$OSR, NA)
sr_past$SR_final <- ifelse(sr_past$Prlambda >0.5, sr_past$SR, NA)

sr_current$OSR_final <- ifelse(sr_current$Prlambda >0.5, sr_current$OSR, NA)
sr_current$SR_final <- ifelse(sr_current$Prlambda >0.5, sr_current$SR, NA)

sr_cmc_85$OSR_final <- ifelse(sr_cmc_85$Prlambda >0.5, sr_cmc_85$OSR, NA)
sr_cmc_85$SR_final <- ifelse(sr_cmc_85$Prlambda >0.5, sr_cmc_85$SR, NA)

sr_cmc_45$OSR_final <- ifelse(sr_cmc_45$Prlambda >0.5, sr_cmc_45$OSR, NA)
sr_cmc_45$SR_final <- ifelse(sr_cmc_45$Prlambda >0.5, sr_cmc_45$SR, NA)

sr_miroc_85$OSR_final <- ifelse(sr_miroc_85$Prlambda >0.5, sr_miroc_85$OSR, NA)
sr_miroc_85$SR_final <- ifelse(sr_miroc_85$Prlambda >0.5, sr_miroc_85$SR, NA)

sr_miroc_45$OSR_final <- ifelse(sr_miroc_45$Prlambda >0.5, sr_miroc_45$OSR, NA)
sr_miroc_45$SR_final <- ifelse(sr_miroc_45$Prlambda >0.5, sr_miroc_45$SR, NA)

sr_ces_85$OSR_final <- ifelse(sr_ces_85$Prlambda >0.5, sr_ces_85$OSR, NA)
sr_ces_85$SR_final <- ifelse(sr_ces_85$Prlambda >0.5, sr_ces_85$SR, NA)

sr_ces_45$OSR_final <- ifelse(sr_ces_45$Prlambda >0.5, sr_ces_45$OSR, NA)
sr_ces_45$SR_final <- ifelse(sr_ces_45$Prlambda >0.5, sr_ces_45$SR, NA)


sr_acc_85$OSR_final <- ifelse(sr_acc_85$Prlambda >0.5, sr_acc_85$OSR, NA)
sr_acc_85$SR_final <- ifelse(sr_acc_85$Prlambda >0.5, sr_acc_85$SR, NA)


sr_acc_45$OSR_final <- ifelse(sr_acc_45$Prlambda >0.5, sr_acc_45$OSR, NA)
sr_acc_45$SR_final <- ifelse(sr_acc_45$Prlambda >0.5, sr_acc_45$SR, NA)


```

```{r}
d_past_OSR <- density(sr_past$OSR_final,na.rm=TRUE)
d_current_OSR <- density(sr_current$OSR_final,na.rm=TRUE)
d_cmc45_OSR <- density(sr_cmc_45$OSR_final,na.rm=TRUE)
d_cmc85_OSR <- density(sr_cmc_85$OSR_final,na.rm=TRUE)

d_ces45_OSR <- density(sr_ces_45$OSR_final,na.rm=TRUE)
d_ces85_OSR <- density(sr_ces_85$OSR_final,na.rm=TRUE)


d_acc45_OSR <- density(sr_acc_45$OSR_final,na.rm=TRUE)
d_acc85_OSR <- density(sr_acc_85$OSR_final,na.rm=TRUE)

d_miroc45_OSR <- density(sr_miroc_45$OSR_final,na.rm=TRUE)
d_miroc85_OSR <- density(sr_miroc_85$OSR_final,na.rm=TRUE)


```



```{r}
d_past_SR <- density(sr_past$SR_final,na.rm=TRUE)
d_current_SR <- density(sr_current$SR_final,na.rm=TRUE)
d_cmc45_SR <- density(sr_cmc_45$SR_final,na.rm=TRUE)
d_cmc85_SR <- density(sr_cmc_85$SR_final,na.rm=TRUE)

d_ces45_SR <- density(sr_ces_45$SR_final,na.rm=TRUE)
d_ces85_SR <- density(sr_ces_85$SR_final,na.rm=TRUE)


d_acc45_SR <- density(sr_acc_45$SR_final,na.rm=TRUE)
d_acc85_SR <- density(sr_acc_85$SR_final,na.rm=TRUE)

d_miroc45_SR <- density(sr_miroc_45$SR_final,na.rm=TRUE)
d_miroc85_SR <- density(sr_miroc_85$SR_final,na.rm=TRUE)


```

```{r}
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/POAR_OSR.pdf",width=5,height=5,useDingbats = F)
par(mar=c(5,5,1.5,0.5))
plot(d_past_OSR, lwd = 2, main = "", xlab = "Operational Sex Ratio (proportion of female panicle)",xlim=c(0,1),ylim=c(0,6.5),
     col = "#7570B3")
# mtext( "A",side = 3, adj = 0,cex=1.25)
abline(v=mean(sr_past$OSR_final,na.rm=TRUE),lty=2,col="#7570B3")

lines(d_current_OSR, lwd = 2,col = "#0072B2")
abline(v=mean(sr_current$OSR_final,na.rm=TRUE),lty=2,col="#0072B2")

lines(d_cmc45_OSR, lwd = 2,col = "#E6AB02")
abline(v=mean(sr_cmc_45$OSR_final,na.rm=TRUE),lty=2,col="#E6AB02")

lines(d_cmc85_OSR, lwd = 2,col = "#E7298A")
abline(v=mean(sr_cmc_85$OSR_final,na.rm=TRUE),lty=2,col="#E7298A")


legend(0.01,6,bty="n",legend=c("Past","Present","RCP 4.5","RCP 8.5"),lwd=c(2,2,2,2),lty=1,col=c("#7570B3","#0072B2","#E6AB02","#E7298A"),cex=0.8)

dev.off()
```



```{r}
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/POAR_OSR_MIROC_CES_ACC.pdf",width=5,height=7,useDingbats = F)
par(mar=c(5,5,1.5,0.5),mfrow=c(3,1))

plot(d_past_OSR, lwd = 2, main = "", xlab = "Operational Sex Ratio (proportion of female panicle)",xlim=c(0,1),
     col = "#7570B3")
mtext( "A",side = 3, adj = 0,cex=1.25)
abline(v=mean(sr_past$OSR_final,na.rm=TRUE),lty=2,col="#7570B3")

lines(d_current_OSR, lwd = 2,col = "#0072B2")
abline(v=mean(sr_current$OSR_final,na.rm=TRUE),lty=2,col="#0072B2")

lines(d_ces45_OSR, lwd = 2,col = "#E6AB02")
abline(v=mean(sr_ces_45$OSR_final,na.rm=TRUE),lty=2,col="#E6AB02")

lines(d_ces85_OSR, lwd = 2,col = "#E7298A")
abline(v=mean(sr_ces_85$OSR_final,na.rm=TRUE),lty=2,col="#E7298A")


plot(d_past_OSR, lwd = 2, main = "", xlab = "Operational Sex Ratio (proportion of female panicle)",xlim=c(0,1),
     col = "#7570B3")
mtext( "B",side = 3, adj = 0,cex=1.25)
abline(v=mean(sr_past$OSR_final,na.rm=TRUE),lty=2,col="#7570B3")

lines(d_current_OSR, lwd = 2,col = "#0072B2")
abline(v=mean(sr_current$OSR_final,na.rm=TRUE),lty=2,col="#0072B2")

lines(d_acc45_OSR, lwd = 2,col = "#E6AB02")
abline(v=mean(sr_acc_45$OSR_final,na.rm=TRUE),lty=2,col="#E6AB02")

lines(d_acc85_OSR, lwd = 2,col = "#E7298A")
abline(v=mean(sr_acc_85$OSR_final,na.rm=TRUE),lty=2,col="#E7298A")


plot(d_past_OSR, lwd = 2, main = "", xlab = "Operational Sex Ratio (proportion of female panicle)",xlim=c(0,1),
     col = "#7570B3")
mtext( "C",side = 3, adj = 0,cex=1.25)
abline(v=mean(sr_past$OSR_final,na.rm=TRUE),lty=2,col="#7570B3")

lines(d_current_OSR, lwd = 2,col = "#0072B2")
abline(v=mean(sr_current$OSR_final,na.rm=TRUE),lty=2,col="#0072B2")

lines(d_miroc45_OSR, lwd = 2,col = "#E6AB02")
abline(v=mean(sr_miroc_45$OSR_final,na.rm=TRUE),lty=2,col="#E6AB02")

lines(d_miroc85_OSR, lwd = 2,col = "#E7298A")
abline(v=mean(sr_miroc_85$OSR_final,na.rm=TRUE),lty=2,col="#E7298A")

dev.off()
```


```{r}


pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/POAR_SR.pdf",width=7,height=7,useDingbats = F)
par(mar=c(5,5,1.5,0.5),mfrow=c(2,2))
plot(d_past_SR, lwd = 2, main = "", xlab = "Sex ratio (proportion of female)",xlim=c(0,1),ylim=c(0,100),
     col = "#7570B3")
mtext( "A",side = 3, adj = 0,cex=1.25)
abline(v=mean(sr_past$SR_final,na.rm=TRUE),lty=2,col="#7570B3")

lines(d_current_SR, lwd = 2,col = "#0072B2")
abline(v=mean(sr_current$SR_final,na.rm=TRUE),lty=2,col="#0072B2")

lines(d_cmc45_SR, lwd = 2,col = "#E6AB02")
abline(v=mean(sr_cmc_45$SR_final,na.rm=TRUE),lty=2,col="#E6AB02")

lines(d_cmc85_SR, lwd = 2,col = "#E7298A")
abline(v=mean(sr_cmc_85$SR_final,na.rm=TRUE),lty=2,col="#E7298A")


legend(0.01,90,bty="n",legend=c("Past","Present","RCP 4.5","RCP 8.5"),lwd=c(2,2,2,2),lty=1,col=c("#7570B3","#0072B2","#E6AB02","#E7298A"),cex=0.8)



plot(d_past_SR, lwd = 2, main = "", xlab = "Sex ratio (proportion of female)",xlim=c(0,1),
     col = "#7570B3")
mtext( "B",side = 3, adj = 0,cex=1.25)
abline(v=mean(sr_past$SR_final,na.rm=TRUE),lty=2,col="#7570B3")

lines(d_current_SR, lwd = 2,col = "#0072B2")
abline(v=mean(sr_current$SR_final,na.rm=TRUE),lty=2,col="#0072B2")

lines(d_ces45_OSR, lwd = 2,col = "#E6AB02")
abline(v=mean(sr_ces_45$SR_final,na.rm=TRUE),lty=2,col="#E6AB02")

lines(d_ces85_OSR, lwd = 2,col = "#E7298A")
abline(v=mean(sr_ces_85$SR_final,na.rm=TRUE),lty=2,col="#E7298A")


plot(d_past_SR, lwd = 2, main = "", xlab = "Sex ratio (proportion of female)",xlim=c(0,1),
     col = "#7570B3")
mtext( "C",side = 3, adj = 0,cex=1.25)
abline(v=mean(sr_past$SR_final,na.rm=TRUE),lty=2,col="#7570B3")

lines(d_current_SR, lwd = 2,col = "#0072B2")
abline(v=mean(sr_current$SR_final,na.rm=TRUE),lty=2,col="#0072B2")

lines(d_acc45_SR, lwd = 2,col = "#E6AB02")
abline(v=mean(sr_acc_45$SR_final,na.rm=TRUE),lty=2,col="#E6AB02")

lines(d_acc85_SR, lwd = 2,col = "#E7298A")
abline(v=mean(sr_acc_85$SR_final,na.rm=TRUE),lty=2,col="#E7298A")


plot(d_past_SR, lwd = 2, main = "", xlab = "Sex ratio (proportion of female)",xlim=c(0,1),
     col = "#7570B3")
mtext( "D",side = 3, adj = 0,cex=1.25)
abline(v=mean(sr_past$SR_final,na.rm=TRUE),lty=2,col="#7570B3")

lines(d_current_SR, lwd = 2,col = "#0072B2")
abline(v=mean(sr_current$SR_final,na.rm=TRUE),lty=2,col="#0072B2")

lines(d_miroc45_SR, lwd = 2,col = "#E6AB02")
abline(v=mean(sr_miroc_45$SR_final,na.rm=TRUE),lty=2,col="#E6AB02")

lines(d_miroc85_SR, lwd = 2,col = "#E7298A")
abline(v=mean(sr_miroc_85$SR_final,na.rm=TRUE),lty=2,col="#E7298A")

dev.off()
```




```{r}
summary(geo_sr_past)
summary(sexratio_current)
summary(sexratio_cmc45)
summary(sexratio_cmc85)
summary(sexratio_acc45)
summary(sexratio_acc85)
summary(sexratio_ces45)
summary(sexratio_ces85)
summary(sexratio_miroc45)
summary(sexratio_miroc85)
```


```{r}
geo_sr_past <- merge(x = sr_past,y =clim_past_values,by=c("pptdorm","tempdorm"))
geo_sr_current <- merge(x = sr_current,y =clim_current_values,by=c("pptdorm","tempdorm")) 
geo_sr_cmc_85 <- merge(x = sr_cmc_85,y =climate_cmc_85_values,by=c("pptdorm","tempdorm"))
geo_sr_cmc_45 <- merge(x = sr_cmc_45,y =climate_cmc_45_values,by=c("pptdorm","tempdorm")) 
geo_sr_miroc_85 <- merge(x = sr_miroc_85,y =climate_miroc85_values,by=c("pptdorm","tempdorm"))
geo_sr_miroc_45 <- merge(x = sr_miroc_45,y =climate_miroc45_values,by=c("pptdorm","tempdorm")) 
geo_sr_ces_85 <- merge(x = sr_ces_85,y =climate_ces_85_values,by=c("pptdorm","tempdorm"))
geo_sr_ces_45 <- merge(x = sr_ces_45,y =climate_ces_45_values,by=c("pptdorm","tempdorm")) 
geo_sr_acc_85 <- merge(x = sr_acc_85 ,y =climate_acc_85_values,by=c("pptdorm","tempdorm"))
geo_sr_acc_45 <- merge(x = sr_acc_45,y =climate_acc_45_values,by=c("pptdorm","tempdorm")) 

```



```{r}
(map_past_osr <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-107,-92), ylim = c(25,41)) +
  geom_tile(data = geo_sr_past, aes(x = x, y = y, fill = OSR_final))+
  annotate(geom="text", x=-100, y=41, label="Past",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = "OSR",
    colours = colorspace::diverge_hcl(3),
    na.value = "transparent",
    breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  theme_light()+
 theme(strip.background = element_blank(),
       legend.background=element_blank(),
       legend.title = element_text(size = 8),
       legend.text  = element_text(size = 5),
       legend.position = c(0.15, 0.7),
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="A") )

```


```{r}
(map_current_osr <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = geo_sr_current, aes(x = x, y = y, fill = OSR_final))+
  # geom_point(data=poar_occ_1990_2019,aes(lon, lat),alpha=1/5)+
  annotate(geom="text", x=-100, y=41, label="Current",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = "OSR",
    colours = colorspace::diverge_hcl(3),
    na.value = "transparent",
    breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  theme_light()+
 theme(strip.background = element_blank(),
       legend.position = "none",
        legend.title = element_text(size = 8),
       legend.text  = element_text(size = 7),
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="B") )
```


```{r}
(map_cmc45_osr <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = geo_sr_cmc_45, aes(x = x, y = y, fill = OSR_final))+
  # geom_point(data=poar_occ_1990_2019,aes(lon, lat),alpha=1/5)+
  annotate(geom="text", x=-100, y=41, label="RCP 4.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = "OSR",
    colours = colorspace::diverge_hcl(3),
    na.value = "transparent",
    breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  theme_light()+
 theme(strip.background = element_blank(),
        legend.title = element_text(size = 8),
        legend.text  = element_text(size = 7),
        legend.position = "none",
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="C") )

```

```{r}
(map_cmc85_osr <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = geo_sr_cmc_85, aes(x = x, y = y, fill = OSR_final))+
  # geom_point(data=poar_occ_1990_2019,aes(lon, lat),alpha=1/5)+
  annotate(geom="text", x=-100, y=41, label="RCP 8.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = "OSR",
    colours = colorspace::diverge_hcl(3),
    na.value = "transparent",
    breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  theme_light()+
 theme(strip.background = element_blank(),
        legend.title = element_text(size = 8),
       legend.text  = element_text(size = 7),
        legend.position = "none",
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="D") )

```

```{r}
(map_past_sr <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-107,-92), ylim = c(25,41)) +
  geom_tile(data = geo_sr_past, aes(x = x, y = y, fill = SR_final))+
  annotate(geom="text", x=-100, y=41, label="Past",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = "SR",
    colours = colorspace::diverge_hcl(100),
    na.value = "transparent",
    breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  theme_light()+
 theme(strip.background = element_blank(),
        legend.background=element_blank(),
       legend.title = element_text(size = 8),
       legend.text  = element_text(size = 5),
       legend.position = c(0.15, 0.7),
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="E") )

```


```{r}
(map_current_sr <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = geo_sr_current, aes(x = x, y = y, fill = SR_final))+
  # geom_point(data=poar_occ_1990_2019,aes(lon, lat),alpha=1/5)+
  annotate(geom="text", x=-100, y=41, label="Current",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = "SR",
    colours = colorspace::diverge_hcl(3),
    na.value = "transparent",
    breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  theme_light()+
 theme(strip.background = element_blank(),
       legend.position = "none",
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="F") )
```


```{r}
(map_cmc45_sr <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = geo_sr_cmc_45, aes(x = x, y = y, fill = SR_final))+
  # geom_point(data=poar_occ_1990_2019,aes(lon, lat),alpha=1/5)+
  annotate(geom="text", x=-100, y=41, label="RCP 4.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = "SR",
    colours = colorspace::diverge_hcl(3),
    na.value = "transparent",
    breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  theme_light()+
 theme(strip.background = element_blank(),
        legend.position = "none",
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="G") )

```

```{r}
(map_cmc85_sr <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = geo_sr_cmc_85, aes(x = x, y = y, fill = SR_final))+
  # geom_point(data=poar_occ_1990_2019,aes(lon, lat),alpha=1/5)+
  annotate(geom="text", x=-100, y=41, label="RCP 8.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = "SR",
    colours = colorspace::diverge_hcl(3),
    na.value = "transparent",
    breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  theme_light()+
 theme(strip.background = element_blank(),
        legend.position = "none",
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="H") )

```




```{r}
Fig_geo_sr_cmc<-ggarrange(map_past_osr, map_current_osr, map_cmc45_osr, map_cmc85_osr, map_past_sr, map_current_sr, map_cmc45_sr, map_cmc85_sr,common.legend = FALSE,ncol = 4, nrow = 2)
ggsave("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/Fig_geo_sr_cmc.pdf", Fig_geo_sr_cmc, width = 10, height = 7)
```

```{r}
(map_ces45_osr <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = geo_sr_ces_45, aes(x = x, y = y, fill = OSR))+
  # geom_point(data=poar_occ_1990_2019,aes(lon, lat),alpha=1/5)+
  annotate(geom="text", x=-100, y=41, label="RCP 4.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = "OSR",
    colours = colorspace::diverge_hcl(3),
    na.value = "transparent",
    breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  theme_light()+
 theme(strip.background = element_blank(),
        legend.title = element_text(size = 8),
        legend.text  = element_text(size = 7),
        legend.position = "none",
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="C") )

```

```{r}
(map_ces85_osr <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = geo_sr_ces_85, aes(x = x, y = y, fill = OSR))+
  # geom_point(data=poar_occ_1990_2019,aes(lon, lat),alpha=1/5)+
  annotate(geom="text", x=-100, y=41, label="RCP 8.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = "OSR",
    colours = colorspace::diverge_hcl(3),
    na.value = "transparent",
    breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  theme_light()+
 theme(strip.background = element_blank(),
        legend.title = element_text(size = 8),
       legend.text  = element_text(size = 7),
        legend.position = "none",
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="D") )

```

```{r}
(map_ces45_sr <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = geo_sr_ces_45, aes(x = x, y = y, fill = SR))+
  # geom_point(data=poar_occ_1990_2019,aes(lon, lat),alpha=1/5)+
  annotate(geom="text", x=-100, y=41, label="RCP 4.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = "SR",
    colours = colorspace::diverge_hcl(3),
    na.value = "transparent",
    breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  theme_light()+
 theme(strip.background = element_blank(),
        legend.title = element_text(size = 8),
        legend.text  = element_text(size = 7),
        legend.position = "none",
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="C") )

```

```{r}
(map_ces85_sr <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = geo_sr_ces_85, aes(x = x, y = y, fill = SR))+
  # geom_point(data=poar_occ_1990_2019,aes(lon, lat),alpha=1/5)+
  annotate(geom="text", x=-100, y=41, label="RCP 8.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = "SR",
    colours = colorspace::diverge_hcl(3),
    na.value = "transparent",
    breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  theme_light()+
 theme(strip.background = element_blank(),
        legend.title = element_text(size = 8),
       legend.text  = element_text(size = 7),
        legend.position = "none",
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="D") )

```



```{r}
Fig_geo_sr_ces<-ggarrange(map_past_osr, map_current_osr, map_ces45_osr, map_ces85_osr, map_past_sr, map_current_sr, map_ces45_sr, map_ces85_sr,common.legend = FALSE,ncol = 4, nrow = 2)
ggsave("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/Fig_geo_sr_ces.pdf", Fig_geo_sr_ces, width = 10, height = 7)
```



```{r}
(map_miroc45_osr <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = geo_sr_miroc_45, aes(x = x, y = y, fill = OSR))+
  # geom_point(data=poar_occ_1990_2019,aes(lon, lat),alpha=1/5)+
  annotate(geom="text", x=-100, y=41, label="RCP 4.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = "OSR",
    colours = colorspace::diverge_hcl(3),
    na.value = "transparent",
    breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  theme_light()+
 theme(strip.background = element_blank(),
        legend.title = element_text(size = 8),
        legend.text  = element_text(size = 7),
        legend.position = "none",
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="C") )

```

```{r}
(map_miroc85_osr <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = geo_sr_miroc_85, aes(x = x, y = y, fill = OSR))+
  # geom_point(data=poar_occ_1990_2019,aes(lon, lat),alpha=1/5)+
  annotate(geom="text", x=-100, y=41, label="RCP 8.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = "OSR",
    colours = colorspace::diverge_hcl(3),
    na.value = "transparent",
    breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  theme_light()+
 theme(strip.background = element_blank(),
        legend.title = element_text(size = 8),
       legend.text  = element_text(size = 7),
        legend.position = "none",
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="D") )

```

```{r}
(map_miroc45_sr <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = geo_sr_miroc_45, aes(x = x, y = y, fill = SR))+
  # geom_point(data=poar_occ_1990_2019,aes(lon, lat),alpha=1/5)+
  annotate(geom="text", x=-100, y=41, label="RCP 4.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = "SR",
    colours = colorspace::diverge_hcl(3),
    na.value = "transparent",
    breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  theme_light()+
 theme(strip.background = element_blank(),
        legend.title = element_text(size = 8),
        legend.text  = element_text(size = 7),
        legend.position = "none",
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="C") )

```

```{r}
(map_miroc85_sr <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = geo_sr_miroc_85, aes(x = x, y = y, fill = SR))+
  # geom_point(data=poar_occ_1990_2019,aes(lon, lat),alpha=1/5)+
  annotate(geom="text", x=-100, y=41, label="RCP 8.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = "SR",
    colours = colorspace::diverge_hcl(3),
    na.value = "transparent",
    breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  theme_light()+
 theme(strip.background = element_blank(),
        legend.title = element_text(size = 8),
       legend.text  = element_text(size = 7),
        legend.position = "none",
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="D") )

```


```{r}
Fig_geo_sr_miroc<-ggarrange(map_past_osr, map_current_osr, map_miroc45_osr, map_miroc85_osr, map_past_sr, map_current_sr, map_miroc45_sr, map_miroc85_sr,common.legend = FALSE,ncol = 4, nrow = 2)
ggsave("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/Fig_geo_sr_miroc.pdf", Fig_geo_sr_miroc, width = 10, height = 7)
```


```{r}
(map_acc45_osr <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = geo_sr_acc_45, aes(x = x, y = y, fill = OSR))+
  # geom_point(data=poar_occ_1990_2019,aes(lon, lat),alpha=1/5)+
  annotate(geom="text", x=-100, y=41, label="RCP 4.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = "OSR",
    colours = colorspace::diverge_hcl(3),
    na.value = "transparent",
    breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  theme_light()+
 theme(strip.background = element_blank(),
        legend.title = element_text(size = 8),
        legend.text  = element_text(size = 7),
        legend.position = "none",
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="C") )

```

```{r}
(map_acc85_osr <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = geo_sr_acc_85, aes(x = x, y = y, fill = OSR))+
  # geom_point(data=poar_occ_1990_2019,aes(lon, lat),alpha=1/5)+
  annotate(geom="text", x=-100, y=41, label="RCP 8.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = "OSR",
    colours = colorspace::diverge_hcl(3),
    na.value = "transparent",
    breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  theme_light()+
 theme(strip.background = element_blank(),
        legend.title = element_text(size = 8),
       legend.text  = element_text(size = 7),
        legend.position = "none",
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="D") )

```

```{r}
(map_acc45_sr <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = geo_sr_acc_45, aes(x = x, y = y, fill = SR))+
  # geom_point(data=poar_occ_1990_2019,aes(lon, lat),alpha=1/5)+
  annotate(geom="text", x=-100, y=41, label="RCP 4.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = "SR",
    colours = colorspace::diverge_hcl(3),
    na.value = "transparent",
    breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  theme_light()+
 theme(strip.background = element_blank(),
        legend.title = element_text(size = 8),
        legend.text  = element_text(size = 7),
        legend.position = "none",
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="C") )

```

```{r}
(map_acc85_sr <- ggplot()+
  # geom_map(data = outline_map, map = outline_map, aes(map_id = region), color = "grey", linewidth = .1, fill = "#FAF9F6")+
  # coord_sf(xlim = c(-110,-90), ylim = c(25,45)) +
  geom_tile(data = geo_sr_acc_85, aes(x = x, y = y, fill = SR))+
  # geom_point(data=poar_occ_1990_2019,aes(lon, lat),alpha=1/5)+
  annotate(geom="text", x=-100, y=41, label="RCP 8.5",
              color="grey",size = 3)+
  scale_fill_gradientn(
    name = "SR",
    colours = colorspace::diverge_hcl(3),
    na.value = "transparent",
    breaks = seq(0, 1, length.out=5),labels=c(0.00, 0.25, 0.50, 0.75, 1.00),
                           limits=c(0,1))+
  theme_light()+
 theme(strip.background = element_blank(),
        legend.title = element_text(size = 8),
       legend.text  = element_text(size = 7),
        legend.position = "none",
        strip.text  = element_text(face = "italic", color = "black"))+
  labs(x = "Longitude", y = "Latitude",title="D") )

```


```{r}
Fig_geo_sr_acc<-ggarrange(map_past_osr, map_current_osr, map_acc45_osr, map_acc85_osr, map_past_sr, map_current_sr, map_acc45_sr, map_acc85_sr,common.legend = FALSE,ncol = 4, nrow = 2)
ggsave("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/Fig_geo_sr_acc.pdf", Fig_geo_sr_acc, width = 10, height = 7)
```


# Natural population and common garden sex ratio variation 
```{r}
## read in natural population surveys
#create the "big" POAR file including data from both survey years (2012 and 2013)
#this takes a bit of finagling
POAR12_1=read.csv(file="https://www.dropbox.com/s/hdxcvbheidi210r/POAR%20GIS%20Final%20Data_2012%281.10.2014%29.csv?dl=1")
POAR13=read.csv("https://www.dropbox.com/s/h0hmxeimw1zhg4w/POAR%20GIS%20Final%20Data_2013.csv?dl=1")
POAR12=read.csv(file="https://www.dropbox.com/s/t2y9r3152tfx3oz/POAR%20GIS%20Final%20Data.csv?dl=1")

#NOTE Compare the two 2012 files
POAR12_1=POAR12_1[order(POAR12_1$Population),]
POAR12=POAR12[order(POAR12$Population),c(1:7)]
#DISCREPANCIES with:
#Clear bay: original file misses polygon data, mine is more current
#Wichita Mountains: original file misses point data, mine is more current
#Quartz Mountain: original file has polygons data that I do not have. I therefore use the POAR12 data)
POAR12_1[10,6:7]=POAR12[10,6:7]  #I substitude POAR12 data to my current file
POAR12=POAR12_1
POAR12$year="2012" ; POAR13$year="2013"   

#COMBINE CLEAR BAY AND THUNDERBIRD LAKE
tmp=rbind(POAR12[14,],POAR13[1,])
newDf=data.frame("Population"="ClearBay-Thunderbird", 
                 "Latitude"=apply(tmp[,2:3],2,FUN=mean)[1],"Longitude"=apply(tmp[,2:3],2,FUN=mean)[2],
                 "Total.Points"=apply(tmp[,4:7],2,FUN=sum)[1],"Total.Polygons"=apply(tmp[,4:7],2,FUN=sum)[2],
                 "Total.Male.Infl."=apply(tmp[,4:7],2,FUN=sum)[3],
                 "Total.Female.Infl."=apply(tmp[,4:7],2,FUN=sum)[4],"year"="2013",row.names=16
)
POAR=rbind(POAR12[-14,],rbind(POAR13[-1,],newDf))        #Clear bay and Thunderbird lake Combined
POAR=POAR[order(as.character(POAR$Population)),]
```

```{r}
OSR<-POAR$Total.Female.Infl./(POAR$Total.Male.Infl. + POAR$Total.Female.Infl.)
mean(OSR)
```



```{r}
## compare to common garden sex ratios
#OSR by year
garden_osr <- poar.clim_seasonal %>% 
  dplyr::select(year, site, Sex,zpptgrow,zpptdorm,ztempgrow,ztempdorm,flowerN_t1) %>% 
  group_by(year,zpptgrow,zpptdorm,ztempgrow,ztempdorm,site, Sex) %>% 
  summarise(total_panicles = sum(flowerN_t1,na.rm=T)) %>% 
  spread(key=Sex,value=total_panicles) %>% 
  dplyr::rename(
    fem_pan ="F",
         mal_pan = "M",
         tempdorm=ztempdorm,
         tempgrow=ztempgrow,
         pptdorm=zpptdorm,
         pptgrow=zpptgrow) %>% 
  mutate(
    tot_pan=fem_pan+mal_pan,
         osr = fem_pan/tot_pan,
         year_index = year-2014)

#OSR pooled across years
garden_osr_poolyr <- poar.clim_seasonal %>% 
  dplyr::select(site, Sex, zpptgrow,zpptdorm,ztempgrow, ztempdorm,flowerN_t1) %>% 
  group_by(zpptgrow,zpptdorm,ztempgrow,ztempdorm, site, Sex) %>% 
  summarise(total_panicles = sum(flowerN_t1,na.rm=T)) %>% 
  spread(key=Sex,value=total_panicles) %>% 
  rename(fem_pan = "F",
         mal_pan = "M",
         tempdorm=ztempdorm,
         tempgrow=ztempgrow,
         pptdorm=zpptdorm,
         pptgrow=zpptgrow) %>% 
  mutate(tot_pan=fem_pan+mal_pan,
         osr = fem_pan/tot_pan)

##sex ratio by year
garden_sr <- poar.clim_seasonal %>% 
  dplyr::select( year, site, Sex, zpptgrow,zpptdorm,ztempgrow, ztempdorm,surv_t1) %>% 
  group_by(year, zpptgrow,zpptdorm,ztempgrow, ztempdorm, site, Sex) %>% 
  summarise(total_plants = sum(surv_t1,na.rm=T)) %>% 
  spread(key=Sex,value=total_plants) %>% 
  rename(fem = `F`,
         mal = `M`,
         tempdorm=ztempdorm,
         tempgrow=ztempgrow,
         pptdorm=zpptdorm,
         pptgrow=zpptgrow) %>% 
  mutate(total=fem+mal,
         sr = fem/total)
##sex ratio pooled across years
garden_sr_poolyr <- poar.clim_seasonal %>%
  dplyr::select(site, Sex, zpptgrow, zpptdorm, ztempgrow, ztempdorm, surv_t1) %>% 
  group_by(zpptgrow,zpptdorm,ztempgrow, ztempdorm, site, Sex) %>% 
  summarise(total_plants = sum(surv_t1,na.rm=T)) %>% 
  spread(key=Sex,value=total_plants) %>% 
  rename(fem = `F`,
         mal = `M`,
         tempdorm=ztempdorm,
         tempgrow=ztempgrow,
         pptdorm=zpptdorm,
         pptgrow=zpptgrow) %>% 
  mutate(total=fem+mal,
         sr = fem/total)
```

```{r}
## Use the same stan model as above to fit these longitudinal trends
garden_osr_dat <- list(y = garden_osr_poolyr$fem_pan,
                       n_trials = garden_osr_poolyr$tot_pan,
                       tempgrow = as.vector(garden_osr_poolyr$tempgrow),
                       tempdorm = as.vector(garden_osr_poolyr$tempdorm),
                       pptdorm=as.vector(garden_osr_poolyr$pptgrow),
                       pptgrow=as.vector(garden_osr_poolyr$pptdorm),
                       N = nrow(garden_osr_poolyr))


```

```{r}
sim_pars <- list(
  warmup = 1000, 
  iter = 9000, 
  thin = 3, 
  chains = 3
)
```

```{r}
# library(cmdstanr)
fit_garden_osr <- stan(
  file = '/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Analysis/stan/poar_garden_climate.stan',
  data = garden_osr_dat,
  warmup = sim_pars$warmup,
  iter = sim_pars$iter,
  thin = sim_pars$thin,
  chains = sim_pars$chains )
```

```{r}
traceplot(fit_garden_osr, pars = quote_bare(b0,b_tempgrow,b_pptgrow,b_pptdorm,b_tempgrow,b_tempdorm,b_pptgrow2,b_pptdorm2,b_tempgrow2,b_tempdorm2,b_tempdormpptdorm,b_tempgrowpptgrow))+theme_bw()

pairs(fit_garden_osr, pars = quote_bare(b0,b_tempgrow,b_pptgrow,b_pptdorm,b_tempgrow,b_tempdorm,b_pptgrow2,b_pptdorm2,b_tempgrow2,b_tempdorm2,b_tempdormpptdorm,b_tempgrowpptgrow))

```

```{r}
## pull out coefficients
coef_garden_osr <- rstan::extract(fit_garden_osr,pars = quote_bare(b0,b_tempgrow,b_pptgrow,b_pptdorm,b_tempdorm,b_pptgrow2,b_pptdorm2,b_tempgrow2,b_tempdorm2,b_tempdormpptdorm,b_tempgrowpptgrow))
names(coef_garden_osr)
```

```{r}
posterior_osr <- as.array(fit_garden_osr)
color_scheme_set("orange")
osr<-mcmc_intervals(posterior_osr, pars = quote_bare(b0,b_tempgrow,b_pptgrow,b_pptdorm,b_tempdorm,b_pptgrow2,b_pptdorm2,b_tempgrow2,b_tempdorm2,b_tempdormpptdorm,b_tempgrowpptgrow)) + 
   ggplot2::scale_y_discrete(limits = c("b0","b_tempgrow","b_pptgrow","b_pptdorm","b_tempdorm","b_pptgrow2","b_pptdorm2","b_tempgrow2","b_tempdorm2","b_tempdormpptdorm","b_tempgrowpptgrow"),
                            labels=c("b0"="b0",
                                     "b_pptgrow"="pptgrow",
                                     "b_tempgrow"="tempgrow",
                                     "b_pptdorm"="pptdorm",
                                     "b_tempdorm"="tempdorm",
                                     "b_tempdormpptdorm"="tempdormpptdorm",
                                     "b_tempgrowpptgrow"="tempgrowpptgrow",
                                     "b_pptgrow2"=expression(pptgrow^2),
                                   "b_tempgrow2"=expression(tempgrow^2),
                                    "b_pptdorm2"=expression(pptdorm^2),
                                    "b_tempdorm2"=expression(tempdorm^2)))+
  geom_vline(xintercept = 0, linetype = "dashed", size = 0.6, alpha = 0.6, color = "black") +
  labs(color = "Interaction type:")+
  xlab("Posterior estimates ")+
  xlim(-1,1)+
  # ggtitle("A") +
  # geom_rect(xmin = 0, xmax=2.25, ymin = 0, ymax = 25, alpha = 0.006, fill = "#F4B400", color = NA)+
  # geom_rect(xmin = -2.25, xmax = 0, ymin = 0, ymax = 25, alpha = 0.006, fill = "#0F9D58", color = NA)+
  theme_pubr()+
  theme(axis.title.x = element_text(family = "Helvetica",colour="black", size = 10),
        axis.title.y = element_blank(),
        axis.text.x = element_text(size = 8),
        axis.text.y  = element_text(size = 10),
        axis.line.x = element_line(linewidth = 0.1),
        axis.line.y = element_line(linewidth = 0.1),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(colour = "black", size=0.5))

```

```{r,eval=FALSE}
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/Posterior_ORS.pdf",useDingbats = F,height=4,width=5)
ggarrange(osr + rremove("ylab"), ncol = 1, nrow = 1)
dev.off()
```

```{r}
set.seed(13)
n_post_draws<-300
osr_post_draws <- sample.int(length(coef_garden_osr$b0), n_post_draws)
```

```{r}
x_tempgrow <- seq(min(garden_osr_poolyr$tempgrow),max(garden_osr_poolyr$tempgrow),length = 100)
x_pptgrow <- seq(min(garden_osr_poolyr$pptgrow),max(garden_osr_poolyr$pptgrow),length = 100)
x_tempdorm <- seq(min(garden_osr_poolyr$tempdorm),max(garden_osr_poolyr$tempdorm),length = 100)
x_pptdorm <- seq(min(garden_osr_poolyr$pptdorm),max(garden_osr_poolyr$pptdorm),length = 100)

```

```{r}
garden_osr_poolyr_plot <- poar.clim_seasonal %>% 
  dplyr::select(site, Sex, pptgrow,pptdorm,tempgrow, tempdorm,flowerN_t1) %>% 
  group_by(pptgrow,pptdorm,tempgrow,tempdorm, site, Sex) %>% 
  summarise(total_panicles = sum(flowerN_t1,na.rm=T)) %>% 
  spread(key=Sex,value=total_panicles) %>% 
  rename(fem_pan = "F",
         mal_pan = "M",
         tempdorm=tempdorm,
         tempgrow=tempgrow,
         pptdorm=pptdorm,
         pptgrow=pptgrow) %>% 
  mutate(tot_pan=fem_pan+mal_pan,
         osr = fem_pan/tot_pan)
```

```{r}
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/gardens_OSR.pdf",useDingbats = F,width=8,height=8)
par(mar=c(5,5,1.5,0.5),mfrow=c(2,2))

plot(garden_osr_poolyr$pptgrow*sd(garden_osr_poolyr_plot$pptgrow)+mean(garden_osr_poolyr_plot$pptgrow),garden_osr_poolyr$osr,ylim=c(0,1),cex.lab=1.2,cex.axis=1.2,
     xlab="Precipitation (grow.season)",ylab="Operational Sex Ratio")
points(garden_osr_poolyr$pptgrow*sd(garden_osr_poolyr_plot$pptgrow)+mean(garden_osr_poolyr_plot$pptgrow),cex=1.5,
       garden_osr_poolyr$osr,lwd=2,col=alpha("#E6AB02",1),bg="#E6AB02",pch=21)

abline(h=0.5,col="gray",lty=2)
mtext("A",side = 3, adj = 0,cex=1.25)
for(p in 1:n_post_draws){
  lines(x_pptgrow*sd(garden_osr_poolyr_plot$pptgrow)+mean(garden_osr_poolyr_plot$pptgrow),
        invlogit(coef_garden_osr$b0[osr_post_draws[p]] +
                   coef_garden_osr$b_pptgrow[osr_post_draws[p]] * x_pptgrow +
                   coef_garden_osr$b_tempgrow[osr_post_draws[p]] * mean(garden_osr_poolyr$tempgrow) +
                   coef_garden_osr$b_pptdorm[osr_post_draws[p]] * mean(garden_osr_poolyr$pptdorm) + 
                   coef_garden_osr$b_tempdorm[osr_post_draws[p]] * mean(garden_osr_poolyr$tempdorm) + 
                   coef_garden_osr$b_pptgrow2[osr_post_draws[p]] * x_pptgrow* x_pptgrow)+
          coef_garden_osr$b_tempgrow2[osr_post_draws[p]] * mean(garden_osr_poolyr$tempgrow)* mean(garden_osr_poolyr$tempgrow)+
       coef_garden_osr$b_pptdorm2[osr_post_draws[p]] * mean(garden_osr_poolyr$pptdorm)* mean(garden_osr_poolyr$pptdorm)+
       coef_garden_osr$b_tempdorm2[osr_post_draws[p]] * mean(garden_osr_poolyr$tempdorm)* mean(garden_osr_poolyr$tempdorm),
        col=alpha("#E6AB02",0.1))
}



plot(garden_osr_poolyr$tempgrow*sd(garden_osr_poolyr_plot$tempgrow)+mean(garden_osr_poolyr_plot$tempgrow),garden_osr_poolyr$osr,ylim=c(0,1),cex.lab=1.2,cex.axis=1.2,
     xlab="Temperature (grow.season)",ylab="Operational Sex Ratio")
points(garden_osr_poolyr$tempgrow*sd(garden_osr_poolyr_plot$tempgrow)+mean(garden_osr_poolyr_plot$tempgrow),cex=1.5,
       garden_osr_poolyr$osr,lwd=2,col=alpha("#E6AB02",1),bg="#E6AB02",pch=21)
abline(h=0.5,col="gray",lty=2)
mtext("B",side = 3, adj = 0,cex=1.25)
for(p in 1:n_post_draws){
  lines(x_tempgrow*sd(garden_osr_poolyr_plot$tempgrow)+mean(garden_osr_poolyr_plot$tempgrow),
        invlogit(coef_garden_osr$b0[osr_post_draws[p]] +
                   coef_garden_osr$b_tempgrow[osr_post_draws[p]] * x_tempgrow +
                   coef_garden_osr$b_pptgrow[osr_post_draws[p]] * mean(garden_osr_poolyr$pptgrow) +
                   coef_garden_osr$b_pptdorm[osr_post_draws[p]] * mean(garden_osr_poolyr$pptdorm) + 
                   coef_garden_osr$b_tempdorm[osr_post_draws[p]] * mean(garden_osr_poolyr$tempdorm) + 
                   coef_garden_osr$b_pptgrow2[osr_post_draws[p]] * mean(garden_osr_poolyr$pptgrow)* mean(garden_osr_poolyr$pptgrow))+
          coef_garden_osr$b_tempgrow2[osr_post_draws[p]] * x_tempgrow* x_tempgrow+
       coef_garden_osr$b_pptdorm2[osr_post_draws[p]] * mean(garden_osr_poolyr$pptdorm)* mean(garden_osr_poolyr$pptdorm)+
       coef_garden_osr$b_tempdorm2[osr_post_draws[p]] * mean(garden_osr_poolyr$tempdorm)* mean(garden_osr_poolyr$tempdorm),
        col=alpha("#E6AB02",0.1))
}


plot(garden_osr_poolyr$pptdorm*sd(garden_osr_poolyr_plot$pptdorm)+mean(garden_osr_poolyr_plot$pptdorm),garden_osr_poolyr$osr,ylim=c(0,1),cex.lab=1.2,cex.axis=1.2,
     xlab="Precipitation (dorm.season)",ylab="Operational Sex Ratio")
points(garden_osr_poolyr$pptdorm*sd(garden_osr_poolyr_plot$pptdorm)+mean(garden_osr_poolyr_plot$pptdorm),cex=1.5,
       garden_osr_poolyr$osr,lwd=2,col=alpha("#E6AB02",1),bg="#E6AB02",pch=21)

mtext("C",side = 3, adj = 0,cex=1.25)
abline(h=0.5,col="gray",lty=2)
for(p in 1:n_post_draws){
  lines(x_pptdorm*sd(garden_osr_poolyr_plot$pptdorm)+mean(garden_osr_poolyr_plot$pptdorm),
        invlogit(coef_garden_osr$b0[osr_post_draws[p]] +
                   coef_garden_osr$b_pptdorm[osr_post_draws[p]] * x_pptdorm +
                   coef_garden_osr$b_tempgrow[osr_post_draws[p]] * mean(garden_osr_poolyr$tempgrow) +
                   coef_garden_osr$b_pptdorm[osr_post_draws[p]] * mean(garden_osr_poolyr$pptdorm) + 
                   coef_garden_osr$b_tempdorm[osr_post_draws[p]] * mean(garden_osr_poolyr$tempdorm) + 
                   coef_garden_osr$b_pptgrow2[osr_post_draws[p]] * mean(garden_osr_poolyr$pptgrow)* mean(garden_osr_poolyr$pptgrow))+
          coef_garden_osr$b_tempgrow2[osr_post_draws[p]] * mean(garden_osr_poolyr$tempgrow)* mean(garden_osr_poolyr$tempgrow)+
       coef_garden_osr$b_pptdorm2[osr_post_draws[p]] * mean(garden_osr_poolyr$pptdorm)* mean(garden_osr_poolyr$pptdorm)+
       coef_garden_osr$b_tempdorm2[osr_post_draws[p]] * mean(garden_osr_poolyr$tempdorm)* mean(garden_osr_poolyr$tempdorm),
        col=alpha("#E6AB02",0.1))
}

plot(garden_osr_poolyr$tempdorm*sd(garden_osr_poolyr_plot$tempdorm)+mean(garden_osr_poolyr_plot$tempdorm),garden_osr_poolyr$osr,ylim=c(0,1),cex.lab=1.2,cex.axis=1.2,
     xlab="Temperature (dorm.season)",ylab="Operational Sex Ratio")
points(garden_osr_poolyr$tempdorm*sd(garden_osr_poolyr_plot$tempdorm)+mean(garden_osr_poolyr_plot$tempdorm),cex=1.5,
       garden_osr_poolyr$osr,lwd=2,col=alpha("#E6AB02",1),bg="#E6AB02",pch=21)
mtext("D",side = 3, adj = 0,cex=1.25)
abline(h=0.5,col="gray",lty=2)
for(p in 1:n_post_draws){
  lines(x_tempdorm*sd(garden_osr_poolyr_plot$tempdorm)+mean(garden_osr_poolyr_plot$tempdorm),
        invlogit(coef_garden_osr$b0[osr_post_draws[p]] +
                   coef_garden_osr$b_tempdorm[osr_post_draws[p]] * x_tempdorm +
                   coef_garden_osr$b_tempgrow[osr_post_draws[p]] * mean(garden_osr_poolyr$tempgrow) +
                   coef_garden_osr$b_pptdorm[osr_post_draws[p]] * mean(garden_osr_poolyr$pptdorm) + 
                   coef_garden_osr$b_pptgrow[osr_post_draws[p]] * mean(garden_osr_poolyr$pptgrow) + 
                   coef_garden_osr$b_pptgrow2[osr_post_draws[p]] * mean(garden_osr_poolyr$pptgrow)* mean(garden_osr_poolyr$pptgrow))+
          coef_garden_osr$b_tempgrow2[osr_post_draws[p]] * mean(garden_osr_poolyr$tempgrow)* mean(garden_osr_poolyr$tempgrow)+
       coef_garden_osr$b_pptdorm2[osr_post_draws[p]] * mean(garden_osr_poolyr$pptdorm)* mean(garden_osr_poolyr$pptdorm)+
       coef_garden_osr$b_tempdorm2[osr_post_draws[p]] * x_tempdorm* x_tempdorm,
        col=alpha("#E6AB02",0.1))
}


dev.off()

```

```{r}
garden_sr_dat <- list(y = garden_sr_poolyr$fem,
                       n_trials = garden_sr_poolyr$total,
                       tempgrow = as.vector(garden_osr_poolyr$tempgrow),
                       tempdorm = as.vector(garden_osr_poolyr$tempdorm),
                      pptgrow = as.vector(garden_osr_poolyr$pptgrow),
                       pptdorm = as.vector(garden_osr_poolyr$pptdorm),
                       N = nrow(garden_sr_poolyr))
```


```{r}
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/gardens_OSR_ESA.pdf",useDingbats = F,width=8,height=4)
par(mar=c(5,5,1.5,0.5),mfrow=c(1,2))

# plot(garden_osr_poolyr$pptgrow*sd(garden_osr_poolyr_plot$pptgrow)+mean(garden_osr_poolyr_plot$pptgrow),garden_osr_poolyr$osr,ylim=c(0,1),cex.lab=1.2,cex.axis=1.2,
#      xlab="Precipitation (grow.season)",ylab="Sex ratio")
# abline(h=0.5,col="gray",lty=2)
# mtext("A",side = 3, adj = 0,cex=1.25)
# for(p in 1:n_post_draws){
#   lines(x_pptgrow*sd(garden_osr_poolyr_plot$pptgrow)+mean(garden_osr_poolyr_plot$pptgrow),
#         invlogit(coef_garden_osr_pptgrow$b0[osr_post_draws[p]] +
#                    coef_garden_osr_pptgrow$b_pptgrow[osr_post_draws[p]] * x_pptgrow +
#                    coef_garden_osr_pptgrow$b_pptgrow2[osr_post_draws[p]] * x_pptgrow* x_pptgrow),
#         col=alpha("#E6AB02",0.1))
# }
# points(garden_osr_poolyr$pptgrow*sd(garden_osr_poolyr_plot$pptgrow)+mean(garden_osr_poolyr_plot$pptgrow),cex=1.5,
#        garden_osr_poolyr$osr,lwd=2,col=alpha("#E6AB02",1),bg="#E6AB02",pch=21)
# 


plot(garden_osr_poolyr$tempgrow*sd(garden_osr_poolyr_plot$tempgrow)+mean(garden_osr_poolyr_plot$tempgrow),garden_osr_poolyr$osr,ylim=c(0,1),cex.lab=1.2,cex.axis=1.2,
     xlab="Temperature (grow.season)",ylab="Sex ratio (proportion of female)")
abline(h=0.5,col="gray",lty=2)
mtext("A",side = 3, adj = 0,cex=1.25)
for(p in 1:n_post_draws){
  lines(x_tempgrow*sd(garden_osr_poolyr_plot$tempgrow)+mean(garden_osr_poolyr_plot$tempgrow),
        invlogit(coef_garden_osr_tempgrow$b0[osr_post_draws[p]] +
                   coef_garden_osr_tempgrow$b_tempgrow[osr_post_draws[p]] * x_tempgrow +
                   coef_garden_osr_tempgrow$b_tempgrow2[osr_post_draws[p]] * x_tempgrow* x_tempgrow),
        col=alpha("#E6AB02",0.1))
}
points(garden_osr_poolyr$tempgrow*sd(garden_osr_poolyr_plot$tempgrow)+mean(garden_osr_poolyr_plot$tempgrow),cex=1.5,
       garden_osr_poolyr$osr,lwd=2,col=alpha("#E6AB02",1),bg="#E6AB02",pch=21)



# plot(garden_osr_poolyr$pptdorm*sd(garden_osr_poolyr_plot$pptdorm)+mean(garden_osr_poolyr_plot$pptdorm),garden_osr_poolyr$osr,ylim=c(0,1),cex.lab=1.2,cex.axis=1.2,
#      xlab="Precipitation (dorm.season)",ylab="Sex ratio")
# mtext("C",side = 3, adj = 0,cex=1.25)
# abline(h=0.5,col="gray",lty=2)
# for(p in 1:n_post_draws){
#   lines(x_pptdorm*sd(garden_osr_poolyr_plot$pptdorm)+mean(garden_osr_poolyr_plot$pptdorm),
#         invlogit(coef_garden_osr_pptdorm$b0[osr_post_draws[p]] +
#                    coef_garden_osr_pptdorm$b_pptdorm[osr_post_draws[p]] * x_pptdorm +
#                    coef_garden_osr_pptdorm$b_pptdorm2[osr_post_draws[p]] * x_pptdorm* x_pptdorm),
#         col=alpha("#E6AB02",0.1))
# }
# points(garden_osr_poolyr$pptdorm*sd(garden_osr_poolyr_plot$pptdorm)+mean(garden_osr_poolyr_plot$pptdorm),cex=1.5,
#        garden_osr_poolyr$osr,lwd=2,col=alpha("#E6AB02",1),bg="#E6AB02",pch=21)


plot(garden_osr_poolyr$tempdorm*sd(garden_osr_poolyr_plot$tempdorm)+mean(garden_osr_poolyr_plot$tempdorm),garden_osr_poolyr$osr,ylim=c(0,1),cex.lab=1.2,cex.axis=1.2,
     xlab="Temperature (dorm.season)",ylab="Sex ratio (proportion of female)")
mtext("B",side = 3, adj = 0,cex=1.25)
abline(h=0.5,col="gray",lty=2)
for(p in 1:n_post_draws){
  lines(x_tempdorm*sd(garden_osr_poolyr_plot$tempdorm)+mean(garden_osr_poolyr_plot$tempdorm),
        invlogit(coef_garden_osr_tempdorm$b0[osr_post_draws[p]] +
                   coef_garden_osr_tempdorm$b_tempdorm[osr_post_draws[p]] * x_tempdorm +
                   coef_garden_osr_tempdorm$b_tempdorm2[osr_post_draws[p]] * x_tempdorm* x_tempdorm),
        col=alpha("#E6AB02",0.1))
}
points(garden_osr_poolyr$tempdorm*sd(garden_osr_poolyr_plot$tempdorm)+mean(garden_osr_poolyr_plot$tempdorm),cex=1.5,
       garden_osr_poolyr$osr,lwd=2,col=alpha("#E6AB02",1),bg="#E6AB02",pch=21)

dev.off()

```

```{r}
garden_sr_dat <- list(y = garden_sr_poolyr$fem,
                       n_trials = garden_sr_poolyr$total,
                       tempgrow = as.vector(garden_osr_poolyr$tempgrow),
                       tempdorm = as.vector(garden_osr_poolyr$tempdorm),
                      pptgrow = as.vector(garden_osr_poolyr$pptgrow),
                       pptdorm = as.vector(garden_osr_poolyr$pptdorm),
                       N = nrow(garden_sr_poolyr))
```


```{r}
fit_garden_sr <- stan(
  file = '/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Analysis/stan/poar_garden_climate.stan',
  data = garden_sr_dat,
  warmup = sim_pars$warmup,
  iter = sim_pars$iter,
  thin = sim_pars$thin,
  chains = sim_pars$chains )
```



```{r}
traceplot(fit_garden_sr, pars = quote_bare(b0,b_tempgrow,b_pptgrow,b_pptdorm,b_tempgrow,b_tempdorm,b_pptgrow2,b_pptdorm2,b_tempgrow2,b_tempdorm2,b_tempdormpptdorm,b_tempgrowpptgrow))+theme_bw()

pairs(fit_garden_sr, pars = quote_bare(b0,b_tempgrow,b_pptgrow,b_pptdorm,b_tempgrow,b_tempdorm,b_pptgrow2,b_pptdorm2,b_tempgrow2,b_tempdorm2,b_tempdormpptdorm,b_tempgrowpptgrow))
```

```{r}
## pull out coefficients
coef_garden_sr <- rstan::extract(fit_garden_sr,pars = quote_bare(b0,b_tempgrow,b_pptgrow,b_pptdorm,b_tempdorm,b_pptgrow2,b_pptdorm2,b_tempgrow2,b_tempdorm2,b_tempdormpptdorm,b_tempgrowpptgrow))
```

```{r}
posterior_sr <- as.array(fit_garden_sr)
color_scheme_set("orange")
sr<-mcmc_intervals(posterior_sr, pars = quote_bare(b0,b_tempgrow,b_pptgrow,b_pptdorm,b_tempdorm,b_pptgrow2,b_pptdorm2,b_tempgrow2,b_tempdorm2,b_tempdormpptdorm,b_tempgrowpptgrow)) + 
   ggplot2::scale_y_discrete(limits = c("b0","b_tempgrow","b_pptgrow","b_pptdorm","b_tempdorm","b_pptgrow2","b_pptdorm2","b_tempgrow2","b_tempdorm2","b_tempdormpptdorm","b_tempgrowpptgrow"),
                            labels=c("b0"="b0",
                                     "b_pptgrow"="pptgrow",
                                     "b_tempgrow"="tempgrow",
                                     "b_pptdorm"="pptdorm",
                                     "b_tempdorm"="tempdorm",
                                     "b_tempdormpptdorm"="tempdormpptdorm",
                                     "b_tempgrowpptgrow"="tempgrowpptgrow",
                                     "b_pptgrow2"=expression(pptgrow^2),
                                   "b_tempgrow2"=expression(tempgrow^2),
                                    "b_pptdorm2"=expression(pptdorm^2),
                                    "b_tempdorm2"=expression(tempdorm^2)))+
  geom_vline(xintercept = 0, linetype = "dashed", size = 0.6, alpha = 0.6, color = "black") +
  labs(color = "Interaction type:")+
  xlab("Posterior estimates ")+
  xlim(-1,1)+
  # ggtitle("A") +
  # geom_rect(xmin = 0, xmax=2.25, ymin = 0, ymax = 25, alpha = 0.006, fill = "#F4B400", color = NA)+
  # geom_rect(xmin = -2.25, xmax = 0, ymin = 0, ymax = 25, alpha = 0.006, fill = "#0F9D58", color = NA)+
  theme_pubr()+
  theme(axis.title.x = element_text(family = "Helvetica",colour="black", size = 10),
        axis.title.y = element_blank(),
        axis.text.x = element_text(size = 8),
        axis.text.y  = element_text(size = 10),
        axis.line.x = element_line(linewidth = 0.1),
        axis.line.y = element_line(linewidth = 0.1),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(colour = "black", size=0.5))

```


```{r,eval=FALSE}
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/Posterior_SR.pdf",useDingbats = F,height=4,width=5)
ggarrange(sr + rremove("ylab"), ncol = 1, nrow = 1)
dev.off()
```

```{r}
set.seed(13)
n_post_draws<-300
sr_post_draws <- sample.int(length(coef_garden_sr$b0), n_post_draws)
```


```{r}
garden_sr_poolyr_plot <- poar.clim_seasonal %>%
  dplyr::select(site, Sex, pptgrow, pptdorm, tempgrow, tempdorm, surv_t1) %>% 
  group_by(pptgrow,pptdorm,tempgrow, tempdorm, site, Sex) %>% 
  summarise(total_plants = sum(surv_t1,na.rm=T)) %>% 
  spread(key=Sex,value=total_plants) %>% 
  rename(fem = `F`,
         mal = `M`,
         tempdorm=tempdorm,
         tempgrow=tempgrow,
         pptdorm=pptdorm,
         pptgrow=pptgrow) %>% 
  mutate(total=fem+mal,
         sr = fem/total)
```

```{r}
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/gardens_SR.pdf",useDingbats = F,width=9,height=8)
par(mar=c(5,5,1.5,0.5),mfrow=c(2,2))

plot(garden_sr_poolyr$pptgrow*sd(garden_sr_poolyr_plot$pptgrow)+mean(garden_sr_poolyr_plot$pptgrow),garden_sr_poolyr$sr,ylim=c(0,1),cex.lab=1.2,cex.axis=1.2,
     xlab="Precipitation (grow.season)",ylab="Proportion of female plants")
points(garden_sr_poolyr$pptgrow*sd(garden_sr_poolyr_plot$pptgrow)+mean(garden_sr_poolyr_plot$pptgrow),cex=1.5,
       garden_sr_poolyr$sr,lwd=2,col=alpha("#E6AB02",1),bg="#E6AB02",pch=21)
abline(h=0.5,col="gray",lty=2)
mtext("A",side = 3, adj = 0,cex=1.25)
for(p in 1:n_post_draws){
  lines(x_pptgrow*sd(garden_sr_poolyr_plot$pptgrow)+mean(garden_sr_poolyr_plot$pptgrow),
        invlogit(coef_garden_sr$b0[osr_post_draws[p]] +
                   coef_garden_sr$b_pptgrow[sr_post_draws[p]] * x_pptgrow +
                   coef_garden_sr$b_tempgrow[sr_post_draws[p]] * mean(garden_sr_poolyr$tempgrow) +
                   coef_garden_sr$b_pptdorm[sr_post_draws[p]] * mean(garden_sr_poolyr$pptdorm) + 
                   coef_garden_sr$b_tempdorm[sr_post_draws[p]] * mean(garden_sr_poolyr$tempdorm) + 
                   coef_garden_sr$b_pptgrow2[sr_post_draws[p]] * x_pptgrow* x_pptgrow)+
          coef_garden_osr$b_tempgrow2[sr_post_draws[p]] * mean(garden_sr_poolyr$tempgrow)* mean(garden_sr_poolyr$tempgrow)+
       coef_garden_sr$b_pptdorm2[sr_post_draws[p]] * mean(garden_sr_poolyr$pptdorm)* mean(garden_sr_poolyr$pptdorm)+
       coef_garden_sr$b_tempdorm2[sr_post_draws[p]] * mean(garden_sr_poolyr$tempdorm)* mean(garden_sr_poolyr$tempdorm),
        col=alpha("#E6AB02",0.1))
}



plot(garden_sr_poolyr$tempgrow*sd(garden_sr_poolyr_plot$tempgrow)+mean(garden_sr_poolyr_plot$tempgrow),garden_sr_poolyr$sr,ylim=c(0,1),cex.lab=1.2,cex.axis=1.2,
     xlab="Temerature (grow.season)",ylab="Proportion of female plants")
abline(h=0.5,col="gray",lty=2)
mtext("B",side = 3, adj = 0,cex=1.25)
points(garden_sr_poolyr$tempgrow*sd(garden_sr_poolyr_plot$tempgrow)+mean(garden_sr_poolyr_plot$tempgrow),cex=1.5,
       garden_sr_poolyr$sr,lwd=2,col=alpha("#E6AB02",1),bg="#E6AB02",pch=21)
for(p in 1:n_post_draws){
  lines(x_tempgrow*sd(garden_sr_poolyr_plot$tempgrow)+mean(garden_sr_poolyr_plot$tempgrow),
        invlogit(coef_garden_sr$b0[sr_post_draws[p]] +
                   coef_garden_sr$b_tempgrow[sr_post_draws[p]] * x_tempgrow +
                   coef_garden_sr$b_pptgrow[sr_post_draws[p]] * mean(garden_sr_poolyr$pptgrow) +
                   coef_garden_sr$b_pptdorm[sr_post_draws[p]] * mean(garden_sr_poolyr$pptdorm) + 
                   coef_garden_sr$b_tempdorm[sr_post_draws[p]] * mean(garden_sr_poolyr$tempdorm) + 
                   coef_garden_sr$b_pptgrow2[sr_post_draws[p]] * mean(garden_sr_poolyr$pptgrow)* mean(garden_sr_poolyr$pptgrow))+
          coef_garden_sr$b_tempgrow2[sr_post_draws[p]] * x_tempgrow* x_tempgrow+
       coef_garden_sr$b_pptdorm2[sr_post_draws[p]] * mean(garden_sr_poolyr$pptdorm)* mean(garden_sr_poolyr$pptdorm)+
       coef_garden_sr$b_tempdorm2[sr_post_draws[p]] * mean(garden_sr_poolyr$tempdorm)* mean(garden_sr_poolyr$tempdorm),
        col=alpha("#E6AB02",0.1))
}



plot(garden_sr_poolyr$pptdorm*sd(garden_sr_poolyr_plot$pptdorm)+mean(garden_sr_poolyr_plot$pptdorm),garden_sr_poolyr$sr,ylim=c(0,1),cex.lab=1.2,cex.axis=1.2,
     xlab="Precipitation (dorm.season)",ylab="Proportion of female plants")
mtext("C",side = 3, adj = 0,cex=1.25)
abline(h=0.5,col="gray",lty=2)
points(garden_sr_poolyr$pptdorm*sd(garden_sr_poolyr_plot$pptdorm)+mean(garden_sr_poolyr_plot$pptdorm),cex=1.5,
       garden_sr_poolyr$sr,lwd=2,col=alpha("#E6AB02",1),bg="#E6AB02",pch=21)
for(p in 1:n_post_draws){
  lines(x_pptdorm*sd(garden_sr_poolyr_plot$pptdorm)+mean(garden_sr_poolyr_plot$pptdorm),
        invlogit(coef_garden_sr$b0[osr_post_draws[p]] +
                   coef_garden_sr$b_pptdorm[sr_post_draws[p]] * x_pptdorm +
                   coef_garden_sr$b_tempgrow[sr_post_draws[p]] * mean(garden_sr_poolyr$tempgrow) +
                   coef_garden_sr$b_pptdorm[sr_post_draws[p]] * mean(garden_sr_poolyr$pptdorm) + 
                   coef_garden_sr$b_tempdorm[sr_post_draws[p]] * mean(garden_sr_poolyr$tempdorm) + 
                   coef_garden_sr$b_pptgrow2[sr_post_draws[p]] * mean(garden_sr_poolyr$pptgrow)* mean(garden_sr_poolyr$pptgrow))+
          coef_garden_sr$b_tempgrow2[sr_post_draws[p]] * mean(garden_sr_poolyr$tempgrow)* mean(garden_sr_poolyr$tempgrow)+
       coef_garden_sr$b_pptdorm2[sr_post_draws[p]] * mean(garden_sr_poolyr$pptdorm)* mean(garden_sr_poolyr$pptdorm)+
       coef_garden_sr$b_tempdorm2[sr_post_draws[p]] * mean(garden_sr_poolyr$tempdorm)* mean(garden_sr_poolyr$tempdorm),
        col=alpha("#E6AB02",0.1))
}


plot(garden_sr_poolyr$tempdorm*sd(garden_sr_poolyr_plot$tempdorm)+mean(garden_sr_poolyr_plot$tempdorm),garden_sr_poolyr$sr,ylim=c(0,1),cex.lab=1.2,cex.axis=1.2,
     xlab="Temperature (dorm.season)",ylab="Proportion of female plants")
mtext("D",side = 3, adj = 0,cex=1.25)
abline(h=0.5,col="gray",lty=2)
points(garden_sr_poolyr$tempdorm*sd(garden_sr_poolyr_plot$tempdorm)+mean(garden_sr_poolyr_plot$tempdorm),cex=1.5,
       garden_sr_poolyr$sr,lwd=2,col=alpha("#E6AB02",1),bg="#E6AB02",pch=21)
for(p in 1:n_post_draws){
  lines(x_tempdorm*sd(garden_sr_poolyr_plot$tempdorm)+mean(garden_sr_poolyr_plot$tempdorm),
        invlogit(coef_garden_sr$b0[sr_post_draws[p]] +
                   coef_garden_sr$b_tempdorm[sr_post_draws[p]] * x_tempdorm +
                   coef_garden_sr$b_tempgrow[sr_post_draws[p]] * mean(garden_sr_poolyr$tempgrow) +
                   coef_garden_sr$b_pptdorm[sr_post_draws[p]] * mean(garden_sr_poolyr$pptdorm) + 
                   coef_garden_sr$b_pptgrow[sr_post_draws[p]] * mean(garden_sr_poolyr$pptgrow) + 
                   coef_garden_sr$b_pptgrow2[sr_post_draws[p]] * mean(garden_sr_poolyr$pptgrow)* mean(garden_osr_poolyr$pptgrow))+
          coef_garden_sr$b_tempgrow2[sr_post_draws[p]] * mean(garden_sr_poolyr$tempgrow)* mean(garden_sr_poolyr$tempgrow)+
       coef_garden_sr$b_pptdorm2[sr_post_draws[p]] * mean(garden_sr_poolyr$pptdorm)* mean(garden_sr_poolyr$pptdorm)+
       coef_garden_sr$b_tempdorm2[sr_post_draws[p]] * x_tempdorm* x_tempdorm,
        col=alpha("#E6AB02",0.1))
}



dev.off()

```






\`\`\`

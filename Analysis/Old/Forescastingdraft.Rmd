---
title: " Dioecious range-limited species response to climate change"
author: "Jacob Moutouama,Aldo Compagnoni and Tom Miller "
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
 rmdformats::readthedown:
    code_folding: show
    self_contained: true
    number_sections: true
    thumbnails: true
    lightbox: true
    gallery: true
    keep_md: true
    highlight: tango
    df_print: kable 
    toc_depth: 3
    fig_width: 8
    fig_height: 8
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(comment=NA, 
                      echo = TRUE,
                      warning=FALSE, 
                      message=FALSE)
knitr::opts_knit$set(fig.pos = "H",global.par = TRUE,knitr.table.format = "latex")
```

This is the code for the paper '-----', which  was  submitted in *Ecological Monograph* in 2023.

**Variables**:\

```{r img-with-knitr,echo=FALSE, fig.align='center', out.width='100%', fig.cap='Growing and dormant season for Poa arachnifera'}
knitr::include_graphics("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/POARlifecycle.png")
```
**pptgrow:** precipitation of the growing season\
**tempgrow:** temperature of the growing season\
**pptdorm:** precipitation of the dormant season\
**tempdorm:** temperature of the growing season\
**census.year:** Census year\


```{r eval=TRUE,echo=T}
rm(list = ls())
```

# Required libraries
```{r,warning=FALSE}
# load packages
library(rstan)
# set rstan options
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
set.seed(13)
# Sys.setenv(LOCAL_CPPFLAGS = '-march=corei7 -mtune=corei7')
options(tidyverse.quiet = TRUE)
library(tidyverse)
options(dplyr.summarise.inform = FALSE)
library(bayesplot)
# install.packages("countreg",repos = "http://R-Forge.R-project.org")
library(countreg)
library(rmutil)
library(actuar)
library(SPEI)
library(LaplacesDemon)
# if (!require("BiocManager", quietly = TRUE))
#     install.packages("BiocManager")
# BiocManager::install("scater")
#library(scater)
```

# Define functions
```{r}
# quote a series of bare names
quote_bare <- function( ... ){
    substitute( alist(...) ) %>% 
    eval( ) %>% 
    sapply( deparse )
}

invlogit<-function(x){exp(x)/(1+exp(x))}

multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)
  
  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)
  
  numPlots = length(plots)
  
  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                     ncol = cols, nrow = ceiling(numPlots/cols))
  }
  
  if (numPlots==1) {
    print(plots[[1]])
    
  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))
    
    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))
      
      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}

```


# Demography data 
```{r}
##
poar_allsites <- read.csv("https://www.dropbox.com/s/xk4225mn8btqhbm/demography_allsites.csv?dl=1", stringsAsFactors = F)#common garden data
poar_allsites$census.year<-poar_allsites$year-1 #Add census year to match with climate data
poar_allsites %>% 
  dplyr::select(everything()) %>% 
  filter(census.year %in% (2015:2016))-> poar_allsites_2015_2016 # Drop the first census to match with the seasonal model (growing and dormant season temp and precip)
```

# Current climatic data  
```{r}
poar_ppt <- read.csv("https://www.dropbox.com/s/kkga2hf9k1w9ht1/Poa_pr.csv?dl=1", stringsAsFactors = F) # monthly  precipitation 
poar_temp <- read.csv("https://www.dropbox.com/s/n0vrn8q5ma49rc9/Poa_tas.csv?dl=1", stringsAsFactors = F) # monthly temperature)
poar_ppt$census.year<-ifelse(poar_ppt$month<5,poar_ppt$year-1,poar_ppt$year) # data were collected in May. Thus, the precipitation for the census year is both the precipitation from May to December of the previous year and precipitation of the current year.  
poar_temp$census.year<-ifelse(poar_temp$month<5,poar_temp$year-1,poar_temp$year)
```

## Seasonal data  (growing and dormant season temperature and precipitation) 

```{r}
poar_temp %>% 
  dplyr::select(site,Longitude, Latitude,census.year,temp,month) %>% 
  filter(census.year %in% (2015:2016)) %>%
  mutate(Season=ifelse((month >= 6) & (month <= 9), "dormant", "growing")) %>% 
  group_by(site,census.year,Season) %>%
	summarise(site=unique(site),Longitude=unique(Longitude),Latitude=unique(Latitude),temp_season = mean(temp))->poar_tempseason 


poar_ppt %>% 
  dplyr::select(site,Longitude, Latitude,census.year,ppt,month) %>% 
  filter(census.year %in% (2015:2016)) %>%
  mutate(Season=ifelse((month >= 6) & (month <= 9), "dormant", "growing")) %>% 
  group_by(site,census.year,Season) %>%
	summarise(site=unique(site),Longitude=unique(Longitude),Latitude=unique(Latitude),ppt_season = sum(ppt))->poar_pptseason 

poar_climseason<- merge(x = poar_tempseason, y = poar_pptseason) # merge temperature and precipitation data

```

## Match seasonnal data with demographic data

```{r}
poar_allsites.clim_season <- left_join(x = poar_allsites_2015_2016 ,y =poar_climseason,by=c("site","census.year","Longitude","Latitude")) # merge the demographic data with climatic data for each site

poar_allsites.clim_season %>% 
  filter(Season=="growing") %>% 
  mutate(tempgrow=temp_season,pptgrow=ppt_season)->poar_allsites.clim_season_grow

poar_allsites.clim_season %>% 
  filter(Season=="dormant") %>% 
  mutate(tempdorm=temp_season,pptdorm=ppt_season)->poar_allsites.clim_season_dorm


poar.clim_seasonal<- cbind(poar_allsites.clim_season_grow,tempdorm=poar_allsites.clim_season_dorm$tempdorm,pptdorm=poar_allsites.clim_season_dorm$pptdorm)

# unique(poar.clim_seasonal$census.year)
# unique(poar.clim_seasonal$site)

# poar.clim_seasonal$Longitude<-poar.clim_seasonal$Longitude.x
# poar.clim_seasonal$Latitude <-poar.clim_seasonal$Latitude.y
# # poar.clim_seasonal %>% 
#   dplyr::select(tempgrow,pptgrow,tempdorm,pptdorm,site,census.year)->J
# 
# head(J)

```

## Check for correlation between predictors for the seasonal data

```{r,eval=FALSE}
figgrow <-ggplot(data=poar.clim_seasonal, aes(x=scale(tempgrow), y=scale(pptgrow))) +
        geom_smooth(method="lm",color = "#0072B2") +
        geom_point(color = '#0072B2',shape = 19, size=4) +
        labs (x="Temperature of growing season",y="Precipitation of growing season") +
        ggpubr::stat_cor(aes(label=..rr.label..)) +
        theme_bw()

figdorm <- ggplot(data=poar.clim_seasonal, aes(x=scale(tempdorm), y=scale(pptdorm))) +
        geom_smooth(method="lm",color = "#0072B2") +
        geom_point(color = '#0072B2',shape = 19, size=4) +
        labs (x="Temperature of dormant season",y="Precipitation of dormant season") +
        ggpubr::stat_cor(aes(label=..rr.label..)) +
        theme_bw()

figppt <-ggplot(data=poar.clim_seasonal, aes(x=scale(pptdorm), y=scale(pptgrow))) +
        geom_smooth(method="lm",color = "#0072B2") +
        geom_point(color = '#0072B2',shape = 19, size=4) +
        labs (x="Precipitation of dormant season",y="Precipitation of growing season") +
        ggpubr::stat_cor(method = "pearson", label.x = -1, label.y = 1.1) +
        theme_bw()

figtemp <- ggplot(data=poar.clim_seasonal, aes(x=scale(tempdorm), y=scale(tempgrow))) +
        geom_smooth(method="lm",color = "#0072B2") +
        geom_point(color = '#0072B2',shape = 19, size=4) +
        labs (x="Temperature of dormant season",y="Temperature of growing season") +
        ggpubr::stat_cor(method = "pearson", label.x = -1.5, label.y = 1) +
        theme_bw()


(figppttemp<-ggpubr::ggarrange(plotlist = list(figgrow, figdorm)))
(figgppt<-ggpubr::ggarrange(plotlist = list(figppt, figtemp)))

# pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/Varianceexplained.pdf",useDingbats = F,height=5,width=8)
# print(figgrowdorm)
# dev.off()
```

# Read and format data

```{r}
# Survival data
poar.clim_seasonal %>% 
  subset( tillerN_t0 > 0 )%>%
  dplyr::select(census.year, Code, site, Block, Sex, 
          Longitude, Latitude, 
          tillerN_t0, surv_t1,pptgrow,pptdorm,tempgrow,tempdorm,site)%>% 
  na.omit %>% 
  mutate( site         = site %>% as.factor %>% as.numeric,
          Block = Block %>% as.factor %>% as.numeric,
          Sex          = Sex %>% as.factor %>% as.numeric,
          source = Code %>% as.factor %>% as.numeric ) %>%
  mutate( log_size_t0   = log(tillerN_t0),
          z_ppt_t1_grow = pptgrow %>% scale %>% .[,1],
          z_temp_t1_grow = tempgrow %>% scale %>% .[,1])->poarclim_seasonal.surv
# growth data
poar.clim_seasonal %>% 
  subset( tillerN_t0 > 0 & tillerN_t1 > 0)%>%
  dplyr::select( census.year, Code, site, Block, Sex, 
          Longitude, Latitude, 
          tillerN_t0, tillerN_t1,surv_t1,pptgrow,pptdorm,tempgrow,tempdorm,site)%>% 
  na.omit %>% 
  mutate( site         = site %>% as.factor %>% as.numeric,
          Block = Block %>% as.factor %>% as.numeric,
          Sex          = Sex %>% as.factor %>% as.numeric,
          source = Code %>% as.factor %>% as.numeric ) %>%
  mutate( log_size_t0   = log(tillerN_t0),
          z_ppt_t1_grow = pptgrow %>% scale %>% .[,1],
          z_temp_t1_grow = tempgrow %>% scale %>% .[,1])->poarclim_seasonal.grow

# flowering data
poar.clim_seasonal %>% 
  subset( tillerN_t1 > 0 )%>%
  dplyr::select(census.year, Code, site, Block, Sex, 
          Longitude, Latitude, 
          tillerN_t1, flowerN_t1,flow_t1,pptgrow,pptdorm,tempgrow,tempdorm,site)%>% 
  na.omit %>% 
  mutate( site         = site %>% as.factor %>% as.numeric,
          Block = Block %>% as.factor %>% as.numeric,
          Sex          = Sex %>% as.factor %>% as.numeric,
          source = Code %>% as.factor %>% as.numeric ) %>%
  mutate( log_size_t1   = log(tillerN_t1),
          z_ppt_t1_grow = pptgrow %>% scale %>% .[,1],
          z_temp_t1_grow = tempgrow %>% scale %>% .[,1])->poarclim_seasonal.flow

# panicle data
poar.clim_seasonal %>% 
  subset( flowerN_t1 > 0 & tillerN_t1 > 0 )%>%
  dplyr::select( census.year, Code, site, Block, Sex, 
          Longitude, Latitude, 
          tillerN_t1, flowerN_t1,pptgrow,pptdorm,tempgrow,tempdorm,site)%>% 
  na.omit %>% 
  mutate( site         = site %>% as.factor %>% as.numeric,
          Block = Block %>% as.factor %>% as.numeric,
          Sex          = Sex %>% as.factor %>% as.numeric,
          source = Code %>% as.factor %>% as.numeric,
          panic_t1 = flowerN_t1) %>%
  mutate( 
          log_size_t1   = log(tillerN_t1),
          z_ppt_t1_grow = pptgrow %>% scale %>% .[,1],
          z_temp_t1_grow = tempgrow %>% scale %>% .[,1])->poarclim_seasonal.panic

#seed viability and germination
viabVr <- read.csv("https://www.dropbox.com/s/jfkgoxgv8o1fgqx/viability.csv?dl=1")

# seed viability
viabVr %>% 
  dplyr::select( plot, totS, yesMaybe, sr_f ) %>% 
  rename( SR        = sr_f,
          y_viab = yesMaybe,
          tot_seeds_viab = totS) %>% 
  dplyr::select(y_viab, tot_seeds_viab, SR ) %>% 
  na.omit ->viab

# seed germination
viabVr %>% 
  dplyr::select( plot, germTot, germFail, sr_f ) %>% 
  rename( SR        = sr_f,
          y_germ    = germTot ) %>% 
  mutate(tot_seeds_germ = y_germ + germFail ) %>% 
  dplyr::select(y_germ, tot_seeds_germ, SR ) %>% 
  na.omit->germ

# seeds per panicle
viabVr %>% 
  dplyr::select(SeedN)  %>% 
  na.omit->seeds



```


```{r}
# bundle data for model
data_sites_season <- list( n_sites    = poarclim_seasonal.surv$site %>% n_distinct,
                  n_sources  = poarclim_seasonal.surv$source %>% n_distinct(),
                  # survival data
                  n_blocks_s = poarclim_seasonal.surv$Block %>% n_distinct,
                  site_s   = poarclim_seasonal.surv$site,
                  source_s =  poarclim_seasonal.surv$source,
                  block_s  = poarclim_seasonal.surv$Block,
                  pptgrow_s=poarclim_seasonal.surv$z_ppt_t1_grow,
                  tempgrow_s=poarclim_seasonal.surv$z_temp_t1_grow,
                  site_block_s = data.frame( site_i  = poarclim_seasonal.surv$site,
                                             block_i = poarclim_seasonal.surv$Block ) %>%
                    unique %>% .$site_i,
                  male_s   = poarclim_seasonal.surv$Sex-1,
                  size_s   = poarclim_seasonal.surv$log_size_t0,
                  y_s      = poarclim_seasonal.surv$surv_t1,
                  n_s      = nrow(poarclim_seasonal.surv),
                  
                  # growth data
                  n_blocks_g = poarclim_seasonal.grow$Block %>% n_distinct,
                  site_g   = poarclim_seasonal.grow$site,
                  source_g =  poarclim_seasonal.grow$source,
                  block_g  = poarclim_seasonal.grow$Block,
                  pptgrow_g=poarclim_seasonal.grow$z_ppt_t1_grow,
                  tempgrow_g=poarclim_seasonal.grow$z_temp_t1_grow,
                  site_block_g = data.frame( site_i  = poarclim_seasonal.grow$site,
                                             block_i = poarclim_seasonal.grow$Block ) %>%
                    unique %>% .$site_i,
                  male_g   = poarclim_seasonal.grow$Sex-1,
                  size_g   = poarclim_seasonal.grow$log_size_t0,
                  y_g      = poarclim_seasonal.grow$tillerN_t1,
                  n_g      = nrow(poarclim_seasonal.grow),
                  
                   # flowering data
                   n_blocks_f = poarclim_seasonal.flow$Block %>% n_distinct,
                  site_f   = poarclim_seasonal.flow$site,
                  source_f =  poarclim_seasonal.flow$source,
                  block_f  = poarclim_seasonal.flow$Block,
                  pptgrow_f=poarclim_seasonal.flow$z_ppt_t1_grow,
                  tempgrow_f=poarclim_seasonal.flow$z_temp_t1_grow,
                  site_block_f = data.frame( site_i  = poarclim_seasonal.flow$site,
                                             block_i = poarclim_seasonal.flow$Block ) %>%
                    unique %>% .$site_i,
                  male_f   = poarclim_seasonal.flow$Sex-1,
                  size_f   = poarclim_seasonal.flow$log_size_t1,
                  y_f      = poarclim_seasonal.flow$flow_t1,
                  n_f      = nrow(poarclim_seasonal.flow),

                  # panicle data
                   n_blocks_p = poarclim_seasonal.panic$Block %>% n_distinct,
                  site_p   = poarclim_seasonal.panic$site,
                  source_p =  poarclim_seasonal.panic$source,
                  block_p  = poarclim_seasonal.panic$Block,
                  pptgrow_p=poarclim_seasonal.panic$z_ppt_t1_grow,
                  tempgrow_p=poarclim_seasonal.panic$z_temp_t1_grow,
                  site_block_p = data.frame( site_i  = poarclim_seasonal.panic$site,
                                             block_i = poarclim_seasonal.panic$Block ) %>%
                    unique %>% .$site_i,
                  male_p   = poarclim_seasonal.panic$Sex-1,
                  size_p   = poarclim_seasonal.panic$log_size_t1,
                  y_p      = poarclim_seasonal.panic$panic_t1,
                  n_p      = nrow(poarclim_seasonal.panic),
                   # viability
                  n_v       = nrow(viab),
                  y_v       = viab$y_viab,
                  tot_seeds_v = viab$tot_seeds_viab,
                  SR_v        = viab$SR,
                  
                  # germination
                  n_m       = nrow(germ),
                  y_m       = germ$y_germ,
                  tot_seeds_m = germ$tot_seeds_germ,
                  SR_m        = germ$SR,
                  
                  # seeds per panicle
                  n_d = nrow(seeds),
                  y_d = seeds$SeedN
                  
                )
```

### Running the stan model
```{r , eval=FALSE}

sim_pars <- list(
  warmup = 1000,
  iter = 4000,
  thin = 3,
  chains = 3
)

fit_allsites_season <- stan(
 file = "/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Analysis/stan/poar_season.stan",
 data = data_sites_season,
 warmup = sim_pars$warmup,
 iter = sim_pars$iter,
 thin = sim_pars$thin,
 chains = sim_pars$chains)

saveRDS(fit_allsites_season, '/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/fit_allsites.rds')

#load stan output -- this will also take a while, but not as long as running the model from scratch
fit_allsites_season <- readRDS(url("https://www.dropbox.com/scl/fi/b0o1cgxxfb8wli76tsgto/fit_allsites.rds?rlkey=7hw2kwh27wwjki39ofweec51x&dl=1"))
#ignore warning from readRDS
```

# Chains convergence 

```{r}
traceplot(fit_allsites_season, pars = quote_bare(b0_s,bsizesex_s,btempgrowpptgrow_s,bsex_s,
                                                        bsize_s,bpptgrow_s,btempgrow_s,
                                                        bpptgrowsex_s,btempgrowsex_s,
                                                        btempgrowpptgrowsex_s,bpptgrow2_s,
                                                        btempgrow2_s,bpptgrow2sex_s,
                                                        btempgrow2sex_s))+theme_bw()
```

```{r}
traceplot(fit_allsites_season, pars = quote_bare(b0_g,btempgrowpptgrow_g,bsizesex_g,bsex_g,
                                                        bsize_g,bpptgrow_g,btempgrow_g,bpptgrowsex_g,
                                                        btempgrowsex_g,
                                                        btempgrowpptgrowsex_g,bpptgrow2_g,btempgrow2_g,
                                                        bpptgrow2sex_g,btempgrow2sex_g))+theme_bw()
```

```{r}
traceplot(fit_allsites_season, pars = quote_bare(b0_f,bsizesex_f,bsex_f, bsize_f,bpptgrow_f,btempgrow_f,
                                                        bpptgrowsex_f,btempgrowsex_f,
                                                        btempgrowpptgrow_f,
                                                        btempgrowpptgrowsex_f,bpptgrow2_f,btempgrow2_f,
                                                        bpptgrow2sex_f,btempgrow2sex_f))+theme_bw()
```

```{r}
traceplot(fit_allsites_season, pars = quote_bare(b0_p,bsex_p,bsex_p,bsizesex_p, bsize_p,bpptgrow_p,
                                                         btempgrow_p,bpptgrowsex_p,btempgrowsex_p,
                                                         btempgrowpptgrow_p,
                                                         btempgrowpptgrowsex_p,bpptgrow2_p,btempgrow2_p,
                                                         bpptgrow2sex_p,btempgrow2sex_p))+theme_bw()
```


# Posterior predictive check for survival

```{r}
#pull out parameter posterior distributions
predS <- rstan::extract(fit_allsites_season, pars = c("predS"))$predS
predG <- rstan::extract(fit_allsites_season, pars = c("predG"))$predG
sigmaG <- rstan::extract(fit_allsites_season, pars = c("sigma"))$sigma
predF <- rstan::extract(fit_allsites_season, pars = c("predF"))$predF
predP <- rstan::extract(fit_allsites_season, pars = c("predP"))$predP
phi_P <- rstan::extract(fit_allsites_season, pars = c("phi_p"))$phi_p
predV <- rstan::extract(fit_allsites_season, pars = c("predV"))$predV
phi_V <- rstan::extract(fit_allsites_season, pars = c("phi_v"))$phi_v
predM <- rstan::extract(fit_allsites_season, pars = c("predM"))$predM
phi_M <- rstan::extract(fit_allsites_season, pars = c("phi_m"))$phi_m
#draw 500 random samples from the joint posterior
n_post_draws <- 500
post_draws <- sample.int(dim(predS)[1], n_post_draws)
#set up simulation output
y_s_sim <- matrix(NA,n_post_draws,length(data_sites_season$y_s))
y_g_sim <- matrix(NA,n_post_draws,length(data_sites_season$y_g))
y_f_sim <- matrix(NA,n_post_draws,length(data_sites_season$y_f))
y_p_sim <- matrix(NA,n_post_draws,length(data_sites_season$y_p))
y_v_sim <- matrix(NA,n_post_draws,length(data_sites_season$y_v))
y_m_sim <- matrix(NA,n_post_draws,length(data_sites_season$y_m))
#loop over the posterior and generate new observations
for(i in 1:n_post_draws){
  print(i)
  ## sample survival data (bernoulli)
  y_s_sim[i,] <- rbinom(n=length(data_sites_season$y_s), size=1, prob = invlogit(predS[i,]))
  ## sample flowering data (bernoulli)
  y_f_sim[i,] <- rbinom(n=length(data_sites_season$y_f), size=1, prob = invlogit(predF[i,]))
  ## sample viability data (beta-binomial)
  y_v_sim[i,] <- rbetabinom(n=length(data_sites_season$y_v), size=data_sites_season$tot_seeds_v, m=predV[i,], s=phi_V[i])
  ## sample germination data (beta-binomial)
  y_m_sim[i,] <- rbetabinom(n=length(data_sites_season$y_m), size=data_sites_season$tot_seeds_m, m=predM[i,], s=phi_M[i])
  ## sample growth data (zero-truncated PIG) -- generates data as legit PIG
    for(j in 1:length(data_sites_season$y_g)){
      ## the pig function appears numerically unstable at low probabilities, so here is a hacky solution
      pig<-dpoisinvgauss(0:1000,mean=predG[i,j],shape=(sigmaG[i]*predG[i,j]))
      pig[is.nan(pig) | is.infinite(pig)] <- 0
      pig_trunc_prob <- pig[2:1001] / (1 - ((1 - sum(pig)) + pig[1]))
      y_g_sim[i,j] <- sample(x=1:1000,size=1,replace=T,prob=pig_trunc_prob)
    } 
  ## sample panicle data (zero-truncated NB)
  for(j in 1:length(data_sites_season$y_p)){
    y_p_sim[i,j] <- sample(x=1:1000,size=1,replace=T,prob=dnbinom(1:1000, mu = exp(predP[i,j]), size=phi_P[i]) / (1 - dnbinom(0, mu = exp(predP[i,j]), size=phi_P[i])))
  }
}

```

```{r}
#plot ppc overlay
ppc_dens_overlay(data_sites_season$y_s, y_s_sim)+
  xlab("Survival status")+ylab("Density")+
  ggtitle(("Survival"))+theme(legend.position = "none")->ppc_surv
ppc_dens_overlay(data_sites_season$y_g, na.omit(y_g_sim))+xlim(0, 50)+
  xlab("Number of tillers")+ylab("Density")+
  ggtitle(("Growth"))+theme(legend.position = "none")->ppc_grow
ppc_dens_overlay(data_sites_season$y_f, y_f_sim)+
  xlab("Flowering status")+ylab("Density")+
  ggtitle(("Flowering"))+theme(legend.position = "none")->ppc_flow
ppc_dens_overlay(data_sites_season$y_p, y_p_sim)+xlim(0, 30)+
  xlab("Number of panicles")+ylab("Density")+
  ggtitle(("Panicles"))+theme(legend.position = "none")->ppc_panic
ppc_dens_overlay(data_sites_season$y_v, y_v_sim)+
  xlab("Number of viable seeds")+ylab("Density")+
  ggtitle(("Seed viability"))+theme(legend.position = "none")->ppc_viab
ppc_dens_overlay(data_sites_season$y_m, y_m_sim)+
  xlab("Number of germinants")+ylab("Density")+
  ggtitle(("Seed germination"))+theme(legend.position = "none")->ppc_germ

#print figure
# pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/PPC2.pdf",useDingbats = F,height=10,width=6)
# multiplot(ppc_surv,ppc_flow,ppc_viab,
#           ppc_grow,ppc_panic,ppc_germ,cols=2)
# dev.off()
```
# Posterior mean values for each  vital rate

```{r}
posteriorsurv_season <- as.array(fit_allsites_season)
color_scheme_set("blue")
mcmc_intervals(posteriorsurv_season, pars = quote_bare(b0_s,bsizesex_s,btempgrowpptgrow_s,bsex_s,
                                                        bsize_s,bpptgrow_s,btempgrow_s,
                                                        bpptgrowsex_s,btempgrowsex_s,
                                                        btempgrowpptgrowsex_s,bpptgrow2_s,
                                                        btempgrow2_s,bpptgrow2sex_s,
                                                        btempgrow2sex_s))+ geom_vline(xintercept = 0, linetype = 2)+theme_bw()
```

```{r}
mcmc_intervals(posteriorsurv_season, pars = quote_bare(b0_g,btempgrowpptgrow_g,bsizesex_g,bsex_g,
                                                        bsize_g,bpptgrow_g,btempgrow_g,bpptgrowsex_g,
                                                        btempgrowsex_g,
                                                        btempgrowpptgrowsex_g,bpptgrow2_g,btempgrow2_g,
                                                        bpptgrow2sex_g,btempgrow2sex_g))+ geom_vline(xintercept = 0, linetype = 2)+theme_bw()
```

```{r}
mcmc_intervals(posteriorsurv_season, pars = quote_bare(b0_f,bsizesex_f,bsex_f, bsize_f,bpptgrow_f,btempgrow_f,
                                                        bpptgrowsex_f,btempgrowsex_f,
                                                        btempgrowpptgrow_f,
                                                        btempgrowpptgrowsex_f,bpptgrow2_f,btempgrow2_f,
                                                        bpptgrow2sex_f,btempgrow2sex_f))+ geom_vline(xintercept = 0, linetype = 2)+theme_bw()
```

```{r}
mcmc_intervals(posteriorsurv_season, pars = quote_bare(b0_p,bsex_p,bsex_p,bsizesex_p, bsize_p,bpptgrow_p,
                                                         btempgrow_p,bpptgrowsex_p,btempgrowsex_p,
                                                         btempgrowpptgrow_p,
                                                         btempgrowpptgrowsex_p,bpptgrow2_p,btempgrow2_p,
                                                         bpptgrow2sex_p,btempgrow2sex_p))+ geom_vline(xintercept = 0, linetype = 2)+theme_bw()
```


# Vital rate figure (data and fitted models) 

```{r}
##set which dataset to use (here we are just reassigning the data and fits
##but in prelim analyses we explored different data subsets and models)
poar <- poar.clim_seasonal  #poar <- poar_dropsites #
fit_full <- fit_allsites_season  #fit_full <- fit_dropsites_full #

# bin size groups for visualization
size_bin_num <- 1


## re-format data for plotting
## Survival

poar %>% 
  subset( tillerN_t0 > 0 )%>%
  dplyr::select(census.year, Code, site, Block, Sex, 
          Longitude, Latitude, 
          tillerN_t0, surv_t1,pptgrow,pptdorm,tempgrow,tempdorm,site)%>% 
  na.omit %>% 
  mutate( site         = site %>% as.factor %>% as.numeric,
          Block = Block %>% as.factor %>% as.numeric,
          Sex          = Sex %>% as.factor %>% as.numeric,
          source = Code %>% as.factor %>% as.numeric ) %>%
  mutate( log_size_t0   = log(tillerN_t0),
          z_ppt_t1_grow = pptgrow %>% scale %>% .[,1],
          z_temp_t1_grow = tempgrow %>% scale %>% .[,1])->poar.surv


poar_surv_binned <- poar.surv %>% 
  mutate(size_bin = as.integer(cut_number(log_size_t0,size_bin_num))) %>% 
  group_by(site,census.year,Sex,size_bin) %>% 
  summarise(mean_size = mean(log_size_t0),
            mean_surv = mean(surv_t1),
            pptgrow = unique(z_ppt_t1_grow),
            tempgrow = unique(z_temp_t1_grow),
            bin_n = n())
surv_mean_sizes <- poar_surv_binned %>% group_by(Sex,size_bin) %>% summarise(size = mean(mean_size))
surv_mean_pptgrow <- poar_surv_binned %>% group_by(Sex,size_bin) %>% summarise(pptgrow = mean(pptgrow))
surv_mean_tempgrow <- poar_surv_binned %>% group_by(Sex,size_bin) %>% summarise(tempgrow = mean(tempgrow))


## Growth

poar %>% 
  subset( tillerN_t0 > 0 & tillerN_t1 > 0)%>%
  dplyr::select( census.year, Code, site, Block, Sex, 
          Longitude, Latitude, 
          tillerN_t0, tillerN_t1,surv_t1,pptgrow,pptdorm,tempgrow,tempdorm,site)%>% 
  na.omit %>% 
  mutate( site         = site %>% as.factor %>% as.numeric,
          Block = Block %>% as.factor %>% as.numeric,
          Sex          = Sex %>% as.factor %>% as.numeric,
          source = Code %>% as.factor %>% as.numeric ) %>%
  mutate( log_size_t0   = log(tillerN_t0),
          z_ppt_t1_grow = pptgrow %>% scale %>% .[,1],
          z_temp_t1_grow = tempgrow %>% scale %>% .[,1])->poar.grow

poar_grow_binned <- poar.grow %>% 
  mutate(size_bin = as.integer(cut_number(log_size_t0,size_bin_num))) %>% 
  group_by(site,census.year,Sex,size_bin) %>% 
  summarise(mean_size = mean(log_size_t0),
            mean_grow = mean(tillerN_t1),
            pptgrow = unique(z_ppt_t1_grow),
            tempgrow = unique(z_temp_t1_grow),
            bin_n = n())
grow_mean_sizes <- poar_grow_binned %>% group_by(Sex,size_bin) %>% summarise(size = mean(mean_size))
grow_mean_pptgrow <- poar_grow_binned %>% group_by(Sex,size_bin) %>% summarise(pptgrow = mean(pptgrow))
grow_mean_tempgrow <- poar_grow_binned %>% group_by(Sex,size_bin) %>% summarise(tempgrow = mean(tempgrow))

## Flowering

poar %>% 
  subset( tillerN_t1 > 0 )%>%
  dplyr::select(census.year, Code, site, Block, Sex, 
          Longitude, Latitude, 
          tillerN_t1, flowerN_t1,flow_t1,pptgrow,pptdorm,tempgrow,tempdorm,site)%>% 
  na.omit %>% 
  mutate( site         = site %>% as.factor %>% as.numeric,
          Block = Block %>% as.factor %>% as.numeric,
          Sex          = Sex %>% as.factor %>% as.numeric,
          source = Code %>% as.factor %>% as.numeric ) %>%
  mutate( log_size_t1   = log(tillerN_t1),
          z_ppt_t1_grow = pptgrow %>% scale %>% .[,1],
          z_temp_t1_grow = tempgrow %>% scale %>% .[,1])->poar.flow

poar_flow_binned <- poar.flow %>% 
  mutate(size_bin = as.integer(cut_number(log_size_t1,size_bin_num))) %>% 
  group_by(site,census.year,Sex,size_bin) %>% 
  summarise(mean_size = mean(log_size_t1),
            mean_flow = mean(flow_t1),
            pptgrow = unique(z_ppt_t1_grow),
            tempgrow = unique(z_temp_t1_grow),
            bin_n = n())
flow_mean_sizes <- poar_flow_binned %>% group_by(Sex,size_bin) %>% summarise(size = mean(mean_size))
flow_mean_pptgrow <- poar_flow_binned %>% group_by(Sex,size_bin) %>% summarise(pptgrow = mean(pptgrow))
flow_mean_tempgrow <- poar_flow_binned %>% group_by(Sex,size_bin) %>% summarise(tempgrow = mean(tempgrow))

## Panicles

poar %>% 
  subset( flowerN_t1 > 0 & tillerN_t1 > 0 )%>%
  dplyr::select(census.year, Code, site, Block, Sex, 
          Longitude, Latitude, 
          tillerN_t1, flowerN_t1,pptgrow,pptdorm,tempgrow,tempdorm,site)%>% 
  na.omit %>% 
  mutate( site         = site %>% as.factor %>% as.numeric,
          Block = Block %>% as.factor %>% as.numeric,
          Sex          = Sex %>% as.factor %>% as.numeric,
          source = Code %>% as.factor %>% as.numeric,
          panic_t1 = flowerN_t1) %>%
  mutate( 
          log_size_t1   = log(tillerN_t1),
          z_ppt_t1_grow = pptgrow %>% scale %>% .[,1],
          z_temp_t1_grow = tempgrow %>% scale %>% .[,1])->poar.panic


poar_panic_binned <- poar.panic %>% 
  mutate(size_bin = as.integer(cut_number(log_size_t1,size_bin_num))) %>% 
  group_by(site,census.year,Sex,size_bin) %>% 
  summarise(mean_size = mean(log_size_t1),
            mean_panic = mean(panic_t1),
            pptgrow = unique(z_ppt_t1_grow),
            tempgrow = unique(z_temp_t1_grow),
            bin_n = n())
panic_mean_sizes <- poar_panic_binned %>% group_by(Sex,size_bin) %>% summarise(size = mean(mean_size))
panic_mean_pptgrow <- poar_panic_binned %>% group_by(Sex,size_bin) %>% summarise(pptgrow = mean(pptgrow))
panic_mean_tempgrow <- poar_panic_binned %>% group_by(Sex,size_bin) %>% summarise(tempgrow = mean(tempgrow))


# pull out stan coefficients
surv_coef <- rstan::extract(fit_full, pars = quote_bare(b0_s,bsizesex_s,btempgrowpptgrow_s,bsex_s,
                                                        bsize_s,bpptgrow_s,btempgrow_s,
                                                        bpptgrowsex_s,btempgrowsex_s,
                                                        btempgrowpptgrowsex_s,bpptgrow2_s,
                                                        btempgrow2_s,bpptgrow2sex_s,
                                                        btempgrow2sex_s,
                                                        site_tau_s,block_tau_s,source_tau_s))

grow_coef <- rstan::extract(fit_full, pars = quote_bare(b0_g,btempgrowpptgrow_g,bsizesex_g,bsex_g,
                                                        bsize_g,bpptgrow_g,btempgrow_g,bpptgrowsex_g,
                                                        btempgrowsex_g,
                                                        btempgrowpptgrowsex_g,bpptgrow2_g,btempgrow2_g,
                                                        bpptgrow2sex_g,btempgrow2sex_g,sigma,
                                                        site_tau_g,block_tau_g,source_tau_g,sigma))

flow_coef <- rstan::extract(fit_full, pars = quote_bare(b0_f,bsizesex_f,bsex_f, bsize_f,bpptgrow_f,btempgrow_f,
                                                        bpptgrowsex_f,btempgrowsex_f,
                                                        btempgrowpptgrow_f,
                                                        btempgrowpptgrowsex_f,bpptgrow2_f,btempgrow2_f,
                                                        bpptgrow2sex_f,btempgrow2sex_f,
                                                        site_tau_f,block_tau_f,source_tau_f))

panic_coef <- rstan::extract(fit_full, pars = quote_bare(b0_p,bsex_p,bsex_p,bsizesex_p, bsize_p,bpptgrow_p,
                                                         btempgrow_p,bpptgrowsex_p,btempgrowsex_p,
                                                         btempgrowpptgrow_p,
                                                         btempgrowpptgrowsex_p,bpptgrow2_p,btempgrow2_p,
                                                         bpptgrow2sex_p,btempgrow2sex_p,
                                                         site_tau_p,block_tau_p,source_tau_p))

```


## Precipitation of the growing season
```{r}
# sample vital rate functions from the join posterior
pptgrow_seq <- seq(min(poar_surv_binned$pptgrow),max(poar_surv_binned$pptgrow),length.out=50)
# temgrow_seq <- seq(min(poar_surv_binned$tempgrow),max(poar_surv_binned$tempgrow),0.1)
# pptdorm_seq <- seq(min(poar_surv_binned$pptdorm),max(poar_surv_binned$pptdorm),0.1)
# tempdorm_seq <- seq(min(poar_surv_binned$tempdorm),max(poar_surv_binned$tempdorm),0.1)

n_post_draws <- 500
post_draws <- sample.int(length(surv_coef$b0_s), n_post_draws)
surv_sex_diff_post <- grow_sex_diff_post <- flow_sex_diff_post <- panic_sex_diff_post <- array(NA,dim=c(size_bin_num,length(pptgrow_seq),n_post_draws))
for(p in 1:n_post_draws){
  for(i in 1:size_bin_num){
    s=1;      
    fem_s <- invlogit((surv_coef$b0_s[post_draws[p]]) + 
                         (surv_coef$bsize_s[post_draws[p]]) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i]+
                         (surv_coef$bsizesex_s[post_draws[p]]) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i] * (s-1) +
                         (surv_coef$bsex_s[post_draws[p]]) * (s-1) +
                         (surv_coef$bpptgrow_s[post_draws[p]]) * pptgrow_seq +
                         (surv_coef$btempgrow_s[post_draws[p]]) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                         (surv_coef$bpptgrowsex_s[post_draws[p]]) * pptgrow_seq * (s-1) +
                         (surv_coef$btempgrowsex_s[post_draws[p]]) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * (s-1) +
                         (surv_coef$btempgrowpptgrow_s[post_draws[p]]) * pptgrow_seq * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                         (surv_coef$btempgrowpptgrowsex_s[post_draws[p]]) * pptgrow_seq * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s]  * (s-1) +
                         (surv_coef$bpptgrow2_s[post_draws[p]]) * (pptgrow_seq^2) +
                         (surv_coef$btempgrow2_s[post_draws[p]]) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 +
                         (surv_coef$bpptgrow2sex_s[post_draws[p]]) * (pptgrow_seq^2) * (s-1) +
                         (surv_coef$btempgrow2sex_s[post_draws[p]]) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 * (s-1) 
    )
    
    fem_g <- exp((grow_coef$b0_g[post_draws[p]]) + 
                         (grow_coef$bsize_g[post_draws[p]]) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i]+
                         (grow_coef$bsizesex_g[post_draws[p]]) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i] * (s-1) +
                         (grow_coef$bsex_g[post_draws[p]]) * (s-1) +
                         (grow_coef$bpptgrow_g[post_draws[p]]) * pptgrow_seq +
                         (grow_coef$btempgrow_g[post_draws[p]]) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                         (grow_coef$bpptgrowsex_g[post_draws[p]]) * pptgrow_seq * (s-1) +
                         (grow_coef$btempgrowsex_g[post_draws[p]]) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] * (s-1) +
                         (grow_coef$btempgrowpptgrow_g[post_draws[p]]) * pptgrow_seq * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                         (grow_coef$btempgrowpptgrowsex_g[post_draws[p]]) * pptgrow_seq * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s]  * (s-1) +
                         (grow_coef$bpptgrow2_g[post_draws[p]]) * (pptgrow_seq^2) +
                         (grow_coef$btempgrow2_g[post_draws[p]]) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 +
                         (grow_coef$bpptgrow2sex_g[post_draws[p]]) * (pptgrow_seq^2) * (s-1) +
                         (grow_coef$btempgrow2sex_g[post_draws[p]]) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 * (s-1)
    
    )
    
    fem_f <- invlogit((flow_coef$b0_f[post_draws[p]]) + 
                         (flow_coef$bsize_f[post_draws[p]]) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i]+
                         (flow_coef$bsizesex_f[post_draws[p]]) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i] * (s-1) +
                         (flow_coef$bsex_f[post_draws[p]]) * (s-1) +
                         (flow_coef$bpptgrow_f[post_draws[p]]) * pptgrow_seq +
                         (flow_coef$btempgrow_f[post_draws[p]]) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                         (flow_coef$bpptgrowsex_f[post_draws[p]]) * pptgrow_seq * (s-1) +
                         (flow_coef$btempgrowsex_f[post_draws[p]]) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] * (s-1) +
                         (flow_coef$btempgrowpptgrow_f[post_draws[p]]) * pptgrow_seq * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                         (flow_coef$btempgrowpptgrowsex_f)[post_draws[p]] * pptgrow_seq * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s]  * (s-1) +
                         (flow_coef$bpptgrow2_f[post_draws[p]]) * (pptgrow_seq^2) +
                         (flow_coef$btempgrow2_f[post_draws[p]]) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 +
                         (flow_coef$bpptgrow2sex_f[post_draws[p]]) * (pptgrow_seq^2) * (s-1) +
                         (flow_coef$btempgrow2sex_f[post_draws[p]]) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 * (s-1) 
    
    )
    
    
     fem_p <- exp((panic_coef$b0_p[post_draws[p]]) + 
                         (panic_coef$bsize_p[post_draws[p]]) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i]+
                         (panic_coef$bsizesex_p[post_draws[p]]) * flow_mean_sizes$size[grow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i] * (s-1) +
                         (panic_coef$bsex_p[post_draws[p]]) * (s-1) +
                         (panic_coef$bpptgrow_p[post_draws[p]]) * pptgrow_seq +
                         (panic_coef$btempgrow_p[post_draws[p]]) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                         (panic_coef$bpptgrowsex_p[post_draws[p]]) * pptgrow_seq * (s-1) +
                         (panic_coef$btempgrowsex_p[post_draws[p]]) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] * (s-1) +
                         (panic_coef$btempgrowpptgrow_p[post_draws[p]]) * pptgrow_seq * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                         (panic_coef$btempgrowpptgrowsex_p[post_draws[p]]) * pptgrow_seq * grow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s]  * (s-1) +
                         (panic_coef$bpptgrow2_p[post_draws[p]]) * (pptgrow_seq^2) +
                         (panic_coef$btempgrow2_p[post_draws[p]]) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 +
                         (panic_coef$bpptgrow2sex_p[post_draws[p]]) * (pptgrow_seq^2) * (s-1) +
                         (panic_coef$btempgrow2sex_p[post_draws[p]]) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 * (s-1) 
    )
    
    
    s=2;       
   male_s <- invlogit((surv_coef$b0_s[post_draws[p]]) + 
                         (surv_coef$bsize_s[post_draws[p]]) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i]+
                         (surv_coef$bsizesex_s[post_draws[p]]) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i] * (s-1) +
                         (surv_coef$bsex_s[post_draws[p]]) * (s-1) +
                         (surv_coef$bpptgrow_s[post_draws[p]]) * pptgrow_seq +
                         (surv_coef$btempgrow_s[post_draws[p]]) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                         (surv_coef$bpptgrowsex_s[post_draws[p]]) * pptgrow_seq * (s-1) +
                         (surv_coef$btempgrowsex_s[post_draws[p]]) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * (s-1) +
                         (surv_coef$btempgrowpptgrow_s[post_draws[p]]) * pptgrow_seq * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                         (surv_coef$btempgrowpptgrowsex_s[post_draws[p]]) * pptgrow_seq * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s]  * (s-1) +
                         (surv_coef$bpptgrow2_s[post_draws[p]]) * (pptgrow_seq^2) +
                         (surv_coef$btempgrow2_s[post_draws[p]]) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 +
                         (surv_coef$bpptgrow2sex_s[post_draws[p]]) * (pptgrow_seq^2) * (s-1) +
                         (surv_coef$btempgrow2sex_s[post_draws[p]]) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 * (s-1) 
    
    )
    
    male_g <- exp((grow_coef$b0_g[post_draws[p]]) + 
                         (grow_coef$bsize_g[post_draws[p]]) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i]+
                         (grow_coef$bsizesex_g[post_draws[p]]) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i] * (s-1) +
                         (grow_coef$bsex_g[post_draws[p]]) * (s-1) +
                         (grow_coef$bpptgrow_g[post_draws[p]]) * pptgrow_seq +
                         (grow_coef$btempgrow_g[post_draws[p]]) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                         (grow_coef$bpptgrowsex_g[post_draws[p]]) * pptgrow_seq * (s-1) +
                         (grow_coef$btempgrowsex_g[post_draws[p]]) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] * (s-1) +
                         (grow_coef$btempgrowpptgrow_g[post_draws[p]]) * pptgrow_seq * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                         (grow_coef$btempgrowpptgrowsex_g)[post_draws[p]] * pptgrow_seq * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s]  * (s-1) +
                         (grow_coef$bpptgrow2_g[post_draws[p]]) * (pptgrow_seq^2) +
                         (grow_coef$btempgrow2_g[post_draws[p]]) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 +
                         (grow_coef$bpptgrow2sex_g[post_draws[p]]) * (pptgrow_seq^2) * (s-1) +
                         (grow_coef$btempgrow2sex_g[post_draws[p]]) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 * (s-1) 
    
    )
    
    male_f <- invlogit((flow_coef$b0_f[post_draws[p]]) + 
                         (flow_coef$bsize_f[post_draws[p]]) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i]+
                         (flow_coef$bsizesex_f[post_draws[p]]) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i] * (s-1) +
                         (flow_coef$bsex_f[post_draws[p]]) * (s-1) +
                         (flow_coef$bpptgrow_f[post_draws[p]]) * pptgrow_seq +
                         (flow_coef$btempgrow_f[post_draws[p]]) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                         (flow_coef$bpptgrowsex_f[post_draws[p]]) * pptgrow_seq * (s-1) +
                         (flow_coef$btempgrowsex_f[post_draws[p]]) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] * (s-1) +
                         (flow_coef$btempgrowpptgrow_f[post_draws[p]]) * pptgrow_seq * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                         (flow_coef$btempgrowpptgrowsex_f)[post_draws[p]] * pptgrow_seq * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s]  * (s-1) +
                         (flow_coef$bpptgrow2_f[post_draws[p]]) * (pptgrow_seq^2) +
                         (flow_coef$btempgrow2_f[post_draws[p]]) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 +
                         (flow_coef$bpptgrow2sex_f[post_draws[p]]) * (pptgrow_seq^2) * (s-1) +
                         (flow_coef$btempgrow2sex_f[post_draws[p]]) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 * (s-1) 
    )
    
    
     male_p <- exp((panic_coef$b0_p[post_draws[p]]) + 
                         (panic_coef$bsize_p[post_draws[p]]) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i]+
                         (panic_coef$bsizesex_p[post_draws[p]]) * flow_mean_sizes$size[grow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i] * (s-1) +
                         (panic_coef$bsex_p[post_draws[p]]) * (s-1) +
                         (panic_coef$bpptgrow_p[post_draws[p]]) * pptgrow_seq +
                         (panic_coef$btempgrow_p[post_draws[p]]) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                         (panic_coef$bpptgrowsex_p[post_draws[p]]) * pptgrow_seq * (s-1) +
                         (panic_coef$btempgrowsex_p[post_draws[p]]) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] * (s-1) +
                         (panic_coef$btempgrowpptgrow_p[post_draws[p]]) * pptgrow_seq * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                         (panic_coef$btempgrowpptgrowsex_p[post_draws[p]]) * pptgrow_seq * grow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s]  * (s-1) +
                         (panic_coef$bpptgrow2_p[post_draws[p]]) * (pptgrow_seq^2) +
                         (panic_coef$btempgrow2_p[post_draws[p]]) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 +
                         (panic_coef$bpptgrow2sex_p[post_draws[p]]) * (pptgrow_seq^2) * (s-1) +
                         (panic_coef$btempgrow2sex_p[post_draws[p]]) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 * (s-1) 
    )
    
    surv_sex_diff_post[i,,p] <-  fem_s-male_s
    grow_sex_diff_post[i,,p] <-  fem_g-male_g
    flow_sex_diff_post[i,,p] <-  fem_f-male_f
    panic_sex_diff_post[i,,p] <-  fem_p-male_p
  }
}

```

```{r}
#define quantiles of posterior samples
sex_diff_surv_mean <- sex_diff_grow_mean <- sex_diff_flow_mean <- sex_diff_panic_mean <- matrix(NA,size_bin_num,length(pptgrow_seq))
sex_diff_surv_95 <- sex_diff_surv_75 <- sex_diff_surv_50 <- sex_diff_surv_25 <- array(NA,dim=c(size_bin_num,length(pptgrow_seq),2))
sex_diff_grow_95 <- sex_diff_grow_75 <- sex_diff_grow_50 <- sex_diff_grow_25 <- array(NA,dim=c(size_bin_num,length(pptgrow_seq),2))
sex_diff_flow_95 <- sex_diff_flow_75 <- sex_diff_flow_50 <- sex_diff_flow_25 <- array(NA,dim=c(size_bin_num,length(pptgrow_seq),2))
sex_diff_panic_95 <- sex_diff_panic_75 <- sex_diff_panic_50 <- sex_diff_panic_25 <- array(NA,dim=c(size_bin_num,length(pptgrow_seq),2))
for(s in 1:size_bin_num){
  for(l in 1:length(pptgrow_seq)){
    sex_diff_surv_mean[s,l] <- mean(surv_sex_diff_post[s,l,])
    sex_diff_surv_95[s,l,] <- quantile(surv_sex_diff_post[s,l,],probs=c(0.025,0.975))
    sex_diff_surv_75[s,l,] <- quantile(surv_sex_diff_post[s,l,],probs=c(0.125,0.875))
    sex_diff_surv_50[s,l,] <- quantile(surv_sex_diff_post[s,l,],probs=c(0.25,0.75))
    sex_diff_surv_25[s,l,] <- quantile(surv_sex_diff_post[s,l,],probs=c(0.375,0.625))
    
    sex_diff_grow_mean[s,l] <- mean(grow_sex_diff_post[s,l,])
    sex_diff_grow_95[s,l,] <- quantile(grow_sex_diff_post[s,l,],probs=c(0.025,0.975))
    sex_diff_grow_75[s,l,] <- quantile(grow_sex_diff_post[s,l,],probs=c(0.125,0.875))
    sex_diff_grow_50[s,l,] <- quantile(grow_sex_diff_post[s,l,],probs=c(0.25,0.75))
    sex_diff_grow_25[s,l,] <- quantile(grow_sex_diff_post[s,l,],probs=c(0.375,0.625))
    
    sex_diff_flow_mean[s,l] <- mean(flow_sex_diff_post[s,l,])
    sex_diff_flow_95[s,l,] <- quantile(flow_sex_diff_post[s,l,],probs=c(0.025,0.975))
    sex_diff_flow_75[s,l,] <- quantile(flow_sex_diff_post[s,l,],probs=c(0.125,0.875))
    sex_diff_flow_50[s,l,] <- quantile(flow_sex_diff_post[s,l,],probs=c(0.25,0.75))
    sex_diff_flow_25[s,l,] <- quantile(flow_sex_diff_post[s,l,],probs=c(0.375,0.625))
    
    sex_diff_panic_mean[s,l] <- mean(panic_sex_diff_post[s,l,])
    sex_diff_panic_95[s,l,] <- quantile(panic_sex_diff_post[s,l,],probs=c(0.025,0.975))
    sex_diff_panic_75[s,l,] <- quantile(panic_sex_diff_post[s,l,],probs=c(0.125,0.875))
    sex_diff_panic_50[s,l,] <- quantile(panic_sex_diff_post[s,l,],probs=c(0.25,0.75))
    sex_diff_panic_25[s,l,] <- quantile(panic_sex_diff_post[s,l,],probs=c(0.375,0.625))
    
  }
}
```

```{r}
# set up figure
sex_cols <- RColorBrewer::brewer.pal(8, "Dark2")[c(2,1)]
# sex_cols <- c("black","white")
sex_lty <- c(1,1)
bin_shapes <- 15:17
diff_col <- "darkgrey"#"dodgerblue"#"black"
diff_alpha <- 0.35

layout.matrix <- rbind(matrix(1:6, nrow = 2, ncol = 3, byrow = F),
                       matrix(7:12, nrow = 2, ncol = 3, byrow = F),
                       matrix(13:18, nrow = 2, ncol = 3, byrow = F),
                       matrix(19:24, nrow = 2, ncol = 3, byrow = F))
#print figure
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/vital_rates_grow.pdf",height = 14,width = 10,useDingbats = F)
layout(mat = layout.matrix,
       heights = rep(c(2, 1),4), # Heights of the two rows
       widths = c(2, 2, 2))
#layout.show(24)

par(oma=c(3,1,0.5,0.5))
with(poar_surv_binned,{
  for(i in 1:size_bin_num){
    par(mar=c(0,4,1,0))
    plot(pptgrow[size_bin==i],mean_surv[size_bin==i],type="n",ylim=c(0,1),
         xlab=" ",ylab=" ",xaxt="n");box()
    if(i==1){mtext("Pr(survival)",side=2,line=3,cex=1.3)}
    title(LETTERS[i],adj=0)
    for(s in 1:2){
      points(pptgrow[Sex==s & size_bin==i],mean_surv[Sex==s & size_bin==i],
             bg=sex_cols[s],pch=21,cex=5*(bin_n/max(bin_n)),lwd=2)
      lines(pptgrow_seq,invlogit(mean(surv_coef$b0_s) + 
                         mean(surv_coef$bsize_s) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i]+
                         mean(surv_coef$bsizesex_s) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i] * (s-1) +
                         mean(surv_coef$bsex_s) * (s-1) +
                         mean(surv_coef$bpptgrow_s) * pptgrow_seq +
                         mean(surv_coef$btempgrow_s) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                         mean(surv_coef$bpptgrowsex_s) * pptgrow_seq * (s-1) +
                         mean(surv_coef$btempgrowsex_s) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * (s-1) +
                         mean(surv_coef$btempgrowpptgrow_s) * pptgrow_seq * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                         mean(surv_coef$btempgrowpptgrowsex_s) * pptgrow_seq * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s]  * (s-1) +
                         mean(surv_coef$bpptgrow2_s) * (pptgrow_seq^2) +
                         mean(surv_coef$btempgrow2_s) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 +
                         mean(surv_coef$bpptgrow2sex_s) * (pptgrow_seq^2) * (s-1) +
                         mean(surv_coef$btempgrow2sex_s) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 * (s-1) 
    ),lty=sex_lty[s],lwd=3,col= sex_cols[s])
    }
    par(mar=c(2,4,0.5,0))
    plot(pptgrow_seq ,sex_diff_surv_mean[i,],type="n",lwd=4,yaxt="n",
         xlab=" ",ylab=" ",xaxt="n",ylim=c(min(sex_diff_surv_95[i,,1]),max(sex_diff_surv_95[i,,2])))
    if(i==1){mtext(expression(paste(Delta," (F-M)")),side=2,line=2,cex=1.3)}
    polygon(x=c(pptgrow_seq,rev(pptgrow_seq )),
            y=c(sex_diff_surv_95[i,,1],rev(sex_diff_surv_95[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptgrow_seq ,rev(pptgrow_seq )),
            y=c(sex_diff_surv_75[i,,1],rev(sex_diff_surv_75[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptgrow_seq,rev(pptgrow_seq)),
            y=c(sex_diff_surv_50[i,,1],rev(sex_diff_surv_50[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptgrow_seq ,rev(pptgrow_seq)),
            y=c(sex_diff_surv_25[i,,1],rev(sex_diff_surv_25[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    lines(pptgrow_seq ,sex_diff_surv_mean[i,],lwd=2,col="black")
    abline(h=0,lty=2)
    mtext("0",side=2,at=0)
  }
})

with(poar_grow_binned,{
  for(i in 1:size_bin_num){
    par(mar=c(0,4,1,0))
    plot(pptgrow[size_bin==i] ,mean_grow[size_bin==i],type="n",
         xlab=" ",ylab=" ",xaxt="n");box()    
    if(i==1){mtext("#tillers",side=2,line=3,cex=1.3)}
    title(LETTERS[i+3],adj=0)    
    for(s in 1:2){
      points(pptgrow[Sex==s & size_bin==i] ,mean_grow[Sex==s & size_bin==i],
             bg=sex_cols[s],pch=21,cex=2*(bin_n/max(bin_n)),lwd=2)
      lines(pptgrow_seq ,
            exp(mean(grow_coef$b0_g) + 
                         mean(grow_coef$bsize_g) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i]+
                         mean(grow_coef$bsizesex_g) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i] * (s-1) +
                         mean(grow_coef$bsex_g) * (s-1) +
                         mean(grow_coef$bpptgrow_g) * pptgrow_seq +
                         mean(grow_coef$btempgrow_g) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                         mean(grow_coef$bpptgrowsex_g) * pptgrow_seq * (s-1) +
                         mean(grow_coef$btempgrowsex_g) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] * (s-1) +
                         mean(grow_coef$btempgrowpptgrow_g) * pptgrow_seq * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                         mean(grow_coef$btempgrowpptgrowsex_g) * pptgrow_seq * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s]  * (s-1) +
                         mean(grow_coef$bpptgrow2_g) * (pptgrow_seq^2) +
                         mean(grow_coef$btempgrow2_g) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 +
                         mean(grow_coef$bpptgrow2sex_g) * (pptgrow_seq^2) * (s-1) +
                         mean(grow_coef$btempgrow2sex_g) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 * (s-1) 
    
    ),lty=sex_lty[s],lwd=3,col= sex_cols[s])
    }
    par(mar=c(2,4,0.5,0))
    plot(pptgrow_seq ,sex_diff_grow_mean[i,],type="n",lwd=4,yaxt="n",
         xlab=" ",ylab=" ",xaxt="n",ylim=c(min(sex_diff_grow_95[i,,1]),max(sex_diff_grow_95[i,,2])))
    if(i==1){mtext(expression(paste(Delta," (F-M)")),side=2,line=2,cex=1.3)}
    polygon(x=c(pptgrow_seq,rev(pptgrow_seq )),
            y=c(sex_diff_grow_95[i,,1],rev(sex_diff_grow_95[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptgrow_seq ,rev(pptgrow_seq)),
            y=c(sex_diff_grow_75[i,,1],rev(sex_diff_grow_75[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptgrow_seq ,rev(pptgrow_seq )),
            y=c(sex_diff_grow_50[i,,1],rev(sex_diff_grow_50[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptgrow_seq ,rev(pptgrow_seq)),
            y=c(sex_diff_grow_25[i,,1],rev(sex_diff_grow_25[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    lines(pptgrow_seq ,sex_diff_grow_mean[i,],lwd=2,col="black")
    abline(h=0,lty=2)
    mtext("0",side=2,at=0)
  }
})


with(poar_flow_binned,{
  for(i in 1:size_bin_num){
    par(mar=c(0,4,1,0))
    plot(pptgrow[size_bin==i] ,mean_flow[size_bin==i],type="n",
         xlab=" ",ylab=" ",xaxt="n");box()
    if(i==1){mtext("Pr(flowering)",side=2,line=3,cex=1.3)}
    title(LETTERS[i+6],adj=0)    
    for(s in 1:2){
      points(pptgrow[Sex==s & size_bin==i],mean_flow[Sex==s & size_bin==i],
             bg=sex_cols[s],pch=21,cex=2*(bin_n/max(bin_n)),lwd=2)
      lines(pptgrow_seq ,invlogit(mean(flow_coef$b0_f) + 
                         mean(flow_coef$bsize_f) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i]+
                         mean(flow_coef$bsizesex_f) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i] * (s-1) +
                         mean(flow_coef$bsex_f) * (s-1) +
                         mean(flow_coef$bpptgrow_f) * pptgrow_seq +
                         mean(flow_coef$btempgrow_f) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                         mean(flow_coef$bpptgrowsex_f) * pptgrow_seq * (s-1) +
                         mean(flow_coef$btempgrowsex_f) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] * (s-1) +
                         mean(flow_coef$btempgrowpptgrow_f) * pptgrow_seq * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                         mean(flow_coef$btempgrowpptgrowsex_f) * pptgrow_seq * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s]  * (s-1) +
                         mean(flow_coef$bpptgrow2_f) * (pptgrow_seq^2) +
                         mean(flow_coef$btempgrow2_f) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 +
                         mean(flow_coef$bpptgrow2sex_f) * (pptgrow_seq^2) * (s-1) +
                         mean(flow_coef$btempgrow2sex_f) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 * (s-1) 
    ) ,lty=sex_lty[s],lwd=3,col= sex_cols[s])
    }
    par(mar=c(2,4,0.5,0))
    plot(pptgrow_seq ,sex_diff_flow_mean[i,],type="n",lwd=4,yaxt="n",
         xlab=" ",ylab=" ",xaxt="n",ylim=c(min(sex_diff_flow_95[i,,1]),max(sex_diff_flow_95[i,,2])))
    if(i==1){mtext(expression(paste(Delta," (F-M)")),side=2,line=2,cex=1.3)}
    polygon(x=c(pptgrow_seq ,rev(pptgrow_seq )),
            y=c(sex_diff_flow_95[i,,1],rev(sex_diff_flow_95[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptgrow_seq ,rev(pptgrow_seq )),
            y=c(sex_diff_flow_75[i,,1],rev(sex_diff_flow_75[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptgrow_seq ,rev(pptgrow_seq)),
            y=c(sex_diff_flow_50[i,,1],rev(sex_diff_flow_50[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptgrow_seq ,rev(pptgrow_seq)),
            y=c(sex_diff_flow_25[i,,1],rev(sex_diff_flow_25[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    lines(pptgrow_seq ,sex_diff_flow_mean[i,],lwd=2,col="black")
    abline(h=0,lty=2)
    mtext("0",side=2,at=0)
  }
})


with(poar_panic_binned,{
  for(i in 1:size_bin_num){
    par(mar=c(0,4,1,0))
    plot(pptgrow[size_bin==i] ,mean_panic[size_bin==i],type="n",
         xlab=" ",ylab=" ",xaxt="n",ylim=c(0,max(mean_panic[size_bin==i])));box()    
    if(i==1){mtext("#panicles",side=2,line=3,cex=1.3)}
    title(LETTERS[i+9],adj=0)    
    for(s in 1:2){
      points(pptgrow[Sex==s & size_bin==i],mean_panic[Sex==s & size_bin==i],
             bg=sex_cols[s],pch=21,cex=5*(bin_n/max(bin_n)),lwd=2)
      lines(pptgrow_seq, exp(mean(panic_coef$b0_p) + 
                         mean(panic_coef$bsize_p) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i]+
                         mean(panic_coef$bsizesex_p) * flow_mean_sizes$size[grow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i] * (s-1) +
                         mean(panic_coef$bsex_p) * (s-1) +
                         mean(panic_coef$bpptgrow_p) * pptgrow_seq +
                         mean(panic_coef$btempgrow_p) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                         mean(panic_coef$bpptgrowsex_p) * pptgrow_seq * (s-1) +
                         mean(panic_coef$btempgrowsex_p) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] * (s-1) +
                         mean(panic_coef$btempgrowpptgrow_p) * pptgrow_seq * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                         mean(panic_coef$btempgrowpptgrowsex_p) * pptgrow_seq * grow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s]  * (s-1) +
                         mean(panic_coef$bpptgrow2_p) * (pptgrow_seq^2) +
                         mean(panic_coef$btempgrow2_p) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 +
                         mean(panic_coef$bpptgrow2sex_p) * (pptgrow_seq^2) * (s-1) +
                         mean(panic_coef$btempgrow2sex_p) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 * (s-1) 
    ) ,lty=sex_lty[s],lwd=3,col= sex_cols[s])
    }
    par(mar=c(2,4,0.5,0))
    plot(pptgrow_seq ,sex_diff_panic_mean[i,],type="n",lwd=4,yaxt="n",
         xlab=" ",ylab=" ",ylim=c(min(sex_diff_panic_95[i,,1]),max(sex_diff_panic_95[i,,2])))
    if(i==1){mtext(expression(paste(Delta," (F-M)")),side=2,line=2,cex=1.3)}
    mtext("Precipitation (grow season)",side=1,line=3,cex=1.3)
    polygon(x=c(pptgrow_seq ,rev(pptgrow_seq )),
            y=c(sex_diff_panic_95[i,,1],rev(sex_diff_panic_95[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptgrow_seq ,rev(pptgrow_seq )),
            y=c(sex_diff_panic_75[i,,1],rev(sex_diff_panic_75[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptgrow_seq ,rev(pptgrow_seq )),
            y=c(sex_diff_panic_50[i,,1],rev(sex_diff_panic_50[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(pptgrow_seq ,rev(pptgrow_seq )),
            y=c(sex_diff_panic_25[i,,1],rev(sex_diff_panic_25[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    lines(pptgrow_seq ,sex_diff_panic_mean[i,],lwd=2,col="black")
    abline(h=0,lty=2)
    mtext("0",side=2,at=0)
  }
})
dev.off()


```

## Temperature of the growing season
```{r}
# sample vital rate functions from the join posterior
# pptgrow_seq <- seq(min(poar_surv_binned$pptgrow),max(poar_surv_binned$pptgrow),length.out=50)
tempgrow_seq <- seq(min(poar_surv_binned$tempgrow),max(poar_surv_binned$tempgrow),length.out=50)
# pptdorm_seq <- seq(min(poar_surv_binned$pptdorm),max(poar_surv_binned$pptdorm),0.1)
# tempdorm_seq <- seq(min(poar_surv_binned$tempdorm),max(poar_surv_binned$tempdorm),0.1)
size_bin_num<-1
n_post_draws <- 500
post_draws <- sample.int(length(surv_coef$b0_s), n_post_draws)
surv_sex_diff_post <- grow_sex_diff_post <- flow_sex_diff_post <- panic_sex_diff_post <- array(NA,dim=c(size_bin_num,length(tempgrow_seq),n_post_draws))
for(p in 1:n_post_draws){
  for(i in 1:size_bin_num){
    s=1;      
    fem_s <-invlogit((surv_coef$b0_s[post_draws[p]]) +
                        (surv_coef$bsize_s[post_draws[p]]) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i] +
                        (surv_coef$bsizesex_s[post_draws[p]]) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i] * (s-1) +
                        (surv_coef$bsex_s[post_draws[p]]) * (s-1) +
                        (surv_coef$bpptgrow_s[post_draws[p]]) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s]  +
                        (surv_coef$btempgrow_s[post_draws[p]]) * tempgrow_seq +
                        (surv_coef$bpptgrowsex_s[post_draws[p]]) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * (s-1) +
                        (surv_coef$btempgrowpptgrow_s[post_draws[p]]) * tempgrow_seq * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] +
                        (surv_coef$btempgrowsex_s[post_draws[p]]) * tempgrow_seq * (s-1) +
                        (surv_coef$btempgrowpptgrowsex_s[post_draws[p]]) * tempgrow_seq * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s]  * (s-1) +
                        (surv_coef$bpptgrow2_s[post_draws[p]]) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 +
                        (surv_coef$btempgrow2_s[post_draws[p]]) * (tempgrow_seq^2) +
                        (surv_coef$bpptgrow2sex_s[post_draws[p]]) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 * (s-1) +
                        (surv_coef$btempgrow2sex_s[post_draws[p]]) * (tempgrow_seq^2) * (s-1) )
    
    fem_g <- exp((grow_coef$b0_g[post_draws[p]]) +
                        (grow_coef$bsize_g[post_draws[p]]) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i] +
                        (grow_coef$bsizesex_g[post_draws[p]]) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i] * (s-1) +
                        (grow_coef$bsex_g[post_draws[p]]) * (s-1) +
                        (grow_coef$bpptgrow_g[post_draws[p]]) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s]  +
                        (grow_coef$btempgrow_g[post_draws[p]]) * tempgrow_seq +
                        (grow_coef$bpptgrowsex_g[post_draws[p]]) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * (s-1) +
                        (grow_coef$btempgrowpptgrow_g[post_draws[p]]) * tempgrow_seq * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] +
                        (grow_coef$btempgrowsex_g[post_draws[p]]) * tempgrow_seq * (s-1) +
                        (grow_coef$btempgrowpptgrowsex_g[post_draws[p]]) * tempgrow_seq * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s]  * (s-1) +
                        (grow_coef$bpptgrow2_g[post_draws[p]]) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 +
                        (grow_coef$btempgrow2_g[post_draws[p]]) * (tempgrow_seq^2) +
                        (grow_coef$bpptgrow2sex_g[post_draws[p]]) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 * (s-1) +
                        (grow_coef$btempgrow2sex_g[post_draws[p]]) * (tempgrow_seq^2) * (s-1) )
    fem_f <- invlogit((flow_coef$b0_f[post_draws[p]]) +
                        (flow_coef$bsize_f[post_draws[p]]) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i] +
                        (flow_coef$bsizesex_f[post_draws[p]]) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i] * (s-1) +
                        (flow_coef$bsex_f[post_draws[p]]) * (s-1) +
                        (flow_coef$bpptgrow_f[post_draws[p]]) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s]  +
                        (flow_coef$btempgrow_f[post_draws[p]]) * tempgrow_seq +
                        (flow_coef$bpptgrowsex_f[post_draws[p]]) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] * (s-1) +
                        (flow_coef$btempgrowsex_f[post_draws[p]]) * tempgrow_seq * (s-1) +
                        (flow_coef$btempgrowpptgrow_f[post_draws[p]]) * tempgrow_seq * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s]   +
                        (flow_coef$btempgrowpptgrowsex_f[post_draws[p]]) * tempgrow_seq * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s]  * (s-1) +
                        (flow_coef$bpptgrow2_f[post_draws[p]]) * (flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s])^2 +
                        (flow_coef$btempgrow2_f[post_draws[p]]) * (tempgrow_seq^2) +
                        (flow_coef$bpptgrow2sex_f[post_draws[p]]) * (flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s])^2 * (s-1) +
                        (flow_coef$btempgrow2sex_f[post_draws[p]]) * (tempgrow_seq^2) * (s-1) )
    
    
     fem_p <- exp((panic_coef$b0_p[post_draws[p]]) +
                        (panic_coef$bsize_p[post_draws[p]]) * panic_mean_sizes$size[panic_mean_sizes$Sex==s & panic_mean_sizes$size_bin==i] +
                        (panic_coef$bsizesex_p[post_draws[p]]) * panic_mean_sizes$size[panic_mean_sizes$Sex==s & panic_mean_sizes$size_bin==i] * (s-1) +
                        (panic_coef$bsex_p[post_draws[p]]) * (s-1) +
                        (panic_coef$bpptgrow_p[post_draws[p]]) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s]+
                        (panic_coef$btempgrow_p[post_draws[p]]) * tempgrow_seq +
                        (panic_coef$bpptgrowsex_p[post_draws[p]]) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s] * (s-1) +
                        (panic_coef$btempgrowsex_p[post_draws[p]]) * tempgrow_seq * (s-1) +
                        (panic_coef$btempgrowpptgrow_p[post_draws[p]]) * tempgrow_seq * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s]   +
                        (panic_coef$btempgrowpptgrowsex_p[post_draws[p]]) * tempgrow_seq * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s]  * (s-1) +
                        (panic_coef$bpptgrow2_p[post_draws[p]]) * (panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s])^2 +
                        (panic_coef$btempgrow2_p[post_draws[p]]) * (tempgrow_seq^2) +
                        (panic_coef$bpptgrow2sex_p[post_draws[p]]) * (panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s])^2 * (s-1) +
                        (panic_coef$btempgrow2sex_p[post_draws[p]]) * (tempgrow_seq^2) * (s-1)  )
    
    s=2;       
   male_s <-invlogit((surv_coef$b0_s[post_draws[p]]) +
                        (surv_coef$bsize_s[post_draws[p]]) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i] +
                        (surv_coef$bsizesex_s[post_draws[p]]) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i] * (s-1) +
                        (surv_coef$bsex_s[post_draws[p]]) * (s-1) +
                        (surv_coef$bpptgrow_s[post_draws[p]]) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s]  +
                        (surv_coef$btempgrow_s[post_draws[p]]) * tempgrow_seq +
                        (surv_coef$bpptgrowsex_s[post_draws[p]]) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * (s-1) +
                        (surv_coef$btempgrowpptgrow_s[post_draws[p]]) * tempgrow_seq * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] +
                        (surv_coef$btempgrowsex_s[post_draws[p]]) * tempgrow_seq * (s-1) +
                        (surv_coef$btempgrowpptgrowsex_s[post_draws[p]]) * tempgrow_seq * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s]  * (s-1) +
                        (surv_coef$bpptgrow2_s[post_draws[p]]) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 +
                        (surv_coef$btempgrow2_s[post_draws[p]]) * (tempgrow_seq^2) +
                        (surv_coef$bpptgrow2sex_s[post_draws[p]]) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 * (s-1) +              (surv_coef$btempgrow2sex_s[post_draws[p]]) * (tempgrow_seq^2) * (s-1) )
    
    male_g <- exp((grow_coef$b0_g[post_draws[p]]) +
                        (grow_coef$bsize_g[post_draws[p]]) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i] +
                        (grow_coef$bsizesex_g[post_draws[p]]) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i] * (s-1) +
                        (grow_coef$bsex_g[post_draws[p]]) * (s-1) +
                        (grow_coef$bpptgrow_g[post_draws[p]]) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s]  +
                        (grow_coef$btempgrow_g[post_draws[p]]) * tempgrow_seq +
                        (grow_coef$bpptgrowsex_g[post_draws[p]]) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * (s-1) +
                        (grow_coef$btempgrowpptgrow_g[post_draws[p]]) * tempgrow_seq * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] +
                        (grow_coef$btempgrowsex_g[post_draws[p]]) * tempgrow_seq * (s-1) +
                        (grow_coef$btempgrowpptgrowsex_g[post_draws[p]]) * tempgrow_seq * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s]  * (s-1) +
                        (grow_coef$bpptgrow2_g[post_draws[p]]) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 +
                        (grow_coef$btempgrow2_g[post_draws[p]]) * (tempgrow_seq^2) +
                        (grow_coef$bpptgrow2sex_g[post_draws[p]]) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 * (s-1) +
                        (grow_coef$btempgrow2sex_g[post_draws[p]]) * (tempgrow_seq^2) * (s-1) )
    male_f <- invlogit((flow_coef$b0_f[post_draws[p]]) +
                        (flow_coef$bsize_f[post_draws[p]]) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i] +
                        (flow_coef$bsizesex_f[post_draws[p]]) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i] * (s-1) +
                        (flow_coef$bsex_f[post_draws[p]]) * (s-1) +
                        (flow_coef$bpptgrow_f[post_draws[p]]) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s]  +
                        (flow_coef$btempgrow_f[post_draws[p]]) * tempgrow_seq +
                        (flow_coef$bpptgrowsex_f[post_draws[p]]) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] * (s-1) +
                        (flow_coef$btempgrowsex_f[post_draws[p]]) * tempgrow_seq * (s-1) +
                        (flow_coef$btempgrowpptgrow_f[post_draws[p]]) * tempgrow_seq * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s]   +
                        (flow_coef$btempgrowpptgrowsex_f[post_draws[p]]) * tempgrow_seq * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s]  * (s-1) +
                        (flow_coef$bpptgrow2_f[post_draws[p]]) * (flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s])^2 +
                        (flow_coef$btempgrow2_f[post_draws[p]]) * (tempgrow_seq^2) +
                        (flow_coef$bpptgrow2sex_f[post_draws[p]]) * (flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s])^2 * (s-1) +
                        (flow_coef$btempgrow2sex_f[post_draws[p]]) * (tempgrow_seq^2) * (s-1))
    
     male_p <- exp((panic_coef$b0_p[post_draws[p]]) +
                        (panic_coef$bsize_p[post_draws[p]]) * panic_mean_sizes$size[panic_mean_sizes$Sex==s & panic_mean_sizes$size_bin==i] +
                        (panic_coef$bsizesex_p[post_draws[p]]) * panic_mean_sizes$size[panic_mean_sizes$Sex==s & panic_mean_sizes$size_bin==i] * (s-1) +
                        (panic_coef$bsex_p[post_draws[p]]) * (s-1) +
                        (panic_coef$bpptgrow_p[post_draws[p]]) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s]  +
                        (panic_coef$btempgrow_p[post_draws[p]]) * tempgrow_seq +
                        (panic_coef$bpptgrowsex_p[post_draws[p]]) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s] * (s-1) +
                        (panic_coef$btempgrowsex_p[post_draws[p]]) * tempgrow_seq * (s-1) +
                        (panic_coef$btempgrowpptgrow_p[post_draws[p]]) * tempgrow_seq * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s]   +
                        (panic_coef$btempgrowpptgrowsex_p[post_draws[p]]) * tempgrow_seq * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s]  * (s-1) +
                        (panic_coef$bpptgrow2_p[post_draws[p]]) * (panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s])^2 +
                        (panic_coef$btempgrow2_p[post_draws[p]]) * (tempgrow_seq^2) +
                        (panic_coef$bpptgrow2sex_p[post_draws[p]]) * (panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s])^2 * (s-1) +
                        (panic_coef$btempgrow2sex_p[post_draws[p]]) * (tempgrow_seq^2) * (s-1) )
    surv_sex_diff_post[i,,p] <-  fem_s-male_s
    grow_sex_diff_post[i,,p] <-  fem_g-male_g
    flow_sex_diff_post[i,,p] <-  fem_f-male_f
    panic_sex_diff_post[i,,p] <-  fem_p-male_p
  }
}

```

```{r}
#define quantiles of posterior samples
sex_diff_surv_mean <- sex_diff_grow_mean <- sex_diff_flow_mean <- sex_diff_panic_mean <- matrix(NA,size_bin_num,length(pptgrow_seq))
sex_diff_surv_95 <- sex_diff_surv_75 <- sex_diff_surv_50 <- sex_diff_surv_25 <- array(NA,dim=c(size_bin_num,length(pptgrow_seq),2))
sex_diff_grow_95 <- sex_diff_grow_75 <- sex_diff_grow_50 <- sex_diff_grow_25 <- array(NA,dim=c(size_bin_num,length(pptgrow_seq),2))
sex_diff_flow_95 <- sex_diff_flow_75 <- sex_diff_flow_50 <- sex_diff_flow_25 <- array(NA,dim=c(size_bin_num,length(pptgrow_seq),2))
sex_diff_panic_95 <- sex_diff_panic_75 <- sex_diff_panic_50 <- sex_diff_panic_25 <- array(NA,dim=c(size_bin_num,length(pptgrow_seq),2))
for(s in 1:size_bin_num){
  for(l in 1:length(pptgrow_seq)){
    sex_diff_surv_mean[s,l] <- mean(surv_sex_diff_post[s,l,])
    sex_diff_surv_95[s,l,] <- quantile(surv_sex_diff_post[s,l,],probs=c(0.025,0.975))
    sex_diff_surv_75[s,l,] <- quantile(surv_sex_diff_post[s,l,],probs=c(0.125,0.875))
    sex_diff_surv_50[s,l,] <- quantile(surv_sex_diff_post[s,l,],probs=c(0.25,0.75))
    sex_diff_surv_25[s,l,] <- quantile(surv_sex_diff_post[s,l,],probs=c(0.375,0.625))
    
    sex_diff_grow_mean[s,l] <- mean(grow_sex_diff_post[s,l,])
    sex_diff_grow_95[s,l,] <- quantile(grow_sex_diff_post[s,l,],probs=c(0.025,0.975))
    sex_diff_grow_75[s,l,] <- quantile(grow_sex_diff_post[s,l,],probs=c(0.125,0.875))
    sex_diff_grow_50[s,l,] <- quantile(grow_sex_diff_post[s,l,],probs=c(0.25,0.75))
    sex_diff_grow_25[s,l,] <- quantile(grow_sex_diff_post[s,l,],probs=c(0.375,0.625))
    
    sex_diff_flow_mean[s,l] <- mean(flow_sex_diff_post[s,l,])
    sex_diff_flow_95[s,l,] <- quantile(flow_sex_diff_post[s,l,],probs=c(0.025,0.975))
    sex_diff_flow_75[s,l,] <- quantile(flow_sex_diff_post[s,l,],probs=c(0.125,0.875))
    sex_diff_flow_50[s,l,] <- quantile(flow_sex_diff_post[s,l,],probs=c(0.25,0.75))
    sex_diff_flow_25[s,l,] <- quantile(flow_sex_diff_post[s,l,],probs=c(0.375,0.625))
    
    sex_diff_panic_mean[s,l] <- mean(panic_sex_diff_post[s,l,])
    sex_diff_panic_95[s,l,] <- quantile(panic_sex_diff_post[s,l,],probs=c(0.025,0.975))
    sex_diff_panic_75[s,l,] <- quantile(panic_sex_diff_post[s,l,],probs=c(0.125,0.875))
    sex_diff_panic_50[s,l,] <- quantile(panic_sex_diff_post[s,l,],probs=c(0.25,0.75))
    sex_diff_panic_25[s,l,] <- quantile(panic_sex_diff_post[s,l,],probs=c(0.375,0.625))
    
  }
}
```

```{r}
# set up figure
sex_cols <- RColorBrewer::brewer.pal(8, "Dark2")[c(2,1)]
# sex_cols <- c("black","white")
sex_lty <- c(1,1)
bin_shapes <- 15:17
diff_col <- "darkgrey"#"dodgerblue"#"black"
diff_alpha <- 0.35

layout.matrix <- rbind(matrix(1:6, nrow = 2, ncol = 3, byrow = F),
                       matrix(7:12, nrow = 2, ncol = 3, byrow = F),
                       matrix(13:18, nrow = 2, ncol = 3, byrow = F),
                       matrix(19:24, nrow = 2, ncol = 3, byrow = F))
#print figure
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Manuscript/Figures/vital_rates_tempgrow.pdf",height = 14,width = 10,useDingbats = F)
layout(mat = layout.matrix,
       heights = rep(c(2, 1),4), # Heights of the two rows
       widths = c(2, 2, 2))
#layout.show(24)

par(oma=c(3,1,0.5,0.5))
with(poar_surv_binned,{
  for(i in 1:size_bin_num){
    par(mar=c(0,4,1,0))
    plot(tempgrow[size_bin==i],mean_surv[size_bin==i],type="n",ylim=c(0,1),
         xlab=" ",ylab=" ",xaxt="n");box()
    if(i==1){mtext("Pr(survival)",side=2,line=3,cex=1.3)}
    title(LETTERS[i],adj=0)
    for(s in 1:2){
      points(tempgrow[Sex==s & size_bin==i],mean_surv[Sex==s & size_bin==i],
             bg=sex_cols[s],pch=21,cex=5*(bin_n/max(bin_n)),lwd=2)
      lines(tempgrow_seq,invlogit(mean(surv_coef$b0_s) +
                        mean(surv_coef$bsize_s) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i] +
                        mean(surv_coef$bsizesex_s) * surv_mean_sizes$size[surv_mean_sizes$Sex==s & surv_mean_sizes$size_bin==i] * (s-1) +
                        mean(surv_coef$bsex_s) * (s-1) +
                        mean(surv_coef$bpptgrow_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s]  +
                        mean(surv_coef$btempgrow_s) * tempgrow_seq +
                        mean(surv_coef$bpptgrowsex_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * (s-1) +
                        mean(surv_coef$btempgrowpptgrow_s) * tempgrow_seq * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] +
                        mean(surv_coef$btempgrowsex_s) * tempgrow_seq * (s-1) +
                        mean(surv_coef$btempgrowpptgrowsex_s) * tempgrow_seq * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s]  * (s-1) +
                        mean(surv_coef$bpptgrow2_s) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 +
                        mean(surv_coef$btempgrow2_s) * (tempgrow_seq^2) +
                        mean(surv_coef$bpptgrow2sex_s) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 * (s-1) +
                        mean(surv_coef$btempgrow2sex_s) * (tempgrow_seq^2) * (s-1) 
    ),lty=sex_lty[s],lwd=3,col= sex_cols[s])
    }
    par(mar=c(2,4,0.5,0))
    plot(tempgrow_seq ,sex_diff_surv_mean[i,],type="n",lwd=4,yaxt="n",
         xlab=" ",ylab=" ",xaxt="n",ylim=c(min(sex_diff_surv_95[i,,1]),max(sex_diff_surv_95[i,,2])))
    if(i==1){mtext(expression(paste(Delta," (F-M)")),side=2,line=2,cex=1.3)}
    polygon(x=c(tempgrow_seq,rev(tempgrow_seq )),
            y=c(sex_diff_surv_95[i,,1],rev(sex_diff_surv_95[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempgrow_seq ,rev(tempgrow_seq )),
            y=c(sex_diff_surv_75[i,,1],rev(sex_diff_surv_75[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempgrow_seq,rev(tempgrow_seq)),
            y=c(sex_diff_surv_50[i,,1],rev(sex_diff_surv_50[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempgrow_seq ,rev(tempgrow_seq)),
            y=c(sex_diff_surv_25[i,,1],rev(sex_diff_surv_25[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    lines(tempgrow_seq ,sex_diff_surv_mean[i,],lwd=2,col="black")
    abline(h=0,lty=2)
    mtext("0",side=2,at=0)
  }
})

with(poar_grow_binned,{
  for(i in 1:size_bin_num){
    par(mar=c(0,4,1,0))
    plot(tempgrow[size_bin==i] ,mean_grow[size_bin==i],type="n",
         xlab=" ",ylab=" ",xaxt="n");box()    
    if(i==1){mtext("#tillers",side=2,line=3,cex=1.3)}
    title(LETTERS[i+3],adj=0)    
    for(s in 1:2){
      points(tempgrow[Sex==s & size_bin==i] ,mean_grow[Sex==s & size_bin==i],
             bg=sex_cols[s],pch=21,cex=5*(bin_n/max(bin_n)),lwd=2)
      lines(tempgrow_seq ,
            exp(mean(grow_coef$b0_g) +
                        mean(grow_coef$bsize_g) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i] +
                        mean(grow_coef$bsizesex_g) * grow_mean_sizes$size[grow_mean_sizes$Sex==s & grow_mean_sizes$size_bin==i] * (s-1) +
                        mean(grow_coef$bsex_g) * (s-1) +
                        mean(grow_coef$bpptgrow_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s]  +
                        mean(grow_coef$btempgrow_g) * tempgrow_seq +
                        mean(grow_coef$bpptgrowsex_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * (s-1) +
                        mean(grow_coef$btempgrowpptgrow_g) * tempgrow_seq * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] +
                        mean(grow_coef$btempgrowsex_g) * tempgrow_seq * (s-1) +
                        mean(grow_coef$btempgrowpptgrowsex_g) * tempgrow_seq * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s]  * (s-1) +
                        mean(grow_coef$bpptgrow2_g) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 +
                        mean(grow_coef$btempgrow2_g) * (tempgrow_seq^2) +
                        mean(grow_coef$bpptgrow2sex_g) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 * (s-1) +
                        mean(grow_coef$btempgrow2sex_g) * (tempgrow_seq^2) * (s-1) 
    ),lty=sex_lty[s],lwd=3,col= sex_cols[s])
    }
    par(mar=c(2,4,0.5,0))
    plot(tempgrow_seq ,sex_diff_grow_mean[i,],type="n",lwd=4,yaxt="n",
         xlab=" ",ylab=" ",xaxt="n",ylim=c(min(sex_diff_grow_95[i,,1]),max(sex_diff_grow_95[i,,2])))
    if(i==1){mtext(expression(paste(Delta," (F-M)")),side=2,line=2,cex=1.3)}
    polygon(x=c(tempgrow_seq,rev(tempgrow_seq )),
            y=c(sex_diff_grow_95[i,,1],rev(sex_diff_grow_95[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempgrow_seq ,rev(tempgrow_seq)),
            y=c(sex_diff_grow_75[i,,1],rev(sex_diff_grow_75[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempgrow_seq ,rev(tempgrow_seq )),
            y=c(sex_diff_grow_50[i,,1],rev(sex_diff_grow_50[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempgrow_seq ,rev(tempgrow_seq)),
            y=c(sex_diff_grow_25[i,,1],rev(sex_diff_grow_25[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    lines(tempgrow_seq ,sex_diff_grow_mean[i,],lwd=2,col="black")
    abline(h=0,lty=2)
    mtext("0",side=2,at=0)
  }
})


with(poar_flow_binned,{
  for(i in 1:size_bin_num){
    par(mar=c(0,4,1,0))
    plot(tempgrow[size_bin==i] ,mean_flow[size_bin==i],type="n",
         xlab=" ",ylab=" ",xaxt="n");box()
    if(i==1){mtext("Pr(flowering)",side=2,line=3,cex=1.3)}
    title(LETTERS[i+6],adj=0)    
    for(s in 1:2){
      points(tempgrow[Sex==s & size_bin==i],mean_flow[Sex==s & size_bin==i],
             bg=sex_cols[s],pch=21,cex=5*(bin_n/max(bin_n)),lwd=2)
      lines(tempgrow_seq ,invlogit(mean(flow_coef$b0_f) +
                        mean(flow_coef$bsize_f) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i] +
                        mean(flow_coef$bsizesex_f) * flow_mean_sizes$size[flow_mean_sizes$Sex==s & flow_mean_sizes$size_bin==i] * (s-1) +
                        mean(flow_coef$bsex_f) * (s-1) +
                        mean(flow_coef$bpptgrow_f) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s]  +
                        mean(flow_coef$btempgrow_f) * tempgrow_seq +
                        mean(flow_coef$bpptgrowsex_f) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] * (s-1) +
                        mean(flow_coef$btempgrowsex_f) * tempgrow_seq * (s-1) +
                        mean(flow_coef$btempgrowpptgrow_f) * tempgrow_seq * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s]   +
                        mean(flow_coef$btempgrowpptgrowsex_f) * tempgrow_seq * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s]  * (s-1) +
                        mean(flow_coef$bpptgrow2_f) * (flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s])^2 +
                        mean(flow_coef$btempgrow2_f) * (tempgrow_seq^2) +
                        mean(flow_coef$bpptgrow2sex_f) * (flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s])^2 * (s-1) +
                        mean(flow_coef$btempgrow2sex_f) * (tempgrow_seq^2) * (s-1) 
    ) ,lty=sex_lty[s],lwd=3,col= sex_cols[s])
    }
    par(mar=c(2,4,0.5,0))
    plot(tempgrow_seq ,sex_diff_flow_mean[i,],type="n",lwd=4,yaxt="n",
         xlab=" ",ylab=" ",xaxt="n",ylim=c(min(sex_diff_flow_95[i,,1]),max(sex_diff_flow_95[i,,2])))
    if(i==1){mtext(expression(paste(Delta," (F-M)")),side=2,line=2,cex=1.3)}
    polygon(x=c(tempgrow_seq ,rev(tempgrow_seq )),
            y=c(sex_diff_flow_95[i,,1],rev(sex_diff_flow_95[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempgrow_seq ,rev(tempgrow_seq)),
            y=c(sex_diff_flow_75[i,,1],rev(sex_diff_flow_75[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempgrow_seq ,rev(tempgrow_seq)),
            y=c(sex_diff_flow_50[i,,1],rev(sex_diff_flow_50[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempgrow_seq ,rev(tempgrow_seq)),
            y=c(sex_diff_flow_25[i,,1],rev(sex_diff_flow_25[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    lines(tempgrow_seq ,sex_diff_flow_mean[i,],lwd=2,col="black")
    abline(h=0,lty=2)
    mtext("0",side=2,at=0)
  }
})


with(poar_panic_binned,{
  for(i in 1:size_bin_num){
    par(mar=c(0,4,1,0))
    plot(tempgrow[size_bin==i] ,mean_panic[size_bin==i],type="n",
         xlab=" ",ylab=" ",xaxt="n",ylim=c(0,max(mean_panic[size_bin==i])));box()    
    if(i==1){mtext("#panicles",side=2,line=3,cex=1.3)}
    title(LETTERS[i+9],adj=0)    
    for(s in 1:2){
      points(tempgrow[Sex==s & size_bin==i],mean_panic[Sex==s & size_bin==i],
             bg=sex_cols[s],pch=21,cex=7*(bin_n/max(bin_n)),lwd=2)
      lines(tempgrow_seq, exp(mean(panic_coef$b0_p) +
                        mean(panic_coef$bsize_p) * panic_mean_sizes$size[panic_mean_sizes$Sex==s & panic_mean_sizes$size_bin==i] +
                        mean(panic_coef$bsizesex_p) * panic_mean_sizes$size[panic_mean_sizes$Sex==s & panic_mean_sizes$size_bin==i] * (s-1) +
                        mean(panic_coef$bsex_p) * (s-1) +
                        mean(panic_coef$bpptgrow_p) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s]  +
                        mean(panic_coef$btempgrow_p) * tempgrow_seq +
                        mean(panic_coef$bpptgrowsex_p) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s] * (s-1) +
                        mean(panic_coef$btempgrowsex_p) * tempgrow_seq * (s-1) +
                        mean(panic_coef$btempgrowpptgrow_p) * tempgrow_seq * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s]   +
                        mean(panic_coef$btempgrowpptgrowsex_p) * tempgrow_seq * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s]  * (s-1) +
                        mean(panic_coef$bpptgrow2_p) * (panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s])^2 +
                        mean(panic_coef$btempgrow2_p) * (tempgrow_seq^2) +
                        mean(panic_coef$bpptgrow2sex_p) * (panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s])^2 * (s-1) +
                        mean(panic_coef$btempgrow2sex_p) * (tempgrow_seq^2) * (s-1) 
    
    ) ,lty=sex_lty[s],lwd=3,col= sex_cols[s])
    }
    par(mar=c(2,4,0.5,0))
    plot(tempgrow_seq ,sex_diff_panic_mean[i,],type="n",lwd=4,yaxt="n",
         xlab=" ",ylab=" ",ylim=c(min(sex_diff_panic_95[i,,1]),max(sex_diff_panic_95[i,,2])))
    if(i==1){mtext(expression(paste(Delta," (F-M)")),side=2,line=2,cex=1.3)}
    mtext("Temperature (grow season)",side=1,line=3,cex=1.3)
    polygon(x=c(tempgrow_seq ,rev(tempgrow_seq )),
            y=c(sex_diff_panic_95[i,,1],rev(sex_diff_panic_95[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempgrow_seq ,rev(tempgrow_seq )),
            y=c(sex_diff_panic_75[i,,1],rev(sex_diff_panic_75[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempgrow_seq ,rev(tempgrow_seq )),
            y=c(sex_diff_panic_50[i,,1],rev(sex_diff_panic_50[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    polygon(x=c(tempgrow_seq ,rev(tempgrow_seq )),
            y=c(sex_diff_panic_25[i,,1],rev(sex_diff_panic_25[i,,2])),
            col=alpha(diff_col,diff_alpha),border=NA)
    lines(tempgrow_seq ,sex_diff_panic_mean[i,],lwd=2,col="black")
    abline(h=0,lty=2)
    mtext("0",side=2,at=0)
  }
})
dev.off()


```



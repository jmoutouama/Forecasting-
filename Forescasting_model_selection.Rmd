---
title: "Model selection approach for a dioecious range-limited species response to climate change"
author: "Jacob Moutouama,Aldo Compagnoni and Tom Miller "
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
 rmdformats::readthedown:
    code_folding: show
    self_contained: true
    number_sections: true
    thumbnails: true
    lightbox: true
    gallery: true
    keep_md: true
    highlight: tango
    df_print: kable 
    toc_depth: 3
    fig_width: 8
    fig_height: 8
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(comment=NA, 
                      echo = TRUE,
                      warning=FALSE, 
                      message=FALSE)
knitr::opts_knit$set(fig.pos = "H",global.par = TRUE,knitr.table.format = "latex")
```

```{r eval=TRUE,echo=T}
rm(list = ls())
```

# Required libraries
```{r,warning=FALSE}
# load packages
library(rstan)
# set rstan options
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
set.seed(13)
# Sys.setenv(LOCAL_CPPFLAGS = '-march=corei7 -mtune=corei7')
options(tidyverse.quiet = TRUE)
library(tidyverse)
options(dplyr.summarise.inform = FALSE)
library(bayesplot)
# install.packages("countreg",repos = "http://R-Forge.R-project.org")
library(countreg)
library(rmutil)
library(actuar)
library(SPEI)
library(LaplacesDemon)
# if (!require("BiocManager", quietly = TRUE))
#     install.packages("BiocManager")
# BiocManager::install("scater")
# library(scater)
```

# Demography data 
```{r}
##
poar_allsites <- read.csv("https://www.dropbox.com/s/xk4225mn8btqhbm/demography_allsites.csv?dl=1", stringsAsFactors = F)#common garden data
poar_allsites$census.year<-poar_allsites$year-1 #Add census year to match with climate data
poar_allsites %>% 
  dplyr::select(everything()) %>% 
  filter(census.year %in% (2015:2016))-> poar_allsites_2015_2016 # Drop the first census to match with the seasonal model (growing and dormant season temp and precip)
```

# Current climatic data  
```{r}
poar_ppt <- read.csv("https://www.dropbox.com/s/kkga2hf9k1w9ht1/Poa_pr.csv?dl=1", stringsAsFactors = F) # monthly  precipitation 
poar_temp <- read.csv("https://www.dropbox.com/s/n0vrn8q5ma49rc9/Poa_tas.csv?dl=1", stringsAsFactors = F) # monthly temperature)
poar_ppt$census.year<-ifelse(poar_ppt$month<5,poar_ppt$year-1,poar_ppt$year) # data were collected in May. Thus, the precipitation for the census year is both the precipitation from May to December of the previous year and precipitation of the current year.  
poar_temp$census.year<-ifelse(poar_temp$month<5,poar_temp$year-1,poar_temp$year)
```

## Seasonal data  (growing and dormant season temperature and precipitation) 
```{r img-with-knitr,echo=FALSE, fig.align='center', out.width='100%', fig.cap='Growing and dormant season for Poa arachnifera'}
knitr::include_graphics("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Figures/POARlifecycle.png")
```

```{r}
poar_temp %>% 
  dplyr::select(site,Longitude, Latitude,census.year,temp,month) %>% 
  filter(census.year %in% (2015:2016)) %>%
  mutate(Season=ifelse((month >= 6) & (month <= 9), "dormant", "growing")) %>% 
  group_by(site,census.year,Season) %>%
	summarise(site=unique(site),Longitude=unique(Longitude),Latitude=unique(Latitude),temp_season = mean(temp))->poar_tempseason 

poar_ppt %>% 
  dplyr::select(site,Longitude, Latitude,census.year,ppt,month) %>% 
  filter(census.year %in% (2015:2016)) %>%
  mutate(Season=ifelse((month >= 6) & (month <= 9), "dormant", "growing")) %>% 
  group_by(site,census.year,Season) %>%
	summarise(site=unique(site),Longitude=unique(Longitude),Latitude=unique(Latitude),ppt_season = sum(ppt))->poar_pptseason 

poar_climseason<- merge(x = poar_tempseason, y = poar_pptseason) # merge temperature and precipitation data
 
```

## Match seasonnal data with demographic data

```{r}
poar_allsites.clim_season <- left_join(x = poar_allsites_2015_2016 ,y =poar_climseason,by=c("site","census.year","Longitude","Latitude")) # merge the demographic data with climatic data for each site

poar_allsites.clim_season %>% 
  filter(Season=="growing") %>% 
  mutate(tempgrow=temp_season,pptgrow=ppt_season)->poar_allsites.clim_season_grow

poar_allsites.clim_season %>% 
  filter(Season=="dormant") %>% 
  mutate(tempdorm=temp_season,pptdorm=ppt_season)->poar_allsites.clim_season_dorm


poar.clim_seasonal<- cbind(poar_allsites.clim_season_grow,tempdorm=poar_allsites.clim_season_dorm$tempdorm,pptdorm=poar_allsites.clim_season_dorm$pptdorm)

```

## Check for correlation between predictors for the seasonal data

```{r,eval=FALSE}
figgrow <-ggplot(data=poar.clim_seasonal, aes(x=scale(tempgrow), y=scale(pptgrow))) +
        geom_smooth(method="lm",color = "#0072B2") +
        geom_point(color = '#0072B2',shape = 19, size=4) +
        labs (x="Temperature of growing season",y="Precipitation of growing season") +
        ggpubr::stat_cor(aes(label=..rr.label..)) +
        theme_bw()

figdorm <- ggplot(data=poar.clim_seasonal, aes(x=scale(tempdorm), y=scale(pptdorm))) +
        geom_smooth(method="lm",color = "#0072B2") +
        geom_point(color = '#0072B2',shape = 19, size=4) +
        labs (x="Temperature of dormant season",y="Precipitation of dormant season") +
        ggpubr::stat_cor(aes(label=..rr.label..)) +
        theme_bw()

(figgrowdorm<-ggpubr::ggarrange(plotlist = list(figgrow, figdorm)))

# pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Figures/Varianceexplained.pdf",useDingbats = F,height=5,width=8)
# print(figgrowdorm)
# dev.off()
```

# MCMC parameters
```{r}
sim_pars <- list(
  warmup = 1000,
  iter = 4000,
  thin = 3,
  chains = 3
)

```


# Suvival 
### Running the  stan model
## First  model: seasonnal data 
### Reshape the data
```{r}
# Survival
poar.clim_seasonal %>% 
  subset( tillerN_t0 > 0 )%>%
  dplyr::select( year, Code, site, Block, Sex, 
          Longitude, Latitude, 
          tillerN_t0, surv_t1,pptgrow,pptdorm,tempgrow,tempdorm,site)%>% 
  na.omit %>% 
  mutate( site         = site %>% as.factor %>% as.numeric,
          Block = Block %>% as.factor %>% as.numeric,
          Sex          = Sex %>% as.factor %>% as.numeric,
          source = Code %>% as.factor %>% as.numeric ) %>%
  mutate( z_size_t0   = tillerN_t0 %>% scale %>% .[,1],
          z_ppt_t1_grow = pptgrow %>% scale %>% .[,1],
          z_ppt_t1_dorm = pptdorm %>% scale %>% .[,1],
          z_temp_t1_grow = tempgrow %>% scale %>% .[,1],
          z_temp_t1_dorm = tempdorm %>% scale %>% .[,1])->poarclim_seasonal.surv


poar_sites_season.surv <- list( n_sites    = poarclim_seasonal.surv$site %>% n_distinct,
                  n_sources  = poarclim_seasonal.surv$source %>% n_distinct(),
                  
                  # survival data
                  n_blocks_s = poarclim_seasonal.surv$Block %>% n_distinct,
                  site_s   = poarclim_seasonal.surv$site,
                  source_s =  poarclim_seasonal.surv$source,
                  block_s  = poarclim_seasonal.surv$Block,
                  pptgrow_s=poarclim_seasonal.surv$z_ppt_t1_grow,
                  pptdorm_s=poarclim_seasonal.surv$z_ppt_t1_dorm,
                  tempgrow_s=poarclim_seasonal.surv$z_temp_t1_grow,
                  tempdorm_s=poarclim_seasonal.surv$z_temp_t1_dorm,
                  site_block_s = data.frame( site_i  = poarclim_seasonal.surv$site,
                                             block_i = poarclim_seasonal.surv$Block ) %>%
                    unique %>% .$site_i,
                  male_s   = poarclim_seasonal.surv$Sex-1,
                  size_s   = poarclim_seasonal.surv$z_size_t0,
                  y_s      = poarclim_seasonal.surv$surv_t1,
                  n_s      = nrow(poarclim_seasonal.surv))
```

### Running the stan model
```{r , eval=FALSE}
fit_allsites_surv_season <- stan(
 file = "/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/stan/poar_survival_season.stan",
 data = poar_sites_season.surv,
 warmup = sim_pars$warmup,
 iter = sim_pars$iter,
 thin = sim_pars$thin,
 chains = sim_pars$chains)


# saveRDS(fit_allsites_surv_season, '/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/Current conditions/poar_survival_season.rds')

#load stan output -- this will also take a while, but not as long as running the model from scratch
fit_allsites_surv_season <- readRDS(url("https://www.dropbox.com/s/ixv0rn7k6yi3bzm/poar_survival_season.rds?dl=1"))
#ignore warning from readRDS
```

```{r}
traceplot(fit_allsites_surv_season, pars = c("b0_s","bsizesex_s","btempdormpptdorm_s","btempgrowpptgrow_s","bsex_s", "bsize_s","bpptgrow_s","bpptdorm_s","btempgrow_s","btempdorm_s","bpptgrowsex_s","bpptdormsex_s","btempgrowsex_s","btempdormsex_s","btempdormpptdormsex_s","btempgrowpptgrowsex_s"), inc_warmup = TRUE, nrow =9 )
```

```{r}
log_lik_surv_season <- loo::extract_log_lik(fit_allsites_surv_season, merge_chains = FALSE)
r_eff_surv_season <- loo::relative_eff(exp(log_lik_surv_season))
loo_surv_season <- loo(log_lik_surv_season, r_eff = r_eff_surv_season, cores = 2)
# print(loo_surv_season)
# plot(loo_surv_season)
```


## Fourth  model: seasonnal data with polynomial second order
### Running the stan model
```{r , eval=FALSE}
fit_allsites_surv_season_polyn <- stan(
 file = "/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/stan/poar_survival_seasonpolynomial.stan",
 data = poar_sites_season.surv,
 warmup = sim_pars$warmup,
 iter = sim_pars$iter,
 thin = sim_pars$thin,
 chains = sim_pars$chains)


# saveRDS(fit_allsites_surv_season_polyn, '/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/Current conditions/poar_survival_seasonpolynomial.rds')

#load stan output -- this will also take a while, but not as long as running the model from scratch
fit_allsites_surv_season_polyn <- readRDS(url("https://www.dropbox.com/s/xr3zrapbwimsfa5/poar_survival_seasonpolynomial.rds?dl=1"))
#ignore warning from readRDS
```

```{r}
traceplot(fit_allsites_surv_season_polyn, pars = c("b0_s","bsizesex_s","btempdormpptdorm_s","btempgrowpptgrow_s","bsex_s", "bsize_s","bpptgrow_s","bpptdorm_s","btempgrow_s","btempdorm_s","bpptgrowsex_s","bpptdormsex_s","btempgrowsex_s","btempdormsex_s","btempdormpptdormsex_s","btempgrowpptgrowsex_s","bpptgrow2_s","bpptdorm2_s","btempgrow2_s","btempdorm2_s","bpptgrow2sex_s","bpptdorm2sex_s","btempgrow2sex_s","btempdorm2sex_s"), inc_warmup = TRUE, nrow =15 )
```

```{r}
log_lik_surv_season_polyn <- loo::extract_log_lik(fit_allsites_surv_season_polyn, merge_chains = FALSE)
r_eff_surv_season_polyn <- loo::relative_eff(exp(log_lik_surv_season_polyn))
loo_surv_season_polyn <- loo(log_lik_surv_season_polyn, r_eff = r_eff_surv_season_polyn, cores = 2)
# print(loo_surv_season_polyn)
# plot(loo_surv_season_polyn)
```
## Model comparaison based on epdl/looic 
```{r}
# Compare
comp_surv <- loo::loo_compare(loo_surv_season,loo_surv_season_polyn)
print(comp_surv)
# The first column shows the difference in ELPD relative to the model with the largest ELPD. In this case, the difference in elpd and its scale relative to the approximate standard error of the difference) indicates a preference for the first model (model1).
```

## Posterior for each model 


```{r}
posteriorsurv_season <- as.array(fit_allsites_surv_season)
color_scheme_set("blue")
mcmc_intervals(posteriorsurv_season, pars = c("b0_s","bsizesex_s","btempdormpptdorm_s","btempgrowpptgrow_s","bsex_s", "bsize_s","bpptgrow_s","bpptdorm_s","btempgrow_s","btempdorm_s","bpptgrowsex_s","bpptdormsex_s","btempgrowsex_s","btempdormsex_s","btempdormpptdormsex_s","btempgrowpptgrowsex_s"))+ geom_vline(xintercept = 0, linetype = 2)+theme_bw()
```

```{r}
posteriorsurv_season_polyn <- as.array(fit_allsites_surv_season_polyn)
color_scheme_set("blue")
mcmc_intervals(posteriorsurv_season_polyn, pars = c("b0_s","bsizesex_s","btempdormpptdorm_s","btempgrowpptgrow_s","bsex_s", "bsize_s","bpptgrow_s","bpptdorm_s","btempgrow_s","btempdorm_s","bpptgrowsex_s","bpptdormsex_s","btempgrowsex_s","btempdormsex_s","btempdormpptdormsex_s","btempgrowpptgrowsex_s","bpptgrow2_s","bpptdorm2_s","btempgrow2_s","btempdorm2_s","bpptgrow2sex_s","bpptdorm2sex_s","btempgrow2sex_s","btempdorm2sex_s"))+ geom_vline(xintercept = 0, linetype = 2)+theme_bw()
```

# Posterior predictive check for survival

```{r}
#pull out parameter posterior distributions
predSS <- rstan::extract(fit_allsites_surv_season, pars = c("predS"))$predS
predSSP <- rstan::extract(fit_allsites_surv_season_polyn, pars = c("predS"))$predS


#draw 500 random samples from the joint posterior
n_post_draws <- 500
post_draws <- sample.int(dim(predSS)[1], n_post_draws)
#set up simulation output
y_ss_sim <- matrix(NA,n_post_draws,length(poar_sites_season.surv$y_s))
y_sps_sim <- matrix(NA,n_post_draws,length(poar_sites_season.surv$y_s))


#loop over the posterior and generate new observations
for(i in 1:n_post_draws){
  print(i)
  ## sample survival data linear (bernoulli)
  y_ss_sim [i,] <- rbinom(n=length(poar_sites_season.surv$y_s), size=1, prob = invlogit(predSS[i,]))
  ## sample survival data  polynomial (bernoulli)
  y_sps_sim [i,] <- rbinom(n=length(poar_sites_season.surv$y_s), size=1, prob = invlogit(predSSP[i,]))

}
```
# plot ppc overlay for survival

```{r}
multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)

  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)

  numPlots = length(plots)

  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }

 if (numPlots==1) {
    print(plots[[1]])

  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))

    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))

      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}
```

```{r}

ppc_dens_overlay(poar_sites_season.surv$y_s, y_ss_sim)+
  xlab("Survival status")+ylab("Density")+
  ggtitle((" Linear"))+theme(legend.position = "none")+theme_bw()->ppc_surv_season


ppc_dens_overlay(poar_sites_season.surv$y_s, y_sps_sim)+
  xlab("Survival status")+ylab("Density")+
  ggtitle((" Polynomial"))+theme(legend.position = "none")+theme_bw()->ppc_surv_season_polyn

# print figure
# pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Figures/PPCSurvival.pdf",useDingbats = F,height=3,width=6)
# multiplot(ppc_surv_season,
#           ppc_surv_season_polyn,cols=2)
# dev.off()
```

# pull out stan coefficients for survival

```{r}
surv_coefss <- rstan::extract(fit_allsites_surv_season, c("b0_s","bsizesex_s","btempdormpptdorm_s","btempgrowpptgrow_s","bsex_s", "bsize_s","bpptgrow_s","bpptdorm_s","btempgrow_s","btempdorm_s","bpptgrowsex_s","bpptdormsex_s","btempgrowsex_s","btempdormsex_s","btempdormpptdormsex_s","btempgrowpptgrowsex_s"))

surv_coefssp <- rstan::extract(fit_allsites_surv_season_polyn, c("b0_s","bsizesex_s","btempdormpptdorm_s","btempgrowpptgrow_s","bsex_s", "bsize_s","bpptgrow_s","bpptdorm_s","btempgrow_s","btempdorm_s","bpptgrowsex_s","bpptdormsex_s","btempgrowsex_s","btempdormsex_s","btempdormpptdormsex_s","btempgrowpptgrowsex_s","bpptgrow2_s","bpptdorm2_s","btempgrow2_s","btempdorm2_s","bpptgrow2sex_s","bpptdorm2sex_s","btempgrow2sex_s","btempdorm2sex_s"))

```

# Plot survival with climate variables
## Re-format data for plotting 





```{r}
sex_cols <- c("#FDAE61", # Orange
            "#66BD63") # Darker green
poarclim_seasonal.surv %>% 
  group_by(site,Sex) %>% 
  summarise(mean_surv = mean(surv_t1),
            mean_size = mean(tillerN_t0),
            mean_pptgrow= mean(pptgrow),
            mean_temprow= mean(tempgrow),
            mean_pptdorm= mean(pptdorm),
            mean_tempdorm= mean(tempdorm),
            pptgrow = unique(pptgrow),
            tempgrow = unique(tempgrow),
            pptdorm = unique(pptdorm),
            tempdorm = unique(tempdorm))->poar_surv_plot_season


zpoar_surv_plot_season<-scale(poar_surv_plot_season[,4:12])
zpoar_surv_plot_season<-data.frame(poar_surv_plot_season[,1:3],zpoar_surv_plot_season)


surv_mean_sizesseason <- zpoar_surv_plot_season %>% group_by(Sex) %>% summarise(size = mean(mean_size))
surv_mean_tempgrow <- zpoar_surv_plot_season %>% group_by(Sex) %>% summarise(tempgrow = mean(tempgrow))
surv_mean_tempdorm <- zpoar_surv_plot_season %>% group_by(Sex) %>% summarise(tempdorm = mean(tempdorm))
surv_mean_pptgrow <- zpoar_surv_plot_season %>% group_by(Sex) %>% summarise(pptgrow = mean(pptgrow))
surv_mean_pptdorm <- zpoar_surv_plot_season %>% group_by(Sex) %>% summarise(pptdorm = mean(pptdorm))
```


```{r}
pptgrow_seq <- seq(min(zpoar_surv_plot_season$pptgrow),max(zpoar_surv_plot_season$pptgrow),0.1)
tempgrow_seq <- seq(min(zpoar_surv_plot_season$tempgrow),max(zpoar_surv_plot_season$tempgrow),0.1)
pptdorm_seq <- seq(min(zpoar_surv_plot_season$pptdorm),max(zpoar_surv_plot_season$pptdorm),0.1)
tempdorm_seq <- seq(min(zpoar_surv_plot_season$tempdorm),max(zpoar_surv_plot_season$tempdorm),0.1)
```





## Plot for seasonnal survival 


```{r}
par(mfrow = c(2, 4))
with(zpoar_surv_plot_season,{
    plot(pptgrow,mean_surv,ylim=c(0,1),
         xlab=" Precipitation growing",ylab=" Pr Survival");box()
    for(s in 1:2){
      points(pptgrow[Sex==s],mean_surv[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(pptgrow_seq,invlogit(mean(surv_coefss$b0_s) + 
                        mean(surv_coefss$bsize_s) * surv_mean_sizesseason$size[surv_mean_sizesseason$Sex==s] +
                        mean(surv_coefss$bsizesex_s) * surv_mean_sizesseason$size[surv_mean_sizesseason$Sex==s] * (s-1) +
                        mean(surv_coefss$bsex_s) * (s-1) +
                        mean(surv_coefss$bpptgrow_s) * pptgrow_seq +
                        mean(surv_coefss$bpptdorm_s) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s]  +
                        mean(surv_coefss$btempgrow_s) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                        mean(surv_coefss$btempdorm_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] +
                        mean(surv_coefss$btempdormpptdorm_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s]* surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] +
                        mean(surv_coefss$btempgrowpptgrow_s) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * pptgrow_seq +
                        mean(surv_coefss$bpptgrowsex_s) * pptgrow_seq * (s-1) +
                        mean(surv_coefss$bpptdormsex_s) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s]  * (s-1) +
                        mean(surv_coefss$btempgrowsex_s) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * (s-1) +
                        mean(surv_coefss$btempdormsex_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * (s-1) +
                        mean(surv_coefss$btempdormpptdormsex_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] * (s-1) +
                        mean(surv_coefss$btempgrowpptgrowsex_s) * pptgrow_seq * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s]  * (s-1) 
      ),col= sex_cols[s],lwd=3)
    }
})

with(zpoar_surv_plot_season,{
    plot(tempgrow,mean_surv,ylim=c(0,1),
         xlab=" Temperature growing",ylab=" Pr Survival");box()
    for(s in 1:2){
      points(tempgrow[Sex==s],mean_surv[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(tempgrow_seq,invlogit(mean(surv_coefss$b0_s) + 
                        mean(surv_coefss$bsize_s) * surv_mean_sizesseason$size[surv_mean_sizesseason$Sex==s] +
                        mean(surv_coefss$bsizesex_s) * surv_mean_sizesseason$size[surv_mean_sizesseason$Sex==s] * (s-1) +
                        mean(surv_coefss$bsex_s) * (s-1) +
                        mean(surv_coefss$bpptgrow_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s]  +
                        mean(surv_coefss$bpptdorm_s) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s]  +
                        mean(surv_coefss$btempgrow_s) * tempgrow_seq +
                        mean(surv_coefss$btempdorm_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] +
                        mean(surv_coefss$btempdormpptdorm_s)*surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] +
                        mean(surv_coefss$btempgrowpptgrow_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * tempgrow_seq +
                        mean(surv_coefss$bpptgrowsex_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * (s-1) +
                        mean(surv_coefss$bpptdormsex_s) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s]  * (s-1) +
                        mean(surv_coefss$btempgrowsex_s) * tempgrow_seq * (s-1) +
                        mean(surv_coefss$btempdormsex_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * (s-1) +
                        mean(surv_coefss$btempdormpptdormsex_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] * (s-1) +
                        mean(surv_coefss$btempgrowpptgrowsex_s) * tempgrow_seq * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s]  * (s-1) 
      ),col= sex_cols[s],lwd=3)
    }
})

with(zpoar_surv_plot_season,{
    plot(pptdorm,mean_surv,ylim=c(0,1),
         xlab=" Precipitation dormant",ylab=" Pr Survival");box()
    for(s in 1:2){
      points(pptdorm[Sex==s],mean_surv[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(pptdorm_seq,invlogit(mean(surv_coefss$b0_s) + 
                        mean(surv_coefss$bsize_s) * surv_mean_sizesseason$size[surv_mean_sizesseason$Sex==s] +
                        mean(surv_coefss$bsizesex_s) * surv_mean_sizesseason$size[surv_mean_sizesseason$Sex==s] * (s-1)  +
                        mean(surv_coefss$bsex_s) * (s-1) +
                        mean(surv_coefss$bpptgrow_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s]  +
                        mean(surv_coefss$bpptdorm_s) * pptdorm_seq +
                        mean(surv_coefss$btempgrow_s) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                        mean(surv_coefss$btempdorm_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] +
                        mean(surv_coefss$btempdormpptdorm_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * pptdorm_seq +
                        mean(surv_coefss$btempgrowpptgrow_s) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] +
                        mean(surv_coefss$bpptgrowsex_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s]  * (s-1) +
                        mean(surv_coefss$bpptdormsex_s) * pptdorm_seq  * (s-1) +
                        mean(surv_coefss$btempgrowsex_s) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * (s-1) +
                        mean(surv_coefss$btempdormsex_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * (s-1) +
                        mean(surv_coefss$btempdormpptdormsex_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * pptdorm_seq * (s-1) +
                        mean(surv_coefss$btempgrowpptgrowsex_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s]  * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s]  * (s-1) 
      ),col= sex_cols[s],lwd=3)
    }
})

with(zpoar_surv_plot_season,{
    plot(tempdorm,mean_surv,ylim=c(0,1),
         xlab=" Temperature dormant",ylab=" Pr Survival");box()
    for(s in 1:2){
      points(tempdorm[Sex==s],mean_surv[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(tempdorm_seq,invlogit(mean(surv_coefss$b0_s) + 
                        mean(surv_coefss$bsize_s) * surv_mean_sizesseason$size[surv_mean_sizesseason$Sex==s] +
                        mean(surv_coefss$bsizesex_s) * surv_mean_sizesseason$size[surv_mean_sizesseason$Sex==s] * (s-1) +
                        mean(surv_coefss$bsex_s) * (s-1) +
                        mean(surv_coefss$bpptgrow_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s]  +
                        mean(surv_coefss$bpptdorm_s) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s]  +
                        mean(surv_coefss$btempgrow_s) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                        mean(surv_coefss$btempdorm_s) * tempdorm_seq +
                        mean(surv_coefss$btempdormpptdorm_s) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] * tempdorm_seq  +
                        mean(surv_coefss$btempgrowpptgrow_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] + 
                        mean(surv_coefss$bpptgrowsex_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * (s-1) +
                        mean(surv_coefss$bpptdormsex_s) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s]  * (s-1) +
                        mean(surv_coefss$btempgrowsex_s) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * (s-1) +
                        mean(surv_coefss$btempdormsex_s) * tempdorm_seq * (s-1) +
                        mean(surv_coefss$btempdormpptdormsex_s) * tempdorm_seq * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] * (s-1) +
                        mean(surv_coefss$btempgrowpptgrowsex_s) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s]   * (s-1) 
      ),col= sex_cols[s],lwd=3)
    }
})


with(zpoar_surv_plot_season,{
    plot(pptgrow,mean_surv,ylim=c(0,1),
         xlab=" Precipitation growing",ylab=" Pr Survival");box()
    for(s in 1:2){
      points(pptgrow[Sex==s],mean_surv[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(pptgrow_seq,invlogit(mean(surv_coefssp$b0_s) + 
                        mean(surv_coefssp$bsize_s) * surv_mean_sizesseason$size[surv_mean_sizesseason$Sex==s] +
                        mean(surv_coefssp$bsizesex_s) * surv_mean_sizesseason$size[surv_mean_sizesseason$Sex==s] * (s-1) +
                        mean(surv_coefssp$bsex_s) * (s-1) +
                        mean(surv_coefssp$bpptgrow_s) * pptgrow_seq +
                        mean(surv_coefssp$bpptdorm_s) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s]  +
                        mean(surv_coefssp$btempgrow_s) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                        mean(surv_coefssp$btempdorm_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] +
                        mean(surv_coefssp$bpptgrowsex_s) * pptgrow_seq * (s-1) +
                        mean(surv_coefssp$bpptdormsex_s) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s]  * (s-1) +
                        mean(surv_coefssp$btempgrowsex_s) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * (s-1) +
                        mean(surv_coefssp$btempdormsex_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * (s-1) +
                        mean(surv_coefssp$btempdormpptdorm_s) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] + 
                        mean(surv_coefssp$btempgrowpptgrow_s) * pptgrow_seq * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                        mean(surv_coefssp$btempdormpptdormsex_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] * (s-1) +
                        mean(surv_coefssp$btempgrowpptgrowsex_s) * pptgrow_seq * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s]  * (s-1) +
                        mean(surv_coefssp$bpptgrow2_s) * (pptgrow_seq^2) +
                        mean(surv_coefssp$bpptdorm2_s) * (surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s])^2 +
                        mean(surv_coefssp$btempgrow2_s) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 +
                        mean(surv_coefssp$btempdorm2_s) * (surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s])^2 +
                        mean(surv_coefssp$bpptgrow2sex_s) * (pptgrow_seq^2) * (s-1) +
                        mean(surv_coefssp$bpptdorm2sex_s) * (surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s])^2 * (s-1) +
                        mean(surv_coefssp$btempgrow2sex_s) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 * (s-1) +
                        mean(surv_coefssp$btempdorm2sex_s) * (surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s])^2 * (s-1) 
      ),col= sex_cols[s],lwd=3)
    }
})

with(zpoar_surv_plot_season,{
    plot(tempgrow,mean_surv,ylim=c(0,1),
         xlab=" Temperature growing",ylab=" Pr Survival");box()
    for(s in 1:2){
      points(tempgrow[Sex==s],mean_surv[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(tempgrow_seq,invlogit(mean(surv_coefss$b0_s) + 
                        mean(surv_coefss$bsize_s) * surv_mean_sizesseason$size[surv_mean_sizesseason$Sex==s] +
                        mean(surv_coefss$bsizesex_s) * surv_mean_sizesseason$size[surv_mean_sizesseason$Sex==s] * (s-1) +
                        mean(surv_coefss$bsex_s) * (s-1) +
                        mean(surv_coefss$bpptgrow_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s]  +
                        mean(surv_coefss$bpptdorm_s) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s]  +
                        mean(surv_coefss$btempgrow_s) * tempgrow_seq +
                        mean(surv_coefss$btempdorm_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] +
                        mean(surv_coefss$bpptgrowsex_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * (s-1) +
                        mean(surv_coefss$bpptdormsex_s) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s]  * (s-1) +
                        mean(surv_coefss$btempdormpptdorm_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] +
                        mean(surv_coefss$btempgrowpptgrow_s) * tempgrow_seq * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] +
                        mean(surv_coefss$btempgrowsex_s) * tempgrow_seq * (s-1) +
                        mean(surv_coefss$btempdormsex_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * (s-1) +
                        mean(surv_coefss$btempdormpptdormsex_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] * (s-1) +
                        mean(surv_coefss$btempgrowpptgrowsex_s) * tempgrow_seq * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s]  * (s-1) +
                        mean(surv_coefssp$bpptgrow2_s) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 +
                        mean(surv_coefssp$bpptdorm2_s) * (surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s])^2 +
                        mean(surv_coefssp$btempgrow2_s) * (tempgrow_seq^2) +
                        mean(surv_coefssp$btempdorm2_s) * (surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s])^2 +
                        mean(surv_coefssp$bpptgrow2sex_s) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 * (s-1) +
                        mean(surv_coefssp$bpptdorm2sex_s) * (surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s])^2 * (s-1) +
                        mean(surv_coefssp$btempgrow2sex_s) * (tempgrow_seq^2) * (s-1) +
                        mean(surv_coefssp$btempdorm2sex_s) * (surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s])^2 * (s-1)
                        
      ),col= sex_cols[s],lwd=3)
    }
})

with(zpoar_surv_plot_season,{
    plot(pptdorm,mean_surv,ylim=c(0,1),
         xlab=" Precipitation dormant",ylab=" Pr Survival");box()
    for(s in 1:2){
      points(pptdorm[Sex==s],mean_surv[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(pptdorm_seq,invlogit(mean(surv_coefss$b0_s) + 
                        mean(surv_coefss$bsize_s) * surv_mean_sizesseason$size[surv_mean_sizesseason$Sex==s] +
                        mean(surv_coefss$bsizesex_s) * surv_mean_sizesseason$size[surv_mean_sizesseason$Sex==s] * (s-1) +
                        mean(surv_coefss$bsex_s) * (s-1) +
                        mean(surv_coefss$bpptgrow_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s]  +
                        mean(surv_coefss$bpptdorm_s) * pptdorm_seq +
                        mean(surv_coefss$btempgrow_s) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                        mean(surv_coefss$btempdorm_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] +
                        mean(surv_coefss$btempdormpptdorm_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * pptdorm_seq  +
                        mean(surv_coefss$btempgrowpptgrow_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s]  * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                        mean(surv_coefss$bpptgrowsex_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s]  * (s-1) +
                        mean(surv_coefss$bpptdormsex_s) * pptdorm_seq  * (s-1) +
                        mean(surv_coefss$btempgrowsex_s) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * (s-1) +
                        mean(surv_coefss$btempdormsex_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * (s-1) +
                        mean(surv_coefss$btempdormpptdormsex_s) * surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s] * pptdorm_seq * (s-1) +
                        mean(surv_coefss$btempgrowpptgrowsex_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s]  * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s]  * (s-1) +
                        mean(surv_coefssp$bpptgrow2_s) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 +
                        mean(surv_coefssp$bpptdorm2_s) * (pptdorm_seq^2) +
                        mean(surv_coefssp$btempgrow2_s) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 +
                        mean(surv_coefssp$btempdorm2_s) * (surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s])^2 +
                        mean(surv_coefssp$bpptgrow2sex_s) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 * (s-1) +
                        mean(surv_coefssp$bpptdorm2sex_s) * (pptdorm_seq^2) * (s-1) +
                        mean(surv_coefssp$btempgrow2sex_s) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 * (s-1) +
                        mean(surv_coefssp$btempdorm2sex_s) *  (surv_mean_tempdorm$tempdorm[surv_mean_tempdorm$Sex==s])^2 * (s-1) 
                        
      ),col= sex_cols[s],lwd=3)
    }
})

with(zpoar_surv_plot_season,{
    plot(tempdorm,mean_surv,ylim=c(0,1),
         xlab=" Temperature dormant",ylab=" Pr Survival");box()
    for(s in 1:2){
      points(tempdorm[Sex==s],mean_surv[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(tempdorm_seq,invlogit(mean(surv_coefss$b0_s) + 
                        mean(surv_coefss$bsize_s) * surv_mean_sizesseason$size[surv_mean_sizesseason$Sex==s] +
                        mean(surv_coefss$bsizesex_s) * surv_mean_sizesseason$size[surv_mean_sizesseason$Sex==s] * (s-1) +
                        mean(surv_coefss$bsex_s) * (s-1) +
                        mean(surv_coefss$bpptgrow_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s]  +
                        mean(surv_coefss$bpptdorm_s) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s]  +
                        mean(surv_coefss$btempgrow_s) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] +
                        mean(surv_coefss$btempdorm_s) * tempdorm_seq +
                        mean(surv_coefss$btempdormpptdorm_s) * tempdorm_seq * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] +
                        mean(surv_coefss$btempgrowpptgrow_s) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] +
                        mean(surv_coefss$bpptgrowsex_s) * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] * (s-1) +
                        mean(surv_coefss$bpptdormsex_s) * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s]  * (s-1) +
                        mean(surv_coefss$btempgrowsex_s) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * (s-1) +
                        mean(surv_coefss$btempdormsex_s) * tempdorm_seq * (s-1) +
                        mean(surv_coefss$btempdormpptdormsex_s) * tempdorm_seq * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] * (s-1) +
                        mean(surv_coefss$btempgrowpptgrowsex_s) * surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s] * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s]   * (s-1) +
                        mean(surv_coefssp$bpptgrow2_s) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 +
                        mean(surv_coefssp$bpptdorm2_s) * (surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s])^2 +
                        mean(surv_coefssp$btempgrow2_s) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s])^2 +
                        mean(surv_coefssp$btempdorm2_s) * (tempdorm_seq^2) +
                        mean(surv_coefssp$bpptgrow2sex_s) * (surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s])^2 * (s-1) +
                        mean(surv_coefssp$bpptdorm2sex_s) * (surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s])^2 * (s-1) +
                        mean(surv_coefssp$btempgrow2sex_s) * (surv_mean_tempgrow$tempgrow[surv_mean_tempgrow$Sex==s]) * (s-1) +
                        mean(surv_coefssp$btempdorm2sex_s) * (tempdorm_seq^2) * (s-1) 
                        
      ),col= sex_cols[s],lwd=3)
    }
})

```



# Growth 

## First  model: seasonnal data 
### Reshape the data
```{r}
# growth
poar.clim_seasonal %>% 
  subset( tillerN_t0 > 0 & tillerN_t1 > 0)%>%
  dplyr::select( year, Code, site, Block, Sex, 
          Longitude, Latitude, 
          tillerN_t0, tillerN_t1,surv_t1,pptgrow,pptdorm,tempgrow,tempdorm,site)%>% 
  na.omit %>% 
  mutate( site         = site %>% as.factor %>% as.numeric,
          Block = Block %>% as.factor %>% as.numeric,
          Sex          = Sex %>% as.factor %>% as.numeric,
          source = Code %>% as.factor %>% as.numeric ) %>%
  mutate( z_size_t0   = tillerN_t0 %>% scale %>% .[,1],
          z_ppt_t1_grow = pptgrow %>% scale %>% .[,1],
          z_ppt_t1_dorm = pptdorm %>% scale %>% .[,1],
          z_temp_t1_grow = tempgrow %>% scale %>% .[,1],
          z_temp_t1_dorm = tempdorm %>% scale %>% .[,1])->poarclim_seasonal.grow


poar_sites_season.grow <- list( n_sites    = poarclim_seasonal.surv$site %>% n_distinct,
                  n_sources  = poarclim_seasonal.surv$source %>% n_distinct(),
                  # growth data
                  n_blocks_g = poarclim_seasonal.grow$Block %>% n_distinct,
                  site_g   = poarclim_seasonal.grow$site,
                  source_g =  poarclim_seasonal.grow$source,
                  block_g  = poarclim_seasonal.grow$Block,
                  pptgrow_g=poarclim_seasonal.grow$z_ppt_t1_grow,
                  pptdorm_g=poarclim_seasonal.grow$z_ppt_t1_dorm,
                  tempgrow_g=poarclim_seasonal.grow$z_temp_t1_grow,
                  tempdorm_g=poarclim_seasonal.grow$z_temp_t1_dorm,
                  site_block_g = data.frame( site_i  = poarclim_seasonal.grow$site,
                                             block_i = poarclim_seasonal.grow$Block ) %>%
                    unique %>% .$site_i,
                  male_g   = poarclim_seasonal.grow$Sex-1,
                  size_g   = poarclim_seasonal.grow$z_size_t0,
                  y_g      = poarclim_seasonal.grow$tillerN_t1,
                  n_g      = nrow(poarclim_seasonal.grow))
```

### Running the stan model
```{r , eval=FALSE}
fit_allsites_grow_season <- stan(
 file = "/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/stan/poar_growth_season.stan",
 data = poar_sites_season.grow,
 warmup = sim_pars$warmup,
 iter = sim_pars$iter,
 thin = sim_pars$thin,
 chains = sim_pars$chains)

# saveRDS(fit_allsites_grow_season, '/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/Current conditions/poar_growth_season.rds')

#load stan output -- this will also take a while, but not as long as running the model from scratch
fit_allsites_grow_season <- readRDS(url("https://www.dropbox.com/s/3h9x43ku3f58up9/poar_growth_season.rds?dl=1"))
#ignore warning from readRDS
```

```{r}
traceplot(fit_allsites_grow_season, pars = c("b0_g","btempdormpptdorm_g","btempgrowpptgrow_g","bsizesex_g","bsex_g", "bsize_g","bpptgrow_g","bpptdorm_g","btempgrow_g","btempdorm_g","bpptgrowsex_g","bpptdormsex_g","btempgrowsex_g","btempdormsex_g","btempdormpptdormsex_g","btempgrowpptgrowsex_g","sigma"), inc_warmup = TRUE, nrow =9 )
```

```{r}
log_lik_grow_season <- loo::extract_log_lik(fit_allsites_grow_season, merge_chains = FALSE)
r_eff_grow_season <- loo::relative_eff(exp(log_lik_grow_season))
loo_grow_season <- loo(log_lik_grow_season, r_eff = r_eff_grow_season, cores = 2)
# print(loo_grow_season)
# plot(loo_grow_season)
```


## Fourth  model: seasonnal data with polynomial second order
### Running the stan model
```{r , eval=FALSE}
fit_allsites_grow_season_polyn <- stan(
 file = "/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/stan/poar_growth_seasonpolynomial.stan",
 data = poar_sites_season.grow,
 warmup = sim_pars$warmup,
 iter = sim_pars$iter,
 thin = sim_pars$thin,
 chains = sim_pars$chains)

# saveRDS(fit_allsites_grow_season_polyn, '/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/Current conditions/poar_growth_seasonpolynomial.rds')


#load stan output -- this will also take a while, but not as long as running the model from scratch
fit_allsites_grow_season_polyn <- readRDS(url("https://www.dropbox.com/s/onie8qtrzer8cme/poar_growth_seasonpolynomial.rds?dl=1"))
#ignore warning from readRDS
```

```{r}
traceplot(fit_allsites_grow_season_polyn, pars = c("b0_g","btempdormpptdorm_g","btempgrowpptgrow_g","bsizesex_g","bsex_g", "bsize_g","bpptgrow_g","bpptdorm_g","btempgrow_g","btempdorm_g","bpptgrowsex_g","bpptdormsex_g","btempgrowsex_g","btempdormsex_g","btempdormpptdormsex_g","btempgrowpptgrowsex_g","bpptgrow2_g","bpptdorm2_g","btempgrow2_g","btempdorm2_g","bpptgrow2sex_g","bpptdorm2sex_g","btempgrow2sex_g","btempdorm2sex_g","sigma"), inc_warmup = TRUE, nrow =9 )

```


```{r}
log_lik_grow_season_polyn <- loo::extract_log_lik(fit_allsites_grow_season_polyn, merge_chains = FALSE)
r_eff_grow_season_polyn <- loo::relative_eff(exp(log_lik_grow_season_polyn))
loo_grow_season_polyn <- loo(log_lik_grow_season_polyn, r_eff = r_eff_grow_season_polyn, cores = 2)
# print(loo_grow_season_polyn)
# plot(loo_grow_season_polyn)
```

## Comparaison between models

```{r}
# Compare
comp_grow <- loo::loo_compare(loo_grow_season,loo_grow_season_polyn)
print(comp_grow)
```

```{r}
posteriorgrow_season <- as.array(fit_allsites_grow_season)
color_scheme_set("blue")
mcmc_intervals(posteriorgrow_season, pars = c("b0_g","btempdormpptdorm_g","btempgrowpptgrow_g","bsizesex_g","bsex_g", "bsize_g","bpptgrow_g","bpptdorm_g","btempgrow_g","btempdorm_g","bpptgrowsex_g","bpptdormsex_g","btempgrowsex_g","btempdormsex_g","btempdormpptdormsex_g","btempgrowpptgrowsex_g"))+ geom_vline(xintercept = 0, linetype = 2)+theme_bw()
```

```{r}
posteriorgrow_season_polyn <- as.array(fit_allsites_grow_season_polyn)
color_scheme_set("blue")
mcmc_intervals(posteriorgrow_season_polyn, pars = c("b0_g","btempdormpptdorm_g","btempgrowpptgrow_g","bsizesex_g","bsex_g", "bsize_g","bpptgrow_g","bpptdorm_g","btempgrow_g","btempdorm_g","bpptgrowsex_g","bpptdormsex_g","btempgrowsex_g","btempdormsex_g","btempdormpptdormsex_g","btempgrowpptgrowsex_g","bpptgrow2_g","bpptdorm2_g","btempgrow2_g","btempdorm2_g","bpptgrow2sex_g","bpptdorm2sex_g","btempgrow2sex_g","btempdorm2sex_g","sigma"))+ geom_vline(xintercept = 0, linetype = 2)+theme_bw()
```

## Posterior predictive check for growth

```{r}
#pull out parameter posterior distributions

predGS <- rstan::extract(fit_allsites_grow_season, pars = c("predG"))$predG
predGSP <- rstan::extract(fit_allsites_grow_season_polyn, pars = c("predG"))$predG


sigmaGS <- rstan::extract(fit_allsites_grow_season, pars = c("sigma"))$sigma
sigmaGSP <- rstan::extract(fit_allsites_grow_season_polyn, pars = c("sigma"))$sigma

#draw 500 random samples from the joint posterior
n_post_draws <- 500
post_draws <- sample.int(dim(predGS)[1], n_post_draws)
#set up simulation output

y_gs_sim <- matrix(NA,n_post_draws,length(poar_sites_season.grow$y_g))
y_gps_sim <- matrix(NA,n_post_draws,length(poar_sites_season.grow$y_g))


#loop over the posterior and generate new observations
for(i in 1:n_post_draws){
  print(i)
  ## sample growth data (zero-truncated PIG) -- generates data as legit PIG
    for(j in 1:length(poar_sites_season.grow$y_g)){
      ## the pig function appears numerically unstable at low probabilities, so here is a hacky solution
      pig<-dpoisinvgauss(0:1000,mean=predGS[i,j],shape=(sigmaGS[i]*predGS[i,j]))
      pig[is.nan(pig) | is.infinite(pig)] <- 0
      pig_trunc_prob <- pig[2:1001] / (1 - ((1 - sum(pig)) + pig[1]))
      y_gs_sim[i,j] <- sample(x=1:1000,size=1,replace=T,prob=pig_trunc_prob)
    } 
  ## sample growth data (zero-truncated PIG) -- generates data as legit PIG
    for(j in 1:length(poar_sites_season.grow$y_g)){
      ## the pig function appears numerically unstable at low probabilities, so here is a hacky solution
      pig<-dpoisinvgauss(0:1000,mean=predGSP[i,j],shape=(sigmaGSP[i]*predGSP[i,j]))
      pig[is.nan(pig) | is.infinite(pig)] <- 0
      pig_trunc_prob <- pig[2:1001] / (1 - ((1 - sum(pig)) + pig[1]))
      y_gps_sim[i,j] <- sample(x=1:1000,size=1,replace=T,prob=pig_trunc_prob)
    } 

}
```
## plot ppc overlay for  growth
```{r}


ppc_dens_overlay(poar_sites_season.grow$y_g, y_gs_sim)+
  xlab("Growth status")+ylab("Density")+
  ggtitle((""))+theme(legend.position = "none")+theme_bw()->ppc_grow_season


ppc_dens_overlay(poar_sites_season.grow$y_g, y_gps_sim)+
  xlab("Growth status")+ylab("Density")+
  ggtitle((""))+theme(legend.position = "none")+theme_bw()->ppc_grow_season_polyn

# print figure
# pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Figures/PPCGrowth.pdf",useDingbats = F,height=7,width=6)
# multiplot(ppc_grow_annual,ppc_grow_annualpolyn,ppc_grow_season,
#           ppc_grow_season_polyn,cols=2)
# dev.off()
```

## pull out stan coefficients for growth

```{r}

grow_coefgs <- rstan::extract(fit_allsites_grow_season, c("b0_g","btempdormpptdorm_g","btempgrowpptgrow_g","bsizesex_g","bsex_g", "bsize_g","bpptgrow_g","bpptdorm_g","btempgrow_g","btempdorm_g","bpptgrowsex_g","bpptdormsex_g","btempgrowsex_g","btempdormsex_g","btempdormpptdormsex_g","btempgrowpptgrowsex_g"))

grow_coefgsp <- rstan::extract(fit_allsites_grow_season_polyn, c("b0_g","btempdormpptdorm_g","btempgrowpptgrow_g","bsizesex_g","bsex_g", "bsize_g","bpptgrow_g","bpptdorm_g","btempgrow_g","btempdorm_g","bpptgrowsex_g","bpptdormsex_g","btempgrowsex_g","btempdormsex_g","btempdormpptdormsex_g","btempgrowpptgrowsex_g","bpptgrow2_g","bpptdorm2_g","btempgrow2_g","btempdorm2_g","bpptgrow2sex_g","bpptdorm2sex_g","btempgrow2sex_g","btempdorm2sex_g","sigma"))

```

# Plot growth  with climate variables
## Re-format data for plotting 

```{r}
poarclim_seasonal.grow %>% 
  group_by(site,Sex) %>% 
  summarise(mean_grow = mean(tillerN_t1),
            mean_size = mean(tillerN_t0),
            mean_pptgrow= mean(pptgrow),
            mean_temprow= mean(tempgrow),
            mean_pptdorm= mean(pptdorm),
            mean_tempdorm= mean(tempdorm),
            pptgrow = unique(pptgrow),
            tempgrow = unique(tempgrow),
            pptdorm = unique(pptdorm),
            tempdorm = unique(tempdorm))->poar_grow_plot_season

zpoar_grow_plot_season<-scale(poar_grow_plot_season[,4:12])
zpoar_grow_plot_season<-data.frame(poar_grow_plot_season[,1:3],zpoar_grow_plot_season)

grow_mean_sizesseason <- zpoar_grow_plot_season %>% group_by(Sex) %>% summarise(size = mean(mean_size))
grow_mean_tempgrow <- zpoar_grow_plot_season %>% group_by(Sex) %>% summarise(tempgrow = mean(tempgrow))
grow_mean_tempdorm <- zpoar_grow_plot_season %>% group_by(Sex) %>% summarise(tempdorm = mean(tempdorm))
grow_mean_pptgrow <- zpoar_grow_plot_season %>% group_by(Sex) %>% summarise(pptgrow = mean(pptgrow))
grow_mean_pptdorm <- zpoar_grow_plot_season %>% group_by(Sex) %>% summarise(pptdorm = mean(pptdorm))
```


```{r}
pptgrow_seq <- seq(min(zpoar_surv_plot_season$pptgrow),max(zpoar_surv_plot_season$pptgrow),0.1)
tempgrow_seq <- seq(min(zpoar_surv_plot_season$tempgrow),max(zpoar_surv_plot_season$tempgrow),0.1)
pptdorm_seq <- seq(min(zpoar_surv_plot_season$pptdorm),max(zpoar_surv_plot_season$pptdorm),0.1)
tempdorm_seq <- seq(min(zpoar_surv_plot_season$tempdorm),max(zpoar_surv_plot_season$tempdorm),0.1)
```

## Plot for seasonnal growth 

```{r}
par(mfrow = c(2, 4))
with(zpoar_grow_plot_season,{
    plot(pptgrow,mean_grow,
         xlab=" Precipitation growing",ylab=" #tillers");box()
    for(s in 1:2){
      points(pptgrow[Sex==s],mean_grow[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(pptgrow_seq,exp(mean(grow_coefgs$b0_g) + 
                        mean(grow_coefgs$bsize_g) * grow_mean_sizesseason$size[grow_mean_sizesseason$Sex==s] +
                        mean(grow_coefgs$bsex_g) * (s-1) +
                        mean(grow_coefgs$bsizesex_g)*grow_mean_sizesseason$size[grow_mean_sizesseason$Sex==s]* (s-1) +
                        mean(grow_coefgs$bpptgrow_g) * pptgrow_seq +
                        mean(grow_coefgs$bpptdorm_g) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s]  +
                        mean(grow_coefgs$btempgrow_g) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                        mean(grow_coefgs$btempdorm_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] +
                        mean(grow_coefgs$bpptgrowsex_g) * pptgrow_seq * (s-1) +
                        mean(grow_coefgs$bpptdormsex_g) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s]  * (s-1) +
                        mean(grow_coefgs$btempgrowsex_g) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] * (s-1) +
                        mean(grow_coefgs$btempdormsex_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * (s-1) +
                        mean(grow_coefgs$btempdormpptdorm_g)*grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s]* grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] +
                          mean(grow_coefgs$btempgrowpptgrow_g)*pptgrow_seq*grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s]+
                        mean(grow_coefgs$btempdormpptdormsex_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] * (s-1) +
                        mean(grow_coefgs$btempgrowpptgrowsex_g) * pptgrow_seq * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s]  * (s-1) 
      ),col= sex_cols[s],lwd=3)
    }
})

with(zpoar_grow_plot_season,{
    plot(tempgrow,mean_grow,
         xlab=" Temperature growing",ylab=" #tillers");box()
    for(s in 1:2){
      points(tempgrow[Sex==s],mean_grow[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(tempgrow_seq,exp(mean(grow_coefgs$b0_g) + 
                        mean(grow_coefgs$bsize_g) * grow_mean_sizesseason$size[grow_mean_sizesseason$Sex==s] +
                        mean(grow_coefgs$bsex_g) * (s-1) +
                        mean(grow_coefgs$bsizesex_g) * grow_mean_sizesseason$size[grow_mean_sizesseason$Sex==s]* (s-1) +
                        mean(grow_coefgs$bpptgrow_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s]  +
                        mean(grow_coefgs$bpptdorm_g) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s]  +
                        mean(grow_coefgs$btempgrow_g) * tempgrow_seq +
                        mean(grow_coefgs$btempdorm_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] +
                        mean(grow_coefgs$bpptgrowsex_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * (s-1) +
                        mean(grow_coefgs$bpptdormsex_g) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s]  * (s-1) +
                        mean(grow_coefgs$btempgrowsex_g) * tempgrow_seq * (s-1) +
                        mean(grow_coefgs$btempdormsex_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * (s-1) +
                        mean(grow_coefgs$btempdormpptdorm_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] +
                        mean(grow_coefgs$btempgrowpptgrow_g) * tempgrow_seq * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                        mean(grow_coefgs$btempdormpptdormsex_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] * (s-1) +
                        mean(grow_coefgs$btempgrowpptgrowsex_g) * tempgrow_seq * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s]  * (s-1) 
      ),col= sex_cols[s],lwd=3)
    }
})

with(zpoar_grow_plot_season,{
    plot(pptdorm,mean_grow,
         xlab=" Precipitation dormant",ylab="#tillers");box()
    for(s in 1:2){
      points(pptdorm[Sex==s],mean_grow[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(pptdorm_seq,exp(mean(grow_coefgs$b0_g) + 
                        mean(grow_coefgs$bsize_g) * grow_mean_sizesseason$size[grow_mean_sizesseason$Sex==s] +
                        mean(grow_coefgs$bsex_g) * grow_mean_sizesseason$size[grow_mean_sizesseason$Sex==s] * (s-1) +
                        mean(grow_coefgs$bsizesex_g) * (s-1) +
                        mean(grow_coefgs$bpptgrow_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s]  +
                        mean(grow_coefgs$bpptdorm_g) * pptdorm_seq +
                        mean(grow_coefgs$btempgrow_g) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                        mean(grow_coefgs$btempdorm_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] +
                        mean(grow_coefgs$bpptgrowsex_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s]  * (s-1) +
                        mean(grow_coefgs$bpptdormsex_g) * pptdorm_seq  * (s-1) +
                        mean(grow_coefgs$btempgrowsex_g) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] * (s-1) +
                        mean(grow_coefgs$btempdormsex_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * (s-1) +
                        mean(grow_coefgs$btempdormpptdorm_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * pptdorm_seq +
                        mean(grow_coefgs$btempgrowpptgrow_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s]  * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                        mean(grow_coefgs$btempdormpptdormsex_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * pptdorm_seq * (s-1) +
                        mean(grow_coefgs$btempgrowpptgrowsex_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s]  * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s]  * (s-1) 
      ),col= sex_cols[s],lwd=3)
    }
})

with(zpoar_grow_plot_season,{
    plot(tempdorm,mean_grow,
         xlab=" Temperature dormant",ylab="#tillers");box()
    for(s in 1:2){
      points(tempdorm[Sex==s],mean_grow[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(tempdorm_seq,exp(mean(grow_coefgs$b0_g) + 
                        mean(grow_coefgs$bsize_g) * grow_mean_sizesseason$size[grow_mean_sizesseason$Sex==s] +
                        mean(grow_coefgs$bsex_g) * grow_mean_sizesseason$size[grow_mean_sizesseason$Sex==s] * (s-1) +
                        mean(grow_coefgs$bsizesex_g) * (s-1) +
                        mean(grow_coefgs$bpptgrow_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s]  +
                        mean(grow_coefgs$bpptdorm_g) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s]  +
                        mean(grow_coefgs$btempgrow_g) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                        mean(grow_coefgs$btempdorm_g) * tempdorm_seq +
                        mean(grow_coefgs$bpptgrowsex_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * (s-1) +
                        mean(grow_coefgs$bpptdormsex_g) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s]  * (s-1) +
                        mean(grow_coefgs$btempgrowsex_g) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] * (s-1) +
                        mean(grow_coefgs$btempdormsex_g) * tempdorm_seq * (s-1) +
                        mean(grow_coefgs$btempdormpptdorm_g) * tempdorm_seq * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] +
                        mean(grow_coefgs$btempgrowpptgrow_g) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] +
                        mean(grow_coefgs$btempdormpptdormsex_g) * tempdorm_seq * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] * (s-1) +
                        mean(grow_coefgs$btempgrowpptgrowsex_g) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s]   * (s-1) 
      ),col= sex_cols[s],lwd=3)
    }
})


with(zpoar_grow_plot_season,{
    plot(pptgrow,mean_grow,
         xlab=" Precipitation growing",ylab="#tillers");box()
    for(s in 1:2){
      points(pptgrow[Sex==s],mean_grow[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(pptgrow_seq,exp(mean(grow_coefgsp$b0_g) + 
                        mean(grow_coefgsp$bsize_g) * grow_mean_sizesseason$size[grow_mean_sizesseason$Sex==s] +
                        mean(grow_coefgsp$bsex_g) * (s-1) +
                        mean(grow_coefgsp$bsizesex_g) * grow_mean_sizesseason$size[grow_mean_sizesseason$Sex==s] * (s-1)+
                        mean(grow_coefgsp$bpptgrow_g) * pptgrow_seq +
                        mean(grow_coefgsp$bpptdorm_g) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s]  +
                        mean(grow_coefgsp$btempgrow_g) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                        mean(grow_coefgsp$btempdorm_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] +
                        mean(grow_coefgsp$bpptgrowsex_g) * pptgrow_seq * (s-1) +
                        mean(grow_coefgsp$bpptdormsex_g) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s]  * (s-1) +
                        mean(grow_coefgsp$btempgrowsex_g) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] * (s-1) +
                        mean(grow_coefgsp$btempdormsex_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * (s-1) +
                        mean(grow_coefgsp$btempdormpptdorm_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] +
                        mean(grow_coefgsp$btempgrowpptgrow_g) * pptgrow_seq * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                        mean(grow_coefgsp$btempdormpptdormsex_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] * (s-1) +
                        mean(grow_coefgsp$btempgrowpptgrowsex_g) * pptgrow_seq * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s]  * (s-1) +
                        mean(grow_coefgsp$bpptgrow2_g) * (pptgrow_seq^2) +
                        mean(grow_coefgsp$bpptdorm2_g) * (grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s])^2 +
                        mean(grow_coefgsp$btempgrow2_g) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 +
                        mean(grow_coefgsp$btempdorm2_g) * (grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s])^2 +
                        mean(grow_coefgsp$bpptgrow2sex_g) * (pptgrow_seq^2) * (s-1) +
                        mean(grow_coefgsp$bpptdorm2sex_g) * (grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s])^2 * (s-1) +
                        mean(grow_coefgsp$btempgrow2sex_g) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 * (s-1) +
                        mean(grow_coefgsp$btempdorm2sex_g) * (grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s])^2 * (s-1) 
      ),col= sex_cols[s],lwd=3)
    }
})

with(zpoar_grow_plot_season,{
    plot(tempgrow,mean_grow,
         xlab="Temperature growing",ylab="#tillers");box()
    for(s in 1:2){
      points(tempgrow[Sex==s],mean_grow[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(tempgrow_seq,exp(mean(grow_coefgsp$b0_g) + 
                        mean(grow_coefgsp$bsize_g) * grow_mean_sizesseason$size[grow_mean_sizesseason$Sex==s] +
                        mean(grow_coefgsp$bsex_g) * (s-1) +
                        mean(grow_coefgsp$bsizesex_g) * grow_mean_sizesseason$size[grow_mean_sizesseason$Sex==s] * (s-1) +
                        mean(grow_coefgsp$bpptgrow_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s]  +
                        mean(grow_coefgsp$bpptdorm_g) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s]  +
                        mean(grow_coefgsp$btempgrow_g) * tempgrow_seq +
                        mean(grow_coefgsp$btempdorm_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] +
                        mean(grow_coefgsp$bpptgrowsex_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * (s-1) +
                        mean(grow_coefgsp$bpptdormsex_g) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s]  * (s-1) +
                        mean(grow_coefgsp$btempgrowsex_g) * tempgrow_seq * (s-1) +
                        mean(grow_coefgsp$btempdormsex_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * (s-1) +
                        mean(grow_coefgsp$btempdormpptdorm_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s]  +
                        mean(grow_coefgsp$btempgrowpptgrow_g) * tempgrow_seq * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s]  +
                        mean(grow_coefgsp$btempdormpptdormsex_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s] * (s-1) +
                        mean(grow_coefgsp$btempgrowpptgrowsex_g) * tempgrow_seq * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s]  * (s-1) +
                        mean(grow_coefgsp$bpptgrow2_g) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 +
                        mean(grow_coefgsp$bpptdorm2_g) * (grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s])^2 +
                        mean(grow_coefgsp$btempgrow2_g) * (tempgrow_seq^2) +
                        mean(grow_coefgsp$btempdorm2_g) * (grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s])^2 +
                        mean(grow_coefgsp$bpptgrow2sex_g) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 * (s-1) +
                        mean(grow_coefgsp$bpptdorm2sex_g) * (grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s])^2 * (s-1) +
                        mean(grow_coefgsp$btempgrow2sex_g) * (tempgrow_seq^2) * (s-1) +
                        mean(grow_coefgsp$btempdorm2sex_g) * (grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s])^2 * (s-1)
                        
      ),col= sex_cols[s],lwd=3)
    }
})

with(zpoar_grow_plot_season,{
    plot(pptdorm,mean_grow,
         xlab=" Precipitation dormant",ylab="#tillers");box()
    for(s in 1:2){
      points(pptdorm[Sex==s],mean_grow[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(pptdorm_seq,exp(mean(grow_coefgsp$b0_g) + 
                        mean(grow_coefgsp$bsize_g) * grow_mean_sizesseason$size[grow_mean_sizesseason$Sex==s] +
                        mean(grow_coefgsp$bsex_g) * (s-1) +
                        mean(grow_coefgsp$bsizesex_g) * grow_mean_sizesseason$size[grow_mean_sizesseason$Sex==s] * (s-1) +
                        mean(grow_coefgsp$bpptgrow_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s]  +
                        mean(grow_coefgsp$bpptdorm_g) * pptdorm_seq +
                        mean(grow_coefgsp$btempgrow_g) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                        mean(grow_coefgsp$btempdorm_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] +
                        mean(grow_coefgsp$bpptgrowsex_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s]  * (s-1) +
                        mean(grow_coefgsp$bpptdormsex_g) * pptdorm_seq  * (s-1) +
                        mean(grow_coefgsp$btempgrowsex_g) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] * (s-1) +
                        mean(grow_coefgsp$btempdormsex_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * (s-1) +
                        mean(grow_coefgsp$btempdormpptdorm_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * pptdorm_seq +
                        mean(grow_coefgsp$btempgrowpptgrow_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s]  * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s]  +
                        mean(grow_coefgsp$btempdormpptdormsex_g) * grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s] * pptdorm_seq * (s-1) +
                        mean(grow_coefgsp$btempgrowpptgrowsex_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s]  * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s]  * (s-1) +
                        mean(grow_coefgsp$bpptgrow2_g) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 +
                        mean(grow_coefgsp$bpptdorm2_g) * (pptdorm_seq^2) +
                        mean(grow_coefgsp$btempgrow2_g) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 +
                        mean(grow_coefgsp$btempdorm2_g) * (grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s])^2 +
                        mean(grow_coefgsp$bpptgrow2sex_g) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 * (s-1) +
                        mean(grow_coefgsp$bpptdorm2sex_g) * (pptdorm_seq^2) * (s-1) +
                        mean(grow_coefgsp$btempgrow2sex_g) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 * (s-1) +
                        mean(grow_coefgsp$btempdorm2sex_g) *  (grow_mean_tempdorm$tempdorm[grow_mean_tempdorm$Sex==s])^2 * (s-1) 
                        
      ),col= sex_cols[s],lwd=3)
    }
})

with(zpoar_grow_plot_season,{
    plot(tempdorm,mean_grow,
         xlab=" Temperature dormant",ylab="#tillers");box()
    for(s in 1:2){
      points(tempdorm[Sex==s],mean_grow[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(tempdorm_seq,exp(mean(grow_coefgsp$b0_g) + 
                        mean(grow_coefgsp$bsize_g) * grow_mean_sizesseason$size[grow_mean_sizesseason$Sex==s] +
                        mean(grow_coefgsp$bsex_g) * (s-1) +
                        mean(grow_coefgsp$bsizesex_g) * grow_mean_sizesseason$size[grow_mean_sizesseason$Sex==s] * (s-1) +
                        mean(grow_coefgsp$bpptgrow_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s]  +
                        mean(grow_coefgsp$bpptdorm_g) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s]  +
                        mean(grow_coefgsp$btempgrow_g) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] +
                        mean(grow_coefgsp$btempdorm_g) * tempdorm_seq +
                        mean(grow_coefgsp$bpptgrowsex_g) * grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s] * (s-1) +
                        mean(grow_coefgsp$bpptdormsex_g) * grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s]  * (s-1) +
                        mean(grow_coefgsp$btempgrowsex_g) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] * (s-1) +
                        mean(grow_coefgsp$btempdormsex_g) * tempdorm_seq * (s-1) +
                        mean(grow_coefgsp$btempdormpptdorm_g) * tempdorm_seq * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] +
                        mean(grow_coefgsp$btempgrowpptgrow_g) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s] +
                        mean(grow_coefgsp$btempdormpptdormsex_g) * tempdorm_seq * surv_mean_pptdorm$pptdorm[surv_mean_pptdorm$Sex==s] * (s-1) +
                        mean(grow_coefgsp$btempgrowpptgrowsex_g) * grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s] * surv_mean_pptgrow$pptgrow[surv_mean_pptgrow$Sex==s]   * (s-1) +
                        mean(grow_coefgsp$bpptgrow2_g) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 +
                        mean(grow_coefgsp$bpptdorm2_g) * (grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s])^2 +
                        mean(grow_coefgsp$btempgrow2_g) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s])^2 +
                        mean(grow_coefgsp$btempdorm2_g) * (tempdorm_seq^2) +
                        mean(grow_coefgsp$bpptgrow2sex_g) * (grow_mean_pptgrow$pptgrow[grow_mean_pptgrow$Sex==s])^2 * (s-1) +
                        mean(grow_coefgsp$bpptdorm2sex_g) * (grow_mean_pptdorm$pptdorm[grow_mean_pptdorm$Sex==s])^2 * (s-1) +
                        mean(grow_coefgsp$btempgrow2sex_g) * (grow_mean_tempgrow$tempgrow[grow_mean_tempgrow$Sex==s]) * (s-1) +
                        mean(grow_coefgsp$btempdorm2sex_g) * (tempdorm_seq^2) * (s-1) 
                        
      ),col= sex_cols[s],lwd=3)
    }
})

```



# Flowering
## First  model: seasonnal data 
### Reshape the data
```{r}
poar.clim_seasonal %>% 
  subset( tillerN_t1 > 0 )%>%
  dplyr::select( year, Code, site, Block, Sex, 
          Longitude, Latitude, 
          tillerN_t1, flowerN_t1,flow_t1,pptgrow,pptdorm,tempgrow,tempdorm,site)%>% 
  na.omit %>% 
  mutate( site         = site %>% as.factor %>% as.numeric,
          Block = Block %>% as.factor %>% as.numeric,
          Sex          = Sex %>% as.factor %>% as.numeric,
          source = Code %>% as.factor %>% as.numeric ) %>%
  mutate( z_size_t1   = tillerN_t1 %>% scale %>% .[,1],
          z_ppt_t1_grow = pptgrow %>% scale %>% .[,1],
          z_ppt_t1_dorm = pptdorm %>% scale %>% .[,1],
          z_temp_t1_grow = tempgrow %>% scale %>% .[,1],
          z_temp_t1_dorm = tempdorm %>% scale %>% .[,1])->poarclim_seasonal.flow


poar_sites_season.flow <- list( n_sites    = poarclim_seasonal.surv$site %>% n_distinct,
                  n_sources  = poarclim_seasonal.surv$source %>% n_distinct(),
                  # flowering data
                   n_blocks_f = poarclim_seasonal.flow$Block %>% n_distinct,
                  site_f   = poarclim_seasonal.flow$site,
                  source_f =  poarclim_seasonal.flow$source,
                  block_f  = poarclim_seasonal.flow$Block,
                  pptgrow_f=poarclim_seasonal.flow$z_ppt_t1_grow,
                  pptdorm_f=poarclim_seasonal.flow$z_ppt_t1_dorm,
                  tempgrow_f=poarclim_seasonal.flow$z_temp_t1_grow,
                  tempdorm_f=poarclim_seasonal.flow$z_temp_t1_dorm,
                  site_block_f = data.frame( site_i  = poarclim_seasonal.flow$site,
                                             block_i = poarclim_seasonal.flow$Block ) %>%
                    unique %>% .$site_i,
                  male_f   = poarclim_seasonal.flow$Sex-1,
                  size_f   = poarclim_seasonal.flow$z_size_t1,
                  y_f      = poarclim_seasonal.flow$flow_t1,
                  n_f      = nrow(poarclim_seasonal.flow))
```

```{r , eval=FALSE}
fit_allsites_flow_season <- stan(
 file = "/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/stan/poar_flow_season.stan",
 data = poar_sites_season.flow,
 warmup = sim_pars$warmup,
 iter = sim_pars$iter,
 thin = sim_pars$thin,
 chains = sim_pars$chains)


saveRDS(fit_allsites_flow_season, '/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/Current conditions/poar_flow_season.rds')

#load stan output -- this will also take a while, but not as long as running the model from scratch
fit_allsites_flow_season <- readRDS(url("https://www.dropbox.com/s/esq822z7cbie4os/poar_flow_season.rds?dl=1"))
#ignore warning from readRDS
```

```{r}
traceplot(fit_allsites_flow_season, pars = c("b0_f","bsizesex_f","bsex_f", "bsize_f","bpptgrow_f","bpptdorm_f","btempgrow_f","btempdorm_f","bpptgrowsex_f","bpptdormsex_f","btempgrowsex_f","btempdormsex_f","btempdormpptdorm_f","btempgrowpptgrow_f","btempdormpptdormsex_f","btempgrowpptgrowsex_f"), inc_warmup = TRUE, nrow =9 )

```


```{r}
log_lik_flow_season <- loo::extract_log_lik(fit_allsites_flow_season, merge_chains = FALSE)
r_eff_flow_season <- loo::relative_eff(exp(log_lik_flow_season))
loo_flow_season <- loo(log_lik_flow_season, r_eff = r_eff_flow_season, cores = 2)
# print(loo_flow_season)
# plot(loo_flow_season)
```

## Fourth  model: seasonnal data with polynomial second order
### Running the stan model
```{r , eval=FALSE}
fit_allsites_flow_season_polyn <- stan(
 file = "/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/stan/poar_flow_seasonpolynomial.stan",
 data = poar_sites_season.flow,
 warmup = sim_pars$warmup,
 iter = sim_pars$iter,
 thin = sim_pars$thin,
 chains = sim_pars$chains)

saveRDS(fit_allsites_flow_season_polyn, '/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/Current conditions/poar_flow_seasonpolynomial.rds')

#load stan output -- this will also take a while, but not as long as running the model from scratch
fit_allsites_flow_season_polyn <- readRDS(url("https://www.dropbox.com/s/o5r2hijb256fmb7/poar_flow_seasonpolynomial.rds?dl=1"))
#ignore warning from readRDS

```

```{r}
traceplot(fit_allsites_flow_season_polyn, pars = c("b0_f","bsizesex_f","bsex_f", "bsize_f","bpptgrow_f","bpptdorm_f","btempgrow_f","btempdorm_f","bpptgrowsex_f","bpptdormsex_f","btempgrowsex_f","btempdormsex_f","btempdormpptdorm_f","btempgrowpptgrow_f","btempdormpptdormsex_f","btempgrowpptgrowsex_f","bpptgrow2_f","bpptdorm2_f","btempgrow2_f","btempdorm2_f","bpptgrow2sex_f","bpptdorm2sex_f","btempgrow2sex_f","btempdorm2sex_f"), inc_warmup = TRUE, nrow =15 )


```

```{r}
log_lik_flow_season_polyn <- loo::extract_log_lik(fit_allsites_flow_season_polyn, merge_chains = FALSE)
r_eff_flow_season_polyn <- loo::relative_eff(exp(log_lik_flow_season_polyn))
loo_flow_season_polyn <- loo(log_lik_flow_season_polyn, r_eff = r_eff_flow_season_polyn, cores = 2)
# print(loo_flow_season_polyn)
# plot(loo_flow_season_polyn)
```


## Model comparaison
```{r}
comp_flow <- loo::loo_compare(loo_flow_season,loo_flow_season_polyn)
print(comp_flow)
```

```{r}
posteriorflow_season <- as.array(fit_allsites_flow_season)
color_scheme_set("blue")
mcmc_intervals(posteriorflow_season, pars = c("b0_f", "bsize_f","bpptgrow_f","bpptdorm_f","btempgrow_f","btempdorm_f","bpptgrowsex_f","bpptdormsex_f","btempgrowsex_f","btempdormsex_f","btempdormpptdormsex_f","btempgrowpptgrowsex_f"))+ geom_vline(xintercept = 0, linetype = 2)+theme_bw()
```

```{r}
posteriorflow_season_polyn <- as.array(fit_allsites_flow_season_polyn)
color_scheme_set("blue")
mcmc_intervals(posteriorflow_season_polyn, pars = c("b0_f", "bsize_f","bpptgrow_f","bpptdorm_f","btempgrow_f","btempdorm_f","bpptgrowsex_f","bpptdormsex_f","btempgrowsex_f","btempdormsex_f","btempdormpptdormsex_f","btempgrowpptgrowsex_f","bpptgrow2_f","bpptdorm2_f","btempgrow2_f","btempdorm2_f","bpptgrow2sex_f","bpptdorm2sex_f","btempgrow2sex_f","btempdorm2sex_f"))+ geom_vline(xintercept = 0, linetype = 2)+theme_bw()
```

## Posterior predictive check for flowering

```{r}
#pull out parameter posterior distributions

predFS <- rstan::extract(fit_allsites_flow_season, pars = c("predF"))$predF
predFSP <- rstan::extract(fit_allsites_flow_season_polyn, pars = c("predF"))$predF


#draw 500 random samples from the joint posterior
n_post_draws <- 500
# post_draws <- sample.int(dim(predSA)[1], n_post_draws)
#set up simulation output

y_fs_sim <- matrix(NA,n_post_draws,length(poar_sites_season.flow$y_f))
y_fps_sim <- matrix(NA,n_post_draws,length(poar_sites_season.flow$y_f))


#loop over the posterior and generate new observations
for(i in 1:n_post_draws){
  print(i)
  
  ## sample flowering data (bernoulli)
  y_fs_sim [i,] <- rbinom(n=length(poar_sites_season.flow$y_f), size=1, prob = invlogit(predFS[i,]))
  ## sample flowering data (bernoulli)
  y_fps_sim [i,] <- rbinom(n=length(poar_sites_season.flow$y_f), size=1, prob = invlogit(predFSP[i,]))

}
```
# plot ppc overlay for survival
```{r}


ppc_dens_overlay(poar_sites_season.flow$y_f, y_fs_sim)+
  xlab("Flowering status")+ylab("Density")+
  ggtitle((""))+theme(legend.position = "none")+theme_bw()->ppc_flow_season


ppc_dens_overlay(poar_sites_season.flow$y_f, y_fps_sim)+
  xlab("Flowering status")+ylab("Density")+
  ggtitle((""))+theme(legend.position = "none")+theme_bw()->ppc_flow_season_polyn

#print figure
# pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Figures/PPCFlowering.pdf",useDingbats = F,height=7,width=6)
# multiplot(ppc_flow_annual,ppc_flow_annualpolyn,ppc_flow_season,
#           ppc_flow_season_polyn,cols=2)
# dev.off()
```

# pull out stan coefficients for flowering

```{r}
flow_coeffs <- rstan::extract(fit_allsites_flow_season, c("b0_f","bsex_f","bsizesex_f", "bsize_f","bpptgrow_f","bpptdorm_f","btempgrow_f","btempdorm_f","bpptgrowsex_f","bpptdormsex_f","btempgrowsex_f","btempdormsex_f","btempdormpptdormsex_f","btempgrowpptgrowsex_f","btempdormpptdorm_f","btempgrowpptgrow_f"))

flow_coeffsp <- rstan::extract(fit_allsites_flow_season_polyn, c("b0_f","bsex_f","bsizesex_f", "bsize_f","bpptgrow_f","bpptdorm_f","btempgrow_f","btempdorm_f","bpptgrowsex_f","bpptdormsex_f","btempgrowsex_f","btempdormsex_f","btempdormpptdorm_f","btempgrowpptgrow_f","btempdormpptdormsex_f","btempgrowpptgrowsex_f","bpptgrow2_f","bpptdorm2_f","btempgrow2_f","btempdorm2_f","bpptgrow2sex_f","bpptdorm2sex_f","btempgrow2sex_f","btempdorm2sex_f"))

```

# Plot flowering with climate variables
## Re-format data for plotting 

```{r}
poarclim_seasonal.flow %>% 
  group_by(site,Sex) %>% 
  summarise(mean_flow = mean(flow_t1),
            mean_size = mean(tillerN_t1),
            mean_pptgrow= mean(pptgrow),
            mean_temprow= mean(tempgrow),
            mean_pptdorm= mean(pptdorm),
            mean_tempdorm= mean(tempdorm),
            pptgrow = unique(pptgrow),
            tempgrow = unique(tempgrow),
            pptdorm = unique(pptdorm),
            tempdorm = unique(tempdorm))->poar_flow_plot_season


zpoar_flow_plot_season<-scale(poar_flow_plot_season[,4:12])
zpoar_flow_plot_season<-data.frame(poar_flow_plot_season[,1:3],zpoar_flow_plot_season)


flow_mean_sizesseason <- zpoar_flow_plot_season %>% group_by(Sex) %>% summarise(size = mean(mean_size))
flow_mean_tempgrow <- zpoar_flow_plot_season %>% group_by(Sex) %>% summarise(tempgrow = mean(tempgrow))
flow_mean_tempdorm <- zpoar_flow_plot_season %>% group_by(Sex) %>% summarise(tempdorm = mean(tempdorm))
flow_mean_pptgrow <- zpoar_flow_plot_season %>% group_by(Sex) %>% summarise(pptgrow = mean(pptgrow))
flow_mean_pptdorm <- zpoar_flow_plot_season %>% group_by(Sex) %>% summarise(pptdorm = mean(pptdorm))
```


```{r}
pptgrow_seq <- seq(min(zpoar_flow_plot_season$pptgrow),max(zpoar_flow_plot_season$pptgrow),0.1)
tempgrow_seq <- seq(min(zpoar_flow_plot_season$tempgrow),max(zpoar_flow_plot_season$tempgrow),0.1)
pptdorm_seq <- seq(min(zpoar_flow_plot_season$pptdorm),max(zpoar_flow_plot_season$pptdorm),0.1)
tempdorm_seq <- seq(min(zpoar_flow_plot_season$tempdorm),max(zpoar_flow_plot_season$tempdorm),0.1)
```

## Plot for seasonnal flowering 


```{r}
par(mfrow = c(2, 4))
with(zpoar_flow_plot_season,{
    plot(pptgrow,mean_flow,ylim=c(0,1),
         xlab=" Precipitation growing",ylab=" Pr Flowering");box()
    for(s in 1:2){
      points(pptgrow[Sex==s],mean_flow[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(pptgrow_seq,invlogit(mean(flow_coeffs$b0_f) + 
                        mean(flow_coeffs$bsize_f) * flow_mean_sizesseason$size[flow_mean_sizesseason$Sex==s] +
                        mean(flow_coeffs$bsizesex_f) * flow_mean_sizesseason$size[flow_mean_sizesseason$Sex==s]* (s-1) +
                        mean(flow_coeffs$bsex_f) * (s-1) +
                        mean(flow_coeffs$bpptgrow_f) * pptgrow_seq +
                        mean(flow_coeffs$bpptdorm_f) * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s]  +
                        mean(flow_coeffs$btempgrow_f) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                        mean(flow_coeffs$btempdorm_f) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] +
                        mean(flow_coeffs$bpptgrowsex_f) * pptgrow_seq * (s-1) +
                        mean(flow_coeffs$bpptdormsex_f) * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s]  * (s-1) +
                        mean(flow_coeffs$btempgrowsex_f) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] * (s-1) +
                        mean(flow_coeffs$btempdormsex_f) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * (s-1) +
                        mean(flow_coeffs$btempdormpptdorm_f) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s]  +
                        mean(flow_coeffs$btempgrowpptgrow_f) * pptgrow_seq * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s]  + 
                        mean(flow_coeffs$btempdormpptdormsex_f) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s] * (s-1) +
                        mean(flow_coeffs$btempgrowpptgrowsex_f) * pptgrow_seq * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s]  * (s-1) 
      ),col= sex_cols[s],lwd=3)
    }
})

with(zpoar_flow_plot_season,{
    plot(tempgrow,mean_flow,ylim=c(0,1),
         xlab=" Temperature growing",ylab=" Pr  Flowering");box()
    for(s in 1:2){
      points(tempgrow[Sex==s],mean_flow[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(tempgrow_seq,invlogit(mean(flow_coeffs$b0_f) + 
                        mean(flow_coeffs$bsize_f) * flow_mean_sizesseason$size[flow_mean_sizesseason$Sex==s] +
                        mean(flow_coeffs$bsizesex_f) * flow_mean_sizesseason$size[flow_mean_sizesseason$Sex==s] * (s-1)  +
                        mean(flow_coeffs$bsex_f) * (s-1) +
                        mean(flow_coeffs$bpptgrow_f) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s]  +
                        mean(flow_coeffs$bpptdorm_f) * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s]  +
                        mean(flow_coeffs$btempgrow_f) * tempgrow_seq +
                        mean(flow_coeffs$btempdorm_f) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] +
                        mean(flow_coeffs$bpptgrowsex_f) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] * (s-1) +
                        mean(flow_coeffs$bpptdormsex_f) * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s]  * (s-1) +
                        mean(flow_coeffs$btempgrowsex_f) * tempgrow_seq * (s-1) +
                        mean(flow_coeffs$btempdormsex_f) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * (s-1) +
                        mean(flow_coeffs$btempdormpptdorm_f) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s]  +
                        mean(flow_coeffs$btempgrowpptgrow_f) * tempgrow_seq * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s]+
                        mean(flow_coeffs$btempdormpptdormsex_f) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s] * (s-1) +
                        mean(flow_coeffs$btempgrowpptgrowsex_f) * tempgrow_seq * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s]  * (s-1) 
      ),col= sex_cols[s],lwd=3)
    }
})

with(zpoar_flow_plot_season,{
    plot(pptdorm,mean_flow,ylim=c(0,1),
         xlab=" Precipitation dormant",ylab=" Pr  Flowering");box()
    for(s in 1:2){
      points(pptdorm[Sex==s],mean_flow[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(pptdorm_seq,invlogit(mean(flow_coeffs$b0_f) + 
                        mean(flow_coeffs$bsize_f) * flow_mean_sizesseason$size[flow_mean_sizesseason$Sex==s] +
                        mean(flow_coeffs$bsizesex_f) * flow_mean_sizesseason$size[flow_mean_sizesseason$Sex==s] * (s-1)  +
                        mean(flow_coeffs$bsex_f) * (s-1) +
                        mean(flow_coeffs$bpptgrow_f) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s]  +
                        mean(flow_coeffs$bpptdorm_f) * pptdorm_seq +
                        mean(flow_coeffs$btempgrow_f) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                        mean(flow_coeffs$btempdorm_f) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] +
                        mean(flow_coeffs$bpptgrowsex_f) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s]  * (s-1) +
                        mean(flow_coeffs$bpptdormsex_f) * pptdorm_seq  * (s-1) +
                        mean(flow_coeffs$btempgrowsex_f) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] * (s-1) +
                        mean(flow_coeffs$btempdormsex_f) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * (s-1) +
                        mean(flow_coeffs$btempdormpptdorm_f) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * pptdorm_seq  +
                        mean(flow_coeffs$btempgrowpptgrow_f) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s]  * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                        mean(flow_coeffs$btempdormpptdormsex_f) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * pptdorm_seq * (s-1) +
                        mean(flow_coeffs$btempgrowpptgrowsex_f) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s]  * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s]  * (s-1) 
      ),col= sex_cols[s],lwd=3)
    }
})

with(zpoar_flow_plot_season,{
    plot(tempdorm,mean_flow,ylim=c(0,1),
         xlab=" Temperature dormant",ylab=" Pr Flowering");box()
    for(s in 1:2){
      points(tempdorm[Sex==s],mean_flow[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(tempdorm_seq,invlogit(mean(flow_coeffs$b0_f) + 
                        mean(flow_coeffs$bsize_f) * flow_mean_sizesseason$size[flow_mean_sizesseason$Sex==s] +
                        mean(flow_coeffs$bsizesex_f) * flow_mean_sizesseason$size[flow_mean_sizesseason$Sex==s] * (s-1)  +
                        mean(flow_coeffs$bsex_f) * (s-1) +
                        mean(flow_coeffs$bpptgrow_f) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s]  +
                        mean(flow_coeffs$bpptdorm_f) * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s]  +
                        mean(flow_coeffs$btempgrow_f) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                        mean(flow_coeffs$btempdorm_f) * tempdorm_seq +
                        mean(flow_coeffs$bpptgrowsex_f) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] * (s-1) +
                        mean(flow_coeffs$bpptdormsex_f) * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s]  * (s-1) +
                        mean(flow_coeffs$btempgrowsex_f) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] * (s-1) +
                        mean(flow_coeffs$btempdormsex_f) * tempdorm_seq * (s-1) +
                        mean(flow_coeffs$btempdormpptdorm_f) * tempdorm_seq * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s]  +
                        mean(flow_coeffs$btempgrowpptgrow_f) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] +
                        mean(flow_coeffs$btempdormpptdormsex_f) * tempdorm_seq * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s] * (s-1) +
                        mean(flow_coeffs$btempgrowpptgrowsex_f) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s]   * (s-1) 
      ),col= sex_cols[s],lwd=3)
    }
})


with(zpoar_flow_plot_season,{
    plot(pptgrow,mean_flow,ylim=c(0,1),
         xlab=" Precipitation growing",ylab=" Pr Flowering");box()
    for(s in 1:2){
      points(pptgrow[Sex==s],mean_flow[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(pptgrow_seq,invlogit(mean(flow_coeffsp$b0_f) + 
                        mean(flow_coeffsp$bsize_f) * flow_mean_sizesseason$size[flow_mean_sizesseason$Sex==s] +
                        mean(flow_coeffsp$bsizesex_f) * flow_mean_sizesseason$size[flow_mean_sizesseason$Sex==s] * (s-1) +
                        mean(flow_coeffsp$bsex_f) * (s-1) +
                        mean(flow_coeffsp$bpptgrow_f) * pptgrow_seq +
                        mean(flow_coeffsp$bpptdorm_f) * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s]  +
                        mean(flow_coeffsp$btempgrow_f) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                        mean(flow_coeffsp$btempdorm_f) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] +
                        mean(flow_coeffsp$bpptgrowsex_f) * pptgrow_seq * (s-1) +
                        mean(flow_coeffsp$bpptdormsex_f) * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s]  * (s-1) +
                        mean(flow_coeffsp$btempgrowsex_f) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] * (s-1) +
                        mean(flow_coeffsp$btempdormsex_f) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * (s-1) +
                        mean(flow_coeffsp$btempdormpptdorm_f) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s]  +
                        mean(flow_coeffsp$btempgrowpptgrow_f) * pptgrow_seq * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s]   +
                        mean(flow_coeffsp$btempdormpptdormsex_f) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s] * (s-1) +
                        mean(flow_coeffsp$btempgrowpptgrowsex_f) * pptgrow_seq * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s]  * (s-1) +
                        mean(flow_coeffsp$bpptgrow2_f) * (pptgrow_seq^2) +
                        mean(flow_coeffsp$bpptdorm2_f) * (flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s])^2 +
                        mean(flow_coeffsp$btempgrow2_f) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 +
                        mean(flow_coeffsp$btempdorm2_f) * (flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s])^2 +
                        mean(flow_coeffsp$bpptgrow2sex_f) * (pptgrow_seq^2) * (s-1) +
                        mean(flow_coeffsp$bpptdorm2sex_f) * (flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s])^2 * (s-1) +
                        mean(flow_coeffsp$btempgrow2sex_f) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 * (s-1) +
                        mean(flow_coeffsp$btempdorm2sex_f) * (flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s])^2 * (s-1) 
      ),col= sex_cols[s],lwd=3)
    }
})

with(zpoar_flow_plot_season,{
    plot(tempgrow,mean_flow,ylim=c(0,1),
         xlab="Temperature growing",ylab=" Pr Survival");box()
    for(s in 1:2){
      points(tempgrow[Sex==s],mean_flow[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(tempgrow_seq,invlogit(mean(flow_coeffsp$b0_f) + 
                        mean(flow_coeffsp$bsize_f) * flow_mean_sizesseason$size[flow_mean_sizesseason$Sex==s] +
                        mean(flow_coeffsp$bsizesex_f) * flow_mean_sizesseason$size[flow_mean_sizesseason$Sex==s] * (s-1) +
                        mean(flow_coeffsp$bsex_f) * (s-1) +
                        mean(flow_coeffsp$bpptgrow_f) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s]  +
                        mean(flow_coeffsp$bpptdorm_f) * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s]  +
                        mean(flow_coeffsp$btempgrow_f) * tempgrow_seq +
                        mean(flow_coeffsp$btempdorm_f) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] +
                        mean(flow_coeffsp$bpptgrowsex_f) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] * (s-1) +
                        mean(flow_coeffsp$bpptdormsex_f) * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s]  * (s-1) +
                        mean(flow_coeffsp$btempgrowsex_f) * tempgrow_seq * (s-1) +
                        mean(flow_coeffsp$btempdormsex_f) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * (s-1) +
                        mean(flow_coeffsp$btempdormpptdorm_f) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s]  +
                        mean(flow_coeffsp$btempgrowpptgrow_f) * tempgrow_seq * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s]   +
                        mean(flow_coeffsp$btempdormpptdormsex_f) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s] * (s-1) +
                        mean(flow_coeffsp$btempgrowpptgrowsex_f) * tempgrow_seq * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s]  * (s-1) +
                        mean(flow_coeffsp$bpptgrow2_f) * (flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s])^2 +
                        mean(flow_coeffsp$bpptdorm2_f) * (flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s])^2 +
                        mean(flow_coeffsp$btempgrow2_f) * (tempgrow_seq^2) +
                        mean(flow_coeffsp$btempdorm2_f) * (flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s])^2 +
                        mean(flow_coeffsp$bpptgrow2sex_f) * (flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s])^2 * (s-1) +
                        mean(flow_coeffsp$bpptdorm2sex_f) * (flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s])^2 * (s-1) +
                        mean(flow_coeffsp$btempgrow2sex_f) * (tempgrow_seq^2) * (s-1) +
                        mean(flow_coeffsp$btempdorm2sex_f) * (flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s])^2 * (s-1)
                        
      ),col= sex_cols[s],lwd=3)
    }
})

with(zpoar_flow_plot_season,{
    plot(pptdorm,mean_flow,ylim=c(0,1),
         xlab=" Precipitation dormant",ylab=" Pr Flowering");box()
    for(s in 1:2){
      points(pptdorm[Sex==s],mean_flow[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(pptdorm_seq,invlogit(mean(flow_coeffsp$b0_f) + 
                        mean(flow_coeffsp$bsize_f) * flow_mean_sizesseason$size[flow_mean_sizesseason$Sex==s] +
                        mean(flow_coeffsp$bsizesex_f) * flow_mean_sizesseason$size[flow_mean_sizesseason$Sex==s] * (s-1) +
                        mean(flow_coeffsp$bsex_f) * (s-1) +
                        mean(flow_coeffsp$bpptgrow_f) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s]  +
                        mean(flow_coeffsp$bpptdorm_f) * pptdorm_seq +
                        mean(flow_coeffsp$btempgrow_f) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                        mean(flow_coeffsp$btempdorm_f) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] +
                        mean(flow_coeffsp$bpptgrowsex_f) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s]  * (s-1) +
                        mean(flow_coeffsp$bpptdormsex_f) * pptdorm_seq  * (s-1) +
                        mean(flow_coeffsp$btempgrowsex_f) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] * (s-1) +
                        mean(flow_coeffsp$btempdormsex_f) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * (s-1) +
                        mean(flow_coeffsp$btempdormpptdorm_f) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * pptdorm_seq +
                        mean(flow_coeffsp$btempgrowpptgrow_f) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s]  * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s]  +
                        mean(flow_coeffsp$btempdormpptdormsex_f) * flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s] * pptdorm_seq * (s-1) +
                        mean(flow_coeffsp$btempgrowpptgrowsex_f) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s]  * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s]  * (s-1) +
                        mean(flow_coeffsp$bpptgrow2_f) * (flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s])^2 +
                        mean(flow_coeffsp$bpptdorm2_f) * (pptdorm_seq^2) +
                        mean(flow_coeffsp$btempgrow2_f) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 +
                        mean(flow_coeffsp$btempdorm2_f) * (flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s])^2 +
                        mean(flow_coeffsp$bpptgrow2sex_f) * (flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s])^2 * (s-1) +
                        mean(flow_coeffsp$bpptdorm2sex_f) * (pptdorm_seq^2) * (s-1) +
                        mean(flow_coeffsp$btempgrow2sex_f) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 * (s-1) +
                        mean(flow_coeffsp$btempdorm2sex_f) *  (flow_mean_tempdorm$tempdorm[flow_mean_tempdorm$Sex==s])^2 * (s-1) 
                        
      ),col= sex_cols[s],lwd=3)
    }
})

with(zpoar_flow_plot_season,{
    plot(tempdorm,mean_flow,ylim=c(0,1),
         xlab="Temperature dormant",ylab="Pr Flowering");box()
    for(s in 1:2){
      points(tempdorm[Sex==s],mean_flow[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(tempdorm_seq,invlogit(mean(flow_coeffsp$b0_f) + 
                        mean(flow_coeffsp$bsize_f) * flow_mean_sizesseason$size[flow_mean_sizesseason$Sex==s] +
                        mean(flow_coeffsp$bsizesex_f) * flow_mean_sizesseason$size[flow_mean_sizesseason$Sex==s] * (s-1) +
                        mean(flow_coeffsp$bsex_f) * (s-1) +
                        mean(flow_coeffsp$bpptgrow_f) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s]  +
                        mean(flow_coeffsp$bpptdorm_f) * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s]  +
                        mean(flow_coeffsp$btempgrow_f) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] +
                        mean(flow_coeffsp$btempdorm_f) * tempdorm_seq +
                        mean(flow_coeffsp$bpptgrowsex_f) * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s] * (s-1) +
                        mean(flow_coeffsp$bpptdormsex_f) * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s]  * (s-1) +
                        mean(flow_coeffsp$btempgrowsex_f) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] * (s-1) +
                        mean(flow_coeffsp$btempdormsex_f) * tempdorm_seq * (s-1) +
                        mean(flow_coeffsp$btempdormpptdorm_f) * tempdorm_seq * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s]  +
                        mean(flow_coeffsp$btempgrowpptgrow_f) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s]  +
                        mean(flow_coeffsp$btempdormpptdormsex_f) * tempdorm_seq * flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s] * (s-1) +
                        mean(flow_coeffsp$btempgrowpptgrowsex_f) * flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s] * flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s]   * (s-1) +
                        mean(flow_coeffsp$bpptgrow2_f) * (flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s])^2 +
                        mean(flow_coeffsp$bpptdorm2_f) * (flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s])^2 +
                        mean(flow_coeffsp$btempgrow2_f) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s])^2 +
                        mean(flow_coeffsp$btempdorm2_f) * (tempdorm_seq^2) +
                        mean(flow_coeffsp$bpptgrow2sex_f) * (flow_mean_pptgrow$pptgrow[flow_mean_pptgrow$Sex==s])^2 * (s-1) +
                        mean(flow_coeffsp$bpptdorm2sex_f) * (flow_mean_pptdorm$pptdorm[flow_mean_pptdorm$Sex==s])^2 * (s-1) +
                        mean(flow_coeffsp$btempgrow2sex_f) * (flow_mean_tempgrow$tempgrow[flow_mean_tempgrow$Sex==s]) * (s-1) +
                        mean(flow_coeffsp$btempdorm2sex_f) * (tempdorm_seq^2) * (s-1) 
                        
      ),col= sex_cols[s],lwd=3)
    }
})

```







# Fertility

## first  model: seasonnal data 
### Reshape the data

```{r}
poar.clim_seasonal %>% 
  subset( flowerN_t1 > 0 & tillerN_t1 > 0 )%>%
  dplyr::select( year, Code, site, Block, Sex, 
          Longitude, Latitude, 
          tillerN_t1, flowerN_t1,pptgrow,pptdorm,tempgrow,tempdorm,site)%>% 
  na.omit %>% 
  mutate( site         = site %>% as.factor %>% as.numeric,
          Block = Block %>% as.factor %>% as.numeric,
          Sex          = Sex %>% as.factor %>% as.numeric,
          source = Code %>% as.factor %>% as.numeric,
          panic_t1 = flowerN_t1) %>%
  mutate( z_size_t1   = tillerN_t1 %>% scale %>% .[,1],
          z_ppt_t1_grow = pptgrow %>% scale %>% .[,1],
          z_ppt_t1_dorm = pptdorm %>% scale %>% .[,1],
          z_temp_t1_grow = tempgrow %>% scale %>% .[,1],
          z_temp_t1_dorm = tempdorm %>% scale %>% .[,1])->poarclim_seasonal.panic


poar_sites_season.panic <- list( n_sites    = poarclim_seasonal.surv$site %>% n_distinct,
                  n_sources  = poarclim_seasonal.surv$source %>% n_distinct(),
                  # panicle data
                   n_blocks_p = poarclim_seasonal.panic$Block %>% n_distinct,
                  site_p   = poarclim_seasonal.panic$site,
                  source_p =  poarclim_seasonal.panic$source,
                  block_p  = poarclim_seasonal.panic$Block,
                  pptgrow_p=poarclim_seasonal.panic$z_ppt_t1_grow,
                  pptdorm_p=poarclim_seasonal.panic$z_ppt_t1_dorm,
                  tempgrow_p=poarclim_seasonal.panic$z_temp_t1_grow,
                  tempdorm_p=poarclim_seasonal.panic$z_temp_t1_dorm,
                  site_block_p = data.frame( site_i  = poarclim_seasonal.panic$site,
                                             block_i = poarclim_seasonal.panic$Block ) %>%
                    unique %>% .$site_i,
                  male_p   = poarclim_seasonal.panic$Sex-1,
                  size_p   = poarclim_seasonal.panic$z_size_t1,
                  y_p      = poarclim_seasonal.panic$panic_t1,
                  n_p      = nrow(poarclim_seasonal.panic))
```

### Running the stan model
```{r , eval=FALSE}
fit_allsites_panic_season <- stan(
 file = "/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/stan/poar_panicle_season.stan",
 data = poar_sites_season.panic,
 warmup = sim_pars$warmup,
 iter = sim_pars$iter,
 thin = sim_pars$thin,
 chains = sim_pars$chains)

saveRDS(fit_allsites_panic_season, '/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/Current conditions/poar_panicle_season.rds')

#load stan output -- this will also take a while, but not as long as running the model from scratch
fit_allsites_panic_season <- readRDS(url("https://www.dropbox.com/s/v7h35imi9u7rveo/poar_panicle_season.rds?dl=1"))
#ignore warning from readRDS

```

```{r}
traceplot(fit_allsites_panic_season, pars = c("b0_p","bsizesex_p","bsex_p","btempdormpptdorm_p","btempgrowpptgrow_p", "bsize_p","bpptgrow_p","bpptdorm_p","btempgrow_p","btempdorm_p","bpptgrowsex_p","bpptdormsex_p","btempgrowsex_p","btempdormsex_p","btempdormpptdorm_p","btempgrowpptgrow_p","btempdormpptdormsex_p","btempgrowpptgrowsex_p"), inc_warmup = TRUE, nrow =5 )
```


```{r}
log_lik_panic_season <- loo::extract_log_lik(fit_allsites_panic_season, merge_chains = FALSE)
r_eff_panic_season <- loo::relative_eff(exp(log_lik_panic_season))
loo_panic_season <- loo(log_lik_panic_season, r_eff = r_eff_panic_season, cores = 2)
# print(loo_panic_season)
# plot(loo_panic_season)
```

## Fourth  model: seasonnal data with polynomial second order
### Running the stan model

```{r , eval=FALSE}
fit_allsites_panic_season_polyn <- stan(
 file = "/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/stan/poar_panicle_seasonpolynomial.stan",
 data = poar_sites_season.panic,
 warmup = sim_pars$warmup,
 iter = sim_pars$iter,
 thin = sim_pars$thin,
 chains = sim_pars$chains)

# saveRDS(fit_allsites_panic_season_polyn, '/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/Forecasting Models output/Current conditions/poar_panicle_seasonpolynomial.rds')


#load stan output -- this will also take a while, but not as long as running the model from scratch
fit_allsites_panic_season_polyn <- readRDS(url("https://www.dropbox.com/s/ydtzwurgf7s58lt/poar_panicle_seasonpolynomial.rds?dl=1"))
#ignore warning from readRDS

```

```{r}
traceplot(fit_allsites_panic_season_polyn, pars = c("b0_p","bsizesex_p","bsex_p","btempdormpptdorm_p","btempgrowpptgrow_p", "bsize_p","bpptgrow_p","bpptdorm_p","btempgrow_p","btempdorm_p","bpptgrowsex_p","bpptdormsex_p","btempgrowsex_p","btempdormsex_p","btempdormpptdorm_p","btempgrowpptgrow_p","btempdormpptdormsex_p","btempgrowpptgrowsex_p","bpptgrow2_p","bpptdorm2_p","btempgrow2_p","btempdorm2_p","bpptgrow2sex_p","bpptdorm2sex_p","btempgrow2sex_p","btempdorm2sex_p"), inc_warmup = TRUE, nrow =6 )
```


```{r}
log_lik_panic_season_polyn <- loo::extract_log_lik(fit_allsites_panic_season_polyn, merge_chains = FALSE)
r_eff_panic_season_polyn <- loo::relative_eff(exp(log_lik_panic_season_polyn))
loo_panic_season_polyn <- loo(log_lik_panic_season_polyn, r_eff = r_eff_panic_season_polyn, cores = 2)
# print(loo_panic_season_polyn)
# plot(loo_panic_season_polyn)
```

# Model comparaison
```{r}
# Compare
comp_panic <- loo::loo_compare(loo_panic_season,loo_panic_season_polyn)
print(comp_panic)
```


`

```{r}
posteriorpanic_season <- as.array(fit_allsites_panic_season)
color_scheme_set("blue")
mcmc_intervals(posteriorpanic_season, pars = c("b0_p","bsizesex_p","bsex_p","btempdormpptdorm_p","btempgrowpptgrow_p", "bsize_p","bpptgrow_p","bpptdorm_p","btempgrow_p","btempdorm_p","bpptgrowsex_p","bpptdormsex_p","btempgrowsex_p","btempdormsex_p","btempdormpptdorm_p","btempgrowpptgrow_p","btempdormpptdormsex_p","btempgrowpptgrowsex_p"))+ geom_vline(xintercept = 0, linetype = 2)+theme_bw()
```

```{r}
posteriorpanic_season_polyn <- as.array(fit_allsites_panic_season_polyn)
color_scheme_set("blue")
mcmc_intervals(posteriorpanic_season_polyn, pars = c("b0_p","bsizesex_p","bsex_p","btempdormpptdorm_p","btempgrowpptgrow_p", "bsize_p","bpptgrow_p","bpptdorm_p","btempgrow_p","btempdorm_p","bpptgrowsex_p","bpptdormsex_p","btempgrowsex_p","btempdormsex_p","btempdormpptdorm_p","btempgrowpptgrow_p","btempdormpptdormsex_p","btempgrowpptgrowsex_p","bpptgrow2_p","bpptdorm2_p","btempgrow2_p","btempdorm2_p","bpptgrow2sex_p","bpptdorm2sex_p","btempgrow2sex_p","btempdorm2sex_p"))+ geom_vline(xintercept = 0, linetype = 2)+theme_bw()
```

## Posterior predictive check for fertility

```{r}
#pull out parameter posterior distributions
predPS <- rstan::extract(fit_allsites_panic_season, pars = c("predP"))$predP
predPSP <- rstan::extract(fit_allsites_panic_season_polyn, pars = c("predP"))$predP

phi_PS <- rstan::extract(fit_allsites_panic_season, pars = c("phi_p"))$phi_p
phi_PSP <- rstan::extract(fit_allsites_panic_season_polyn, pars = c("phi_p"))$phi_p


#draw 500 random samples from the joint posterior
n_post_draws <- 500
# post_draws <- sample.int(dim(predPA)[1], n_post_draws)
#set up simulation output

y_ps_sim <- matrix(NA,n_post_draws,length(poar_sites_season.panic$y_p))
y_pps_sim <- matrix(NA,n_post_draws,length(poar_sites_season.panic$y_p))


#loop over the posterior and generate new observations
for(i in 1:n_post_draws){
  print(i)
  ## sample panicle data (zero-truncated NB)
  for(j in 1:length(poar_sites_season.panic$y_p)){
    y_ps_sim[i,j] <- sample(x=1:1000,size=1,replace=T,prob=dnbinom(1:1000, mu = exp(predPS[i,j]), size=phi_PS[i]) / (1 - dnbinom(0, mu = exp(predPS[i,j]), size=phi_PS[i])))
  }
  ## sample panicle data (zero-truncated NB)
  for(j in 1:length(poar_sites_season.panic$y_p)){
    y_pps_sim[i,j] <- sample(x=1:1000,size=1,replace=T,prob=dnbinom(1:1000, mu = exp(predPSP[i,j]), size=phi_PSP[i]) / (1 - dnbinom(0, mu = exp(predPSP[i,j]), size=phi_PSP[i])))
  }
}
```
## plot ppc overlay for  growth
```{r}

ppc_dens_overlay(poar_sites_season.panic$y_p, y_ps_sim)+
  xlab("Number of panicles")+ylab("Density")+
  ggtitle(("")) +
  theme(legend.position = "none",plot.title = element_text(size = 40,hjust = 0.5)) +
  theme_bw()->ppc_panic_season


ppc_dens_overlay(poar_sites_season.panic$y_p, y_pps_sim)+
  xlab("Number of panicles")+ylab("Density")+
  ggtitle((""))+theme(legend.position = "none")+theme_bw()->ppc_panic_season_polyn

# print figure
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Figures/PPC.pdf",useDingbats = F,height=7,width=6)
multiplot(ppc_surv_season,ppc_grow_season,
          ppc_flow_season,ppc_panic_season,
          ppc_surv_season_polyn,ppc_grow_season_polyn,
          ppc_flow_season_polyn,ppc_panic_season_polyn,cols=2)
dev.off()
```

# pull out stan coefficients for fertility

```{r}

panic_coefps <- rstan::extract(fit_allsites_panic_season, c("b0_p","bsizesex_p","bsex_p", "bsize_p","bpptgrow_p","bpptdorm_p","btempgrow_p","btempdorm_p","bpptgrowsex_p","bpptdormsex_p","btempgrowsex_p","btempdormsex_p","btempdormpptdorm_p","btempgrowpptgrow_p","btempdormpptdormsex_p","btempgrowpptgrowsex_p"))

panic_coefpsp <- rstan::extract(fit_allsites_panic_season_polyn, c("b0_p","bsex_p","bsizesex_p", "bsize_p","bpptgrow_p","bpptdorm_p","btempgrow_p","btempdorm_p","bpptgrowsex_p","bpptdormsex_p","btempgrowsex_p","btempdormsex_p","btempdormpptdorm_p","btempgrowpptgrow_p","btempdormpptdormsex_p","btempgrowpptgrowsex_p","bpptgrow2_p","bpptdorm2_p","btempgrow2_p","btempdorm2_p","bpptgrow2sex_p","bpptdorm2sex_p","btempgrow2sex_p","btempdorm2sex_p"))

```

# Plot fertility  with climate variables
## Re-format data for plotting 

```{r}
poarclim_seasonal.panic %>% 
  group_by(site,Sex) %>% 
  summarise(mean_panic = mean(panic_t1),
            mean_size = mean(tillerN_t1),
            mean_pptgrow= mean(pptgrow),
            mean_temprow= mean(tempgrow),
            mean_pptdorm= mean(pptdorm),
            mean_tempdorm= mean(tempdorm),
            pptgrow = unique(pptgrow),
            tempgrow = unique(tempgrow),
            pptdorm = unique(pptdorm),
            tempdorm = unique(tempdorm))->poar_panic_plot_season


zpoar_panic_plot_season<-scale(poar_panic_plot_season[,4:12])
zpoar_panic_plot_season<-data.frame(poar_panic_plot_season[,1:3],zpoar_panic_plot_season)


panic_mean_sizesseason <- zpoar_panic_plot_season %>% group_by(Sex) %>% summarise(size = mean(mean_size))
panic_mean_tempgrow <- zpoar_panic_plot_season %>% group_by(Sex) %>% summarise(tempgrow = mean(tempgrow))
panic_mean_tempdorm <- zpoar_panic_plot_season %>% group_by(Sex) %>% summarise(tempdorm = mean(tempdorm))
panic_mean_pptgrow <- zpoar_panic_plot_season %>% group_by(Sex) %>% summarise(pptgrow = mean(pptgrow))
panic_mean_pptdorm <- zpoar_panic_plot_season %>% group_by(Sex) %>% summarise(pptdorm = mean(pptdorm))
```


```{r}
pptgrow_seq <- seq(min(zpoar_panic_plot_season$pptgrow),max(zpoar_panic_plot_season$pptgrow),0.1)
tempgrow_seq <- seq(min(zpoar_panic_plot_season$tempgrow),max(zpoar_panic_plot_season$tempgrow),0.1)
pptdorm_seq <- seq(min(zpoar_panic_plot_season$pptdorm),max(zpoar_panic_plot_season$pptdorm),0.1)
tempdorm_seq <- seq(min(zpoar_panic_plot_season$tempdorm),max(zpoar_panic_plot_season$tempdorm),0.1)
```


## Plot for seasonnal fertility 

```{r}
par(mfrow = c(2, 4))
with(zpoar_panic_plot_season,{
    plot(pptgrow,mean_panic,
         xlab=" Precipitation growing",ylab="#panicles");box()
    for(s in 1:2){
      points(pptgrow[Sex==s],mean_panic[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(pptgrow_seq,exp(mean(panic_coefpsp$b0_p) + 
                        mean(panic_coefpsp$bsize_p) * panic_mean_sizesseason$size[panic_mean_sizesseason$Sex==s] +
                         mean(panic_coefpsp$bsizesex_p) * panic_mean_sizesseason$size[panic_mean_sizesseason$Sex==s]* (s-1)  +
                        mean(panic_coefpsp$bsex_p) * (s-1) +
                        mean(panic_coefpsp$bpptgrow_p) * pptgrow_seq +
                        mean(panic_coefpsp$bpptdorm_p) * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s]  +
                        mean(panic_coefpsp$btempgrow_p) * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] +
                        mean(panic_coefpsp$btempdorm_p) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] +
                        mean(panic_coefpsp$bpptgrowsex_p) * pptgrow_seq * (s-1) +
                        mean(panic_coefpsp$bpptdormsex_p) * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s]  * (s-1) +
                        mean(panic_coefpsp$btempgrowsex_p) * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] * (s-1) +
                        mean(panic_coefpsp$btempdormsex_p) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * (s-1) +
                        mean(panic_coefpsp$btempdormpptdorm_p) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s] * (s-1) +
                        mean(panic_coefpsp$btempgrowpptgrow_p) * pptgrow_seq * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s]  * (s-1) +
                        mean(panic_coefpsp$btempdormpptdormsex_p) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s] * (s-1) +
                        mean(panic_coefpsp$btempgrowpptgrowsex_p) * pptgrow_seq * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s]  * (s-1) 
      ),col= sex_cols[s],lwd=3)
    }
})

with(zpoar_panic_plot_season,{
    plot(tempgrow,mean_panic,
         xlab=" Temperature growing",ylab="#panicles");box()
    for(s in 1:2){
      points(tempgrow[Sex==s],mean_panic[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(tempgrow_seq,exp(mean(panic_coefpsp$b0_p) + 
                        mean(panic_coefpsp$bsize_p) * panic_mean_sizesseason$size[panic_mean_sizesseason$Sex==s] +
                        mean(panic_coefpsp$bsize_p) * panic_mean_sizesseason$size[panic_mean_sizesseason$Sex==s]* (s-1)  +
                        mean(panic_coefpsp$bsex_p) * (s-1) +
                        mean(panic_coefpsp$bpptgrow_p) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s]  +
                        mean(panic_coefpsp$bpptdorm_p) * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s]  +
                        mean(panic_coefpsp$btempgrow_p) * tempgrow_seq +
                        mean(panic_coefpsp$btempdorm_p) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] +
                        mean(panic_coefpsp$bpptgrowsex_p) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s] * (s-1) +
                        mean(panic_coefpsp$bpptdormsex_p) * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s]  * (s-1) +
                        mean(panic_coefpsp$btempgrowsex_p) * tempgrow_seq * (s-1) +
                        mean(panic_coefpsp$btempdormsex_p) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * (s-1) +
                        mean(panic_coefpsp$btempdormpptdorm_p) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s] +
                        mean(panic_coefpsp$btempgrowpptgrow_p) * tempgrow_seq * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s]  +
                        mean(panic_coefpsp$btempdormpptdormsex_p) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s] * (s-1) +
                        mean(panic_coefpsp$btempgrowpptgrowsex_p) * tempgrow_seq * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s]  * (s-1) 
      ),col= sex_cols[s],lwd=3)
    }
})

with(zpoar_panic_plot_season,{
    plot(pptdorm,mean_panic,
         xlab=" Precipitation dormant",ylab="#panicles");box()
    for(s in 1:2){
      points(pptdorm[Sex==s],mean_panic[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(pptdorm_seq,exp(mean(panic_coefpsp$b0_p) + 
                        mean(panic_coefpsp$bsize_p) * panic_mean_sizesseason$size[panic_mean_sizesseason$Sex==s] +
                        mean(panic_coefpsp$bsizesex_p) * panic_mean_sizesseason$size[panic_mean_sizesseason$Sex==s] * (s-1) +
                        mean(panic_coefpsp$bsex_p) * (s-1) +
                        mean(panic_coefpsp$bpptgrow_p) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s]  +
                        mean(panic_coefpsp$bpptdorm_p) * pptdorm_seq +
                        mean(panic_coefpsp$btempgrow_p) * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] +
                        mean(panic_coefpsp$btempdorm_p) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] +
                        mean(panic_coefpsp$bpptgrowsex_p) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s]  * (s-1) +
                        mean(panic_coefpsp$bpptdormsex_p) * pptdorm_seq  * (s-1) +
                        mean(panic_coefpsp$btempgrowsex_p) * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] * (s-1) +
                        mean(panic_coefpsp$btempdormsex_p) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * (s-1) +
                        mean(panic_coefpsp$btempdormpptdorm_p) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * pptdorm_seq  +
                        mean(panic_coefpsp$btempgrowpptgrow_p) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s]  * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s]  + 
                        mean(panic_coefpsp$btempdormpptdormsex_p) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * pptdorm_seq * (s-1) +
                        mean(panic_coefpsp$btempgrowpptgrowsex_p) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s]  * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s]  * (s-1) 
      ),col= sex_cols[s],lwd=3)
    }
})

with(zpoar_panic_plot_season,{
    plot(tempdorm,mean_panic,
         xlab=" Temperature dormant",ylab="#panicles");box()
    for(s in 1:2){
      points(tempdorm[Sex==s],mean_panic[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(tempdorm_seq,exp(mean(panic_coefpsp$b0_p) + 
                        mean(panic_coefpsp$bsize_p) * panic_mean_sizesseason$size[panic_mean_sizesseason$Sex==s] +
                        mean(panic_coefpsp$bsizesex_p) * panic_mean_sizesseason$size[panic_mean_sizesseason$Sex==s] * (s-1) +
                        mean(panic_coefpsp$bsex_p) * (s-1) +
                        mean(panic_coefpsp$bpptgrow_p) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s]  +
                        mean(panic_coefpsp$bpptdorm_p) * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s]  +
                        mean(panic_coefpsp$btempgrow_p) * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] +
                        mean(panic_coefpsp$btempdorm_p) * tempdorm_seq +
                        mean(panic_coefpsp$bpptgrowsex_p) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s] * (s-1) +
                        mean(panic_coefpsp$bpptdormsex_p) * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s]  * (s-1) +
                        mean(panic_coefpsp$btempgrowsex_p) * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] * (s-1) +
                        mean(panic_coefpsp$btempdormsex_p) * tempdorm_seq * (s-1) +
                        mean(panic_coefpsp$btempdormpptdorm_p) * tempdorm_seq * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s]  +
                        mean(panic_coefpsp$btempgrowpptgrow_p) * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s]    +
                        mean(panic_coefpsp$btempdormpptdormsex_p) * tempdorm_seq * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s] * (s-1) +
                        mean(panic_coefpsp$btempgrowpptgrowsex_p) * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s]   * (s-1) 
      ),col= sex_cols[s],lwd=3)
    }
})


with(zpoar_panic_plot_season,{
    plot(pptgrow,mean_panic,
         xlab=" Precipitation growing",ylab="#panicles");box()
    for(s in 1:2){
      points(pptgrow[Sex==s],mean_panic[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(pptgrow_seq,exp(mean(panic_coefpsp$b0_p) + 
                        mean(panic_coefpsp$bsize_p) * panic_mean_sizesseason$size[panic_mean_sizesseason$Sex==s] +
                        mean(panic_coefpsp$bsizesex_p) * panic_mean_sizesseason$size[panic_mean_sizesseason$Sex==s] * (s-1) +
                        mean(panic_coefpsp$bsex_p) * (s-1) +
                        mean(panic_coefpsp$bpptgrow_p) * pptgrow_seq +
                        mean(panic_coefpsp$bpptdorm_p) * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s]  +
                        mean(panic_coefpsp$btempgrow_p) * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] +
                        mean(panic_coefpsp$btempdorm_p) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] +
                        mean(panic_coefpsp$bpptgrowsex_p) * pptgrow_seq * (s-1) +
                        mean(panic_coefpsp$bpptdormsex_p) * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s]  * (s-1) +
                        mean(panic_coefpsp$btempgrowsex_p) * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] * (s-1) +
                        mean(panic_coefpsp$btempdormsex_p) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * (s-1) +
                        mean(panic_coefpsp$btempdormpptdorm_p) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s]  +
                        mean(panic_coefpsp$btempgrowpptgrow_p) * pptgrow_seq * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s]   +
                        mean(panic_coefpsp$btempdormpptdormsex_p) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s] * (s-1) +
                        mean(panic_coefpsp$btempgrowpptgrowsex_p) * pptgrow_seq * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s]  * (s-1) +
                        mean(panic_coefpsp$bpptgrow2_p) * (pptgrow_seq^2) +
                        mean(panic_coefpsp$bpptdorm2_p) * (panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s])^2 +
                        mean(panic_coefpsp$btempgrow2_p) * (panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s])^2 +
                        mean(panic_coefpsp$btempdorm2_p) * (panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s])^2 +
                        mean(panic_coefpsp$bpptgrow2sex_p) * (pptgrow_seq^2) * (s-1) +
                        mean(panic_coefpsp$bpptdorm2sex_p) * (panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s])^2 * (s-1) +
                        mean(panic_coefpsp$btempgrow2sex_p) * (panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s])^2 * (s-1) +
                        mean(panic_coefpsp$btempdorm2sex_p) * (panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s])^2 * (s-1) 
      ),col= sex_cols[s],lwd=3)
    }
})

with(zpoar_panic_plot_season,{
    plot(tempgrow,mean_panic,
         xlab="Temperature growing",ylab="#panicles");box()
    for(s in 1:2){
      points(tempgrow[Sex==s],mean_panic[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(tempgrow_seq,exp(mean(panic_coefpsp$b0_p) + 
                        mean(panic_coefpsp$bsize_p) * panic_mean_sizesseason$size[panic_mean_sizesseason$Sex==s] +
                        mean(panic_coefpsp$bsizesex_p) * panic_mean_sizesseason$size[panic_mean_sizesseason$Sex==s] * (s-1) +
                        mean(panic_coefpsp$bsex_p) * (s-1) +
                        mean(panic_coefpsp$bpptgrow_p) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s]  +
                        mean(panic_coefpsp$bpptdorm_p) * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s]  +
                        mean(panic_coefpsp$btempgrow_p) * tempgrow_seq +
                        mean(panic_coefpsp$btempdorm_p) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] +
                        mean(panic_coefpsp$bpptgrowsex_p) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s] * (s-1) +
                        mean(panic_coefpsp$bpptdormsex_p) * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s]  * (s-1) +
                        mean(panic_coefpsp$btempgrowsex_p) * tempgrow_seq * (s-1) +
                        mean(panic_coefpsp$btempdormsex_p) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * (s-1) +
                        mean(panic_coefpsp$btempdormpptdorm_p) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s]  +
                        mean(panic_coefpsp$btempgrowpptgrow_p) * tempgrow_seq * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s]   +
                        mean(panic_coefpsp$btempdormpptdormsex_p) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s] * (s-1) +
                        mean(panic_coefpsp$btempgrowpptgrowsex_p) * tempgrow_seq * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s]  * (s-1) +
                        mean(panic_coefpsp$bpptgrow2_p) * (panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s])^2 +
                        mean(panic_coefpsp$bpptdorm2_p) * (panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s])^2 +
                        mean(panic_coefpsp$btempgrow2_p) * (tempgrow_seq^2) +
                        mean(panic_coefpsp$btempdorm2_p) * (panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s])^2 +
                        mean(panic_coefpsp$bpptgrow2sex_p) * (panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s])^2 * (s-1) +
                        mean(panic_coefpsp$bpptdorm2sex_p) * (panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s])^2 * (s-1) +
                        mean(panic_coefpsp$btempgrow2sex_p) * (tempgrow_seq^2) * (s-1) +
                        mean(panic_coefpsp$btempdorm2sex_p) * (panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s])^2 * (s-1)
                        
      ),col= sex_cols[s],lwd=3)
    }
})

with(zpoar_panic_plot_season,{
    plot(pptdorm,mean_panic,
         xlab=" Precipitation dormant",ylab="#panicles");box()
    for(s in 1:2){
      points(pptdorm[Sex==s],mean_panic[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(pptdorm_seq,exp(mean(panic_coefpsp$b0_p) + 
                        mean(panic_coefpsp$bsize_p) * panic_mean_sizesseason$size[panic_mean_sizesseason$Sex==s] +
                        mean(panic_coefpsp$bsizesex_p) * panic_mean_sizesseason$size[panic_mean_sizesseason$Sex==s] * (s-1)  +
                        mean(panic_coefpsp$bsex_p) * (s-1) +
                        mean(panic_coefpsp$bpptgrow_p) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s]  +
                        mean(panic_coefpsp$bpptdorm_p) * pptdorm_seq +
                        mean(panic_coefpsp$btempgrow_p) * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] +
                        mean(panic_coefpsp$btempdorm_p) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] +
                        mean(panic_coefpsp$bpptgrowsex_p) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s]  * (s-1) +
                        mean(panic_coefpsp$bpptdormsex_p) * pptdorm_seq  * (s-1) +
                        mean(panic_coefpsp$btempgrowsex_p) * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] * (s-1) +
                        mean(panic_coefpsp$btempdormsex_p) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * (s-1) +
                        mean(panic_coefpsp$btempdormpptdorm_p) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * pptdorm_seq  +
                        mean(panic_coefpsp$btempgrowpptgrow_p) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s]  * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s]   +
                        mean(panic_coefpsp$btempdormpptdormsex_p) * panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s] * pptdorm_seq * (s-1) +
                        mean(panic_coefpsp$btempgrowpptgrowsex_p) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s]  * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s]  * (s-1) +
                        mean(panic_coefpsp$bpptgrow2_p) * (panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s])^2 +
                        mean(panic_coefpsp$bpptdorm2_p) * (pptdorm_seq^2) +
                        mean(panic_coefpsp$btempgrow2_p) * (panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s])^2 +
                        mean(panic_coefpsp$btempdorm2_p) * (panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s])^2 +
                        mean(panic_coefpsp$bpptgrow2sex_p) * (panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s])^2 * (s-1) +
                        mean(panic_coefpsp$bpptdorm2sex_p) * (pptdorm_seq^2) * (s-1) +
                        mean(panic_coefpsp$btempgrow2sex_p) * (panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s])^2 * (s-1) +
                        mean(panic_coefpsp$btempdorm2sex_p) *  (panic_mean_tempdorm$tempdorm[panic_mean_tempdorm$Sex==s])^2 * (s-1) 
                        
      ),col= sex_cols[s],lwd=3)
    }
})

with(zpoar_panic_plot_season,{
    plot(tempdorm,mean_panic,
         xlab=" Temperature dormant",ylab="#panicles");box()
    for(s in 1:2){
      points(tempdorm[Sex==s],mean_panic[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(tempdorm_seq,exp(mean(panic_coefpsp$b0_p) + 
                        mean(panic_coefpsp$bsize_p) * panic_mean_sizesseason$size[panic_mean_sizesseason$Sex==s] +
                        mean(panic_coefpsp$bsizesex_p) * panic_mean_sizesseason$size[panic_mean_sizesseason$Sex==s] * (s-1) +
                        mean(panic_coefpsp$bsex_p) * (s-1) +
                        mean(panic_coefpsp$bpptgrow_p) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s]  +
                        mean(panic_coefpsp$bpptdorm_p) * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s]  +
                        mean(panic_coefpsp$btempgrow_p) * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] +
                        mean(panic_coefpsp$btempdorm_p) * tempdorm_seq +
                        mean(panic_coefpsp$bpptgrowsex_p) * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s] * (s-1) +
                        mean(panic_coefpsp$bpptdormsex_p) * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s]  * (s-1) +
                        mean(panic_coefpsp$btempgrowsex_p) * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] * (s-1) +
                        mean(panic_coefpsp$btempdormsex_p) * tempdorm_seq * (s-1) +
                        mean(panic_coefpsp$btempdormpptdorm_p) * tempdorm_seq * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s]  +
                        mean(panic_coefpsp$btempgrowpptgrow_p) * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s]  +
                        mean(panic_coefpsp$btempdormpptdormsex_p) * tempdorm_seq * panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s] * (s-1) +
                        mean(panic_coefpsp$btempgrowpptgrowsex_p) * panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s] * panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s]   * (s-1) +
                        mean(panic_coefpsp$bpptgrow2_p) * (panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s])^2 +
                        mean(panic_coefpsp$bpptdorm2_p) * (panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s])^2 +
                        mean(panic_coefpsp$btempgrow2_p) * (panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s])^2 +
                        mean(panic_coefpsp$btempdorm2_p) * (tempdorm_seq^2) +
                        mean(panic_coefpsp$bpptgrow2sex_p) * (panic_mean_pptgrow$pptgrow[panic_mean_pptgrow$Sex==s])^2 * (s-1) +
                        mean(panic_coefpsp$bpptdorm2sex_p) * (panic_mean_pptdorm$pptdorm[panic_mean_pptdorm$Sex==s])^2 * (s-1) +
                        mean(panic_coefpsp$btempgrow2sex_p) * (panic_mean_tempgrow$tempgrow[panic_mean_tempgrow$Sex==s]) * (s-1) +
                        mean(panic_coefpsp$btempdorm2sex_p) * (tempdorm_seq^2) * (s-1) 
                        
      ),col= sex_cols[s],lwd=3)
    }
})

```


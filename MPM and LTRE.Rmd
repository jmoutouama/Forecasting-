---
title: "Two-sex matrix model"
author: "Jacob Moutouama,Aldo Compagnoni and Tom Miller "
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
 rmdformats::readthedown:
    code_folding: show
    self_contained: true
    number_sections: true
    thumbnails: true
    lightbox: true
    gallery: true
    keep_md: true
    highlight: tango
    df_print: kable 
    toc_depth: 3
    fig_width: 8
    fig_height: 8
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(comment=NA, 
                      echo = TRUE,
                      warning=FALSE, 
                      message=FALSE)
knitr::opts_knit$set(global.par = TRUE,knitr.table.format = "latex")
```

```{r eval=TRUE,echo=T}
rm(list = ls())
```

# Required libraries
```{r,warning=FALSE}
# load packages
library(rstan)
# set rstan options
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
set.seed(13)
# Sys.setenv(LOCAL_CPPFLAGS = '-march=corei7 -mtune=corei7')
options(tidyverse.quiet = TRUE)
library(tidyverse)
options(dplyr.summarise.inform = FALSE)
library(bayesplot)
# install.packages("countreg",repos = "http://R-Forge.R-project.org")
library(countreg)
library(rmutil)
library(actuar)
library(SPEI)
library(LaplacesDemon)
# if (!require("BiocManager", quietly = TRUE))
#     install.packages("BiocManager")
# BiocManager::install("scater")
# library(scater)
```

# Demography data 
```{r}
poar_allsites <- read.csv("https://www.dropbox.com/s/xk4225mn8btqhbm/demography_allsites.csv?dl=1", stringsAsFactors = F)#common garden data
poar_allsites$census.year<-poar_allsites$year-1 #Add census year to match with climate data
poar_allsites %>% 
  dplyr::select(everything()) %>% 
  filter(census.year %in% (2015:2016))-> poar_allsites_2015_2016 # Drop the first census to match with the seasonal model (growing and dormant season temp and precip)
```

# Current climatic data  
```{r}
poar_ppt <- read.csv("https://www.dropbox.com/s/kkga2hf9k1w9ht1/Poa_pr.csv?dl=1", stringsAsFactors = F) # monthly  precipitation 
poar_temp <- read.csv("https://www.dropbox.com/s/n0vrn8q5ma49rc9/Poa_tas.csv?dl=1", stringsAsFactors = F) # monthly temperature)
poar_ppt$census.year<-ifelse(poar_ppt$month<5,poar_ppt$year-1,poar_ppt$year) # data were collected in May. Thus, the precipitation for the census year is both the precipitation from May to December of the previous year and precipitation of the current year.  
poar_temp$census.year<-ifelse(poar_temp$month<5,poar_temp$year-1,poar_temp$year)
```

## Climatic data for the model with seasonal data  (growing and dormant season temp and precip) 

```{r}
poar_temp %>% 
  dplyr::select(site,Longitude, Latitude,census.year,temp,month) %>% 
  dplyr::filter(census.year %in% (2015:2016)) %>%
  dplyr::mutate(Season=ifelse((month >= 6) & (month <= 9), "dormant", "growing")) %>% 
  group_by(site,census.year,Season) %>%
	dplyr::summarise(site=unique(site),Longitude=unique(Longitude),Latitude=unique(Latitude),temp_season = mean(temp))->poar_tempseason 

poar_ppt %>% 
  dplyr::select(site,Longitude, Latitude,census.year,ppt,month) %>% 
  dplyr::filter(census.year %in% (2015:2016)) %>%
  dplyr::mutate(Season=ifelse((month >= 6) & (month <= 9), "dormant", "growing")) %>% 
  group_by(site,census.year,Season) %>%
	dplyr::summarise(site=unique(site),Longitude=unique(Longitude),Latitude=unique(Latitude),ppt_season = sum(ppt))->poar_pptseason 

poar_climseason<- merge(x = poar_tempseason, y = poar_pptseason) # merge temperature and precipitation data
###

```

## Match seasonnal data with demographic data

```{r}
poar_allsites.clim_season <- left_join(x = poar_allsites_2015_2016 ,y =poar_climseason,by=c("site","census.year","Longitude","Latitude")) # merge the demographic data with climatic data for each site
poar_allsites.clim_season %>% 
  filter(Season=="growing") %>% 
  mutate(tempgrow=temp_season,pptgrow=ppt_season)->poar_allsites.clim_season_grow

# head(poar_allsites.clim_season_grow)
# head(poar_allsites.clim_season_dorm)
poar_allsites.clim_season %>% 
  filter(Season=="dormant") %>% 
  mutate(tempdorm=temp_season,pptdorm=ppt_season)->poar_allsites.clim_season_dorm


poar.clim_seasonal<- cbind(poar_allsites.clim_season_grow,tempdorm=poar_allsites.clim_season_dorm$tempdorm,pptdorm=poar_allsites.clim_season_dorm$pptdorm)

# poar.clim_seasonal$Longitude<-poar.clim_seasonal$Longitude.x
# poar.clim_seasonal$Latitude <-poar.clim_seasonal$Latitude.y
# poar.clim_seasonal %>% 
#   mutate( pptgrow   = pptgrow %>% scale %>% .[,1],
#           tempgrow = tempgrow %>% scale %>% .[,1],
#           pptdorm = pptdorm %>% scale %>% .[,1],
#           tempdorm= tempdorm %>% scale %>% .[,1])->zpoar.clim_seasonal

```

## Posterior for each vital rate
```{r}
#load stan output -- this will also take a while, but not as long as running the model from scratch
fit_survival <- readRDS(url("https://www.dropbox.com/s/ixv0rn7k6yi3bzm/poar_survival_season.rds?dl=1"))
fit_growth<-readRDS(url("https://www.dropbox.com/s/3h9x43ku3f58up9/poar_growth_season.rds?dl=1"))
fit_flow<-readRDS(url("https://www.dropbox.com/s/esq822z7cbie4os/poar_flow_season.rds?dl=1"))
fit_panicle<-readRDS(url("https://www.dropbox.com/scl/fi/f9stvvdpk9xh8xqv4ipas/poar_panicle_season.rds?rlkey=x5on1k5ildr3t2d0j7bt15e35&dl=1"))
fit_viability<-readRDS(url("https://www.dropbox.com/scl/fi/ig1c0vf2sxq2qmsncs9sm/poar_viability.rds?rlkey=73cvtqef95kmyq1637s1f2s0d&dl=1"))
```

## load MPM functions

```{r}
# source("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/twosexMPM.R")
source("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/twosexMPMLTRE.R")
# source("C:/Users/tm9/Dropbox/github/POAR-Forecasting/twosexMPMLTRE.R")

```
## read in the seedling survival data from Poa autumnalis

```{r}
POAU <- read.csv("https://www.dropbox.com/s/7f2yfz49fzrcp5i/POAU.csv?dl=1")
sdlg_surv <- POAU %>% filter(year_recruit==year_t,year_t %in% 2014:2016) %>% summarise(sdlg_surv = mean(spring_survival_t1,na.rm=T))
```

##  pull out mean stan coefficients
```{r}
mean_coefs<- lapply(rstan::extract(fit_survival, pars = c("b0_s","bsizesex_s","btempdormpptdorm_s","btempgrowpptgrow_s","bsex_s", "bsize_s","bpptgrow_s","bpptdorm_s","btempgrow_s","btempdorm_s","bpptgrowsex_s","bpptdormsex_s","btempgrowsex_s","btempdormsex_s","btempdormpptdormsex_s","btempgrowpptgrowsex_s")) ,mean)

mean_coefg<- lapply(rstan::extract(fit_growth, pars = c("b0_g","btempdormpptdorm_g","btempgrowpptgrow_g","bsizesex_g","bsex_g", "bsize_g","bpptgrow_g","bpptdorm_g","btempgrow_g","btempdorm_g","bpptgrowsex_g","bpptdormsex_g","btempgrowsex_g","btempdormsex_g","btempdormpptdormsex_g","btempgrowpptgrowsex_g","sigma")) ,mean)

mean_coeff<- lapply(rstan::extract(fit_flow, pars = c("b0_f","bsizesex_f","bsex_f", "bsize_f","bpptgrow_f","bpptdorm_f","btempgrow_f","btempdorm_f","bpptgrowsex_f","bpptdormsex_f","btempgrowsex_f","btempdormsex_f","btempdormpptdorm_f","btempgrowpptgrow_f","btempdormpptdormsex_f","btempgrowpptgrowsex_f")) ,mean)

mean_coefp<- lapply(rstan::extract(fit_panicle, pars = c("b0_p","bsex_p","bsex_p","bsizesex_p", "bsize_p","bpptgrow_p","bpptdorm_p","btempgrow_p","btempdorm_p","bpptgrowsex_p","bpptdormsex_p","btempgrowsex_p","btempdormsex_p","btempdormpptdorm_p","btempgrowpptgrow_p","btempdormpptdormsex_p","btempgrowpptgrowsex_p")) ,mean)

mean_coefv<-lapply(rstan::extract(fit_viability, pars = c("v0","a_v","m","lambda_d")) ,mean)

```

# set up female and male parameter vectors to run the Matrix 
```{r}
F_params <- M_params <- c()
## survival
F_params$surv_mu <- mean_coefs$b0_s
F_params$surv_size <- mean_coefs$bsize_s
F_params$surv_pptgrow <- mean_coefs$bpptgrow_s 
F_params$surv_pptdorm <- mean_coefs$bpptdorm_s 
F_params$surv_tempgrow <- mean_coefs$btempgrow_s 
F_params$surv_tempdorm <- mean_coefs$btempdorm_s  
F_params$surv_tempdorm_pptdorm<-mean_coefs$btempdormpptdorm_s
F_params$surv_tempgrow_pptgrow<-mean_coefs$btempgrowpptgrow_s
M_params$surv_mu <- mean_coefs$b0_s + mean_coefs$bsex_s  
M_params$surv_size <- mean_coefs$bsize_s + mean_coefs$bsizesex_s
M_params$surv_pptgrow <- mean_coefs$bpptgrow_s  + mean_coefs$bpptgrowsex_s 
M_params$surv_pptdorm <- mean_coefs$bpptdorm_s  + mean_coefs$bpptdormsex_s 
M_params$surv_tempgrow <- mean_coefs$btempgrow_s + mean_coefs$btempgrowsex_s #
M_params$surv_tempdorm <-  mean_coefs$btempdorm_s  + mean_coefs$btempdormsex_s  
M_params$surv_tempdorm_pptdorm<-mean_coefs$btempdormpptdorm_s + mean_coefs$btempdormpptdormsex_s
M_params$surv_tempgrow_pptgrow<-mean_coefs$btempgrowpptgrow_s + mean_coefs$btempgrowpptgrowsex_s

## growth
F_params$grow_mu <- mean_coefg$b0_g
F_params$grow_size <- mean_coefg$bsize_g
F_params$grow_pptgrow <- mean_coefg$bpptgrow_g 
F_params$grow_pptdorm <- mean_coefg$bpptdorm_g 
F_params$grow_tempgrow <- mean_coefg$btempgrow_g 
F_params$grow_tempdorm <- mean_coefg$btempdorm_g  
F_params$grow_tempdorm_pptdorm<-mean_coefg$btempdormpptdorm_g
F_params$grow_tempgrow_pptgrow<-mean_coefg$btempgrowpptgrow_g
F_params$sigma_g <- mean_coefg$sigma 
M_params$grow_mu <- mean_coefg$b0_g + mean_coefg$bsex_g  
M_params$grow_size <- mean_coefg$bsize_g + mean_coefg$bsizesex_g
M_params$grow_pptgrow <- mean_coefg$bpptgrow_g  + mean_coefg$bpptgrowsex_g 
M_params$grow_pptdorm <- mean_coefg$bpptdorm_g  + mean_coefg$bpptdormsex_g 
M_params$grow_tempgrow <- mean_coefg$btempgrow_g + mean_coefg$btempgrowsex_g #
M_params$grow_tempdorm <-  mean_coefg$btempdorm_g  + mean_coefg$btempdormsex_g  
M_params$grow_tempdorm_pptdorm<-mean_coefg$btempdormpptdorm_g + mean_coefg$btempdormpptdormsex_g
M_params$grow_tempgrow_pptgrow<-mean_coefg$btempgrowpptgrow_g + mean_coefg$btempgrowpptgrowsex_g
M_params$sigma_g <- mean_coefg$sigma 
## flowering
F_params$flow_mu <- mean_coeff$b0_f
F_params$flow_size <- mean_coeff$bsize_f
F_params$flow_pptgrow <- mean_coeff$bpptgrow_f 
F_params$flow_pptdorm <- mean_coeff$bpptdorm_f 
F_params$flow_tempgrow <- mean_coeff$btempgrow_f 
F_params$flow_tempdorm <- mean_coeff$btempdorm_f  
F_params$flow_tempdorm_pptdorm<-mean_coeff$btempdormpptdorm_f
F_params$flow_tempgrow_pptgrow<-mean_coeff$btempgrowpptgrow_f
M_params$flow_mu <- mean_coeff$b0_f + mean_coeff$bsex_f  
M_params$flow_size <- mean_coeff$bsize_f + mean_coeff$bsizesex_f
M_params$flow_pptgrow <- mean_coeff$bpptgrow_f  + mean_coeff$bpptgrowsex_f 
M_params$flow_pptdorm <- mean_coeff$bpptdorm_f  + mean_coeff$bpptdormsex_f 
M_params$flow_tempgrow <- mean_coeff$btempgrow_f + mean_coeff$btempgrowsex_f #
M_params$flow_tempdorm <-  mean_coeff$btempdorm_f  + mean_coeff$btempdormsex_f  
M_params$flow_tempdorm_pptdorm<-mean_coeff$btempdormpptdorm_f + mean_coeff$btempdormpptdormsex_f
M_params$flow_tempgrow_pptgrow<-mean_coeff$btempgrowpptgrow_f + mean_coeff$btempgrowpptgrowsex_f
## panicles
F_params$panic_mu <- mean_coefp$b0_p
F_params$panic_size <- mean_coefp$bsize_p
F_params$panic_pptgrow <- mean_coefp$bpptgrow_p 
F_params$panic_pptdorm <- mean_coefp$bpptdorm_p 
F_params$panic_tempgrow <- mean_coefp$btempgrow_p 
F_params$panic_tempdorm <- mean_coefp$btempdorm_p  
F_params$panic_tempdorm_pptdorm<-mean_coefp$btempdormpptdorm_p
F_params$panic_tempgrow_pptgrow<-mean_coefp$btempgrowpptgrow_p
M_params$panic_mu <- mean_coefp$b0_p + mean_coefp$bsex_p  
M_params$panic_size <- mean_coefp$bsize_p + mean_coefp$bsizesex_p
M_params$panic_pptgrow <- mean_coefp$bpptgrow_p  + mean_coefp$bpptgrowsex_p 
M_params$panic_pptdorm <- mean_coefp$bpptdorm_p  + mean_coefp$bpptdormsex_p 
M_params$panic_tempgrow <- mean_coefp$btempgrow_p + mean_coefp$btempgrowsex_p #
M_params$panic_tempdorm <-  mean_coefp$btempdorm_p  + mean_coefp$btempdormsex_p  
M_params$panic_tempdorm_pptdorm<-mean_coefp$btempdormpptdorm_p + mean_coefp$btempdormpptdormsex_p
M_params$panic_tempgrow_pptgrow<-mean_coefp$btempgrowpptgrow_p + mean_coefp$btempgrowpptgrowsex_p
## seed viability and misc fertility params
F_params$v0 <- mean_coefv$v0 
F_params$a_v <- mean_coefv$a_v 
F_params$ov_per_inf <- mean_coefv$lambda_d 
F_params$germ <- mean_coefv$m 
F_params$PSR <- 0.5
## use POAU seedling survival for females and males
F_params$sdlg_surv <- M_params$sdlg_surv <- sdlg_surv$sdlg_surv
## set max size equal between the sexes
F_params$max_size <- M_params$max_size <- round(quantile(na.omit((poar.clim_seasonal$tillerN_t1)),probs=0.99))

```

```{r,eval=FALSE,results='hide'}
# Survival
poar.clim_seasonal %>% 
  subset( tillerN_t0 > 0 )%>%
  dplyr::select( census.year, Code, site, Block, Sex, 
          Longitude, Latitude, 
          tillerN_t0, surv_t1,pptgrow,pptdorm,tempgrow,tempdorm,site)%>% 
  na.omit %>% 
  mutate( site         = site %>% as.factor %>% as.numeric,
          Block = Block %>% as.factor %>% as.numeric,
          Sex          = Sex %>% as.factor %>% as.numeric,
          source = Code %>% as.factor %>% as.numeric ) %>%
  mutate( mean_size_surv   = mean(na.omit(tillerN_t0)),
          sd_size_surv = sd(na.omit(tillerN_t0)),
          mean_pptgrow_surv = mean(na.omit(pptgrow)),
          sd_pptgrow_surv = sd (na.omit(pptgrow)),
          mean_pptdorm_surv = mean(na.omit(pptdorm)),
          sd_pptdorm_surv = sd (na.omit(pptdorm)),
          mean_tempgrow_surv = mean(na.omit(tempgrow)),
          sd_tempgrow_surv = sd (na.omit(tempgrow)),
          mean_tempdorm_surv = mean(na.omit(tempdorm)),
          sd_tempdorm_surv = sd (na.omit(tempdorm)))->poarclim_seasonal.sur_mean_sd

# Growth
poar.clim_seasonal %>% 
  subset( tillerN_t0 > 0 & tillerN_t1 > 0)%>%
  dplyr::select( census.year, Code, site, Block, Sex, 
          Longitude, Latitude, 
          tillerN_t0, tillerN_t1,surv_t1,pptgrow,pptdorm,tempgrow,tempdorm,site)%>% 
  na.omit %>% 
  mutate( site         = site %>% as.factor %>% as.numeric,
          Block = Block %>% as.factor %>% as.numeric,
          Sex          = Sex %>% as.factor %>% as.numeric,
          source = Code %>% as.factor %>% as.numeric ) %>%
  mutate( mean_size_grow   = mean(na.omit(tillerN_t0)),
          sd_size_grow = sd(na.omit(tillerN_t0)),
          mean_pptgrow_grow = mean(na.omit(pptgrow)),
          sd_pptgrow_grow = sd (na.omit(pptgrow)),
          mean_pptdorm_grow = mean(na.omit(pptdorm)),
          sd_pptdorm_grow = sd (na.omit(pptdorm)),
          mean_tempgrow_grow = mean(na.omit(tempgrow)),
          sd_tempgrow_grow = sd (na.omit(tempgrow)),
          mean_tempdorm_grow = mean(na.omit(tempdorm)),
          sd_tempdorm_grow = sd (na.omit(tempdorm)))->poarclim_seasonal.grow_mean_sd

# Flowering

poar.clim_seasonal %>% 
  subset( tillerN_t1 > 0 )%>%
  dplyr::select( census.year, Code, site, Block, Sex, 
          Longitude, Latitude, 
          tillerN_t1, flowerN_t1,flow_t1,pptgrow,pptdorm,tempgrow,tempdorm,site)%>% 
  na.omit %>% 
  mutate( site         = site %>% as.factor %>% as.numeric,
          Block = Block %>% as.factor %>% as.numeric,
          Sex          = Sex %>% as.factor %>% as.numeric,
          source = Code %>% as.factor %>% as.numeric ) %>%
   mutate( mean_size_flow   = mean(na.omit(tillerN_t1)),
          sd_size_flow = sd(na.omit(tillerN_t1)),
          mean_pptgrow_flow = mean(na.omit(pptgrow)),
          sd_pptgrow_flow = sd (na.omit(pptgrow)),
          mean_pptdorm_flow = mean(na.omit(pptdorm)),
          sd_pptdorm_flow = sd (na.omit(pptdorm)),
          mean_tempgrow_flow = mean(na.omit(tempgrow)),
          sd_tempgrow_flow = sd (na.omit(tempgrow)),
          mean_tempdorm_flow = mean(na.omit(tempdorm)),
          sd_tempdorm_flow = sd (na.omit(tempdorm)))->poarclim_seasonal.flow_mean_sd

# Panicles

poar.clim_seasonal %>% 
  subset( flowerN_t1 > 0 & tillerN_t1 > 0 )%>%
  dplyr::select( census.year, Code, site, Block, Sex, 
          Longitude, Latitude, 
          tillerN_t1, flowerN_t1,pptgrow,pptdorm,tempgrow,tempdorm,site)%>% 
  na.omit %>% 
  mutate( site         = site %>% as.factor %>% as.numeric,
          Block = Block %>% as.factor %>% as.numeric,
          Sex          = Sex %>% as.factor %>% as.numeric,
          source = Code %>% as.factor %>% as.numeric,
          panic_t1 = flowerN_t1) %>%
  mutate( mean_size_panic   = mean(na.omit(tillerN_t1)),
          sd_size_panic = sd(na.omit(tillerN_t1)),
          mean_pptgrow_panic = mean(na.omit(pptgrow)),
          sd_pptgrow_panic = sd (na.omit(pptgrow)),
          mean_pptdorm_panic = mean(na.omit(pptdorm)),
          sd_pptdorm_panic = sd (na.omit(pptdorm)),
          mean_tempgrow_panic = mean(na.omit(tempgrow)),
          sd_tempgrow_panic = sd (na.omit(tempgrow)),
          mean_tempdorm_panic = mean(na.omit(tempdorm)),
          sd_tempdorm_panic = sd (na.omit(tempdorm)))->poarclim_seasonal.panic_mean_sd
```

# Relation lambda and each climatic variable (growing season)

```{r}
## extend the climatic  to bounds and beyond of observed distribution
## note that length of this vector has a big effect on how fast/slow the following code runs

pptgrow_seq_extend <- seq(min(poar.clim_seasonal$pptgrow),max(poar.clim_seasonal$pptgrow),length.out=10)
tempgrow_seq_extend <- seq(min(poar.clim_seasonal$tempgrow),max(poar.clim_seasonal$tempgrow),length.out=10)
pptdorm_seq_extend <- seq(min(poar.clim_seasonal$pptdorm),max(poar.clim_seasonal$pptdorm),length.out=10)
tempdorm_seq_extend <- seq(min(poar.clim_seasonal$tempdorm),max(poar.clim_seasonal$tempdorm),length.out=10)


climat_grow<-data.frame(pptgrow_seq_extend=pptgrow_seq_extend,tempgrow_seq_extend=rep(mean(poar.clim_seasonal$tempgrow),length(pptgrow_seq_extend)),pptdorm_mean=rep(mean(poar.clim_seasonal$pptdorm),length(pptgrow_seq_extend)),tempdorm_mean=rep(mean(poar.clim_seasonal$tempdorm),length(pptgrow_seq_extend)))

# library(usethis) 
# usethis::edit_r_environ()

lambda_grow_mean<-lambda_grow_mean_2sex<-SR_grow_mean<-OSR_grow_mean<-c()
ssd<-matrix(NA,(F_params$max_size+1)*2,nrow(climat_grow))
max_yrs <- 10


for (i in 1:nrow(climat_grow)) {
    #linear model for comparison
  mat <- megamatrix_delay( F_params=F_params,
                           M_params=M_params,
                           twosex=F,
                           grow_perturb=0,
                           surv_perturb=0,
                           flow_perturb=0,
                           fert_perturb=0,
                           viab_perturb=0,
                           pptgrow=climat_grow[i,1],
                           tempgrow=climat_grow[i,2],
                           pptdorm=climat_grow[i,3],
                           tempdorm=climat_grow[i,4],
                           rfx=rfx_fun())$MEGAmat
  lambda_grow_mean[i] <- popbio::lambda(mat)
  # 2-sex model
  lambda_run <- lambdaSim_delay( F_params=F_params,
                                 M_params=M_params,
                                 grow_perturb=0,
                                 surv_perturb=0,
                                 flow_perturb=0,
                                 fert_perturb=0,
                                 viab_perturb=0,
                                 pptgrow=climat_grow[i,1],
                                 tempgrow=climat_grow[i,2],
                                 pptdorm=climat_grow[i,3],
                                 tempdorm=climat_grow[i,4],
                                 rfx = rfx_fun(),
                                 max.yrs = max_yrs)
  lambda_grow_mean_2sex[i] <- lambda_run$lambdatracker[max_yrs]
  SR_grow_mean[i] <- lambda_run$SRtracker[max_yrs]
  OSR_grow_mean[i] <- lambda_run$OSRtracker[max_yrs]
  ssd[,i] <- lambda_run$n0
}


```


```{r}
cbPalette <- RColorBrewer::brewer.pal(8, "Dark2")[c(2,1)]
par(mar=c(5,5,1,1))
plot(climat_grow$pptgrow_seq_extend,lambda_grow_mean,type="l",lwd=2,col=cbPalette[1],
     xlab="Precipitation growing season",ylab=expression(paste(lambda)),cex.lab=1.5,ylim=c(0,2.7))
lines(climat_grow$pptgrow_seq_extend,lambda_grow_mean_2sex,type="l",lwd=2,col=cbPalette[2])
legend("topright",legend=c("Two-sex","Female-dominant"),lwd=2,col =cbPalette ,bty="n",cex=1.2)
```




# Projection on the geographic space
# Getting the value of each predictors per site/geographic coordinate
```{r}
poar.clim_seasonal %>% 
  subset( tillerN_t0 > 0 & tillerN_t1 > 0)%>%
  mutate( site         = site %>% as.factor %>% as.numeric,
          Block = Block %>% as.factor %>% as.numeric,
          Sex          = Sex %>% as.factor %>% as.numeric,
          source = Code %>% as.factor %>% as.numeric ) %>%
  group_by(site) %>% 
  summarise( Longitude=unique(Longitude),
             Latitude=unique(Latitude),
            size = mean(tillerN_t1),
            pptgrow= mean(pptgrow),
            temprow= mean(tempgrow),
            pptdorm= mean(pptdorm),
            tempdorm= mean(tempdorm))->poarclim_seasonal.mean

climmean<- data.frame(mean_size=rep(mean(poarclim_seasonal.mean$size),nrow(poarclim_seasonal.mean)),mean_pptgrow=rep(mean(poarclim_seasonal.mean$pptgrow),nrow(poarclim_seasonal.mean)),mean_temprow=rep(mean(poarclim_seasonal.mean$temprow),nrow(poarclim_seasonal.mean)),mean_pptdorm=rep(mean(poarclim_seasonal.mean$pptdorm),nrow(poarclim_seasonal.mean)),mean_tempdorm=rep(mean(poarclim_seasonal.mean$tempdorm),nrow(poarclim_seasonal.mean)))

poarclim_seasonal.meanplot<-data.frame(poarclim_seasonal.mean,climmean)


# poarclim_seasonal.mean<-as.data.frame(poarclim_seasonal.mean)
```

```{r,eval=FALSE}
## evaluate lambda at mean climate
## female-dominant:
max_yrs<-10
Fdom_meanclim_mat <- megamatrix_delay(F_params=F_params,
                           M_params=M_params,
                           twosex=F,
                           grow_perturb=0,
                           surv_perturb=0,
                           flow_perturb=0,
                           fert_perturb=0,
                           viab_perturb=0,
                           pptgrow=mean(poarclim_seasonal.mean$pptgrow),
                           tempgrow=mean(poarclim_seasonal.mean$temprow),
                           pptdorm=mean(poarclim_seasonal.mean$pptdorm),
                           tempdorm=mean(poarclim_seasonal.mean$tempdorm),
                           rfx=rfx_fun())
popbio::lambda(Fdom_meanclim_mat$MEGAmat) ## this is unrealistically high

# sum(diag(Fdom_meanclim_mat))



twosex_meanclim_mat <- lambdaSim_delay( F_params=F_params,
                           M_params=M_params,
                           grow_perturb=0,
                           surv_perturb=0,
                           flow_perturb=0,
                           fert_perturb=0,
                           viab_perturb=0,
                           pptgrow=mean(poarclim_seasonal.mean$pptgrow),
                           tempgrow=mean(poarclim_seasonal.mean$temprow),
                           pptdorm=mean(poarclim_seasonal.mean$pptdorm),
                           tempdorm=mean(poarclim_seasonal.mean$tempdorm),
                           max.yrs = max_yrs,
                           rfx = rfx_fun())
                  
twosex_meanclim_mat$lambdatracker[max_yrs] # I am not sure about the lambdatracker values. Some at insanely high 
twosex_meanclim_mat$SRtracker[max_yrs]
twosex_meanclim_mat$n0[max_yrs]

```
# Value of lambda for each site 
## Precipitation of tmeperature growing season  
```{r}
lambda_grow_mean<-lambda_grow_mean_2sex<-SR_grow_mean<-OSR_grow_mean<-c()
ssd<-matrix(NA,(F_params$max_size+1)*2,nrow(poarclim_seasonal.meanplot))
max_yrs <- 10

for (i in 1:nrow(poarclim_seasonal.meanplot)){
    #linear model for comparison
  mat <- megamatrix_delay( F_params=F_params,
                           M_params=M_params,
                           twosex=F,
                           grow_perturb=0,
                           surv_perturb=0,
                           flow_perturb=0,
                           fert_perturb=0,
                           viab_perturb=0,
                           pptgrow=poarclim_seasonal.meanplot[i,5],
                           tempgrow=poarclim_seasonal.meanplot[i,6],
                           pptdorm=poarclim_seasonal.meanplot[i,12],
                           tempdorm=poarclim_seasonal.meanplot[i,13],
                           rfx=rfx_fun())$MEGAmat
  lambda_grow_mean[i] <- popbio::lambda(mat)
  # 2-sex model
  lambda_run <- lambdaSim_delay( F_params=F_params,
                                 M_params=M_params,
                                 grow_perturb=0,
                                 surv_perturb=0,
                                 flow_perturb=0,
                                 fert_perturb=0,
                                 viab_perturb=0,
                                pptgrow=poarclim_seasonal.meanplot[i,5],
                                tempgrow=poarclim_seasonal.meanplot[i,6],
                                pptdorm=poarclim_seasonal.meanplot[i,12],
                                tempdorm=poarclim_seasonal.meanplot[i,13],
                                 rfx = rfx_fun(),
                                 max.yrs = max_yrs)
  lambda_grow_mean_2sex[i] <- lambda_run$lambdatracker[max_yrs]
  SR_grow_mean[i] <- lambda_run$SRtracker[max_yrs]
  OSR_grow_mean[i] <- lambda_run$OSRtracker[max_yrs]
  ssdppt[,i] <- lambda_run$n0
}


```
## Project on geographic space

```{r}
data_geo<-data.frame(long=poarclim_seasonal.meanplot$Longitude,lat=poarclim_seasonal.meanplot$Latitude,lambda=lambda_grow_mean)

```


## Projection on the niche space


```{r}
## extend the climatic  to bounds and beyond of observed distribution
## note that length of this vector has a big effect on how fast/slow the following code runs

pptgrow_seq_extend <- seq(min(poar.clim_seasonal$pptgrow),max(poar.clim_seasonal$pptgrow),length.out=10)
tempgrow_seq_extend <- seq(min(poar.clim_seasonal$tempgrow),max(poar.clim_seasonal$tempgrow),length.out=10)
pptdorm_seq_extend <- seq(min(poar.clim_seasonal$pptdorm),max(poar.clim_seasonal$pptdorm),length.out=10)
tempdorm_seq_extend <- seq(min(poar.clim_seasonal$tempdorm),max(poar.clim_seasonal$tempdorm),length.out=10)

# dormmean<- data.frame(pptdorm_mean=rep(mean(poar.clim_seasonal$pptdorm),length(pptgrow_seq_extend)),tempdorm_mean=rep(mean(poar.clim_seasonal$tempdorm),length(pptgrow_seq_extend)))

climat_grow<-expand.grid(pptgrow_seq_extend=pptgrow_seq_extend,tempgrow_seq_extend=tempgrow_seq_extend)
pptdorm_mean<-rep(mean(poar.clim_seasonal$pptdorm),nrow(climat_grow))
tempdorm_mean<-rep(mean(poar.clim_seasonal$tempdorm),nrow(climat_grow))
climat_grow<-data.frame(climat_grow,pptdorm_mean,tempdorm_mean)

# climat_grow<-data.frame(pptgrow_seq_extend=pptgrow_seq_extend,tempgrow_seq_extend=tempgrow_seq_extend,pptdorm_mean=rep(mean(poar.clim_seasonal$pptdorm),length(pptgrow_seq_extend)),tempdorm_mean=rep(mean(poar.clim_seasonal$tempdorm),length(pptgrow_seq_extend)))

# library(usethis) 
# usethis::edit_r_environ()

lambda_grow_mean<-lambda_grow_mean_2sex<-SR_grow_mean<-OSR_grow_mean<-c()
ssd<-matrix(NA,(F_params$max_size+1)*2,nrow(climat_grow))
max_yrs <- 10


for (i in 1:nrow(climat_grow)) {
    #linear model for comparison
  mat <- megamatrix_delay( F_params=F_params,
                           M_params=M_params,
                           twosex=F,
                           grow_perturb=0,
                           surv_perturb=0,
                           flow_perturb=0,
                           fert_perturb=0,
                           viab_perturb=0,
                           pptgrow=climat_grow[i,1],
                           tempgrow=climat_grow[i,2],
                           pptdorm=climat_grow[i,3],
                           tempdorm=climat_grow[i,4],
                           rfx=rfx_fun())$MEGAmat
  lambda_grow_mean[i] <- popbio::lambda(mat)
  # 2-sex model
  lambda_run <- lambdaSim_delay( F_params=F_params,
                                 M_params=M_params,
                                 grow_perturb=0,
                                 surv_perturb=0,
                                 flow_perturb=0,
                                 fert_perturb=0,
                                 viab_perturb=0,
                                 pptgrow=climat_grow[i,1],
                                 tempgrow=climat_grow[i,2],
                                 pptdorm=climat_grow[i,3],
                                 tempdorm=climat_grow[i,4],
                                 rfx = rfx_fun(),
                                 max.yrs = max_yrs)
  lambda_grow_mean_2sex[i] <- lambda_run$lambdatracker[max_yrs]
  SR_grow_mean[i] <- lambda_run$SRtracker[max_yrs]
  OSR_grow_mean[i] <- lambda_run$OSRtracker[max_yrs]
  ssd[,i] <- lambda_run$n0
}




```


```{r}
library(RColorBrewer)
library(lattice)
cls <- colorRampPalette(rev(brewer.pal(11, 'RdYlBu')))(100)
mtrx_grow <- matrix(lambda_grow_mean, nrow = 10, dimnames = list(pptgrow_seq_extend, 
               tempgrow_seq_extend))
# persp(mtrx_grow,xlab="Precipitation",ylab="Temperature",zlab=expression(paste(lambda)),
#                      theta = 30, phi = 30,col=cls)

# trellis.par.set("axis.line",list(col=NA,lty=1,lwd=1))
wireframe(lambda_grow_mean ~ climat_grow$pptgrow_seq_extend + climat_grow$tempgrow_seq_extend,
          # subset = lambda_grow_mean < 5, 
          zlab = list(expression(paste(lambda)), rot=90),
    drape = TRUE, col.regions = cls, scales = list(arrows = FALSE), 
    par.settings = list(axis.line = list(col = 'transparent')),
    main='', xlab='Precipitation', ylab='Temperature', screen=list(z = 120, x = -70, y = 3))

filled.contour(x=tempgrow_seq_extend,y=pptgrow_seq_extend,z=mtrx_grow)
# fields::image.plot(mtrx_grow)
filled.contour(mtrx_grow, plot.axes = {
  axis(1)
  axis(2)
  contour(mtrx_grow, add = TRUE, lwd = 1)
  }
)

grow_climate_plot<-data.frame(pptgrow=climat_grow$pptgrow_seq_extend,tempgrow=climat_grow$tempgrow_seq_extend,lambda=lambda_grow_mean)

gg = ggplot(grow_climate_plot, aes(x = pptgrow, y = tempgrow)) + 
  geom_raster(aes(fill = lambda)) + 
  geom_contour(aes(z = lambda), colour = "white", size = 0.2, alpha = 0.5) + 
  metR::geom_text_contour(aes(z = lambda),  colour = "white" ) +
  labs(x = "Temperature", 
      y = "Precipitation", 
      fill = "Lambda") + 
  theme(legend.title = element_text(size = 10, face = "bold"), 
  legend.position = "right", panel.background = element_blank(), 
  axis.text = element_text(colour = "black", size = 10), 
  axis.title = element_text(size = 12), 
  legend.text = element_text(size = 11), legend.key = element_blank()) + 
  scale_fill_continuous(low = "#BFE1B0", high = "#137177") + 
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) 


gg
```


```{r}

pptgrow_seq_extend <- seq(min(poar.clim_seasonal$pptgrow),max(poar.clim_seasonal$pptgrow),length.out=10)
tempgrow_seq_extend <- seq(min(poar.clim_seasonal$tempgrow),max(poar.clim_seasonal$tempgrow),length.out=10)
pptdorm_seq_extend <- seq(min(poar.clim_seasonal$pptdorm),max(poar.clim_seasonal$pptdorm),length.out=10)
tempdorm_seq_extend <- seq(min(poar.clim_seasonal$tempdorm),max(poar.clim_seasonal$tempdorm),length.out=10)

# growmean<- data.frame(pptgrow_mean=rep(mean(poar.clim_seasonal$pptgrow),length(pptgrow_seq_extend)),tempgrow_mean=rep(mean(poar.clim_seasonal$tempgrow),length(pptgrow_seq_extend)))

climat_dorm<-expand.grid(pptdorm_seq_extend=pptdorm_seq_extend,tempdorm_seq_extend=tempdorm_seq_extend)
climat_dorm<-data.frame(climat_dorm,pptgrow_mean=rep(mean(poar.clim_seasonal$pptgrow),nrow(climat_dorm)),tempgrow_mean=rep(mean(poar.clim_seasonal$tempgrow),nrow(climat_dorm)))

lambda_dorm_mean<-lambda_dorm_mean_2sex<-SR_dorm_mean<-OSR_dorm_mean<-c()
ssd<-matrix(NA,(F_params$max_size+1)*2,nrow(climat_dorm))
max_yrs <- 20

for (i in 1:nrow(climat_dorm)) {
    #linear model for comparison
  mat <- megamatrix_delay( F_params=F_params,
                           M_params=M_params,
                           twosex=F,
                           grow_perturb=0,
                           surv_perturb=0,
                           flow_perturb=0,
                           fert_perturb=0,
                           viab_perturb=0,
                           pptdorm=climat_dorm[i,1],
                           tempdorm=climat_dorm[i,2],
                           pptgrow=climat_dorm[i,3],
                           tempgrow=climat_dorm[i,4],
                           rfx=rfx_fun())$MEGAmat
  lambda_dorm_mean[i] <- popbio::lambda(mat)
  #2-sex model
  lambda_run <- lambdaSim_delay( F_params=F_params,
                                 M_params=M_params,
                                 grow_perturb=0,
                                 surv_perturb=0,
                                 flow_perturb=0,
                                 fert_perturb=0,
                                 viab_perturb=0,
                                 pptdorm=climat_dorm[i,1],
                                 tempdorm=climat_dorm[i,2],
                                 pptgrow=climat_dorm[i,3],
                                 tempgrow=climat_dorm[i,4],
                                 rfx = rfx_fun(),
                                 max.yrs = max_yrs)
  lambda_dorm_mean_2sex[i] <- lambda_run$lambdatracker[max_yrs]
  SR_dorm_mean[i] <- lambda_run$SRtracker[max_yrs]
  OSR_dorm_mean[i] <- lambda_run$OSRtracker[max_yrs]
  ssd[,i] <- lambda_run$n0
    
}


```


```{r}
cbPalette <- RColorBrewer::brewer.pal(8, "Dark2")[c(2,1)]
par(mar=c(5,5,1,1))
plot(climat_dorm$pptdorm,lambda_dorm_mean,type="l",lwd=2,col=cbPalette[1],
     xlab="Precipitation growing season",ylab=expression(paste(lambda)),cex.lab=1.5,ylim=c(0,12.7))
lines(climat_dorm$pptdorm,lambda_dorm_mean_2sex,type="l",lwd=2,col=cbPalette[2])
legend("topright",legend=c("Two-sex","Female-dominant"),lwd=2,col =cbPalette ,bty="n",cex=1.2)
```

```{r}
library(RColorBrewer)
library(lattice)
cls <- colorRampPalette(rev(brewer.pal(11, 'RdYlBu')))(100)
mtrx_grow <- matrix(lambda_dorm_mean, nrow = 10, dimnames = list(pptdorm_seq_extend, 
               tempdorm_seq_extend))
# persp(mtrx_grow,xlab="Precipitation",ylab="Temperature",zlab=expression(paste(lambda)),
#                      theta = 30, phi = 30,col=cls)

trellis.par.set("axis.line",list(col=NA,lty=1,lwd=1))
wireframe(lambda_dorm_mean ~ climat_dorm$pptdorm_seq_extend + climat_dorm$tempdorm_seq_extend,
          # subset = lambda_grow_mean < 5, 
          zlab = list(expression(paste(lambda)), rot=90),
    drape = TRUE, col.regions = cls, scales = list(arrows = FALSE), 
    par.settings = list(axis.line = list(col = 'transparent')),
    main='', xlab='Precipitation', ylab='Temperature', screen=list(z = 120, x = -70, y = 3))

filled.contour(x=tempgrow_seq_extend,y=pptgrow_seq_extend,z=mtrx_grow)
# fields::image.plot(mtrx_grow)
filled.contour(mtrx_grow, plot.axes = {
  axis(1)
  axis(2)
  contour(mtrx_grow, add = TRUE, lwd = 1)
  }
)

grow_climate_plot<-data.frame(pptgrow=climat_grow$pptgrow_seq_extend,tempgrow=climat_grow$tempgrow_seq_extend,lambda=lambda_grow_mean)

gg = ggplot(grow_climate_plot, aes(x = pptgrow, y = tempgrow)) + 
  geom_raster(aes(fill = lambda)) + 
  geom_contour(aes(z = lambda), colour = "white", size = 0.2, alpha = 0.5) + 
  metR::geom_text_contour(aes(z = lambda),  colour = "white" ) +
  labs(x = "Temperature", 
      y = "Precipitation", 
      fill = "Lambda") + 
  theme(legend.title = element_text(size = 10, face = "bold"), 
  legend.position = "right", panel.background = element_blank(), 
  axis.text = element_text(colour = "black", size = 10), 
  axis.title = element_text(size = 12), 
  legend.text = element_text(size = 11), legend.key = element_blank()) + 
  scale_fill_continuous(low = "#BFE1B0", high = "#137177") + 
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) 

gg
```




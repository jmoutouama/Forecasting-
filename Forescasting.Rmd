---
title: "Demographic response of a dioecious range-limited species to climate change"
author: "Tom Miller,Jacob Moutouama and Aldo Compagnoni"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
 rmdformats::readthedown:
    code_folding: show
    self_contained: true
    number_sections: true
    thumbnails: true
    lightbox: true
    gallery: true
    keep_md: true
    highlight: tango
    df_print: kable 
    toc_depth: 3
    fig_width: 8
    fig_height: 8
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(comment=NA, 
                      echo = TRUE,
                      warning=FALSE, 
                      message=FALSE)
knitr::opts_knit$set(global.par = TRUE,knitr.table.format = "latex")
```

```{r eval=TRUE,echo=T}
rm(list = ls())
```

# Required libraries
```{r}
# load packages
library(rstan)
# set rstan options
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
set.seed(13)
# Sys.setenv(LOCAL_CPPFLAGS = '-march=corei7 -mtune=corei7')
options(tidyverse.quiet = TRUE)
library(tidyverse)
options(dplyr.summarise.inform = FALSE)
library(bayesplot)
# install.packages("countreg",repos = "http://R-Forge.R-project.org")
library(countreg)
library(rmutil)
library(actuar)
library(SPEI)
library(LaplacesDemon)
# if (!require("BiocManager", quietly = TRUE))
#     install.packages("BiocManager")
# BiocManager::install("scater")
library(scater)
```

# Demography and germination data  
```{r}
poar_allsites <- read.csv("https://www.dropbox.com/s/xk4225mn8btqhbm/demography_allsites.csv?dl=1", stringsAsFactors = F)#common garden data
poar_allsites$census.year<-poar_allsites$year-1 #Add census year to match with climate data
poar_allsites %>% 
  dplyr::select(everything()) %>% 
  filter(census.year %in% (2015:2016))-> poar_allsites_2015_2016 # Drop the first census to match with the seasonal model (growing and dormant season temp and precip)
viabVr <- read.csv("https://www.dropbox.com/s/jfkgoxgv8o1fgqx/viability.csv?dl=1") #seed viability and germination
```

# Current climatic conditions 
```{r}
poar_ppt <- read.csv("https://www.dropbox.com/s/kkga2hf9k1w9ht1/Poa_pr.csv?dl=1", stringsAsFactors = F) # monthly  precipitation 
poar_temp <- read.csv("https://www.dropbox.com/s/n0vrn8q5ma49rc9/Poa_tas.csv?dl=1", stringsAsFactors = F) # monthly temperature)
poar_ppt$census.year<-ifelse(poar_ppt$month<5,poar_ppt$year-1,poar_ppt$year) # data were collected in May. Thus, the precipitation for the census year is both the precipitation from May to December of the previous year and precipitation of the current year.  
poar_temp$census.year<-ifelse(poar_temp$month<5,poar_temp$year-1,poar_temp$year)
```

# Model with annual variables 
## Climatic data for the model with annual precipitation, annual mean temprature and their coefficient of variation
```{r}
poar_ppt %>% 
  dplyr::select(Longitude, Latitude, census.year, ppt,site) %>% 
  filter(census.year %in% (2015:2016)) %>%
  group_by(site,census.year) %>%
	summarise(mean_ppt=sum(ppt),sd_ppt=sd(ppt),cv_ppt=sd_ppt/mean_ppt,Longitude=unique(Longitude),Latitude=unique(Latitude))->poar_pptann 

poar_temp %>% 
  dplyr::select(Longitude, Latitude, census.year, temp,site) %>% 
  filter(census.year %in% (2015:2016)) %>%
  group_by(site,census.year) %>%
	summarise(mean_temp = mean(temp),sd_temp=sd(temp),cv_temp=sd_temp/mean_temp,Longitude=unique(Longitude),Latitude=unique(Latitude))->poar_tempann 

poar_climann<- merge(x = poar_pptann, y = poar_tempann) # merge temperature and precipitation data
```



## Match climatic data with annual precipitation, annual mean temprature and their coefficient of variation

```{r}
poar_allsites.clim <- left_join(x = poar_allsites_2015_2016 ,y =poar_climann,by=c("site","census.year","Longitude","Latitude")) # merge the demographic data with climatic data for each site
names(poar_allsites.clim)
```

# Check for correlation between predictors ( precipitation and seasonality of precipitation,  temperature and seasonality of temperature )

```{r,eval=FALSE}
figppt <- ggpubr::ggscatter(poar_allsites.clim, x = "mean_ppt", y = "cv_ppt", color = '#0072B2',shape = 19, size=4,xlab="Annual mean precipitation",
  ylab="CV precipitation",
   add = "reg.line",  # Add regressin line
   add.params = list(color = "#0072B2", fill = "lightgray"), # Customize reg. line
   conf.int = TRUE # Add confidence interval
   )
figppt<-figppt + ggpubr::stat_cor(method = "pearson", label.x = 1200, label.y = 0.04)

fitemp <- ggpubr::ggscatter(poar_allsites.clim, x = "mean_temp", y = "cv_temp",color = '#0072B2',shape = 19,size=4,xlab="Annual mean temperature ",ylab="CV temperature",
   add = "reg.line",  # Add regressin line
   add.params = list(color = "#0072B2", fill = "lightgray"), # Customize reg. line
   conf.int = TRUE # Add confidence interval
   )
fitemp<-fitemp + ggpubr::stat_cor(method = "pearson", label.x = 14, label.y = 0.2)


(figppttemp<-ggpubr::ggarrange(plotlist = list(figppt, fitemp)))

pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Figures/Correlationannualclimate.pdf",useDingbats = F,height=5,width=8)
print(figppttemp)
dev.off()
```

# Data for each vital rate
```{r}
# Survival
poar_allsites.clim %>% 
  subset( tillerN_t0 > 0 )%>%
  dplyr::select( year, Code, site, Block, Sex, 
          Longitude, Latitude, 
          tillerN_t0, surv_t1,mean_ppt,cv_ppt,mean_temp,site)%>% 
  na.omit %>% 
  mutate( site         = site %>% as.factor %>% as.numeric,
          Block = Block %>% as.factor %>% as.numeric,
          Sex          = Sex %>% as.factor %>% as.numeric,
          source = Code %>% as.factor %>% as.numeric ) %>%
  mutate( z_size_t0   = tillerN_t0 %>% scale %>% .[,1],
          z_ppt_t1_z = mean_ppt %>% scale %>% .[,1],
          z_cvppt_t1_z = cv_ppt %>% scale %>% .[,1],
          z_temp_t1_z = mean_temp %>% scale %>% .[,1])->poar_allsites.surv
# growth
poar_allsites.clim %>% 
  subset( tillerN_t0 > 0 & tillerN_t1 > 0)%>%
  dplyr::select( year, Code, site, Block, Sex, 
          Longitude, Latitude, 
          tillerN_t0, tillerN_t1,surv_t1,mean_ppt,cv_ppt,mean_temp,site)%>% 
  na.omit %>% 
  mutate( site         = site %>% as.factor %>% as.numeric,
          Block = Block %>% as.factor %>% as.numeric,
          Sex          = Sex %>% as.factor %>% as.numeric,
          source = Code %>% as.factor %>% as.numeric ) %>%
  mutate( z_size_t0   = tillerN_t0 %>% scale %>% .[,1],
          z_ppt_t1_z = mean_ppt %>% scale %>% .[,1],
          z_cvppt_t1_z = cv_ppt %>% scale %>% .[,1],
          z_temp_t1_z = mean_temp %>% scale %>% .[,1])->poar_allsites.grow
# flowering
poar_allsites.clim %>% 
  subset( tillerN_t1 > 0 )%>%
  dplyr::select( year, Code, site, Block, Sex, 
          Longitude, Latitude, 
          tillerN_t1, flowerN_t1,flow_t1,mean_ppt,cv_ppt,mean_temp,site)%>% 
  na.omit %>% 
  mutate( site         = site %>% as.factor %>% as.numeric,
          Block = Block %>% as.factor %>% as.numeric,
          Sex          = Sex %>% as.factor %>% as.numeric,
          source = Code %>% as.factor %>% as.numeric ) %>%
  mutate( z_size_t1   = tillerN_t1 %>% scale %>% .[,1],
          z_ppt_t1_z = mean_ppt %>% scale %>% .[,1],
          z_cvppt_t1_z = cv_ppt %>% scale %>% .[,1],
          z_temp_t1_z = mean_temp %>% scale %>% .[,1])->poar_allsites.flow
# Panicles
poar_allsites.clim %>% 
  subset( flowerN_t1 > 0 & tillerN_t1 > 0 )%>%
  dplyr::select( year, Code, site, Block, Sex, 
          Longitude, Latitude, 
          tillerN_t1, flowerN_t1,mean_ppt,cv_ppt,mean_temp,site)%>% 
  na.omit %>% 
  mutate( site         = site %>% as.factor %>% as.numeric,
          Block = Block %>% as.factor %>% as.numeric,
          Sex          = Sex %>% as.factor %>% as.numeric,
          source = Code %>% as.factor %>% as.numeric,
          panic_t1 = flowerN_t1) %>%
  mutate( z_size_t1   = tillerN_t1 %>% scale %>% .[,1],
          z_ppt_t1_z = mean_ppt %>% scale %>% .[,1],
          z_cvppt_t1_z = cv_ppt %>% scale %>% .[,1],
          z_temp_t1_z = mean_temp %>% scale %>% .[,1])->poar_allsites.panic

# seed viability
viabVr %>% 
  dplyr::select( plot, totS, yesMaybe, sr_f ) %>% 
  dplyr::rename( SR        = sr_f,
          y_viab = yesMaybe,
          tot_seeds_viab = totS) %>% 
  dplyr::select(y_viab, tot_seeds_viab, SR ) %>% 
  na.omit->viab

# seed germination
viabVr %>% 
  dplyr::select( plot, germTot, germFail, sr_f ) %>% 
  dplyr::rename( SR        = sr_f,
          y_germ    = germTot ) %>% 
  mutate(tot_seeds_germ = y_germ + germFail ) %>% 
  dplyr::select(y_germ, tot_seeds_germ, SR ) %>% 
  na.omit->germ

# seeds per panicle
viabVr %>% 
  dplyr::select(SeedN)  %>% 
  na.omit->seeds
```

# Bundle data for model for current climatic conditions and model with annual variables
```{r}
data_allsites <- list( n_sites    = poar_allsites.surv$site %>% n_distinct,
                  n_sources  = poar_allsites.surv$source %>% n_distinct(),
                  
                  # survival data
                  n_blocks_s = poar_allsites.surv$Block %>% n_distinct,
                  site_s   = poar_allsites.surv$site,
                  source_s =  poar_allsites.surv$source,
                  block_s  = poar_allsites.surv$Block,
                  ppt_s=poar_allsites.surv$z_ppt_t1_z,
                  cvppt_s=poar_allsites.surv$z_cvppt_t1_z,
                  temp_s=poar_allsites.surv$z_temp_t1_z,
                  site_block_s = data.frame( site_i  = poar_allsites.surv$site,
                                             block_i = poar_allsites.surv$Block ) %>%
                    unique %>% .$site_i,
                  male_s   = poar_allsites.surv$Sex-1,
                  size_s   = poar_allsites.surv$z_size_t0,
                  y_s      = poar_allsites.surv$surv_t1,
                  n_s      = nrow(poar_allsites.surv),
                  
                  # growth data
                  n_blocks_g = poar_allsites.grow$Block %>% n_distinct,
                  site_g   = poar_allsites.grow$site,
                  source_g =  poar_allsites.grow$source,
                  block_g  = poar_allsites.grow$Block,
                  ppt_g=poar_allsites.grow$z_ppt_t1_z,
                  cvppt_g=poar_allsites.grow$z_cvppt_t1_z,
                  temp_g=poar_allsites.grow$z_temp_t1_z,
                  site_block_g = data.frame( site_i  = poar_allsites.grow$site,
                                             block_i = poar_allsites.grow$Block ) %>%
                    unique %>% .$site_i,
                  male_g   = poar_allsites.grow$Sex-1,
                  size_g   = poar_allsites.grow$z_size_t0,
                  y_g      = poar_allsites.grow$tillerN_t1,
                  n_g      = nrow(poar_allsites.grow),

                  # flowering data
                   n_blocks_f = poar_allsites.flow$Block %>% n_distinct,
                  site_f   = poar_allsites.flow$site,
                  source_f =  poar_allsites.flow$source,
                  block_f  = poar_allsites.flow$Block,
                  ppt_f=poar_allsites.flow$z_ppt_t1_z,
                  cvppt_f=poar_allsites.flow$z_cvppt_t1_z,
                  temp_f=poar_allsites.flow$z_temp_t1_z,
                  site_block_f = data.frame( site_i  = poar_allsites.flow$site,
                                             block_i = poar_allsites.flow$Block ) %>%
                    unique %>% .$site_i,
                  male_f   = poar_allsites.flow$Sex-1,
                  size_f   = poar_allsites.flow$z_size_t1,
                  y_f      = poar_allsites.flow$flow_t1,
                  n_f      = nrow(poar_allsites.flow),

                  
                  # panicle data
                   n_blocks_p = poar_allsites.panic$Block %>% n_distinct,
                  site_p   = poar_allsites.panic$site,
                  source_p =  poar_allsites.panic$source,
                  block_p  = poar_allsites.panic$Block,
                  ppt_p=poar_allsites.panic$z_ppt_t1_z,
                  cvppt_p=poar_allsites.panic$z_cvppt_t1_z,
                  temp_p=poar_allsites.panic$z_temp_t1_z,
                  site_block_p = data.frame( site_i  = poar_allsites.panic$site,
                                             block_i = poar_allsites.panic$Block ) %>%
                    unique %>% .$site_i,
                  male_p   = poar_allsites.panic$Sex-1,
                  size_p   = poar_allsites.panic$z_size_t1,
                  y_p      = poar_allsites.panic$panic_t1,
                  n_p      = nrow(poar_allsites.panic), 

                  
                  # viability
                  n_v       = nrow(viab),
                  y_v       = viab$y_viab,
                  tot_seeds_v = viab$tot_seeds_viab,
                  SR_v        = viab$SR,
                  
                  # germination
                  n_m       = nrow(germ),
                  y_m       = germ$y_germ,
                  tot_seeds_m = germ$tot_seeds_germ,
                  SR_m        = germ$SR,
                  
                  # seeds per panicle
                  n_d = nrow(seeds),
                  y_d = seeds$SeedN)
```

# MCMC parameters
```{r}
sim_pars <- list(
  warmup = 1000,
  iter = 4000,
  thin = 3,
  chains = 3
)

```

```{r , eval=FALSE}
fit_allsites_full_annual <- stan(
 file = "F:/POAR-Forecasting-main/Stan/poar_vitalrate.stan",
 data = data_allsites,
 warmup = sim_pars$warmup,
 iter = sim_pars$iter,
 thin = sim_pars$thin,
 chains = sim_pars$chains)


saveRDS(fit_allsites_full_annual, 'F:/POAR-Forecasting-main/Stan/poar_vitalrate.rds')

```

```{r}
#load stan output: this will also take a while, but not as long as running the model from scratch
fit_allsites_full_annual <- readRDS(url("https://www.dropbox.com/s/3as6uzej386voyi/poar_vitalrate.rds?dl=1"))
#ignore warning from readRDS

```

```{r}
traceplot(fit_allsites_full_annual, pars = c("b0_s", "bsize_s","bsex_s","bppt_s","btemp_s","bcvppt_s","bpptsex_s","btempsex_s","bcvpptsex_s","bppttempsex_s","b0_g", "bsize_g","bsex_g","bppt_g","btemp_g","bcvppt_g","bpptsex_g","btempsex_g","bcvpptsex_g","bppttempsex_g","b0_p", "bsize_p","bsex_p","bppt_p","btemp_p","bcvppt_p","bpptsex_p","btempsex_p","bcvpptsex_p","bppttempsex_p","b0_f", "bsize_f","bsex_f","bppt_f","btemp_f","bcvppt_f","bpptsex_f","btempsex_f","bcvpptsex_f","bppttempsex_f","v0","a_v","m","phi_m","lambda_d"), inc_warmup = TRUE, nrow =9 )
```


```{r}
stan_dens(fit_allsites_full_annual, pars = c("b0_s", "bsize_s","bsex_s","bppt_s","btemp_s","bcvppt_s","bpptsex_s","btempsex_s","bcvpptsex_s","bppttempsex_s","b0_g", "bsize_g","bsex_g","bppt_g","btemp_g","bcvppt_g","bpptsex_g","btempsex_g","bcvpptsex_g","bppttempsex_g","b0_p", "bsize_p","bsex_p","bppt_p","btemp_p","bcvppt_p","bpptsex_p","btempsex_p","bcvpptsex_p","bppttempsex_p","b0_f", "bsize_f","bsex_f","bppt_f","btemp_f","bcvppt_f","bpptsex_f","btempsex_f","bcvpptsex_f","bppttempsex_f","v0","a_v","m","phi_m","lambda_d")) + geom_vline(xintercept = 0, linetype = 2)
```

# Posterior predictive check 

```{r}
#pull out parameter posterior distributions
predS <- rstan::extract(fit_allsites_full_annual, pars = c("predS"))$predS
predG <- rstan::extract(fit_allsites_full_annual, pars = c("predG"))$predG
sigmaG <- rstan::extract(fit_allsites_full_annual, pars = c("sigma"))$sigma
predF <- rstan::extract(fit_allsites_full_annual, pars = c("predF"))$predF
predP <- rstan::extract(fit_allsites_full_annual, pars = c("predP"))$predP
phi_P <- rstan::extract(fit_allsites_full_annual, pars = c("phi_p"))$phi_p
predV <- rstan::extract(fit_allsites_full_annual, pars = c("predV"))$predV
phi_V <- rstan::extract(fit_allsites_full_annual, pars = c("phi_v"))$phi_v
predM <- rstan::extract(fit_allsites_full_annual, pars = c("predM"))$predM
phi_M <- rstan::extract(fit_allsites_full_annual, pars = c("phi_m"))$phi_m

#draw 500 random samples from the joint posterior
n_post_draws <- 500
post_draws <- sample.int(dim(predS)[1], n_post_draws)
#set up simulation output
y_s_sim <- matrix(NA,n_post_draws,length(data_allsites$y_s))
y_g_sim <- matrix(NA,n_post_draws,length(data_allsites$y_g))
y_f_sim <- matrix(NA,n_post_draws,length(data_allsites$y_f))
y_p_sim <- matrix(NA,n_post_draws,length(data_allsites$y_p))
y_v_sim <- matrix(NA,n_post_draws,length(data_allsites$y_v))
y_m_sim <- matrix(NA,n_post_draws,length(data_allsites$y_m))

#loop over the posterior and generate new observations
for(i in 1:n_post_draws){
  print(i)
  ## sample survival data (bernoulli)
  y_s_sim[i,] <- rbinom(n=length(data_allsites$y_s), size=1, prob = invlogit(predS[i,]))
  ## sample flowering data (bernoulli)
  y_f_sim[i,] <- rbinom(n=length(data_allsites$y_f), size=1, prob = invlogit(predF[i,]))
  ## sample viability data (beta-binomial)
  y_v_sim[i,] <- rbetabinom(n=length(data_allsites$y_v), size=data_allsites$tot_seeds_v, m=predV[i,], s=phi_V[i])
  ## sample germination data (beta-binomial)
  y_m_sim[i,] <- rbetabinom(n=length(data_allsites$y_m), size=data_allsites$tot_seeds_m, m=predM[i,], s=phi_M[i])
  ## sample growth data (zero-truncated PIG) -- generates data as legit PIG
    for(j in 1:length(data_allsites$y_g)){
      ## the pig function appears numerically unstable at low probabilities, so here is a hacky solution
      pig<-dpoisinvgauss(0:1000,mean=predG[i,j],shape=(sigmaG[i]*predG[i,j]))
      pig[is.nan(pig) | is.infinite(pig)] <- 0
      pig_trunc_prob <- pig[2:1001] / (1 - ((1 - sum(pig)) + pig[1]))
      y_g_sim[i,j] <- sample(x=1:1000,size=1,replace=T,prob=pig_trunc_prob)
    } 
  ## sample panicle data (zero-truncated NB)
  for(j in 1:length(data_allsites$y_p)){
    y_p_sim[i,j] <- sample(x=1:1000,size=1,replace=T,prob=dnbinom(1:1000, mu = exp(predP[i,j]), size=phi_P[i]) / (1 - dnbinom(0, mu = exp(predP[i,j]), size=phi_P[i])))
  }
}
```



# plot ppc overlay
```{r}
ppc_dens_overlay(data_allsites$y_s, y_s_sim)+
  xlab("Survival status")+ylab("Density")+
  ggtitle(("Survival"))+theme(legend.position = "none")->ppc_surv
ppc_dens_overlay(data_allsites$y_g, na.omit(y_g_sim))+xlim(0, 50)+
  xlab("Number of tillers")+ylab("Density")+
  ggtitle(("Growth"))+theme(legend.position = "none")->ppc_grow
ppc_dens_overlay(data_allsites$y_f, y_f_sim)+
  xlab("Flowering status")+ylab("Density")+
  ggtitle(("Flowering"))+theme(legend.position = "none")->ppc_flow
ppc_dens_overlay(data_allsites$y_p, y_p_sim)+xlim(0, 30)+
  xlab("Number of panicles")+ylab("Density")+
  ggtitle(("Panicles"))+theme(legend.position = "none")->ppc_panic
ppc_dens_overlay(data_allsites$y_v, y_v_sim)+
  xlab("Number of viable seeds")+ylab("Density")+
  ggtitle(("Seed viability"))+theme(legend.position = "none")->ppc_viab
ppc_dens_overlay(data_allsites$y_m, y_m_sim)+
  xlab("Number of germinants")+ylab("Density")+
  ggtitle(("Seed germination"))+theme(legend.position = "none")->ppc_germ

#print figure
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Figures/PPCannualclimate.pdf",useDingbats = F,height=10,width=6)
multiplot(ppc_surv,ppc_flow,ppc_viab,
          ppc_grow,ppc_panic,ppc_germ,cols=2)
dev.off()
```

```{r}
posteriorannual <- as.array(fit_allsites_full_annual)
color_scheme_set("blue")
mcmc_intervals(posteriorannual, pars = c("b0_s", "bsize_s","bsex_s","bppt_s","btemp_s","bcvppt_s","bpptsex_s","btempsex_s","bcvpptsex_s","bppttempsex_s","b0_g", "bsize_g","bsex_g","bppt_g","btemp_g","bcvppt_g","bpptsex_g","btempsex_g","bcvpptsex_g","bppttempsex_g","b0_p", "bsize_p","bsex_p","bppt_p","btemp_p","bcvppt_p","bpptsex_p","btempsex_p","bcvpptsex_p","bppttempsex_p","b0_f", "bsize_f","bsex_f","bppt_f","btemp_f","bcvppt_f","bpptsex_f","btempsex_f","bcvpptsex_f","bppttempsex_f"))+ geom_vline(xintercept = 0, linetype = 2)+theme_bw()
```

# Model with seasonal variables
## Climatic data with  seasonal variables (growing and dormant season temp and precip) 
```{r img-with-knitr,echo=FALSE, fig.align='center', out.width='100%', fig.cap='Growing and dormant season for Poa arachnifera'}
knitr::include_graphics("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Figures/POARlifecycle.png")
```

```{r}
poar_temp %>% 
  dplyr::select(site,Longitude, Latitude,census.year,temp,month) %>% 
  filter(census.year %in% (2015:2016)) %>%
  mutate(Season=ifelse((month >= 6) & (month <= 9), "dormant", "growing")) %>% 
  group_by(site,Season) %>%
	summarise(site=unique(site),Longitude=unique(Longitude),Latitude=unique(Latitude),temp_season = mean(temp))->poar_tempseason 

poar_ppt %>% 
  dplyr::select(site,Longitude, Latitude,census.year,ppt,month) %>% 
  filter(census.year %in% (2015:2016)) %>%
  mutate(Season=ifelse((month >= 6) & (month <= 9), "dormant", "growing")) %>% 
  group_by(site,Season) %>%
	summarise(site=unique(site),Longitude=unique(Longitude),Latitude=unique(Latitude),ppt_season = sum(ppt))->poar_pptseason 

poar_climseason<- merge(x = poar_tempseason, y = poar_pptseason) # merge temperature and precipitation data

```

## Match seasonnal data with demographic data and clean the data 

```{r}
poar_allsites.clim_season <- left_join(x = poar_allsites_2015_2016 ,y =poar_climseason,by=c("site","Longitude","Latitude")) # merge the demographic data with climatic data for each site
poar_allsites.clim_season %>% 
  filter(Season=="growing") %>% 
  mutate(tempgrow=temp_season,pptgrow=ppt_season)->poar_allsites.clim_season_grow

# head(poar_allsites.clim_season_grow)
# head(poar_allsites.clim_season_dorm)
poar_allsites.clim_season %>% 
  filter(Season=="dormant") %>% 
  mutate(tempdorm=temp_season,pptdorm=ppt_season)->poar_allsites.clim_season_dorm


poar.clim_seasonal<- cbind(poar_allsites.clim_season_grow,tempdorm=poar_allsites.clim_season_dorm$tempdorm,pptdorm=poar_allsites.clim_season_dorm$pptdorm)


```

# Check for correlation between predictors

```{r,eval=FALSE}
figgrow <- ggpubr::ggscatter(poar.clim_seasonal, x = "tempgrow", y = "pptgrow", color = '#0072B2',shape = 19, size=4,xlab="Annual mean temperature",
  ylab="Annual mean precipitation",
   add = "reg.line",  # Add regressin line
   add.params = list(color = "#0072B2", fill = "lightgray"), # Customize reg. line
   conf.int = TRUE # Add confidence interval
   )
figgrow<-figgrow + ggpubr::stat_cor(method = "pearson")



figdorm <- ggpubr::ggscatter(poar.clim_seasonal, x = "tempdorm", y = "pptdorm",color = '#0072B2',shape = 19,size=4,xlab="Annual mean temperature ",ylab="Annual mean precipitation",
   add = "reg.line",  # Add regressin line
   add.params = list(color = "#0072B2", fill = "lightgray"), # Customize reg. line
   conf.int = TRUE # Add confidence interval
   )
figdorm<-figdorm + ggpubr::stat_cor(method = "pearson")


(figgrowdorm<-ggpubr::ggarrange(plotlist = list(figgrow, figdorm)))

# pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Figures/Correlationannualclimate.pdf",useDingbats = F,height=5,width=8)
# print(figppttemp)
# dev.off()
```



# Data for each vital rate
```{r}
# Survival
poar.clim_seasonal %>% 
  subset( tillerN_t0 > 0 )%>%
  dplyr::select( year, Code, site, Block, Sex, 
          Longitude, Latitude, 
          tillerN_t0, surv_t1,pptgrow,pptdorm,tempgrow,tempdorm,site)%>% 
  na.omit %>% 
  mutate( site         = site %>% as.factor %>% as.numeric,
          Block = Block %>% as.factor %>% as.numeric,
          Sex          = Sex %>% as.factor %>% as.numeric,
          source = Code %>% as.factor %>% as.numeric ) %>%
  mutate( z_size_t0   = tillerN_t0 %>% scale %>% .[,1],
          z_ppt_t1_grow = pptgrow %>% scale %>% .[,1],
          z_ppt_t1_dorm = pptdorm %>% scale %>% .[,1],
          z_temp_t1_grow = tempgrow %>% scale %>% .[,1],
          z_temp_t1_dorm = tempdorm %>% scale %>% .[,1])->poarclim_seasonal.surv
# growth
poar.clim_seasonal %>% 
  subset( tillerN_t0 > 0 & tillerN_t1 > 0)%>%
  dplyr::select( year, Code, site, Block, Sex, 
          Longitude, Latitude, 
          tillerN_t0, tillerN_t1,surv_t1,pptgrow,pptdorm,tempgrow,tempdorm,site)%>% 
  na.omit %>% 
  mutate( site         = site %>% as.factor %>% as.numeric,
          Block = Block %>% as.factor %>% as.numeric,
          Sex          = Sex %>% as.factor %>% as.numeric,
          source = Code %>% as.factor %>% as.numeric ) %>%
  mutate( z_size_t0   = tillerN_t0 %>% scale %>% .[,1],
          z_ppt_t1_grow = pptgrow %>% scale %>% .[,1],
          z_ppt_t1_dorm = pptdorm %>% scale %>% .[,1],
          z_temp_t1_grow = tempgrow %>% scale %>% .[,1],
          z_temp_t1_dorm = tempdorm %>% scale %>% .[,1])->poarclim_seasonal.grow
# flowering
poar.clim_seasonal %>% 
  subset( tillerN_t1 > 0 )%>%
  dplyr::select( year, Code, site, Block, Sex, 
          Longitude, Latitude, 
          tillerN_t1, flowerN_t1,flow_t1,pptgrow,pptdorm,tempgrow,tempdorm,site)%>% 
  na.omit %>% 
  mutate( site         = site %>% as.factor %>% as.numeric,
          Block = Block %>% as.factor %>% as.numeric,
          Sex          = Sex %>% as.factor %>% as.numeric,
          source = Code %>% as.factor %>% as.numeric ) %>%
  mutate( z_size_t1   = tillerN_t1 %>% scale %>% .[,1],
          z_ppt_t1_grow = pptgrow %>% scale %>% .[,1],
          z_ppt_t1_dorm = pptdorm %>% scale %>% .[,1],
          z_temp_t1_grow = tempgrow %>% scale %>% .[,1],
          z_temp_t1_dorm = tempdorm %>% scale %>% .[,1])->poarclim_seasonal.flow
# Panicles
poar.clim_seasonal %>% 
  subset( flowerN_t1 > 0 & tillerN_t1 > 0 )%>%
  dplyr::select( year, Code, site, Block, Sex, 
          Longitude, Latitude, 
          tillerN_t1, flowerN_t1,pptgrow,pptdorm,tempgrow,tempdorm,site)%>% 
  na.omit %>% 
  mutate( site         = site %>% as.factor %>% as.numeric,
          Block = Block %>% as.factor %>% as.numeric,
          Sex          = Sex %>% as.factor %>% as.numeric,
          source = Code %>% as.factor %>% as.numeric,
          panic_t1 = flowerN_t1) %>%
  mutate( z_size_t1   = tillerN_t1 %>% scale %>% .[,1],
          z_ppt_t1_grow = pptgrow %>% scale %>% .[,1],
          z_ppt_t1_dorm = pptdorm %>% scale %>% .[,1],
          z_temp_t1_grow = tempgrow %>% scale %>% .[,1],
          z_temp_t1_dorm = tempdorm %>% scale %>% .[,1])->poarclim_seasonal.panic

# seed viability
viabVr %>% 
  dplyr::select( plot, totS, yesMaybe, sr_f ) %>% 
  dplyr::rename( SR        = sr_f,
          y_viab = yesMaybe,
          tot_seeds_viab = totS) %>% 
  dplyr::select(y_viab, tot_seeds_viab, SR ) %>% 
  na.omit->viab

# seed germination
viabVr %>% 
  dplyr::select( plot, germTot, germFail, sr_f ) %>% 
  dplyr::rename( SR        = sr_f,
          y_germ    = germTot ) %>% 
  mutate(tot_seeds_germ = y_germ + germFail ) %>% 
  dplyr::select(y_germ, tot_seeds_germ, SR ) %>% 
  na.omit->germ

# seeds per panicle
viabVr %>% 
  dplyr::select(SeedN)  %>% 
  na.omit->seeds
```

# Bundle data for model for current climatic conditions and model with annual variables
```{r}
data_allsites.season <- list( n_sites    = poarclim_seasonal.surv$site %>% n_distinct,
                  n_sources  = poarclim_seasonal.surv$source %>% n_distinct(),
                  
                  # survival data
                  n_blocks_s = poarclim_seasonal.surv$Block %>% n_distinct,
                  site_s   = poarclim_seasonal.surv$site,
                  source_s =  poarclim_seasonal.surv$source,
                  block_s  = poarclim_seasonal.surv$Block,
                  pptgrow_s=poarclim_seasonal.surv$z_ppt_t1_grow,
                  pptdorm_s=poarclim_seasonal.surv$z_ppt_t1_dorm,
                  tempgrow_s=poarclim_seasonal.surv$z_temp_t1_grow,
                  tempdorm_s=poarclim_seasonal.surv$z_temp_t1_dorm,
                  site_block_s = data.frame( site_i  = poarclim_seasonal.surv$site,
                                             block_i = poarclim_seasonal.surv$Block ) %>%
                    unique %>% .$site_i,
                  male_s   = poarclim_seasonal.surv$Sex-1,
                  size_s   = poarclim_seasonal.surv$z_size_t0,
                  y_s      = poarclim_seasonal.surv$surv_t1,
                  n_s      = nrow(poarclim_seasonal.surv),
                  
                  # growth data
                  n_blocks_g = poarclim_seasonal.grow$Block %>% n_distinct,
                  site_g   = poarclim_seasonal.grow$site,
                  source_g =  poarclim_seasonal.grow$source,
                  block_g  = poarclim_seasonal.grow$Block,
                  pptgrow_g=poarclim_seasonal.grow$z_ppt_t1_grow,
                  pptdorm_g=poarclim_seasonal.grow$z_ppt_t1_dorm,
                  tempgrow_g=poarclim_seasonal.grow$z_temp_t1_grow,
                  tempdorm_g=poarclim_seasonal.grow$z_temp_t1_dorm,
                  site_block_g = data.frame( site_i  = poarclim_seasonal.grow$site,
                                             block_i = poarclim_seasonal.grow$Block ) %>%
                    unique %>% .$site_i,
                  male_g   = poarclim_seasonal.grow$Sex-1,
                  size_g   = poarclim_seasonal.grow$z_size_t0,
                  y_g      = poarclim_seasonal.grow$tillerN_t1,
                  n_g      = nrow(poarclim_seasonal.grow),

                  # flowering data
                   n_blocks_f = poarclim_seasonal.flow$Block %>% n_distinct,
                  site_f   = poarclim_seasonal.flow$site,
                  source_f =  poarclim_seasonal.flow$source,
                  block_f  = poarclim_seasonal.flow$Block,
                  pptgrow_f=poarclim_seasonal.flow$z_ppt_t1_grow,
                  pptdorm_f=poarclim_seasonal.flow$z_ppt_t1_dorm,
                  tempgrow_f=poarclim_seasonal.flow$z_temp_t1_grow,
                  tempdorm_f=poarclim_seasonal.flow$z_temp_t1_dorm,
                  site_block_f = data.frame( site_i  = poarclim_seasonal.flow$site,
                                             block_i = poarclim_seasonal.flow$Block ) %>%
                    unique %>% .$site_i,
                  male_f   = poarclim_seasonal.flow$Sex-1,
                  size_f   = poarclim_seasonal.flow$z_size_t1,
                  y_f      = poarclim_seasonal.flow$flow_t1,
                  n_f      = nrow(poarclim_seasonal.flow),

                  
                  # panicle data
                   n_blocks_p = poarclim_seasonal.panic$Block %>% n_distinct,
                  site_p   = poarclim_seasonal.panic$site,
                  source_p =  poarclim_seasonal.panic$source,
                  block_p  = poarclim_seasonal.panic$Block,
                  pptgrow_p=poarclim_seasonal.panic$z_ppt_t1_grow,
                  pptdorm_p=poarclim_seasonal.panic$z_ppt_t1_dorm,
                  tempgrow_p=poarclim_seasonal.panic$z_temp_t1_grow,
                  tempdorm_p=poarclim_seasonal.panic$z_temp_t1_dorm,
                  site_block_p = data.frame( site_i  = poarclim_seasonal.panic$site,
                                             block_i = poarclim_seasonal.panic$Block ) %>%
                    unique %>% .$site_i,
                  male_p   = poarclim_seasonal.panic$Sex-1,
                  size_p   = poarclim_seasonal.panic$z_size_t1,
                  y_p      = poarclim_seasonal.panic$panic_t1,
                  n_p      = nrow(poarclim_seasonal.panic), 

                  
                  # viability
                  n_v       = nrow(viab),
                  y_v       = viab$y_viab,
                  tot_seeds_v = viab$tot_seeds_viab,
                  SR_v        = viab$SR,
                  
                  # germination
                  n_m       = nrow(germ),
                  y_m       = germ$y_germ,
                  tot_seeds_m = germ$tot_seeds_germ,
                  SR_m        = germ$SR,
                  
                  # seeds per panicle
                  n_d = nrow(seeds),
                  y_d = seeds$SeedN)
```

# MCMC parameters
```{r}
sim_pars <- list(
  warmup = 1000,
  iter = 4000,
  thin = 3,
  chains = 3
)

```

```{r , eval=FALSE}
fit_allsites_full_season <- stan(
 file = "F:/POAR-Forecasting-main/Stan/poar_vitalrate_season.stan",
 data = data_allsites.season,
 warmup = sim_pars$warmup,
 iter = sim_pars$iter,
 thin = sim_pars$thin,
 chains = sim_pars$chains)


saveRDS(fit_allsites_full_season, 'F:/POAR-Forecasting-main/stan/poar_vitalrate_season.rds')

```

```{r}
#load stan output: this will also take a while, but not as long as running the model from scratch
fit_allsites_full_seasonal <- readRDS(url("https://www.dropbox.com/s/4nnty0zl5ecm75e/poar_vitalrate_season.rds?dl=1"))
#ignore warning from readRDS

```

```{r}
traceplot(fit_allsites_full_seasonal, pars = c("b0_s", "bsize_s","bpptgrow_s","bpptdorm_s","btempgrow_s","btempdorm_s","bpptgrowsex_s","bpptdormsex_s","btempgrowsex_s","btempdormsex_s","btempdormpptdormsex_s","btempgrowpptgrowsex_s","b0_g", "bsize_g","bpptgrow_g","bpptdorm_g","btempgrow_g","btempdorm_g","bpptgrowsex_g","bpptdormsex_g","btempgrowsex_g","btempdormsex_g","btempdormpptdormsex_g","btempgrowpptgrowsex_g","b0_p", "bsize_p","bpptgrow_p","bpptdorm_p","btempgrow_p","btempdorm_p","bpptgrowsex_p","bpptdormsex_p","btempgrowsex_p","btempdormsex_p","btempdormpptdormsex_p","btempgrowpptgrowsex_p","b0_f", "bsize_f","bpptgrow_f","bpptdorm_f","btempgrow_f","btempdorm_f","bpptgrowsex_f","bpptdormsex_f","btempgrowsex_f","btempdormsex_f","btempdormpptdormsex_f","btempgrowpptgrowsex_f","v0","a_v","m","phi_m","lambda_d"), inc_warmup = TRUE, nrow =9 )
```

```{r}
stan_dens(fit_allsites_full_seasonal, pars = c("b0_s", "bsize_s","bpptgrow_s","bpptdorm_s","btempgrow_s","btempdorm_s","bpptgrowsex_s","bpptdormsex_s","btempgrowsex_s","btempdormsex_s","btempdormpptdormsex_s","btempgrowpptgrowsex_s","b0_g", "bsize_g","bpptgrow_g","bpptdorm_g","btempgrow_g","btempdorm_g","bpptgrowsex_g","bpptdormsex_g","btempgrowsex_g","btempdormsex_g","btempdormpptdormsex_g","btempgrowpptgrowsex_g","b0_p", "bsize_p","bpptgrow_p","bpptdorm_p","btempgrow_p","btempdorm_p","bpptgrowsex_p","bpptdormsex_p","btempgrowsex_p","btempdormsex_p","btempdormpptdormsex_p","btempgrowpptgrowsex_p","b0_f", "bsize_f","bpptgrow_f","bpptdorm_f","btempgrow_f","btempdorm_f","bpptgrowsex_f","bpptdormsex_f","btempgrowsex_f","btempdormsex_f","btempdormpptdormsex_f","btempgrowpptgrowsex_f","v0","a_v","m","phi_m","lambda_d")) + geom_vline(xintercept = 0, linetype = 2)
```

# Posterior predictive check 

```{r}
#pull out parameter posterior distributions
predS <- rstan::extract(fit_allsites_full_seasonal, pars = c("predS"))$predS
predG <- rstan::extract(fit_allsites_full_seasonal, pars = c("predG"))$predG
sigmaG <- rstan::extract(fit_allsites_full_seasonal, pars = c("sigma"))$sigma
predF <- rstan::extract(fit_allsites_full_seasonal, pars = c("predF"))$predF
predP <- rstan::extract(fit_allsites_full_seasonal, pars = c("predP"))$predP
phi_P <- rstan::extract(fit_allsites_full_seasonal, pars = c("phi_p"))$phi_p
predV <- rstan::extract(fit_allsites_full_seasonal, pars = c("predV"))$predV
phi_V <- rstan::extract(fit_allsites_full_seasonal, pars = c("phi_v"))$phi_v
predM <- rstan::extract(fit_allsites_full_seasonal, pars = c("predM"))$predM
phi_M <- rstan::extract(fit_allsites_full_seasonal, pars = c("phi_m"))$phi_m

#draw 500 random samples from the joint posterior
n_post_draws <- 500
post_draws <- sample.int(dim(predS)[1], n_post_draws)
#set up simulation output
y_s_sim <- matrix(NA,n_post_draws,length(data_allsites.season$y_s))
y_g_sim <- matrix(NA,n_post_draws,length(data_allsites.season$y_g))
y_f_sim <- matrix(NA,n_post_draws,length(data_allsites.season$y_f))
y_p_sim <- matrix(NA,n_post_draws,length(data_allsites.season$y_p))
y_v_sim <- matrix(NA,n_post_draws,length(data_allsites.season$y_v))
y_m_sim <- matrix(NA,n_post_draws,length(data_allsites.season$y_m))

#loop over the posterior and generate new observations
for(i in 1:n_post_draws){
  print(i)
  ## sample survival data (bernoulli)
  y_s_sim[i,] <- rbinom(n=length(data_allsites.season$y_s), size=1, prob = invlogit(predS[i,]))
  ## sample flowering data (bernoulli)
  y_f_sim[i,] <- rbinom(n=length(data_allsites.season$y_f), size=1, prob = invlogit(predF[i,]))
  ## sample viability data (beta-binomial)
  y_v_sim[i,] <- rbetabinom(n=length(data_allsites.season$y_v), size=data_allsites.season$tot_seeds_v, m=predV[i,], s=phi_V[i])
  ## sample germination data (beta-binomial)
  y_m_sim[i,] <- rbetabinom(n=length(data_allsites.season$y_m), size=data_allsites.season$tot_seeds_m, m=predM[i,], s=phi_M[i])
  ## sample growth data (zero-truncated PIG) -- generates data as legit PIG
    for(j in 1:length(data_allsites.season$y_g)){
      ## the pig function appears numerically unstable at low probabilities, so here is a hacky solution
      pig<-dpoisinvgauss(0:1000,mean=predG[i,j],shape=(sigmaG[i]*predG[i,j]))
      pig[is.nan(pig) | is.infinite(pig)] <- 0
      pig_trunc_prob <- pig[2:1001] / (1 - ((1 - sum(pig)) + pig[1]))
      y_g_sim[i,j] <- sample(x=1:1000,size=1,replace=T,prob=pig_trunc_prob)
    } 
  ## sample panicle data (zero-truncated NB)
  for(j in 1:length(data_allsites.season$y_p)){
    y_p_sim[i,j] <- sample(x=1:1000,size=1,replace=T,prob=dnbinom(1:1000, mu = exp(predP[i,j]), size=phi_P[i]) / (1 - dnbinom(0, mu = exp(predP[i,j]), size=phi_P[i])))
  }
}
```



# plot ppc overlay
```{r}
ppc_dens_overlay(data_allsites$y_s, y_s_sim)+
  xlab("Survival status")+ylab("Density")+
  ggtitle(("Survival"))+theme(legend.position = "none")->ppc_surv
ppc_dens_overlay(data_allsites$y_g, na.omit(y_g_sim))+xlim(0, 50)+
  xlab("Number of tillers")+ylab("Density")+
  ggtitle(("Growth"))+theme(legend.position = "none")->ppc_grow
ppc_dens_overlay(data_allsites$y_f, y_f_sim)+
  xlab("Flowering status")+ylab("Density")+
  ggtitle(("Flowering"))+theme(legend.position = "none")->ppc_flow
ppc_dens_overlay(data_allsites$y_p, y_p_sim)+xlim(0, 30)+
  xlab("Number of panicles")+ylab("Density")+
  ggtitle(("Panicles"))+theme(legend.position = "none")->ppc_panic
ppc_dens_overlay(data_allsites$y_v, y_v_sim)+
  xlab("Number of viable seeds")+ylab("Density")+
  ggtitle(("Seed viability"))+theme(legend.position = "none")->ppc_viab
ppc_dens_overlay(data_allsites$y_m, y_m_sim)+
  xlab("Number of germinants")+ylab("Density")+
  ggtitle(("Seed germination"))+theme(legend.position = "none")->ppc_germ

#print figure
pdf("/Users/jm200/Library/CloudStorage/Dropbox/Miller Lab/github/POAR-Forecasting/Figures/PPCseasonclimate.pdf",useDingbats = F,height=10,width=6)
multiplot(ppc_surv,ppc_flow,ppc_viab,
          ppc_grow,ppc_panic,ppc_germ,cols=2)
dev.off()
```

```{r}
posteriorseason <- as.array(fit_allsites_full_seasonal)
color_scheme_set("blue")
mcmc_intervals(posteriorseason, pars = c("b0_s", "bsize_s","bpptgrow_s","bpptdorm_s","btempgrow_s","btempdorm_s","bpptgrowsex_s","bpptdormsex_s","btempgrowsex_s","btempdormsex_s","btempdormpptdormsex_s","btempgrowpptgrowsex_s","b0_g", "bsize_g","bpptgrow_g","bpptdorm_g","btempgrow_g","btempdorm_g","bpptgrowsex_g","bpptdormsex_g","btempgrowsex_g","btempdormsex_g","btempdormpptdormsex_g","btempgrowpptgrowsex_g","b0_p", "bsize_p","bpptgrow_p","bpptdorm_p","btempgrow_p","btempdorm_p","bpptgrowsex_p","bpptdormsex_p","btempgrowsex_p","btempdormsex_p","btempdormpptdormsex_p","btempgrowpptgrowsex_p","b0_f", "bsize_f","bpptgrow_f","bpptdorm_f","btempgrow_f","btempdorm_f","bpptgrowsex_f","bpptdormsex_f","btempgrowsex_f","btempdormsex_f","btempdormpptdormsex_f","btempgrowpptgrowsex_f"))+ geom_vline(xintercept = 0, linetype = 2)+theme_bw()
```


# Plotting vital rate
# Re-format data for plotting
```{r}
poar <- poar_allsites  
```

```{r}
## Survival
poar_allsites.surv %>% 
  group_by(site,Sex) %>% 
  summarise(mean_size = mean(z_size_t0),
            mean_surv = mean(surv_t1),
            ppt = unique(mean_ppt),
            mean_ppt= mean(mean_ppt),
            temp = unique(mean_temp),
            mean_temp= mean(mean_temp),
            cv_ppt=unique(cv_ppt),
            mean_cv_ppt=mean(cv_ppt))->poar_surv_plot
surv_mean_sizes <- poar_surv_plot %>% group_by(Sex) %>% summarise(size = mean(mean_size))
surv_mean_temp <- poar_surv_plot %>% group_by(Sex) %>% summarise(temp = mean(mean_temp))
surv_mean_ppt <- poar_surv_plot %>% group_by(Sex) %>% summarise(ppt = mean(mean_ppt))
surv_mean_cv_ppt <- poar_surv_plot %>% group_by(Sex) %>% summarise(cv_ppt = mean(cv_ppt))

## Growth
poar_allsites.grow %>% 
  group_by(site,Sex) %>% 
  summarise(mean_size = mean(z_size_t0),
            mean_grow = mean(tillerN_t1),
            ppt = unique(mean_ppt),
            mean_ppt= mean(mean_ppt),
            temp = unique(mean_temp),
            mean_temp= mean(mean_temp),
            cv_ppt=unique(cv_ppt),
            mean_cv_ppt=mean(cv_ppt),
            )->poar_grow_plot

grow_mean_sizes <- poar_grow_plot %>% group_by(Sex) %>% summarise(size = mean(mean_size))
grow_mean_temp <- poar_grow_plot %>% group_by(Sex) %>% summarise(temp = mean(mean_temp))
grow_mean_ppt <- poar_grow_plot %>% group_by(Sex) %>% summarise(ppt = mean(mean_ppt))
grow_mean_cv_ppt <- poar_grow_plot %>% group_by(Sex) %>% summarise(cv_ppt = mean(cv_ppt))

## Flowering
poar_allsites.flow %>% 
  group_by(site,Sex) %>% 
  summarise(mean_size = mean(z_size_t1),
            mean_flow = mean(flow_t1),
            ppt = unique(mean_ppt),
            mean_ppt= mean(mean_ppt),
            temp = unique(mean_temp),
            mean_temp= mean(mean_temp),
            cv_ppt=unique(cv_ppt),
            mean_cv_ppt=mean(cv_ppt))->poar_flow_plot

flow_mean_sizes <- poar_flow_plot %>% group_by(Sex) %>% summarise(size = mean(mean_size))
flow_mean_temp <- poar_flow_plot %>% group_by(Sex) %>% summarise(temp = mean(mean_temp))
flow_mean_ppt <- poar_flow_plot %>% group_by(Sex) %>% summarise(ppt = mean(mean_ppt))
flow_mean_cv_ppt <- poar_flow_plot %>% group_by(Sex) %>% summarise(cv_ppt = mean(cv_ppt))

## Panicles


poar_allsites.panic %>% 
  group_by(site,Sex) %>% 
  summarise(mean_size = mean(z_size_t1),
            mean_panic = mean(panic_t1),
            ppt = unique(mean_ppt),
            mean_ppt= mean(mean_ppt),
            temp = unique(mean_temp),
            mean_temp= mean(mean_temp),
            cv_ppt=unique(cv_ppt),
            mean_cv_ppt=mean(cv_ppt))->poar_panic_plot

panic_mean_sizes <- poar_panic_plot %>% group_by(Sex) %>% summarise(size = mean(mean_size))
panic_mean_temp <- poar_panic_plot %>% group_by(Sex) %>% summarise(temp = mean(mean_temp))
panic_mean_ppt <- poar_panic_plot %>% group_by(Sex) %>% summarise(ppt = mean(mean_ppt))
panic_mean_cv_ppt <- poar_panic_plot %>% group_by(Sex) %>% summarise(cv_ppt = mean(mean_cv_ppt))


```





# pull out stan coefficients
```{r}
fit_full <- fit_allsites_full_annual 
surv_coef <- rstan::extract(fit_full, pars = c("b0_s", "bsize_s","bsex_s","bppt_s","btemp_s","bcvppt_s","bpptsex_s","btempsex_s","bcvpptsex_s","bppttempsex_s","block_tau_s","source_tau_s","site_tau_s"))

grow_coef <- rstan::extract(fit_full, pars = c("b0_g", "bsize_g","bsex_g","bppt_g","btemp_g","bcvppt_g","bpptsex_g","btempsex_g","bcvpptsex_g","bppttempsex_g","block_tau_g","source_tau_g","site_tau_g"))

flow_coef <- rstan::extract(fit_full, pars = c("b0_f", "bsize_f","bsex_f","bppt_f","btemp_f","bcvppt_f","bpptsex_f","btempsex_f","bcvpptsex_f","bppttempsex_f","block_tau_f","source_tau_f","site_tau_f"))

panic_coef <- rstan::extract(fit_full, pars = c("b0_p", "bsize_p","bsex_p","bppt_p","btemp_p","bcvppt_p","bpptsex_p","btempsex_p","bcvpptsex_p","bppttempsex_p","block_tau_p","source_tau_p","site_tau_p"))
```


```{r}
regpar <- summary(fit_full, pars = c("b0_p", "bsize_p","bsex_p","bppt_p","btemp_p","bcvppt_p","bpptsex_p","btempsex_p","bcvpptsex_p","bppttempsex_p","block_tau_p","source_tau_p","siteyear_tau_p"))$summary
knitr::kable(regpar)
```





# sample vital rate functions from the join posterior

```{r}
poar_surv_plot$scaled_ppt <- scale(poar_surv_plot$ppt)
ppt_seq <- seq(min(poar_surv_plot$scaled_ppt),max(poar_surv_plot$scaled_ppt),0.1)
poar_surv_plot$scaled_temp <- scale(poar_surv_plot$temp)
temp_seq <- seq(min(poar_surv_plot$scaled_temp),max(poar_surv_plot$scaled_temp),0.1)
poar_surv_plot$scaled_cvppt <- scale(poar_surv_plot$cv_ppt)
cvppt_seq <- seq(min(poar_surv_plot$scaled_cvppt),max(poar_surv_plot$scaled_cvppt),0.1)
```


```{r}
for(s in 1:2){
      SV<-invlogit(mean(surv_coef$b0_s) + 
                        mean(surv_coef$bsize_s) * surv_mean_sizes$size[surv_mean_sizes$Sex==s] +
                        mean(surv_coef$bsex_s) * (s-1) +
                        mean(surv_coef$bppt_s) * ppt_seq +
                        mean(surv_coef$btemp_s) * surv_mean_temp$temp[surv_mean_temp$Sex==s] +
                        mean(surv_coef$bcvppt_s) * surv_mean_cv_ppt$cv_ppt[surv_mean_cv_ppt$Sex==s] +
                        mean(surv_coef$bpptsex_s) * ppt_seq * (s-1) +
                        mean(surv_coef$btempsex_s) * surv_mean_temp$temp[surv_mean_temp$Sex==s] * (s-1) +
                        mean(surv_coef$bcvpptsex_s) * surv_mean_cv_ppt$cv_ppt[surv_mean_cv_ppt$Sex==s] * (s-1) +
                        mean(surv_coef$bppttempsex_s) * ppt_seq * surv_mean_temp$temp[surv_mean_temp$Sex==s] * surv_mean_cv_ppt$cv_ppt[surv_mean_cv_ppt$Sex==s] * (s-1) 
      )
      print(SV)
    }
```

```{r}
sex_cols <- c("#FDAE61","#66BD63")
# sex_lty <- c(1,2)
with(poar_surv_plot,{
  par(mar=c(2,4,1,0))
    plot(scaled_ppt,mean_surv,ylim=c(0,1),
         xlab=" Precipitation",ylab=" Pr Survival");box()
    for(s in 1:2){
      points(scaled_ppt[Sex==s],mean_surv[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(ppt_seq,invlogit(mean(surv_coef$b0_s) + 
                        mean(surv_coef$bsize_s) * surv_mean_sizes$size[surv_mean_sizes$Sex==s] +
                        mean(surv_coef$bsex_s) * (s-1) +
                        mean(surv_coef$bppt_s) * ppt_seq +
                        mean(surv_coef$btemp_s) * surv_mean_temp$temp[surv_mean_temp$Sex==s] +
                        mean(surv_coef$bcvppt_s) * surv_mean_cv_ppt$cv_ppt[surv_mean_cv_ppt$Sex==s] +
                        mean(surv_coef$bpptsex_s) * ppt_seq * (s-1) +
                        mean(surv_coef$btempsex_s) * surv_mean_temp$temp[surv_mean_temp$Sex==s] * (s-1) +
                        mean(surv_coef$bcvpptsex_s) * surv_mean_cv_ppt$cv_ppt[surv_mean_cv_ppt$Sex==s] * (s-1) +
                        mean(surv_coef$bppttempsex_s) * ppt_seq * surv_mean_temp$temp[surv_mean_temp$Sex==s] * surv_mean_cv_ppt$cv_ppt[surv_mean_cv_ppt$Sex==s] * (s-1) 
      ),col= sex_cols[s],lwd=3)
    }
})

surv_mean_sizes$size[surv_mean_sizes$Sex==1]
with(poar_grow_plot,{
  par(mar=c(0,4,1,0))
    plot(ppt,mean_grow,
         xlab=" Precipitation",ylab=" #tillers");box()
    for(s in 1:2){
      points(ppt[Sex==s],mean_grow[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(ppt_seq,exp(mean(grow_coef$b0_g) + 
                        mean(grow_coef$bsize_g) * grow_mean_sizes$size[grow_mean_sizes$Sex==s] +
                        mean(grow_coef$bsex_g) * (s-1) +
                        mean(grow_coef$bppt_g) * ppt_seq +
                        mean(grow_coef$btemp_g) * grow_mean_temp$temp[grow_mean_temp$Sex==s] +
                        mean(grow_coef$bcvppt_g) * grow_mean_cv_ppt$cv_ppt[grow_mean_cv_ppt$Sex==s] +
                        mean(grow_coef$bpptsex_g) * ppt_seq * (s-1) +
                        mean(grow_coef$btempsex_g) * grow_mean_temp$temp[grow_mean_temp$Sex==s] * (s-1) +
                        mean(grow_coef$bcvpptsex_g) * grow_mean_cv_ppt$cv_ppt[grow_mean_cv_ppt$Sex==s] * (s-1) +
                        mean(grow_coef$bppttempsex_g) * ppt_seq * grow_mean_temp$temp[grow_mean_temp$Sex==s] * grow_mean_cv_ppt$cv_ppt[grow_mean_cv_ppt$Sex==s] * (s-1) 
      ),col= sex_cols[s],lwd=3)
    }
})

with(poar_flow_plot,{
  par(mar=c(0,4,1,0))
    plot(ppt,mean_flow,ylim=c(0,1),
         xlab=" Precipitation",ylab=" Pr flowering");box()
    for(s in 1:2){
      points(ppt[Sex==s],mean_flow[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(ppt_seq,invlogit(mean(flow_coef$b0_f) + 
                        mean(flow_coef$bsize_f) * flow_mean_sizes$size[flow_mean_sizes$Sex==s] +
                        mean(flow_coef$bsex_f) * (s-1) +
                        mean(flow_coef$bppt_f) * ppt_seq +
                        mean(flow_coef$btemp_f) * flow_mean_temp$temp[flow_mean_temp$Sex==s] +
                        mean(flow_coef$bcvppt_f) * flow_mean_cv_ppt$cv_ppt[flow_mean_cv_ppt$Sex==s] +
                        mean(flow_coef$bpptsex_f) * ppt_seq * (s-1) +
                        mean(flow_coef$btempsex_f) * flow_mean_temp$temp[flow_mean_temp$Sex==s] * (s-1) +
                        mean(flow_coef$bcvpptsex_f) * flow_mean_cv_ppt$cv_ppt[flow_mean_cv_ppt$Sex==s] * (s-1) +
                        mean(flow_coef$bppttempsex_f) * ppt_seq * flow_mean_temp$temp[flow_mean_temp$Sex==s] * flow_mean_cv_ppt$cv_ppt[flow_mean_cv_ppt$Sex==s] * (s-1) 
      ),col= sex_cols[s],lwd=3)
    }
})


with(poar_panic_plot,{
  par(mar=c(0,4,1,0))
    plot(ppt,mean_panic,
         xlab=" Precipitation",ylab=" #panicles");box()
    for(s in 1:2){
      points(ppt[Sex==s],mean_panic[Sex==s],
             bg=sex_cols[s],pch=21,cex=2)
      lines(ppt_seq,exp(mean(panic_coef$b0_p) + 
                        mean(panic_coef$bsize_p) * panic_mean_sizes$size[panic_mean_sizes$Sex==s] +
                        mean(panic_coef$bsex_p) * (s-1) +
                        mean(panic_coef$bppt_p) * ppt_seq +
                        mean(panic_coef$btemp_p) * panic_mean_temp$temp[panic_mean_temp$Sex==s] +
                        mean(panic_coef$bcvppt_p) * panic_mean_cv_ppt$cv_ppt[panic_mean_cv_ppt$Sex==s] +
                        mean(panic_coef$bpptsex_p) * ppt_seq * (s-1) +
                        mean(panic_coef$btempsex_p) * panic_mean_temp$temp[panic_mean_temp$Sex==s] * (s-1) +
                        mean(panic_coef$bcvpptsex_p) * panic_mean_cv_ppt$cv_ppt[panic_mean_cv_ppt$Sex==s] * (s-1) +
                        mean(panic_coef$bppttempsex_p) * ppt_seq * panic_mean_temp$temp[panic_mean_temp$Sex==s] * panic_mean_cv_ppt$cv_ppt[panic_mean_cv_ppt$Sex==s] * (s-1) 
      ),col=sex_cols[s],lwd=3)
    }
})
```







